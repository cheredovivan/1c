
&НаСервере
Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Настройки = КомпоновщикНастроек.ПолучитьНастройки();
	
	// Получаем период из пользовательских настроек
	Период = ПолучитьПериодИзНастроек();
	
	Если ЗначениеЗаполнено(Период.ДатаНачала) Тогда
		НачалоПериода = Период.ДатаНачала;
	Иначе
		// Если период не задан — используем предыдущий рабочий день
		ПредыдущийРабочийДень = ПолучитьПредыдущийРабочийДень(ТекущаяДатаСеанса());
		НачалоПериода = НачалоДня(ПредыдущийРабочийДень);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Период.ДатаОкончания) Тогда
		КонецПериода = Период.ДатаОкончания;
	Иначе
		КонецПериода = КонецДня(НачалоПериода);
	КонецЕсли;
	
	// Получаем данные с группировкой номенклатуры
	ТаблицаДанных = ПолучитьДанныеОтчета(НачалоПериода, КонецПериода);
	
	// Передаём как внешний набор данных
	ВнешниеНаборыДанных = Новый Структура;
	ВнешниеНаборыДанных.Вставить("ТаблицаДанных", ТаблицаДанных);
	
	// Выполняем компоновку
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, Настройки, ДанныеРасшифровки);
	
	ПроцессорКомпоновки = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновки.Инициализировать(МакетКомпоновки, ВнешниеНаборыДанных, ДанныеРасшифровки);
	
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВТабличныйДокумент;
	ПроцессорВывода.УстановитьДокумент(ДокументРезультат);
	ПроцессорВывода.Вывести(ПроцессорКомпоновки);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьДанныеОтчета(НачалоПериода, КонецПериода)
	
	// Запрос для получения заказов и номенклатуры
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗаказК.Партнер КАК Клиент,
	|	ВЫРАЗИТЬ(ЗаказК.СуммаДокумента КАК ЧИСЛО(15, 0)) КАК СуммаСчета,
	|	ЗаказК.Ссылка КАК ЗаказКлиента,
	|	ЗаказК.Статус КАК Статус,
	|	ЗаказКлиентаТовары.Номенклатура КАК Номенклатура
	|ИЗ
	|	Документ.ЗаказКлиента КАК ЗаказК
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента.Товары КАК ЗаказКлиентаТовары
	|		ПО ЗаказК.Ссылка = ЗаказКлиентаТовары.Ссылка
	|ГДЕ
	|	ЗаказК.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ЗаказК.Проведен
	|УПОРЯДОЧИТЬ ПО
	|	ЗаказКлиента,
	|	Номенклатура";
	
	Запрос.УстановитьПараметр("НачалоПериода", НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода", КонецПериода);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	// Создаём таблицу результата с объединённой номенклатурой
	ТаблицаДанных = Новый ТаблицаЗначений;
	ТаблицаДанных.Колонки.Добавить("Клиент");
	ТаблицаДанных.Колонки.Добавить("СуммаСчета", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 0)));
	ТаблицаДанных.Колонки.Добавить("Номенклатура", Новый ОписаниеТипов("Строка"));
	ТаблицаДанных.Колонки.Добавить("Статус", Новый ОписаниеТипов("Строка"));
	ТаблицаДанных.Колонки.Добавить("ЗаказКлиента");
	
	// Группируем по заказу и объединяем номенклатуру
	ТекущийЗаказ = Неопределено;
	СписокНоменклатуры = Новый Массив;
	ТекущаяСтрока = Неопределено;
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Если ТекущийЗаказ <> Выборка.ЗаказКлиента Тогда
			// Записываем предыдущий заказ
			Если ТекущаяСтрока <> Неопределено Тогда
				ТекущаяСтрока.Номенклатура = СтрСоединить(СписокНоменклатуры, ", ");
			КонецЕсли;
			
			// Начинаем новый заказ
			ТекущийЗаказ = Выборка.ЗаказКлиента;
			СписокНоменклатуры = Новый Массив;
			
			ТекущаяСтрока = ТаблицаДанных.Добавить();
			ТекущаяСтрока.Клиент = Выборка.Клиент;
			ТекущаяСтрока.СуммаСчета = Выборка.СуммаСчета;
			ТекущаяСтрока.Статус = ПредставлениеСтатуса(Выборка.Статус);
			ТекущаяСтрока.ЗаказКлиента = Выборка.ЗаказКлиента;
		КонецЕсли;
		
		// Добавляем номенклатуру в список
		СписокНоменклатуры.Добавить(Строка(Выборка.Номенклатура));
		
	КонецЦикла;
	
	// Записываем последний заказ
	Если ТекущаяСтрока <> Неопределено Тогда
		ТекущаяСтрока.Номенклатура = СтрСоединить(СписокНоменклатуры, ", ");
	КонецЕсли;
	
	Возврат ТаблицаДанных;
	
КонецФункции

// Получает значение параметра "Период" из пользовательских настроек СКД.
// Возвращает СтандартныйПериод. Если параметр не найден или не используется — возвращает пустой период.
//
&НаСервере
Функция ПолучитьПериодИзНастроек()
	
	НайденныйПараметрВарианта = КомпоновщикНастроек.Настройки.ПараметрыДанных.Элементы.Найти("Период");
	Если НайденныйПараметрВарианта <> Неопределено Тогда
		НайденныйПараметр = КомпоновщикНастроек.ПользовательскиеНастройки.Элементы.Найти(
			НайденныйПараметрВарианта.ИдентификаторПользовательскойНастройки);
		Если НайденныйПараметр <> Неопределено И НайденныйПараметр.Использование Тогда
			Возврат НайденныйПараметр.Значение;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Новый СтандартныйПериод;
	
КонецФункции

// Возвращает представление статуса для отчёта.
// "К выполнению / В резерве" -> "К выполнению"
//
&НаСервере
Функция ПредставлениеСтатуса(Статус)
	
	ПредставлениеСтатуса = Строка(Статус);
	
	Если ПредставлениеСтатуса = "К выполнению / В резерве" Тогда
		Возврат "К выполнению";
	КонецЕсли;
	
	Возврат ПредставлениеСтатуса;
	
КонецФункции

// Возвращает предыдущий рабочий день с учётом выходных.
// Если сегодня понедельник - вернёт пятницу.
//
&НаСервере
Функция ПолучитьПредыдущийРабочийДень(ТекущаяДата)
	
	ПредыдущийДень = ТекущаяДата - 86400; // Минус один день в секундах
	
	// Определяем день недели предыдущего дня (1 - понедельник, 7 - воскресенье)
	ДеньНеделиПредыдущегоДня = ДеньНедели(ПредыдущийДень);
	
	// Если предыдущий день - воскресенье (7), откатываемся на 2 дня (пятница)
	Если ДеньНеделиПредыдущегоДня = 7 Тогда
		ПредыдущийДень = ПредыдущийДень - 2 * 86400;
	// Если предыдущий день - суббота (6), откатываемся на 1 день (пятница)
	ИначеЕсли ДеньНеделиПредыдущегоДня = 6 Тогда
		ПредыдущийДень = ПредыдущийДень - 86400;
	КонецЕсли;
	
	Возврат ПредыдущийДень;
	
КонецФункции
