////////////////////////////////////////////////////////////////////////////////
// Обработка ПриложениеКП
// Печатная форма "Приложение к коммерческому предложению"
// для документа КоммерческоеПредложениеКлиенту.
//
// Макет "ПриложениеКП" содержит следующие именованные области:
//   Шапка          — номер, дата, обращение к заказчику, "Коммерческое предложение"
//   Преамбула      — "В соответствии с вашим запросом предлагаем к поставке:"
//   ШапкаТаблицы   — заголовки колонок таблицы товаров
//   СтрокаТаблицы  — строка таблицы товаров
//   Итого          — итого, НДС, всего наименований, сумма прописью
//   СрокДействия   — "Действие цены актуально до ..."
//   УсловияОплаты  — условия оплаты
//   УсловияДоставки — условия доставки
//   Подписи        — должность, ФИО руководителя
//   Менеджер       — контакты менеджера
//
// Параметры областей:
//   Шапка: НомерДокумента, ДатаДокумента
//   Преамбула: (нет параметров)
//   ШапкаТаблицы: (нет параметров)
//   СтрокаТаблицы: НомерСтроки, Наименование, Количество, ЕдиницаИзмерения,
//                  СрокПоставки, Цена, Сумма
//   Итого: ИтогоСумма, СуммаНДС, КоличествоНаименований,
//          ВсегоСумма, СуммаПрописью
//   СрокДействия: ДатаОкончанияДействия
//   УсловияОплаты: ТекстУсловийОплаты
//   УсловияДоставки: ТекстУсловийДоставки
//   Подписи: Должность, ФИОРуководителя
//   Менеджер: ФИОМенеджера, Телефон, Email
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

// Стандартная процедура печати.
//
// Параметры:
//   МассивОбъектов         - Массив - массив ссылок на документы КоммерческоеПредложениеКлиенту.
//   КоллекцияПечатныхФорм  - ТаблицаЗначений - коллекция печатных форм.
//   ОбъектыПечати          - СписокЗначений - соответствие объектов и областей печати.
//   ПараметрыВывода        - Структура - параметры вывода.
//
Процедура Печать(МассивОбъектов, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт

	Если УправлениеПечатью.НужноПечататьМакет(КоллекцияПечатныхФорм, "ПриложениеКП") Тогда
		УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(
			КоллекцияПечатныхФорм,
			"ПриложениеКП",
			НСтр("ru = 'Приложение к коммерческому предложению'"),
			СформироватьПечатнуюФорму(МассивОбъектов, ОбъектыПечати));
	КонецЕсли;

КонецПроцедуры

// Возвращает сведения для регистрации обработки в справочнике
// "Дополнительные отчеты и обработки" (интерфейс БСП).
//
// Возвращаемое значение:
//   Структура - параметры регистрации.
//
Функция СведенияОВнешнейОбработке() Экспорт

	ПараметрыРегистрации = Новый Структура;
	ПараметрыРегистрации.Вставить("Вид", "ПечатнаяФорма");
	ПараметрыРегистрации.Вставить("Назначение", ПолучитьНазначениеОбработки());
	ПараметрыРегистрации.Вставить("Наименование", НСтр("ru = 'Приложение к коммерческому предложению'"));
	ПараметрыРегистрации.Вставить("Версия", "1.0");
	ПараметрыРегистрации.Вставить("БезопасныйРежим", Истина);
	ПараметрыРегистрации.Вставить("Информация",
		НСтр("ru = 'Печатная форма приложения к коммерческому предложению клиенту'"));

	ТаблицаКоманд = ПолучитьТаблицуКоманд();

	ДобавитьКоманду(ТаблицаКоманд,
		НСтр("ru = 'Приложение к КП'"),
		"ПриложениеКП",
		"ВызовСерверногоМетода",
		Истина,
		"ПечатьMXL");

	ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);
	Возврат ПараметрыРегистрации;

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Формирует табличный документ печатной формы.
//
// Параметры:
//   МассивОбъектов - Массив - массив ссылок на документы.
//   ОбъектыПечати  - СписокЗначений - соответствие объектов и областей.
//
// Возвращаемое значение:
//   ТабличныйДокумент - сформированная печатная форма.
//
Функция СформироватьПечатнуюФорму(МассивОбъектов, ОбъектыПечати)

	УстановитьПривилегированныйРежим(Истина);

	ТабличныйДокумент = Новый ТабличныйДокумент;
	ТабличныйДокумент.ИмяПараметровПечати = "ПАРАМЕТРЫ_ПЕЧАТИ_ПриложениеКП";

	Макет = ПолучитьМакет("ПриложениеКП");

	ОбластьШапка           = Макет.ПолучитьОбласть("Шапка");
	ОбластьПреамбула       = Макет.ПолучитьОбласть("Преамбула");
	ОбластьШапкаТаблицы    = Макет.ПолучитьОбласть("ШапкаТаблицы");
	ОбластьСтрокаТаблицы   = Макет.ПолучитьОбласть("СтрокаТаблицы");
	ОбластьИтого           = Макет.ПолучитьОбласть("Итого");
	ОбластьСрокДействия    = Макет.ПолучитьОбласть("СрокДействия");
	ОбластьУсловияОплаты   = Макет.ПолучитьОбласть("УсловияОплаты");
	ОбластьУсловияДоставки = Макет.ПолучитьОбласть("УсловияДоставки");
	ОбластьПодписи         = Макет.ПолучитьОбласть("Подписи");
	ОбластьМенеджер        = Макет.ПолучитьОбласть("Менеджер");

	ДанныеДляПечати = ПолучитьДанныеДляПечати(МассивОбъектов);

	ВыборкаПоШапке = ДанныеДляПечати.Шапка.Выбрать();
	ТаблицаТоваров = ДанныеДляПечати.Товары.Выгрузить();

	ПервыйДокумент = Истина;

	Пока ВыборкаПоШапке.Следующий() Цикл

		Если Не ПервыйДокумент Тогда
			ТабличныйДокумент.ВывестиГоризонтальныйРазделительСтраниц();
		КонецЕсли;

		НомерСтрокиНачало = ТабличныйДокумент.ВысотаТаблицы + 1;

		// === Шапка ===
		ОбластьШапка.Параметры.НомерДокумента = ВыборкаПоШапке.Номер;
		ОбластьШапка.Параметры.ДатаДокумента  = Формат(ВыборкаПоШапке.Дата,
			"ДФ='""от «""dd""» ""MMMM yyyy""г.""'");
		ТабличныйДокумент.Вывести(ОбластьШапка);

		// === Преамбула ===
		ТабличныйДокумент.Вывести(ОбластьПреамбула);

		// === Шапка таблицы ===
		ТабличныйДокумент.Вывести(ОбластьШапкаТаблицы);

		// === Строки таблицы ===
		СтрокиТоваров = ТаблицаТоваров.НайтиСтроки(
			Новый Структура("Ссылка", ВыборкаПоШапке.Ссылка));

		ИтогоСумма    = 0;
		ИтогоСуммаНДС = 0;
		ИтогоСуммаСНДС = 0;
		КоличествоНаименований = 0;

		Для Каждого СтрокаТовара Из СтрокиТоваров Цикл

			КоличествоНаименований = КоличествоНаименований + 1;

			ОбластьСтрокаТаблицы.Параметры.НомерСтроки     = СтрокаТовара.НомерСтроки;
			ОбластьСтрокаТаблицы.Параметры.Наименование     = СтрокаТовара.Наименование;
			ОбластьСтрокаТаблицы.Параметры.Количество       = СтрокаТовара.Количество;
			ОбластьСтрокаТаблицы.Параметры.ЕдиницаИзмерения = СтрокаТовара.ЕдиницаИзмерения;
			ОбластьСтрокаТаблицы.Параметры.СрокПоставки     = ПредставлениеСрокаПоставки(
				СтрокаТовара.СрокПоставки,
				ВыборкаПоШапке.ВариантУказанияСрокаПоставки);
			ОбластьСтрокаТаблицы.Параметры.Цена             = Формат(СтрокаТовара.Цена,
				"ЧДЦ=2; ЧРГ=' '; ЧРД=,");
			ОбластьСтрокаТаблицы.Параметры.Сумма            = Формат(СтрокаТовара.СуммаСНДС,
				"ЧДЦ=2; ЧРГ=' '; ЧРД=,");

			ТабличныйДокумент.Вывести(ОбластьСтрокаТаблицы);

			ИтогоСумма     = ИтогоСумма + СтрокаТовара.Сумма;
			ИтогоСуммаНДС  = ИтогоСуммаНДС + СтрокаТовара.СуммаНДС;
			ИтогоСуммаСНДС = ИтогоСуммаСНДС + СтрокаТовара.СуммаСНДС;

		КонецЦикла;

		// === Итого ===
		Если ВыборкаПоШапке.УчитыватьНДС Тогда
			ИтоговаяСумма = ИтогоСуммаСНДС;
		Иначе
			ИтоговаяСумма = ИтогоСумма;
		КонецЕсли;

		ОбластьИтого.Параметры.ИтогоСумма = Формат(ИтогоСумма,
			"ЧДЦ=2; ЧРГ=' '; ЧРД=,");
		ОбластьИтого.Параметры.СуммаНДС   = Формат(ИтогоСуммаНДС,
			"ЧДЦ=2; ЧРГ=' '; ЧРД=,");
		ОбластьИтого.Параметры.КоличествоНаименований = КоличествоНаименований;
		ОбластьИтого.Параметры.ВсегоСумма = Формат(ИтоговаяСумма,
			"ЧДЦ=2; ЧРГ=' '; ЧРД=,");
		ОбластьИтого.Параметры.СуммаПрописью = РаботаСКурсамиВалютВызовСервера.СформироватьСуммуПрописью(
			ИтоговаяСумма, ВыборкаПоШапке.Валюта);

		ТабличныйДокумент.Вывести(ОбластьИтого);

		// === Срок действия ===
		Если ЗначениеЗаполнено(ВыборкаПоШапке.СрокДействия) Тогда
			ОбластьСрокДействия.Параметры.ДатаОкончанияДействия = Формат(
				ВыборкаПоШапке.СрокДействия, "ДФ='dd MMMM yyyyг.'");
			ТабличныйДокумент.Вывести(ОбластьСрокДействия);
		КонецЕсли;

		// === Условия оплаты ===
		Если ЗначениеЗаполнено(ВыборкаПоШапке.УсловияОплаты) Тогда
			ОбластьУсловияОплаты.Параметры.ТекстУсловийОплаты = ВыборкаПоШапке.УсловияОплаты;
			ТабличныйДокумент.Вывести(ОбластьУсловияОплаты);
		КонецЕсли;

		// === Условия доставки ===
		Если ЗначениеЗаполнено(ВыборкаПоШапке.УсловияДоставки) Тогда
			ОбластьУсловияДоставки.Параметры.ТекстУсловийДоставки = ВыборкаПоШапке.УсловияДоставки;
			ТабличныйДокумент.Вывести(ОбластьУсловияДоставки);
		КонецЕсли;

		// === Подписи ===
		ДанныеПодписанта = ПолучитьДанныеПодписанта(ВыборкаПоШапке.Организация);
		ОбластьПодписи.Параметры.Должность       = ДанныеПодписанта.Должность;
		ОбластьПодписи.Параметры.ФИОРуководителя  = ДанныеПодписанта.ФИО;
		ТабличныйДокумент.Вывести(ОбластьПодписи);

		// === Менеджер ===
		ДанныеМенеджера = ПолучитьДанныеМенеджера(ВыборкаПоШапке.Менеджер);
		ОбластьМенеджер.Параметры.ФИОМенеджера = ДанныеМенеджера.ФИО;
		ОбластьМенеджер.Параметры.Телефон       = ДанныеМенеджера.Телефон;
		ОбластьМенеджер.Параметры.Email          = ДанныеМенеджера.Email;
		ТабличныйДокумент.Вывести(ОбластьМенеджер);

		УправлениеПечатью.ЗадатьОбластьПечатиДокумента(
			ТабличныйДокумент, НомерСтрокиНачало, ОбъектыПечати, ВыборкаПоШапке.Ссылка);

		ПервыйДокумент = Ложь;

	КонецЦикла;

	ТабличныйДокумент.АвтоМасштаб = Истина;

	Возврат ТабличныйДокумент;

КонецФункции

// Получает данные для печати из базы данных.
//
// Параметры:
//   МассивОбъектов - Массив - массив ссылок на документы КоммерческоеПредложениеКлиенту.
//
// Возвращаемое значение:
//   Структура - с ключами "Шапка" (РезультатЗапроса) и "Товары" (РезультатЗапроса).
//
Функция ПолучитьДанныеДляПечати(МассивОбъектов)

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("МассивОбъектов", МассивОбъектов);

	Запрос.Текст =
	"ВЫБРАТЬ
	|	КП.Ссылка КАК Ссылка,
	|	КП.Номер КАК Номер,
	|	КП.Дата КАК Дата,
	|	КП.Организация КАК Организация,
	|	КП.Клиент КАК Клиент,
	|	КП.Контрагент КАК Контрагент,
	|	КП.Менеджер КАК Менеджер,
	|	КП.Валюта КАК Валюта,
	|	КП.СрокДействия КАК СрокДействия,
	|	КП.УсловияОплатыТекст КАК УсловияОплаты,
	|	КП.УсловияДоставкиТекст КАК УсловияДоставки,
	|	КП.Налогообложение КАК УчитыватьНДС,
	|	КП.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
	|	КП.ВариантУказанияСрокаПоставки КАК ВариантУказанияСрокаПоставки
	|ИЗ
	|	Документ.КоммерческоеПредложениеКлиенту КАК КП
	|ГДЕ
	|	КП.Ссылка В (&МассивОбъектов)
	|УПОРЯДОЧИТЬ ПО
	|	КП.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Ссылка КАК Ссылка,
	|	Товары.НомерСтроки КАК НомерСтроки,
	|	ВЫБОР
	|		КОГДА Товары.Характеристика = ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|			ТОГДА Товары.Номенклатура.НаименованиеПолное
	|		ИНАЧЕ ПРЕДСТАВЛЕНИЕ(Товары.Номенклатура) + "" "" + ПРЕДСТАВЛЕНИЕ(Товары.Характеристика)
	|	КОНЕЦ КАК Наименование,
	|	Товары.Количество КАК Количество,
	|	ПРЕДСТАВЛЕНИЕ(Товары.ЕдиницаИзмерения) КАК ЕдиницаИзмерения,
	|	Товары.Цена КАК Цена,
	|	Товары.Сумма КАК Сумма,
	|	Товары.СуммаНДС КАК СуммаНДС,
	|	Товары.СуммаСНДС КАК СуммаСНДС,
	|	Товары.СрокПоставки КАК СрокПоставки
	|ИЗ
	|	Документ.КоммерческоеПредложениеКлиенту.Товары КАК Товары
	|ГДЕ
	|	Товары.Ссылка В (&МассивОбъектов)
	|УПОРЯДОЧИТЬ ПО
	|	Товары.Ссылка,
	|	Товары.НомерСтроки";

	РезультатЗапроса = Запрос.ВыполнитьПакет();

	Результат = Новый Структура;
	Результат.Вставить("Шапка",  РезультатЗапроса[0]);
	Результат.Вставить("Товары", РезультатЗапроса[1]);

	Возврат Результат;

КонецФункции

// Формирует текстовое представление срока поставки.
//
// Параметры:
//   СрокПоставки                   - Дата, Число - значение срока поставки.
//   ВариантУказанияСрокаПоставки   - ПеречислениеСсылка - вариант.
//
// Возвращаемое значение:
//   Строка - текстовое представление.
//
Функция ПредставлениеСрокаПоставки(СрокПоставки, ВариантУказанияСрокаПоставки)

	Если Не ЗначениеЗаполнено(СрокПоставки) Тогда
		Возврат "";
	КонецЕсли;

	Если ТипЗнч(СрокПоставки) = Тип("Дата") Тогда
		Возврат Формат(СрокПоставки, "ДФ='dd.MM.yyyy'");
	ИначеЕсли ТипЗнч(СрокПоставки) = Тип("Число") Тогда
		Если СрокПоставки = 0 Тогда
			Возврат "";
		КонецЕсли;
		Возврат НСтр("ru = 'в течение'") + " " + Формат(СрокПоставки, "ЧГ=") + " "
			+ НСтр("ru = 'дн.'");
	КонецЕсли;

	Возврат Строка(СрокПоставки);

КонецФункции

// Получает данные подписанта (руководителя) организации.
//
// Параметры:
//   Организация - СправочникСсылка.Организации - организация.
//
// Возвращаемое значение:
//   Структура - с ключами "Должность" и "ФИО".
//
Функция ПолучитьДанныеПодписанта(Организация)

	Результат = Новый Структура("Должность, ФИО", "", "");

	Попытка
		// Используем типовой механизм получения ответственных лиц организации.
		ОтветственныеЛица = ОтветственныеЛицаБП.ОтветственныеЛицаОрганизации(
			Организация, ТекущаяДатаСеанса());
		Если ОтветственныеЛица <> Неопределено Тогда
			Результат.Должность = ОтветственныеЛица.ДолжностьРуководителя;
			Результат.ФИО       = ОтветственныеЛица.РуководительПредставление;
		КонецЕсли;
	Исключение
		// Если модуль недоступен — пробуем альтернативный способ.
		Попытка
			МассивВидов = Новый Массив;
			МассивВидов.Добавить(
				ПредопределенноеЗначение("Перечисление.ВидыОтветственныхЛиц.Руководитель"));

			ОтветственныеЛица = ОтветственныеЛицаСервер.ОтветственныеЛица(
				Организация, МассивВидов, ТекущаяДатаСеанса());

			Если ОтветственныеЛица.Количество() > 0 Тогда
				Строка = ОтветственныеЛица[0];
				Результат.Должность = Строка.Должность;
				Результат.ФИО       = Строка.ФизическоеЛицо;
			КонецЕсли;
		Исключение
			// Оба способа недоступны — оставляем пустые значения.
		КонецИсключения;
	КонецПопытки;

	Возврат Результат;

КонецФункции

// Получает контактные данные менеджера.
//
// Параметры:
//   Менеджер - СправочникСсылка.Пользователи - менеджер.
//
// Возвращаемое значение:
//   Структура - с ключами "ФИО", "Телефон", "Email".
//
Функция ПолучитьДанныеМенеджера(Менеджер)

	Результат = Новый Структура("ФИО, Телефон, Email", "", "", "");

	Если Не ЗначениеЗаполнено(Менеджер) Тогда
		Возврат Результат;
	КонецЕсли;

	Результат.ФИО = Строка(Менеджер);

	// Получаем контактную информацию через общий механизм.
	Попытка
		МассивОбъектов = Новый Массив;
		МассивОбъектов.Добавить(Менеджер);

		МассивВидов = Новый Массив;
		МассивВидов.Добавить(
			ПредопределенноеЗначение("Справочник.ВидыКонтактнойИнформации.ТелефонПользователя"));
		МассивВидов.Добавить(
			ПредопределенноеЗначение("Справочник.ВидыКонтактнойИнформации.EmailПользователя"));

		КонтактнаяИнформация = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъектов(
			МассивОбъектов, МассивВидов, , ТекущаяДатаСеанса());

		Для Каждого СтрокаКИ Из КонтактнаяИнформация Цикл
			Если СтрокаКИ.Вид =
				ПредопределенноеЗначение(
					"Справочник.ВидыКонтактнойИнформации.ТелефонПользователя") Тогда
				Результат.Телефон = СтрокаКИ.Представление;
			ИначеЕсли СтрокаКИ.Вид =
				ПредопределенноеЗначение(
					"Справочник.ВидыКонтактнойИнформации.EmailПользователя") Тогда
				Результат.Email = СтрокаКИ.Представление;
			КонецЕсли;
		КонецЦикла;

	Исключение
		// Контактная информация недоступна — оставляем пустые значения.
	КонецПопытки;

	Возврат Результат;

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыРегистрации

Функция ПолучитьНазначениеОбработки()

	Назначение = Новый Массив;
	Назначение.Добавить("Документ.КоммерческоеПредложениеКлиенту");
	Возврат Назначение;

КонецФункции

Функция ПолучитьТаблицуКоманд()

	Команды = Новый ТаблицаЗначений;
	Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка"));
	Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка"));
	Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка"));
	Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));
	Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
	Возврат Команды;

КонецФункции

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение, Модификатор)

	НоваяСтрока = ТаблицаКоманд.Добавить();
	НоваяСтрока.Представление       = Представление;
	НоваяСтрока.Идентификатор       = Идентификатор;
	НоваяСтрока.Использование       = Использование;
	НоваяСтрока.ПоказыватьОповещение = ПоказыватьОповещение;
	НоваяСтрока.Модификатор         = Модификатор;

КонецПроцедуры

#КонецОбласти
