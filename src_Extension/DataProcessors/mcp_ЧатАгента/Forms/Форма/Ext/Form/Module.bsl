#Область ПеременныеМодуля

&НаКлиенте
Перем ТекстДляОтправки;

&НаКлиенте
Перем НужнаПрокрутка; // Флаг для прокрутки после обновления HTML

&НаКлиенте
Перем мИдФоновогоЗадания; // UUID фонового задания

&НаКлиенте
Перем мАдресРезультата; // Адрес во временном хранилище для результата

#КонецОбласти

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Используем постоянную сессию для пользователя (можно продолжить диалог)
	// Сессия = ИмяПользователя + "_main" для основного чата
	// BSLLS:UnusedLocalVariable-off
	ИдентификаторСессии = ПолучитьИлиСоздатьСессиюПользователя();
	// BSLLS:UnusedLocalVariable-on
	
	// Загружаем историю диалога
	ЗагрузитьИсториюНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Инициализируем флаг прокрутки
	НужнаПрокрутка = Ложь;
	
	// Прокрутка к последнему сообщению при открытии формы
	// Используем небольшую задержку, чтобы HTML успел загрузиться
	ПодключитьОбработчикОжидания("ПрокрутитьЧатВнизОтложенно", 0.3, Истина);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура Поле1ДокументСформирован(Элемент)
	
	// Прокрутка к последнему сообщению после загрузки HTML
	Если НужнаПрокрутка = Истина Тогда
		НужнаПрокрутка = Ложь;
		ПрокрутитьЧатВниз();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОтправитьСообщение(Команда)
	
	// Получаем текст из форматированного документа
	ТекстСообщения = ПолучитьТекстИзФорматированногоДокумента(ПолеВводаСообщения);
	ТекстСообщения = СокрЛП(ТекстСообщения);
	
	Если НЕ ЗначениеЗаполнено(ТекстСообщения) Тогда
		Возврат;
	КонецЕсли;
	
	// Очищаем поле ввода
	ПолеВводаСообщения = Новый ФорматированныйДокумент;
	
	// Сохраняем текст для отложенной отправки
	ТекстДляОтправки = ТекстСообщения;
	
	// Сначала показываем сообщение пользователя
	ДобавитьСообщениеПользователяНаСервере(ТекстСообщения);
	
	// Показываем индикатор ожидания
	ДобавитьИндикаторОжиданияНаСервере();
	
	// Запрашиваем прокрутку после обновления HTML
	ЗапроситьПрокрутку();
	
	// Блокируем кнопку отправки
	Элементы.Кнопка1.Доступность = Ложь;
	
	// Отправляем запрос с небольшой задержкой для обновления UI
	ПодключитьОбработчикОжидания("ОтправитьЗапросОтложенно", 0.1, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтправитьЗапросОтложенно()
	
	// Запускаем фоновое задание для обработки запроса
	РезультатЗапуска = ЗапуститьФоновоеЗаданиеНаСервере(ТекстДляОтправки);
	
	Если РезультатЗапуска.Успешно Тогда
		мИдФоновогоЗадания = РезультатЗапуска.ИдентификаторЗадания;
		мАдресРезультата = РезультатЗапуска.АдресРезультата;
		// Подключаем обработчик ожидания для проверки завершения задания
		ПодключитьОбработчикОжидания("ПроверитьЗавершениеЗадания", 1, Ложь);
	Иначе
		// Ошибка запуска - показываем в чате
		ПоказатьОшибкуВЧатеНаСервере(РезультатЗапуска.Ошибка);
		ЗапроситьПрокрутку();
		Элементы.Кнопка1.Доступность = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьЗавершениеЗадания()
	
	СтатусЗадания = ПолучитьСтатусЗаданияНаСервере(мИдФоновогоЗадания);
	
	Если СтатусЗадания.Завершено Тогда
		// Отключаем обработчик ожидания
		ОтключитьОбработчикОжидания("ПроверитьЗавершениеЗадания");
		
		// Обрабатываем результат
		ОбработатьРезультатЗаданияНаСервере(мАдресРезультата, СтатусЗадания.Ошибка);
	
	// Запрашиваем прокрутку к ответу
	ЗапроситьПрокрутку();
	
	// Разблокируем кнопку
	Элементы.Кнопка1.Доступность = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьИсторию(Команда)
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ОчиститьИсториюЗавершение", ЭтотОбъект);
	ПоказатьВопрос(ОписаниеОповещения, "Очистить историю диалога?", РежимДиалогаВопрос.ДаНет);
	
КонецПроцедуры

&НаКлиенте
Процедура ОчиститьИсториюЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = КодВозвратаДиалога.Да Тогда
		ОчиститьВсеНаСервере();
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Создание/получение сессии

&НаСервере
Функция ПолучитьИлиСоздатьСессиюПользователя()
	
	// Используем постоянную сессию для текущего пользователя
	// Формат: ИмяПользователя_main
	ИмяПользователя = ИмяПользователя();
	Если ПустаяСтрока(ИмяПользователя) Тогда
		ИмяПользователя = "default";
	КонецЕсли;
	
	Возврат ИмяПользователя + "_main";
	
КонецФункции

&НаСервере
Функция СоздатьНовуюСессиюНаСервере()
	
	// Создаёт новую уникальную сессию (для кнопки "Новый чат")
	УникальныйID = Новый УникальныйИдентификатор;
	Возврат СтрЗаменить(Строка(УникальныйID), "-", "");
	
КонецФункции

// Обработка запроса - Этап 1: Показать сообщение пользователя

&НаСервере
Процедура ДобавитьСообщениеПользователяНаСервере(Знач ТекстЗапроса)
	
	ДобавитьСообщениеВЧатНаСервере("user", ТекстЗапроса);
	
КонецПроцедуры

// Обработка запроса - Этап 2: Показать индикатор ожидания

&НаСервере
Процедура ДобавитьИндикаторОжиданияНаСервере()
	
	ДобавитьСообщениеВЧатНаСервере("waiting", "Думаю...");
	
КонецПроцедуры

// Обработка запроса - Этап 3: Запуск фонового задания

&НаСервере
Функция ЗапуститьФоновоеЗаданиеНаСервере(Знач ТекстЗапроса)
	
	Результат = Новый Структура("Успешно, ИдентификаторЗадания, АдресРезультата, Ошибка", Ложь);
	
	Попытка
		// Создаём адрес во временном хранилище для результата
		АдресРезультата = ПоместитьВоВременноеХранилище(Неопределено, УникальныйИдентификатор);
		
		// Параметры для фонового задания
		// Передаём пользователя явно, т.к. в фоне параметры сеанса могут быть другими
		Пользователь = ПараметрыСеанса.ТекущийПользователь;
		ПараметрыЗадания = Новый Массив;
		ПараметрыЗадания.Добавить(ТекстЗапроса);
		ПараметрыЗадания.Добавить(ИдентификаторСессии);
		ПараметрыЗадания.Добавить(Пользователь);
		ПараметрыЗадания.Добавить(АдресРезультата);
		
		// Запускаем фоновое задание
		ФоновоеЗадание = ФоновыеЗадания.Выполнить(
			"mcp_АгентОбработчик.ОбработатьЗапросФоновое",
			ПараметрыЗадания,
			,
			"Чат агента: обработка запроса");
		
		Результат.Успешно = Истина;
		Результат.ИдентификаторЗадания = ФоновоеЗадание.УникальныйИдентификатор;
		Результат.АдресРезультата = АдресРезультата;
		
	Исключение
		Результат.Ошибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьСтатусЗаданияНаСервере(Знач ИдентификаторЗадания)
	
	Результат = Новый Структура("Завершено, Ошибка", Ложь, "");
	
	Попытка
		Задание = ФоновыеЗадания.НайтиПоУникальномуИдентификатору(ИдентификаторЗадания);
		
		Если Задание = Неопределено Тогда
			Результат.Завершено = Истина;
			Результат.Ошибка = "Фоновое задание не найдено";
			Возврат Результат;
		КонецЕсли;
		
		Если Задание.Состояние = СостояниеФоновогоЗадания.Завершено Тогда
			Результат.Завершено = Истина;
		ИначеЕсли Задание.Состояние = СостояниеФоновогоЗадания.ЗавершеноАварийно Тогда
			Результат.Завершено = Истина;
			Результат.Ошибка = Задание.ИнформацияОбОшибке.Описание;
		ИначеЕсли Задание.Состояние = СостояниеФоновогоЗадания.Отменено Тогда
			Результат.Завершено = Истина;
			Результат.Ошибка = "Задание отменено";
		КонецЕсли;
		
	Исключение
		Результат.Завершено = Истина;
		Результат.Ошибка = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Процедура ОбработатьРезультатЗаданияНаСервере(Знач АдресРезультата, Знач ОшибкаЗадания)
	
	// Удаляем индикатор ожидания
	УдалитьПоследнееСообщениеНаСервере();
	
	// Если была ошибка задания - показываем её
	Если ЗначениеЗаполнено(ОшибкаЗадания) Тогда
		ДобавитьСообщениеВЧатНаСервере("error", ОшибкаЗадания);
		Возврат;
	КонецЕсли;
	
	// Получаем результат из временного хранилища
	Попытка
		Результат = ПолучитьИзВременногоХранилища(АдресРезультата);
	Исключение
		ДобавитьСообщениеВЧатНаСервере("error", "Ошибка получения результата: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		Возврат;
	КонецПопытки;
	
	Если Результат = Неопределено Тогда
		ДобавитьСообщениеВЧатНаСервере("error", "Результат не получен");
		Возврат;
	КонецЕсли;
	
	// Добавляем ответ в чат
	Если Результат.Успешно Тогда
		ДобавитьСообщениеВЧатНаСервере("assistant", Результат.ТекстОтвета);
	Иначе
		ДобавитьСообщениеВЧатНаСервере("error", Результат.Ошибка);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПоказатьОшибкуВЧатеНаСервере(Знач ТекстОшибки)
	
	// Удаляем индикатор ожидания
	УдалитьПоследнееСообщениеНаСервере();
	
	// Показываем ошибку
	ДобавитьСообщениеВЧатНаСервере("error", ТекстОшибки);
	
КонецПроцедуры

// Удаление последнего сообщения (индикатора ожидания)

&НаСервере
Процедура УдалитьПоследнееСообщениеНаСервере()
	
	// Ищем и удаляем последний <div>...</div> с "Думаю..."
	ПозицияДумаю = СтрНайти(СодержимоеЧата, "Думаю...", НаправлениеПоиска.СКонца);
	Если ПозицияДумаю > 0 Тогда
		// Ищем начало тега <div> перед "Думаю..."
		ПозицияНачалоDiv = СтрНайти(Лев(СодержимоеЧата, ПозицияДумаю), "<div", НаправлениеПоиска.СКонца);
		// Ищем конец тега </div> после "Думаю..."
		ПозицияКонецDiv = СтрНайти(Сред(СодержимоеЧата, ПозицияДумаю), "</div>");
		Если ПозицияНачалоDiv > 0 И ПозицияКонецDiv > 0 Тогда
			ПозицияКонецDivАбс = ПозицияДумаю + ПозицияКонецDiv + 5; // +5 для </div>
			СодержимоеЧата = Лев(СодержимоеЧата, ПозицияНачалоDiv - 1) + Сред(СодержимоеЧата, ПозицияКонецDivАбс);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Работа с историей

&НаСервере
Процедура ЗагрузитьИсториюНаСервере()
	
	История = Обработки.mcp_ЧатАгента.ПолучитьИсторию(ИдентификаторСессии);
	
	// Очищаем чат перед загрузкой
	// BSLLS:UnusedLocalVariable-off
	СодержимоеЧата = "";
	// BSLLS:UnusedLocalVariable-on
	
	// Если история пустая - показываем приветствие
	Если История.Количество() = 0 Тогда
		ДобавитьСообщениеВЧатНаСервере("system", "Я умею искать почти любую информацию в системе.");
		Возврат;
	КонецЕсли;
	
	// Загружаем историю из базы
	Для Каждого СтрокаИстории Из История Цикл
		// Пропускаем системные сообщения из истории (результаты инструментов)
		Если НРег(СтрокаИстории.Роль) = "system" Тогда
			Продолжить;
		КонецЕсли;
		ДобавитьСообщениеВЧатНаСервере(СтрокаИстории.Роль, СтрокаИстории.ТекстСообщения);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ОчиститьВсеНаСервере()
	
	Обработки.mcp_ЧатАгента.ОчиститьИсторию(ИдентификаторСессии);
	// BSLLS:UnusedLocalVariable-off
	СодержимоеЧата = "";
	// BSLLS:UnusedLocalVariable-on
	ДобавитьСообщениеВЧатНаСервере("system", "История очищена. Введите новое сообщение.");
	
КонецПроцедуры

// Работа с чатом

&НаСервере
Процедура ДобавитьСообщениеВЧатНаСервере(Знач Роль, Знач Текст)
	
	// Определяем префикс и стиль по роли
	Если Роль = "user" Тогда
		Префикс = "Вы: ";
		СтильСообщения = "color: green;";
	ИначеЕсли Роль = "assistant" Тогда
		Префикс = "1С: ";
		СтильСообщения = "color: blue;";
		// Конвертируем Markdown в HTML для ответов ассистента
		Текст = КонвертироватьMarkdownВHTML(Текст);
	ИначеЕсли Роль = "error" Тогда
		Префикс = "Ошибка: ";
		СтильСообщения = "color: red;";
	ИначеЕсли Роль = "waiting" Тогда
		Префикс = "";
		СтильСообщения = "color: orange; font-style: italic;";
	Иначе
		Префикс = "";
		СтильСообщения = "color: gray;";
	КонецЕсли;
	
	// Формируем HTML для нового сообщения с якорем для прокрутки
	НовоеСообщениеHTML = "<div id=""lastMessage"" style=""" + СтильСообщения + """>" + Префикс + Текст + "</div>";
	
	// Удаляем id="lastMessage" у предыдущего сообщения (чтобы id был только у последнего)
	СодержимоеЧата = СтрЗаменить(СодержимоеЧата, " id=""lastMessage""", "");
	
	// Добавляем СНИЗУ (новые сообщения внизу, прокручиваем к ним)
	Если СтрНайти(СодержимоеЧата, "</body>") > 0 Тогда
		СодержимоеЧата = СтрЗаменить(СодержимоеЧата, "</body>", НовоеСообщениеHTML + "</body>");
	Иначе
		СодержимоеЧата = ПолучитьБазовыйHTML() + НовоеСообщениеHTML + "</body></html>";
	КонецЕсли;
	
КонецПроцедуры

// Конвертация Markdown в HTML
&НаСервере
Функция КонвертироватьMarkdownВHTML(Знач Текст)
	
	// Обрабатываем таблицы (| col1 | col2 |)
	Если СтрНайти(Текст, "|") > 0 Тогда
		Текст = КонвертироватьТаблицыMarkdown(Текст);
	КонецЕсли;
	
	// Жирный текст: **текст** или __текст__
	Пока СтрНайти(Текст, "**") > 0 Цикл
		Поз1 = СтрНайти(Текст, "**");
		Поз2 = СтрНайти(Сред(Текст, Поз1 + 2), "**");
		Если Поз2 = 0 Тогда
			Прервать;
		КонецЕсли;
		Поз2 = Поз1 + 1 + Поз2;
		Содержимое = Сред(Текст, Поз1 + 2, Поз2 - Поз1 - 2);
		Текст = Лев(Текст, Поз1 - 1) + "<b>" + Содержимое + "</b>" + Сред(Текст, Поз2 + 2);
	КонецЦикла;
	
	// Переносы строк
	Текст = СтрЗаменить(Текст, Символы.ПС, "<br>");
	
	Возврат Текст;
	
КонецФункции

// Конвертация Markdown-таблиц в HTML
&НаСервере
Функция КонвертироватьТаблицыMarkdown(Знач Текст)
	
	Строки = СтрРазделить(Текст, Символы.ПС, Ложь);
	Результат = "";
	ВТаблице = Ложь;
	ПервыйРяд = Истина;
	
	Для Каждого Строка Из Строки Цикл
		СтрокаОбр = СокрЛП(Строка);
		
		// Проверяем, это строка таблицы?
		Если Лев(СтрокаОбр, 1) = "|" И Прав(СтрокаОбр, 1) = "|" Тогда
			
			// Пропускаем строку-разделитель (| --- | --- |)
			Если СтрНайти(СтрокаОбр, "---") > 0 Тогда
				Продолжить;
			КонецЕсли;
			
			// Начинаем таблицу
			Если НЕ ВТаблице Тогда
				Результат = Результат + "<table border=""1"" cellpadding=""5"" cellspacing=""0"" style=""border-collapse: collapse; margin: 10px 0;"">";
				ВТаблице = Истина;
				ПервыйРяд = Истина;
			КонецЕсли;
			
			// Парсим ячейки
			Ячейки = СтрРазделить(СтрокаОбр, "|", Ложь);
			
			Результат = Результат + "<tr>";
			Для Каждого Ячейка Из Ячейки Цикл
				ЯчейкаОбр = СокрЛП(Ячейка);
				Если ПервыйРяд Тогда
					Результат = Результат + "<th style=""background-color: #f0f0f0;"">" + ЯчейкаОбр + "</th>";
				Иначе
					Результат = Результат + "<td>" + ЯчейкаОбр + "</td>";
				КонецЕсли;
			КонецЦикла;
			Результат = Результат + "</tr>";
			ПервыйРяд = Ложь;
			
		Иначе
			// Закрываем таблицу, если была открыта
			Если ВТаблице Тогда
				Результат = Результат + "</table>";
				ВТаблице = Ложь;
			КонецЕсли;
			Результат = Результат + СтрокаОбр + Символы.ПС;
		КонецЕсли;
	КонецЦикла;
	
	// Закрываем таблицу в конце
	Если ВТаблице Тогда
		Результат = Результат + "</table>";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Функция ПолучитьБазовыйHTML()
	
	Возврат "<!DOCTYPE html>
	|<html>
	|<head>
	|<meta charset=""UTF-8"">
	|<style>
	|body { font-family: Arial, sans-serif; font-size: 14px; margin: 10px; }
	|p { margin: 8px 0; }
	|</style>
	|</head>
	|<body>";
	
КонецФункции

&НаКлиенте
Функция ПолучитьТекстИзФорматированногоДокумента(ФорматированныйДок)
	
	Если ТипЗнч(ФорматированныйДок) = Тип("ФорматированныйДокумент") Тогда
		Возврат ФорматированныйДок.ПолучитьТекст();
	Иначе
		Возврат Строка(ФорматированныйДок);
	КонецЕсли;
	
КонецФункции

// Прокрутка чата к последнему сообщению через DOM
&НаКлиенте
Процедура ПрокрутитьЧатВниз()
	
	// Пытаемся прокрутить к элементу с id="lastMessage"
	// Не все браузеры поддерживают scrollIntoView, оборачиваем в попытку
	Попытка
		Документ = Элементы.Поле1.Документ;
		Если Документ <> Неопределено Тогда
			ЭлементПоследний = Документ.getElementById("lastMessage");
			Если ЭлементПоследний <> Неопределено Тогда
				// Ложь = прокрутить так, чтобы элемент был внизу видимой области
				ЭлементПоследний.scrollIntoView(Ложь);
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Не все браузеры поддерживают метод scrollIntoView, игнорируем ошибку
		Возврат;
	КонецПопытки;
	
КонецПроцедуры

// Запрос на прокрутку после обновления содержимого
&НаКлиенте
Процедура ЗапроситьПрокрутку()
	
	НужнаПрокрутка = Истина;
	
КонецПроцедуры

// Отложенная прокрутка (для использования с ПодключитьОбработчикОжидания)
&НаКлиенте
Процедура ПрокрутитьЧатВнизОтложенно()
	
	ПрокрутитьЧатВниз();
	
КонецПроцедуры

#КонецОбласти
