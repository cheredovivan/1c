// BSLLS:UnusedLocalVariable-off

////////////////////////////////////////////////////////////////////////////////
// Логика завершения этапов производства (см. функцию ПрименитьВДокументахНаСервере_ЗавершитьЭтап_Рекурсивно):
//
// 1. При выборе строки в дереве этапов, реквизит "ОбработкаЭтапа_РедактируемыйЭтапПроизводства"
//    устанавливается как "ТекущиеДанные.ОсновнойЭтапПроизводства", а НЕ как "ТекущиеДанные.Ссылка".
//    Для конечных этапов ОсновнойЭтапПроизводства = самому себе.
//    Для предшествующих этапов ОсновнойЭтапПроизводства = родительский (конечный) этап.
//
// 2. Цикл завершения этапов вызывается ПОСЛЕ основного цикла записи документов.
//    Перечитывает объекты из базы и устанавливает статус "Завершен", если
//    КоличествоУпаковокФакт + КоличествоУпаковокОтменено >= КоличествоУпаковокПлан.
//
// fix 19.02.2026: Убрана проверка ЗаписанныеДокументы в цикле завершения.
//    Ранее этапы, уже записанные в основном цикле, пропускались при попытке завершения,
//    из-за чего статус "Завершен" не устанавливался даже при выполнении условия.
////////////////////////////////////////////////////////////////////////////////

Процедура ЭтапыПроизводства_ОбеспечитьКолонкуВыполненоДляТаблицы(ТаблицаДанных)
	
	Если ТаблицаДанных = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(ТаблицаДанных) <> Тип("ТаблицаЗначений") Тогда
		Возврат;
	КонецЕсли;
	
	Если ТаблицаДанных.Колонки.Найти("Выполнено") = Неопределено Тогда
		ТаблицаДанных.Колонки.Добавить("Выполнено", Новый ОписаниеТипов("Число"));
		Для Каждого СтрокаТаблицы Из ТаблицаДанных Цикл
			СтрокаТаблицы.Выполнено = 0;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

//* Открытие и закрытие формы ******************************************************************************************************************************
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Объект.РабочаяДата												= ТекущаяДатаСеанса();
	Отбор_СтатусыЭтаповПроизводства.Добавить(Перечисления.СтатусыЭтаповПроизводства2_2.Формируется);
	Отбор_СтатусыЭтаповПроизводства.Добавить(Перечисления.СтатусыЭтаповПроизводства2_2.Сформирован);
	Отбор_СтатусыЭтаповПроизводства.Добавить(Перечисления.СтатусыЭтаповПроизводства2_2.КВыполнению);
	Отбор_СтатусыЭтаповПроизводства.Добавить(Перечисления.СтатусыЭтаповПроизводства2_2.Начат);
	ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства		= Документы.ЭтапПроизводства2_2.ПустаяСсылка();
КонецПроцедуры
&НаСервере
Процедура ПриЗагрузкеДанныхИзНастроекНаСервере(Настройки)
	Отбор_Изделие_Выбрано											= НЕ(Настройки.Получить("Объект.Отбор_Изделие") = Справочники.Номенклатура.ПустаяСсылка()) И НЕ(Настройки.Получить("Объект.Отбор_Изделие") = Неопределено);
	Отбор_ПодразделениеИсполнитель_Выбрано							= НЕ(Настройки.Получить("Объект.Отбор_ПодразделениеИсполнитель") = Справочники.СтруктураПредприятия.ПустаяСсылка()) И НЕ(Настройки.Получить("Объект.Отбор_ПодразделениеИсполнитель") = Неопределено);
	Отбор_Спецификация_Выбрано										= НЕ(Настройки.Получить("Объект.Отбор_Спецификация") = Справочники.РесурсныеСпецификации.ПустаяСсылка()) И НЕ(Настройки.Получить("Объект.Отбор_Спецификация") = Неопределено);

	Обновить_ЭтапыПроизводстваПоИзделию								= Отбор_Изделие_Выбрано;
	Обновить_РедактированиеИспользованныхРесурсов					= Отбор_Изделие_Выбрано И Отбор_ПодразделениеИсполнитель_Выбрано И Отбор_Спецификация_Выбрано;
КонецПроцедуры
&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ИдетОткрытиеФормы												= Истина;
	Если (Обновить_ЭтапыПроизводстваПоИзделию) Тогда
		Ошибка														= "";
		Отбор_ИзделниеПриИзмененииНаСервере(Ошибка);
		
		Если НЕ(Ошибка = "") Тогда
			ПоказатьПредупреждение( , Ошибка, 15, "Информация...");
		КонецЕсли;
	КонецЕсли;
	//ПодключитьОбработчикОжидания("ПриОткрытии_Завершение", 1, Истина); 
	УстановитьДоступностьОтборов();
КонецПроцедуры
&НаКлиенте
Процедура ПриОткрытии_Завершение()
	ИдетОткрытиеФормы												= Ложь;
КонецПроцедуры
&НаКлиенте
Процедура ПередЗакрытием_Завершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	Если НЕ(РезультатВопроса = КодВозвратаДиалога.Да) Тогда Возврат; КонецЕсли;

	ОбработкаЭтапа_Начата											= Ложь;
	Закрыть();
КонецПроцедуры
&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	Если (ОбработкаЭтапа_Начата) Тогда
		Если (ОбработкаЭтапа_БылиИзменения) Тогда
			Попытка
					ОписаниеОповещения								= Новый ОписаниеОповещения("ПередЗакрытием_Завершение", ЭтотОбъект);
					ПоказатьВопрос(ОписаниеОповещения, "Все внесённые изменения будут утеряны. Закрыть рабочий стол?", РежимДиалогаВопрос.ДаНет);
					Отказ											= Истина;
				Исключение
					
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры
&НаСервере
Процедура ОбработкаОповещенияНаСервере(ДокументЭтапаПроизводства)
	//Найдем где был документ и обновим "Статус"
	врПараметрыОтбора												= Новый Структура;
	врПараметрыОтбора.Вставить("Ссылка",							ДокументЭтапаПроизводства);
	НайденныеСтроки													= Объект.ЭтапыПроизводстваПоИзделию.НайтиСтроки(врПараметрыОтбора);
	Если (НайденныеСтроки.Количество() = 0) Тогда
			врПараметрыОтбора										= Новый Структура;
			врПараметрыОтбора.Вставить("СсылкаПредшествующий",		ДокументЭтапаПроизводства);
			НайденныеСтроки											= Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.НайтиСтроки(врПараметрыОтбора);
			Если НЕ(НайденныеСтроки.Количество() = 0) Тогда
				НайденныеСтроки[0].Статус							= ДокументЭтапаПроизводства.Статус;
			КонецЕсли;
		Иначе
			НайденныеСтроки[0].Статус								= ДокументЭтапаПроизводства.Статус;
	КонецЕсли;
КонецПроцедуры
&НаКлиенте
Процедура ОбработкаОповещения_УстановитьСтрокуРекурсивно(СтрокиДерева, ЭтапПроизводстваТекущейСтрокиДерева, СтрокаРодитель, СтрокаУстановлена)
	Для Каждого врСтрокаД Из СтрокиДерева Цикл
		Если (врСтрокаД.Ссылка = ЭтапПроизводстваТекущейСтрокиДерева) Тогда
				Если НЕ(СтрокаРодитель = Неопределено) Тогда
					ИдентификаторСтроки								= СтрокаРодитель.ПолучитьИдентификатор();
					Элементы.ДеревоЭтапыПроизводстваПоИзделию.Развернуть(ИдентификаторСтроки, Истина);
				КонецЕсли;
				Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущаяСтрока= врСтрокаД.ПолучитьИдентификатор();
				СтрокаУстановлена									= Истина;
			ИначеЕсли НЕ(врСтрокаД.ПолучитьЭлементы().Количество() = 0) Тогда
				ОбработкаОповещения_УстановитьСтрокуРекурсивно(врСтрокаД.ПолучитьЭлементы(), ЭтапПроизводстваТекущейСтрокиДерева, врСтрокаД, СтрокаУстановлена)
			Иначе
				
		КонецЕсли;
		Если (СтрокаУстановлена) Тогда Прервать; КонецЕсли;
	КонецЦикла;

КонецПроцедуры
&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	Если (ИмяСобытия = "Запись_ЭтапыПроизводства") Тогда
		ОбработкаОповещенияНаСервере(Источник);
		Если НЕ(Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные = Неопределено) Тогда      
			ТекущаяСтрокаДерева										= Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные.ПолучитьИдентификатор();
			ЭтапПроизводстваТекущейСтрокиДерева						= Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные.Ссылка;
		КонецЕсли;
		Ошибка														= "";
		Отбор_ИзделниеПриИзмененииНаСервере(Ошибка);
		
		ОбработкаОповещения_УстановитьСтрокуРекурсивно(ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы(), ЭтапПроизводстваТекущейСтрокиДерева, Неопределено, Ложь);
	КонецЕсли;
КонецПроцедуры
//* Реагирование формы (основное) ***************************************************************************************************************************
&НаКлиенте
Процедура ОбновитьСписокЭтаповПроизводства(Команда)
	Ошибка															= "";
	Отбор_ИзделниеПриИзмененииНаСервере(Ошибка);
	
	Если НЕ(Ошибка = "") Тогда
		ПоказатьПредупреждение( , Ошибка, 15, "Информация...");
	КонецЕсли;
КонецПроцедуры
&НаСервере
Процедура Отбор_ИзделниеПриИзмененииНаСервере(Ошибка)
	Объект.ЭтапыПроизводстваПоИзделию.Очистить();
	Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.Очистить();
	ОчиститьСпискиДерево();

	//Если НЕ(ЗначениеЗаполнено(Объект.Отбор_Изделие)) Тогда
	//	Ошибка														= "Не выбрано изделие!";
	//	Возврат;
	//КонецЕсли;
	
	врТЗ															= ЭтапыПроизводства_НайтиПоИзделию(Объект.Отбор_Изделие, Отбор_СтатусыЭтаповПроизводства);
	Если (врТЗ = Неопределено) Тогда
		Ошибка														= "По выбранному изделию не найдено этапов со статусом ""Сформирован"", ""К выполннию"" или ""Начат""!";
		Возврат;
	КонецЕсли;
	
	Объект.ЭтапыПроизводстваПоИзделию.Загрузить(врТЗ);
	ЭтапыПроизводства_ПостроитьДеревоЭтапов();
	//ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства		= Объект.ЭтапыПроизводстваПоИзделию[0].ОсновнойЭтапПроизводства;  
	ЗаполнитьОтборы_ПодразделениеИсполнитель();
	ЗаполнитьОтборы_Спецификация();
	//ЗаполнитьОтборы_ЗаказНаПроизводство();
	
	Объект.Отбор_ИзделиеТекст										= СокрЛП(Объект.Отбор_Изделие);
КонецПроцедуры
&НаСервере
Процедура Отбор_ПодразделениеИсполнительПриИзмененииПриИзмененииНаСервере(Ошибка)
	Объект.ЭтапыПроизводстваПоИзделию.Очистить();
	Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.Очистить();
	ОчиститьСпискиДерево();

	Если НЕ(ЗначениеЗаполнено(Объект.Отбор_ПодразделениеИсполнитель)) Тогда
		Ошибка														= "Не выбрано ПодразделениеИсполнитель!";
		Возврат;
	КонецЕсли;
	
	врТЗ															= ЭтапыПроизводства_НайтиПоПодразделению(Объект.Отбор_ПодразделениеИсполнитель, Отбор_СтатусыЭтаповПроизводства);
	Если (врТЗ = Неопределено) Тогда
		Ошибка														= "По выбранному подразделению не найдено этапов со статусом ""Сформирован"", ""К выполннию"" или ""Начат""!";
		Возврат;
	КонецЕсли;
	
	Объект.ЭтапыПроизводстваПоИзделию.Загрузить(врТЗ);
	ЭтапыПроизводства_ПостроитьДеревоЭтапов();
	//ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства		= Объект.ЭтапыПроизводстваПоИзделию[0].ОсновнойЭтапПроизводства;
	ЗаполнитьОтборы_ПодразделениеИсполнитель();
	ЗаполнитьОтборы_Спецификация();
	//ЗаполнитьОтборы_ЗаказНаПроизводство();
	
	Объект.Отбор_ИзделиеТекст										= СокрЛП(Объект.Отбор_Изделие);
КонецПроцедуры
&НаКлиенте
Процедура Отбор_ИзделниеПриИзменении(Элемент)
	Ошибка															= "";
	Отбор_ИзделниеПриИзмененииНаСервере(Ошибка);
	
	Если НЕ(Ошибка = "") Тогда
		ПоказатьПредупреждение( , Ошибка, 15, "Информация...");
	КонецЕсли;
КонецПроцедуры
&НаКлиенте
Процедура Отбор_СписокЗначений_ПодразделениеИсполнительПриИзменении(Элемент)
	//Объект.Отбор_ПодразделениеИсполнитель							= Отбор_СписокЗначений_ПодразделениеИсполнитель;
	//ЗаполнитьОтборы_Спецификация(); 
	Ошибка															= "";
	Отбор_ПодразделениеИсполнительПриИзмененииПриИзмененииНаСервере(Ошибка);
	
	Если НЕ(Ошибка = "") Тогда
		ПоказатьПредупреждение( , Ошибка, 15, "Информация...");
	КонецЕсли	
КонецПроцедуры
&НаКлиенте
Процедура Отбор_СписокЗначений_СпецификацияПриИзменении(Элемент)
	Объект.Отбор_Спецификация										= Отбор_СписокЗначений_Спецификация;
КонецПроцедуры
&НаКлиенте
Процедура Отбор_СписокЗначений_ЗаказНаПроизводствоПриИзменении(Элемент)
	Объект.Отбор_ЗаказНаПроизводство								= Отбор_СписокЗначений_ЗаказНаПроизводство;
КонецПроцедуры
&НаКлиенте
Процедура ОбработкаЭтапа_РедактируемыйЭтапПроизводстваНажатие(Элемент, СтандартнаяОбработка)
	ПоказатьЗначение( , ОбработкаЭтапа_РедактируемыйЭтапПроизводства);
	СтандартнаяОбработка											= Ложь;
КонецПроцедуры
&НаКлиенте
Процедура Отбор_Изделние_ПояснениеНажатие(Элемент, СтандартнаяОбработка)
	ПоказатьЗначение( , Объект.Отбор_Изделие);
	СтандартнаяОбработка											= Ложь;
КонецПроцедуры
&НаКлиенте
Процедура ОбработкаЭтапа_РапределеноПриИзменении(Элемент)
	Если (ОбработкаЭтапа_Рапределено > ОбработкаЭтапа_Недодел) Тогда
			ПоказатьПредупреждение( , "Указанное количество к распределению большее, чем недоделано!", 15, "Информация...");
			ОбновитьДоступностьКнопкиПрименить();
		ИначеЕсли (ДеревоИспользованныхМатериалов.ПолучитьЭлементы().Количество() = 0) Тогда  
			ОбновитьДоступностьКнопкиПрименить();
			ОписаниеОповещения										= Новый ОписаниеОповещения("СформироватьТаблицуМатериалов_Завершение", ЭтотОбъект);
			ПоказатьВопрос(ОписаниеОповещения, "Сформировать таблицу материалов?", РежимДиалогаВопрос.ДаНет);
		Иначе  
			Ошибка													= "";
			Инициализировано										= СформироватьТаблицуМатериаловНаСервере_Инициализация(Ошибка);
			Если (ОбработкаЭтапа_БылиИзменения) Тогда
				ПоказатьПредупреждение( , "В таблицу использованных материалов были внесены изменения." + Символы.ПС + "При необходимости, для пересчета нажмите ""Материалы"".", 15, "Информация...");
			КонецЕсли;
			ОбновитьДоступностьКнопкиПрименить();
	КонецЕсли;
КонецПроцедуры
//* Реагирование формы (дерево этапов производства) *********************************************************************************************************
&НаКлиенте
Процедура ДеревоЭтапыПроизводстваПоИзделиюПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ															= Истина;
КонецПроцедуры
&НаКлиенте
Процедура ДеревоЭтапыПроизводстваПоИзделиюПередУдалением(Элемент, Отказ)
	Отказ															= Истина;
КонецПроцедуры
&НаСервере
Процедура ДеревоЭтапыПроизводстваПоИзделиюПриАктивизацииСтрокиНаСервере()
	ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводстваТекст	= "№ " + СокрЛП(ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства.Номер) + " от " + Формат(ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства.Дата, "ДЛФ=Д");
	ДеревоЭтапыПроизводстваПоИзделию_ЗаказНаПроизводствоТекст		= "№ " + СокрЛП(ДеревоЭтапыПроизводстваПоИзделию_ЗаказНаПроизводство.Номер) + " от " + Формат(ДеревоЭтапыПроизводстваПоИзделию_ЗаказНаПроизводство.Дата, "ДЛФ=Д");
КонецПроцедуры
&НаКлиенте
Процедура ДеревоЭтапыПроизводстваПоИзделиюПриАктивизацииСтроки(Элемент)
	ТекущиеДанные													= Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные;
	Если (ТекущиеДанные = Неопределено) Тогда Возврат; КонецЕсли;

	ЕстьИзменениеОсновногоЭтапаПроизводства							= НЕ(ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства = ТекущиеДанные.ОсновнойЭтапПроизводства);
	ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства		= ТекущиеДанные.ОсновнойЭтапПроизводства;
	Если НЕ(ИдетРасчетСписков) Тогда
		Если (ЕстьИзменениеОсновногоЭтапаПроизводства) Тогда
			ИдетРасчетСписков										= Истина;
			ДеревоЭтапыПроизводстваПоИзделию_ЗаказНаПроизводство	= ТекущиеДанные.ЗаказНаПроизводство;
			ЗаполнитьОтборы_ПодразделениеИсполнитель();
			ДеревоЭтапыПроизводстваПоИзделиюПриАктивизацииСтрокиНаСервере();
			//ЗаполнитьОтборы_Спецификация();
			//ЗаполнитьОтборы_ЗаказНаПроизводство();
			ИдетРасчетСписков										= Ложь;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры
&НаКлиенте
Процедура ДеревоЭтапыПроизводстваПоИзделиюВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	ПоказатьЗначение( , Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные.Ссылка);
	СтандартнаяОбработка												= Ложь;
КонецПроцедуры
&НаКлиенте
Процедура ДеревоЭтапыПроизводстваПоИзделию_ЗаказНаПроизводствоНажатие(Элемент, СтандартнаяОбработка)
	ПоказатьЗначение( , Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные.ЗаказНаПроизводство);
	СтандартнаяОбработка											= Ложь;
КонецПроцедуры
&НаКлиенте
Процедура ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводстваНажатие(Элемент, СтандартнаяОбработка)
	ПоказатьЗначение( , Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные.ОсновнойЭтапПроизводства);
	СтандартнаяОбработка											= Ложь;
КонецПроцедуры
&НаСервере
Процедура ВывестиСписок_ДеревоЭтапыПроизводстваПоИзделиюНаСервере_Рекурсивно(ТабДокумент, Макет, СтрокиДерева, Знач врУровень)     //не используется
	Для Каждого врСтрокаД Из СтрокиДерева Цикл
		ОбластьСтроки												= ?(врУровень = 0, Макет.ПолучитьОбласть("СтрокаОсновной"), Макет.ПолучитьОбласть("Строка"));
		ОбластьСтроки.Параметры.Заполнить(врСтрокаД);
		ОбластьСтроки.Область( , 1, , 1).Отступ						= врУровень; 
		ТабДокумент.Вывести(ОбластьСтроки, врУровень);   
		Если НЕ(врСтрокаД.ПолучитьЭлементы() = 0) Тогда
			ВывестиСписок_ДеревоЭтапыПроизводстваПоИзделиюНаСервере_Рекурсивно(ТабДокумент, Макет, врСтрокаД.ПолучитьЭлементы(), врУровень + 1)
		КонецЕсли;
	КонецЦикла;  
	ОбластьСтроки = Макет.ПолучитьОбласть("СтрокаОсновной");
	ОбластьСтроки.Параметры.Заполнить(СтрокиДерева.ОсновнойЭтапПроизводства);
	ОбластьСтроки.Область( , 1, , 1).Отступ	= врУровень;
	ТабДокумент.Вывести(ОбластьСтроки, врУровень);
КонецПроцедуры
&НаСервере
Функция   ВывестиСписок_ДеревоЭтапыПроизводстваПоИзделиюНаСервере()
	врОбъект														= РеквизитФормыВЗначение("Объект");
	Макет		      												= врОбъект.ПолучитьМакет("ДеревоЭтапов");
	
	ТабДокумент														= Новый ТабличныйДокумент;
	//Шапка
	ОбластьШапка													= Макет.ПолучитьОбласть("Шапка");
	ТабДокумент.Вывести(ОбластьШапка);
	
	ТабДокумент.НачатьАвтогруппировкуСтрок();
	ВывестиСписок_ДеревоЭтапыПроизводстваПоИзделиюНаСервере_Рекурсивно(ТабДокумент, Макет, ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы(), 0);
	ТабДокумент.ЗакончитьАвтогруппировкуСтрок();
	
	ТабДокумент.ТолькоПросмотр										= Истина;
	ТабДокумент.ФиксацияСверху										= 1;
	
	Возврат ТабДокумент;
КонецФункции
&НаКлиенте
Процедура ВывестиСписок_ДеревоЭтапыПроизводстваПоИзделию(Команда)
	ТабличныйДокумент												= ВывестиСписок_ДеревоЭтапыПроизводстваПоИзделиюНаСервере();
	
	КоллекцияПечатныхФорм											= УправлениеПечатьюКлиент.НоваяКоллекцияПечатныхФорм("Макет");
	ПечатнаяФорма													= УправлениеПечатьюКлиент.ОписаниеПечатнойФормы(КоллекцияПечатныхФорм, "Макет");
	ПечатнаяФорма.ТабличныйДокумент									= ТабличныйДокумент;
	КлючУникальности												= ЭтаФОрма.УникальныйИдентификатор;
	ПараметрыОткрытия												= Новый Структура("ИмяМенеджераПечати,ИменаМакетов,ПараметрКоманды,ПараметрыПечати");
	ПараметрыОткрытия.ПараметрКоманды								= Новый Массив;
	ПараметрыОткрытия.ПараметрыПечати								= Новый Структура;
	ПараметрыОткрытия.Вставить("КоллекцияПечатныхФорм",				КоллекцияПечатныхФорм);
	ОткрытьФорму("ОбщаяФорма.ПечатьДокументов", ПараметрыОткрытия, ВладелецФормы, КлючУникальности);
КонецПроцедуры
//* Реагирование формы (дерево использованных материалов) ***************************************************************************************************
&НаКлиенте
Процедура ДеревоИспользованныхМатериаловКоличествоУпаковокФактическиПриИзменении(Элемент)
	ТекущиеДанные														= Элементы.ДеревоИспользованныхМатериалов.ТекущиеДанные;
	Если (ТекущиеДанные = Неопределено) Тогда Возврат; КонецЕсли;
	
	ТекущиеДанные.ЕстьИзменение											= НЕ(ТекущиеДанные.КоличествоУпаковокТребуется = ТекущиеДанные.КоличествоУпаковокФактически); 
	
	ТекущиеДанные.КоличествоУпаковокНехватает = ТекущиеДанные.КоличествоУпаковокФактически - ТекущиеДанные.КоличествоУпаковокВНаличии;	
	
	ОбработкаЭтапа_БылиИзменения										= БылиИзменения();

	//Обновляем доступность с учётом всех проверок (материалы + исполнители)
	ОбновитьДоступностьКнопкиПрименить();
КонецПроцедуры
&НаКлиенте
Процедура ДеревоИспользованныхМатериаловВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	Если (Поле.Имя = "ДеревоИспользованныхМатериаловСсылка") Тогда
		ПоказатьЗначение( , Элементы.ДеревоИспользованныхМатериалов.ТекущиеДанные.Ссылка);
		СтандартнаяОбработка											= Ложь;
	КонецЕсли;
	Если (Поле.Имя = "ДеревоИспользованныхМатериаловНоменклатура") Тогда
		ИзменитьНоменклатуруМатериала(Неопределено);
		СтандартнаяОбработка											= Ложь;
	КонецЕсли;
КонецПроцедуры
&НаКлиенте
Процедура ДеревоИспользованныхМатериаловПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	Отказ																= Истина;
КонецПроцедуры
&НаКлиенте
Процедура ДеревоИспользованныхМатериаловПередУдалением(Элемент, Отказ)
	Отказ																= Истина;
КонецПроцедуры
&НаКлиенте
Процедура ДеревоИспользованныхМатериаловПередНачаломИзменения(Элемент, Отказ)
	Если НЕ(Элементы.ДеревоИспользованныхМатериалов.ТекущиеДанные.ИзменениеДоступно) Тогда
		ПоказатьПредупреждение( , "Нельзя редактировать строку (статус ""Завершен"")!", 15, "Информация...");
		Отказ															= Истина;
	КонецЕсли;
КонецПроцедуры
&НаСервере
Процедура ВывестиСписок_ДеревоИспользованныхМатериаловНаСервере_Рекурсивно(ТабДокумент, Макет, СтрокиДерева, Знач врУровень)
	Для Каждого врСтрокаД Из СтрокиДерева Цикл
		ОбластьСтроки												= Макет.ПолучитьОбласть("Строка");
		ОбластьСтроки.Параметры.Заполнить(врСтрокаД);
		ОбластьСтроки.Параметры.НоменклатураКод						= врСтрокаД.Номенклатура.Код;
		ОбластьСтроки.Область( 1, 1, 1, 1).ОтступСлева				= врУровень;	
		ТабДокумент.Вывести(ОбластьСтроки, врУровень);
		Если НЕ(врСтрокаД.ПолучитьЭлементы() = 0) Тогда
			ВывестиСписок_ДеревоИспользованныхМатериаловНаСервере_Рекурсивно(ТабДокумент, Макет, врСтрокаД.ПолучитьЭлементы(), врУровень + 1)
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
&НаСервере
Функция   ВывестиСписок_ДеревоИспользованныхМатериаловНаСервере()
	врОбъект														= РеквизитФормыВЗначение("Объект");
	Макет		      												= врОбъект.ПолучитьМакет("ДеревоМатериалов");
	
	ТабДокумент														= Новый ТабличныйДокумент;
	//Шапка
	ОбластьШапка													= Макет.ПолучитьОбласть("Шапка");
	ТабДокумент.Вывести(ОбластьШапка);
	
	ТабДокумент.НачатьАвтогруппировкуСтрок();
	ВывестиСписок_ДеревоИспользованныхМатериаловНаСервере_Рекурсивно(ТабДокумент, Макет, ДеревоИспользованныхМатериалов.ПолучитьЭлементы(), 0);
	ТабДокумент.ЗакончитьАвтогруппировкуСтрок();
	
	ТабДокумент.ТолькоПросмотр										= Истина;
	ТабДокумент.ФиксацияСверху										= 1;
	
	Возврат ТабДокумент;
КонецФункции
&НаКлиенте
Процедура ВывестиСписок_ДеревоИспользованныхМатериалов(Команда)
	ТабличныйДокумент												= ВывестиСписок_ДеревоИспользованныхМатериаловНаСервере();
	
	КоллекцияПечатныхФорм											= УправлениеПечатьюКлиент.НоваяКоллекцияПечатныхФорм("Макет");
	ПечатнаяФорма													= УправлениеПечатьюКлиент.ОписаниеПечатнойФормы(КоллекцияПечатныхФорм, "Макет");
	ПечатнаяФорма.ТабличныйДокумент									= ТабличныйДокумент;
	КлючУникальности												= ЭтаФОрма.УникальныйИдентификатор;
	ПараметрыОткрытия												= Новый Структура("ИмяМенеджераПечати,ИменаМакетов,ПараметрКоманды,ПараметрыПечати");
	ПараметрыОткрытия.ПараметрКоманды								= Новый Массив;
	ПараметрыОткрытия.ПараметрыПечати								= Новый Структура;
	ПараметрыОткрытия.Вставить("КоллекцияПечатныхФорм",				КоллекцияПечатныхФорм);
	ОткрытьФорму("ОбщаяФорма.ПечатьДокументов", ПараметрыОткрытия, ВладелецФормы, КлючУникальности);
КонецПроцедуры
//* Дерево этапов производства ******************************************************************************************************************************
&НаСервере
Функция   ЭтапыПроизводства_ПостроитьДеревоЭтапов_ДобавитьПредшествующиеРекурсивно(Знач ТЗПредшествующих, СтрокаКорняДерева, СтрокаВерхнегоУровня, Знач врУровень)
	ДобавленоЭтапов													= 0;
	ЭтапыПроизводства_ОбеспечитьКолонкуВыполненоДляТаблицы(ТЗПредшествующих);
	ЭтапыПроизводства_ОбеспечитьКолонкуВыполненоДляТаблицы(Объект.ЭтапыПроизводстваПоИзделиюПредшествующие);
	Для Каждого врСтрокаД Из ТЗПредшествующих Цикл
		//Сначала надо проверить есть ли предшествующие и закрыт ли текущий
		ПредшествующиеЭтапы											= ЭтапыПроизводства_НайтиПредшествующие(врСтрокаД.СсылкаПредшествующий);
		Если ((ПредшествующиеЭтапы = Неопределено) И (врСтрокаД.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен)) Тогда Продолжить;	КонецЕсли;
		
		Если врСтрокаД.СсылкаПредшествующий.Подразделение = СтрокаКорняДерева.Ссылка.Подразделение Тогда
			//Добавим в ТЗ
			нСтр														= Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.Добавить();
			ЗаполнитьЗначенияСвойств(нСтр, врСтрокаД);
			нСтр.Ссылка													= СтрокаКорняДерева.Ссылка;
			нСтр.УровеньИерархии										= врУровень + 1;
			//Добавим в дерево
			нСтрокаВерхнегоУровня										= СтрокаВерхнегоУровня.ПолучитьЭлементы().Добавить();
			ЗаполнитьЗначенияСвойств(нСтрокаВерхнегоУровня, врСтрокаД);
			нСтрокаВерхнегоУровня.УровеньИерархии						= врУровень + 1;
			нСтрокаВерхнегоУровня.Ссылка								= врСтрокаД.СсылкаПредшествующий;
			нСтрокаВерхнегоУровня.ОсновнойЭтапПроизводства				= СтрокаКорняДерева.Ссылка;
			
			ДобавленоЭтапов												= ДобавленоЭтапов + 1; 
			Иначе Продолжить; // Чтобы не проваливаться сквозь этапы других цехов --- ТУТ именно "продолжить"
		КонецЕсли;
		
		Если НЕ(ПредшествующиеЭтапы = Неопределено) Тогда
			ДобавленоЭтаповПредшествующих							= ЭтапыПроизводства_ПостроитьДеревоЭтапов_ДобавитьПредшествующиеРекурсивно(ПредшествующиеЭтапы, СтрокаКорняДерева, нСтрокаВерхнегоУровня, врУровень + 1);
			Если ((ДобавленоЭтаповПредшествующих = 0) И (врСтрокаД.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен)) Тогда
				Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.Удалить(Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.Индекс(нСтр));
				СтрокаВерхнегоУровня.ПолучитьЭлементы().Удалить(СтрокаВерхнегоУровня.ПолучитьЭлементы().Индекс(нСтрокаВерхнегоУровня));
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат ДобавленоЭтапов;
КонецФункции
&НаСервере
Процедура ЭтапыПроизводства_ПостроитьДеревоЭтапов()
	ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы().Очистить();
	ЭтапыПроизводства_ОбеспечитьКолонкуВыполненоДляТаблицы(Объект.ЭтапыПроизводстваПоИзделию);
	ЭтапыПроизводства_ОбеспечитьКолонкуВыполненоДляТаблицы(Объект.ЭтапыПроизводстваПоИзделиюПредшествующие);
	ТекущийЭтап														= Неопределено;
	ОсновнойЭтапПроизводства										= Неопределено;
	Для Каждого врСтрока Из Объект.ЭтапыПроизводстваПоИзделию Цикл
		Если НЕ(ТекущийЭтап = врСтрока.Ссылка) Тогда
			Если НЕ(ОсновнойЭтапПроизводства = Неопределено) Тогда
				ОсновнойЭтапПроизводства.КоличествоПредшествующих	= ОсновнойЭтапПроизводства.ПолучитьЭлементы().Количество();
			КонецЕсли;
			ТекущийЭтап												= врСтрока.Ссылка;
		КонецЕсли;
		
		ОсновнойЭтапПроизводства									= ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы().Добавить();
		ЗаполнитьЗначенияСвойств(ОсновнойЭтапПроизводства, врСтрока);
		ОсновнойЭтапПроизводства.ОсновнойЭтапПроизводства			= ОсновнойЭтапПроизводства.Ссылка;
		ОсновнойЭтапПроизводства.ИзделиеПолуфабрикат				= Объект.Отбор_Изделие;
		
		//ПредшествующиеЭтапы											= ЭтапыПроизводства_НайтиПредшествующие(ОсновнойЭтапПроизводства.Ссылка);
		ПредшествующиеЭтапы											= ЭтапыПроизводства_НайтиПредшествующие(врСтрока.Ссылка); //тут все нормально, этапы есть
		Если (ПредшествующиеЭтапы = Неопределено) Тогда Продолжить; КонецЕсли;
		
		ЭтапыПроизводства_ПостроитьДеревоЭтапов_ДобавитьПредшествующиеРекурсивно(ПредшествующиеЭтапы, ОсновнойЭтапПроизводства, ОсновнойЭтапПроизводства, 0);
	КонецЦикла;
	
	// Вычисляем "Выполнено" для всех строк дерева
	ЭтапыПроизводства_ВычислитьВыполнено(ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы());
КонецПроцедуры
&НаСервере
Процедура ЭтапыПроизводства_ВычислитьВыполнено(СтрокиДерева)
	Для Каждого врСтрокаД Из СтрокиДерева Цикл
		Если НЕ(врСтрокаД.Ссылка = Неопределено) Тогда
			// Для этапов с ПроизводствоНаСтороне = Истина считаем по табличным частям
			// Для остальных этапов используем реквизит КоличествоУпаковокФакт
			врВыполнено = 0;
			врКоличествоУпаковокПлан = 0;
			врКоличествоУпаковокОтменено = 0;
			
			// Проверяем, является ли этап производством на стороне
			Запрос = Новый Запрос;
			Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ЭтапПроизводства2_2.ПроизводствоНаСтороне КАК ПроизводствоНаСтороне,
			|	ЭтапПроизводства2_2.КоличествоУпаковокФакт КАК КоличествоУпаковокФакт,
			|	ЭтапПроизводства2_2.КоличествоУпаковокПлан КАК КоличествоУпаковокПлан,
			|	ЭтапПроизводства2_2.КоличествоУпаковокОтменено КАК КоличествоУпаковокОтменено
			|ИЗ
			|	Документ.ЭтапПроизводства2_2 КАК ЭтапПроизводства2_2
			|ГДЕ
			|	ЭтапПроизводства2_2.Ссылка = &Ссылка";
			
			Запрос.УстановитьПараметр("Ссылка", врСтрокаД.Ссылка);
			РезультатЗапроса = Запрос.Выполнить();
			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
			
			Если ВыборкаДетальныеЗаписи.Следующий() Тогда
				врКоличествоУпаковокПлан = ВыборкаДетальныеЗаписи.КоличествоУпаковокПлан;
				врКоличествоУпаковокОтменено = ВыборкаДетальныеЗаписи.КоличествоУпаковокОтменено;
				Если ВыборкаДетальныеЗаписи.ПроизводствоНаСтороне Тогда
					// Считаем сумму по табличным частям
					// Сначала проверяем, есть ли строки в ВыходныеИзделия с Произведено = ИСТИНА
					Запрос = Новый Запрос;
					Запрос.Текст = 
					"ВЫБРАТЬ
					|	КОЛИЧЕСТВО(ВыходныеИзделия.Ссылка) КАК КоличествоСтрок,
					|	ЕСТЬNULL(СУММА(ВыходныеИзделия.КоличествоУпаковок), 0) КАК Сумма
					|ИЗ
					|	Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК ВыходныеИзделия
					|ГДЕ
					|	ВыходныеИзделия.Ссылка = &Ссылка
					|	И НЕ ВыходныеИзделия.Отменено";
					
					Запрос.УстановитьПараметр("Ссылка", врСтрокаД.Ссылка);
					РезультатЗапроса = Запрос.Выполнить();
					ВыборкаВыходные = РезультатЗапроса.Выбрать();
					
					Если ВыборкаВыходные.Следующий() И ВыборкаВыходные.КоличествоСтрок > 0 Тогда
						// Используем ВыходныеИзделия - сумма всех строк
						Если ЗначениеЗаполнено(ВыборкаВыходные.Сумма) Тогда
							врВыполнено = ВыборкаВыходные.Сумма;
						КонецЕсли;
					Иначе
						// Используем ПобочныеИзделия (без проверки Произведено, так как такого реквизита нет)
						Запрос = Новый Запрос;
						Запрос.Текст = 
						"ВЫБРАТЬ
						|	ЕСТЬNULL(СУММА(ПобочныеИзделия.КоличествоУпаковок), 0) КАК Сумма
						|ИЗ
						|	Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК ПобочныеИзделия
						|ГДЕ
						|	ПобочныеИзделия.Ссылка = &Ссылка
						|	И НЕ ПобочныеИзделия.Отменено";
						
						Запрос.УстановитьПараметр("Ссылка", врСтрокаД.Ссылка);
						РезультатЗапроса = Запрос.Выполнить();
						ВыборкаПобочные = РезультатЗапроса.Выбрать();
						
						Если ВыборкаПобочные.Следующий() И ЗначениеЗаполнено(ВыборкаПобочные.Сумма) Тогда
							врВыполнено = ВыборкаПобочные.Сумма;
						КонецЕсли;
					КонецЕсли;
				Иначе
					// Используем реквизит КоличествоУпаковокФакт
					Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.КоличествоУпаковокФакт) Тогда
						врВыполнено = ВыборкаДетальныеЗаписи.КоличествоУпаковокФакт;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
			
			// Обновляем значение для отображения в колонке "Выполнено"
			Попытка
				врСтрокаД.КоличествоУпаковокФакт = врВыполнено;
			Исключение
				// Если колонка не определена (например, для прочих узлов), просто пропускаем
			КонецПопытки;
			
			// Вычисляем и записываем "Недодел" = План - Факт - Отменено
			Попытка
				врСтрокаД.Недодел = врКоличествоУпаковокПлан - врВыполнено - врКоличествоУпаковокОтменено;
			Исключение
				// Если колонка не определена, просто пропускаем
			КонецПопытки;
		КонецЕсли;
		
		// Рекурсивно обрабатываем дочерние элементы
		Если НЕ(врСтрокаД.ПолучитьЭлементы().Количество() = 0) Тогда
			ЭтапыПроизводства_ВычислитьВыполнено(врСтрокаД.ПолучитьЭлементы());
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
//* Дерево использованных материалов ************************************************************************************************************************
&НаСервере
Функция   СформироватьТаблицуМатериаловНаСервере_СкопироватьВетвьДерева(врИсточник, врПриемник, СтрокаДерева = Неопределено)
	Для Каждого врСтрокаД Из врИсточник.ПолучитьЭлементы() Цикл
		Если ((врСтрокаД = СтрокаДерева) ИЛИ (СтрокаДерева = Неопределено)) Тогда
			нСтрД														= врПриемник.ПолучитьЭлементы().Добавить();
			ЗаполнитьЗначенияСвойств(нСтрД, врСтрокаД);
			Если НЕ(врСтрокаД.ПолучитьЭлементы().Количество() = 0) Тогда
				СформироватьТаблицуМатериаловНаСервере_СкопироватьВетвьДерева(врСтрокаД, нСтрД);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат врПриемник.ПолучитьЭлементы();
КонецФункции
&НаСервере
Функция   СформироватьТаблицуМатериаловНаСервере_ПолучитьСтрокуДерева_ОсновнойЭтап(Ошибка)
	РедактируемыйЭтапПроизводства_СтрокаДерева							= Неопределено;
	Для Каждого врСтрокаД Из ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы() Цикл
		Если (врСтрокаД.Ссылка = ОбработкаЭтапа_РедактируемыйЭтапПроизводства) Тогда
			РедактируемыйЭтапПроизводства_СтрокаДерева					= врСтрокаД;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	Если (РедактируемыйЭтапПроизводства_СтрокаДерева = Неопределено) Тогда
		Ошибка															= "В дереве этапов не найден редактируемый этап!";
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат РедактируемыйЭтапПроизводства_СтрокаДерева;
КонецФункции
&НаСервере
Функция   СформироватьТаблицуМатериаловНаСервере_ПолучитьТрокуДерева_Предшествующие(СтрокаДерева, Ошибка)
	ПредшествующиеЭтапыПроизводства_СтрокиДерева						= СтрокаДерева.ПолучитьЭлементы();
	Если (ПредшествующиеЭтапыПроизводства_СтрокиДерева.Количество() = 0) Тогда
		Ошибка															= "У выбранного этапа производства нет предшествующих этапов!";
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат ПредшествующиеЭтапыПроизводства_СтрокиДерева;
КонецФункции
&НаСервере
Функция   СформироватьТаблицуМатериаловНаСервере_Получить_СписокПолуфабрикатов(СтрокиДерева)
	ИзделияПолуфабрикаты												= Новый СписокЗначений;
	Для Каждого врСтрокаД Из СтрокиДерева Цикл
		ИзделияПолуфабрикаты.Добавить(врСтрокаД.ИзделиеПолуфабрикат);
	КонецЦикла;
	
	Возврат ИзделияПолуфабрикаты;
КонецФункции
&НаСервере
Процедура СформироватьТаблицуМатериаловНаСервере_ПотребностьИзделийПолуфабрикатовКонечногоЭтапа(ИзделияПолуфабрикаты, Ошибка)
	врТЗ																= Объект.ПотребностьИзделийПолуфабрикатовКонечногоЭтапа;
	врТЗ.Очистить();
	
	//Заполним материалы редактируемого этапа производства по спецификации исходя из указанного количества "ОбработкаЭтапа_Рапределено"
	РедактируемыйЭтапПроизводства_СтрокаДерева							= Неопределено;
	Для Каждого врСтрокаД Из ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы() Цикл
		Если (врСтрокаД.Ссылка = ОбработкаЭтапа_РедактируемыйЭтапПроизводства) Тогда
			РедактируемыйЭтапПроизводства_СтрокаДерева					= врСтрокаД;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	Если (РедактируемыйЭтапПроизводства_СтрокаДерева = Неопределено) Тогда
		Ошибка															= "В дереве этапов производства не найден редактируемый этап!";
		Возврат;
	КонецЕсли;

	врСпецификация														= РедактируемыйЭтапПроизводства_СтрокаДерева.Спецификация;
	      
	//Коэффициент для расчета выходного изделия - строка ТЧ "ВыходныеИзделия" 
	врКоэффициентКоличества												= 0;
	Для Каждого врСтрока Из врСпецификация.ВыходныеИзделия Цикл
		Если (врСтрока.Номенклатура = Объект.Отбор_Изделие) Тогда
			врКоэффициентКоличества										= врСтрока.КоличествоУпаковок;
			Прервать;
		КонецЕсли;
	КонецЦикла;      
	//добавил 30.10.24 чтобы оформлять побочный выпуск
	Если (врКоэффициентКоличества = 0) Тогда
		Для Каждого врСтрока Из ОбработкаЭтапа_РедактируемыйЭтапПроизводства.ПобочныеИзделия Цикл
			Если (врСтрока.Номенклатура = Объект.Отбор_Изделие) Тогда
				врКоэффициентКоличества										= врСпецификация.ОсновноеИзделиеКоличествоУпаковок;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	                
	
	Если (врКоэффициентКоличества = 0) Тогда
			Ошибка														= "Не удалось определить по спецификации """ + СокрЛП(врСпецификация) + """количество выпускаемых изделий (""" + СокрЛП(Объект.Отбор_Изделие) + """)!";
		Возврат;
	КонецЕсли;
	
	//Подготовим таблицу расчета по формулам
	врТаблица															= ОбщегоНазначенияУТ.ВыгрузитьТаблицуЗначений(врСпецификация.МатериалыИУслуги,, "НомерСтроки,АлгоритмРасчетаКоличества", Новый Структура("Формула", ""));
	врНаборДанных														= Новый Массив;
	врНаборДанных.Добавить(врТаблица);
	врОписание															= Справочники.МаршрутныеКарты.ОписаниеИсточниковДанныхОперандов();
	врПараметры															= УправлениеДаннымиОбИзделиях.ПараметрыДляРасчетаПоФормулам(врОписание, врНаборДанных);
	врПараметрыСтруктура												= Новый Структура;
	Для Каждого врСтрокаФ Из врПараметры Цикл
		врПараметрыСтруктура.Вставить(врСтрокаФ.ИмяПараметра,			ОбработкаЭтапа_Рапределено);
	КонецЦикла;
	//Берем ТЧ "МатериалыИУслуги" и выполняем рассчеты (в ТЧ указано количество на "врКоэффициентКоличества")
	Для Каждого врСтрока Из врСпецификация.МатериалыИУслуги Цикл
		//Убрал, т. к. вне ТЗ появилось требование выводить так же и конечный этап
		//Если (ИзделияПолуфабрикаты.НайтиПоЗначению(врСтрока.Номенклатура) = Неопределено) Тогда Продолжить; КонецЕсли;
		
		нСтр															= врТЗ.Добавить();
		нСтр.Номенклатура												= врСтрока.Номенклатура;
		нСтр.Упаковка													= врСтрока.Упаковка;
		Если (врСтрока.АлгоритмРасчетаКоличества = "") Тогда
				нСтр.КоличествоУпаковок									= ОбработкаЭтапа_Рапределено * врСтрока.КоличествоУпаковок / врКоэффициентКоличества;
			Иначе
				Для Каждого врСтрокаФ Из врПараметры Цикл
					Если (врСтрокаФ.ДанныеСтроки.НомерСтроки = врСтрока.НомерСтроки) Тогда
						Попытка
								нСтр.КоличествоУпаковок					= ОбщегоНазначения.ВычислитьВБезопасномРежиме(врСтрокаФ.ДанныеСтроки.Формула, врПараметрыСтруктура);
							Исключение
								нСтр.КоличествоУпаковок					= 0;
						КонецПопытки;
					КонецЕсли;
				КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	//И добавим еще строку - конечное изделие
	нСтр																= врТЗ.Добавить();
	нСтр.Номенклатура													= Объект.Отбор_Изделие;
	нСтр.Упаковка														= Объект.Отбор_Изделие.ЕдиницаИзмерения;
	нСтр.КоличествоУпаковок												= ОбработкаЭтапа_Рапределено;
	
	Возврат;
КонецПроцедуры

&НаСервере
Процедура СформироватьТаблицуМатериаловНаСервере_Рекурсивно(Знач врЭтапыПредшествующие, СтрокаДерева, Знач ИзделиеПолуфабрикат = Неопределено, Знач ТЗКоличествоИзделийПолуфабрикатов, Ошибка, КешМатериалов)

	Для Каждого врСтрока01 Из врЭтапыПредшествующие Цикл
		Если НЕ(ИзделиеПолуфабрикат = Неопределено) Тогда
			Если НЕ(врСтрока01.ИзделиеПолуфабрикат = ИзделиеПолуфабрикат) Тогда
				ЕстьСовпадение = Ложь;
				Для Каждого врСтрока03 Из врСтрока01.Ссылка.ПобочныеИзделия Цикл
					Если (врСтрока03.Номенклатура = ИзделиеПолуфабрикат) Тогда
				    	ЕстьСовпадение = Истина;
					КонецЕсли; 
				КонецЦикла;
				Если (ЕстьСовпадение = Ложь) Тогда Продолжить; КонецЕсли;
			КонецЕсли; 
		КонецЕсли;	
		
		//Определим требуемое количество, исходя из редактируемой спецификации 
		ОбработкаЭтапа_Рапределено_ПоСпецификации = 0;
		НайденнаяСтрока	= ТЗКоличествоИзделийПолуфабрикатов.Найти(врСтрока01.ИзделиеПолуфабрикат);
		Если НЕ(НайденнаяСтрока = Неопределено) Тогда
			ОбработкаЭтапа_Рапределено_ПоСпецификации				= НайденнаяСтрока.КоличествоУпаковок;
			НайденнаяНоменклатураПолуфабриката = НайденнаяСтрока.Номенклатура;
		Иначе     // добавил 09.07.25 чтобы заполнялось количество требуется по этапам в рамках одной РС
			Для Каждого врСтрока03 Из врСтрока01.Ссылка.ПобочныеИзделия Цикл
				НайденнаяСтрока = ТЗКоличествоИзделийПолуфабрикатов.Найти(врСтрока03.Номенклатура);
				Если НЕ(НайденнаяСтрока = Неопределено) Тогда
					ОбработкаЭтапа_Рапределено_ПоСпецификации = НайденнаяСтрока.КоличествоУпаковок;
					НайденнаяНоменклатураПолуфабриката = НайденнаяСтрока.Номенклатура;
					Прервать;
				КонецЕсли;	
			КонецЦикла;	
			//Ошибка													= Ошибка + "Не найдено требуемое количество предшествующего изделия """ + СокрЛП(врСтрока01.ИзделиеПолуфабрикат) + """!" + Символы.ПС;
		КонецЕсли;		
			
		
		//Получим спецификацию и коэффициент расчета (коэффициент для расчета материалов - строка ТЧ "ВыходныеИзделия")
		врСпецификация													= врСтрока01.Спецификация;
		//ПроизводственныеЭтапыСпецификации								= ПолучитьСтруктуруПроизводственныхЭтаповСпецификации(врСпецификация, Объект.Отбор_ПодразделениеИсполнитель);
		врКоэффициентКоличества											= 0;
		Для Каждого врСтрока02 Из врСпецификация.ВыходныеИзделия Цикл
			Если (врСтрока02.Номенклатура = НайденнаяНоменклатураПолуфабриката) Тогда //врСтрока01.ИзделиеПолуфабрикат) Тогда
				врКоэффициентКоличества									= врСтрока02.КоличествоУпаковок;
				Прервать;
			КонецЕсли;
		КонецЦикла; 
		Если (врКоэффициентКоличества = 0) Тогда		
			Для Каждого врСтрока02 Из врСпецификация.ВозвратныеОтходы Цикл
				Если (врСтрока02.Номенклатура = НайденнаяНоменклатураПолуфабриката) Тогда //врСтрока01.ИзделиеПолуфабрикат) Тогда
					врКоэффициентКоличества									= врСтрока02.КоличествоУпаковок;
					Прервать;
				КонецЕсли;
			КонецЦикла;	
		КонецЕсли;		
		
		Если (врКоэффициентКоличества = 0) Тогда
			Ошибка														= "Не удалось определить по спецификации """ + СокрЛП(врСпецификация) + """количество выпускаемых изделий (""" + СокрЛП(врСтрока01.ИзделиеПолуфабрикат) + """)!";
			Возврат;
		КонецЕсли;
		
		//Подготовим таблицу расчета по формулам (если такие есть в спецификации)
		врТаблица														= ОбщегоНазначенияУТ.ВыгрузитьТаблицуЗначений(врСпецификация.МатериалыИУслуги,, "НомерСтроки,АлгоритмРасчетаКоличества", Новый Структура("Формула", ""));
		врНаборДанных													= Новый Массив;
		врНаборДанных.Добавить(врТаблица);
		врОписание														= Справочники.МаршрутныеКарты.ОписаниеИсточниковДанныхОперандов();
		врПараметры														= УправлениеДаннымиОбИзделиях.ПараметрыДляРасчетаПоФормулам(врОписание, врНаборДанных);
		врПараметрыСтруктура											= Новый Структура;
		Для Каждого врСтрокаФ Из врПараметры Цикл
			врПараметрыСтруктура.Вставить(врСтрокаФ.ИмяПараметра,		ОбработкаЭтапа_Рапределено_ПоСпецификации);
		КонецЦикла;
		
		//Добавлять строки надо с условием по подразделению-исполнителю, этапу и спецификации, при этом сохраняя рекурсивность. Берем ТЧ "МатериалыИУслуги" и выполняем рассчеты (в ТЧ указано количество на "врКоэффициентКоличества")
		нСтр															= Неопределено;
		врСтруктураСтроки												= Новый Структура;

		Для Каждого врСтрока02 Из врСпецификация.МатериалыИУслуги Цикл
				
			РеквизитВспомогательныйМатериал = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "ВспомогательныйМатериал_a6ab234c1428470d81365a2df40445b9");
			ЗначениеРеквизитаВспомогательныйМатериал = УправлениеСвойствами.ЗначениеСвойства(врСтрока02.Номенклатура, РеквизитВспомогательныйМатериал);
			Если (ЗначениеРеквизитаВспомогательныйМатериал <> Неопределено) Тогда
				ДобавитьЭтуСтроку = Ложь;
			Иначе
				ДобавитьЭтуСтроку = (врСтрока01.ПодразделениеИсполнитель = Объект.Отбор_ПодразделениеИсполнитель) И (врСтрока01.Ссылка.Этап = врСтрока02.Этап) И НЕ(врСтрока01.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен);  
				//ДобавитьЭтуСтроку = (врСтрока01.ПодразделениеИсполнитель = Объект.Отбор_ПодразделениеИсполнитель) И (врСтрока01.Ссылка.Этап = врСтрока02.ЭтапРедактирование) И НЕ(врСтрока01.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен);
			КонецЕсли;
			
			Если (врСтрока02.АлгоритмРасчетаКоличества = "") Тогда
				врКоличествоУпаковокТребуется = ОбработкаЭтапа_Рапределено_ПоСпецификации * врСтрока02.КоличествоУпаковок / врКоэффициентКоличества;
			Иначе
				Для Каждого врСтрокаФ Из врПараметры Цикл
					Если (врСтрокаФ.ДанныеСтроки.НомерСтроки = врСтрока02.НомерСтроки) Тогда
						Попытка
							врКоличествоУпаковокТребуется		= ОбщегоНазначения.ВычислитьВБезопасномРежиме(врСтрокаФ.ДанныеСтроки.Формула, врПараметрыСтруктура);
						Исключение
							врКоличествоУпаковокТребуется		= 0;
						КонецПопытки;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
						
			врУпаковка													= ?(ЗначениеЗаполнено(врСтрока02.Упаковка), врСтрока02.Упаковка, врСтрока02.Номенклатура.ЕдиницаИзмерения);
			//СтруктураОстатков= ПолучитьТекущийОстаток_ИзТаблицыЗначений(врСтрока01.Ссылка, врСтрока02.Номенклатура, врУпаковка, врКоличествоУпаковокТребуется);
			СтруктураОстатков = ПолучитьТекущийОстаток_ИзТаблицыЗначений(врСтрока01.Ссылка, врСтрока02.Номенклатура, врСтрока02.КлючСвязи ,врУпаковка, врКоличествоУпаковокТребуется);//Изменил 08.09.25
			
			Если СтруктураОстатков.Количество() = 0 Тогда  // СтруктураОстатков будет пустая, если не совпадает назначение номенклатуры. 
				Продолжить;
			КонецЕсли; 
			
			КоличествоУпаковокНехватает = врКоличествоУпаковокТребуется - СтруктураОстатков.КоличествоУпаковокВНаличии;
			
			врСтруктураСтроки.Вставить("Номенклатура",						врСтрока02.Номенклатура);
			врСтруктураСтроки.Вставить("Упаковка",							врУпаковка);
			врСтруктураСтроки.Вставить("Ссылка",							врСтрока01.Ссылка);
			врСтруктураСтроки.Вставить("ИзменениеДоступно",					?(врСтрока01.Ссылка.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен, Ложь, Истина));
			врСтруктураСтроки.Вставить("КоличествоУпаковокТребуется",		врКоличествоУпаковокТребуется);
			врСтруктураСтроки.Вставить("КоличествоУпаковокФактически",		врКоличествоУпаковокТребуется);
			врСтруктураСтроки.Вставить("КоличествоУпаковокВНаличии",		СтруктураОстатков.КоличествоУпаковокВНаличии);
			врСтруктураСтроки.Вставить("КоличествоУпаковокВНаличииТекст",	СтруктураОстатков.КоличествоУпаковокВНаличииТекст);
			врСтруктураСтроки.Вставить("НоменклатураИсходная",				врСтрока02.Номенклатура);
			врСтруктураСтроки.Вставить("ИдентификаторСтроки",				Строка(Новый УникальныйИдентификатор()));
			врСтруктураСтроки.Вставить("ПроизводитсяВПроцессе",				СтруктураОстатков.ПроизводитсяВПроцессе);
			врСтруктураСтроки.Вставить("КоличествоУпаковокНехватает",		КоличествоУпаковокНехватает);
			врСтруктураСтроки.Вставить("Назначение", СтруктураОстатков.Назначение);
			врСтруктураСтроки.Вставить("Характеристика", СтруктураОстатков.Характеристика);
			
			
			Если (ДобавитьЭтуСтроку) Тогда    
				Ключ = Строка(врСтруктураСтроки.Номенклатура)
				+ "|" + Строка(врСтруктураСтроки.Ссылка)
				+ "|" + Строка(врСтруктураСтроки.Назначение);	
				Если КешМатериалов.Получить(Ключ) = Неопределено Тогда
					КешМатериалов.Вставить(Ключ, Истина);  // запомнили
					нСтр = СтрокаДерева.Добавить();
					ЗаполнитьЗначенияСвойств(нСтр, врСтруктураСтроки);
				КонецЕсли;  
			КонецЕсли;
			
			//Если это номенклатура с предшествующим этапом - вызовем рекурсивно, но вызывать надо, если этап совпадает, а то в спецификации может быть несколько номенклатур, но этапы разные

			Если (врСтрока01.Ссылка.Этап = врСтрока02.Этап) Тогда
					врТЗ													= Новый ТаблицаЗначений;
					врТЗ.Колонки.Добавить("Номенклатура");
					врТЗ.Колонки.Добавить("КоличествоУпаковок");
					нСтрИП													= врТЗ.Добавить();
					нСтрИП.Номенклатура										= врСтруктураСтроки.Номенклатура;
					// Для производимых полуфабрикатов с наличием передаем недостающее количество для расчета материалов
					Если (СтруктураОстатков.ПроизводитсяВПроцессе) И (СтруктураОстатков.КоличествоУпаковокВНаличии > 0) Тогда
						нСтрИП.КоличествоУпаковок							= Макс(0, КоличествоУпаковокНехватает);
					Иначе
						нСтрИП.КоличествоУпаковок							= врСтруктураСтроки.КоличествоУпаковокТребуется;
					КонецЕсли;
					СформироватьтаблицуМатериаловНаСервере_Рекурсивно(врСтрока01.ПолучитьЭлементы(), ?(нСтр = Неопределено, СтрокаДерева, нСтр.ПолучитьЭлементы()), врСтруктураСтроки.Номенклатура, врТЗ, Ошибка, КешМатериалов);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
КонецПроцедуры
&НаСервере
Функция   СформироватьТаблицуМатериаловНаСервере_Инициализация(Ошибка, ВернутьСтруктуруСтрокДерева = Ложь)
	Объект.ПотребностьИзделийПолуфабрикатовКонечногоЭтапа.Очистить();
	
	ВозвращаемаяСтруктура												= Новый Структура;
	//Найдем строку дерева, чтобы взять подчиненные этапы
	РедактируемыйЭтапПроизводства_СтрокаДерева							= СформироватьТаблицуМатериаловНаСервере_ПолучитьСтрокуДерева_ОсновнойЭтап(Ошибка);
	Если НЕ(Ошибка = "") Тогда Возврат Неопределено; КонецЕсли;
	ВозвращаемаяСтруктура.Вставить("СтрокаДерева_КонечныйЭтап",			РедактируемыйЭтапПроизводства_СтрокаДерева);
	//Найдем подчиненные строки дерева
	ПредшествующиеЭтапыПроизводства_СтрокиДерева						= СформироватьТаблицуМатериаловНаСервере_ПолучитьТрокуДерева_Предшествующие(РедактируемыйЭтапПроизводства_СтрокаДерева, Ошибка);
	//08.11.2023 больше не считаем ошибкой, если нет предшествующих этапов
	//Если НЕ(Ошибка = "") Тогда Возврат Неопределено; КонецЕсли;
	Ошибка																= "";
	//Для начала надо рассчитать потребность в количестве изделий этапов предшественников (оно не всегда равно указанному в "ОбработкаЭтапа_Рапределено")
	//08.11.2023 таблицу составляем, только если есть предшествующие изделия
	Если НЕ(ПредшествующиеЭтапыПроизводства_СтрокиДерева = Неопределено) Тогда
		ИзделияПолуфабрикаты											= СформироватьТаблицуМатериаловНаСервере_Получить_СписокПолуфабрикатов(ПредшествующиеЭтапыПроизводства_СтрокиДерева);
	КонецЕсли;
	СформироватьтаблицуМатериаловНаСервере_ПотребностьИзделийПолуфабрикатовКонечногоЭтапа(ИзделияПолуфабрикаты, Ошибка);
	Если НЕ(Ошибка = "") Тогда Возврат Неопределено; КонецЕсли;
	ВозвращаемаяСтруктура.Вставить("СтрокиДерева_ПредшествующиеЭтапы",	ПредшествующиеЭтапыПроизводства_СтрокиДерева);
	//Скопируем всю ветвь дерева
	ДеревоЭтапыПроизводстваПоИзделиюДляОбработки.ПолучитьЭлементы().Очистить();
	ВетвьДерева_ВсеСтроки												= СформироватьТаблицуМатериаловНаСервере_СкопироватьВетвьДерева(ДеревоЭтапыПроизводстваПоИзделию, ДеревоЭтапыПроизводстваПоИзделиюДляОбработки, РедактируемыйЭтапПроизводства_СтрокаДерева);
	ВозвращаемаяСтруктура.Вставить("ВетвьДерева",						ВетвьДерева_ВсеСтроки);
	
	Если (ВернутьСтруктуруСтрокДерева) Тогда
			Возврат ВозвращаемаяСтруктура;
		Иначе
			Возврат Истина;
	КонецЕсли;
КонецФункции
&НаСервере
Процедура СформироватьТаблицуМатериаловНаСервере_ДоступныеОстаткиМатериалов()
	ДоступныеОстаткиМатериалов.Очистить();

	врОтбор																= Новый Структура;
	врОтбор.Вставить("Ссылка",											ОбработкаЭтапа_РедактируемыйЭтапПроизводства);
	НайденныеСтроки														= Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.НайтиСтроки(врОтбор);
	//Если (НайденныеСтроки.Количество() = 0) 
	//	Тогда Возврат; 
	//КонецЕсли;           
	//закоментировал 24.10.24 чтобы выводились полуфабрикаты в заготовительном, когда они совпадают с изделием
	врСписокЭтапов														= Новый СписокЗначений;
	врСписокЭтапов.Добавить(ОбработкаЭтапа_РедактируемыйЭтапПроизводства);
	Для Каждого врСтрока Из НайденныеСтроки Цикл
		Если (врСписокЭтапов.НайтиПоЗначению(врСтрока.СсылкаПредшествующий) = Неопределено) Тогда
			врСписокЭтапов.Добавить(врСтрока.СсылкаПредшествующий);
		КонецЕсли;
	КонецЦикла;

	ВрЗапрос															= Новый Запрос("ВЫБРАТЬ
	        															               |	ЭтапПроизводстваОбеспечение.Ссылка КАК Ссылка,
	        															               |	ЭтапПроизводстваОбеспечение.Подразделение КАК Подразделение,
	        															               |	ЭтапПроизводстваОбеспечение.Склад КАК Склад,
	        															               |	ЭтапПроизводстваОбеспечение.Номенклатура КАК Номенклатура,
	        															               |	ЭтапПроизводстваОбеспечение.ВариантОбеспечения КАК ВариантОбеспечения,
	        															               |	ЭтапПроизводстваОбеспечение.Производится КАК Производится,
	        															               |	ЭтапПроизводстваОбеспечение.Назначение КАК Назначение,
	        															               |	ЭтапПроизводстваОбеспечение.НазначениеОбеспечения КАК НазначениеОбеспечения
	        															               |ИЗ
	        															               |	Документ.ЭтапПроизводства2_2.ОбеспечениеМатериаламиИРаботами КАК ЭтапПроизводстваОбеспечение
	        															               |ГДЕ
	        															               |	ЭтапПроизводстваОбеспечение.Ссылка В(&СписокЭтапов)
	        															               |	И ЭтапПроизводстваОбеспечение.Подразделение = &Подразделение");
	врЗапрос.УстановитьПараметр("СписокЭтапов",							врСписокЭтапов);
	врЗапрос.УстановитьПараметр("Подразделение",						Объект.Отбор_ПодразделениеИсполнитель);
	Результат															= врЗапрос.Выполнить();
	Если (Результат.Пустой()) Тогда Возврат; КонецЕсли;
	
	ТЗНоменклатурДляОстатков											= Результат.Выгрузить();
	ТЗСклады															= ТЗНоменклатурДляОстатков.Скопировать();
	ТЗСклады.Свернуть("Склад");
	МассивСкладов														= ТЗСклады.ВыгрузитьКолонку("Склад");
	ТЗНоменклатура														= ТЗНоменклатурДляОстатков.Скопировать();
	ТЗНоменклатура.Свернуть("Номенклатура");
	МассивНоменклатур													= ТЗНоменклатура.ВыгрузитьКолонку("Номенклатура");

	ТЗНазначения = ТЗНоменклатурДляОстатков.Скопировать();
	ТЗНазначения.Свернуть("Назначение");
	МассивНазначений = ТЗНазначения.ВыгрузитьКолонку("Назначение");

	врЗапросОстатков													= Новый Запрос("ВЫБРАТЬ
	                													               |	ТоварыНаСкладахОстатки.Склад КАК Склад,
	                													               |	ТоварыНаСкладахОстатки.Номенклатура КАК Номенклатура,
	                													               |	ТоварыНаСкладахОстатки.Назначение КАК Назначение,
	                													               |	ТоварыНаСкладахОстатки.Номенклатура.ЕдиницаИзмерения КАК Упаковка,
	                													               |	ВЫБОР
	                													               |		КОГДА ТоварыНаСкладахОстатки.ВНаличииОстаток < 0
	                													               |			ТОГДА 0
	                													               |		ИНАЧЕ ТоварыНаСкладахОстатки.ВНаличииОстаток
	                													               |	КОНЕЦ КАК КоличествоУпаковокВНаличии
	                													               |ИЗ
	                													               |	РегистрНакопления.ТоварыНаСкладах.Остатки(
	                													               |			&ДатаКон,
	                													               |			Склад В (&Склады)
	                													               |				И Номенклатура В (&Номенклатуры)
	                													               |	            И Назначение В (&Назначения)) КАК ТоварыНаСкладахОстатки");
	врЗапросОстатков.УстановитьПараметр("ДатаКон",						КонецДня(ТекущаяДатаСеанса()));
	врЗапросОстатков.УстановитьПараметр("Склады",						МассивСкладов);
	врЗапросОстатков.УстановитьПараметр("Номенклатуры",					МассивНоменклатур);  
	врЗапросОстатков.УстановитьПараметр("Назначения", 					МассивНазначений);
	Результат															= врЗапросОстатков.Выполнить();
	Если (Результат.Пустой()) Тогда Возврат; КонецЕсли;
	
	ДоступныеОстаткиМатериалов.Загрузить(Результат.Выгрузить());
КонецПроцедуры
&НаСервере
Процедура ПроверитьТаблицуМатериаловНаСервере_Рекурсивно(врСтрокиДерева, врСчетНоменклатур)
	Для Каждого врСтрокаД Из врСтрокиДерева Цикл
		//Если ((врСтрокаД.КоличествоУпаковокВНаличии - врСтрокаД.КоличествоУпаковокФактически < 0) И НЕ(врСтрокаД.ПроизводитсяВПроцессе)) Тогда 
		//закомментил 16-06-25 и теперь проверяется наличие материалов в полуфабрикатах
		Если (врСтрокаД.КоличествоУпаковокВНаличии - врСтрокаД.КоличествоУпаковокФактически < 0)  Тогда
			Если НЕ(врСтрокаД.ПроизводитсяВПроцессе) Тогда
				врСчетНоменклатур = врСчетНоменклатур + 1;  			 
			КонецЕсли;			
			Если НЕ(врСтрокаД.ПолучитьЭлементы().Количество() = 0) Тогда
				ПроверитьТаблицуМатериаловНаСервере_Рекурсивно(врСтрокаД.ПолучитьЭлементы(), врСчетНоменклатур);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
&НаСервере
Процедура ПроверитьТаблицуМатериаловНаСервере_Инициализация(врСчетНоменклатур)
	ПроверитьТаблицуМатериаловНаСервере_Рекурсивно(ДеревоИспользованныхМатериалов.ПолучитьЭлементы(), врСчетНоменклатур);
КонецПроцедуры
&НаКлиенте
Процедура ПроверитьТаблицуМатериаловНаСервере_ДоступностьПрименения()
	врСчетНоменклатур													= 0;
	ПроверитьТаблицуМатериаловНаСервере_Инициализация(врСчетНоменклатур);
	Если НЕ(врСчетНоменклатур = 0) Тогда
			//ПоказатьПредупреждение( , "Недостаточно материалов по " + СтрЗаменить(Строка(врСчетНоменклатур), Символы.НПП, "") + " позициям.
			//							|Применение в документах невозможно!", 30, "Критическая ошибка...");
			ПоказатьПредупреждение( , "Недостаточно материалов!
										|Применение в документах невозможно!", 30, "Критическая ошибка...");
	КонецЕсли;
	//Обновляем доступность с учётом всех проверок (материалы + исполнители)
	ОбновитьДоступностьКнопкиПрименить();
КонецПроцедуры
&НаСервере
Процедура СформироватьТаблицуМатериаловНаСервере(Ошибка)
	ДеревоИспользованныхМатериалов.ПолучитьЭлементы().Очистить();
	
	КешМатериалов = Новый Соответствие;
	
	СсылкиНаСтрокиДерева												= СформироватьТаблицуМатериаловНаСервере_Инициализация(Ошибка, Истина);
	Если НЕ(Ошибка = "") Тогда Возврат; КонецЕсли;
	
	//Получим доступные остатки по номенклатуре
	СформироватьТаблицуМатериаловНаСервере_ДоступныеОстаткиМатериалов();
	
	//Для каждого предшествующего этапа надо добавить материалы, с учетом, что могут быть предпредшествующие этапы, сделаем рекурсивно
	Ошибка																= "";
	СформироватьТаблицуМатериаловНаСервере_Рекурсивно(СсылкиНаСтрокиДерева.ВетвьДерева, ДеревоИспользованныхМатериалов.ПолучитьЭлементы(), , Объект.ПотребностьИзделийПолуфабрикатовКонечногоЭтапа.Выгрузить(), Ошибка, КешМатериалов);
	
	Если НЕ(Ошибка = "") Тогда Возврат; КонецЕсли;
КонецПроцедуры
&НаКлиенте
Процедура СформироватьТаблицуМатериалов_Завершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	Если НЕ(РезультатВопроса = КодВозвратаДиалога.Да) Тогда Возврат; КонецЕсли;
	
	Ошибка																	= "";
	СформироватьТаблицуМатериаловНаСервере(Ошибка);
	
	Если НЕ(Ошибка = "") Тогда
		ПоказатьПредупреждение( , Ошибка, 15, "Информация...");
		Возврат;
	КонецЕсли;
	
	Для Каждого врСтрока Из ДеревоИспользованныхМатериалов.ПолучитьЭлементы() Цикл
		ИдентификаторСтроки													= врСтрока.ПолучитьИдентификатор();
		Элементы.ДеревоИспользованныхМатериалов.Развернуть(ИдентификаторСтроки, Истина);
	КонецЦикла;
	
	ОбработкаЭтапа_БылиИзменения											= БылиИзменения();
	ЭтаФорма.ТекущийЭлемент													= Элементы.ДеревоИспользованныхМатериалов;
	
	ПроверитьТаблицуМатериаловНаСервере_ДоступностьПрименения();
КонецПроцедуры
&НаКлиенте
Процедура СформироватьТаблицуМатериалов(Команда)
	Если (ОбработкаЭтапа_Рапределено = 0) Тогда
		ПоказатьПредупреждение( , "Не указано количество к распределению!", 15, "Критическая ошибка..."); 
		ЭтаФорма.ТекущийЭлемент											= Элементы.ОбработкаЭтапа_Рапределено;
		Возврат;
	КонецЕсли;
	Если (ОбработкаЭтапа_БылиИзменения) Тогда
			ОписаниеОповещения											= Новый ОписаниеОповещения("СформироватьТаблицуМатериалов_Завершение", ЭтотОбъект);
			ПоказатьВопрос(ОписаниеОповещения, "Все внесённые изменения будут утеряны. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Иначе
			СформироватьТаблицуМатериалов_Завершение(КодВозвратаДиалога.Да, Неопределено);
	КонецЕсли;
КонецПроцедуры
&НаСервере
Процедура НачатьРаботуНаСервере()
	ДанныеВыпуска														= РаботаЭтап_ПолучитьДанныеВыпуска();
	ОбработкаЭтапа_Запланировано										= ДанныеВыпуска.Запланировано;
	ОбработкаЭтапа_Недодел												= ДанныеВыпуска.Недодел;
	ОбработкаЭтапа_РедактируемыйЭтапПроизводстваТекст					= "№ " + СокрЛП(ОбработкаЭтапа_РедактируемыйЭтапПроизводства.Номер) + " от " + Формат(ОбработкаЭтапа_РедактируемыйЭтапПроизводства.Дата, "ДЛФ=Д");
КонецПроцедуры
&НаКлиенте
Процедура НачатьРаботу(Команда)
	РаботаСЭтапомВозможна												= РаботаСЭтапомВозможна(ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства);
	Если НЕ(РаботаСЭтапомВозможна) Тогда
		ПоказатьПредупреждение( , "Не возможно редактировать выбранный этап (статус ""Завершен"")!", 15, "Критическая ошибка..."); 
		Возврат;
	КонецЕсли;
	
	//Проверим, установлены ли отборы
	Если НЕ(ЗначениеЗаполнено(Объект.Отбор_ПодразделениеИсполнитель)) Тогда
		ПоказатьПредупреждение( , "Не установлен отбор по цеху (подразделению-исполнителю)!", 15, "Критическая ошибка..."); 
		Возврат;
	КонецЕсли;
	//Отбор только по подразделению (так попросили уже после ТЗ)
	//Если НЕ(ЗначениеЗаполнено(Объект.Отбор_Спецификация)) Тогда
	//	ПоказатьПредупреждение( , "Не выбрана спецификация!", 15, "Критическая ошибка..."); 
	//	Возврат;
	//КонецЕсли;
	
	ОбработкаЭтапа_Начата												= Истина;
	ОбработкаЭтапа_РедактируемыйЭтапПроизводства						= ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства;
	Элементы.ГруппаСтраницыОсновные.ТекущаяСтраница						= Элементы.ГруппаСтраницыОсновные.ПодчиненныеЭлементы.ГруппаСтраницаРабота;
	ЭтаФорма.ТекущийЭлемент												= Элементы.ОбработкаЭтапа_Рапределено;
	УстановитьДоступностьОтборов();
	НачатьРаботуНаСервере();
КонецПроцедуры
&НаКлиенте
Процедура ОтменитьТекущуюРаботу_Завершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	Если НЕ(РезультатВопроса = КодВозвратаДиалога.Да) Тогда Возврат; КонецЕсли;
	
	Элементы.ГруппаСтраницыОсновные.ТекущаяСтраница					= Элементы.ГруппаСтраницыОсновные.ПодчиненныеЭлементы.ГруппаСтраницаЭтапы;
	ОчиститьСпискиДеревоМатериалы();
	УстановитьДоступностьОтборов();
	ОбновитьДоступностьКнопкиПрименить();
КонецПроцедуры
&НаКлиенте
Процедура ОтменитьТекущуюРаботу(Команда)
	Если (ОбработкаЭтапа_БылиИзменения) ИЛИ (ОбработкаЭтапа_БылиИзмененияТрудозатрат) Тогда
			ОписаниеОповещения										= Новый ОписаниеОповещения("ОтменитьТекущуюРаботу_Завершение", ЭтотОбъект);
			ПоказатьВопрос(ОписаниеОповещения, "Все внесённые изменения будут утеряны. Продолжить?", РежимДиалогаВопрос.ДаНет);
		Иначе
			ОтменитьТекущуюРаботу_Завершение(КодВозвратаДиалога.Да, Неопределено);
	КонецЕсли;
КонецПроцедуры
&НаКлиенте
Процедура ИзменитьНоменклатуруМатериала_Завершение(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	Если (РезультатЗакрытия = Неопределено) Тогда Возврат; КонецЕсли;
	
	ТекущиеДанные															= Элементы.ДеревоИспользованныхМатериалов.ТекущиеДанные;
	ТекущиеДанные.Номенклатура												= РезультатЗакрытия.Номенклатура;
	ТекущиеДанные.КоличествоУпаковокФактически								= РезультатЗакрытия.КоличествоУпаковокФактически;
	ТекущиеДанные.КоличествоУпаковокВНаличии								= РезультатЗакрытия.КоличествоУпаковокВНаличии; 
	ТекущиеДанные.КоличествоУпаковокНехватает = ТекущиеДанные.КоличествоУпаковокФактически - ТекущиеДанные.КоличествоУпаковокВНаличии;
	ТекущиеДанные.КоличествоУпаковокВНаличииТекст							= РезультатЗакрытия.КоличествоУпаковокВНаличииТекст;
	ТекущиеДанные.ЕстьИзменение												= НЕ(ТекущиеДанные.Номенклатура = ТекущиеДанные.НоменклатураИсходная) ИЛИ НЕ(ТекущиеДанные.КоличествоУпаковокТребуется = ТекущиеДанные.КоличествоУпаковокФактически);
	ОбработкаЭтапа_БылиИзменения											= БылиИзменения();

	ПроверитьТаблицуМатериаловНаСервере_ДоступностьПрименения();
КонецПроцедуры
&НаКлиенте
Процедура ИзменитьНоменклатуруМатериала(Команда)
	ТекущиеДанные														= Элементы.ДеревоИспользованныхМатериалов.ТекущиеДанные;
	Если (ТекущиеДанные = Неопределено) Тогда Возврат; КонецЕсли;
	Если НЕ(ТекущиеДанные.ИзменениеДоступно) Тогда
		ПоказатьПредупреждение( , "Нельзя редактировать строку (статус ""Завершен"")!", 15, "Информация...");
		Возврат;
	КонецЕсли;
	
	ПараметрыОткрытия													= ДобавитьИспользованныйМатериал_ПодготовитьПараметрыОткрытия(ТекущиеДанные.Ссылка, ТекущиеДанные.Номенклатура, ТекущиеДанные.Номенклатура, ТекущиеДанные.КоличествоУпаковокФактически, ТекущиеДанные.ИдентификаторСтроки, "ВыборНоменклатуры");
	ОповещениеОЗакрытии													= Новый ОписаниеОповещения("ИзменитьНоменклатуруМатериала_Завершение", ЭтотОбъект);
	Попытка
			ОткрытьФорму("ВнешняяОбработка.РабочееМестоЛокальныйДиспетчер.Форма.ФормаРедактированияСтроки", ПараметрыОткрытия, ЭтаФорма, , , , ОповещениеОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		Исключение
			ОткрытьФорму("Обработка.РабочееМестоЛокальныйДиспетчер.Форма.ФормаРедактированияСтроки", ПараметрыОткрытия, ЭтаФорма, , , , ОповещениеОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	КонецПопытки;
КонецПроцедуры
&НаСервере
Процедура ДобавитьИспользованныйМатериалНаСервере_Рекурсивно(КореньДерева, СтрокиДерева, РезультатЗакрытия, СтрокаДобавлена)
	Для Каждого врСтрокаД Из СтрокиДерева Цикл
		Если (СтрокаДобавлена) Тогда Прервать; КонецЕсли;
		Если (врСтрокаД.ИдентификаторСтроки = РезультатЗакрытия.ИдентификаторСтрокиПредыдущей) Тогда
			врРодитель															= ?(врСтрокаД.Родитель = Неопределено, КореньДерева, врСтрокаД.Родитель.Строки);
			нСтр																= врРодитель.Вставить(врРодитель.Индекс(врСтрокаД) + 1);
			ЗаполнитьЗначенияСвойств(нСтр, РезультатЗакрытия);
			
			нСтр.ЕстьИзменение													= Истина;
			нСтр.ИзменениеДоступно												= Истина;
			СтрокаДобавлена														= Истина;
		КонецЕсли;
		Если НЕ(врСтрокаД.Строки.Количество() = 0) Тогда
			ДобавитьИспользованныйМатериалНаСервере_Рекурсивно(КореньДерева, врСтрокаД.Строки, РезультатЗакрытия, СтрокаДобавлена);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
&НаСервере
Процедура ДобавитьИспользованныйМатериалНаСервере(РезультатЗакрытия)
	врДЗ																= РеквизитФормыВЗначение("ДеревоИспользованныхМатериалов");
	
	СтрокаДобавлена														= Ложь;
	ДобавитьИспользованныйМатериалНаСервере_Рекурсивно(врДЗ.Строки, врДЗ.Строки, РезультатЗакрытия, СтрокаДобавлена);
	
	ЗначениеВРеквизитФормы(врДЗ, "ДеревоИспользованныхМатериалов");
КонецПроцедуры
&НаКлиенте
Процедура ДобавитьИспользованныйМатериал_Завершение(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	Если (РезультатЗакрытия = Неопределено) Тогда Возврат; КонецЕсли;
	
	ДобавитьИспользованныйМатериалНаСервере(РезультатЗакрытия);
	
	ОбработкаЭтапа_БылиИзменения										= БылиИзменения();
	Для Каждого врСтрока Из ДеревоИспользованныхМатериалов.ПолучитьЭлементы() Цикл
		идСтроки														= врСтрока.ПолучитьИдентификатор();
		Элементы.ДеревоИспользованныхМатериалов.Развернуть(идСтроки, Истина);
	КонецЦикла;
	
	СтрокаДерева														= Неопределено;
	СтрокаНайдена														= Ложь;
	НайтиСтрокуДереваРекурсивно(ДеревоИспользованныхМатериалов.ПолучитьЭлементы(), РезультатЗакрытия.ИдентификаторСтроки, СтрокаДерева, СтрокаНайдена);
	Если (СтрокаНайдена) Тогда
		Элементы.ДеревоИспользованныхМатериалов.ТекущаяСтрока			= СтрокаДерева.ПолучитьИдентификатор();
	КонецЕсли;
	
	ПроверитьТаблицуМатериаловНаСервере_ДоступностьПрименения();
КонецПроцедуры
&НаСервере
Функция   ДобавитьИспользованныйМатериал_ПодготовитьПараметрыОткрытия(Ссылка, Номенклатура, НоменклатураТекущая, КоличествоУпаковокФактически, ИдентификаторСтроки, РежимДиалога)
	ПараметрыОткрытия													= Новый Структура;
	ПараметрыОткрытия.Вставить("Ссылка",								Ссылка);
	ПараметрыОткрытия.Вставить("Номенклатура",							Номенклатура);
	ПараметрыОткрытия.Вставить("КоличествоУпаковокФактически",			КоличествоУпаковокФактически);
	ПараметрыОткрытия.Вставить("РабочаяДата",							Объект.РабочаяДата);
	ПараметрыОткрытия.Вставить("ДоступныеОстаткиМатериалов",			ЗначениеВСтрокуВнутр(ДоступныеОстаткиМатериалов.Выгрузить()));
	ПараметрыОткрытия.Вставить("Склад",									СкладПоПодразделению(Ссылка.Подразделение, НоменклатураТекущая));
	ПараметрыОткрытия.Вставить("РежимДиалога",							РежимДиалога);
	ПараметрыОткрытия.Вставить("ИдентификаторСтроки",					ИдентификаторСтроки);
	
	Возврат ПараметрыОткрытия;
КонецФункции
&НаКлиенте
Процедура ДобавитьИспользованныйМатериал(Команда)
	ТекущиеДанные														= Элементы.ДеревоИспользованныхМатериалов.ТекущиеДанные;
	Если (ТекущиеДанные = Неопределено) Тогда Возврат; КонецЕсли;
	Если НЕ(ТекущиеДанные.ИзменениеДоступно) Тогда
		ПоказатьПредупреждение( , "Нельзя редактировать строку (статус ""Завершен"")!", 15, "Информация...");
		Возврат;
	КонецЕсли;
	
	ПараметрыОткрытия													= ДобавитьИспользованныйМатериал_ПодготовитьПараметрыОткрытия(ТекущиеДанные.Ссылка, ПредопределенноеЗначение("Справочник.Номенклатура.ПустаяСсылка"), ТекущиеДанные.Номенклатура, 0, ТекущиеДанные.ИдентификаторСтроки, "ВводНовойСтроки");
	ОповещениеОЗакрытии													= Новый ОписаниеОповещения("ДобавитьИспользованныйМатериал_Завершение", ЭтотОбъект);
	Попытка
			ОткрытьФорму("Обработка.РабочееМестоЛокальныйДиспетчер.Форма.ФормаРедактированияСтроки", ПараметрыОткрытия, ЭтаФорма, , , , ОповещениеОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		Исключение
			ОткрытьФорму("ВнешняяОбработка.РабочееМестоЛокальныйДиспетчер.Форма.ФормаРедактированияСтроки", ПараметрыОткрытия, ЭтаФорма, , , , ОповещениеОЗакрытии, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	КонецПопытки;
КонецПроцедуры
&НаСервере
Процедура ПрименитьВДокументахНаСервере_ОбновитьДокумент_ПроверитьСтатус(врОбъект)
	Если НЕ(врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Начат) Тогда
		врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Начат;
		врОбъект.ФактическоеНачалоЭтапа = ТекущаяДатаСеанса();
	КонецЕсли;
КонецПроцедуры
&НаСервере
Процедура ПрименитьВДокументахНаСервере_ОбновитьДокумент_РасходМатериаловИРабот(врОбъект, МассивМатериалов)
	врТЧ																= врОбъект.РасходМатериаловИРабот; 
	СтатьяКалькуляцииПоУмолчанию = Справочники.СтатьиКалькуляции.НайтиПоРеквизиту("ИдентификаторДляФормул","ПокупныеМатериалы");
	Для Каждого врЭлемент Из МассивМатериалов Цикл
		нСтр															= врТЧ.Добавить();
		ЗаполнитьЗначенияСвойств(нСтр, врЭлемент); 
		
		//нСтр.Номенклатура = врЭлемент.Номенклатура;
		//нСтр.КоличествоУпаковок = врЭлемент.КоличествоУпаковок;
		//нСтр.Упаковка = врЭлемент.Упаковка; 
		//нСтр.Количество = врЭлемент.Количество;
		//нСтр.ДатаРасхода = врЭлемент.ДатаРасхода; 	

		Если нСтр.СтатьяКалькуляции = Неопределено Тогда
			нСтр.СтатьяКалькуляции = СтатьяКалькуляцииПоУмолчанию;
		КонецЕсли;
	КонецЦикла;
	
	//fix: 16.02.2026 — Переработана логика свёртки строк материалов.
	//  Раньше: Выгрузить() → Свернуть() → Загрузить() — перезаписывалась ВСЯ ТЧ,
	//  что интерпретировалось как изменение строк с прошлыми датами и вызывало ошибку
	//  "запрещено изменять данные с датой ранее..." даже при работе с текущей датой.
	//  Теперь: сворачиваем только строки с ТЕКУЩЕЙ рабочей датой (аналогично СжатьТабличнуюЧастьСегодня
	//  из старого АРМ). Строки с прошлыми датами НЕ модифицируются.
	СжатьТабличнуюЧастьПоДате(врТЧ, "ДатаРасхода", НачалоДня(Объект.РабочаяДата),
		"Номенклатура,Характеристика,Упаковка,СтатьяКалькуляции,ДатаРасхода,Серия,Подразделение");
КонецПроцедуры

// Сворачивает дублирующиеся строки табличной части ТОЛЬКО для указанной даты.
// Строки с другими датами остаются нетронутыми (не вызывают проверку запрета изменения по датам).
// Аналог СжатьТабличнуюЧастьСегодня из старого АРМ_ЛокальныйДиспетчер.
&НаСервере
Процедура СжатьТабличнуюЧастьПоДате(ТабличнаяЧасть, КолонкаДаты, Дата, РеквизитыГруппировки)
	// Находим все строки с указанной датой
	СтрокиУказаннойДаты = ТабличнаяЧасть.НайтиСтроки(Новый Структура(КолонкаДаты, Дата));
	Если СтрокиУказаннойДаты.Количество() <= 1 Тогда
		Возврат; // Нечего сворачивать
	КонецЕсли;
	
	// Собираем строки для удаления (не индексы, а сами строки)
	СтрокиДляУдаления = Новый Массив;
	ОбработанныеКлючи = Новый Соответствие;
	Отбор = Новый Структура(РеквизитыГруппировки);
	
	Для Каждого Строка Из СтрокиУказаннойДаты Цикл
		ЗаполнитьЗначенияСвойств(Отбор, Строка);
		
		// Формируем строковый ключ для отслеживания обработанных комбинаций
		КлючСтрока = "";
		Для Каждого КЗ Из Отбор Цикл
			КлючСтрока = КлючСтрока + "|" + СокрЛП(КЗ.Значение);
		КонецЦикла;
		
		ПерваяСтрокаСКлючом = ОбработанныеКлючи.Получить(КлючСтрока);
		Если ПерваяСтрокаСКлючом = Неопределено Тогда
			// Первая строка с таким ключом — запоминаем
			ОбработанныеКлючи.Вставить(КлючСтрока, Строка);
		Иначе
			// Дубликат — суммируем количество в первую строку и помечаем на удаление
			ПерваяСтрокаСКлючом.КоличествоУпаковок = ПерваяСтрокаСКлючом.КоличествоУпаковок + Строка.КоличествоУпаковок;
			ПерваяСтрокаСКлючом.Количество = ПерваяСтрокаСКлючом.Количество + Строка.Количество;
			СтрокиДляУдаления.Добавить(Строка);
		КонецЕсли;
	КонецЦикла;
	
	// Удаляем дубликаты (по ссылке на строку, а не по индексу)
	Для Каждого СтрокаДляУдаления Из СтрокиДляУдаления Цикл
		ТабличнаяЧасть.Удалить(СтрокаДляУдаления);
	КонецЦикла;
КонецПроцедуры
&НаСервере
Процедура ПрименитьВДокументахНаСервере_ОбновитьДокумент_ОбеспечениеМатериаламиИРаботами(врОбъект, МассивМатериалов)
	Если врОбъект.НеОтгружатьЧастями Тогда
		врОбъект.НеОтгружатьЧастями = Ложь;
	КонецЕсли;
	врТЧ																= врОбъект.ОбеспечениеМатериаламиИРаботами;
	Для Каждого врЭлемент Из МассивМатериалов Цикл
		//Сначала скорректируем количество к обеспечению
		врПараметрыОтбора												= Новый Структура;
		врПараметрыОтбора.Вставить("ВариантОбеспечения",				Перечисления.ВариантыОбеспечения.КОбеспечению);
		врПараметрыОтбора.Вставить("Номенклатура",						врЭлемент.Номенклатура);
		//fix: 06.02.2026 — Добавлен фильтр по назначению, чтобы не модифицировать строки
		//  с другим назначением (при наличии нескольких строк одной номенклатуры с разными назначениями
		//  код мог изменить не ту строку, что приводило к некорректным данным и ошибке проведения).
		Если ЗначениеЗаполнено(врЭлемент.Назначение) Тогда
			врПараметрыОтбора.Вставить("Назначение",					врЭлемент.Назначение);
		КонецЕсли;
		//fix: 10.02.2026 — Добавлен фильтр по характеристике для корректной корректировки строк
		//  при наличии нескольких строк одной номенклатуры с разными характеристиками.
		Если ЗначениеЗаполнено(врЭлемент.Характеристика) Тогда
			врПараметрыОтбора.Вставить("Характеристика",				врЭлемент.Характеристика);
		КонецЕсли;
		МассивСтрокКОбеспечению											= врТЧ.НайтиСтроки(врПараметрыОтбора);
		ДобавитьСтроку													= Ложь;
		Если НЕ(МассивСтрокКОбеспечению.Количество() = 0) Тогда
			врКоличествоУпаковокНовыйРасход								= врЭлемент.КоличествоУпаковок;
			врКоличествоНовыйРасход										= врЭлемент.Количество;
			Для Каждого врСтрокаКО Из МассивСтрокКОбеспечению Цикл
				Если (врСтрокаКО.КоличествоУпаковок > врКоличествоУпаковокНовыйРасход) Тогда
						врСтрокаКО.КоличествоУпаковок					= врСтрокаКО.КоличествоУпаковок		- врКоличествоУпаковокНовыйРасход;
						врСтрокаКО.Количество							= врСтрокаКО.Количество				- врКоличествоНовыйРасход; 
						врСтрокаКО.ДатаОтгрузки							= Объект.РабочаяДата;  
						ДобавитьСтроку									= Истина;
						Прервать;
					ИначеЕсли (врСтрокаКО.КоличествоУпаковок < врКоличествоУпаковокНовыйРасход) Тогда
						врКоличествоУпаковокНовыйРасход					= врКоличествоУпаковокНовыйРасход	- врСтрокаКО.КоличествоУпаковок;
						врКоличествоНовыйРасход							= врКоличествоНовыйРасход			- врСтрокаКО.Количество;
						врЭлемент.КоличествоУпаковок					= врКоличествоУпаковокНовыйРасход;
						врЭлемент.Количество							= врКоличествоНовыйРасход;
						врСтрокаКО.ВариантОбеспечения					= Перечисления.ВариантыОбеспечения.Отгрузить;
						врСтрокаКО.ДатаОтгрузки							= Объект.РабочаяДата;  
						ДобавитьСтроку									= Истина;
					Иначе
						врКоличествоУпаковокНовыйРасход					= 0;
						врКоличествоНовыйРасход							= 0;
						врЭлемент.КоличествоУпаковок					= врКоличествоУпаковокНовыйРасход;
						врЭлемент.Количество							= врКоличествоНовыйРасход;
						врСтрокаКО.ВариантОбеспечения					= Перечисления.ВариантыОбеспечения.Отгрузить;
						врСтрокаКО.ДатаОтгрузки							= Объект.РабочаяДата;
						ДобавитьСтроку									= Ложь;
						Прервать;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		Если (ДобавитьСтроку) Тогда
			нСтр														= врТЧ.Добавить();
			ЗаполнитьЗначенияСвойств(нСтр, врЭлемент);
		КонецЕсли;
	КонецЦикла;

	врОбъект.МаксимальныйКодСтрокиОбеспечение							= врОбъект.МаксимальныйКодСтрокиОбеспечение + МассивМатериалов.Количество();
КонецПроцедуры
&НаСервере
Процедура ПрименитьВДокументахНаСервере_ОбновитьДокумент_ВыходныеИзделия(врОбъект, ДанныеВыходногоИзделияМассив)
	//врТЧПобочныеИзделия											= врОбъект.ПобочныеИзделия;
	//врТЧ														= врОбъект.ВыходныеИзделия;
	СчетчикДобавленныхСтрок = 0;
	Для Каждого ДанныеВыходногоИзделия Из ДанныеВыходногоИзделияМассив Цикл
		ДанныеВыходногоИзделия.Вставить("ХарактеристикаТЧ",				Неопределено);
		//Сначала найдем стркоу плана и отнимем от неё факт производства
		врКоличествоПроизведено											= ДанныеВыходногоИзделия.КоличествоУпаковок;
		врПараметрыОтбора												= Новый Структура;
		Если (СокрЛП(ДанныеВыходногоИзделия.Назначение) = "") Тогда
			врПараметрыОтбора.Вставить("Произведено",				Ложь);
			врПараметрыОтбора.Вставить("Номенклатура",				ДанныеВыходногоИзделия.Номенклатура);
		Иначе
			врПараметрыОтбора.Вставить("Произведено",				Ложь);
			врПараметрыОтбора.Вставить("Номенклатура",				ДанныеВыходногоИзделия.Номенклатура);
			врПараметрыОтбора.Вставить("Назначение",				ДанныеВыходногоИзделия.Назначение);
		КонецЕсли;
		МассивСтрокПланПроизводства = врОбъект.ВыходныеИзделия.НайтиСтроки(врПараметрыОтбора); 
		ДобавитьСтроку = Ложь;    
		Если (МассивСтрокПланПроизводства.Количество() = 0) Тогда 
			МассивСтрокПланПроизводства = врОбъект.ПобочныеИзделия.НайтиСтроки(врПараметрыОтбора);
			Если (МассивСтрокПланПроизводства.Количество() = 0) Тогда Продолжить; КонецЕсли;
			врТЧ = врОбъект.ПобочныеИзделия;
		Иначе
			врТЧ = врОбъект.ВыходныеИзделия;  
		КонецЕсли; 
		
		ДобавитьСтроку = Истина;     
		
		Для Каждого врСтрокаПП Из МассивСтрокПланПроизводства Цикл
			Если НЕ(ЗначениеЗаполнено(врСтрокаПП.ДатаПроизводства)) Тогда
				врСтрокаПП.ДатаПроизводства							= Объект.РабочаяДата;//ДанныеВыходногоИзделия.ДатаПроизводстваПлан;
				Если НЕ(ЗначениеЗаполнено(врСтрокаПП.ДатаПроизводства)) Тогда
					врСтрокаПП.ДатаПроизводства						= Объект.РабочаяДата;//ТекущаяДатаСеанса();
				КонецЕсли;
			КонецЕсли;
			Если (врСтрокаПП.КоличествоУпаковок > врКоличествоПроизведено) Тогда
				врСтрокаПП.КоличествоУпаковок					= врСтрокаПП.КоличествоУпаковок	- врКоличествоПроизведено;
				врСтрокаПП.Количество							= врСтрокаПП.Количество			- врКоличествоПроизведено;
				ДанныеВыходногоИзделия.Вставить("ХарактеристикаТЧ",врСтрокаПП.Характеристика);
				//Прервать;        
			//Закомментировал этот блок, чтобы не оформлять больше, чем запланировано.
			//ИначеЕсли (врСтрокаПП.КоличествоУпаковок < врКоличествоПроизведено) Тогда
			//	врКоличествоПроизведено							= врКоличествоПроизведено		- врСтрокаПП.КоличествоУпаковок;
			//	ДанныеВыходногоИзделия.КоличествоУпаковок		= врКоличествоПроизведено;
			//	ДанныеВыходногоИзделия.Количество				= врКоличествоПроизведено;
			//	врСтрокаПП.Произведено							= Истина;
			//	врСтрокаПП.ДатаПроизводства						= ДанныеВыходногоИзделия.ДатаПроизводства;
			//	ДанныеВыходногоИзделия.Вставить("ХарактеристикаТЧ",врСтрокаПП.Характеристика);
			Иначе
				врКоличествоПроизведено							= 0;
				ДанныеВыходногоИзделия.КоличествоУпаковок		= врКоличествоПроизведено;
				ДанныеВыходногоИзделия.Количество				= врКоличествоПроизведено;
				врСтрокаПП.Произведено							= Истина;
				врСтрокаПП.ДатаПроизводства						= ДанныеВыходногоИзделия.ДатаПроизводства;
				ДобавитьСтроку									= Ложь;
				//Прервать;
			КонецЕсли;
		КонецЦикла;  
		Если (ДобавитьСтроку) Тогда 
			СчетчикДобавленныхСтрок = СчетчикДобавленныхСтрок + 1;
			нСтр = врТЧ.Добавить();
			ЗаполнитьЗначенияСвойств(нСтр, ДанныеВыходногоИзделия);
			нСтр.Характеристика = ?(ДанныеВыходногоИзделия.Характеристика = Неопределено, ДанныеВыходногоИзделия.ХарактеристикаТЧ, ДанныеВыходногоИзделия.Характеристика);
		КонецЕсли;			
		//врОбъект.МаксимальныйКодСтрокиИзделия							= врОбъект.МаксимальныйКодСтрокиИзделия + 1;
		//врОбъект.КоличествоУпаковокФакт									= 0;
		//Для Каждого врСтрока Из врОбъект.ВыходныеИзделия Цикл
		//	Если НЕ(врСтрока.Произведено) Тогда Продолжить; КонецЕсли;
		//	врОбъект.КоличествоУпаковокФакт = врОбъект.КоличествоУпаковокФакт + врСтрока.КоличествоУпаковок;
		//КонецЦикла;  		
	КонецЦикла;    
	врОбъект.МаксимальныйКодСтрокиИзделия							= врОбъект.МаксимальныйКодСтрокиИзделия + 1;
	врОбъект.КоличествоУпаковокФакт									= 0;
	Для Каждого врСтрока Из врОбъект.ВыходныеИзделия Цикл
		Если НЕ(врСтрока.Произведено) Тогда Продолжить; КонецЕсли;
		врОбъект.КоличествоУпаковокФакт = врОбъект.КоличествоУпаковокФакт + врСтрока.КоличествоУпаковок;
	КонецЦикла; 
	//fix: 13.02.2026 — Расчёт КоличествоУпаковокФакт по ПобочныеИзделия для этапов разборки.
	//  Убрано условие СчетчикДобавленныхСтрок > 0 — оно блокировало расчёт для этапов без ВыходныеИзделия.
	//  Теперь если по ВыходныеИзделия факт = 0, проверяем ПобочныеИзделия.
	Если (врОбъект.КоличествоУпаковокФакт = 0) Тогда
		ОбщееКоличествоПобочных = 0;
		ПроизведеноПобочных = 0;
		Для Каждого врСтрока Из врОбъект.ПобочныеИзделия Цикл 
			ОбщееКоличествоПобочных = ОбщееКоличествоПобочных + врСтрока.КоличествоУпаковок;
			Если НЕ(врСтрока.Произведено) Тогда Продолжить; КонецЕсли;
			ПроизведеноПобочных = ПроизведеноПобочных + врСтрока.КоличествоУпаковок; 
		КонецЦикла;
		Если (ОбщееКоличествоПобочных > 0) И (ПроизведеноПобочных > 0) Тогда
			врОбъект.КоличествоУпаковокФакт = Цел(врОбъект.КоличествоУпаковокПлан * ПроизведеноПобочных / ОбщееКоличествоПобочных);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры
&НаСервере
Процедура ПрименитьВДокументахНаСервере_ОбновитьДокумент_Трудозатраты(врОбъект, ДанныеВыходногоИзделияМассив)
	//Новая логика: берем трудозатраты из таблицы формы ТаблицаТрудозатрат
	врТЧ																= врОбъект.Трудозатраты;
	врЭтапПроизводства													= врОбъект.Ссылка;
	
	//Отбираем строки из таблицы формы по текущему этапу
	СчетДобавленныхСтрок												= 0;
	Для Каждого врСтрока Из ТаблицаТрудозатрат Цикл
		Если НЕ(врСтрока.ЭтапПроизводства = врЭтапПроизводства) Тогда Продолжить; КонецЕсли;
		
		нСтр															= врТЧ.Добавить();
		нСтр.ВидРабот													= врСтрока.ВидРабот;
		нСтр.Количество													= врСтрока.КоличествоФактически;
		нСтр.СтатьяКалькуляции											= врСтрока.СтатьяКалькуляции;
		нСтр.НазначениеРабот											= врСтрока.НазначениеРабот;
		нСтр.Исполнитель												= врСтрока.Исполнитель;
		нСтр.ДатаВыполнения												= Объект.РабочаяДата;
		нСтр.Подразделение												= врСтрока.Подразделение;
		нСтр.Выполнено													= Истина;
		
		СчетДобавленныхСтрок											= СчетДобавленныхСтрок + 1;
	КонецЦикла;
	
	//Сворачиваем одинаковые строки
	врТЗ																= врТЧ.Выгрузить();
	врТЗ.Свернуть("ВидРабот,СтатьяКалькуляции,НазначениеРабот,Исполнитель,ДатаВыполнения,Подразделение,Выполнено", "Количество");
	врТЧ.Загрузить(врТЗ);
	врОбъект.МаксимальныйКодСтрокиТрудозатраты							= врОбъект.МаксимальныйКодСтрокиТрудозатраты + СчетДобавленныхСтрок;
КонецПроцедуры
&НаСервере
Процедура ПрименитьВДокументахНаСервере_ОбновитьДокумент(ДокументЭтапаПроизводства, ТЗМатериалы, ТЗВыпуска, РезультатОбработки, ЗаписанныеДокументы)
	УстановитьПривилегированныйРежим(Истина);
	
	//Защита от повторной записи в одной транзакции
	Если ЗаписанныеДокументы.Получить(ДокументЭтапаПроизводства) <> Неопределено Тогда
		РезультатОбработки = "пропущен (уже записан в этой транзакции)";
		Возврат;
	КонецЕсли;
	
	Заполнять_ОбеспечениеМатериаламиИРаботами							= Истина;
	Заполнять_РасходМатериаловИРабот									= Истина;
	Заполнять_ВыходныеИзделия											= Истина;
	Заполнять_Трудозатраты												= (ТаблицаТрудозатрат.Количество() > 0);

	//Управляемая блокировка: предотвращает ОшибкаХранимыхДанных при параллельном изменении документа
	БлокировкаДанных = Новый БлокировкаДанных;
	ЭлементБлокировки = БлокировкаДанных.Добавить("Документ.ЭтапПроизводства2_2");
	ЭлементБлокировки.УстановитьЗначение("Ссылка", ДокументЭтапаПроизводства);
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	БлокировкаДанных.Заблокировать();

	врОбъект															= ДокументЭтапаПроизводства.ПолучитьОбъект();
	//Обновим статус (без отдельного проведения — все изменения проводятся один раз в конце)
	ПрименитьВДокументахНаСервере_ОбновитьДокумент_ПроверитьСтатус(врОбъект);
	врСпецификация = врОбъект.Спецификация;
	МассивМатериалов													= ПолучитьДанныеНоменклатурыДляЗаполнения(ДокументЭтапаПроизводства, ТЗМатериалы);
	
	Попытка
		Если (ТЗМатериалы[0].ОсновноеИзделие <> Неопределено) Тогда
			СтруктураПромежуточногоИзделия					= Новый Структура;
			СтруктураПромежуточногоИзделия.Вставить("ОсновноеИзделие",						ТЗМатериалы[0].ОсновноеИзделие);
			СтруктураПромежуточногоИзделия.Вставить("ОсновноеИзделиеКоличествоУпаковок",	ТЗМатериалы[0].ОсновноеИзделиеКоличествоУпаковок);
		КонецЕсли;
	Исключение
		СтруктураПромежуточногоИзделия						= Неопределено;
	КонецПопытки;
	//fix: 07.02.2026 — Когда ТЗМатериалы пуста (этап без материалов к списанию, напр. .4 при повторном прогоне),
	//  СтруктураПромежуточногоИзделия остаётся Неопределено, и количество выпуска берётся из ОбработкаЭтапа_Рапределено
	//  (количество конечного изделия), а не из реальной потребности полуфабриката.
	//  В этом случае ТЗВыпуска содержит корректные данные из дерева: Номенклатура и КоличествоУпаковок полуфабриката.
	//  Используем ТЗВыпуска для формирования СтруктураПромежуточногоИзделия и ТЗВыпускаСтурктура.
	//  ВАЖНО: ТЗВыпускаСтурктура передаётся как 4-й параметр ТОЛЬКО в этом случае, чтобы не затронуть
	//  нормальный сценарий (когда ТЗМатериалы непуста и Назначение определяется через ВыходныеИзделия документа).
	ТЗМатериалыБылаПуста = (СтруктураПромежуточногоИзделия = Неопределено);
	Если (ТЗМатериалыБылаПуста) И (ТЗВыпуска.Количество() > 0) Тогда
		СтруктураПромежуточногоИзделия							= Новый Структура;
		СтруктураПромежуточногоИзделия.Вставить("ОсновноеИзделие",						ТЗВыпуска[0].Номенклатура);
		СтруктураПромежуточногоИзделия.Вставить("ОсновноеИзделиеКоличествоУпаковок",	ТЗВыпуска[0].КоличествоУпаковок);
	КонецЕсли;
	ДанныеВыходногоИзделияМассив								= Новый Массив;
	ТЗВыпускаСтурктура											= Новый Структура;
	//fix: 07.02.2026 — Передаём ТЗВыпуска[0] как ТЗВыпускаСтурктура (4-й параметр) ТОЛЬКО когда ТЗМатериалы была пуста,
	//  чтобы Назначение корректно определялось из дерева для этапов без материалов.
	Если (ТЗМатериалыБылаПуста) И (ТЗВыпуска.Количество() > 0) Тогда
		ТЗВыпускаСтурктура.Вставить("Назначение",				ТЗВыпуска[0].Назначение);
		ТЗВыпускаСтурктура.Вставить("КоличествоУпаковок",		ТЗВыпуска[0].КоличествоУпаковок);
		ТЗВыпускаСтурктура.Вставить("Номенклатура",			ТЗВыпуска[0].Номенклатура);
		ТЗВыпускаСтурктура.Вставить("Подразделение",			ТЗВыпуска[0].Подразделение);
		ТЗВыпускаСтурктура.Вставить("ЭтапПроизводства",		ТЗВыпуска[0].ЭтапПроизводства);
		ДанныеВыходногоИзделия									= ПолучитьДанныеВыходногоИзделия(ДокументЭтапаПроизводства, ОбработкаЭтапа_Рапределено, СтруктураПромежуточногоИзделия, ТЗВыпускаСтурктура);
	Иначе
		ДанныеВыходногоИзделия									= ПолучитьДанныеВыходногоИзделия(ДокументЭтапаПроизводства, ОбработкаЭтапа_Рапределено, СтруктураПромежуточногоИзделия);
	КонецЕсли;
	ДанныеВыходногоИзделияМассив.Добавить(ДанныеВыходногоИзделия);
	
	КоличествоУпаковокПлан = врОбъект.КоличествоУпаковокПлан;
	ОсновноеИзделиеКоличествоУпаковок = врСпецификация.ОсновноеИзделиеКоличествоУпаковок;
	//КоличествоРаспределеноКоэфф = КоличествоУпаковокПлан / ОбработкаЭтапа_Рапределено;
	//	Для Каждого врСтрока Из врОбъект.ПобочныеИзделия Цикл     
	Для Каждого врСтрока Из врСпецификация.ВозвратныеОтходы Цикл   //дописал 17-07-25 теперь верно счиатет выпуск побочки
		Если врСтрока.Этап = врОбъект.Этап Тогда
			СтруктураПромежуточногоИзделия					= Новый Структура;
			СтруктураПромежуточногоИзделия.Вставить("ОсновноеИзделие",						врСтрока.Номенклатура);
			//СтруктураПромежуточногоИзделия.Вставить("ОсновноеИзделиеКоличествоУпаковок",	врСтрока.КоличествоУпаковок);  
			КоличествоРаспределеноКоэфф = врСтрока.КоличествоУпаковок / ОсновноеИзделиеКоличествоУпаковок;
			КоличествоПолуфабрикатаРаспределено = ОбработкаЭтапа_Рапределено * КоличествоРаспределеноКоэфф;
			СтруктураПромежуточногоИзделия.Вставить("ОсновноеИзделиеКоличествоУпаковок",	КоличествоПолуфабрикатаРаспределено);
			ДанныеВыходногоИзделия = ПолучитьДанныеВыходногоИзделия(ДокументЭтапаПроизводства, КоличествоПолуфабрикатаРаспределено, СтруктураПромежуточногоИзделия);
			//ДанныеВыходногоИзделияМассив.Добавить(ДанныеВыходногоИзделия);
			Есть = Ложь;
			Для Каждого Существующий Из ДанныеВыходногоИзделияМассив Цикл
				Если (Существующий.Номенклатура = ДанныеВыходногоИзделия.Номенклатура) И (Существующий.Назначение = ДанныеВыходногоИзделия.Назначение) Тогда
					Есть = Истина;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			Если Не Есть Тогда
				ДанныеВыходногоИзделияМассив.Добавить(ДанныеВыходногоИзделия);
			КонецЕсли;	
		КонецЕсли;		
	КонецЦикла;
	
	//debug: 07.02.2026 — Логирование МассивМатериалов (входные данные для РасходМатериаловИРабот)
	Если МассивМатериалов.Количество() > 0 Тогда
		ДиагМат = "=== МассивМатериалов для " + СокрЛП(ДокументЭтапаПроизводства.Номер) + " (" + МассивМатериалов.Количество() + " строк) ===" + Символы.ПС;
		Для Каждого дЭлемент Из МассивМатериалов Цикл
			ДиагМат = ДиагМат + "  " + дЭлемент.Номенклатура + " | Кол=" + дЭлемент.КоличествоУпаковок
				+ " | Назначение=" + дЭлемент.Назначение + " | НазначениеОбеспечения=" + дЭлемент.НазначениеОбеспечения
				+ " | Обособленно=" + дЭлемент.Обособленно + " | Производится=" + дЭлемент.Производится + Символы.ПС;
		КонецЦикла;
		ЗаписьЖурналаРегистрации("РабочееМестоЛокальныйДиспетчер.МассивМатериалов",
			УровеньЖурналаРегистрации.Ошибка, , ДокументЭтапаПроизводства, ДиагМат,
			РежимТранзакцииЗаписиЖурналаРегистрации.Независимая);
	КонецЕсли;
	
	//Добавим в ТЧ "РасходМатериаловИРабот" первым шагом, потому что потом мы таблицу "МассивМатериалов" изменяем
	Если (Заполнять_РасходМатериаловИРабот И МассивМатериалов.Количество() > 0) Тогда
		ПрименитьВДокументахНаСервере_ОбновитьДокумент_РасходМатериаловИРабот(врОбъект, МассивМатериалов);
	КонецЕсли;  	
	//Добавим в ТЧ "ОбеспечениеМатериаламиИРаботами": заказчик попросил уменьшать количество "К обеспечению" и если оно <= "0", тогда не уменьшать, а помечать "Отгрузить"
	Если (Заполнять_ОбеспечениеМатериаламиИРаботами И МассивМатериалов.Количество() > 0) Тогда
		ПрименитьВДокументахНаСервере_ОбновитьДокумент_ОбеспечениеМатериаламиИРаботами(врОбъект, МассивМатериалов);
	КонецЕсли; 	
	//Добавим в ТЧ "ВыходныеИзделия"
	//debug: 07.02.2026 — Логирование ДанныеВыходногоИзделияМассив, ТЗВыпуска и ТЗМатериалы ПЕРЕД обновлением ВыходныхИзделий
	ДиагВИ = "=== ДанныеВыходногоИзделияМассив для " + СокрЛП(ДокументЭтапаПроизводства.Номер) + " (" + ДанныеВыходногоИзделияМассив.Количество() + " элементов) ===" + Символы.ПС;
	Для Каждого дЭлемент Из ДанныеВыходногоИзделияМассив Цикл
		ДиагВИ = ДиагВИ + "  Номенклатура=" + Строка(дЭлемент.Номенклатура) + " | Кол=" + Строка(дЭлемент.КоличествоУпаковок)
			+ " | Произведено=" + Строка(дЭлемент.Произведено) + " | Назначение=" + Строка(дЭлемент.Назначение) + Символы.ПС;
	КонецЦикла;
	ДиагВИ = ДиагВИ + "--- ТЗВыпуска (" + ТЗВыпуска.Количество() + " строк) ---" + Символы.ПС;
	Для Каждого дСтр Из ТЗВыпуска Цикл
		ДиагВИ = ДиагВИ + "  " + Строка(дСтр.Номенклатура) + " | Кол=" + Строка(дСтр.КоличествоУпаковок)
			+ " | Назначение=" + Строка(дСтр.Назначение) + " | Этап=" + Строка(дСтр.ЭтапПроизводства) + Символы.ПС;
	КонецЦикла;
	ДиагВИ = ДиагВИ + "--- ТЗМатериалы (" + ТЗМатериалы.Количество() + " строк) ---" + Символы.ПС;
	Для Каждого дСтр Из ТЗМатериалы Цикл
		ДиагВИ = ДиагВИ + "  " + Строка(дСтр.Номенклатура) + " | Кол=" + Строка(дСтр.КоличествоУпаковок)
			+ " | ОсновноеИзделие=" + Строка(дСтр.ОсновноеИзделие) + " | ОсновноеИзделиеКол=" + Строка(дСтр.ОсновноеИзделиеКоличествоУпаковок) + Символы.ПС;
	КонецЦикла;
	Если (СтруктураПромежуточногоИзделия = Неопределено) Тогда
		ДиагВИ = ДиагВИ + "СтруктураПромежуточногоИзделия=Неопределено" + Символы.ПС;
	Иначе
		ДиагВИ = ДиагВИ + "СтруктураПромежуточногоИзделия=" + Строка(СтруктураПромежуточногоИзделия.ОсновноеИзделие)
			+ " | Кол=" + Строка(СтруктураПромежуточногоИзделия.ОсновноеИзделиеКоличествоУпаковок) + Символы.ПС;
	КонецЕсли;
	ЗаписьЖурналаРегистрации("РабочееМестоЛокальныйДиспетчер.ДанныеВыходногоИзделия",
		УровеньЖурналаРегистрации.Ошибка, , ДокументЭтапаПроизводства, ДиагВИ,
		РежимТранзакцииЗаписиЖурналаРегистрации.Независимая);
	Если (Заполнять_ВыходныеИзделия) Тогда
		ПрименитьВДокументахНаСервере_ОбновитьДокумент_ВыходныеИзделия(врОбъект, ДанныеВыходногоИзделияМассив);
	КонецЕсли;   
	//Добавим в ТЧ "Трудозатраты" (по согласованию с Иваном отключили)
	Если (Заполнять_Трудозатраты) Тогда
		ПрименитьВДокументахНаСервере_ОбновитьДокумент_Трудозатраты(врОбъект, ДанныеВыходногоИзделияМассив);
	КонецЕсли; 
	//fix: 06.02.2026 — Единственное проведение документа: выполняется ПОСЛЕ заполнения всех ТЧ
	//  (РасходМатериаловИРабот, ОбеспечениеМатериаламиИРаботами, ВыходныеИзделия, Трудозатраты).
	//  Промежуточное проведение из подпроцедуры _РасходМатериаловИРабот убрано.
	
	//debug: 07.02.2026 — Логирование состояния документа ПЕРЕД проведением
	ДиагТекст = "=== ДИАГНОСТИКА ПЕРЕД ПРОВЕДЕНИЕМ ===" + Символы.ПС;
	ДиагТекст = ДиагТекст + "Документ: " + СокрЛП(врОбъект.Номер) + ", КоличествоУпаковокФакт=" + врОбъект.КоличествоУпаковокФакт
		+ ", КоличествоУпаковокПлан=" + врОбъект.КоличествоУпаковокПлан + Символы.ПС;
	ДиагТекст = ДиагТекст + "--- ВыходныеИзделия (" + врОбъект.ВыходныеИзделия.Количество() + " строк) ---" + Символы.ПС;
	Для Каждого дСтр Из врОбъект.ВыходныеИзделия Цикл
		ДиагТекст = ДиагТекст + "  " + дСтр.Номенклатура + " | Кол=" + дСтр.КоличествоУпаковок
			+ " | Произведено=" + дСтр.Произведено + " | Назначение=" + дСтр.Назначение + Символы.ПС;
	КонецЦикла;
	ДиагТекст = ДиагТекст + "--- РасходМатериаловИРабот (" + врОбъект.РасходМатериаловИРабот.Количество() + " строк) ---" + Символы.ПС;
	Для Каждого дСтр Из врОбъект.РасходМатериаловИРабот Цикл
		ДиагТекст = ДиагТекст + "  " + дСтр.Номенклатура + " | Кол=" + дСтр.КоличествоУпаковок
			+ " | Аналитика=" + дСтр.АналитикаУчетаНоменклатуры + " | СтатьяКалькуляции=" + дСтр.СтатьяКалькуляции + Символы.ПС;
	КонецЦикла;
	ДиагТекст = ДиагТекст + "--- ОбеспечениеМатериаламиИРаботами (" + врОбъект.ОбеспечениеМатериаламиИРаботами.Количество() + " строк) ---" + Символы.ПС;
	Для Каждого дСтр Из врОбъект.ОбеспечениеМатериаламиИРаботами Цикл
		ДиагТекст = ДиагТекст + "  " + дСтр.Номенклатура + " | Кол=" + дСтр.КоличествоУпаковок
			+ " | Назначение=" + дСтр.Назначение + " | ВариантОбеспечения=" + дСтр.ВариантОбеспечения
			+ " | Обособленно=" + дСтр.Обособленно + Символы.ПС;
	КонецЦикла;
	ЗаписьЖурналаРегистрации("РабочееМестоЛокальныйДиспетчер.ДиагностикаПередПроведением",
		УровеньЖурналаРегистрации.Ошибка, , врОбъект.Ссылка, ДиагТекст,
		РежимТранзакцииЗаписиЖурналаРегистрации.Независимая);
	
	//Диагностика: проверка версии объекта перед записью
	ВерсияВПамяти = "";
	Попытка
		ВерсияВПамяти = Base64Строка(врОбъект.ВерсияДанных);
	Исключение
		ВерсияВПамяти = "недоступно";
	КонецПопытки;
	Запрос = Новый Запрос("ВЫБРАТЬ ВерсияДанных ИЗ Документ.ЭтапПроизводства2_2 ГДЕ Ссылка = &Ссылка");
	Запрос.УстановитьПараметр("Ссылка", ДокументЭтапаПроизводства);
	РезультатВерсии = Запрос.Выполнить();
	ВерсияВБД = "";
	Если НЕ РезультатВерсии.Пустой() Тогда
		Выборка = РезультатВерсии.Выбрать();
		Выборка.Следующий();
		Попытка
			ВерсияВБД = Base64Строка(Выборка.ВерсияДанных);
		Исключение
			ВерсияВБД = "недоступно";
		КонецПопытки;
	КонецЕсли;
	ВерсииСовпадают = (ВерсияВПамяти = ВерсияВБД);
	ДиагТекстВерсии = "=== ВЕРСИИ ПЕРЕД ЗАПИСЬЮ ===" + Символы.ПС
		+ "Документ: " + СокрЛП(ДокументЭтапаПроизводства.Номер) + Символы.ПС
		+ "ВерсияВПамяти: " + ВерсияВПамяти + Символы.ПС
		+ "ВерсияВБД: " + ВерсияВБД + Символы.ПС
		+ "Совпадают: " + ВерсииСовпадают + Символы.ПС
		+ "ЗаписанныеРанее: ";
	Для Каждого КлючЗначение Из ЗаписанныеДокументы Цикл
		ДиагТекстВерсии = ДиагТекстВерсии + СокрЛП(КлючЗначение.Ключ.Номер) + "; ";
	КонецЦикла;
	ЗаписьЖурналаРегистрации("РабочееМестоЛокальныйДиспетчер.ДиагностикаВерсий",
		УровеньЖурналаРегистрации.Ошибка, , врОбъект.Ссылка, ДиагТекстВерсии,
		РежимТранзакцииЗаписиЖурналаРегистрации.Независимая);
	
	врОбъект.Записать(РежимЗаписиДокумента.Проведение);
	ЗаписанныеДокументы.Вставить(ДокументЭтапаПроизводства, Истина); //Регистрируем записанный документ
	РезультатОбработки											= "успешно изменен.";
	Если (врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда
		РезультатОбработки										= "успешно изменен, этап завершен.";
	КонецЕсли;
КонецПроцедуры
&НаСервере
Процедура ПрименитьВДокументахНаСервере_ОбновитьПредшественниковБезМатериалов(ДокументЭтапаПроизводства, ТЗМатериалы, РезультатОбработки, СтруктураДокументовДляЗаписи, ОбработанныеПредшественники, ЗаписанныеДокументы)
	//Обновляем ВыходныеИзделия у предшественников, которые не входят в основной цикл обработки (выпуск полуфабрикатов)
	УстановитьПривилегированныйРежим(Истина);

	Для Каждого врСтрокаМ Из ТЗМатериалы Цикл
		ПредшествующиеЭтапы												= ЭтапыПроизводства_НайтиПредшествующие(ДокументЭтапаПроизводства.Ссылка, , врСтрокаМ.Номенклатура);
		Если (ПредшествующиеЭтапы = Неопределено) Тогда Продолжить; КонецЕсли;
		врПредшествующийЭтап											= ПредшествующиеЭтапы[0].СсылкаПредшествующий;

		Если (врПредшествующийЭтап.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Продолжить; КонецЕсли;

		//Пропускаем предшественников из других подразделений (не трогаем этапы чужих цехов)
		Если врПредшествующийЭтап.Подразделение <> ДокументЭтапаПроизводства.Подразделение Тогда Продолжить; КонецЕсли;

		//Пропускаем предшественников, которые уже были обработаны (из другого этапа в этом же цикле)
		Если ОбработанныеПредшественники.Получить(врПредшествующийЭтап) <> Неопределено Тогда Продолжить; КонецЕсли;
		
		//Пропускаем предшественников, которые уже были записаны в этой транзакции
		Если ЗаписанныеДокументы.Получить(врПредшествующийЭтап) <> Неопределено Тогда Продолжить; КонецЕсли;

		//Пропускаем предшественников, которые уже есть в основном цикле обработки — они будут обработаны в ОбновитьДокумент
		врВОсновномЦикле = Ложь;
		Для Каждого врЭлемент Из СтруктураДокументовДляЗаписи Цикл
			Если врЭлемент.Значение.ЭтапПроизводства = врПредшествующийЭтап Тогда
				врВОсновномЦикле = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Если врВОсновномЦикле Тогда Продолжить; КонецЕсли;

		//Управляемая блокировка предшественника
		БлокировкаДанных = Новый БлокировкаДанных;
		ЭлементБлокировки = БлокировкаДанных.Добавить("Документ.ЭтапПроизводства2_2");
		ЭлементБлокировки.УстановитьЗначение("Ссылка", врПредшествующийЭтап);
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		БлокировкаДанных.Заблокировать();

		врОбъект														= врПредшествующийЭтап.ПолучитьОбъект();
		//Обновим статус (без отдельного проведения)
		ПрименитьВДокументахНаСервере_ОбновитьДокумент_ПроверитьСтатус(врОбъект);

		ДанныеВыходногоИзделияМассив									= Новый Массив;
		ДанныеВыходногоИзделия											= ПолучитьДанныеВыходногоИзделия(врПредшествующийЭтап, врСтрокаМ.КоличествоУпаковок);
		ДанныеВыходногоИзделияМассив.Добавить(ДанныеВыходногоИзделия);

		ПрименитьВДокументахНаСервере_ОбновитьДокумент_ВыходныеИзделия(врОбъект, ДанныеВыходногоИзделияМассив);

		//Диагностика: логируем запись предшественника
		ЗаписьЖурналаРегистрации("РабочееМестоЛокальныйДиспетчер.ЗаписьПредшественника",
			УровеньЖурналаРегистрации.Ошибка, , врОбъект.Ссылка,
			"Запись предшественника " + СокрЛП(врПредшествующийЭтап.Номер) + " для " + СокрЛП(ДокументЭтапаПроизводства.Номер),
			РежимТранзакцииЗаписиЖурналаРегистрации.Независимая);
		
		врОбъект.Записать(РежимЗаписиДокумента.Проведение);
		ОбработанныеПредшественники.Вставить(врПредшествующийЭтап, Истина);
		ЗаписанныеДокументы.Вставить(врПредшествующийЭтап, Истина); //Регистрируем записанный документ
		врСтрокаСообщения										= "успешно изменен (без обеспечения материалами).";
		Если (врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда
			врСтрокаСообщения									= "успешно изменен, этап завершен (без обеспечения материалами).";
		КонецЕсли;
		РезультатОбработки												= РезультатОбработки + "Результат обработки этапа " + СокрЛП(врПредшествующийЭтап.Номер) + " от " + Формат(врПредшествующийЭтап.Дата, "ДЛФ=Д") + ": ";
		РезультатОбработки												= РезультатОбработки + врСтрокаСообщения + Символы.ПС;
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры
&НаСервере
Функция   ПрименитьВДокументахНаСервере_ЗавершитьЭтап_Рекурсивно(СтрокаДерева, РезультатОбработки, ЗаписанныеДокументы)
	//Алгоритм простой: обходим дерево, построенное в "ДеревоЭтапыПроизводстваПоИзделию", опускаемся вниз, там пробуем закрыть, возвращаем результат.
	ПредыдущиеЭтапыЗавершены											= Истина;
	ЕстьПредшествующие													= СтрокаДерева.ПолучитьЭлементы().Количество() > 0;
	Если (ЕстьПредшествующие) Тогда
		//Рекурсивно проверим предшестующие
		Для Каждого врСтрокаД Из СтрокаДерева.ПолучитьЭлементы() Цикл
			Если НЕ(врСтрокаД.ПолучитьЭлементы().Количество() = 0) Тогда
				ПредыдущиеЭтапыЗавершены								= Истина;
				ПредыдущиеЭтапыЗавершены								= ПрименитьВДокументахНаСервере_ЗавершитьЭтап_Рекурсивно(врСтрокаД, РезультатОбработки, ЗаписанныеДокументы);
				Если НЕ(ПредыдущиеЭтапыЗавершены) Тогда Продолжить; КонецЕсли;
			КонецЕсли;
			
			//Управляемая блокировка перед завершением этапа
			БлокировкаДанных = Новый БлокировкаДанных;
			ЭлементБлокировки = БлокировкаДанных.Добавить("Документ.ЭтапПроизводства2_2");
			ЭлементБлокировки.УстановитьЗначение("Ссылка", врСтрокаД.Ссылка);
			ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
			БлокировкаДанных.Заблокировать();

			врОбъект													= врСтрокаД.Ссылка.ПолучитьОбъект();
			
			Если (врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Продолжить; КонецЕсли;
			
			Если ((врОбъект.КоличествоУпаковокФакт + врОбъект.КоличествоУпаковокОтменено) >= врОбъект.КоличествоУпаковокПлан) Тогда
				врОбъект.Статус	= Перечисления.СтатусыЭтаповПроизводства2_2.Завершен;
				врОбъект.ФактическоеОкончаниеЭтапа = ТекущаяДатаСеанса();
				врПараметрыОтбора = Новый Структура;
				врПараметрыОтбора.Вставить("ВариантОбеспечения", Перечисления.ВариантыОбеспечения.КОбеспечению);
				врМассивСтрок = врОбъект.ОбеспечениеМатериаламиИРаботами.НайтиСтроки(врПараметрыОтбора);
				Для Каждого мСтрока Из врМассивСтрок Цикл
					врОбъект.ОбеспечениеМатериаламиИРаботами.Удалить(мСтрока);
				КонецЦикла;
				
				врОбъект.Записать(РежимЗаписиДокумента.Проведение);
				ЗаписанныеДокументы.Вставить(врСтрокаД.Ссылка, Истина);
				РезультатОбработки							= РезультатОбработки + "Результат обработки: этапа " + СокрЛП(врОбъект.Номер) + " от " + Формат(врОбъект.Дата, "ДЛФ=Д") + ": этап завершен." + Символы.ПС;
			Иначе
				ПредыдущиеЭтапыЗавершены							= Ложь;
			КонецЕсли;
		КонецЦикла;
	Конецесли;
	Если НЕ(ЕстьПредшествующие) Тогда
		//Управляемая блокировка
		БлокировкаДанных = Новый БлокировкаДанных;
		ЭлементБлокировки = БлокировкаДанных.Добавить("Документ.ЭтапПроизводства2_2");
		ЭлементБлокировки.УстановитьЗначение("Ссылка", СтрокаДерева.Ссылка);
		ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
		БлокировкаДанных.Заблокировать();

		врОбъект													= СтрокаДерева.Ссылка.ПолучитьОбъект();
		
		Если НЕ(врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда
			Если ((врОбъект.КоличествоУпаковокФакт + врОбъект.КоличествоУпаковокОтменено) >= врОбъект.КоличествоУпаковокПлан) Тогда
				врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен;
				врОбъект.ФактическоеОкончаниеЭтапа = ТекущаяДатаСеанса();
				врПараметрыОтбора = Новый Структура;
				врПараметрыОтбора.Вставить("ВариантОбеспечения", Перечисления.ВариантыОбеспечения.КОбеспечению);
				врМассивСтрок = врОбъект.ОбеспечениеМатериаламиИРаботами.НайтиСтроки(врПараметрыОтбора);
				Для Каждого мСтрока Из врМассивСтрок Цикл
					врОбъект.ОбеспечениеМатериаламиИРаботами.Удалить(мСтрока);
				КонецЦикла;
				
				врОбъект.Записать(РежимЗаписиДокумента.Проведение);
				ЗаписанныеДокументы.Вставить(СтрокаДерева.Ссылка, Истина);
				РезультатОбработки							= РезультатОбработки + "Результат обработки: этапа " + СокрЛП(врОбъект.Номер) + " от " + Формат(врОбъект.Дата, "ДЛФ=Д") + ": этап завершен." + Символы.ПС;
			Иначе
				ПредыдущиеЭтапыЗавершены							= Ложь;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ПредыдущиеЭтапыЗавершены;
КонецФункции
&НаСервере
Процедура ПрименитьВДокументахНаСервере(СообщениеПользователю)
	УстановитьПривилегированныйРежим(Истина);
	//Отключим на время контроль остатков
	врПроводитьБезКонтроляОстатковТоваровОрганизаций					= ПараметрыСеанса.ПроводитьБезКонтроляОстатковТоваровОрганизаций;
	Если НЕ(врПроводитьБезКонтроляОстатковТоваровОрганизаций) Тогда
		ПараметрыСеанса.ПроводитьБезКонтроляОстатковТоваровОрганизаций	= Истина;
	КонецЕсли;
	//fix: 16.02.2026 — Убран bypass ПропуститьПроверкуЗапретаИзменения.
	//  Теперь код работает без обхода проверки запрета изменения по датам,
	//  т.к. процедура СжатьТабличнуюЧастьПоДате не модифицирует строки с прошлыми датами.

	//Алгоритм простой: из дерева значений составляем структуру, каждый элемент которой состоит из "Ссылка" и таблицы значений материалов
	врШаблонТЗ															= Новый ТаблицаЗначений;
	врШаблонТЗ.Колонки.Добавить("Номенклатура");
	врШаблонТЗ.Колонки.Добавить("Упаковка");
	врШаблонТЗ.Колонки.Добавить("НоменклатураИсходная");
	врШаблонТЗ.Колонки.Добавить("Количество");
	врШаблонТЗ.Колонки.Добавить("КоличествоУпаковок");
	врШаблонТЗ.Колонки.Добавить("ОсновноеИзделие");
	врШаблонТЗ.Колонки.Добавить("ОсновноеИзделиеКоличествоУпаковок"); 
	врШаблонТЗ.Колонки.Добавить("Назначение");
	врШаблонТЗ.Колонки.Добавить("Характеристика");
	врШаблонТЗВыпуска													= Новый ТаблицаЗначений;
	врШаблонТЗВыпуска.Колонки.Добавить("Номенклатура");
	врШаблонТЗВыпуска.Колонки.Добавить("КоличествоУпаковок");
	врШаблонТЗВыпуска.Колонки.Добавить("Подразделение");
	врШаблонТЗВыпуска.Колонки.Добавить("Назначение");
	врШаблонТЗВыпуска.Колонки.Добавить("ЭтапПроизводства");
	СтруктураДокументовДляЗаписи										= Новый Структура;
	ПолучитьСтруктуруДокументовДляЗаписиРекурсивно(СтруктураДокументовДляЗаписи, врШаблонТЗ, врШаблонТЗВыпуска, ДеревоИспользованныхМатериалов.ПолучитьЭлементы());
	СтруктураДокументовДляЗаписи										= ОтсортироватьПорядокДокументов(СтруктураДокументовДляЗаписи);

	НачатьТранзакцию();
	Попытка

	ОбработанныеПредшественники											= Новый Соответствие; //Защита от повторной обработки одного предшественника из разных этапов
	ЗаписанныеДокументы													= Новый Соответствие; //Защита от повторной записи документа в одной транзакции
	ТекущийЭтапИнфо														= ""; //Трекер текущего этапа для диагностики ошибок
	Для Каждого врСтрока Из СтруктураДокументовДляЗаписи Цикл

		врНомерЭтапа = СокрЛП(врСтрока.Значение.ЭтапПроизводства.Номер);
		врДатаЭтапа  = Формат(врСтрока.Значение.ЭтапПроизводства.Дата, "ДЛФ=Д");
		ТекущийЭтапИнфо													= "этап " + врНомерЭтапа + " от " + врДатаЭтапа;

		РезультатОбработки												= "";
		ПрименитьВДокументахНаСервере_ОбновитьПредшественниковБезМатериалов(врСтрока.Значение.ЭтапПроизводства, врСтрока.Значение.ТЗМатериалы, РезультатОбработки, СтруктураДокументовДляЗаписи, ОбработанныеПредшественники, ЗаписанныеДокументы);
		Если НЕ(РезультатОбработки = "") Тогда
			СообщениеПользователю										= СообщениеПользователю + РезультатОбработки;
		КонецЕсли;

		РезультатОбработки												= "";
		ПрименитьВДокументахНаСервере_ОбновитьДокумент(врСтрока.Значение.ЭтапПроизводства, врСтрока.Значение.ТЗМатериалы, врСтрока.Значение.ТЗВыпуска, РезультатОбработки, ЗаписанныеДокументы);
		врСтрокаСообщения												= "Результат обработки этапа " + врНомерЭтапа + " от " + врДатаЭтапа + ": ";
		врСтрокаСообщения												= врСтрокаСообщения + РезультатОбработки + Символы.ПС;
		СообщениеПользователю											= СообщениеПользователю + врСтрокаСообщения;

	КонецЦикла;

	//Закроем доступные этапы
	ТекущийЭтапИнфо														= "завершение этапов";
	РезультатОбработки													= "";
	Для Каждого врСтрокаД Из ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы() Цикл
		Если (врСтрокаД.Ссылка = ОбработкаЭтапа_РедактируемыйЭтапПроизводства) Тогда
			ТекущийЭтапИнфо												= "завершение этапа " + СокрЛП(врСтрокаД.Ссылка.Номер);
			ОсновнойЭтапЗавершен										= ПрименитьВДокументахНаСервере_ЗавершитьЭтап_Рекурсивно(врСтрокаД, РезультатОбработки, ЗаписанныеДокументы);
			Если (ОсновнойЭтапЗавершен) Тогда
				//Управляемая блокировка основного этапа
				БлокировкаДанных = Новый БлокировкаДанных;
				ЭлементБлокировки = БлокировкаДанных.Добавить("Документ.ЭтапПроизводства2_2");
				ЭлементБлокировки.УстановитьЗначение("Ссылка", врСтрокаД.Ссылка);
				ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
				БлокировкаДанных.Заблокировать();

				врОбъект													= врСтрокаД.Ссылка.ПолучитьОбъект();
				Если НЕ(врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен)
					И ((врОбъект.КоличествоУпаковокФакт + врОбъект.КоличествоУпаковокОтменено) >= врОбъект.КоличествоУпаковокПлан) Тогда
					врОбъект.Статус	= Перечисления.СтатусыЭтаповПроизводства2_2.Завершен;
					врОбъект.ФактическоеОкончаниеЭтапа = ТекущаяДатаСеанса();
					врПараметрыОтбора = Новый Структура;
					врПараметрыОтбора.Вставить("ВариантОбеспечения", Перечисления.ВариантыОбеспечения.КОбеспечению);
					врМассивСтрок = врОбъект.ОбеспечениеМатериаламиИРаботами.НайтиСтроки(врПараметрыОтбора);
					Для Каждого мСтрока Из врМассивСтрок Цикл
						врОбъект.ОбеспечениеМатериаламиИРаботами.Удалить(мСтрока);
					КонецЦикла;
					
					врОбъект.Записать(РежимЗаписиДокумента.Проведение);
					ЗаписанныеДокументы.Вставить(врСтрокаД.Ссылка, Истина);
					СообщениеПользователю							= СообщениеПользователю + РезультатОбработки + "Конечный этап завершен.";
				ИначеЕсли НЕ((врОбъект.КоличествоУпаковокФакт + врОбъект.КоличествоУпаковокОтменено) >= врОбъект.КоличествоУпаковокПлан) Тогда
					ПредыдущиеЭтапыЗавершены							= Ложь;
				КонецЕсли;
			КонецЕсли;
			Если НЕ(ОсновнойЭтапЗавершен) Тогда
				врОбъект												= врСтрокаД.Ссылка.ПолучитьОбъект();
				ОсновнойЭтапПроизводстваЗакрыт							= врОбъект.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен;
				СообщениеПользователю									= СообщениеПользователю + РезультатОбработки + ?(ОсновнойЭтапПроизводстваЗакрыт, "Конечный этап завершен.", "Конечный этап не завершен.");
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		ЗаписьЖурналаРегистрации("РабочееМестоЛокальныйДиспетчер.ОшибкаОбработки",
			УровеньЖурналаРегистрации.Ошибка, , , "Ошибка при обработке [" + ТекущийЭтапИнфо + "]: " + ОписаниеОшибки());
		ПараметрыСеанса.ПроводитьБезКонтроляОстатковТоваровОрганизаций	= врПроводитьБезКонтроляОстатковТоваровОрганизаций;
		ВызватьИсключение;
	КонецПопытки;

	ПараметрыСеанса.ПроводитьБезКонтроляОстатковТоваровОрганизаций		= врПроводитьБезКонтроляОстатковТоваровОрганизаций;
	УстановитьПривилегированныйРежим(Ложь);
КонецПроцедуры
&НаКлиенте
Процедура ПрименитьВДокументах_Завершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	Если НЕ(РезультатВопроса = КодВозвратаДиалога.Да) Тогда Возврат; КонецЕсли;
	
	СообщениеПользователю												= "";
	ПрименитьВДокументахНаСервере(СообщениеПользователю);
	
	ОтменитьТекущуюРаботу_Завершение(КодВозвратаДиалога.Да, Неопределено);
	
	Если НЕ(Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные = Неопределено) Тогда
		ТекущаяСтрокаДерева												= Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные.ПолучитьИдентификатор();
		ЭтапПроизводстваТекущейСтрокиДерева								= Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные.Ссылка;
	КонецЕсли;
	Ошибка																= "";
	Отбор_ИзделниеПриИзмененииНаСервере(Ошибка);
	ОбработкаОповещения_УстановитьСтрокуРекурсивно(ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы(), ЭтапПроизводстваТекущейСтрокиДерева, Неопределено, Ложь);
	Если НЕ(Элементы.ДеревоЭтапыПроизводстваПоИзделию.ТекущиеДанные = Неопределено) Тогда
		ДеревоЭтапыПроизводстваПоИзделиюПриАктивизацииСтрокиНаСервере();
	КонецЕсли;
	
	ПараметрыОткрытия													= Новый Структура;
	ПараметрыОткрытия.Вставить("СообщениеПользователю",					СообщениеПользователю);
	Попытка
			ОткрытьФорму("ВнешняяОбработка.РабочееМестоЛокальныйДиспетчер.Форма.ФормаОповещенияОРезультатеОбработкиДокументов", ПараметрыОткрытия, ЭтаФорма, , , , , РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		Исключение
			ОткрытьФорму("Обработка.РабочееМестоЛокальныйДиспетчер.Форма.ФормаОповещенияОРезультатеОбработкиДокументов", ПараметрыОткрытия, ЭтаФорма, , , , , РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
		КонецПопытки;   
		
	П = Новый Структура;
	П.Вставить("Ключ", ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства);
	ОткрытьФорму("Документ.ЭтапПроизводства2_2.ФормаОбъекта", П ); 
	
КонецПроцедуры
&НаКлиенте
Процедура ПрименитьВДокументах(Команда)
	//Если (ДеревоИспользованныхМатериалов.ПолучитьЭлементы().Количество() = 0) Тогда Возврат; КонецЕсли;
	ОписаниеОповещения												= Новый ОписаниеОповещения("ПрименитьВДокументах_Завершение", ЭтотОбъект);
	ПоказатьВопрос(ОписаниеОповещения, "Данные таблиц материалов и трудозатрат будут записаны в соответствующие этапы производства. Продолжить?", РежимДиалогаВопрос.ДаНет);
КонецПроцедуры
//* Вспомогательные процедуры и функции *********************************************************************************************************************
&НаСервере
Функция   ПолучитьСтруктуруПроизводственныхЭтаповСпецификации(врСпецификация, врПодразделение)
	ВозвращаемаяСтруктура											= Новый Структура;
	ВозвращаемаяСтруктура.Вставить("НетЭтапов",						Ложь);
	ВозвращаемаяСтруктура.Вставить("МассивЭтапов", 					Новый Массив);
	
	врЗапрос														= Новый Запрос("ВЫБРАТЬ
	        														               |	ЭтапыПроизводства.Ссылка КАК Ссылка,
	        														               |	ЭтапыПроизводства.Владелец КАК Владелец,
	        														               |	ЭтапыПроизводства.Наименование КАК Наименование,
	        														               |	ЭтапыПроизводства.Подразделение КАК Подразделение,
	        														               |	ЭтапыПроизводства.НомерЭтапа КАК НомерЭтапа,
	        														               |	ЭтапыПроизводства.НомерСледующегоЭтапа КАК НомерСледующегоЭтапа
	        														               |ИЗ
	        														               |	Справочник.ЭтапыПроизводства КАК ЭтапыПроизводства
	        														               |ГДЕ
	        														               |	ЭтапыПроизводства.Владелец = &Спецификация
	        														               |	И ЭтапыПроизводства.Подразделение = &Подразделение
	        														               |
	        														               |УПОРЯДОЧИТЬ ПО
	        														               |	НомерЭтапа УБЫВ");
	врЗапрос.УстановитьПараметр("Спецификация",						врСпецификация);
	врЗапрос.УстановитьПараметр("Подразделение",					врПодразделение);
	Результат														= врЗапрос.Выполнить();
	Если (Результат.Пустой()) Тогда
			ВозвращаемаяСтруктура.Вставить("НетЭтапов",				Истина);
		Иначе
			врМассивЭтапов											= Результат.Выгрузить().ВыгрузитьКолонку("Ссылка");
			ВозвращаемаяСтруктура.Вставить("МассивЭтапов",	 		врМассивЭтапов);
	КонецЕсли;
	
	Возврат ВозвращаемаяСтруктура;
КонецФункции
&НаКлиенте
Процедура НайтиСтрокуДереваРекурсивно(СтрокиДерева, ИдентификаторСтроки, СтрокаДерева, СтрокаНайдена)
	Для Каждого врСтрокаД Из СтрокиДерева Цикл
		Если (СтрокаНайдена) Тогда Прервать; КонецЕсли;
		Если (врСтрокаД.ИдентификаторСтроки = ИдентификаторСтроки) Тогда
			СтрокаДерева											= врСтрокаД;
			СтрокаНайдена											= Истина;
			Прервать;
		КонецЕсли;
		Если НЕ(врСтрокаД.ПолучитьЭлементы().Количество() = 0) Тогда
			НайтиСтрокуДереваРекурсивно(врСтрокаД.ПолучитьЭлементы(), ИдентификаторСтроки, СтрокаДерева, СтрокаНайдена);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
&НаСервере
Функция   РаботаСЭтапомВозможна(врСсылка)
	Для Каждого врСтрока Из Объект.ЭтапыПроизводстваПоИзделию Цикл
		Если (врСтрока.Ссылка = врСсылка) Тогда
			Возврат НЕ(врСтрока.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен);
		КонецЕсли;
	КонецЦикла;
	Возврат Ложь;
КонецФункции
&НаКлиенте
Процедура УдалитьИспользованныйМатериал(Команда)
	ТекущиеДанные														= Элементы.ДеревоИспользованныхМатериалов.ТекущиеДанные;
	Если (ТекущиеДанные = Неопределено) Тогда Возврат; КонецЕсли;
	Если НЕ(ТекущиеДанные.ИзменениеДоступно) Тогда
		ПоказатьПредупреждение( , "Нельзя редактировать строку (статус ""Завершен"")!", 15, "Информация...");
		Возврат;
	КонецЕсли;

	ТекущиеДанные.КоличествоУпаковокФактически							= 0;
	ТекущиеДанные.ЕстьИзменение											= НЕ(ТекущиеДанные.КоличествоУпаковокТребуется = ТекущиеДанные.КоличествоУпаковокФактически);
	ОбработкаЭтапа_БылиИзменения										= БылиИзменения();
КонецПроцедуры
&НаСервере
Функция   БылиИзменения()
	Возврат БылиИзменения_Рекурсивно(ДеревоИспользованныхМатериалов.ПолучитьЭлементы());
КонецФункции
&НаСервере
Функция   БылиИзменения_Рекурсивно(СтрокаДерева)
	Для Каждого врСтрокаД Из СтрокаДерева Цикл
		Если (врСтрокаД.ЕстьИзменение) Тогда Возврат Истина; КонецЕсли;
		Если НЕ(врСтрокаД.ПолучитьЭлементы().Количество() = 0) Тогда
			Если (БылиИзменения_Рекурсивно(врСтрокаД.ПолучитьЭлементы())) Тогда Возврат Истина; КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Ложь;
КонецФункции
&НаСервере
Процедура ОчиститьСпискиДерево()
	ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы().Очистить();

	Отбор_СписокЗначений_ПодразделениеИсполнитель					= Справочники.СтруктураПредприятия.ПустаяСсылка();
	врСписокВыбора													= Элементы.Отбор_СписокЗначений_ПодразделениеИсполнитель.СписокВыбора;
	врСписокВыбора.Очистить();

	Отбор_СписокЗначений_Спецификация								= Справочники.СтруктураПредприятия.ПустаяСсылка();
	врСписокВыбора													= Элементы.Отбор_СписокЗначений_Спецификация.СписокВыбора;
	врСписокВыбора.Очистить();
	
	ДеревоЭтапыПроизводстваПоИзделию_ЗаказНаПроизводствоТекст		= "";
	ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводстваТекст	= "";
КонецПроцедуры
&НаСервере
Процедура ОчиститьСпискиДеревоМатериалы()
	ДеревоИспользованныхМатериалов.ПолучитьЭлементы().Очистить();
	ТаблицаТрудозатрат.Очистить();

	ОбработкаЭтапа_Начата											= Ложь;
	ОбработкаЭтапа_РедактируемыйЭтапПроизводства					= ПредопределенноеЗначение("Документ.ЭтапПроизводства2_2.ПустаяСсылка");
	ОбработкаЭтапа_Рапределено										= 0;
	ОбработкаЭтапа_БылиИзменения									= Ложь;
	ОбработкаЭтапа_БылиИзмененияТрудозатрат							= Ложь; // BSLLS:UnusedLocalVariable-off - реквизит формы
КонецПроцедуры
&НаСервере
Процедура ЗаполнитьОтборы_ПодразделениеИсполнитель()
	Объект.Отбор_ПодразделениеИсполнитель							= Справочники.СтруктураПредприятия.ПустаяСсылка();
	Отбор_СписокЗначений_ПодразделениеИсполнитель					= Справочники.СтруктураПредприятия.ПустаяСсылка();
	
	врСписокВыбора													= Элементы.Отбор_СписокЗначений_ПодразделениеИсполнитель.СписокВыбора;
	врСписокВыбора.Очистить();
	Для Каждого врСтрока Из Объект.ЭтапыПроизводстваПоИзделию Цикл
		Если НЕ(врСтрока.ОсновнойЭтапПроизводства = ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства) Тогда Продолжить; КонецЕсли;
		Если (врСтрока.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Продолжить; КонецЕсли;
		
		//Подразделение и спецификация основоного этапа производства не нужны
		//С 28.09.2023 подразделение снова нужно
		Если (врСписокВыбора.НайтиПоЗначению(врСтрока.ПодразделениеИсполнитель) = Неопределено) Тогда
			врСписокВыбора.Добавить(врСтрока.ПодразделениеИсполнитель);
		КонецЕсли;

		врПараметрыОтбора											= Новый Структура;
		врПараметрыОтбора.Вставить("Ссылка",						врСтрока.Ссылка);
		НайденныеСтрокиПредшествующих								= Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.НайтиСтроки(врПараметрыОтбора);
		Если НЕ(НайденныеСтрокиПредшествующих.Количество() = 0) Тогда
			Для Каждого врСтрокаП Из НайденныеСтрокиПредшествующих Цикл
				Если (врСтрокаП.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Продолжить; КонецЕсли;
				Если (врСписокВыбора.НайтиПоЗначению(врСтрокаП.ПодразделениеИсполнитель) = Неопределено) Тогда
					врСписокВыбора.Добавить(врСтрокаП.ПодразделениеИсполнитель);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	Если (врСписокВыбора.Количество() > 0) Тогда     // было = 1 01.12.23 добавил изменил на > 0 , теперь цех подставляется всегда, даже если в предшественниках есть другие цеха
		Отбор_СписокЗначений_ПодразделениеИсполнитель				= врСписокВыбора[0].Значение;
		Объект.Отбор_ПодразделениеИсполнитель						= Отбор_СписокЗначений_ПодразделениеИсполнитель;
	КонецЕсли;    
	
КонецПроцедуры
&НаСервере
Процедура ЗаполнитьОтборы_Спецификация()
	//Спецификации связаны с выбранным цехом
	Объект.Отбор_Спецификация										= Справочники.СтруктураПредприятия.ПустаяСсылка();
	Отбор_СписокЗначений_Спецификация								= Справочники.СтруктураПредприятия.ПустаяСсылка();
	врСписокВыбора													= Элементы.Отбор_СписокЗначений_Спецификация.СписокВыбора;
	врСписокВыбора.Очистить();
	Если НЕ(ЗначениеЗаполнено(Объект.Отбор_ПодразделениеИсполнитель)) Тогда Возврат; КонецЕсли;
	
	Для Каждого врСтрока Из Объект.ЭтапыПроизводстваПоИзделию Цикл
		Если НЕ(врСтрока.ОсновнойЭтапПроизводства = ДеревоЭтапыПроизводстваПоИзделию_ОсновнойЭтапПроизводства) Тогда Продолжить; КонецЕсли;
		Если (врСтрока.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Продолжить; КонецЕсли;
		
		//Подразделение и спецификация основоного этапа производства не нужны
		//Если (врСписокВыбора.НайтиПоЗначению(врСтрока.Спецификация) = Неопределено) Тогда
		//	Если (врСтрока.ПодразделениеИсполнитель = Объект.Отбор_ПодразделениеИсполнитель) Тогда
		//		врСписокВыбора.Добавить(врСтрока.Спецификация);
		//	КонецЕсли;
		//КонецЕсли;
		
		врПараметрыОтбора											= Новый Структура;
		врПараметрыОтбора.Вставить("Ссылка",						врСтрока.Ссылка);
		НайденныеСтрокиПредшествующих								= Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.НайтиСтроки(врПараметрыОтбора);
		Если НЕ(НайденныеСтрокиПредшествующих.Количество() = 0) Тогда
			Для Каждого врСтрокаП Из НайденныеСтрокиПредшествующих Цикл
				Если (врСтрокаП.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Продолжить; КонецЕсли;
				
				Если (врСписокВыбора.НайтиПоЗначению(врСтрокаП.Спецификация) = Неопределено) Тогда
					Если (врСтрокаП.ПодразделениеИсполнитель = Объект.Отбор_ПодразделениеИсполнитель) Тогда
						врСписокВыбора.Добавить(врСтрокаП.Спецификация);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ(врСписокВыбора.НайтиПоЗначению(Объект.Отбор_Спецификация) = Неопределено) Тогда
		Отбор_СписокЗначений_Спецификация							= Объект.Отбор_Спецификация;
	КонецЕсли;
	
	Если (врСписокВыбора.Количество() = 1) Тогда
		Отбор_СписокЗначений_Спецификация							= врСписокВыбора[0].Значение;
		Объект.Отбор_Спецификация									= Отбор_СписокЗначений_Спецификация;
	КонецЕсли;
КонецПроцедуры
&НаСервере
Процедура ЗаполнитьОтборы_ЗаказНаПроизводство()
	//Не используем отбор по заказам, но на всякий случай процедуру оставим (элемнт управления на форме скрыт)
	Отбор_СписокЗначений_ЗаказНаПроизводство						= Справочники.СтруктураПредприятия.ПустаяСсылка();
	врСписокВыбора													= Элементы.Отбор_СписокЗначений_ЗаказНаПроизводство.СписокВыбора;
	врСписокВыбора.Очистить();
	Для Каждого врСтрока Из Объект.ЭтапыПроизводстваПоИзделию Цикл
		Если (врСтрока.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Продолжить; КонецЕсли;
		
		Если (врСписокВыбора.НайтиПоЗначению(врСтрока.ЗаказНаПроизводство) = Неопределено) Тогда
			врСписокВыбора.Добавить(врСтрока.ЗаказНаПроизводство);
		КонецЕсли;
		
		врПараметрыОтбора											= Новый Структура;
		врПараметрыОтбора.Вставить("Ссылка",						врСтрока.Ссылка);
		НайденныеСтрокиПредшествующих								= Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.НайтиСтроки(врПараметрыОтбора);
		Если НЕ(НайденныеСтрокиПредшествующих.Количество() = 0) Тогда
			Для Каждого врСтрокаП Из НайденныеСтрокиПредшествующих Цикл
				Если (врСтрокаП.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Продолжить; КонецЕсли;
				Если (врСписокВыбора.НайтиПоЗначению(врСтрокаП.ЗаказНаПроизводство) = Неопределено) Тогда
					врСписокВыбора.Добавить(врСтрокаП.ЗаказНаПроизводство);
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ(врСписокВыбора.НайтиПоЗначению(Объект.Отбор_ЗаказНаПроизводство) = Неопределено) Тогда
		Отбор_СписокЗначений_ЗаказНаПроизводство					= Объект.Отбор_ЗаказНаПроизводство;
	КонецЕсли;
	
	Если (врСписокВыбора.Количество() = 1) Тогда
		Отбор_СписокЗначений_ЗаказНаПроизводство					= врСписокВыбора[0].Значение;
		Объект.Отбор_ЗаказНаПроизводство							= Отбор_СписокЗначений_ЗаказНаПроизводство;
	КонецЕсли;
КонецПроцедуры
&НаКлиенте
Процедура УстановитьДоступностьОтборов()
	Элементы.Отбор_Изделние.Доступность									= НЕ(ОбработкаЭтапа_Начата);
	Элементы.Отбор_СписокЗначений_ПодразделениеИсполнитель.Доступность	= НЕ(ОбработкаЭтапа_Начата);
	Элементы.НачатьРаботу.Доступность									= НЕ(ОбработкаЭтапа_Начата);
	Элементы.ГруппаОтборов.Видимость									= НЕ(ОбработкаЭтапа_Начата);
	Элементы.ГруппаУправлениеМатериалами.Видимость						= ОбработкаЭтапа_Начата;
	ОбновитьДоступностьКнопкиПрименить();
КонецПроцедуры
&НаСервере
Функция   ЭтапыПроизводства_НайтиПоИзделию(НоменклатураИзделия, СтатусыЭтаповПроизводства = Неопределено)
	врЗапрос														= Новый Запрос("ВЫБРАТЬ РАЗЛИЧНЫЕ
	        														               |	Изделия.Ссылка.Номер КАК Номер,
	        														               |	Изделия.Ссылка.Подразделение КАК ПодразделениеИсполнитель,
	        														               |	Изделия.Ссылка.Спецификация КАК Спецификация,
	        														               |	Изделия.Ссылка.Статус КАК Статус,
	        														               |	Изделия.Ссылка КАК Ссылка,
	        														               |	Изделия.Ссылка.Дата КАК Дата,
	        														               |	Изделия.Ссылка.Ссылка КАК ОсновнойЭтапПроизводства,
	        														               |	Изделия.Номенклатура КАК ОсновноеИзделие,
	        														               |	Изделия.Ссылка.Распоряжение КАК ЗаказНаПроизводство
	        														               |ПОМЕСТИТЬ РезультатПодготовленный
	        														               |ИЗ
	        														               |	(ВЫБРАТЬ
	        														               |		ВыходныеИзделияЭтапа.Ссылка КАК Ссылка,
	        														               |		ВыходныеИзделияЭтапа.Номенклатура КАК Номенклатура
	        														               |	ИЗ
	        														               |		Документ.ЭтапПроизводства2_2.ВыходныеИзделия КАК ВыходныеИзделияЭтапа
	        														               |	
	        														               |	ОБЪЕДИНИТЬ ВСЕ
	        														               |	
	        														               |	ВЫБРАТЬ
	        														               |		ПобочныеИзделияЭтапа.Ссылка,
	        														               |		ПобочныеИзделияЭтапа.Номенклатура
	        														               |	ИЗ
	        														               |		Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК ПобочныеИзделияЭтапа) КАК Изделия
	        														               |ГДЕ
	        														               |	Изделия.Номенклатура = &ОсновноеИзделиеНоменклатура
	        														               |	И Изделия.Ссылка.Статус В(&СтатусыЭтаповПроизводства)
	        														               |	И НЕ Изделия.Ссылка.Ссылка ЕСТЬ NULL
	        														               |	И НЕ Изделия.Ссылка.Ссылка.ПометкаУдаления
	        														               |	И Изделия.Ссылка.Ссылка.Проведен
																				   |
																				   |;
	        														               |
	        														               |//////////////////////////////////////////////////////////////////////////////// 
	        														               |ВЫБРАТЬ
	        														               |	РезультатПодготовленный.Статус КАК Статус,
	        														               |	РезультатПодготовленный.Номер КАК Номер,
	        														               |	РезультатПодготовленный.ПодразделениеИсполнитель КАК ПодразделениеИсполнитель,
	        														               |	РезультатПодготовленный.Спецификация КАК Спецификация,
	        														               |	РезультатПодготовленный.ОсновноеИзделие КАК ОсновноеИзделие,
	        														               |	РезультатПодготовленный.Ссылка КАК Ссылка,
	        														               |	РезультатПодготовленный.Дата КАК Дата,
	        														               |	РезультатПодготовленный.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	        														               |	РезультатПодготовленный.ОсновнойЭтапПроизводства КАК ОсновнойЭтапПроизводства,
	        														               |	ЕСТЬNULL(ЭтапПроизводстваПоследователи.НомерСтроки, 0) КАК КоличествоПоследователей
	        														               |ПОМЕСТИТЬ ВыборкаСУчетомКоличестваПоследователей
	        														               |ИЗ
	        														               |	РезультатПодготовленный КАК РезультатПодготовленный
	        														               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	        														               |			ЭтапПроизводстваПоследователи.Ссылка КАК Ссылка,
	        														               |			МАКСИМУМ(ЭтапПроизводстваПоследователи.НомерСтроки) КАК НомерСтроки
	        														               |		ИЗ
	        														               |			Документ.ЭтапПроизводства2_2.Последователи КАК ЭтапПроизводстваПоследователи
	        														               |		
	        														               |		СГРУППИРОВАТЬ ПО
	        														               |			ЭтапПроизводстваПоследователи.Ссылка) КАК ЭтапПроизводстваПоследователи
	        														               |		ПО РезультатПодготовленный.Ссылка = ЭтапПроизводстваПоследователи.Ссылка
	        														               |;
	        														               |
	        														               |////////////////////////////////////////////////////////////////////////////////
	        														               |ВЫБРАТЬ
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Статус КАК Статус,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Номер КАК Номер,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.ПодразделениеИсполнитель КАК ПодразделениеИсполнитель,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Спецификация КАК Спецификация,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.ОсновноеИзделие КАК ОсновноеИзделие,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Ссылка КАК Ссылка,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Дата КАК Дата,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.ОсновнойЭтапПроизводства КАК ОсновнойЭтапПроизводства,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.КоличествоПоследователей КАК КоличествоПоследователей
	        														               |ИЗ
	        														               |	ВыборкаСУчетомКоличестваПоследователей КАК ВыборкаСУчетомКоличестваПоследователей
																				   //|ГДЕ
																				   //|	ВыборкаСУчетомКоличестваПоследователей.КоличествоПоследователей >= 0
	        														               |
	        														               |УПОРЯДОЧИТЬ ПО
	        														               |	Номер ВОЗР");
	врЗапрос.УстановитьПараметр("ОсновноеИзделиеНоменклатура",		НоменклатураИзделия);
	врЗапрос.УстановитьПараметр("СтатусыЭтаповПроизводства",		СтатусыЭтаповПроизводства);	
	Если (СтатусыЭтаповПроизводства = Неопределено) Тогда                                     
		врЗапрос.Текст												= СтрЗаменить(врЗапрос.Текст, "И ВыборкаПредварительно.Статус В(&СтатусыЭтаповПроизводства)", "");
	КонецЕсли;
	Результат														= врЗапрос.Выполнить();
	Если НЕ (Результат.Пустой()) Тогда 	
		врТЗ															= Результат.Выгрузить();
		Возврат врТЗ;
	КонецЕсли;

	//врЗапрос1														= Новый Запрос("ВЫБРАТЬ
	//        														               |	ЭтапПроизводства2_2.Статус КАК Статус,
	//        														               |	ЭтапПроизводства2_2.Номер КАК Номер,
	//        														               |	ЭтапПроизводства2_2.Подразделение КАК ПодразделениеИсполнитель,
	//        														               |	ЭтапПроизводства2_2.Спецификация КАК Спецификация,
	//        														               |	ПобочныеИзделияЭтапа.Номенклатура КАК ОсновноеИзделие,
	//        														               |	ЭтапПроизводства2_2.Ссылка КАК Ссылка,
	//        														               |	ЭтапПроизводства2_2.Дата КАК Дата,
	//        														               |	ЭтапПроизводства2_2.Ссылка.Распоряжение КАК ЗаказНаПроизводство,
	//        														               |	ЭтапПроизводства2_2.Ссылка КАК ОсновнойЭтапПроизводства,	
	//																			   |	ЕСТЬNULL(МАКСИМУМ(ЭтапПроизводства2_2.Последователи.НомерСтроки), 0) КАК КоличествоПоследователей
	//        														               |ИЗ
	//        														               |	Документ.ЭтапПроизводства2_2 КАК ЭтапПроизводства2_2
	//																			   |	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭтапПроизводства2_2.ПобочныеИзделия КАК ПобочныеИзделияЭтапа
	//																			   |	ПО ЭтапПроизводства2_2.Ссылка = ПобочныеИзделияЭтапа.Ссылка
	//        														               |ГДЕ 
	//																			   |	НЕ ПобочныеИзделияЭтапа.Произведено	
	//        														               |	И ПобочныеИзделияЭтапа.Номенклатура = &ОсновноеИзделиеНоменклатура
	//																			   |	И ЭтапПроизводства2_2.Статус В(&СтатусыЭтаповПроизводства)
	//        														               |УПОРЯДОЧИТЬ ПО
	//        														               |	Номер ВОЗР");
	//врЗапрос1.УстановитьПараметр("ОсновноеИзделиеНоменклатура",		НоменклатураИзделия);
	//врЗапрос1.УстановитьПараметр("СтатусыЭтаповПроизводства",		СтатусыЭтаповПроизводства);	
	//Если (СтатусыЭтаповПроизводства = Неопределено) Тогда
	//	врЗапрос1.Текст												= СтрЗаменить(врЗапрос1.Текст, "И ЭтапПроизводства2_2.Статус В(&СтатусыЭтаповПроизводства)", "");
	//КонецЕсли;
	//Результат1														= врЗапрос1.Выполнить();
	//
	//Если НЕ (Результат1.Пустой()) Тогда 	
	//	врТЗ1															= Результат1.Выгрузить(); 
	//	Если НЕ (Результат.Пустой()) Тогда	
	//		ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(врТЗ1, врТЗ);
	//		Иначе Возврат врТЗ1;
	//	КонецЕсли;	
	//КонецЕсли;
	//  
	//Если ((Результат.Пустой()) И (Результат1.Пустой())) Тогда Возврат Неопределено; КонецЕсли;
		
	Возврат врТЗ;
КонецФункции
&НаСервере
Функция   ЭтапыПроизводства_НайтиПоПодразделению(ПодразделениеИсполнитель, СтатусыЭтаповПроизводства = Неопределено)
	врЗапрос														= Новый Запрос("ВЫБРАТЬ
	        														               |	ЭтапПроизводства2_2.Статус КАК Статус,
	        														               |	ЭтапПроизводства2_2.Номер КАК Номер,
	        														               |	ЭтапПроизводства2_2.Подразделение КАК ПодразделениеИсполнитель,
	        														               |	ЭтапПроизводства2_2.Спецификация КАК Спецификация,
	        														               |	ЭтапПроизводства2_2.Спецификация.ОсновноеИзделиеНоменклатура КАК ОсновноеИзделиеНоменклатура,
	        														               |	ЭтапПроизводства2_2.Ссылка КАК Ссылка,
	        														               |	ЭтапПроизводства2_2.Дата КАК Дата
	        														               |ПОМЕСТИТЬ ВыборкаПредварительно
	        														               |ИЗ
	        														               |	Документ.ЭтапПроизводства2_2 КАК ЭтапПроизводства2_2
	        														               |ГДЕ
	        														               |	ЭтапПроизводства2_2.Подразделение = &ПодразделениеИсполнитель																				   
	        														               |;
	        														               |
	        														               |////////////////////////////////////////////////////////////////////////////////
	        														               |ВЫБРАТЬ
	        														               |	ВыборкаПредварительно.Статус КАК Статус,
	        														               |	ВыборкаПредварительно.Номер КАК Номер,
	        														               |	ВыборкаПредварительно.ПодразделениеИсполнитель КАК ПодразделениеИсполнитель,
	        														               |	ВыборкаПредварительно.Спецификация КАК Спецификация,
	        														               |	ВыборкаПредварительно.ОсновноеИзделиеНоменклатура КАК ОсновноеИзделие,
	        														               |	ВыборкаПредварительно.Ссылка КАК Ссылка,
	        														               |	ВыборкаПредварительно.Дата КАК Дата,
	        														               |	ВыборкаПредварительно.Ссылка.Распоряжение КАК ЗаказНаПроизводство,
	        														               |	ВыборкаПредварительно.Ссылка КАК ОсновнойЭтапПроизводства
	        														               |ПОМЕСТИТЬ РезультатПодготовленный
	        														               |ИЗ
	        														               |	ВыборкаПредварительно КАК ВыборкаПредварительно
	        														               |ГДЕ
	        														               |	ИСТИНА
	        														               |	И ВыборкаПредварительно.Статус В(&СтатусыЭтаповПроизводства)
	        														               |	И НЕ ВыборкаПредварительно.Ссылка ЕСТЬ NULL
	        														               |	И НЕ ВыборкаПредварительно.Ссылка.ПометкаУдаления
	        														               |;
	        														               |
	        														               |////////////////////////////////////////////////////////////////////////////////
	        														               |ВЫБРАТЬ
	        														               |	РезультатПодготовленный.Статус КАК Статус,
	        														               |	РезультатПодготовленный.Номер КАК Номер,
	        														               |	РезультатПодготовленный.ПодразделениеИсполнитель КАК ПодразделениеИсполнитель,
	        														               |	РезультатПодготовленный.Спецификация КАК Спецификация,
	        														               |	РезультатПодготовленный.ОсновноеИзделие КАК ОсновноеИзделие,
	        														               |	РезультатПодготовленный.Ссылка КАК Ссылка,
	        														               |	РезультатПодготовленный.Дата КАК Дата,
	        														               |	РезультатПодготовленный.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	        														               |	РезультатПодготовленный.ОсновнойЭтапПроизводства КАК ОсновнойЭтапПроизводства,
	        														               |	ЕСТЬNULL(ЭтапПроизводстваПоследователи.НомерСтроки, 0) КАК КоличествоПоследователей
	        														               |ПОМЕСТИТЬ ВыборкаСУчетомКоличестваПоследователей
	        														               |ИЗ
	        														               |	РезультатПодготовленный КАК РезультатПодготовленный
	        														               |		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	        														               |			ЭтапПроизводстваПоследователи.Ссылка КАК Ссылка,
	        														               |			МАКСИМУМ(ЭтапПроизводстваПоследователи.НомерСтроки) КАК НомерСтроки
	        														               |		ИЗ
	        														               |			Документ.ЭтапПроизводства2_2.Последователи КАК ЭтапПроизводстваПоследователи
	        														               |		
	        														               |		СГРУППИРОВАТЬ ПО
	        														               |			ЭтапПроизводстваПоследователи.Ссылка) КАК ЭтапПроизводстваПоследователи
	        														               |		ПО РезультатПодготовленный.Ссылка = ЭтапПроизводстваПоследователи.Ссылка
	        														               |;
	        														               |
	        														               |////////////////////////////////////////////////////////////////////////////////
	        														               |ВЫБРАТЬ
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Статус КАК Статус,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Номер КАК Номер,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.ПодразделениеИсполнитель КАК ПодразделениеИсполнитель,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Спецификация КАК Спецификация,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.ОсновноеИзделие КАК ОсновноеИзделие,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Ссылка КАК Ссылка,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.Дата КАК Дата,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.ОсновнойЭтапПроизводства КАК ОсновнойЭтапПроизводства,
	        														               |	ВыборкаСУчетомКоличестваПоследователей.КоличествоПоследователей КАК КоличествоПоследователей
	        														               |ИЗ
	        														               |	ВыборкаСУчетомКоличестваПоследователей КАК ВыборкаСУчетомКоличестваПоследователей
	        														               |ГДЕ
	        														               |	ВыборкаСУчетомКоличестваПоследователей.КоличествоПоследователей >= 0
	        														               |
	        														               |УПОРЯДОЧИТЬ ПО
	        														               |	Дата ВОЗР");
	врЗапрос.УстановитьПараметр("ПодразделениеИсполнитель",		ПодразделениеИсполнитель);
	врЗапрос.УстановитьПараметр("СтатусыЭтаповПроизводства",		СтатусыЭтаповПроизводства);	
	Если (СтатусыЭтаповПроизводства = Неопределено) Тогда
		врЗапрос.Текст												= СтрЗаменить(врЗапрос.Текст, "И ВыборкаПредварительно.Статус В(&СтатусыЭтаповПроизводства)", "");
	КонецЕсли;
	Результат														= врЗапрос.Выполнить();
	Если (Результат.Пустой()) Тогда Возврат Неопределено; КонецЕсли;
	
	врТЗ															= Результат.Выгрузить();
	
	Возврат врТЗ;
КонецФункции
&НаСервере
Функция   ЭтапыПроизводства_НайтиПредшествующие(ЭтапПроизводства, Статус = Неопределено, врНоменклатура = Неопределено)
	врЗапрос														= Новый Запрос("ВЫБРАТЬ
	        														               |	ТЧПоследователи.Ссылка КАК Этап,
	        														               |	ТЧПоследователи.Этап КАК СледующийЭтап
	        														               |ПОМЕСТИТЬ ВТСвязиЭтапов
	        														               |ИЗ
	        														               |	Документ.ЭтапПроизводства2_2.Последователи КАК ТЧПоследователи
	        														               |ГДЕ
	        														               |	ТЧПоследователи.Этап = &ЭтапПроизводства
	        														               |	И ТЧПоследователи.Ссылка.Проведен
	        														               |	И НЕ ТЧПоследователи.Ссылка.Статус = &Статус
																				   |	И НЕ ТЧПоследователи.Ссылка.ПроизводствоНаСтороне2_5 = ИСТИНА
																				   |	И НЕ ТЧПоследователи.Ссылка.ПроизводствоНаСтороне = ИСТИНА
	        														               |;
	        														               |
	        														               |////////////////////////////////////////////////////////////////////////////////
	        														               |ВЫБРАТЬ
	        														               |	ВТСвязиЭтапов.СледующийЭтап КАК Ссылка,
	        														               |	ВТСвязиЭтапов.Этап КАК СсылкаПредшествующий,
	        														               |	ВТСвязиЭтапов.Этап.Статус КАК Статус,
	        														               |	ВТСвязиЭтапов.Этап.Номер КАК Номер,
	        														               |	ВТСвязиЭтапов.Этап.Дата КАК Дата,
	        														               |	ВТСвязиЭтапов.Этап.Подразделение КАК ПодразделениеИсполнитель,
	        														               |	ВТСвязиЭтапов.Этап.Спецификация КАК Спецификация,
	        														               |	ВТСвязиЭтапов.Этап.Распоряжение КАК ЗаказНаПроизводство,
	        														               |	ПартииПроизводства.ОсновноеИзделиеНоменклатура КАК ИзделиеПолуфабрикат
	        														               |ПОМЕСТИТЬ ВыборкаПредварительная
	        														               |ИЗ
	        														               |	ВТСвязиЭтапов КАК ВТСвязиЭтапов
	        														               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК ПартииПроизводства
	        														               |		ПО ВТСвязиЭтапов.Этап.ПартияПроизводства = ПартииПроизводства.Ссылка
	        														               |;
	        														               |
	        														               |////////////////////////////////////////////////////////////////////////////////
	        														               |ВЫБРАТЬ РАЗЛИЧНЫЕ
	        														               |	ВыборкаПредварительная.Ссылка КАК Ссылка,
	        														               |	ВыборкаПредварительная.СсылкаПредшествующий КАК СсылкаПредшествующий,
	        														               |	ВыборкаПредварительная.Статус КАК Статус,
	        														               |	ВыборкаПредварительная.Номер КАК Номер,
	        														               |	ВыборкаПредварительная.Дата КАК Дата,
	        														               |	ВыборкаПредварительная.ПодразделениеИсполнитель КАК ПодразделениеИсполнитель,
	        														               |	ВыборкаПредварительная.Спецификация КАК Спецификация,
	        														               |	ВыборкаПредварительная.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	        														               |	ВыборкаПредварительная.ИзделиеПолуфабрикат КАК ИзделиеПолуфабрикат
	        														               |ИЗ
	        														               |	ВыборкаПредварительная КАК ВыборкаПредварительная
	        														               |ГДЕ
	        														               |	ИСТИНА
	        														               |	И ВыборкаПредварительная.ИзделиеПолуфабрикат = &Номенклатура
	        														               |	И НЕ ВыборкаПредварительная.Ссылка.ПометкаУдаления
	        														               |	И НЕ ВыборкаПредварительная.СсылкаПредшествующий.ПометкаУдаления");
	врЗапрос.УстановитьПараметр("ЭтапПроизводства",					ЭтапПроизводства);
	врЗапрос.УстановитьПараметр("Статус",							Статус);
	врЗапрос.УстановитьПараметр("Номенклатура",						врНоменклатура);
	Если (Статус = Неопределено) Тогда
		врЗапрос.Текст												= СтрЗаменить(врЗапрос.Текст, "И НЕ ТЧПоследователи.Ссылка.Статус = &Статус", "");
	КонецЕсли;
	Если (врНоменклатура = Неопределено) Тогда
		врЗапрос.Текст												= СтрЗаменить(врЗапрос.Текст, "И ВыборкаПредварительная.ИзделиеПолуфабрикат = &Номенклатура", "");
	КонецЕсли;
	Результат														= врЗапрос.Выполнить();  
	//Выборка = Результат.Выбрать();
	Если (Результат.Пустой()) Тогда Возврат Неопределено; КонецЕсли;
	//Пока Выборка.Следующий() Цикл
	//	Номер = Выборка.Номер;
	//	Спецификация = Выборка.Спецификация;
	//КонецЦикла;
	врТЗ															= Результат.Выгрузить();
	
	Возврат врТЗ;
КонецФункции
&НаСервере
Функция   ЭтапыПроизводства_ОсновноеИзделиеЭтапа(ЭтапПроизводства)
	врЗапрос														= Новый Запрос("ВЫБРАТЬ
	        														               |	ЭтапПроизводства2_2.Ссылка КАК Ссылка,
	        														               |	ЭтапПроизводства2_2.Подразделение КАК Подразделение,
	        														               |	ЭтапПроизводства2_2.ПартияПроизводства КАК ПартияПроизводства
	        														               |ПОМЕСТИТЬ ЭтапыПроизводства
	        														               |ИЗ
	        														               |	Документ.ЭтапПроизводства2_2 КАК ЭтапПроизводства2_2
	        														               |ГДЕ
	        														               |	ЭтапПроизводства2_2.Ссылка = &ЭтапПроизводства
	        														               |;
	        														               |
	        														               |////////////////////////////////////////////////////////////////////////////////
	        														               |ВЫБРАТЬ
	        														               |	ЭтапыПроизводства.Ссылка КАК Ссылка,
	        														               |	ЭтапыПроизводства.Подразделение КАК Подразделение,
	        														               |	ЭтапыПроизводства.ПартияПроизводства КАК ПартияПроизводства,
	        														               |	ПартииПроизводства.ОсновноеИзделиеНоменклатура КАК ОсновноеИзделие
	        														               |ИЗ
	        														               |	ЭтапыПроизводства КАК ЭтапыПроизводства
	        														               |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК ПартииПроизводства
	        														               |		ПО ЭтапыПроизводства.ПартияПроизводства = ПартииПроизводства.Ссылка");
	врЗапрос.УстановитьПараметр("ЭтапПроизводства",					ЭтапПроизводства);
	Результат														= врЗапрос.Выполнить();
	Если (Результат.Пустой()) Тогда Возврат Неопределено; КонецЕсли;
	
	врТЗ															= Результат.Выгрузить();
	
	Возврат врТЗ[0];
КонецФункции
&НаСервере
Функция   РаботаЭтап_ПолучитьДанныеВыпуска()
	СтруктураВозврата												= Новый Структура;
	СтруктураВозврата.Вставить("Запланировано",						ОбработкаЭтапа_РедактируемыйЭтапПроизводства.КоличествоУпаковокПлан);
	СтруктураВозврата.Вставить("Недодел",							ОбработкаЭтапа_РедактируемыйЭтапПроизводства.КоличествоУпаковокПлан - ОбработкаЭтапа_РедактируемыйЭтапПроизводства.КоличествоУпаковокФакт - ОбработкаЭтапа_РедактируемыйЭтапПроизводства.КоличествоУпаковокОтменено);
	
	Возврат СтруктураВозврата;
КонецФункции
&НаСервере
Процедура ПолучитьСтруктуруДокументовДляЗаписиРекурсивно(СтруктураДокументовДляЗаписи, врШаблонТЗ, врШаблонТЗВыпуска, СтрокиДерева, Знач врОсновноеИзделие = Неопределено, Знач врОсновноеИзделиеКоличествоУпаковок = Неопределено, ТЗВыпускаВышестоящегоЭтапа = Неопределено)
	КоличествоСтрокДерева = СтрокиДерева.Количество();
	Если (СтрокиДерева.Количество() > 0) Тогда
		СтрукутраТекущегоДокумента									= ПолучитьЭлементСтруктурыДокументовДляЗаписи(СтруктураДокументовДляЗаписи, врШаблонТЗ, врШаблонТЗВыпуска, СтрокиДерева[0].Ссылка, ТЗВыпускаВышестоящегоЭтапа);
	врТЗ															= СтрукутраТекущегоДокумента.Значение.ТЗМатериалы;	
	КонецЕсли;
	//врТЗ															= СтрукутраТекущегоДокумента.Значение.ТЗМатериалы;
	Для Каждого врСтрокаД Из СтрокиДерева Цикл
		Если (врСтрокаД.КоличествоУпаковокФактически <= 0) Тогда Продолжить; КонецЕсли;   
		
		нСтр														= врТЗ.Добавить();
		нСтр.Номенклатура											= врСтрокаД.Номенклатура;
		нСтр.Упаковка												= врСтрокаД.Упаковка;
		нСтр.НоменклатураИсходная									= врСтрокаД.НоменклатураИсходная;
		// Количество берём из дерева - оно уже рассчитано с учётом недостающего количества полуфабрикатов
		нСтр.КоличествоУпаковок										= врСтрокаД.КоличествоУпаковокФактически;
		нСтр.ОсновноеИзделие										= врОсновноеИзделие;
		нСтр.ОсновноеИзделиеКоличествоУпаковок						= врОсновноеИзделиеКоличествоУпаковок;
		//fix: 10.02.2026 — Назначение берём из строки дерева (определено из ТЧ ОбеспечениеМатериаламиИРаботами),
		//  а не из шапки документа этапа. У каждого материала своё назначение: обособленные — назначение этапа,
		//  необособленные — пустое. Ранее подставлялось назначение изделия из шапки, что было некорректно.
		нСтр.Назначение	= врСтрокаД.Назначение;
		нСтр.Характеристика	= врСтрокаД.Характеристика;
		Если НЕ(нСтр.Номенклатура.ЕдиницаИзмерения = нСтр.Упаковка) Тогда
				//Надо пересчиатть количество, но с некторыми особенностями
				Если (нСтр.Упаковка = нСтр.Номенклатура.ВесЕдиницаИзмерения) Тогда
						//Это вес, настройки указаны в самой номенклатуре
						нСтр.Количество								= нСтр.КоличествоУпаковок * нСтр.Номенклатура.ВесЗнаменатель / нСтр.Номенклатура.ВесЧислитель;
					ИначеЕсли (нСтр.Упаковка = нСтр.Номенклатура.ДлинаЕдиницаИзмерения) Тогда
						//Это длинна
						нСтр.Количество								= нСтр.КоличествоУпаковок * нСтр.Номенклатура.ДлинаЗнаменатель / нСтр.Номенклатура.ДлинаЧислитель;
					ИначеЕсли (нСтр.Упаковка = нСтр.Номенклатура.ОбъемЕдиницаИзмерения) Тогда
						//Это объем
						нСтр.Количество								= нСтр.КоличествоУпаковок * нСтр.Номенклатура.ОбъемЗнаменатель / нСтр.Номенклатура.ОбъемЧислитель;
					ИначеЕсли (нСтр.Упаковка = нСтр.Номенклатура.ПлощадьЕдиницаИзмерения) Тогда
						//Это площадь
						нСтр.Количество								= нСтр.КоличествоУпаковок * нСтр.Номенклатура.ПлощадьЗнаменатель / нСтр.Номенклатура.ПлощадьЧислитель;
					Иначе
						//Просто пересчитаем
						нСтр.Количество								= нСтр.КоличествоУпаковок * нСтр.Номенклатура.ЕдиницаИзмерения.Знаменатель / нСтр.Номенклатура.ЕдиницаИзмерения.Числитель;
				КонецЕсли;
			Иначе
				нСтр.Количество										= нСтр.КоличествоУпаковок;
		КонецЕсли;
		Если НЕ(врСтрокаД.ПолучитьЭлементы().Количество() = 0) Тогда
			//"ОбработкаЭтапа_Рапределено" это для конечного этапа, но для предшествующих переделов могут указать в дереве материалов
			врОсновноеИзделие										= врСтрокаД.Номенклатура;
			врОсновноеИзделиеКоличествоУпаковок						= врСтрокаД.КоличествоУпаковокФактически;
			//Формируем тут, но передаем как параметр для заполнения там
			врТЗВ													= врШаблонТЗВыпуска.Скопировать();
			нСтрВ													= врТЗВ.Добавить();
			нСтрВ.Номенклатура										= врСтрокаД.Номенклатура;
			// Для выпуска используем недостающее количество (если полуфабрикат производится и частично есть в наличии)
			Если (врСтрокаД.ПроизводитсяВПроцессе) И (врСтрокаД.КоличествоУпаковокВНаличии > 0) Тогда
				нСтрВ.КоличествоУпаковок							= Макс(0, врСтрокаД.КоличествоУпаковокФактически - врСтрокаД.КоличествоУпаковокВНаличии);
			Иначе
				нСтрВ.КоличествоУпаковок							= врСтрокаД.КоличествоУпаковокФактически;
			КонецЕсли;
			нСтрВ.Подразделение										= врСтрокаД.Ссылка.Подразделение;
			нСтрВ.Назначение										= НазначениеПоЭтапуИНаправленюДеятельности(врСтрокаД.Ссылка, врСтрокаД.Ссылка.НаправлениеДеятельности);
			нСтрВ.ЭтапПроизводства									= врСтрокаД.Ссылка;
			// Материалы вложенных этапов уже рассчитаны в дереве с учётом недостающего количества
			ПолучитьСтруктуруДокументовДляЗаписиРекурсивно(СтруктураДокументовДляЗаписи, врШаблонТЗ, врШаблонТЗВыпуска, врСтрокаД.ПолучитьЭлементы(), врСтрокаД.Номенклатура, врСтрокаД.КоличествоУпаковокФактически, врТЗВ);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
//&НаСервере
//Функция   ОтсортироватьПорядокДокументов(Знач СтруктураДокументовДляЗаписи)
//	//Сначала выгрузим порядок в список значений
//	ПорядокДокументов												= Новый СписокЗначений;
//	Для Каждого врСтруктура Из СтруктураДокументовДляЗаписи Цикл
//		ПорядокДокументов.Добавить(врСтруктура.Значение.НомерПартииЗапуска);
//	КонецЦикла;
//	ПорядокДокументов.СортироватьПоЗначению(НаправлениеСортировки.Возр);
//	
//	НоваяСтруктураДокументовДляЗаписи								= Новый Структура;
//	ДокументСчет													= 1;
//	Для Каждого врЗначение Из ПорядокДокументов Цикл
//		Для Каждого врСтруктура Из СтруктураДокументовДляЗаписи Цикл
//			Если (врСтруктура.Значение.НомерПартииЗапуска = врЗначение.Значение) Тогда
//				ДокументСчетТекст												= ?(ДокументСчет < 10, "0" + Строка(ДокументСчет), Строка(ДокументСчет));
//				ДокументСчетТекст												= "Документ" + ДокументСчетТекст;
//				СтруктураДокументаДляЗаписи										= Новый Структура;
//				СтруктураДокументаДляЗаписи.Вставить("НомерПартииЗапуска",		врСтруктура.Значение.НомерПартииЗапуска);
//				СтруктураДокументаДляЗаписи.Вставить("ЭтапПроизводства",		врСтруктура.Значение.ЭтапПроизводства);
//				СтруктураДокументаДляЗаписи.Вставить("ТЗМатериалы",				врСтруктура.Значение.ТЗМатериалы);
//				СтруктураДокументаДляЗаписи.Вставить("ТЗВыпуска",				врСтруктура.Значение.ТЗВыпуска);
//				НоваяСтруктураДокументовДляЗаписи.Вставить(ДокументСчетТекст,	СтруктураДокументаДляЗаписи);
//				ДокументСчет													= ДокументСчет + 1;
//			КонецЕсли;
//		КонецЦикла;
//	КонецЦикла;
//	
//	Возврат НоваяСтруктураДокументовДляЗаписи;
//КонецФункции 
&НаСервере
Функция ОтсортироватьПорядокДокументов(Знач СтруктураДокументовДляЗаписи)
    //fix: 13.02.2026 — Топологическая сортировка: производители ПЕРЕД потребителями.
    //  Номера партий НЕ отражают реальные зависимости, поэтому сортировка по партии не работает.
    //  Строим граф зависимостей и сортируем топологически.
    
    // 1. Собираем все документы в таблицу
    Таб = Новый ТаблицаЗначений;
    Таб.Колонки.Добавить("ЭтапПроизводства");
    Таб.Колонки.Добавить("НомерПартииЗапуска");
    Таб.Колонки.Добавить("ТЗМатериалы");
    Таб.Колонки.Добавить("ТЗВыпуска");
    Таб.Колонки.Добавить("УровеньЗависимости", Новый ОписаниеТипов("Число"));

    Для Каждого Элемент Из СтруктураДокументовДляЗаписи Цикл
        НоваяСтрока = Таб.Добавить();
        НоваяСтрока.ЭтапПроизводства     = Элемент.Значение.ЭтапПроизводства;
        НоваяСтрока.НомерПартииЗапуска   = Элемент.Значение.НомерПартииЗапуска;
        НоваяСтрока.ТЗМатериалы          = Элемент.Значение.ТЗМатериалы;
        НоваяСтрока.ТЗВыпуска            = Элемент.Значение.ТЗВыпуска;
        НоваяСтрока.УровеньЗависимости   = 0;
    КонецЦикла;

    // 2. Группируем - убираем дубликаты
    Таб.Свернуть("ЭтапПроизводства,НомерПартииЗапуска,ТЗМатериалы,ТЗВыпуска,УровеньЗависимости", "");

    // 3. Строим соответствие для быстрого поиска: ЭтапПроизводства → индекс строки
    ИндексЭтапов = Новый Соответствие;
    Для Инд = 0 По Таб.Количество() - 1 Цикл
        ИндексЭтапов.Вставить(Таб[Инд].ЭтапПроизводства, Инд);
    КонецЦикла;

    // 4. Для каждого документа определяем уровень зависимости (глубина в графе)
    //    Документ-производитель должен иметь МЕНЬШИЙ уровень, чем потребитель.
    Изменилось = Истина;
    Итерация = 0;
    Пока Изменилось И Итерация < 100 Цикл // защита от бесконечного цикла
        Изменилось = Ложь;
        Итерация = Итерация + 1;
        
        Для Каждого СтрПотребитель Из Таб Цикл
            //Для каждого материала из ТЗМатериалы находим производителя
            Если СтрПотребитель.ТЗМатериалы = Неопределено Тогда Продолжить; КонецЕсли;
            
            Для Каждого СтрМатериал Из СтрПотребитель.ТЗМатериалы Цикл
                //Ищем этап, который ПРОИЗВОДИТ эту номенклатуру (в его ТЗВыпуска)
                Для Каждого СтрПроизводитель Из Таб Цикл
                    Если СтрПроизводитель.ЭтапПроизводства = СтрПотребитель.ЭтапПроизводства Тогда Продолжить; КонецЕсли;
                    Если СтрПроизводитель.ТЗВыпуска = Неопределено Тогда Продолжить; КонецЕсли;
                    
                    Для Каждого СтрВыпуск Из СтрПроизводитель.ТЗВыпуска Цикл
                        Если СтрВыпуск.Номенклатура = СтрМатериал.Номенклатура Тогда
                            //Нашли связь: СтрПроизводитель → СтрПотребитель
                            //Уровень потребителя должен быть > уровня производителя
                            НовыйУровень = СтрПроизводитель.УровеньЗависимости + 1;
                            Если НовыйУровень > СтрПотребитель.УровеньЗависимости Тогда
                                СтрПотребитель.УровеньЗависимости = НовыйУровень;
                                Изменилось = Истина;
                            КонецЕсли;
                            Прервать;
                        КонецЕсли;
                    КонецЦикла;
                КонецЦикла;
            КонецЦикла;
        КонецЦикла;
    КонецЦикла;

    // 5. Сортируем по уровню зависимости (производители раньше потребителей)
    Таб.Сортировать("УровеньЗависимости Возр, НомерПартииЗапуска Возр");

    // 6. Переносим в структуру-результат
    НоваяСтруктура = Новый Структура;
    Счет = 1;
    Для Каждого Стр Из Таб Цикл
        ИмяДок = "Документ" + ?(Счет < 10, "0" + Строка(Счет), Строка(Счет));
        НоваяСтруктура.Вставить(ИмяДок, Новый Структура(
            "НомерПартииЗапуска,ЭтапПроизводства,ТЗМатериалы,ТЗВыпуска",
            Стр.НомерПартииЗапуска,
            Стр.ЭтапПроизводства,
            Стр.ТЗМатериалы,
            Стр.ТЗВыпуска
        ));
        Счет = Счет + 1;
    КонецЦикла;

    Возврат НоваяСтруктура;
КонецФункции

&НаСервере
Функция   ПолучитьЭлементСтруктурыДокументовДляЗаписи(СтруктураДокументовДляЗаписи, врШаблонТЗ, врШаблонТЗВыпуска, врСсылка, ТЗВыпускаВышестоящегоЭтапа)
	Для Каждого врСтрока Из СтруктураДокументовДляЗаписи Цикл
		Если (врСтрока.Значение.ЭтапПроизводства = врСсылка) Тогда
			Если (ТЗВыпускаВышестоящегоЭтапа <> Неопределено) Тогда
				врТЗ												= врСтрока.Значение.ТЗВыпуска;
				Для Каждого врСтрокаВ Из ТЗВыпускаВышестоящегоЭтапа Цикл
					нСтр											= врТЗ.Добавить();
					ЗаполнитьЗначенияСвойств(нСтр, врСтрокаВ);
				КонецЦикла;
			КонецЕсли;
			Возврат врСтрока;
		КонецЕсли;
	КонецЦикла;
	ДокументСчет													= СтруктураДокументовДляЗаписи.Количество() + 1;
	ДокументСчетТекст												= ?(ДокументСчет < 10, "0" + Строка(ДокументСчет), Строка(ДокументСчет));
	ДокументСчетТекст												= "Документ" + ДокументСчетТекст;
	СтруктураДокументаДляЗаписи										= Новый Структура;
	СтруктураДокументаДляЗаписи.Вставить("НомерПартииЗапуска",		врСсылка.НомерПартииЗапуска);
	СтруктураДокументаДляЗаписи.Вставить("ЭтапПроизводства",		врСсылка);
	СтруктураДокументаДляЗаписи.Вставить("ТЗМатериалы",				врШаблонТЗ.Скопировать()); 
	СтруктураДокументаДляЗаписи.Вставить("ТЗВыпуска",				врШаблонТЗВыпуска.Скопировать());
	Если НЕ(ТЗВыпускаВышестоящегоЭтапа = Неопределено) Тогда
		врТЗ														= СтруктураДокументаДляЗаписи.ТЗВыпуска;
		Для Каждого врСтрокаВ Из ТЗВыпускаВышестоящегоЭтапа Цикл
			нСтр													= врТЗ.Добавить();
			ЗаполнитьЗначенияСвойств(нСтр, врСтрокаВ);
		КонецЦикла;
	КонецЕсли;
	СтруктураДокументовДляЗаписи.Вставить(ДокументСчетТекст,		СтруктураДокументаДляЗаписи);

	Для Каждого врСтрока Из СтруктураДокументовДляЗаписи Цикл
		Если (врСтрока.Значение.ЭтапПроизводства = врСсылка) Тогда
			Возврат врСтрока;
		КонецЕсли;
	КонецЦикла; 
	//Возврат Документы.ЭтапПроизводства2_2.ПустаяСсылка();
КонецФункции
&НаСервере
Функция   ПолучитьДанныеНоменклатурыДляЗаполнения(врОснование, врТЗМатериалов)
	УстановитьПривилегированныйРежим(Истина);
	
	//ТЗМатериаловПоЭтапу												= ДанныеСпецификацииПоНоменклатуре(врОснование, врТЗМатериалов);
	ТЗМатериалыПоЭтапу												= ДанныеТЗМатериаловПоНоменклатуре(врОснование, врТЗМатериалов);
	
	ВозвращаемыйМассив												= Новый Массив;

	Для Каждого врСтрока Из врТЗМатериалов Цикл
	//Отбор = Новый Структура(
	//  "Номенклатура,Назначение",
	//  врСтрока.Номенклатура,
	//  врСтрока.Назначение
	//); 
    Отбор = Новый Структура(
      "Номенклатура",
      врСтрока.Номенклатура
    );	
    НайденныеСтроки = ТЗМатериалыПоЭтапу.НайтиСтроки(Отбор); 
	//СтруктураНоменклатуры										= Новый Структура;	
	Если НайденныеСтроки.Количество() > 0 Тогда       
		СтруктураНоменклатуры = Новый Структура;
        НайденныеДанныеНоменклатуры = НайденныеСтроки[0];  
		СтруктураНоменклатуры.Вставить("Номенклатура",				врСтрока.Номенклатура);
		СтруктураНоменклатуры.Вставить("Упаковка",					врСтрока.Упаковка);
		СтруктураНоменклатуры.Вставить("КоличествоУпаковок",		врСтрока.КоличествоУпаковок);
		СтруктураНоменклатуры.Вставить("Количество",				врСтрока.Количество);
		СтруктураНоменклатуры.Вставить("ВариантОбеспечения",		Перечисления.ВариантыОбеспечения.Отгрузить);
		СтруктураНоменклатуры.Вставить("ДатаОтгрузки",				Объект.РабочаяДата);
		
		СтруктураНоменклатуры.Вставить("Склад",						НайденныеДанныеНоменклатуры.Склад);
        СтруктураНоменклатуры.Вставить("Производится",				НайденныеДанныеНоменклатуры.ПроизводитсяВПроцессе);
		СтруктураНоменклатуры.Вставить("Спецификация",				НайденныеДанныеНоменклатуры.Спецификация);
		СтруктураНоменклатуры.Вставить("Назначение",				НайденныеДанныеНоменклатуры.Назначение);
		СтруктураНоменклатуры.Вставить("НазначениеОбеспечения",		НайденныеДанныеНоменклатуры.НазначениеОбеспечения);
		СтруктураНоменклатуры.Вставить("ПрименениеМатериала",		НайденныеДанныеНоменклатуры.ПрименениеМатериала);
		СтруктураНоменклатуры.Вставить("СтатьяКалькуляции",			НайденныеДанныеНоменклатуры.СтатьяКалькуляции);
		СтруктураНоменклатуры.Вставить("Обособленно",				НайденныеДанныеНоменклатуры.Обособленно);
		СтруктураНоменклатуры.Вставить("Характеристика",				НайденныеДанныеНоменклатуры.Характеристика);
		
		СтруктураНоменклатуры.Вставить("Подразделение",				врОснование.Подразделение);
		СтруктураНоменклатуры.Вставить("ИдентификаторСтроки",		Новый УникальныйИдентификатор());
		СтруктураНоменклатуры.Вставить("ДатаРасхода",				Объект.РабочаяДата);
		
		ВозвращаемыйМассив.Добавить(СтруктураНоменклатуры);
	КонецЕсли;	     
	
		//НайденныеДанныеНоменклатуры									= ДанныеСпецификации.Найти(врСтрока.Номенклатура, "Номенклатура");
		
		//СтруктураНоменклатуры.Вставить("Номенклатура",				врСтрока.Номенклатура);
		//СтруктураНоменклатуры.Вставить("Упаковка",					врСтрока.Упаковка);
		//СтруктураНоменклатуры.Вставить("КоличествоУпаковок",		врСтрока.КоличествоУпаковок);
		//СтруктураНоменклатуры.Вставить("Количество",				врСтрока.Количество);
		//СтруктураНоменклатуры.Вставить("ВариантОбеспечения",		Перечисления.ВариантыОбеспечения.Отгрузить);
		//СтруктураНоменклатуры.Вставить("ДатаОтгрузки",				Объект.РабочаяДата);
		////СтруктураНоменклатуры.Вставить("Склад",						НайденныеДанныеНоменклатуры.Склад);
		////СтруктураНоменклатуры.Вставить("Производится",				НайденныеДанныеНоменклатуры.ПроизводитсяВПроцессе);
		////СтруктураНоменклатуры.Вставить("Спецификация",				НайденныеДанныеНоменклатуры.Спецификация);
		////СтруктураНоменклатуры.Вставить("Назначение",				НайденныеДанныеНоменклатуры.Назначение);
		////СтруктураНоменклатуры.Вставить("НазначениеОбеспечения",		НайденныеДанныеНоменклатуры.НазначениеОбеспечения);
		////СтруктураНоменклатуры.Вставить("ПрименениеМатериала",		НайденныеДанныеНоменклатуры.ПрименениеМатериала);
		////СтруктураНоменклатуры.Вставить("СтатьяКалькуляции",			НайденныеДанныеНоменклатуры.СтатьяКалькуляции);
		////СтруктураНоменклатуры.Вставить("Обособленно",				НайденныеДанныеНоменклатуры.Обособленно);
		//СтруктураНоменклатуры.Вставить("Подразделение",				врОснование.Подразделение);
		//СтруктураНоменклатуры.Вставить("ИдентификаторСтроки",		Новый УникальныйИдентификатор());
		//СтруктураНоменклатуры.Вставить("ДатаРасхода",				Объект.РабочаяДата);
		
		//ВозвращаемыйМассив.Добавить(СтруктураНоменклатуры);
	КонецЦикла;	
	Возврат ВозвращаемыйМассив;
КонецФункции
&НаСервере
Функция   СкладПоПодразделению(врПодразделение, врНоменклатура)
	УстановитьПривилегированныйРежим(Истина);
	
	врЗапрос														= Новый Запрос("ВЫБРАТЬ
	        														               |	СхемыОбеспеченияПроизводства.Склад КАК Ссылка
	        														               |ИЗ
	        														               |	РегистрСведений.СхемыОбеспеченияПроизводства КАК СхемыОбеспеченияПроизводства
	        														               |ГДЕ
	        														               |	СхемыОбеспеченияПроизводства.Подразделение = &Подразделение
	        														               |	И СхемыОбеспеченияПроизводства.СхемаОбеспечения = &СхемаОбеспечения");
	врЗапрос.УстановитьПараметр("Подразделение",					врПодразделение);
	врЗапрос.УстановитьПараметр("СхемаОбеспечения",					врНоменклатура.СхемаОбеспечения);
	Результат														= врЗапрос.Выполнить();
	Если (Результат.Пустой()) Тогда
		Возврат Справочники.Склады.ПустаяСсылка();
	КонецЕсли;
	
	Возврат Результат.Выгрузить()[0].Ссылка;
КонецФункции
&НаСервере
Функция   НазначениеПоЭтапуИНаправленюДеятельности(врЭтапПроизводства, врНаправлениеДеятельности)
	УстановитьПривилегированныйРежим(Истина);
	
	врЗапрос														= Новый Запрос("ВЫБРАТЬ
	        														               |	Назначения.Ссылка КАК Ссылка,
	        														               |	Назначения.Заказ КАК Заказ,
	        														               |	Назначения.НаправлениеДеятельности КАК НаправлениеДеятельности
	        														               |ИЗ
	        														               |	Справочник.Назначения КАК Назначения
	        														               |ГДЕ
	        														               |	Назначения.Заказ = &ЭтапПроизводства
	        														               |	И Назначения.НаправлениеДеятельности = &НаправлениеДеятельности");
	врЗапрос.УстановитьПараметр("ЭтапПроизводства",					врЭтапПроизводства);
	врЗапрос.УстановитьПараметр("НаправлениеДеятельности",			врНаправлениеДеятельности);
	Результат														= врЗапрос.Выполнить();
	Если (Результат.Пустой()) Тогда
		Возврат Справочники.Назначения.ПустаяСсылка();
	КонецЕсли;
	
	Возврат Результат.Выгрузить()[0].Ссылка;
КонецФункции
&НаСервере  
Функция   ДанныеТЗМатериаловПоНоменклатуре(врОснование, врТЗМатериалов)
	УстановитьПривилегированныйРежим(Истина);
	
	врСпецификация													= врОснование.Спецификация;
	ПараметрыЗаполненияНазначений									= ОбеспечениеПроизводства.ПараметрыДействияЗаполнитьНазначениеОбеспеченияВЭтапеПроизводства(врОснование, врОснование.ВыходныеИзделия);
	
	ТЗВозвращаемая													= Новый ТаблицаЗначений;
	ТЗВозвращаемая.Колонки.Добавить("Номенклатура");
	ТЗВозвращаемая.Колонки.Добавить("Упаковка");
	ТЗВозвращаемая.Колонки.Добавить("Артикул");
	ТЗВозвращаемая.Колонки.Добавить("Обособленно");
	ТЗВозвращаемая.Колонки.Добавить("ПрименениеМатериала");
	ТЗВозвращаемая.Колонки.Добавить("ПроизводитсяВПроцессе");
	ТЗВозвращаемая.Колонки.Добавить("СпособПолученияМатериала");
	ТЗВозвращаемая.Колонки.Добавить("СтатьяКалькуляции");
	ТЗВозвращаемая.Колонки.Добавить("Спецификация");
	ТЗВозвращаемая.Колонки.Добавить("Этап");
	ТЗВозвращаемая.Колонки.Добавить("Склад");
	ТЗВозвращаемая.Колонки.Добавить("Назначение");
	ТЗВозвращаемая.Колонки.Добавить("НазначениеОбеспечения");
	ТЗВозвращаемая.Колонки.Добавить("Характеристика");
	
	ОбеспечениеМатериаламиИРаботами												= врОснование.ОбеспечениеМатериаламиИРаботами.Выгрузить(); 
	
	СтатьяКалькуляцииПокупныеМатериалы = Справочники.СтатьиКалькуляции.НайтиПоРеквизиту("ИдентификаторДляФормул","ПокупныеМатериалы");
	
	Для Каждого врСтрокаМ Из врТЗМатериалов Цикл
		НайденнаяСтрокаЭтапа									= ОбеспечениеМатериаламиИРаботами.Найти(врСтрокаМ.Номенклатура, "Номенклатура");
		Если НЕ(НайденнаяСтрокаЭтапа = Неопределено) Тогда
			нСтр													= ТЗВозвращаемая.Добавить();
			ЗаполнитьЗначенияСвойств(нСтр, НайденнаяСтрокаЭтапа);
			нСтр.Упаковка											= врСтрокаМ.Номенклатура.ЕдиницаИзмерения;
			Если нСтр.Склад = Неопределено Тогда
				нСтр.Склад												= СкладПоПодразделению(врОснование.Подразделение, врСтрокаМ.Номенклатура); 
			КонецЕсли;
			       
			
			Если (НайденнаяСтрокаЭтапа.Производится) Тогда
				нСтр.Обособленно								= Истина;
				нСтр.ПроизводитсяВПроцессе						= Истина; 
				ДанныеОбИзделии										= Новый Структура;
				ДанныеОбИзделии.Вставить("НаправлениеДеятельности",	врОснование.НаправлениеДеятельности);
				ДанныеОбИзделии.Вставить("НачалоПроизводства",		врОснование.Распоряжение.НачатьНеРанее);
				ДанныеОбИзделии.Вставить("Номенклатура",			врСтрокаМ.Номенклатура);
				ДанныеОбИзделии.Вставить("ПодразделениеДиспетчер",	врОснование.Подразделение);
				ДанныеОбИзделии.Вставить("ТекущаяСпецификация",		Справочники.РесурсныеСпецификации.ПустаяСсылка());
				ДанныеОбИзделии.Вставить("Характеристика",			Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
				ПараметрыВыбораСпецификаций							= УправлениеДаннымиОбИзделиях.ПараметрыВыбораСпецификаций(врОснование, Документы.ЭтапПроизводства2_2);
				СписокСпецификаций									= УправлениеДаннымиОбИзделиях.СпецификацииИзделия(ДанныеОбИзделии, ПараметрыВыбораСпецификаций.ОбеспечениеМатериаламиИРаботами);
				Попытка
					нСтр.Спецификация							= СписокСпецификаций[0].Спецификация;
				Исключение
					нСтр.Спецификация							= Справочники.РесурсныеСпецификации.ПустаяСсылка();
				КонецПопытки;  
			Иначе
				нСтр.Обособленно								= НайденнаяСтрокаЭтапа.Обособленно;
				нСтр.ПроизводитсяВПроцессе						= Ложь;				
			КонецЕсли;
			нСтр.НазначениеОбеспечения								= ?(нСтр.ПроизводитсяВПроцессе, ПараметрыЗаполненияНазначений.НазначениеПолуфабрикаты, ПараметрыЗаполненияНазначений.НазначениеМатериалы);
			нСтр.Назначение											= ?(нСтр.Обособленно, нСтр.НазначениеОбеспечения, Справочники.Назначения.ПустаяСсылка());
			//Если ((НайденнаяСтрокаСпецификации.СпособПолученияМатериала =  Перечисления.СпособыПолученияМатериаловВСпецификации.ПроизвестиПоСпецификации) ИЛИ (нСтр.ПроизводитсяВПроцессе)) Тогда
			//КонецЕсли;
			
			
			
			Продолжить;
		КонецЕсли;
		
		//раскомментировал 20.08.24 нужно для замены номенклатуры материалов
		Если (НайденнаяСтрокаЭтапа = Неопределено) Тогда
			НайденнаяСтрокаЭтапа								= ОбеспечениеМатериаламиИРаботами.Найти(врСтрокаМ.НоменклатураИсходная, "Номенклатура");
			нСтр													= ТЗВозвращаемая.Добавить();
			Если (НайденнаяСтрокаЭтапа <> Неопределено) Тогда
				ЗаполнитьЗначенияСвойств(нСтр, НайденнаяСтрокаЭтапа); 
				нСтр.ПроизводитсяВПроцессе = НайденнаяСтрокаЭтапа.Производится;   //22.08.25
			Иначе	
			    нСтр.ПроизводитсяВПроцессе = Ложь; 
				нСтр.Обособленно = Ложь;  
				нСтр.СтатьяКалькуляции = СтатьяКалькуляцииПокупныеМатериалы;
			КонецЕсли;
			нСтр.Номенклатура										= врСтрокаМ.Номенклатура;
			нСтр.Упаковка											= врСтрокаМ.Номенклатура.ЕдиницаИзмерения;
			нСтр.Артикул											= врСтрокаМ.Номенклатура.Артикул;
			Если нСтр.Склад = Неопределено Тогда
				нСтр.Склад												= СкладПоПодразделению(врОснование.Подразделение, врСтрокаМ.Номенклатура);
			КонецЕсли;
			Если (нСтр.ПроизводитсяВПроцессе) Тогда
				нСтр.Обособленно									= Истина;
			КонецЕсли;
			нСтр.НазначениеОбеспечения								= ?(нСтр.ПроизводитсяВПроцессе, ПараметрыЗаполненияНазначений.НазначениеПолуфабрикаты, ПараметрыЗаполненияНазначений.НазначениеМатериалы);
			нСтр.Назначение											= ?(нСтр.Обособленно, нСтр.НазначениеОбеспечения, Справочники.Назначения.ПустаяСсылка());
			Если НЕ (нСтр.ПроизводитсяВПроцессе) Тогда
				//Бывает что в спецификации не отмечено "Произвести", а на самом деле производтся...
				Если врСтрокаМ.НоменклатураИсходная <> Неопределено Тогда
					ПредшествующиеЭтапы	= ЭтапыПроизводства_НайтиПредшествующие(врОснование.Ссылка, , врСтрокаМ.НоменклатураИсходная);
				КонецЕсли;
				Если НЕ(ПредшествующиеЭтапы = Неопределено) Тогда
					нСтр.ПроизводитсяВПроцессе						= Истина;
					нСтр.Обособленно								= Истина;
					//fix: 06.02.2026 — Пересчёт назначений после обнаружения предшественника.
					//  Когда ОбеспечениеМатериаламиИРаботами пустая, НазначениеОбеспечения и Назначение
					//  вычислялись ДО корректировки ПроизводитсяВПроцессе/Обособленно и оставались пустыми.
					//  Это приводило к формированию расхода без назначения, тогда как на складе
					//  полуфабрикат лежит с назначением этапа → [ОшибкаХранимыхДанных] при проведении.
					нСтр.НазначениеОбеспечения						= ПараметрыЗаполненияНазначений.НазначениеПолуфабрикаты;
					нСтр.Назначение									= нСтр.НазначениеОбеспечения;
				КонецЕсли;
			КонецЕсли; 
			Если (НайденнаяСтрокаЭтапа <> Неопределено) Тогда
				//Если ((НайденнаяСтрокаЭтапа.СпособПолученияМатериала =  Перечисления.СпособыПолученияМатериаловВСпецификации.ПроизвестиПоСпецификации) ИЛИ (нСтр.ПроизводитсяВПроцессе)) Тогда
				Если нСтр.ПроизводитсяВПроцессе Тогда
					ДанныеОбИзделии										= Новый Структура;
					ДанныеОбИзделии.Вставить("НаправлениеДеятельности",	врОснование.НаправлениеДеятельности);
					ДанныеОбИзделии.Вставить("НачалоПроизводства",		врОснование.Распоряжение.НачатьНеРанее);
					ДанныеОбИзделии.Вставить("Номенклатура",			врСтрокаМ.Номенклатура);
					ДанныеОбИзделии.Вставить("ПодразделениеДиспетчер",	врОснование.Подразделение);
					ДанныеОбИзделии.Вставить("ТекущаяСпецификация",		Справочники.РесурсныеСпецификации.ПустаяСсылка());
					ДанныеОбИзделии.Вставить("Характеристика",			Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
					ПараметрыВыбораСпецификаций							= УправлениеДаннымиОбИзделиях.ПараметрыВыбораСпецификаций(врОснование, Документы.ЭтапПроизводства2_2);
					СписокСпецификаций									= УправлениеДаннымиОбИзделиях.СпецификацииИзделия(ДанныеОбИзделии, ПараметрыВыбораСпецификаций.ОбеспечениеМатериаламиИРаботами);
					Попытка
						нСтр.Спецификация							= СписокСпецификаций[0].Спецификация;
					Исключение
						нСтр.Спецификация							= Справочники.РесурсныеСпецификации.ПустаяСсылка();
					КонецПопытки;
				КонецЕсли;
			КонецЕсли;
			Продолжить;
		КонецЕсли;
		//
	КонецЦикла;
	
		
	Возврат ТЗВозвращаемая;
КонецФункции
Функция   ДанныеСпецификацииПоНоменклатуре(врОснование, врТЗМатериалов)
	УстановитьПривилегированныйРежим(Истина);
	
	врСпецификация													= врОснование.Спецификация;
	ПараметрыЗаполненияНазначений									= ОбеспечениеПроизводства.ПараметрыДействияЗаполнитьНазначениеОбеспеченияВЭтапеПроизводства(врОснование, врОснование.ВыходныеИзделия);
	
	ТЗВозвращаемая													= Новый ТаблицаЗначений;
	ТЗВозвращаемая.Колонки.Добавить("Номенклатура");
	ТЗВозвращаемая.Колонки.Добавить("Упаковка");
	ТЗВозвращаемая.Колонки.Добавить("Артикул");
	ТЗВозвращаемая.Колонки.Добавить("Обособленно");
	ТЗВозвращаемая.Колонки.Добавить("ПрименениеМатериала");
	ТЗВозвращаемая.Колонки.Добавить("ПроизводитсяВПроцессе");
	ТЗВозвращаемая.Колонки.Добавить("СпособПолученияМатериала");
	ТЗВозвращаемая.Колонки.Добавить("СтатьяКалькуляции");
	ТЗВозвращаемая.Колонки.Добавить("Спецификация");
	ТЗВозвращаемая.Колонки.Добавить("Этап");
	ТЗВозвращаемая.Колонки.Добавить("Склад");
	ТЗВозвращаемая.Колонки.Добавить("Назначение");
	ТЗВозвращаемая.Колонки.Добавить("НазначениеОбеспечения");
	
	врТЗСпецификации												= врСпецификация.МатериалыИУслуги.Выгрузить(); 
	
	СтатьяКалькуляцииПокупныеМатериалы = Справочники.СтатьиКалькуляции.НайтиПоРеквизиту("ИдентификаторДляФормул","ПокупныеМатериалы");
	
	Для Каждого врСтрокаМ Из врТЗМатериалов Цикл
		НайденнаяСтрокаСпецификации									= врТЗСпецификации.Найти(врСтрокаМ.Номенклатура, "Номенклатура");
		Если НЕ(НайденнаяСтрокаСпецификации = Неопределено) Тогда
			нСтр													= ТЗВозвращаемая.Добавить();
			ЗаполнитьЗначенияСвойств(нСтр, НайденнаяСтрокаСпецификации);
			нСтр.Упаковка											= врСтрокаМ.Номенклатура.ЕдиницаИзмерения;
			нСтр.Склад												= СкладПоПодразделению(врОснование.Подразделение, врСтрокаМ.Номенклатура);
			
			//	Если (нСтр.ПроизводитсяВПроцессе) Тогда
			//		нСтр.Обособленно									= Истина;
			//	КонецЕсли;
			//	нСтр.НазначениеОбеспечения								= ?(нСтр.ПроизводитсяВПроцессе, ПараметрыЗаполненияНазначений.НазначениеПолуфабрикаты, ПараметрыЗаполненияНазначений.НазначениеМатериалы);
			//	нСтр.Назначение											= ?(нСтр.Обособленно, нСтр.НазначениеОбеспечения, Справочники.Назначения.ПустаяСсылка());
			//	Если НЕ(нСтр.ПроизводитсяВПроцессе) Тогда
			//		//Бывает что в спецификации не отмечено "Произвести", а на самом деле производтся...
			//		ПредшествующиеЭтапы									= ЭтапыПроизводства_НайтиПредшествующие(врОснование.Ссылка, , врСтрокаМ.Номенклатура);
			//		Если НЕ(ПредшествующиеЭтапы = Неопределено) Тогда
			//			нСтр.ПроизводитсяВПроцессе						= Истина;
			//			нСтр.Обособленно								= Истина;
			//		КонецЕсли;
			//	КонецЕсли;
			//	Если ((НайденнаяСтрокаСпецификации.СпособПолученияМатериала =  Перечисления.СпособыПолученияМатериаловВСпецификации.ПроизвестиПоСпецификации) ИЛИ (нСтр.ПроизводитсяВПроцессе)) Тогда
			//		ДанныеОбИзделии										= Новый Структура;
			//		ДанныеОбИзделии.Вставить("НаправлениеДеятельности",	врОснование.НаправлениеДеятельности);
			//		ДанныеОбИзделии.Вставить("НачалоПроизводства",		врОснование.Распоряжение.НачатьНеРанее);
			//		ДанныеОбИзделии.Вставить("Номенклатура",			врСтрокаМ.Номенклатура);
			//		ДанныеОбИзделии.Вставить("ПодразделениеДиспетчер",	врОснование.Подразделение);
			//		ДанныеОбИзделии.Вставить("ТекущаяСпецификация",		Справочники.РесурсныеСпецификации.ПустаяСсылка());
			//		ДанныеОбИзделии.Вставить("Характеристика",			Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
			//		ПараметрыВыбораСпецификаций							= УправлениеДаннымиОбИзделиях.ПараметрыВыбораСпецификаций(врОснование, Документы.ЭтапПроизводства2_2);
			//        СписокСпецификаций									= УправлениеДаннымиОбИзделиях.СпецификацииИзделия(ДанныеОбИзделии, ПараметрыВыбораСпецификаций.ОбеспечениеМатериаламиИРаботами);
			//		Попытка
			//				нСтр.Спецификация							= СписокСпецификаций[0].Спецификация;
			//			Исключение
			//				нСтр.Спецификация							= Справочники.РесурсныеСпецификации.ПустаяСсылка();
			//		КонецПопытки;
			//	КонецЕсли;        
			
			Если ((НайденнаяСтрокаСпецификации.СпособПолученияМатериала =  Перечисления.СпособыПолученияМатериаловВСпецификации.ПроизвестиПоСпецификации) ИЛИ (НайденнаяСтрокаСпецификации.СпособПолученияМатериала =  Перечисления.СпособыПолученияМатериаловВСпецификации.ПроизводитсяНаЭтапе)) Тогда
				нСтр.Обособленно								= Истина;
				нСтр.ПроизводитсяВПроцессе						= Истина; 
				ДанныеОбИзделии										= Новый Структура;
				ДанныеОбИзделии.Вставить("НаправлениеДеятельности",	врОснование.НаправлениеДеятельности);
				ДанныеОбИзделии.Вставить("НачалоПроизводства",		врОснование.Распоряжение.НачатьНеРанее);
				ДанныеОбИзделии.Вставить("Номенклатура",			врСтрокаМ.Номенклатура);
				ДанныеОбИзделии.Вставить("ПодразделениеДиспетчер",	врОснование.Подразделение);
				ДанныеОбИзделии.Вставить("ТекущаяСпецификация",		Справочники.РесурсныеСпецификации.ПустаяСсылка());
				ДанныеОбИзделии.Вставить("Характеристика",			Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
				ПараметрыВыбораСпецификаций							= УправлениеДаннымиОбИзделиях.ПараметрыВыбораСпецификаций(врОснование, Документы.ЭтапПроизводства2_2);
				СписокСпецификаций									= УправлениеДаннымиОбИзделиях.СпецификацииИзделия(ДанныеОбИзделии, ПараметрыВыбораСпецификаций.ОбеспечениеМатериаламиИРаботами);
				Попытка
					нСтр.Спецификация							= СписокСпецификаций[0].Спецификация;
				Исключение
					нСтр.Спецификация							= Справочники.РесурсныеСпецификации.ПустаяСсылка();
				КонецПопытки;
			КонецЕсли;
			нСтр.НазначениеОбеспечения								= ?(нСтр.ПроизводитсяВПроцессе, ПараметрыЗаполненияНазначений.НазначениеПолуфабрикаты, ПараметрыЗаполненияНазначений.НазначениеМатериалы);
			нСтр.Назначение											= ?(нСтр.Обособленно, нСтр.НазначениеОбеспечения, Справочники.Назначения.ПустаяСсылка());
			//Если ((НайденнаяСтрокаСпецификации.СпособПолученияМатериала =  Перечисления.СпособыПолученияМатериаловВСпецификации.ПроизвестиПоСпецификации) ИЛИ (нСтр.ПроизводитсяВПроцессе)) Тогда
			//КонецЕсли;
			
			
			
			Продолжить;
		КонецЕсли;
		
		//раскомментировал 20.08.24 нужно для замены номенклатуры материалов
		Если (НайденнаяСтрокаСпецификации = Неопределено) Тогда
			НайденнаяСтрокаСпецификации								= врТЗСпецификации.Найти(врСтрокаМ.НоменклатураИсходная, "Номенклатура");
			нСтр													= ТЗВозвращаемая.Добавить();
			Если (НайденнаяСтрокаСпецификации <> Неопределено) Тогда
				ЗаполнитьЗначенияСвойств(нСтр, НайденнаяСтрокаСпецификации);
			Иначе	
			    нСтр.ПроизводитсяВПроцессе = Ложь; 
				нСтр.Обособленно = Ложь;  
				нСтр.СтатьяКалькуляции = СтатьяКалькуляцииПокупныеМатериалы;
			КонецЕсли;
			нСтр.Номенклатура										= врСтрокаМ.Номенклатура;
			нСтр.Упаковка											= врСтрокаМ.Номенклатура.ЕдиницаИзмерения;
			нСтр.Артикул											= врСтрокаМ.Номенклатура.Артикул;
			нСтр.Склад												= СкладПоПодразделению(врОснование.Подразделение, врСтрокаМ.Номенклатура);
			Если (нСтр.ПроизводитсяВПроцессе) Тогда
				нСтр.Обособленно									= Истина;
			КонецЕсли;
			нСтр.НазначениеОбеспечения								= ?(нСтр.ПроизводитсяВПроцессе, ПараметрыЗаполненияНазначений.НазначениеПолуфабрикаты, ПараметрыЗаполненияНазначений.НазначениеМатериалы);
			нСтр.Назначение											= ?(нСтр.Обособленно, нСтр.НазначениеОбеспечения, Справочники.Назначения.ПустаяСсылка());
			Если НЕ(нСтр.ПроизводитсяВПроцессе) Тогда
				//Бывает что в спецификации не отмечено "Произвести", а на самом деле производтся...
				//Если врСтрокаМ.НоменклатураИсходная <> Неопределено
					ПредшествующиеЭтапы	= ЭтапыПроизводства_НайтиПредшествующие(врОснование.Ссылка, , врСтрокаМ.НоменклатураИсходная);
				//КонецЕсли;
				Если НЕ(ПредшествующиеЭтапы = Неопределено) Тогда
					нСтр.ПроизводитсяВПроцессе						= Истина;
					нСтр.Обособленно								= Истина;
				КонецЕсли;
			КонецЕсли; 
			Если (НайденнаяСтрокаСпецификации <> Неопределено) Тогда
				Если ((НайденнаяСтрокаСпецификации.СпособПолученияМатериала =  Перечисления.СпособыПолученияМатериаловВСпецификации.ПроизвестиПоСпецификации) ИЛИ (нСтр.ПроизводитсяВПроцессе)) Тогда
					ДанныеОбИзделии										= Новый Структура;
					ДанныеОбИзделии.Вставить("НаправлениеДеятельности",	врОснование.НаправлениеДеятельности);
					ДанныеОбИзделии.Вставить("НачалоПроизводства",		врОснование.Распоряжение.НачатьНеРанее);
					ДанныеОбИзделии.Вставить("Номенклатура",			врСтрокаМ.Номенклатура);
					ДанныеОбИзделии.Вставить("ПодразделениеДиспетчер",	врОснование.Подразделение);
					ДанныеОбИзделии.Вставить("ТекущаяСпецификация",		Справочники.РесурсныеСпецификации.ПустаяСсылка());
					ДанныеОбИзделии.Вставить("Характеристика",			Справочники.ХарактеристикиНоменклатуры.ПустаяСсылка());
					ПараметрыВыбораСпецификаций							= УправлениеДаннымиОбИзделиях.ПараметрыВыбораСпецификаций(врОснование, Документы.ЭтапПроизводства2_2);
					СписокСпецификаций									= УправлениеДаннымиОбИзделиях.СпецификацииИзделия(ДанныеОбИзделии, ПараметрыВыбораСпецификаций.ОбеспечениеМатериаламиИРаботами);
					Попытка
						нСтр.Спецификация							= СписокСпецификаций[0].Спецификация;
					Исключение
						нСтр.Спецификация							= Справочники.РесурсныеСпецификации.ПустаяСсылка();
					КонецПопытки;
				КонецЕсли;
			КонецЕсли;
			Продолжить;
		КонецЕсли;
		//
	КонецЦикла;
	
		
	Возврат ТЗВозвращаемая;
КонецФункции
&НаСервере
Функция   ПлановаяДатаПроизводстваПоЭтапу(врЭтапПроизводства)
	УстановитьПривилегированныйРежим(Истина);
	
	врЗапрос														= Новый Запрос("ВЫБРАТЬ
	        														               |	ГрафикЭтаповПроизводства2_2.ЭтапПроизводства КАК ЭтапПроизводства,
	        														               |	ГрафикЭтаповПроизводства2_2.НачалоЭтапа КАК НачалоЭтапа
	        														               |ИЗ
	        														               |	РегистрСведений.ГрафикЭтаповПроизводства2_2 КАК ГрафикЭтаповПроизводства2_2
	        														               |ГДЕ
	        														               |	ГрафикЭтаповПроизводства2_2.ЭтапПроизводства = &ЭтапПроизводства");
	врЗапрос.УстановитьПараметр("ЭтапПроизводства",					врЭтапПроизводства);
	Результат														= врЗапрос.Выполнить();
	Если (Результат.Пустой()) Тогда
		Попытка
				Возврат врЭтапПроизводства.Распоряжение.Дата;
			Исключение
				Возврат ТекущаяДатаСеанса();
		КонецПопытки;
	КонецЕсли;
	
	Возврат Результат.Выгрузить()[0].НачалоЭтапа;
КонецФункции
&НаСервере
Функция   ПолучитьДанныеВыходногоИзделия(врОснование, ОбработкаЭтапа_Рапределено, СтруктураПромежуточногоИзделия = Неопределено, ТЗВыпускаСтурктура = Неопределено)
	ВозвращаемаяСтруктура											= Новый Структура;
	врКоличествоУпаковок = ОбработкаЭтапа_Рапределено;
	врПараметрыОтбора												= Новый Структура;
	врПараметрыОтбора.Вставить("Ссылка",							врОснование);
	НайденныеСтроки													= Объект.ЭтапыПроизводстваПоИзделию.НайтиСтроки(врПараметрыОтбора);
	Если (НайденныеСтроки.Количество() = 0) Тогда
		врПараметрыОтбора										= Новый Структура;
			врПараметрыОтбора.Вставить("СсылкаПредшествующий",		врОснование);
			НайденныеСтроки											= Объект.ЭтапыПроизводстваПоИзделиюПредшествующие.НайтиСтроки(врПараметрыОтбора);
			врНоменклатура											= НайденныеСтроки[0].ИзделиеПолуфабрикат;
			врЗаказНаПроизводство									= НайденныеСтроки[0].ЗаказНаПроизводство;
			врСпецификация											= НайденныеСтроки[0].Спецификация;
		Иначе
			врНоменклатура											= НайденныеСтроки[0].ОсновноеИзделие;
			врЗаказНаПроизводство									= НайденныеСтроки[0].ЗаказНаПроизводство;
			врСпецификация											= НайденныеСтроки[0].Спецификация;
	КонецЕсли;

	//Если это прямой предшествующий этап, то количество выпуска есть "ПотребностьИзделийПолуфабрикатовКонечногоЭтапа"
	врПараметрыОтбора												= Новый Структура;
	врПараметрыОтбора.Вставить("Номенклатура",						врНоменклатура);
	НайденныеСтроки													= Объект.ПотребностьИзделийПолуфабрикатовКонечногоЭтапа.НайтиСтроки(врПараметрыОтбора);
	Если НЕ(НайденныеСтроки.Количество() = 0) Тогда
		врКоличествоУпаковок										= НайденныеСтроки[0].КоличествоУпаковок;
	КонецЕсли;
	//Возможно это субпромежуточный этап, тогда Пользователь может указать количество прямо в дереве
	Если НЕ(СтруктураПромежуточногоИзделия = Неопределено) Тогда	
		//Если (СтруктураПромежуточногоИзделия.ОсновноеИзделие = врНоменклатура) Тогда
			врКоличествоУпаковок = СтруктураПромежуточногоИзделия.ОсновноеИзделиеКоличествоУпаковок; //врКоличествоУпаковок;//
			врНоменклатура = СтруктураПромежуточногоИзделия.ОсновноеИзделие; 
		//КонецЕсли;
	КонецЕсли;
	
	ВозвращаемаяСтруктура.Вставить("Номенклатура",					врНоменклатура);
	ВозвращаемаяСтруктура.Вставить("КоличествоУпаковок",			врКоличествоУпаковок);
	ВозвращаемаяСтруктура.Вставить("Количество",					врКоличествоУпаковок);
	ВозвращаемаяСтруктура.Вставить("Произведено",					Истина);
	ВозвращаемаяСтруктура.Вставить("ДатаПроизводства",				Объект.РабочаяДата);
	ВозвращаемаяСтруктура.Вставить("ДатаПроизводстваПлан",			Объект.РабочаяДата);
	ВозвращаемаяСтруктура.Вставить("Подразделение",					Справочники.СтруктураПредприятия.ПустаяСсылка());	
	ВозвращаемаяСтруктура.Вставить("Получатель",					Справочники.Склады.ПустаяСсылка());	
	ВозвращаемаяСтруктура.Вставить("Назначение",					Справочники.Назначения.ПустаяСсылка());	
	ВозвращаемаяСтруктура.Вставить("Спецификация",					врСпецификация);	
	ВозвращаемаяСтруктура.Вставить("СтатьяКалькуляции",				Справочники.СтатьиКалькуляции.ПустаяСсылка());	
	ВозвращаемаяСтруктура.Вставить("Характеристика",				Неопределено);
	Для Каждого врСтрокаВО Из врСпецификация.ВозвратныеОтходы Цикл
		Если (врСтрокаВО.Номенклатура = врНоменклатура) Тогда
			ВозвращаемаяСтруктура.Вставить("СтатьяКалькуляции",		врСтрокаВО.СтатьяКалькуляции);	
		КонецЕсли;
	КонецЦикла;
	
	//В общем пришлось упростить алгоритм: назначение все так же возьмем из "ТЗВыпускаСтруктура", а вот подразделение и получатель найдем в текущем выпуске, с учетом назначения
	ПоискЗавершен													= Ложь;
	НазначениеНайдено												= Ложь;
	//02.11.2023: расширили функциональность - теперь "Назанчение" есть в структуре, поэтому сначала возьмем от туда
	//Если НЕ(ТЗВыпускаСтурктура = Неопределено) Тогда
	//	ВозвращаемаяСтруктура.Вставить("Назначение",				ТЗВыпускаСтурктура.Назначение);
	//	НазначениеНайдено											= Истина;
	//КонецЕсли;       
	Если НЕ(ТЗВыпускаСтурктура = Неопределено) Тогда
		Если НЕ(ТЗВыпускаСтурктура.Назначение = "") Тогда      										 // добавил 27.11.23
			ВозвращаемаяСтруктура.Вставить("Назначение",				ТЗВыпускаСтурктура.Назначение);
			НазначениеНайдено											= Истина;
		КонецЕсли;	                                          									    // добавил 27.11.23
	КонецЕсли;	
	//Ищем в выходных изделиях
	Для Каждого врСтрока Из врОснование.ВыходныеИзделия Цикл
		Если (врСтрока.Номенклатура = врНоменклатура) Тогда
			Если (НазначениеНайдено) Тогда
					Если (врСтрока.Назначение = ВозвращаемаяСтруктура.Назначение) Тогда
						ВозвращаемаяСтруктура.Вставить("Подразделение",	врСтрока.Подразделение);
						ВозвращаемаяСтруктура.Вставить("Получатель",	врСтрока.Получатель);
						ПоискЗавершен									= Истина;
					КонецЕсли;
				Иначе
					ВозвращаемаяСтруктура.Вставить("Подразделение",	врСтрока.Подразделение);
					ВозвращаемаяСтруктура.Вставить("Получатель",	врСтрока.Получатель); 
					ВозвращаемаяСтруктура.Вставить("Назначение",	врСтрока.Назначение);		// добавил 27.11.23
					НазначениеНайдено								= Истина;                   // добавил 27.11.23					
					ПоискЗавершен									= Истина;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	//Ищем в побочных изделиях
	Если НЕ(ПоискЗавершен) Тогда
		Для Каждого врСтрока Из врОснование.ПобочныеИзделия Цикл
			Если (врСтрока.Номенклатура = врНоменклатура) Тогда
				Если (НазначениеНайдено) Тогда
						Если (врСтрока.Назначение = ВозвращаемаяСтруктура.Назначение) Тогда
							ВозвращаемаяСтруктура.Вставить("Подразделение",	врСтрока.Подразделение);
							ВозвращаемаяСтруктура.Вставить("Получатель",	врСтрока.Получатель);
							ПоискЗавершен								= Истина;
						КонецЕсли;
					Иначе
						ВозвращаемаяСтруктура.Вставить("Подразделение",	врСтрока.Подразделение);
						ВозвращаемаяСтруктура.Вставить("Получатель",	врСтрока.Получатель);
						ВозвращаемаяСтруктура.Вставить("Назначение",	врСтрока.Назначение);
						НазначениеНайдено								= Истина;
						ПоискЗавершен									= Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	//Не нашли - возможно это конечная номенклатура, поищем в ТЧ заказа на производство
	Если НЕ(ПоискЗавершен) Тогда
		Для Каждого врСтрока Из врЗаказНаПроизводство.Продукция Цикл
			Если (врСтрока.Номенклатура = врНоменклатура) Тогда
				ВозвращаемаяСтруктура.Вставить("Подразделение",		врЗаказНаПроизводство.Подразделение);
				ВозвращаемаяСтруктура.Вставить("Получатель",		врСтрока.Склад);
				ВозвращаемаяСтруктура.Вставить("Характеристика",	?(НЕ(ЗначениеЗаполнено(врСтрока.Характеристика)), Неопределено, врСтрока.Характеристика));
				ВозвращаемаяСтруктура.Вставить("Назначение",		врСтрока.Назначение);
				НазначениеНайдено									= Истина;
				ПоискЗавершен										= Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	//Не нашли - сообщим
	Если НЕ(ПоискЗавершен) Тогда
		СообщениеПользователю										= Новый СообщениеПользователю;
		СообщениеПользователю.Текст									= "В """ + СокрЛП(врОснование) + """ при выпуске """ + СокрЛП(врНоменклатура) + """ не удалось определить подразделние и получателя!";
		СообщениеПользователю.Сообщить();
	КонецЕсли;
	
	Возврат ВозвращаемаяСтруктура;
КонецФункции
&НаСервере
Функция   ПолучитьТекущийОстаток_ИзТаблицыЗначений(ЭтапПроизводства, врНоменклатура, КлючСвязи, врУпаковка, Знач врКоличествоУпаковокТребуется);
	врКоличествоУпаковокВНаличии									= 0;
	врПроизводитсяВПроцессе											= Ложь;
	врПроизводитсяВПроцессеНайдено									= 0;
	КоличествоНайдено												= Ложь;
	ВрХарактеристика												= Неопределено;
	ТЧОбеспечение													= ЭтапПроизводства.ОбеспечениеМатериаламиИРаботами;
	Для Каждого врСтрока из ТЧОбеспечение Цикл
		//Если ((врСтрока.Номенклатура = врНоменклатура) И НЕ (врСтрока.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.Отгрузить)) Тогда            //ВариантыОбеспечения
		//Если ((врСтрока.Номенклатура = врНоменклатура) И (врСтрока.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.КОбеспечению)) Тогда            //Изменил 26.05.25
		Если ((врСтрока.КлючСвязиСпецификация = КлючСвязи) И (врСтрока.Номенклатура = врНоменклатура) И (врСтрока.ВариантОбеспечения = Перечисления.ВариантыОбеспечения.КОбеспечению)) Тогда //Изменил 08.09.25
			
			Если (врСтрока.Производится) Тогда	
				врПодразделение = врСтрока.Спецификация.ОсновноеИзделиеЭтап.Подразделение;          //добавил 29.11.23      
				//врПодразделение = врСтрока.Подразделение;    //изменил на это 16-06-25
				//НЕ ЗначениеЗаполнено(врПодразделение) оказывается истиной, если материал производится на этапе
				ПроизводствоНаСтороне = врСтрока.Спецификация.ОсновноеИзделиеЭтап.ПроизводствоНаСтороне; //добавил 05.05.25
				Если ((врПодразделение = Объект.Отбор_ПодразделениеИсполнитель) И НЕ ПроизводствоНаСтороне) Тогда                //добавил 29.11.23 и 05.05.25
					врПроизводитсяВПроцессе = врСтрока.Производится;  
				КонецЕсли;	
				Если (НЕ ЗначениеЗаполнено(врПодразделение)) Тогда   
					ЭтапПроизводстваСпецификация = ЭтапПроизводства.Спецификация;
					СпецификацияМатериалыИУслуги = ЭтапПроизводстваСпецификация.МатериалыИУслуги;
					Для Каждого МатериалыИУслугиСтрока из СпецификацияМатериалыИУслуги Цикл
						МатериалыИУслугиСтрокаИсточникПолученияПолуфабриката = МатериалыИУслугиСтрока.ИсточникПолученияПолуфабриката;   
						Если (ТипЗнч(МатериалыИУслугиСтрокаИсточникПолученияПолуфабриката) = Тип("СправочникСсылка.ЭтапыПроизводства")) Тогда 
							МатериалыИУслугиСтрокаИсточникПолученияПолуфабрикатаПодразделение = МатериалыИУслугиСтрокаИсточникПолученияПолуфабриката.Подразделение;
							Если (МатериалыИУслугиСтрока.Номенклатура = врНоменклатура) И НЕ (МатериалыИУслугиСтрокаИсточникПолученияПолуфабрикатаПодразделение = Объект.Отбор_ПодразделениеИсполнитель) Тогда
								врПроизводитсяВПроцессе = Ложь;
								врПроизводитсяВПроцессеНайдено = 1;
							КонецЕсли;   
						КонецЕсли;
					КонецЦикла;	
					Если (врПроизводитсяВПроцессеНайдено = 0) Тогда
						врПроизводитсяВПроцессе = врСтрока.Производится;	
					КонецЕсли;	
				КонецЕсли;                                                                          //добавил 29.11.23
			КонецЕсли;
			врОтбор													= новый Структура;
			врОтбор.Вставить("Склад",								врСтрока.Склад);
			врОтбор.Вставить("Номенклатура",						врСтрока.Номенклатура);
			врОтбор.Вставить("Назначение",							врСтрока.Назначение);
			НайденныеСтроки											= ДоступныеОстаткиМатериалов.НайтиСтроки(врОтбор);
			Если (НайденныеСтроки.Количество() = 1) Тогда 
				Если (НайденныеСтроки[0].КоличествоУпаковокВНаличии <= 0) Тогда Прервать; КонецЕсли; 
				ВрНазначение = врСтрока.Назначение;
				ВрХарактеристика = врСтрока.Характеристика;
					КоличествоНайдено										= Истина;
					Если (НайденныеСтроки[0].Упаковка = врУпаковка) Тогда
							врКоличествоУпаковокВНаличии					= НайденныеСтроки[0].КоличествоУпаковокВНаличии;
							НайденныеСтроки[0].КоличествоУпаковокВНаличии	= НайденныеСтроки[0].КоличествоУпаковокВНаличии - врКоличествоУпаковокТребуется;  
							//закоментировал 24.10.24 чтобы количество в наличии считалось на все строки одинаково, т.е. без учета предыдущих
						Иначе   
							ДанныеУпаковки = Справочники.УпаковкиЕдиницыИзмерения.КоэффициентВесОбъемПрочиеРеквизитыУпаковки(врУпаковка, врСтрока.Номенклатура);
							КоэффициентУпаковки = ДанныеУпаковки.Коэффициент;
							врКоличествоУпаковокВНаличии					= НайденныеСтроки[0].КоличествоУпаковокВНаличии / КоэффициентУпаковки;
							врКоличествоУпаковокВНаличииНовое				= врКоличествоУпаковокВНаличии - врКоличествоУпаковокТребуется;
							НайденныеСтроки[0].КоличествоУпаковокВНаличии	= врКоличествоУпаковокВНаличииНовое * КоэффициентУпаковки;
							//закоментировал 24.10.24 чтобы количество в наличии считалось на все строки одинаково, т.е. без учета предыдущих
					КонецЕсли;
				Прервать;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ВозвращаемаяСтруктура											= Новый Структура;
	ВозвращаемаяСтруктура.Вставить("КоличествоУпаковокВНаличии",		врКоличествоУпаковокВНаличии);
	ВозвращаемаяСтруктура.Вставить("КоличествоУпаковокВНаличииТекст",	?(врПроизводитсяВПроцессе И (врКоличествоУпаковокВНаличии - врКоличествоУпаковокТребуется < 0), "<производится>", ""));
	//ВозвращаемаяСтруктура.Вставить("КоличествоУпаковокВНаличииТекст",	"");	
	ВозвращаемаяСтруктура.Вставить("ПроизводитсяВПроцессе",				врПроизводитсяВПроцессе);
	ВозвращаемаяСтруктура.Вставить("Назначение", ВрНазначение);
	ВозвращаемаяСтруктура.Вставить("Характеристика", ВрХарактеристика);
	Возврат ВозвращаемаяСтруктура;
КонецФункции

//* ТРУДОЗАТРАТЫ *************************************************************************************************************
&НаКлиенте
Процедура СформироватьТаблицуТрудозатрат(Команда)
	Если НЕ(ОбработкаЭтапа_Начата) Тогда
		ПоказатьПредупреждение( , "Работа еще не начата. Нажмите ""Оформить"" в строке нужного этапа.", 15, "Информация...");
		Возврат;
	КонецЕсли;
	
	Если (ТаблицаТрудозатрат.Количество() > 0) И (ОбработкаЭтапа_БылиИзмененияТрудозатрат) Тогда
		ТекстВопроса														= "Таблица трудозатрат уже заполнена и есть изменения." + Символы.ПС + "Перезаполнить таблицу трудозатрат?";
		ПоказатьВопрос(Новый ОписаниеОповещения("СформироватьТаблицуТрудозатрат_Завершение", ЭтаФорма), ТекстВопроса, РежимДиалогаВопрос.ДаНет, 15, КодВозвратаДиалога.Нет, "Информация...", КодВозвратаДиалога.Нет);
	Иначе
		Ошибка																= "";
		СформироватьТаблицуТрудозатратНаСервере(Ошибка);
		Если НЕ(Ошибка = "") Тогда
			ПоказатьПредупреждение( , Ошибка, 15, "Информация...");
			Возврат;
		КонецЕсли;
		ОбработкаЭтапа_БылиИзмененияТрудозатрат								= БылиИзмененияТрудозатрат();
		ОбновитьДоступностьКнопкиПрименить();
	КонецЕсли;
КонецПроцедуры
&НаКлиенте
Процедура СформироватьТаблицуТрудозатрат_Завершение(РезультатВопроса, ДополнительныеПараметры) Экспорт
	Если НЕ(РезультатВопроса = КодВозвратаДиалога.Да) Тогда Возврат; КонецЕсли;
	
	Ошибка																	= "";
	СформироватьТаблицуТрудозатратНаСервере(Ошибка);
	
	Если НЕ(Ошибка = "") Тогда
		ПоказатьПредупреждение( , Ошибка, 15, "Информация...");
		Возврат;
	КонецЕсли;
	
	ОбработкаЭтапа_БылиИзмененияТрудозатрат									= БылиИзмененияТрудозатрат(); // BSLLS:UnusedLocalVariable-off - реквизит формы
	ОбновитьДоступностьКнопкиПрименить();
	ЭтаФорма.ТекущийЭлемент													= Элементы.ТаблицаТрудозатрат;
КонецПроцедуры
&НаСервере
Процедура СформироватьТаблицуТрудозатратНаСервере(Ошибка)
	ТаблицаТрудозатрат.Очистить();
	
	//Найдем строку дерева редактируемого этапа
	РедактируемыйЭтапПроизводства_СтрокаДерева							= Неопределено;
	Для Каждого врСтрокаД Из ДеревоЭтапыПроизводстваПоИзделию.ПолучитьЭлементы() Цикл
		Если (врСтрокаД.Ссылка = ОбработкаЭтапа_РедактируемыйЭтапПроизводства) Тогда
			РедактируемыйЭтапПроизводства_СтрокаДерева					= врСтрокаД;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	Если (РедактируемыйЭтапПроизводства_СтрокаДерева = Неопределено) Тогда
		Ошибка															= "В дереве этапов не найден редактируемый этап!";
		Возврат;
	КонецЕсли;
	
	//Рекурсивно заполним трудозатраты по всем этапам ветви
	СформироватьТаблицуТрудозатратНаСервере_Рекурсивно(РедактируемыйЭтапПроизводства_СтрокаДерева, Ошибка);
КонецПроцедуры
&НаСервере
Процедура СформироватьТаблицуТрудозатратНаСервере_Рекурсивно(СтрокаДерева, Ошибка)
	//Обработаем текущий этап
	СформироватьТаблицуТрудозатратНаСервере_ДобавитьТрудозатратыЭтапа(СтрокаДерева, Ошибка);
	
	//Рекурсивно обработаем предшествующие этапы
	Для Каждого врСтрокаД Из СтрокаДерева.ПолучитьЭлементы() Цикл
		СформироватьТаблицуТрудозатратНаСервере_Рекурсивно(врСтрокаД, Ошибка);
	КонецЦикла;
КонецПроцедуры
&НаСервере
Процедура СформироватьТаблицуТрудозатратНаСервере_ДобавитьТрудозатратыЭтапа(СтрокаДерева, Ошибка)
	//Пропускаем завершённые этапы (аналогично материалам)
	Если (СтрокаДерева.Статус = Перечисления.СтатусыЭтаповПроизводства2_2.Завершен) Тогда Возврат; КонецЕсли;
	
	врСпецификация														= СтрокаДерева.Спецификация;
	Если НЕ(ЗначениеЗаполнено(врСпецификация)) Тогда Возврат; КонецЕсли;
	
	врЭтап																= СтрокаДерева.Ссылка.Этап;
	врЭтапПроизводства													= СтрокаДерева.Ссылка;
	врПодразделение														= СтрокаДерева.ПодразделениеИсполнитель;
	
	//Рассчитаем коэффициент для пересчета количества трудозатрат
	врКоэффициентКоличества												= 0;
	Для Каждого врСтрока Из врСпецификация.ВыходныеИзделия Цикл
		Если (врСтрока.Номенклатура = Объект.Отбор_Изделие) ИЛИ (врСтрока.Номенклатура = СтрокаДерева.ИзделиеПолуфабрикат) Тогда
			врКоэффициентКоличества										= врСтрока.КоличествоУпаковок;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	//Если коэффициент не найден в выходных изделиях, проверим в возвратных отходах (побочный выпуск)
	Если (врКоэффициентКоличества = 0) Тогда
		Для Каждого врСтрока Из врСпецификация.ВозвратныеОтходы Цикл
			Если (врСтрока.Номенклатура = СтрокаДерева.ИзделиеПолуфабрикат) Тогда
				врКоэффициентКоличества									= врСтрока.КоличествоУпаковок;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	Если (врКоэффициентКоличества = 0) Тогда
		врКоэффициентКоличества											= 1; //По умолчанию 1 для избежания деления на ноль
	КонецЕсли;
	
	//Получим плановое количество по этапу
	врКоличествоВыпуска													= ?(СтрокаДерева.Ссылка = ОбработкаЭтапа_РедактируемыйЭтапПроизводства, ОбработкаЭтапа_Рапределено, СтрокаДерева.Ссылка.КоличествоУпаковокПлан);
	
	//Добавляем трудозатраты из спецификации этапа
	Для Каждого врСтрокаТЧ Из врСпецификация.Трудозатраты Цикл
		//Фильтруем только по текущему этапу спецификации
		Если НЕ(врСтрокаТЧ.Этап = врЭтап) И ЗначениеЗаполнено(врСтрокаТЧ.Этап) Тогда Продолжить; КонецЕсли;
		
		нСтр															= ТаблицаТрудозатрат.Добавить();
		нСтр.ЭтапПроизводства											= врЭтапПроизводства;
		нСтр.ВидРабот													= врСтрокаТЧ.ВидРабот;
		нСтр.Количество													= врСтрокаТЧ.Количество / врКоэффициентКоличества * врКоличествоВыпуска;
		нСтр.КоличествоФактически										= нСтр.Количество;
		нСтр.Исполнитель												= Неопределено; //Пользователь должен выбрать
		нСтр.Подразделение												= врПодразделение;
		нСтр.СтатьяКалькуляции											= врСтрокаТЧ.СтатьяКалькуляции;
		нСтр.НазначениеРабот											= врСтрокаТЧ.НазначениеРабот;
		нСтр.ИзменениеДоступно											= Истина; //Завершённые этапы уже пропущены выше
		нСтр.ЕстьИзменение												= Ложь;
	КонецЦикла;
КонецПроцедуры
&НаКлиенте
Функция БылиИзмененияТрудозатрат()
	Для Каждого врСтрока Из ТаблицаТрудозатрат Цикл
		Если (врСтрока.ЕстьИзменение) Тогда
			Возврат Истина;
		КонецЕсли;
	КонецЦикла;
	Возврат Ложь;
КонецФункции
&НаКлиенте
Процедура ТаблицаТрудозатратЭтапПроизводстваОткрытие(Элемент, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	
	ТекущиеДанные = Элементы.ТаблицаТрудозатрат.ТекущиеДанные;
	Если (ТекущиеДанные = Неопределено) Тогда Возврат; КонецЕсли;
	Если НЕ(ЗначениеЗаполнено(ТекущиеДанные.ЭтапПроизводства)) Тогда Возврат; КонецЕсли;
	
	ПоказатьЗначение( , ТекущиеДанные.ЭтапПроизводства);
КонецПроцедуры
&НаКлиенте
Процедура ТаблицаТрудозатратПриОкончанииРедактирования(Элемент, НоваяСтрока, ОтменаРедактирования)
	Если (ОтменаРедактирования) Тогда Возврат; КонецЕсли;
	
	ТекущиеДанные														= Элементы.ТаблицаТрудозатрат.ТекущиеДанные;
	Если (ТекущиеДанные = Неопределено) Тогда Возврат; КонецЕсли;
	
	ТекущиеДанные.ЕстьИзменение											= Истина;
	ОбработкаЭтапа_БылиИзмененияТрудозатрат								= Истина; // BSLLS:UnusedLocalVariable-off - реквизит формы
	
	//Обновим доступность кнопки "Применить"
	ОбновитьДоступностьКнопкиПрименить();
КонецПроцедуры
&НаКлиенте
Процедура ЗаполнитьИсполнителяТрудозатрат(Команда)
	Если (ТаблицаТрудозатрат.Количество() = 0) Тогда
		ПоказатьПредупреждение( , "Таблица трудозатрат пуста. Сначала сформируйте таблицу трудозатрат.", 15, "Информация...");
		Возврат;
	КонецЕсли;
	
	//Открываем форму выбора бригады
	ОписаниеОповещения = Новый ОписаниеОповещения("ЗаполнитьИсполнителяТрудозатрат_Завершение", ЭтаФорма);
	ОткрытьФорму("Справочник.Бригады.ФормаВыбора", , ЭтаФорма, , , , ОписаниеОповещения, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
КонецПроцедуры
&НаКлиенте
Процедура ЗаполнитьИсполнителяТрудозатрат_Завершение(ВыбраннаяБригада, ДополнительныеПараметры) Экспорт
	Если (ВыбраннаяБригада = Неопределено) Тогда Возврат; КонецЕсли;
	
	//Заполняем исполнителя для всех строк
	Для Каждого врСтрока Из ТаблицаТрудозатрат Цикл
		Если (врСтрока.ИзменениеДоступно) Тогда
			врСтрока.Исполнитель = ВыбраннаяБригада;
			врСтрока.ЕстьИзменение = Истина;
		КонецЕсли;
	КонецЦикла;
	
	ОбработкаЭтапа_БылиИзмененияТрудозатрат = Истина; // BSLLS:UnusedLocalVariable-off - реквизит формы
	ОбновитьДоступностьКнопкиПрименить();
КонецПроцедуры
&НаКлиенте
Функция ВсеИсполнителиТрудозатратЗаполнены()
	Если (ТаблицаТрудозатрат.Количество() = 0) Тогда
		Возврат Истина;
	КонецЕсли;
	
	Для Каждого врСтрока Из ТаблицаТрудозатрат Цикл
		Если (врСтрока.ИзменениеДоступно) И НЕ(ЗначениеЗаполнено(врСтрока.Исполнитель)) Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
КонецФункции
&НаКлиенте
Процедура ОбновитьДоступностьКнопкиПрименить()
	//Кнопка "Применить" активна только если:
	//1. Количество к распределению не больше недодела
	//2. Все исполнители трудозатрат заполнены
	//3. Достаточно материалов
	
	врДоступность = Истина;
	
	//Проверка количества к распределению
	Если (ОбработкаЭтапа_Рапределено > ОбработкаЭтапа_Недодел) Тогда
		врДоступность = Ложь;
	КонецЕсли;
	
	//Проверка исполнителей трудозатрат
	Если (врДоступность) И НЕ(ВсеИсполнителиТрудозатратЗаполнены()) Тогда
		врДоступность = Ложь;
	КонецЕсли;
	
	//Проверка достаточности материалов
	Если (врДоступность) И (ДеревоИспользованныхМатериалов.ПолучитьЭлементы().Количество() > 0) Тогда
		врСчетНоменклатур = 0;
		ПроверитьТаблицуМатериаловНаСервере_Инициализация(врСчетНоменклатур);
		Если НЕ(врСчетНоменклатур = 0) Тогда
			врДоступность = Ложь;
		КонецЕсли;
	КонецЕсли;
	
	Элементы.ПрименитьВДокументах.Доступность = врДоступность;
КонецПроцедуры






















