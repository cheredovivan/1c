#Область ПрограммныйИнтерфейс

// Добавляет ресурсы в таблицу ресурсов
//
// Параметры:
//  ТаблицаРесурсов - ТаблицаЗначений - таблица ресурсов для заполнения
//
Процедура ДобавитьРесурсы(ТаблицаРесурсов) Экспорт
	
	mcp_Метаданные.ДобавитьРесурс(
		ТаблицаРесурсов,
		"file://resource/data_tools_guide.md",
		"data_tools_guide",
		"Инструкция по использованию инструментов работы с данными базы 1С:Предприятие (чтение, запись, пометка на удаление)"
	);
	
КонецПроцедуры

// Читает ресурс по адресу
//
// Параметры:
//  Адрес - Строка - адрес ресурса
//
// Возвращаемое значение:
//  Структура - описание содержимого ресурса в формате MCP
//
Функция ПрочитатьРесурс(Адрес) Экспорт
	
	Если СтрНачинаетсяС(Адрес, "file://resource/") Тогда
		
		ПозицияНачалаИмени = СтрДлина("file://resource/") + 1;
		ПозицияНачалаРасширения = СтрНайти(Адрес, ".");
		ИмяМакета = Сред(Адрес, ПозицияНачалаИмени, ПозицияНачалаРасширения - ПозицияНачалаИмени);
		
		Если ИмяМакета = "data_tools_guide" Тогда
			ТекстИнструкции = ПолучитьТекстИнструкции();
			Возврат mcp_Содержимое.ТекстовоеСодержимоеРесурса(ТекстИнструкции, "text/markdown");
		КонецЕсли;
		
	КонецЕсли;
	
	ВызватьИсключение СтрШаблон("Неизвестный адрес ресурса: %1", Адрес);
	
КонецФункции

#КонецОбласти

#Область ФормированиеИнструкции

Функция ПолучитьТекстИнструкции()
	
	ТекстИнструкции = 
	"ИНСТРУКЦИЯ ПО ИСПОЛЬЗОВАНИЮ ИНСТРУМЕНТОВ РАБОТЫ С ДАННЫМИ БАЗЫ 1С:ПРЕДПРИЯТИЕ
	|
	|========================================
	|ВАЖНО: ТИПИЧНЫЕ ОШИБКИ И ИХ РЕШЕНИЕ
	|========================================
	|
	|ОШИБКА 1: 'Валюта не найдена' или 'передана пустая валюта'
	|Причина: Поиск валюты по наименованию ('руб.') может не работать.
	|РЕШЕНИЕ: ВСЕГДА используйте КОД валюты вместо наименования:
	|  - '643' для российского рубля (вместо 'руб.')
	|  - '840' для доллара США (вместо 'USD')
	|  - '978' для евро (вместо 'EUR')
	|
	|ОШИБКА 2: 'Организация не найдена'
	|Причина: У справочника Организации НЕТ реквизита Код.
	|РЕШЕНИЕ: Искать по ИНН или ТОЧНОМУ наименованию.
	|
	|ОШИБКА 3: 'Ошибка получения курса валют'
	|Причина: Валюта передается некорректно или не найдена.
	|РЕШЕНИЕ: Использовать КОД валюты (643, 840, 978).
	|
	|========================================
	|ОСНОВНАЯ ИНСТРУКЦИЯ
	|
	|ОБЗОР
	|
	|MCP сервер предоставляет инструменты для работы с данными базы данных 1С:Предприятие:
	|
	|- execute_any_query - выполнение произвольных запросов к базе данных (SELECT, INSERT, UPDATE и т.д.)
	|- read_object_data - работа с данными объектов (чтение, запись, пометка на удаление): справочники, документы, табличные части, регистры
	|- list_metadata_objects - получение списка объектов метаданных
	|- get_metadata_structure - получение структуры объекта метаданных
	|
	|РЕКОМЕНДУЕМЫЙ ПОРЯДОК РАБОТЫ
	|
	|1. Используйте list_metadata_objects для поиска нужного объекта метаданных
	|2. Используйте get_metadata_structure для изучения структуры объекта (реквизиты, табличные части, измерения, ресурсы)
	|3. Используйте read_object_data или execute_any_query для работы с данными
	|
	|ИНСТРУМЕНТ execute_any_query
	|
	|Выполняет произвольные запросы к базе данных без ограничений на тип запроса (SELECT, INSERT, UPDATE и т.д.).
	|
	|Параметры:
	|- query (обязательный, string) - текст запроса на языке запросов 1С:Предприятие (любой тип запроса)
	|- parameters (опциональный, object) - параметры запроса в виде объекта (ключ-значение)
	|- format (опциональный, string) - формат результата: markdown (по умолчанию) или json
	|- includeSchema (опциональный, boolean) - включить схему колонок в JSON результат
	|- maxRows (опциональный, number) - максимальное количество строк (по умолчанию 1000, максимум 10000)
	|
	|ИНСТРУМЕНТ read_object_data
	|
	|Универсальный инструмент для работы с данными объектов базы данных 1С:Предприятие. Поддерживает три операции:
	|
	|- Чтение данных (operation=read) - получение данных объектов из базы
	|- Запись данных (operation=write) - создание и обновление объектов
	|- Пометка на удаление (operation=mark_for_deletion) - установка пометки удаления для объектов
	|
	|Обязательные параметры:
	|- metaType (string) - тип объекта метаданных: Catalogs, Documents, InformationRegisters, AccumulationRegisters, AccountingRegisters, CalculationRegisters
	|- name (string) - точное имя объекта метаданных (без учета регистра)
	|- mode (string) - режим работы: catalog_item, document_header, document_table_part, register_slice
	|
	|Опциональные параметры:
	|- operation (string) - операция. По умолчанию read. Допустимые значения: read, write, mark_for_deletion
	|- selector (string) - идентификатор объекта: UUID ссылки, номер документа, код или наименование элемента справочника
	|- tablePart (string) - имя табличной части (обязательно для mode=document_table_part)
	|- data (object) - данные для записи в формате JSON объекта (обязательно для operation=write)
	|- fields (array of string) - список полей для выборки
	|- maxRows (number) - максимальное количество строк в результате (по умолчанию 1000, максимум 10000)
	|- format (string) - формат результата: markdown (по умолчанию) или json
	|
	|ОПЕРАЦИИ
	|
	|1. Чтение данных (operation=read)
	|Режимы чтения:
	|- catalog_item - чтение элемента справочника. Требуется: selector (код, наименование или UUID ссылки)
	|- document_header - чтение заголовка документа. Требуется: selector (номер документа или UUID ссылки)
	|- document_table_part - чтение табличной части документа. Требуется: selector, tablePart (имя табличной части)
	|- register_slice - чтение среза регистра. Требуется: selector (структура с измерениями и условиями)
	|
	|2. Запись данных (operation=write)
	|Режимы записи:
	|- catalog_item - создание/обновление элемента справочника
	|- document_header - создание/обновление документа (документ автоматически проводится)
	|- document_table_part - запись табличной части документа (требуется существующий документ)
	|- register_slice - запись движений регистра
	|
	|Формат данных для записи:
	|Данные передаются в параметре data в формате JSON объекта. Значения автоматически преобразуются в типы 1С:
	|- Даты: строки в формате ISO (2025-01-27T00:00:00 или 2025-01-27)
	|- Ссылки: строки с UUID ссылки, кодом или наименованием объекта
	|- Числа: числа или строки, содержащие числа
	|- Булево: true/false, 1/0
	|- Строки: строковые значения
	|
	|Важно: При записи документа или справочника служебные поля (Ссылка, Номер, ПометкаУдаления) игнорируются.
	|
	|3. Пометка на удаление (operation=mark_for_deletion)
	|Поддерживается для режимов: catalog_item, document_header
	|Не поддерживается для табличных частей и регистров.
	|
	|ОГРАНИЧЕНИЯ
	|
	|- Максимальное количество строк в результате: 10000
	|- При записи документов они автоматически проводятся
	|- Служебные поля (Ссылка, Номер, ПометкаУдаления) не могут быть изменены при записи
	|- Для записи табличной части требуется существующий документ
	|
	|ФОРМАТЫ РЕЗУЛЬТАТА
	|
	|Markdown - удобочитаемая таблица. Подходит для отображения в интерфейсе пользователя.
	|JSON - структурированные данные с полями: columns, rows, truncated, maxRows, totalRows.
|
|ИНСТРУМЕНТ get_purchase_order_status
|
|Назначение: сводка по заказу поставщику (шапка, товары, остатки по регистру ЗаказыПоставщикам, состояние расчетов, связанные документы поступления).
|
|Использование перед закрытием заказа:
|- Проверить, что в разделе ""Остатки по заказу"" пусто (все товары поступили/отменены).
|- Проверить в ""Состоянии расчетов"": КОплате=0, Оплачено = сумма заказа, Оплачивается=0, КПоступлению=0.
|- Если есть остатки или долги - сообщить пользователю, что нужно оформить соответствующие документы (поступления/оплаты).
|
|ИНСТРУМЕНТ task_manager
|
|Закрытие задач исполнителя
|
|Порядок действий, если пользователь просит закрыть задачу:
|- Выполнить все действия, описанные в тексте задачи (например, провести документы, выполнить проверки, оплатить счета и т.п.).
|- Зафиксировать результат выполнения в параметре result (кратко и по существу).
|- Вызвать task_manager с operation=complete и selector=<номер задачи>.
|
|ИНСТРУМЕНТ create_debt_adjustment
|
|Создание документа ""Корректировка задолженности"".
|
|Параметры (обязательные): organization, partner, direction (РасчетыСПоставщиком/РасчетыСКлиентом/РасчетыСКредитором/РасчетыСДебитором/РасчетыСАрендодателем), currency, amount, basis_selector (номер/UUID заказа поставщику).
|Опциональные: contragent, date (ISO), comment.
|
|Перед созданием по заказу: проверить заказ через get_purchase_order_status; если есть остатки или долги — сообщить пользователю, что нужно оформить соответствующие документы (поступления/оплаты).
|Результат: документ создается и проводится; направление расчетов (direction) определяет сторону долга.
|
|========================================
|ПРАКТИЧЕСКИЕ ПРИМЕРЫ РАБОТЫ
|========================================
|
|ПРИМЕР 1: Поиск организации для использования в инструментах
|
|Проблема: Многие инструменты требуют организацию, но поиск по наименованию может не работать.
|
|Решение - Шаг 1: Найти организацию по части наименования:
|execute_any_query(
|  query = ""ВЫБРАТЬ Организации.Наименование, Организации.ИНН ИЗ Справочник.Организации КАК Организации ГДЕ Организации.Наименование ПОДОБНО '%ЭТП%'"",
|  format = ""markdown""
|)
|
|Шаг 2: Использовать ТОЧНОЕ наименование или ИНН в инструментах
|Важно: Справочник Организации НЕ имеет реквизита Код, используйте ИНН для поиска.
|
|ПРИМЕР 2: Поиск партнера
|
|execute_any_query(
|  query = ""ВЫБРАТЬ ПЕРВЫЕ 10 Партнеры.Наименование ИЗ Справочник.Партнеры КАК Партнеры ГДЕ Партнеры.Наименование ПОДОБНО &Маска"",
|  parameters = {""Маска"": ""%Zhongshan%""}
|)
|
|ПРИМЕР 3: Работа с заказами поставщику - полный цикл
|
|Шаг 1: Получить статус заказа
|get_purchase_order_status(selector=""ПОУП-002044"", format=""markdown"")
|
|Шаг 2: Прочитать заголовок документа для получения данных
|read_object_data(metaType=""Documents"", name=""ЗаказПоставщику"", mode=""document_header"", selector=""ПОУП-002044"")
|Из результата получить: Организация, Партнер, Валюта, СуммаДокумента
|
|Шаг 3: Создать корректировку задолженности
|create_debt_adjustment(organization=""ПО ЭТП АО"", partner=""Zhongshan..."", direction=""РасчетыСПоставщиком"", currency=""643"", amount=282205.78, basis_selector=""ПОУП-002044"")
|
|ПРИМЕР 4: Поиск документа по номеру с несколькими результатами
|
|Проблема: Номер документа может быть не уникальным.
|
|Решение: Используйте execute_any_query с дополнительными условиями:
|execute_any_query(query=""ВЫБРАТЬ Док.Номер, Док.Дата, Док.Партнер.Наименование, Док.СуммаДокумента ИЗ Документ.ЗаказПоставщику КАК Док ГДЕ Док.Номер = &Номер"", parameters={""Номер"":""ПОУП-002044""})
|
|Затем используйте JSON selector для точного поиска:
|read_object_data(selector=""{\""Номер\"": \""ПОУП-002044\"", \""Партнер\"": \""Zhongshan...\"", \""Дата\"": \""2025-11-06\""}"")
|
|ПРИМЕР 5: Получение структуры объекта
|
|Всегда используйте get_metadata_structure перед работой:
|get_metadata_structure(metaType=""Documents"", name=""ЗаказПоставщику"")
|
|ВАЖНЫЕ ОСОБЕННОСТИ:
|
|1. Справочник Организации НЕТ реквизита Код - используйте ИНН
|2. Номера документов могут быть не уникальными - добавляйте условия (дата, партнер)
|3. Валюты: используйте КОДЫ - ""643"" (рубли), ""840"" (доллары), ""978"" (евро)
|4. Всегда получайте актуальные данные перед использованием специализированных инструментов
|5. Последовательность для корректировки: get_purchase_order_status -> read_object_data -> create_debt_adjustment
	|";
	
	Возврат ТекстИнструкции;
	
КонецФункции

#КонецОбласти

