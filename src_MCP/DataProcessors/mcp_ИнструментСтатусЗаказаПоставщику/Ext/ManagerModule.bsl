#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт
	
	ДобавитьИнструментСтатусЗаказаПоставщику(Инструменты);
	
КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт
	
	Попытка
		Если ИмяИнструмента = "get_purchase_order_status" Тогда
			Возврат ПолучитьСтатусЗаказаПоставщику(Аргументы);
		Иначе
			Возврат СформироватьОтветСОшибкой("Неизвестный инструмент: " + ИмяИнструмента);
		КонецЕсли;
	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		СообщениеОшибки = СтрШаблон("Ошибка выполнения инструмента '%1': %2",
			ИмяИнструмента,
			ОписаниеОшибкиТекст);
		
		Попытка
			ЗаписьЖурналаРегистрации("MCP." + ИмяИнструмента, УровеньЖурналаРегистрации.Ошибка, , , 
				СообщениеОшибки + Символы.ПС + ПодробноеОписание);
		Исключение
			// Ошибка логирования не должна прерывать основной поток
		КонецПопытки;
		
		Возврат СформироватьОтветСОшибкой(СообщениеОшибки + Символы.ПС + ПодробноеОписание);
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СформироватьОтветСОшибкой(ТекстОшибки)
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", "ОШИБКА: " + ТекстОшибки);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Ответ.Вставить("isError", Истина);
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

#Область ИнструментСтатусЗаказаПоставщику

Процедура ДобавитьИнструментСтатусЗаказаПоставщику(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	// Параметр selector - идентификатор заказа
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"selector",
		"string",
		"Идентификатор заказа: номер документа (например 'ПОУП-001998'), UUID или JSON-объект с критериями поиска: {""Номер"": ""001998"", ""Дата"": ""2025-10-29"", ""Партнер"": ""ДАН""}",
		,
		Истина
	));
	
	// Параметр format - формат результата
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"format",
		"string",
		"Формат результата: 'markdown' (удобочитаемые таблицы) или 'json' (структурированные данные). По умолчанию 'markdown'",
		"markdown",
		Ложь,
		"markdown,json"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"get_purchase_order_status",
		"Получение полной информации о статусе заказа поставщику: заголовок документа, табличная часть товаров, " +
		"состояние по регистру заказов (что осталось к поступлению/оформлению), состояние расчетов (оплаты), " +
		"список связанных документов поступления (Приобретение товаров и услуг, Поступление товаров на склад)",
		СхемаПараметров
	);
	
КонецПроцедуры

Функция ПолучитьСтатусЗаказаПоставщику(Аргументы)
	
	УстановитьПривилегированныйРежим(Истина);
	
	// Преобразуем Соответствие в Структуру если нужно
	Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
		АргументыСтруктура = Новый Структура;
		Для Каждого КлючЗначение Из Аргументы Цикл
			АргументыСтруктура.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
		Аргументы = АргументыСтруктура;
	КонецЕсли;
	
	// Получаем параметры
	Селектор = "";
	Если Аргументы.Свойство("selector") Тогда
		Селектор = Аргументы.selector;
	КонецЕсли;
	
	ФорматРезультата = "markdown";
	Если Аргументы.Свойство("format") Тогда
		ФорматРезультата = НРег(Аргументы.format);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Селектор) Тогда
		Возврат СформироватьОтветСОшибкой("Не указан селектор заказа (selector)");
	КонецЕсли;
	
	// Находим документ
	ЗаказСсылка = НайтиЗаказПоСелектору(Селектор);
	
	Если ЗаказСсылка = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой("Заказ поставщику не найден по селектору: " + Селектор);
	КонецЕсли;
	
	// Собираем полную информацию
	Результат = Новый Структура;
	
	// 1. Заголовок документа
	Результат.Вставить("Заголовок", ПолучитьЗаголовокЗаказа(ЗаказСсылка));
	
	// 2. Табличная часть Товары
	Результат.Вставить("Товары", ПолучитьТоварыЗаказа(ЗаказСсылка));
	
	// 3. Остатки по регистру ЗаказыПоставщикам
	Результат.Вставить("ОстаткиЗаказа", ПолучитьОстаткиЗаказа(ЗаказСсылка));
	
	// 4. Состояние расчетов
	Результат.Вставить("СостояниеРасчетов", ПолучитьСостояниеРасчетов(ЗаказСсылка));
	
	// 5. Документы поступления
	Результат.Вставить("ДокументыПоступления", ПолучитьДокументыПоступления(ЗаказСсылка));
	
	// Форматируем результат
	Если ФорматРезультата = "json" Тогда
		Возврат СформироватьJSONОтвет(Результат);
	Иначе
		Возврат СформироватьMarkdownОтвет(Результат, ЗаказСсылка);
	КонецЕсли;
	
КонецФункции

// Ищет заказ поставщику по селектору
Функция НайтиЗаказПоСелектору(Селектор)
	
	// Попробуем распарсить как JSON (структура критериев)
	Критерии = Неопределено;
	Если СтрНачинаетсяС(СокрЛП(Селектор), "{") Тогда
		Попытка
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(Селектор);
			Критерии = ПрочитатьJSON(ЧтениеJSON, Истина);
			ЧтениеJSON.Закрыть();
		Исключение
			// Не JSON — обрабатываем как строку
		КонецПопытки;
	КонецЕсли;
	
	Если Критерии <> Неопределено Тогда
		Возврат НайтиЗаказПоКритериям(Критерии);
	КонецЕсли;
	
	// Поиск по UUID
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			Возврат Документы.ЗаказПоставщику.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
		Исключение
			// Не UUID — продолжаем
		КонецПопытки;
	КонецЕсли;
	
	// Поиск по номеру документа
	Возврат НайтиЗаказПоНомеру(Селектор);
	
КонецФункции

// Поиск заказа по номеру (с учетом частичного совпадения)
Функция НайтиЗаказПоНомеру(Номер)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Док.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ЗаказПоставщику КАК Док
		|ГДЕ
		|	Док.Номер ПОДОБНО &Номер
		|УПОРЯДОЧИТЬ ПО
		|	Док.Дата УБЫВ";
	
	Запрос.УстановитьПараметр("Номер", "%" + Номер + "%");
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Поиск заказа по расширенным критериям
Функция НайтиЗаказПоКритериям(Критерии)
	
	Запрос = Новый Запрос;
	ТекстУсловий = "";
	
	// Условие по номеру
	Номер = ПолучитьЗначениеКритерия(Критерии, "Номер");
	Если ЗначениеЗаполнено(Номер) Тогда
		ТекстУсловий = "Док.Номер ПОДОБНО &Номер";
		Запрос.УстановитьПараметр("Номер", "%" + Номер + "%");
	КонецЕсли;
	
	// Условие по дате
	Дата = ПолучитьЗначениеКритерия(Критерии, "Дата");
	Если ЗначениеЗаполнено(Дата) Тогда
		Если ЗначениеЗаполнено(ТекстУсловий) Тогда
			ТекстУсловий = ТекстУсловий + " И ";
		КонецЕсли;
		ТекстУсловий = ТекстУсловий + "НАЧАЛОПЕРИОДА(Док.Дата, ДЕНЬ) = НАЧАЛОПЕРИОДА(&Дата, ДЕНЬ)";
		
		// Преобразуем дату из строки если нужно
		Если ТипЗнч(Дата) = Тип("Строка") Тогда
			Дата = mcp_ОбщегоНазначения.ПреобразоватьДатуИзISO(Дата);
		КонецЕсли;
		Запрос.УстановитьПараметр("Дата", Дата);
	КонецЕсли;
	
	// Условие по партнеру/контрагенту
	Партнер = ПолучитьЗначениеКритерия(Критерии, "Партнер");
	Если НЕ ЗначениеЗаполнено(Партнер) Тогда
		Партнер = ПолучитьЗначениеКритерия(Критерии, "Контрагент");
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Партнер) Тогда
		Если ЗначениеЗаполнено(ТекстУсловий) Тогда
			ТекстУсловий = ТекстУсловий + " И ";
		КонецЕсли;
		ТекстУсловий = ТекстУсловий + "Док.Партнер.Наименование ПОДОБНО &Партнер";
		Запрос.УстановитьПараметр("Партнер", "%" + Партнер + "%");
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ТекстУсловий) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Запрос.Текст = СтрШаблон(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Док.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ЗаказПоставщику КАК Док
		|ГДЕ
		|	%1
		|УПОРЯДОЧИТЬ ПО
		|	Док.Дата УБЫВ", ТекстУсловий);
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Получает значение критерия из Структуры или Соответствия
Функция ПолучитьЗначениеКритерия(Критерии, Ключ)
	
	Если ТипЗнч(Критерии) = Тип("Структура") Тогда
		Если Критерии.Свойство(Ключ) Тогда
			Возврат Критерии[Ключ];
		КонецЕсли;
	ИначеЕсли ТипЗнч(Критерии) = Тип("Соответствие") Тогда
		Возврат Критерии.Получить(Ключ);
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Получает заголовок заказа
Функция ПолучитьЗаголовокЗаказа(ЗаказСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Док.Номер КАК Номер,
		|	Док.Дата КАК Дата,
		|	Док.Статус КАК Статус,
		|	Док.Проведен КАК Проведен,
		|	Док.Партнер.Наименование КАК Партнер,
		|	Док.Контрагент.Наименование КАК Контрагент,
		|	Док.Организация.Наименование КАК Организация,
		|	Док.Склад.Наименование КАК Склад,
		|	Док.Валюта.Наименование КАК Валюта,
		|	Док.СуммаДокумента КАК СуммаДокумента,
		|	Док.Комментарий КАК Комментарий,
		|	Док.ЖелаемаяДатаПоступления КАК ЖелаемаяДатаПоступления,
		|	Док.Менеджер.Наименование КАК Менеджер
		|ИЗ
		|	Документ.ЗаказПоставщику КАК Док
		|ГДЕ
		|	Док.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", ЗаказСсылка);
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		
		Заголовок = Новый Структура;
		Заголовок.Вставить("Номер", Выборка.Номер);
		Заголовок.Вставить("Дата", Выборка.Дата);
		Заголовок.Вставить("Статус", Строка(Выборка.Статус));
		Заголовок.Вставить("Проведен", Выборка.Проведен);
		Заголовок.Вставить("Партнер", Выборка.Партнер);
		Заголовок.Вставить("Контрагент", Выборка.Контрагент);
		Заголовок.Вставить("Организация", Выборка.Организация);
		Заголовок.Вставить("Склад", Выборка.Склад);
		Заголовок.Вставить("Валюта", Выборка.Валюта);
		Заголовок.Вставить("СуммаДокумента", Выборка.СуммаДокумента);
		Заголовок.Вставить("Комментарий", Выборка.Комментарий);
		Заголовок.Вставить("ЖелаемаяДатаПоступления", Выборка.ЖелаемаяДатаПоступления);
		Заголовок.Вставить("Менеджер", Выборка.Менеджер);
		
		Возврат Заголовок;
	КонецЕсли;
	
	Возврат Новый Структура;
	
КонецФункции

// Получает табличную часть Товары
Функция ПолучитьТоварыЗаказа(ЗаказСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Товары.НомерСтроки КАК НомерСтроки,
		|	Товары.КодСтроки КАК КодСтроки,
		|	Товары.Номенклатура.Наименование КАК Номенклатура,
		|	Товары.Характеристика.Наименование КАК Характеристика,
		|	Товары.Количество КАК Количество,
		|	Товары.Цена КАК Цена,
		|	Товары.Сумма КАК Сумма,
		|	Товары.Отменено КАК Отменено,
		|	Товары.ДатаПоступления КАК ДатаПоступления
		|ИЗ
		|	Документ.ЗаказПоставщику.Товары КАК Товары
		|ГДЕ
		|	Товары.Ссылка = &Ссылка
		|УПОРЯДОЧИТЬ ПО
		|	Товары.НомерСтроки";
	
	Запрос.УстановитьПараметр("Ссылка", ЗаказСсылка);
	
	Результат = Запрос.Выполнить();
	Таблица = Результат.Выгрузить();
	
	МассивТоваров = Новый Массив;
	Для Каждого Строка Из Таблица Цикл
		СтрокаДанных = Новый Структура;
		СтрокаДанных.Вставить("НомерСтроки", Строка.НомерСтроки);
		СтрокаДанных.Вставить("КодСтроки", Строка.КодСтроки);
		СтрокаДанных.Вставить("Номенклатура", Строка.Номенклатура);
		СтрокаДанных.Вставить("Характеристика", Строка.Характеристика);
		СтрокаДанных.Вставить("Количество", Строка.Количество);
		СтрокаДанных.Вставить("Цена", Строка.Цена);
		СтрокаДанных.Вставить("Сумма", Строка.Сумма);
		СтрокаДанных.Вставить("Отменено", Строка.Отменено);
		СтрокаДанных.Вставить("ДатаПоступления", Строка.ДатаПоступления);
		МассивТоваров.Добавить(СтрокаДанных);
	КонецЦикла;
	
	Возврат МассивТоваров;
	
КонецФункции

// Получает остатки по регистру ЗаказыПоставщикам
Функция ПолучитьОстаткиЗаказа(ЗаказСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Остатки.Номенклатура.Наименование КАК Номенклатура,
		|	Остатки.Характеристика.Наименование КАК Характеристика,
		|	Остатки.КодСтроки КАК КодСтроки,
		|	Остатки.Склад.Наименование КАК Склад,
		|	Остатки.ЗаказаноОстаток КАК Заказано,
		|	Остатки.КОформлениюОстаток КАК КОформлению,
		|	Остатки.КПоступлениюОстаток КАК КПоступлению,
		|	Остатки.СуммаОстаток КАК Сумма
		|ИЗ
		|	РегистрНакопления.ЗаказыПоставщикам.Остатки(, ЗаказПоставщику = &Заказ) КАК Остатки
		|УПОРЯДОЧИТЬ ПО
		|	КодСтроки";
	
	Запрос.УстановитьПараметр("Заказ", ЗаказСсылка);
	
	Результат = Запрос.Выполнить();
	Таблица = Результат.Выгрузить();
	
	МассивОстатков = Новый Массив;
	Для Каждого Строка Из Таблица Цикл
		СтрокаДанных = Новый Структура;
		СтрокаДанных.Вставить("Номенклатура", Строка.Номенклатура);
		СтрокаДанных.Вставить("Характеристика", Строка.Характеристика);
		СтрокаДанных.Вставить("КодСтроки", Строка.КодСтроки);
		СтрокаДанных.Вставить("Склад", Строка.Склад);
		СтрокаДанных.Вставить("Заказано", Строка.Заказано);
		СтрокаДанных.Вставить("КОформлению", Строка.КОформлению);
		СтрокаДанных.Вставить("КПоступлению", Строка.КПоступлению);
		СтрокаДанных.Вставить("Сумма", Строка.Сумма);
		МассивОстатков.Добавить(СтрокаДанных);
	КонецЦикла;
	
	Возврат МассивОстатков;
	
КонецФункции

// Получает состояние расчетов по заказу
Функция ПолучитьСостояниеРасчетов(ЗаказСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Остатки.Валюта.Наименование КАК Валюта,
		|	ЕСТЬNULL(Остатки.СуммаОстаток, 0) КАК Сумма,
		|	ЕСТЬNULL(Остатки.ОплачиваетсяОстаток, 0) КАК Оплачивается,
		|	ЕСТЬNULL(Остатки.КОплатеОстаток, 0) КАК КОплате,
		|	ЕСТЬNULL(Остатки.КПоступлениюОстаток, 0) КАК КПоступлению
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.Остатки(, ОбъектРасчетов.Объект = &Заказ) КАК Остатки";
	
	Запрос.УстановитьПараметр("Заказ", ЗаказСсылка);
	
	Результат = Запрос.Выполнить();
	Таблица = Результат.Выгрузить();
	
	РасчетыСводно = Новый Структура;
	РасчетыСводно.Вставить("Валюта", "");
	РасчетыСводно.Вставить("Сумма", 0);
	РасчетыСводно.Вставить("Оплачивается", 0);
	РасчетыСводно.Вставить("КОплате", 0);
	РасчетыСводно.Вставить("КПоступлению", 0);
	
	Если Таблица.Количество() > 0 Тогда
		Строка = Таблица[0];
		РасчетыСводно.Валюта = Строка.Валюта;
		РасчетыСводно.Сумма = Строка.Сумма;
		РасчетыСводно.Оплачивается = Строка.Оплачивается;
		РасчетыСводно.КОплате = Строка.КОплате;
		РасчетыСводно.КПоступлению = Строка.КПоступлению;
	КонецЕсли;
	
	// Также получим обороты по документам (оплаты)
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Обороты.Валюта.Наименование КАК Валюта,
		|	ЕСТЬNULL(Обороты.КОплатеПриход, 0) КАК Оплачено,
		|	ЕСТЬNULL(Обороты.КПоступлениюРасход, 0) КАК Поступило
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.ОстаткиИОбороты(, , , , ОбъектРасчетов.Объект = &Заказ) КАК Обороты";
	
	Результат = Запрос.Выполнить();
	Таблица = Результат.Выгрузить();
	
	Если Таблица.Количество() > 0 Тогда
		Строка = Таблица[0];
		РасчетыСводно.Вставить("Оплачено", Строка.Оплачено);
		РасчетыСводно.Вставить("Поступило", Строка.Поступило);
	Иначе
		РасчетыСводно.Вставить("Оплачено", 0);
		РасчетыСводно.Вставить("Поступило", 0);
	КонецЕсли;
	
	Возврат РасчетыСводно;
	
КонецФункции

// Получает документы поступления по заказу
Функция ПолучитьДокументыПоступления(ЗаказСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	""ПриобретениеТоваровУслуг"" КАК ТипДокумента,
		|	Товары.Ссылка КАК Документ,
		|	Товары.Ссылка.Номер КАК Номер,
		|	Товары.Ссылка.Дата КАК Дата,
		|	Товары.Ссылка.Проведен КАК Проведен,
		|	СУММА(Товары.Количество) КАК Количество,
		|	СУММА(Товары.Сумма) КАК Сумма
		|ИЗ
		|	Документ.ПриобретениеТоваровУслуг.Товары КАК Товары
		|ГДЕ
		|	Товары.ЗаказПоставщику = &Заказ
		|СГРУППИРОВАТЬ ПО
		|	Товары.Ссылка,
		|	Товары.Ссылка.Номер,
		|	Товары.Ссылка.Дата,
		|	Товары.Ссылка.Проведен
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	""ПоступлениеТоваровНаСклад"",
		|	Товары.Ссылка,
		|	Товары.Ссылка.Номер,
		|	Товары.Ссылка.Дата,
		|	Товары.Ссылка.Проведен,
		|	СУММА(Товары.Количество),
		|	СУММА(Товары.Сумма)
		|ИЗ
		|	Документ.ПоступлениеТоваровНаСклад.Товары КАК Товары
		|ГДЕ
		|	Товары.ЗаказПоставщику = &Заказ
		|СГРУППИРОВАТЬ ПО
		|	Товары.Ссылка,
		|	Товары.Ссылка.Номер,
		|	Товары.Ссылка.Дата,
		|	Товары.Ссылка.Проведен
		|
		|УПОРЯДОЧИТЬ ПО
		|	Дата";
	
	Запрос.УстановитьПараметр("Заказ", ЗаказСсылка);
	
	Попытка
		Результат = Запрос.Выполнить();
		Таблица = Результат.Выгрузить();
	Исключение
		// Если документ ПоступлениеТоваровНаСклад не существует, попробуем без него
		Запрос.Текст = 
			"ВЫБРАТЬ РАЗЛИЧНЫЕ
			|	""ПриобретениеТоваровУслуг"" КАК ТипДокумента,
			|	Товары.Ссылка КАК Документ,
			|	Товары.Ссылка.Номер КАК Номер,
			|	Товары.Ссылка.Дата КАК Дата,
			|	Товары.Ссылка.Проведен КАК Проведен,
			|	СУММА(Товары.Количество) КАК Количество,
			|	СУММА(Товары.Сумма) КАК Сумма
			|ИЗ
			|	Документ.ПриобретениеТоваровУслуг.Товары КАК Товары
			|ГДЕ
			|	Товары.ЗаказПоставщику = &Заказ
			|СГРУППИРОВАТЬ ПО
			|	Товары.Ссылка,
			|	Товары.Ссылка.Номер,
			|	Товары.Ссылка.Дата,
			|	Товары.Ссылка.Проведен
			|УПОРЯДОЧИТЬ ПО
			|	Дата";
		
		Результат = Запрос.Выполнить();
		Таблица = Результат.Выгрузить();
	КонецПопытки;
	
	МассивДокументов = Новый Массив;
	Для Каждого Строка Из Таблица Цикл
		СтрокаДанных = Новый Структура;
		СтрокаДанных.Вставить("ТипДокумента", Строка.ТипДокумента);
		СтрокаДанных.Вставить("Документ", Строка(Строка.Документ));
		СтрокаДанных.Вставить("Номер", Строка.Номер);
		СтрокаДанных.Вставить("Дата", Строка.Дата);
		СтрокаДанных.Вставить("Проведен", Строка.Проведен);
		СтрокаДанных.Вставить("Количество", Строка.Количество);
		СтрокаДанных.Вставить("Сумма", Строка.Сумма);
		МассивДокументов.Добавить(СтрокаДанных);
	КонецЦикла;
	
	Возврат МассивДокументов;
	
КонецФункции

// Формирует JSON ответ
// Преобразует все даты в строки ISO для корректной JSON сериализации
Функция СформироватьJSONОтвет(Результат)
	
	// Преобразуем результат для JSON сериализации (даты -> строки)
	РезультатДляJSON = ПреобразоватьДляJSON(Результат);
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, РезультатДляJSON);
	ТекстJSON = ЗаписьJSON.Закрыть();
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", ТекстJSON);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

// Рекурсивно преобразует структуру для JSON сериализации
// Даты -> строки ISO, пустые даты -> пустые строки
Функция ПреобразоватьДляJSON(Значение)
	
	ТипЗначения = ТипЗнч(Значение);
	
	Если ТипЗначения = Тип("Структура") Тогда
		НоваяСтруктура = Новый Структура;
		Для Каждого КлючЗначение Из Значение Цикл
			НоваяСтруктура.Вставить(КлючЗначение.Ключ, ПреобразоватьДляJSON(КлючЗначение.Значение));
		КонецЦикла;
		Возврат НоваяСтруктура;
		
	ИначеЕсли ТипЗначения = Тип("Массив") Тогда
		НовыйМассив = Новый Массив;
		Для Каждого Элемент Из Значение Цикл
			НовыйМассив.Добавить(ПреобразоватьДляJSON(Элемент));
		КонецЦикла;
		Возврат НовыйМассив;
		
	ИначеЕсли ТипЗначения = Тип("Дата") Тогда
		Если ЗначениеЗаполнено(Значение) Тогда
			Возврат Формат(Значение, "ДФ=yyyy-MM-ddTHH:mm:ss");
		Иначе
			Возврат "";
		КонецЕсли;
		
	ИначеЕсли ТипЗначения = Тип("Булево") Тогда
		Возврат Значение;
		
	ИначеЕсли ТипЗначения = Тип("Число") Тогда
		Возврат Значение;
		
	ИначеЕсли ТипЗначения = Тип("Строка") Тогда
		Возврат Значение;
		
	ИначеЕсли Значение = Неопределено Тогда
		Возврат Null;
		
	Иначе
		// Для всех остальных типов - преобразуем в строку
		Возврат Строка(Значение);
	КонецЕсли;
	
КонецФункции

// Формирует Markdown ответ
Функция СформироватьMarkdownОтвет(Результат, ЗаказСсылка)
	
	Текст = "";
	
	// Заголовок
	Заголовок = Результат.Заголовок;
	Текст = Текст + "# Заказ поставщику " + Заголовок.Номер + " от " + Формат(Заголовок.Дата, "ДФ=dd.MM.yyyy") + Символы.ПС;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "## Основные реквизиты" + Символы.ПС;
	Текст = Текст + "| Реквизит | Значение |" + Символы.ПС;
	Текст = Текст + "| --- | --- |" + Символы.ПС;
	Текст = Текст + "| Статус | **" + Заголовок.Статус + "** |" + Символы.ПС;
	Текст = Текст + "| Проведен | " + ?(Заголовок.Проведен, "Да", "Нет") + " |" + Символы.ПС;
	Текст = Текст + "| Партнер | " + Заголовок.Партнер + " |" + Символы.ПС;
	Текст = Текст + "| Контрагент | " + Заголовок.Контрагент + " |" + Символы.ПС;
	Текст = Текст + "| Организация | " + Заголовок.Организация + " |" + Символы.ПС;
	Текст = Текст + "| Склад | " + Заголовок.Склад + " |" + Символы.ПС;
	Текст = Текст + "| Валюта | " + Заголовок.Валюта + " |" + Символы.ПС;
	Текст = Текст + "| Сумма документа | " + Формат(Заголовок.СуммаДокумента, "ЧДЦ=2") + " |" + Символы.ПС;
	Если ЗначениеЗаполнено(Заголовок.ЖелаемаяДатаПоступления) Тогда
		Текст = Текст + "| Желаемая дата поступления | " + Формат(Заголовок.ЖелаемаяДатаПоступления, "ДФ=dd.MM.yyyy") + " |" + Символы.ПС;
	КонецЕсли;
	
	// Состояние расчетов
	Расчеты = Результат.СостояниеРасчетов;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "## Состояние расчетов" + Символы.ПС;
	Текст = Текст + "| Показатель | Значение |" + Символы.ПС;
	Текст = Текст + "| --- | --- |" + Символы.ПС;
	Текст = Текст + "| К оплате | " + Формат(Расчеты.КОплате, "ЧДЦ=2") + " " + Расчеты.Валюта + " |" + Символы.ПС;
	Текст = Текст + "| Оплачено | " + Формат(?(Расчеты.Свойство("Оплачено"), Расчеты.Оплачено, 0), "ЧДЦ=2") + " " + Расчеты.Валюта + " |" + Символы.ПС;
	Текст = Текст + "| Оплачивается (в процессе) | " + Формат(Расчеты.Оплачивается, "ЧДЦ=2") + " " + Расчеты.Валюта + " |" + Символы.ПС;
	Текст = Текст + "| К поступлению (деньги) | " + Формат(Расчеты.КПоступлению, "ЧДЦ=2") + " " + Расчеты.Валюта + " |" + Символы.ПС;
	
	// Товары
	Товары = Результат.Товары;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "## Табличная часть ""Товары"" (" + Товары.Количество() + " строк)" + Символы.ПС;
	Текст = Текст + "| № | Код | Номенклатура | Кол-во | Цена | Сумма | Отменено |" + Символы.ПС;
	Текст = Текст + "| --- | --- | --- | ---: | ---: | ---: | --- |" + Символы.ПС;
	Для Каждого Строка Из Товары Цикл
		Текст = Текст + "| " + Строка.НомерСтроки + " | " + Строка.КодСтроки + " | " + 
			СокрЛП(Строка.Номенклатура) + " | " + 
			Формат(Строка.Количество, "ЧДЦ=3") + " | " +
			Формат(Строка.Цена, "ЧДЦ=2") + " | " +
			Формат(Строка.Сумма, "ЧДЦ=2") + " | " +
			?(Строка.Отменено, "**Да**", "Нет") + " |" + Символы.ПС;
	КонецЦикла;
	
	// Остатки по заказу
	Остатки = Результат.ОстаткиЗаказа;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "## Остатки по регистру ""Заказы поставщикам""" + Символы.ПС;
	Если Остатки.Количество() = 0 Тогда
		Текст = Текст + "*Остатков нет — все позиции поступили или отменены*" + Символы.ПС;
	Иначе
		Текст = Текст + "| Код | Номенклатура | Заказано | К оформлению | К поступлению |" + Символы.ПС;
		Текст = Текст + "| --- | --- | ---: | ---: | ---: |" + Символы.ПС;
		Для Каждого Строка Из Остатки Цикл
			Текст = Текст + "| " + Строка.КодСтроки + " | " + 
				СокрЛП(Строка.Номенклатура) + " | " + 
				Формат(Строка.Заказано, "ЧДЦ=3") + " | " +
				Формат(Строка.КОформлению, "ЧДЦ=3") + " | " +
				Формат(Строка.КПоступлению, "ЧДЦ=3") + " |" + Символы.ПС;
		КонецЦикла;
	КонецЕсли;
	
	// Документы поступления
	ДокументыПоступления = Результат.ДокументыПоступления;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "## Документы поступления" + Символы.ПС;
	Если ДокументыПоступления.Количество() = 0 Тогда
		Текст = Текст + "*Документов поступления нет*" + Символы.ПС;
	Иначе
		Текст = Текст + "| Тип | Номер | Дата | Проведен | Количество | Сумма |" + Символы.ПС;
		Текст = Текст + "| --- | --- | --- | --- | ---: | ---: |" + Символы.ПС;
		Для Каждого Строка Из ДокументыПоступления Цикл
			Текст = Текст + "| " + Строка.ТипДокумента + " | " + 
				Строка.Номер + " | " +
				Формат(Строка.Дата, "ДФ=dd.MM.yyyy") + " | " +
				?(Строка.Проведен, "Да", "Нет") + " | " +
				Формат(Строка.Количество, "ЧДЦ=3") + " | " +
				Формат(Строка.Сумма, "ЧДЦ=2") + " |" + Символы.ПС;
		КонецЦикла;
	КонецЕсли;
	
	// Вывод
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", Текст);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

