#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт

	ДобавитьИнструментЧтенияЖурналаРегистрации(Инструменты);

КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Попытка
		Если ИмяИнструмента = "read_event_log" Тогда
			Возврат ПрочитатьЖурналРегистрации(Аргументы);
		Иначе
			Возврат СформироватьОтветСОшибкой("Неизвестный инструмент: " + ИмяИнструмента);
		КонецЕсли;
	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());

		СообщениеОшибки = СтрШаблон("Ошибка выполнения инструмента '%1': %2",
			ИмяИнструмента,
			ОписаниеОшибкиТекст);

		Попытка
			ЗаписьЖурналаРегистрации("MCP." + ИмяИнструмента, УровеньЖурналаРегистрации.Ошибка, , ,
				СообщениеОшибки + Символы.ПС + ПодробноеОписание);
		Исключение
			ОшибкаЛогирования = ОписаниеОшибки();
		КонецПопытки;

		Возврат СформироватьОтветСОшибкой(СообщениеОшибки + Символы.ПС + ПодробноеОписание);
	КонецПопытки;

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СформироватьОтветСОшибкой(ТекстОшибки)

	МассивСодержимого = Новый Массив;

	СодержимоеОшибки = Новый Структура;
	СодержимоеОшибки.Вставить("type", "text");
	СодержимоеОшибки.Вставить("text", "ОШИБКА: " + ТекстОшибки);
	СодержимоеОшибки.Вставить("isError", Истина);

	МассивСодержимого.Добавить(СодержимоеОшибки);

	Возврат МассивСодержимого;

КонецФункции

Процедура ДобавитьИнструментЧтенияЖурналаРегистрации(Инструменты)

	МассивПараметров = Новый Массив;

	// Начало периода (обязательный)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"startDate",
		"string",
		"Начало периода (формат: 'YYYY-MM-DD' или 'YYYY-MM-DDTHH:MM:SS'). Обязательный параметр.",
		,
		Истина
	));

	// Конец периода (обязательный)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"endDate",
		"string",
		"Конец периода (формат: 'YYYY-MM-DD' или 'YYYY-MM-DDTHH:MM:SS'). Обязательный параметр.",
		,
		Истина
	));

	// Уровень журнала
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"level",
		"string",
		"Фильтр по уровню события: 'Ошибка', 'Предупреждение', 'Информация', 'Примечание'. Можно указать несколько через запятую. Если не указан — все уровни.",
		,
		Ложь
	));

	// Событие
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"event",
		"string",
		"Фильтр по имени события (точное совпадение или подстрока). Например: '_ДемijонтажОборудования', 'Проведение'. Можно указать несколько через запятую."
	));

	// Поиск по комментарию
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"comment",
		"string",
		"Поиск подстроки в комментарии записи журнала. Регистронезависимый поиск."
	));

	// Метаданные (фильтр по объекту метаданных)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"metadata",
		"string",
		"Фильтр по объекту метаданных. Формат: 'ТипОбъекта.ИмяОбъекта', например 'Документ.ЭтапПроизводства2_2', 'РегистрНакопления.А1_МатСоставИзделий_Расш1'. Можно указать несколько через запятую."
	));

	// Представление данных
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"dataPresentation",
		"string",
		"Поиск подстроки в представлении данных. Например, номер документа."
	));

	// Пользователь
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"user",
		"string",
		"Фильтр по имени пользователя (поиск подстроки в имени)."
	));

	// Максимальное количество строк
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"maxRows",
		"number",
		"Максимальное количество записей в результате (по умолчанию 200, максимум 5000)",
		200
	));

	// Формат
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"format",
		"string",
		"Формат результата: 'markdown' (удобочитаемая таблица) или 'json' (структурированные данные). По умолчанию 'markdown'",
		"markdown",
		Ложь,
		"markdown,json"
	));

	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);

	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"read_event_log",
		"Чтение журнала регистрации 1С:Предприятие. Позволяет получать записи журнала с фильтрацией по периоду, уровню (Ошибка/Предупреждение/Информация/Примечание), событию, метаданным, пользователю и комментарию. Полезно для диагностики ошибок, анализа действий пользователей и отслеживания проведения документов.",
		СхемаПараметров
	);

КонецПроцедуры

Функция ПрочитатьЖурналРегистрации(Аргументы)

	// Нормализуем аргументы
	Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
		АргументыСтруктура = Новый Структура;
		Для Каждого КлючЗначение Из Аргументы Цикл
			АргументыСтруктура.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
		Аргументы = АргументыСтруктура;
	КонецЕсли;

	// Получаем параметры
	НачалоПериодаСтрока = Аргументы.startDate;
	КонецПериодаСтрока = Аргументы.endDate;
	МаксСтрок = ?(Аргументы.Свойство("maxRows") И ЗначениеЗаполнено(Аргументы.maxRows), Аргументы.maxRows, 200);
	ФорматРезультата = ?(Аргументы.Свойство("format") И ЗначениеЗаполнено(Аргументы.format), НРег(Аргументы.format), "markdown");

	Если МаксСтрок > 5000 Тогда
		МаксСтрок = 5000;
	КонецЕсли;

	// Парсим даты
	НачалоПериода = РазобратьДату(НачалоПериодаСтрока);
	КонецПериода = РазобратьДату(КонецПериодаСтрока);

	Если НЕ ЗначениеЗаполнено(НачалоПериода) Тогда
		Возврат СформироватьОтветСОшибкой("Не удалось разобрать дату начала периода: " + НачалоПериодаСтрока);
	КонецЕсли;
	Если НЕ ЗначениеЗаполнено(КонецПериода) Тогда
		Возврат СформироватьОтветСОшибкой("Не удалось разобрать дату конца периода: " + КонецПериодаСтрока);
	КонецЕсли;

	// Если передана только дата без времени — устанавливаем конец дня
	Если КонецПериода = НачалоДня(КонецПериода) Тогда
		КонецПериода = КонецДня(КонецПериода);
	КонецЕсли;

	// Формируем отбор
	Отбор = Новый Структура;
	Отбор.Вставить("НачалоПериода", НачалоПериода);
	Отбор.Вставить("КонецПериода", КонецПериода);

	// Фильтр по уровню
	Если Аргументы.Свойство("level") И ЗначениеЗаполнено(Аргументы.level) Тогда
		МассивУровней = Новый Массив;
		ЧастиСтроки = СтрРазделить(Аргументы.level, ",", Ложь);
		Для Каждого ЧастьСтроки Из ЧастиСтроки Цикл
			Уровень = ПолучитьУровеньЖурнала(СокрЛП(ЧастьСтроки));
			Если Уровень <> Неопределено Тогда
				МассивУровней.Добавить(Уровень);
			КонецЕсли;
		КонецЦикла;
		Если МассивУровней.Количество() > 0 Тогда
			Отбор.Вставить("Уровень", МассивУровней);
		КонецЕсли;
	КонецЕсли;

	// Фильтр по событию
	Если Аргументы.Свойство("event") И ЗначениеЗаполнено(Аргументы.event) Тогда
		МассивСобытий = Новый Массив;
		ЧастиСтроки = СтрРазделить(Аргументы.event, ",", Ложь);
		Для Каждого ЧастьСтроки Из ЧастиСтроки Цикл
			МассивСобытий.Добавить(СокрЛП(ЧастьСтроки));
		КонецЦикла;
		Если МассивСобытий.Количество() > 0 Тогда
			Отбор.Вставить("Событие", МассивСобытий);
		КонецЕсли;
	КонецЕсли;

	// Фильтр по метаданным
	Если Аргументы.Свойство("metadata") И ЗначениеЗаполнено(Аргументы.metadata) Тогда
		МассивМетаданных = Новый Массив;
		ЧастиСтроки = СтрРазделить(Аргументы.metadata, ",", Ложь);
		Для Каждого ЧастьСтроки Из ЧастиСтроки Цикл
			МД = НайтиМетаданныеПоИмени(СокрЛП(ЧастьСтроки));
			Если МД <> Неопределено Тогда
				МассивМетаданных.Добавить(МД);
			КонецЕсли;
		КонецЦикла;
		Если МассивМетаданных.Количество() > 0 Тогда
			Отбор.Вставить("Метаданные", МассивМетаданных);
		КонецЕсли;
	КонецЕсли;

	// Фильтр по представлению данных
	Если Аргументы.Свойство("dataPresentation") И ЗначениеЗаполнено(Аргументы.dataPresentation) Тогда
		Отбор.Вставить("ДанныеПредставление", Аргументы.dataPresentation);
	КонецЕсли;

	// Выгружаем журнал регистрации (без указания колонок — платформа вернёт все доступные)
	ТаблицаЖурнала = Новый ТаблицаЗначений;
	ВыгрузитьЖурналРегистрации(ТаблицаЖурнала, Отбор);
	
	// Сортируем по дате убывания, чтобы свежие записи были первыми
	ТаблицаЖурнала.Сортировать("Дата УБЫВ");

	// Фильтруем по комментарию (постфильтр)
	ФильтрКомментарий = "";
	Если Аргументы.Свойство("comment") И ЗначениеЗаполнено(Аргументы.comment) Тогда
		ФильтрКомментарий = НРег(Аргументы.comment);
	КонецЕсли;

	// Фильтруем по пользователю (постфильтр)
	ФильтрПользователь = "";
	Если Аргументы.Свойство("user") И ЗначениеЗаполнено(Аргументы.user) Тогда
		ФильтрПользователь = НРег(Аргументы.user);
	КонецЕсли;

	// Формируем результат с учетом постфильтров и ограничения строк
	МассивСодержимого = Новый Массив;

	Если ФорматРезультата = "json" Тогда
		РезультатJSON = СформироватьРезультатJSON(ТаблицаЖурнала, МаксСтрок, ФильтрКомментарий, ФильтрПользователь);
		МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(РезультатJSON));
	Иначе
		РезультатMarkdown = СформироватьРезультатMarkdown(ТаблицаЖурнала, МаксСтрок, ФильтрКомментарий, ФильтрПользователь);
		МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(РезультатMarkdown));
	КонецЕсли;

	Возврат МассивСодержимого;

КонецФункции

Функция СформироватьРезультатJSON(ТаблицаЖурнала, МаксСтрок, ФильтрКомментарий, ФильтрПользователь)

	Результат = Новый Структура;
	Результат.Вставить("columns", Новый Массив);
	Результат.columns.Добавить("Дата");
	Результат.columns.Добавить("Пользователь");
	Результат.columns.Добавить("Уровень");
	Результат.columns.Добавить("Событие");
	Результат.columns.Добавить("Метаданные");
	Результат.columns.Добавить("Данные");
	Результат.columns.Добавить("Комментарий");
	Результат.columns.Добавить("Приложение");

	МассивСтрок = Новый Массив;
	Счетчик = 0;
	ПропущеноФильтром = 0;

	Для Каждого СтрокаЖурнала Из ТаблицаЖурнала Цикл

		// Постфильтр по комментарию
		Если ЗначениеЗаполнено(ФильтрКомментарий) Тогда
			Если СтрНайти(НРег(СтрокаЖурнала.Комментарий), ФильтрКомментарий) = 0 Тогда
				ПропущеноФильтром = ПропущеноФильтром + 1;
				Продолжить;
			КонецЕсли;
		КонецЕсли;

		// Постфильтр по пользователю
		Если ЗначениеЗаполнено(ФильтрПользователь) Тогда
			Если СтрНайти(НРег(Строка(СтрокаЖурнала.Пользователь)), ФильтрПользователь) = 0 Тогда
				ПропущеноФильтром = ПропущеноФильтром + 1;
				Продолжить;
			КонецЕсли;
		КонецЕсли;

		Счетчик = Счетчик + 1;
		Если Счетчик > МаксСтрок Тогда
			Прервать;
		КонецЕсли;

		СтрокаРезультата = Новый Структура;
		СтрокаРезультата.Вставить("Дата", Формат(СтрокаЖурнала.Дата, "ДФ='yyyy-MM-dd HH:mm:ss'"));
		СтрокаРезультата.Вставить("Пользователь", Строка(СтрокаЖурнала.Пользователь));
		СтрокаРезультата.Вставить("Уровень", ПредставлениеУровняЖурнала(СтрокаЖурнала.Уровень));
		СтрокаРезультата.Вставить("Событие", СтрокаЖурнала.Событие);
		СтрокаРезультата.Вставить("Метаданные", ЗначениеКолонки(ТаблицаЖурнала, СтрокаЖурнала, "МетаданныеПредставление", "Метаданные"));
		СтрокаРезультата.Вставить("Данные", ЗначениеКолонки(ТаблицаЖурнала, СтрокаЖурнала, "ДанныеПредставление", "Данные"));
		СтрокаРезультата.Вставить("Комментарий", СтрокаЖурнала.Комментарий);
		СтрокаРезультата.Вставить("Приложение", ЗначениеКолонки(ТаблицаЖурнала, СтрокаЖурнала, "ИмяПриложения", "ПредставлениеПриложения"));

		МассивСтрок.Добавить(СтрокаРезультата);

	КонецЦикла;

	Результат.Вставить("rows", МассивСтрок);
	Результат.Вставить("totalInLog", ТаблицаЖурнала.Количество());
	Результат.Вставить("returned", МассивСтрок.Количество());
	Результат.Вставить("filteredOut", ПропущеноФильтром);

	Если Счетчик > МаксСтрок Тогда
		Результат.Вставить("truncated", Истина);
		Результат.Вставить("maxRows", МаксСтрок);
	КонецЕсли;

	Возврат mcp_ОбщегоНазначения.СтруктураВJSON(Результат);

КонецФункции

Функция СформироватьРезультатMarkdown(ТаблицаЖурнала, МаксСтрок, ФильтрКомментарий, ФильтрПользователь)

	Результат = "";
	Счетчик = 0;
	ПропущеноФильтром = 0;

	Результат = Результат + "| Дата | Пользователь | Уровень | Событие | Метаданные | Данные | Комментарий |" + Символы.ПС;
	Результат = Результат + "| --- | --- | --- | --- | --- | --- | --- |" + Символы.ПС;

	Для Каждого СтрокаЖурнала Из ТаблицаЖурнала Цикл

		// Постфильтр по комментарию
		Если ЗначениеЗаполнено(ФильтрКомментарий) Тогда
			Если СтрНайти(НРег(СтрокаЖурнала.Комментарий), ФильтрКомментарий) = 0 Тогда
				ПропущеноФильтром = ПропущеноФильтром + 1;
				Продолжить;
			КонецЕсли;
		КонецЕсли;

		// Постфильтр по пользователю
		Если ЗначениеЗаполнено(ФильтрПользователь) Тогда
			Если СтрНайти(НРег(Строка(СтрокаЖурнала.Пользователь)), ФильтрПользователь) = 0 Тогда
				ПропущеноФильтром = ПропущеноФильтром + 1;
				Продолжить;
			КонецЕсли;
		КонецЕсли;

		Счетчик = Счетчик + 1;
		Если Счетчик > МаксСтрок Тогда
			Прервать;
		КонецЕсли;

		// Обрезаем комментарий для таблицы
		Комментарий = СтрокаЖурнала.Комментарий;
		Комментарий = СтрЗаменить(Комментарий, Символы.ПС, " ");
		Комментарий = СтрЗаменить(Комментарий, Символы.ВК, "");
		Комментарий = СтрЗаменить(Комментарий, "|", "\|");
		Если СтрДлина(Комментарий) > 200 Тогда
			Комментарий = Лев(Комментарий, 200) + "...";
		КонецЕсли;

		Результат = Результат + СтрШаблон("| %1 | %2 | %3 | %4 | %5 | %6 | %7 |",
			Формат(СтрокаЖурнала.Дата, "ДФ='yyyy-MM-dd HH:mm:ss'"),
			Строка(СтрокаЖурнала.Пользователь),
			ПредставлениеУровняЖурнала(СтрокаЖурнала.Уровень),
			СтрокаЖурнала.Событие,
			ЗначениеКолонки(ТаблицаЖурнала, СтрокаЖурнала, "МетаданныеПредставление", "Метаданные"),
			ЗначениеКолонки(ТаблицаЖурнала, СтрокаЖурнала, "ДанныеПредставление", "Данные"),
			Комментарий) + Символы.ПС;

	КонецЦикла;

	// Добавляем статистику
	Результат = Результат + Символы.ПС;
	Результат = Результат + СтрШаблон("*Всего записей в журнале за период: %1. Выведено: %2.*",
		ТаблицаЖурнала.Количество(), Мин(Счетчик, МаксСтрок));

	Если ПропущеноФильтром > 0 Тогда
		Результат = Результат + СтрШаблон(" *Отфильтровано: %1.*", ПропущеноФильтром);
	КонецЕсли;

	Если Счетчик > МаксСтрок Тогда
		Результат = Результат + СтрШаблон(" *Результат обрезан до %1 строк.*", МаксСтрок);
	КонецЕсли;

	Если ТаблицаЖурнала.Количество() = 0 Тогда
		Результат = "*Запрос выполнен успешно. Записей не найдено.*";
	КонецЕсли;

	Возврат Результат;

КонецФункции

// Преобразует строку уровня в значение перечисления
Функция ПолучитьУровеньЖурнала(СтрокаУровня)

	СтрокаУровняНижний = НРег(СокрЛП(СтрокаУровня));

	Если СтрокаУровняНижний = "ошибка" ИЛИ СтрокаУровняНижний = "error" Тогда
		Возврат УровеньЖурналаРегистрации.Ошибка;
	ИначеЕсли СтрокаУровняНижний = "предупреждение" ИЛИ СтрокаУровняНижний = "warning" Тогда
		Возврат УровеньЖурналаРегистрации.Предупреждение;
	ИначеЕсли СтрокаУровняНижний = "информация" ИЛИ СтрокаУровняНижний = "information" ИЛИ СтрокаУровняНижний = "info" Тогда
		Возврат УровеньЖурналаРегистрации.Информация;
	ИначеЕсли СтрокаУровняНижний = "примечание" ИЛИ СтрокаУровняНижний = "note" Тогда
		Возврат УровеньЖурналаРегистрации.Примечание;
	КонецЕсли;

	Возврат Неопределено;

КонецФункции

// Преобразует уровень журнала в строковое представление
Функция ПредставлениеУровняЖурнала(Уровень)

	Если Уровень = УровеньЖурналаРегистрации.Ошибка Тогда
		Возврат "Ошибка";
	ИначеЕсли Уровень = УровеньЖурналаРегистрации.Предупреждение Тогда
		Возврат "Предупреждение";
	ИначеЕсли Уровень = УровеньЖурналаРегистрации.Информация Тогда
		Возврат "Информация";
	ИначеЕсли Уровень = УровеньЖурналаРегистрации.Примечание Тогда
		Возврат "Примечание";
	КонецЕсли;

	Возврат Строка(Уровень);

КонецФункции

// Разбирает строку даты в значение Дата
Функция РазобратьДату(СтрокаДаты)

	Попытка
		// Формат ISO: 2026-01-15T10:30:00
		Если СтрНайти(СтрокаДаты, "T") > 0 Тогда
			Возврат XMLЗначение(Тип("Дата"), СтрокаДаты);
		КонецЕсли;

		// Формат даты: 2026-01-15
		Если СтрДлина(СтрокаДаты) = 10 И Сред(СтрокаДаты, 5, 1) = "-" Тогда
			Год = Число(Лев(СтрокаДаты, 4));
			Месяц = Число(Сред(СтрокаДаты, 6, 2));
			День = Число(Прав(СтрокаДаты, 2));
			Возврат Дата(Год, Месяц, День);
		КонецЕсли;

		// Попытка через XML
		Возврат XMLЗначение(Тип("Дата"), СтрокаДаты);
	Исключение
		Возврат Неопределено;
	КонецПопытки;

КонецФункции

// Находит объект метаданных по строковому имени
Функция НайтиМетаданныеПоИмени(ИмяМетаданных)

	Попытка
		МД = Метаданные.НайтиПоПолномуИмени(ИмяМетаданных);
		Если МД <> Неопределено Тогда
			Возврат МД;
		КонецЕсли;

		// Пробуем с разными префиксами
		Префиксы = Новый Массив;
		Префиксы.Добавить("Справочник.");
		Префиксы.Добавить("Документ.");
		Префиксы.Добавить("РегистрНакопления.");
		Префиксы.Добавить("РегистрСведений.");
		Префиксы.Добавить("РегистрБухгалтерии.");
		Префиксы.Добавить("Обработка.");
		Префиксы.Добавить("Отчет.");
		Префиксы.Добавить("ПланВидовХарактеристик.");
		Префиксы.Добавить("ПланСчетов.");

		Для Каждого Префикс Из Префиксы Цикл
			МД = Метаданные.НайтиПоПолномуИмени(Префикс + ИмяМетаданных);
			Если МД <> Неопределено Тогда
				Возврат МД;
			КонецЕсли;
		КонецЦикла;
	Исключение
		Возврат Неопределено;
	КонецПопытки;

	Возврат Неопределено;

КонецФункции

// Безопасное получение значения колонки из строки таблицы журнала.
// Пробует основное имя колонки, затем альтернативное. Возвращает Строка().
Функция ЗначениеКолонки(ТаблицаЖурнала, СтрокаЖурнала, ИмяКолонки, АльтернативноеИмя = "")

	Если ТаблицаЖурнала.Колонки.Найти(ИмяКолонки) <> Неопределено Тогда
		Возврат Строка(СтрокаЖурнала[ИмяКолонки]);
	КонецЕсли;

	Если ЗначениеЗаполнено(АльтернативноеИмя) И ТаблицаЖурнала.Колонки.Найти(АльтернативноеИмя) <> Неопределено Тогда
		Возврат Строка(СтрокаЖурнала[АльтернативноеИмя]);
	КонецЕсли;

	Возврат "";

КонецФункции

#КонецОбласти