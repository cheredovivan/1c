#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт

	ДобавитьИнструментLSPЗапрос(Инструменты);

КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Если ИмяИнструмента = "lsp_request" Тогда
		Возврат ВыполнитьLSPЗапрос(Аргументы);
	Иначе
		ВызватьИсключение "Неизвестный инструмент: " + ИмяИнструмента;
	КонецЕсли;

КонецФункции

#КонецОбласти

#Область ИнструментLSPЗапрос

Процедура ДобавитьИнструментLSPЗапрос(Инструменты)

	// Создаем описания параметров для инструмента lsp_request
	МассивПараметров = Новый Массив;
	
	// Параметр method - LSP метод (textDocument/hover, textDocument/completion, etc.)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"method",
		"string",
		"Метод LSP (например: textDocument/hover, textDocument/completion, textDocument/signatureHelp)",
		Неопределено,
		Истина
	));
	
	// Параметр params - параметры LSP запроса (JSON объект в виде строки или структура)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"params",
		"string",
		"Параметры LSP запроса в формате JSON (строка) или структура",
		Неопределено,
		Ложь
	));
	
	// Параметр serverUrl - URL сервера LSP (если не указан, используется stdio через настройки)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"serverUrl",
		"string",
		"URL сервера LSP в формате http://host:port (опционально, по умолчанию используется stdio)",
		Неопределено,
		Ложь
	));
	
	// Создаем JSON-схему параметров
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	// Добавляем инструмент в таблицу
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"lsp_request",
		"Выполнение запроса к bsl-language-server через LSP (Language Server Protocol). Поддерживает методы textDocument/hover, textDocument/completion, textDocument/signatureHelp и другие.",
		СхемаПараметров
	);

КонецПроцедуры

Функция ВыполнитьLSPЗапрос(Аргументы)

	МетодLSP = Аргументы.method;
	ПараметрыЗапроса = Аргументы.params;
	URLСервера = ?(Аргументы.Свойство("serverUrl"), Аргументы.serverUrl, "");
	
	// Преобразуем параметры из строки JSON в структуру, если нужно
	Если ТипЗнч(ПараметрыЗапроса) = Тип("Строка") Тогда
		Попытка
		ПараметрыЗапроса = mcp_ОбщегоНазначения.JSONВСтруктуру(ПараметрыЗапроса);
	Исключение
		ВызватьИсключение СтрШаблон("Ошибка парсинга JSON параметров: %1", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;
	КонецЕсли;
	
	// Выполняем запрос через HTTP или stdio
	// Если URL не указан, используем локальный Python-прокси
	Если ЗначениеЗаполнено(URLСервера) Тогда
		Возврат ВыполнитьLSPЗапросHTTP(МетодLSP, ПараметрыЗапроса, URLСервера);
	Иначе
		// Используем локальный Python-прокси на порту 8000
		Возврат ВыполнитьLSPЗапросHTTP(МетодLSP, ПараметрыЗапроса, "http://127.0.0.1:8000/lsp/");
	КонецЕсли;

КонецФункции

Функция ВыполнитьLSPЗапросHTTP(МетодLSP, ПараметрыЗапроса, URLСервера)
	
	// Формируем JSON-RPC запрос
	ЗапросLSP = Новый Структура;
	ЗапросLSP.Вставить("jsonrpc", "2.0");
	ЗапросLSP.Вставить("id", Строка(Новый УникальныйИдентификатор()));
	ЗапросLSP.Вставить("method", МетодLSP);
	ЗапросLSP.Вставить("params", ПараметрыЗапроса);
	
	JSONЗапроса = mcp_ОбщегоНазначения.СтруктураВJSON(ЗапросLSP);
	
	// Разбираем URL для HTTP соединения
	ПараметрыURL = mcp_ОбщегоНазначения.РазобратьURL(URLСервера);
	
	// Выполняем HTTP запрос
	HTTPСоединение = Новый HTTPСоединение(ПараметрыURL.Хост, ПараметрыURL.Порт, , , 30, ?(ПараметрыURL.Схема = "https", Новый ЗащищенноеСоединениеOpenSSL(), Неопределено));
	HTTPЗапрос = Новый HTTPЗапрос(ПараметрыURL.Путь, JSONЗапроса);
	HTTPЗапрос.Заголовки.Вставить("Content-Type", "application/json; charset=utf-8");
	
	Попытка
		HTTPОтвет = HTTPСоединение.ВызватьHTTPМетод("POST", HTTPЗапрос);
		
		Если HTTPОтвет.КодСостояния <> 200 Тогда
			ВызватьИсключение СтрШаблон("LSP сервер вернул ошибку: %1 %2", HTTPОтвет.КодСостояния, HTTPОтвет.ПолучитьТелоКакСтроку());
		КонецЕсли;
		
		ТелоОтвета = HTTPОтвет.ПолучитьТелоКакСтроку();
		ОтветLSP = mcp_ОбщегоНазначения.JSONВСтруктуру(ТелоОтвета);
		
		// Проверяем наличие ошибки в ответе
		Если ОтветLSP.Свойство("error") Тогда
			ВызватьИсключение СтрШаблон("Ошибка LSP: %1 (код: %2)", ОтветLSP.error.message, ОтветLSP.error.code);
		КонецЕсли;
		
		// Возвращаем result из ответа
		Если ОтветLSP.Свойство("result") Тогда
			Возврат mcp_ОбщегоНазначения.СтруктураВJSON(ОтветLSP.result);
		Иначе
			Возврат "";
		КонецЕсли;
		
	Исключение
		ВызватьИсключение СтрШаблон("Ошибка выполнения HTTP запроса к LSP серверу: %1", ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;

КонецФункции

Функция ВыполнитьLSPЗапросStdio(МетодLSP, ПараметрыЗапроса)
	
	// Для stdio режима нужно запустить процесс bsl-language-server
	// Это требует настройки пути к серверу и работы с процессами
	// Пока возвращаем информацию о необходимости настройки
	
	// Функция не реализована, выбрасываем исключение
	ВызватьИсключение "Режим stdio для LSP пока не реализован. Используйте параметр serverUrl для HTTP режима или настройте путь к bsl-language-server в обработке.";

КонецФункции

#КонецОбласти

