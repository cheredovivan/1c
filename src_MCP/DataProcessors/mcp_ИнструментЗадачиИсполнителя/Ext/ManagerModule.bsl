#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт
	
	ДобавитьИнструментЗадачиИсполнителя(Инструменты);
	
КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт
	
	Попытка
		Если ИмяИнструмента = "task_manager" Тогда
			Возврат УправлениеЗадачами(Аргументы);
		Иначе
			Возврат СформироватьОтветСОшибкой("Неизвестный инструмент: " + ИмяИнструмента);
		КонецЕсли;
	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		СообщениеОшибки = СтрШаблон("Ошибка выполнения инструмента '%1': %2",
			ИмяИнструмента,
			ОписаниеОшибкиТекст);
		
		Попытка
			ЗаписьЖурналаРегистрации("MCP." + ИмяИнструмента, УровеньЖурналаРегистрации.Ошибка, , , 
				СообщениеОшибки + Символы.ПС + ПодробноеОписание);
		Исключение
			// BSLLS:EmptyCodeBlock-off
			// Ошибка логирования не должна прерывать основной поток
			// BSLLS:EmptyCodeBlock-on
		КонецПопытки;
		
		Возврат СформироватьОтветСОшибкой(СообщениеОшибки + Символы.ПС + ПодробноеОписание);
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СформироватьОтветСОшибкой(ТекстОшибки)
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", "ОШИБКА: " + ТекстОшибки);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Ответ.Вставить("isError", Истина);
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

#Область ИнструментЗадачиИсполнителя

Процедура ДобавитьИнструментЗадачиИсполнителя(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	// Параметр operation - операция (list, get, complete)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"operation",
		"string",
		"Операция: 'list' (список задач), 'get' (получение задачи), 'complete' (выполнение задачи)",
		,
		Истина,
		"list,get,complete"
	));
	
	// Параметр selector - идентификатор задачи (для get и complete)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"selector",
		"string",
		"Идентификатор задачи: номер (например 'УП-00000069001') или UUID. Обязателен для операций 'get' и 'complete'",
		,
		Ложь
	));
	
	// Параметры фильтрации для list
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"performer",
		"string",
		"Фильтр по исполнителю (поиск по наименованию). Применяется только для операции 'list'",
		,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"performer_uuid",
		"string",
		"UUID пользователя-исполнителя (точный поиск по ссылке). Приоритетнее performer. Применяется только для операции 'list'",
		,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"author",
		"string",
		"Фильтр по автору (поиск по наименованию). Применяется только для операции 'list'",
		,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"author_uuid",
		"string",
		"UUID пользователя-автора (точный поиск по ссылке). Приоритетнее author. Применяется только для операции 'list'",
		,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"completed",
		"string",
		"Фильтр по статусу выполнения: 'true' (выполненные), 'false' (невыполненные), 'all' (все). По умолчанию 'false'. Применяется только для операции 'list'",
		"false",
		Ложь,
		"true,false,all"
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"deadline_from",
		"string",
		"Начало периода срока исполнения (дата в формате ISO или 'YYYY-MM-DD'). Применяется только для операции 'list'",
		,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"deadline_to",
		"string",
		"Конец периода срока исполнения (дата в формате ISO или 'YYYY-MM-DD'). Применяется только для операции 'list'",
		,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"subject",
		"string",
		"Поиск по предмету задачи (наименование связанного объекта). Применяется только для операции 'list'",
		,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"result",
		"string",
		"Текст результата выполнения задачи. Применяется только для операции 'complete'",
		,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"maxRows",
		"number",
		"Максимальное количество строк в результате. По умолчанию 100, максимум 1000. Применяется только для операции 'list'",
		100,
		Ложь
	));
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"format",
		"string",
		"Формат результата: 'markdown' (удобочитаемые таблицы) или 'json' (структурированные данные). По умолчанию 'markdown'",
		"markdown",
		Ложь,
		"markdown,json"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"task_manager",
		"Управление задачами исполнителя: получение списка задач с фильтрами, получение детальной информации о задаче, выполнение задачи",
		СхемаПараметров
	);
	
КонецПроцедуры

Функция УправлениеЗадачами(Аргументы)
	
	УстановитьПривилегированныйРежим(Истина);
	
	// Преобразуем Соответствие в Структуру если нужно
	Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
		АргументыСтруктура = Новый Структура;
		Для Каждого КлючЗначение Из Аргументы Цикл
			АргументыСтруктура.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
		Аргументы = АргументыСтруктура;
	КонецЕсли;
	
	// Получаем параметры
	Операция = "";
	Если Аргументы.Свойство("operation") Тогда
		Операция = НРег(Аргументы.operation);
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Операция) Тогда
		Возврат СформироватьОтветСОшибкой("Не указана операция (operation)");
	КонецЕсли;
	
	ФорматРезультата = "markdown";
	Если Аргументы.Свойство("format") Тогда
		ФорматРезультата = НРег(Аргументы.format);
	КонецЕсли;
	
	Если Операция = "list" Тогда
		Возврат ПолучитьСписокЗадач(Аргументы, ФорматРезультата);
	ИначеЕсли Операция = "get" Тогда
		Возврат ПолучитьЗадачу(Аргументы, ФорматРезультата);
	ИначеЕсли Операция = "complete" Тогда
		Возврат ВыполнитьЗадачу(Аргументы, ФорматРезультата);
	Иначе
		Возврат СформироватьОтветСОшибкой("Неизвестная операция: " + Операция + ". Доступны: list, get, complete");
	КонецЕсли;
	
КонецФункции

// Получает список задач с фильтрами
Функция ПолучитьСписокЗадач(Аргументы, ФорматРезультата)
	
	Запрос = Новый Запрос;
	ТекстУсловий = "Задача.ПометкаУдаления = ЛОЖЬ";
	
	// Фильтр по статусу выполнения
	Выполнена = "false";
	Если Аргументы.Свойство("completed") Тогда
		Выполнена = НРег(Аргументы.completed);
	КонецЕсли;
	
	Если Выполнена = "true" Тогда
		ТекстУсловий = ТекстУсловий + " И Задача.Выполнена = ИСТИНА";
	ИначеЕсли Выполнена = "false" Тогда
		ТекстУсловий = ТекстУсловий + " И Задача.Выполнена = ЛОЖЬ";
	КонецЕсли;
	
	// Фильтр по исполнителю (UUID имеет приоритет над наименованием)
	Если Аргументы.Свойство("performer_uuid") И ЗначениеЗаполнено(Аргументы.performer_uuid) Тогда
		ИсполнительСсылка = НайтиПользователяПоUUID(Аргументы.performer_uuid);
		Если ИсполнительСсылка <> Неопределено Тогда
			ТекстУсловий = ТекстУсловий + " И Задача.Исполнитель = &Исполнитель";
			Запрос.УстановитьПараметр("Исполнитель", ИсполнительСсылка);
		Иначе
			// UUID не найден - вернём пустой результат
			ТекстУсловий = ТекстУсловий + " И ЛОЖЬ";
		КонецЕсли;
	ИначеЕсли Аргументы.Свойство("performer") И ЗначениеЗаполнено(Аргументы.performer) Тогда
		ТекстУсловий = ТекстУсловий + " И Задача.Исполнитель.Наименование ПОДОБНО &ИсполнительНаименование";
		Запрос.УстановитьПараметр("ИсполнительНаименование", "%" + Аргументы.performer + "%");
	КонецЕсли;
	
	// Фильтр по автору (UUID имеет приоритет над наименованием)
	Если Аргументы.Свойство("author_uuid") И ЗначениеЗаполнено(Аргументы.author_uuid) Тогда
		АвторСсылка = НайтиПользователяПоUUID(Аргументы.author_uuid);
		Если АвторСсылка <> Неопределено Тогда
			ТекстУсловий = ТекстУсловий + " И Задача.Автор = &Автор";
			Запрос.УстановитьПараметр("Автор", АвторСсылка);
		Иначе
			// UUID не найден - вернём пустой результат
			ТекстУсловий = ТекстУсловий + " И ЛОЖЬ";
		КонецЕсли;
	ИначеЕсли Аргументы.Свойство("author") И ЗначениеЗаполнено(Аргументы.author) Тогда
		ТекстУсловий = ТекстУсловий + " И Задача.Автор.Наименование ПОДОБНО &АвторНаименование";
		Запрос.УстановитьПараметр("АвторНаименование", "%" + Аргументы.author + "%");
	КонецЕсли;
	
	// Фильтр по сроку исполнения
	Если Аргументы.Свойство("deadline_from") И ЗначениеЗаполнено(Аргументы.deadline_from) Тогда
		ДатаОт = ПреобразоватьДатуИзСтроки(Аргументы.deadline_from);
		ТекстУсловий = ТекстУсловий + " И Задача.СрокИсполнения >= &СрокОт";
		Запрос.УстановитьПараметр("СрокОт", ДатаОт);
	КонецЕсли;
	
	Если Аргументы.Свойство("deadline_to") И ЗначениеЗаполнено(Аргументы.deadline_to) Тогда
		ДатаПо = ПреобразоватьДатуИзСтроки(Аргументы.deadline_to);
		ТекстУсловий = ТекстУсловий + " И Задача.СрокИсполнения <= &СрокПо";
		Запрос.УстановитьПараметр("СрокПо", ДатаПо);
	КонецЕсли;
	
	// Фильтр по предмету
	Если Аргументы.Свойство("subject") И ЗначениеЗаполнено(Аргументы.subject) Тогда
		ТекстУсловий = ТекстУсловий + " И Задача.ПредметСтрокой ПОДОБНО &Предмет";
		Запрос.УстановитьПараметр("Предмет", "%" + Аргументы.subject + "%");
	КонецЕсли;
	
	МаксСтрок = 100;
	Если Аргументы.Свойство("maxRows") И ТипЗнч(Аргументы.maxRows) = Тип("Число") Тогда
		МаксСтрок = Мин(Макс(Аргументы.maxRows, 1), 1000);
	КонецЕсли;
	
	Запрос.Текст = СтрШаблон(
		"ВЫБРАТЬ ПЕРВЫЕ %1
		|	Задача.Ссылка КАК Ссылка,
		|	Задача.Номер КАК Номер,
		|	Задача.Дата КАК Дата,
		|	Задача.Наименование КАК Наименование,
		|	Задача.Исполнитель.Наименование КАК Исполнитель,
		|	Задача.Автор.Наименование КАК Автор,
		|	Задача.ПредметСтрокой КАК Предмет,
		|	Задача.СрокИсполнения КАК СрокИсполнения,
		|	Задача.Выполнена КАК Выполнена,
		|	Задача.ДатаИсполнения КАК ДатаИсполнения,
		|	Задача.Описание КАК Описание,
		|	Задача.РезультатВыполнения КАК РезультатВыполнения,
		|	Задача.Важность КАК Важность
		|ИЗ
		|	Задача.ЗадачаИсполнителя КАК Задача
		|ГДЕ
		|	%2
		|УПОРЯДОЧИТЬ ПО
		|	Задача.СрокИсполнения УБЫВ,
		|	Задача.Дата УБЫВ", МаксСтрок, ТекстУсловий);
	
	Результат = Запрос.Выполнить();
	Таблица = Результат.Выгрузить();
	
	МассивЗадач = Новый Массив;
	Для Каждого Строка Из Таблица Цикл
		Задача = Новый Структура;
		Задача.Вставить("Номер", Строка.Номер);
		Задача.Вставить("Дата", Строка.Дата);
		Задача.Вставить("Наименование", Строка.Наименование);
		Задача.Вставить("Исполнитель", Строка.Исполнитель);
		Задача.Вставить("Автор", Строка.Автор);
		Задача.Вставить("Предмет", Строка.Предмет);
		Задача.Вставить("СрокИсполнения", Строка.СрокИсполнения);
		Задача.Вставить("Выполнена", Строка.Выполнена);
		Задача.Вставить("ДатаИсполнения", Строка.ДатаИсполнения);
		Задача.Вставить("Описание", Строка.Описание);
		Задача.Вставить("РезультатВыполнения", Строка.РезультатВыполнения);
		Задача.Вставить("Важность", Строка(Строка.Важность));
		МассивЗадач.Добавить(Задача);
	КонецЦикла;
	
	Если ФорматРезультата = "json" Тогда
		Возврат СформироватьJSONОтвет(МассивЗадач);
	Иначе
		Возврат СформироватьMarkdownОтветСписок(МассивЗадач);
	КонецЕсли;
	
КонецФункции

// Получает детальную информацию о задаче
Функция ПолучитьЗадачу(Аргументы, ФорматРезультата)
	
	Селектор = "";
	Если Аргументы.Свойство("selector") Тогда
		Селектор = Аргументы.selector;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Селектор) Тогда
		Возврат СформироватьОтветСОшибкой("Не указан селектор задачи (selector) для операции 'get'");
	КонецЕсли;
	
	ЗадачаСсылка = НайтиЗадачуПоСелектору(Селектор);
	
	Если ЗадачаСсылка = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой("Задача не найдена по селектору: " + Селектор);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Задача.Ссылка КАК Ссылка,
		|	Задача.Номер КАК Номер,
		|	Задача.Дата КАК Дата,
		|	Задача.Наименование КАК Наименование,
		|	Задача.Исполнитель.Наименование КАК Исполнитель,
		|	Задача.Автор.Наименование КАК Автор,
		|	Задача.ПредметСтрокой КАК Предмет,
		|	Задача.СрокИсполнения КАК СрокИсполнения,
		|	Задача.Выполнена КАК Выполнена,
		|	Задача.ДатаИсполнения КАК ДатаИсполнения,
		|	Задача.Описание КАК Описание,
		|	Задача.РезультатВыполнения КАК РезультатВыполнения,
		|	Задача.Важность КАК Важность,
		|	Задача.ПринятаКИсполнению КАК ПринятаКИсполнению,
		|	Задача.ДатаПринятияКИсполнению КАК ДатаПринятияКИсполнению,
		|	Задача.ДатаНачала КАК ДатаНачала
		|ИЗ
		|	Задача.ЗадачаИсполнителя КАК Задача
		|ГДЕ
		|	Задача.Ссылка = &Ссылка";
	
	Запрос.УстановитьПараметр("Ссылка", ЗадачаСсылка);
	
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат СформироватьОтветСОшибкой("Задача не найдена");
	КонецЕсли;
	
	Выборка = Результат.Выбрать();
	Выборка.Следующий();
	
	Задача = Новый Структура;
	Задача.Вставить("Номер", Выборка.Номер);
	Задача.Вставить("Дата", Выборка.Дата);
	Задача.Вставить("Наименование", Выборка.Наименование);
	Задача.Вставить("Исполнитель", Выборка.Исполнитель);
	Задача.Вставить("Автор", Выборка.Автор);
	Задача.Вставить("Предмет", Выборка.Предмет);
	Задача.Вставить("СрокИсполнения", Выборка.СрокИсполнения);
	Задача.Вставить("Выполнена", Выборка.Выполнена);
	Задача.Вставить("ДатаИсполнения", Выборка.ДатаИсполнения);
	Задача.Вставить("Описание", Выборка.Описание);
	Задача.Вставить("РезультатВыполнения", Выборка.РезультатВыполнения);
	Задача.Вставить("Важность", Строка(Выборка.Важность));
	Задача.Вставить("ПринятаКИсполнению", Выборка.ПринятаКИсполнению);
	Задача.Вставить("ДатаПринятияКИсполнению", Выборка.ДатаПринятияКИсполнению);
	Задача.Вставить("ДатаНачала", Выборка.ДатаНачала);
	
	Если ФорматРезультата = "json" Тогда
		Возврат СформироватьJSONОтвет(Задача);
	Иначе
		Возврат СформироватьMarkdownОтветЗадача(Задача);
	КонецЕсли;
	
КонецФункции

// Выполняет задачу
Функция ВыполнитьЗадачу(Аргументы, ФорматРезультата)
	
	Селектор = "";
	Если Аргументы.Свойство("selector") Тогда
		Селектор = Аргументы.selector;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(Селектор) Тогда
		Возврат СформироватьОтветСОшибкой("Не указан селектор задачи (selector) для операции 'complete'");
	КонецЕсли;
	
	ЗадачаСсылка = НайтиЗадачуПоСелектору(Селектор);
	
	Если ЗадачаСсылка = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой("Задача не найдена по селектору: " + Селектор);
	КонецЕсли;
	
	// Получаем объект задачи
	ЗадачаОбъект = ЗадачаСсылка.ПолучитьОбъект();
	
	Если ЗадачаОбъект.Выполнена Тогда
		Возврат СформироватьОтветСОшибкой("Задача уже выполнена");
	КонецЕсли;
	
	// Устанавливаем результат выполнения если указан
	Если Аргументы.Свойство("result") И ЗначениеЗаполнено(Аргументы.result) Тогда
		ЗадачаОбъект.РезультатВыполнения = Аргументы.result;
		// Записываем объект перед выполнением, чтобы сохранить результат
		Попытка
			ЗадачаОбъект.Записать();
		Исключение
			ИнформацияОбОшибке = ИнформацияОбОшибке();
			Возврат СформироватьОтветСОшибкой("Ошибка записи результата выполнения задачи: " + 
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		КонецПопытки;
	КонецЕсли;
	
	// Выполняем задачу через стандартный механизм
	Попытка
		БизнесПроцессыИЗадачиВызовСервера.ВыполнитьЗадачу(ЗадачаСсылка, Истина);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		Возврат СформироватьОтветСОшибкой("Ошибка выполнения задачи: " + 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Получаем обновленную информацию о задаче
	Возврат ПолучитьЗадачу(Аргументы, ФорматРезультата);
	
КонецФункции

// Ищет задачу по селектору (номер или UUID)
Функция НайтиЗадачуПоСелектору(Селектор)
	
	// Поиск по UUID
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			Возврат Задачи.ЗадачаИсполнителя.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
		Исключение
			// BSLLS:EmptyCodeBlock-off
			// Не UUID - продолжаем поиск по номеру
			// BSLLS:EmptyCodeBlock-on
		КонецПопытки;
	КонецЕсли;
	
	// Поиск по номеру
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Задача.Ссылка КАК Ссылка
		|ИЗ
		|	Задача.ЗадачаИсполнителя КАК Задача
		|ГДЕ
		|	Задача.Номер ПОДОБНО &Номер
		|УПОРЯДОЧИТЬ ПО
		|	Задача.Дата УБЫВ";
	
	Запрос.УстановитьПараметр("Номер", "%" + Селектор + "%");
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Формирует JSON ответ
Функция СформироватьJSONОтвет(Данные)
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Данные);
	ТекстJSON = ЗаписьJSON.Закрыть();
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", ТекстJSON);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

// Формирует Markdown ответ для списка задач
Функция СформироватьMarkdownОтветСписок(МассивЗадач)
	
	Текст = "# Список задач исполнителя" + Символы.ПС;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "Всего задач: **" + МассивЗадач.Количество() + "**" + Символы.ПС;
	Текст = Текст + Символы.ПС;
	
	Если МассивЗадач.Количество() = 0 Тогда
		Текст = Текст + "*Задач не найдено*" + Символы.ПС;
	Иначе
		Текст = Текст + "| № | Наименование | Исполнитель | Автор | Срок | Выполнена |" + Символы.ПС;
		Текст = Текст + "| --- | --- | --- | --- | --- | --- |" + Символы.ПС;
		
		Для Каждого Задача Из МассивЗадач Цикл
			Срок = "";
			Если ЗначениеЗаполнено(Задача.СрокИсполнения) Тогда
				Срок = Формат(Задача.СрокИсполнения, "ДФ=dd.MM.yyyy");
			КонецЕсли;
			
			Текст = Текст + "| " + Задача.Номер + " | " + 
				СокрЛП(Задача.Наименование) + " | " + 
				СокрЛП(Задача.Исполнитель) + " | " +
				СокрЛП(Задача.Автор) + " | " +
				Срок + " | " +
				?(Задача.Выполнена, "**Да**", "Нет") + " |" + Символы.ПС;
		КонецЦикла;
	КонецЕсли;
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", Текст);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

// Преобразует строку даты в формате ISO (YYYY-MM-DD) в дату
Функция ПреобразоватьДатуИзСтроки(СтрокаДаты)
	
	Попытка
		// Формат ISO: YYYY-MM-DD или YYYY-MM-DDTHH:MM:SS
		СтрокаДаты = СокрЛП(СтрокаДаты);
		
		// Убираем время если есть
		ПозицияT = СтрНайти(СтрокаДаты, "T");
		Если ПозицияT > 0 Тогда
			СтрокаДаты = Лев(СтрокаДаты, ПозицияT - 1);
		КонецЕсли;
		
		// Разбираем YYYY-MM-DD
		Части = СтрРазделить(СтрокаДаты, "-");
		Если Части.Количество() >= 3 Тогда
			Возврат Дата(Число(Части[0]), Число(Части[1]), Число(Части[2]));
		КонецЕсли;
		
		Возврат '00010101';
	Исключение
		Возврат '00010101';
	КонецПопытки;
	
КонецФункции

// Находит пользователя по UUID
Функция НайтиПользователяПоUUID(СтрокаUUID)
	
	Попытка
		УИД = Новый УникальныйИдентификатор(СтрокаUUID);
		Возврат Справочники.Пользователи.ПолучитьСсылку(УИД);
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
КонецФункции

// Формирует Markdown ответ для одной задачи
Функция СформироватьMarkdownОтветЗадача(Задача)
	
	Текст = "# Задача " + Задача.Номер + Символы.ПС;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "## Основные реквизиты" + Символы.ПС;
	Текст = Текст + "| Реквизит | Значение |" + Символы.ПС;
	Текст = Текст + "| --- | --- |" + Символы.ПС;
	Текст = Текст + "| Наименование | **" + Задача.Наименование + "** |" + Символы.ПС;
	Текст = Текст + "| Дата | " + Формат(Задача.Дата, "ДФ=dd.MM.yyyy HH:mm:ss") + " |" + Символы.ПС;
	Текст = Текст + "| Исполнитель | " + Задача.Исполнитель + " |" + Символы.ПС;
	Текст = Текст + "| Автор | " + Задача.Автор + " |" + Символы.ПС;
	
	Если ЗначениеЗаполнено(Задача.Предмет) Тогда
		Текст = Текст + "| Предмет | " + Задача.Предмет + " |" + Символы.ПС;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Задача.СрокИсполнения) Тогда
		Текст = Текст + "| Срок исполнения | " + Формат(Задача.СрокИсполнения, "ДФ=dd.MM.yyyy") + " |" + Символы.ПС;
	КонецЕсли;
	
	Текст = Текст + "| Выполнена | " + ?(Задача.Выполнена, "**Да**", "**Нет**") + " |" + Символы.ПС;
	
	Если Задача.Выполнена И ЗначениеЗаполнено(Задача.ДатаИсполнения) Тогда
		Текст = Текст + "| Дата исполнения | " + Формат(Задача.ДатаИсполнения, "ДФ=dd.MM.yyyy HH:mm:ss") + " |" + Символы.ПС;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Задача.Важность) Тогда
		Текст = Текст + "| Важность | " + Задача.Важность + " |" + Символы.ПС;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Задача.Описание) Тогда
		Текст = Текст + Символы.ПС;
		Текст = Текст + "## Описание" + Символы.ПС;
		Текст = Текст + Задача.Описание + Символы.ПС;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Задача.РезультатВыполнения) Тогда
		Текст = Текст + Символы.ПС;
		Текст = Текст + "## Результат выполнения" + Символы.ПС;
		Текст = Текст + Задача.РезультатВыполнения + Символы.ПС;
	КонецЕсли;
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", Текст);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

