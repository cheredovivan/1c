// Область "Настройки" описывает параметры инициализации механизма загрузки
// регламентированных отчетов из файлов выгрузки. Формат области настроек - JSON.
//
// Описание параметров:
//  * Установкой параметра "РазрешитьЗагрузку" в "true" или "false" регулируем видимость
//    кнопки "Загрузить" и возможность загрузки из файла в форме отчета.
//  * Параметр "ФорматыСхемВыгрузки" описывает соответствие имен макетов схем выгрузки
//    поддерживаемым форматам загрузки. Если у формы единственная схема выгрузки или
//    нужно всегда использовать схему по умолчанию - указываем значение "null".
//  * Параметр "ОбластиОбработчиков" содержит список имен используемых обработчиков
//    загружаемых данных. Имена соответствуют областям макета, в которых можно размещать
//    произвольные алгоритмы на языке "1С:Предприятие" для обработки доступных объектов.
//
// Примечание:
//  Сопоставление имен узлов из файла XML и имен показателей отчета выполняется по данным схемы выгрузки,
//  поэтому обработчики используются для получения значений показателей не описанных в схеме выгрузки.
//
#Область Настройки
{
	"РазрешитьЗагрузку"   : true,
	
	"ФорматыСхемВыгрузки" : {
		"СхемаВыгрузки520" : "5.20",
	},
	"ОбластиОбработчиков" : {
		"ПередЗагрузкой"  : "ПредОбработкаСхемыЗагрузки",
		"ПослеЗагрузки"   : "ПостОбработкаДокументаОтчета",
	}
}
#КонецОбласти

// Доступны параметры:
//
//  П.ДеревоДляЗагрузки - выбранное дерево схемы загрузки, не заполненное данными;
//  П.ПараметрыОтчета   - параметры, сформированные в форме отчета, используются для выгрузки.
//
#Область ПредОбработкаСхемыЗагрузки
	
	ДобавитьКолонкуВДеревоЕслиНеНайдена(П.ДеревоДляЗагрузки, "МнУр"); // для определения многоуровневых разделов
	
	НайденныеУзлы = УзлыПоXPath(П.ДеревоДляЗагрузки, "//Документ/НДФЛ3");
	
	Для Каждого НайденныйУзел Из НайденныеУзлы Цикл
		
		НайденныйУзел.МнУр = Истина;
		
		НайденныеУзлыИерархия = УзлыПоXPath(НайденныйУзел, "//node()"); // вся иерархия подчиненных узлов любого типа
		Для Каждого ТекущийУзел Из НайденныеУзлыИерархия Цикл
			ТекущийУзел.МнУр = Истина;
			
			Если ТекущийУзел.Ключ = "П10001М210003" Тогда
				ТекущийУзел.Ключ = "П00001М210003";
				ТекущийУзел.Обязательность = ТекущийУзел.Обязательность + "П";
			ИначеЕсли ТекущийУзел.Ключ = "П10001М213003" Тогда
				ТекущийУзел.Ключ = "П00001М213003";
				ТекущийУзел.Обязательность = ТекущийУзел.Обязательность + "П";
			ИначеЕсли ТекущийУзел.Ключ = "П10001М216003" Тогда
				ТекущийУзел.Ключ = "П00001М216003";
				ТекущийУзел.Обязательность = ТекущийУзел.Обязательность + "П";
			КонецЕсли;
		КонецЦикла;
		
	КонецЦикла;
	
#КонецОбласти

// Доступны параметры:
//
//  П.ДанныеОтчета      - заполненные данные документа регламентированного отчета;
//  П.ДеревоДляЗагрузки - выбранное дерево схемы загрузки, не заполненное данными;
//  П.ПараметрыОтчета   - параметры, сформированные в форме отчета, используются для выгрузки.
//
#Область ПостОбработкаДокументаОтчета
	
	Титульный = Неопределено;
	
	П.ДанныеОтчета.ПоказателиОтчета.Свойство("ПолеТабличногоДокументаТитульный", Титульный);
	Если Титульный <> Неопределено Тогда
		
		Титульный.Период         = П.ПараметрыОтчета.Период;
		Титульный.ОтчетГод       = П.ПараметрыОтчета.ОтчетГод;
		Титульный.НалоговыйОрган = П.ПараметрыОтчета.КодНО; 
		
		Титульный.КодКатегорииНалогоплательщика = П.ПараметрыОтчета.КодКатегории;
		Титульный.КодСтатусаНалогоплательщика   = П.ПараметрыОтчета.КодСтатуса; 
		
		Тлф = Неопределено;
		Если П.ПараметрыОтчета.Свойство("Тлф", Тлф) И Тлф <> Неопределено Тогда
			Титульный.НомерТелефона = СокрЛП(Тлф);
		КонецЕсли;
		
		Титульный.Фамилия = П.ПараметрыОтчета.Фамилия;
		Титульный.Имя     = П.ПараметрыОтчета.Имя;
		Отчество = Неопределено;
		Если П.ПараметрыОтчета.Свойство("Отчество", Отчество) И Отчество <> Неопределено Тогда
			Титульный.Отчество = СокрЛП(Отчество);
		КонецЕсли;
		
		ИННФЛ = Неопределено;
		Если П.ПараметрыОтчета.Свойство("ИННФЛ", ИННФЛ) И ИННФЛ <> Неопределено Тогда
			Титульный.ИНН = СокрЛП(ИННФЛ);
		КонецЕсли;
		ИдЕРН = Неопределено;
		Если П.ПараметрыОтчета.Свойство("ИдЕРН", ИдЕРН) И ИдЕРН <> Неопределено Тогда
			Титульный.ИдЕРН = СокрЛП(ИдЕРН);
		КонецЕсли;
		ДатаРожд = Неопределено;
		Если П.ПараметрыОтчета.Свойство("ДатаРожд", ДатаРожд) И ДатаРожд <> Неопределено Тогда
			Титульный.ДатаРождения = ДатаИзСтрокиЛюбогоФормата(ДатаРожд);
		КонецЕсли;
		ОКСМ = Неопределено;
		Если П.ПараметрыОтчета.Свойство("ОКСМ", ОКСМ) И ОКСМ <> Неопределено Тогда
			Титульный.КодСтраны = СокрЛП(ОКСМ);
		КонецЕсли;
		КодВидДок = Неопределено;
		Если П.ПараметрыОтчета.Свойство("КодВидДок", КодВидДок) И КодВидДок <> Неопределено Тогда
			Титульный.КодВидаДокумента = СокрЛП(КодВидДок);
		КонецЕсли;
		СерНомДок = Неопределено;
		Если П.ПараметрыОтчета.Свойство("СерНомДок", СерНомДок) И СерНомДок <> Неопределено Тогда
			Титульный.СерияИНомерДокумента = СокрЛП(СерНомДок);
		КонецЕсли;
		
	КонецЕсли;
	
	УзлыРаздел1Мнч2 = УзлыПоXPath(П.ДеревоДляЗагрузки, "//Документ/НДФЛ3/СумНалПу/СумНалПу227"); // многоуровневый раздел "Раздел 1"
	
	НомСтраницы = Новый Массив(1);
	НомСтроки   = Новый Массив(1);
	
	НомСтраницы[0] = 1;
	Для НомСтрокиУровень1 = 1 По УзлыРаздел1Мнч2.Количество() Цикл
		
		НомСтроки[0] = НомСтрокиУровень1;
		УзелРаздел1Мнч2 = УзлыРаздел1Мнч2[НомСтрокиУровень1 - 1];
		
		УзлыАвПУУменПг = УзлыПоXPath(УзелРаздел1Мнч2, "@АвПУУменПг");
		Если ЗначениеЗаполнено(УзлыАвПУУменПг) Тогда
			УзелАвПУУменПг = УзлыАвПУУменПг[0];
			Если Лев(УзелАвПУУменПг.Значение, 1) = "-" Тогда
				УзелАвПУУменПг.Значение = Сред(УзелАвПУУменПг.Значение, 2);
				УзелАвПУУменПг.Ключ = "П00001М211003";
			КонецЕсли;
			ЗаполнитьДаннымиСохраненныйДокументИзДереваДляЗагрузки(УзелАвПУУменПг, П.ДанныеОтчета, П.ПараметрыОтчета, , НомСтраницы, НомСтроки);
		КонецЕсли;
		УзлыАвПУУмен9м = УзлыПоXPath(УзелРаздел1Мнч2, "@АвПУУмен9м");
		Если ЗначениеЗаполнено(УзлыАвПУУменПг) Тогда
			УзелАвПУУмен9м = УзлыАвПУУмен9м[0];
			Если Лев(УзелАвПУУмен9м.Значение, 1) = "-" Тогда
				УзелАвПУУмен9м.Значение = Сред(УзелАвПУУмен9м.Значение, 2);
				УзелАвПУУмен9м.Ключ = "П00001М214003";
			КонецЕсли;
			ЗаполнитьДаннымиСохраненныйДокументИзДереваДляЗагрузки(УзелАвПУУмен9м, П.ДанныеОтчета, П.ПараметрыОтчета, , НомСтраницы, НомСтроки);
		КонецЕсли;
		УзлыНалПУУменПер = УзлыПоXPath(УзелРаздел1Мнч2, "@НалПУУменПер");
		Если ЗначениеЗаполнено(УзлыНалПУУменПер) Тогда
			УзелНалПУУменПер = УзлыНалПУУменПер[0];
			Если Лев(УзелНалПУУменПер.Значение, 1) = "-" Тогда
				УзелНалПУУменПер.Значение = Сред(УзелНалПУУменПер.Значение, 2);
				УзелНалПУУменПер.Ключ = "П00001М217003";
			КонецЕсли;
			ЗаполнитьДаннымиСохраненныйДокументИзДереваДляЗагрузки(УзелНалПУУменПер, П.ДанныеОтчета, П.ПараметрыОтчета, , НомСтраницы, НомСтроки);
		КонецЕсли;
		
	КонецЦикла;
	
#КонецОбласти