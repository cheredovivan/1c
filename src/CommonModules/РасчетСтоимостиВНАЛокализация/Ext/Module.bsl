////////////////////////////////////////////////////////////////////////////////
// Локализованные процедуры, связанные с расчетом стоимости ОС и НМА
// 
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныеПроцедурыИФункции

Процедура ОбработатьРасчетРасходов(РасчетРасходов, ТаблицаОбъектов) Экспорт

	//++ Локализация
	ОбработатьРасчетРасходовПриЦелевомФинансировании(РасчетРасходов, ТаблицаОбъектов);
	КорректировкаСтоимостиАрендованногоИмущества(РасчетРасходов, ТаблицаОбъектов);
	//-- Локализация
	
КонецПроцедуры

Функция ТекстЗапросаВтУчетнаяПолитика() Экспорт
	
	ТекстЗапроса = Неопределено;
	
	//++ Локализация
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	СписокОрганизаций.Организация КАК Организация,
	|	НастройкиУчетаНалогаНаПрибыль.ВключатьВСоставНалоговыхРасходовАрендныеПлатежи КАК ВключатьВСоставНалоговыхРасходовАрендныеПлатежи,
	|	НастройкиСистемыНалогообложения.ПлательщикНалогаНаПрибыль КАК ПлательщикНалогаНаПрибыль
	|	
	|ПОМЕСТИТЬ ВтУчетнаяПолитика
	|
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ВтПорцияДанныхКРасчету.Организация КАК Организация,
	|		ВЫРАЗИТЬ(ВтПорцияДанныхКРасчету.Организация КАК Справочник.Организации).ГоловнаяОрганизация КАК ГоловнаяОрганизация
	|	ИЗ
	|		ВтПорцияДанныхКРасчету КАК ВтПорцияДанныхКРасчету
	|		
	|	) КАК СписокОрганизаций
	|	
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиУчетаНалогаНаПрибыль.СрезПоследних(&КонецМесяца) КАК НастройкиУчетаНалогаНаПрибыль
	|		ПО НастройкиУчетаНалогаНаПрибыль.Организация = СписокОрганизаций.ГоловнаяОрганизация
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиСистемыНалогообложения.СрезПоследних(&КонецМесяца) КАК НастройкиСистемыНалогообложения
	|		ПО НастройкиСистемыНалогообложения.Организация = СписокОрганизаций.ГоловнаяОрганизация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация
	|";
	
	//-- Локализация

	Возврат ТекстЗапроса;
	
КонецФункции

Процедура ДополнитьТипыДокументовДвиженияКоторыхНужноПеренестиНаНачалоМесяца(ТипыОбъектов) Экспорт

	//++ Локализация
	ВнеоборотныеАктивыСлужебный.ДобавитьТипОбъектаМетаданных("РаспределениеНДС", Ложь, ТипыОбъектов);
	//-- Локализация
	
КонецПроцедуры

Процедура УчестьОтражениеВУчетеПриРасчетеСтоимости(ДанныеСтроки, СтрокаДокумента) Экспорт

	//++ Локализация
	
	Если НЕ СтрокаДокумента.ОтражатьВБУ
		И НЕ СтрокаДокумента.ОтражатьВНУ Тогда
								
		ДанныеСтроки.СуммаРегл = 0;
		ДанныеСтроки.ПостояннаяРазница = 0;
		ДанныеСтроки.ВременнаяРазница  = 0;
		
	ИначеЕсли СтрокаДокумента.ОтражатьВБУ
		И НЕ СтрокаДокумента.ОтражатьВНУ Тогда
								
		ДанныеСтроки.ВременнаяРазница = ДанныеСтроки.СуммаРегл - ДанныеСтроки.ПостояннаяРазница;
		
	ИначеЕсли НЕ СтрокаДокумента.ОтражатьВБУ
		И СтрокаДокумента.ОтражатьВНУ Тогда
								
		ДанныеСтроки.ВременнаяРазница = -(ДанныеСтроки.СуммаРегл - ДанныеСтроки.ВременнаяРазница - ДанныеСтроки.ПостояннаяРазница);
		ДанныеСтроки.СуммаРегл = 0;
		ДанныеСтроки.ПостояннаяРазница = 0;
		
	КонецЕсли;
	
	//-- Локализация
	
КонецПроцедуры

Процедура ЗаписатьТаблицыДвижений(ТаблицыДвижений, ПараметрыВыполнения) Экспорт
	
	//++ Локализация
	
	Если ПараметрыВыполнения.СформироватьЗадания Тогда
		СформироватьЗаданияКДоначислениюНалогаНаИмущество(ПараметрыВыполнения.МенеджерВременныхТаблиц);
	КонецЕсли;
	
	//-- Локализация
	
КонецПроцедуры

//++ Локализация

Процедура ОбработатьРасчетРасходовПриЦелевомФинансировании(РасчетРасходов, ТаблицаОбъектов)

	Для Каждого ДанныеОбъекта Из ТаблицаОбъектов Цикл
		
		Если ДанныеОбъекта.ВариантПримененияЦелевогоФинансирования <> Перечисления.ВариантыПримененияЦелевогоФинансирования.Частичное Тогда
			Продолжить;
		КонецЕсли; 
			
		// Сумму целевых средств нужно распределить пропорционально по строкам расходов.
		СтоимостьРеглКоэффициенты = Новый Массив;
		
		СтруктураПоиска = Новый Структура("АналитикаРасходов", ДанныеОбъекта.АналитикаКапитализацииРасходов);
		СписокСтрок = РасчетРасходов.НайтиСтроки(СтруктураПоиска);
		Для каждого СтрокаРасход Из СписокСтрок Цикл
			СтоимостьРеглКоэффициенты.Добавить(СтрокаРасход.СуммаРегл);
		КонецЦикла; 
		
		СуммаЦФ = ОбщегоНазначенияУТКлиентСервер.РаспределитьПропорционально(ДанныеОбъекта.СуммаЦелевыхСредств, СтоимостьРеглКоэффициенты);
		
		Если СуммаЦФ = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		Для Сч = 0 По СписокСтрок.ВГраница() Цикл
			
			СтрокаРасход = СписокСтрок[Сч];
			
			СтрокаРасход.СуммаЦФ = СуммаЦФ[Сч];
			
			Если СтрокаРасход.СуммаРегл <> 0 Тогда
				
				Коэффициент = СтрокаРасход.СуммаЦФ / СтрокаРасход.СуммаРегл;
				
				СтрокаРасход.СуммаНУЦФ = Окр(СтрокаРасход.СуммаНУ * Коэффициент, 2);
				СтрокаРасход.СуммаПРЦФ = Окр(СтрокаРасход.ПостояннаяРазница * Коэффициент, 2);
			
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура КорректировкаСтоимостиАрендованногоИмущества(РасчетРасходов, ТаблицаОбъектов)

	Для Каждого ДанныеОбъекта Из ТаблицаОбъектов Цикл
		
		Если ДанныеОбъекта.ХозяйственнаяОперация <> Перечисления.ХозяйственныеОперации.ПринятиеКУчетуПредметовАренды
			ИЛИ НЕ ДанныеОбъекта.ВключатьВСоставНалоговыхРасходовАрендныеПлатежи Тогда
			Продолжить;
		КонецЕсли; 
			
		// Стоимость в НУ распределить пропорционально по строкам расходов.
		СтоимостьНУКоэффициенты = Новый Массив;
		
		СтруктураПоиска = Новый Структура("АналитикаРасходов", ДанныеОбъекта.АналитикаКапитализацииРасходов);
		СписокСтрок = РасчетРасходов.НайтиСтроки(СтруктураПоиска);
		Для каждого СтрокаРасход Из СписокСтрок Цикл
			СтоимостьНУКоэффициенты.Добавить(СтрокаРасход.СуммаРегл - СтрокаРасход.ПостояннаяРазница - СтрокаРасход.ВременнаяРазница);
		КонецЦикла; 
		
		СуммаНУ = ОбщегоНазначенияУТКлиентСервер.РаспределитьПропорционально(ДанныеОбъекта.СтоимостьНУ, СтоимостьНУКоэффициенты);

		Если СуммаНУ = Неопределено Тогда
			Продолжить
		КонецЕсли;
		
		Для Сч = 0 По СписокСтрок.ВГраница() Цикл
			
			СтрокаРасход = СписокСтрок[Сч];
			СтрокаРасход.НеУчитываемаяСтоимостьНУ = СтоимостьНУКоэффициенты[Сч] - СуммаНУ[Сч];
			
		КонецЦикла;
		
	КонецЦикла;

КонецПроцедуры

Процедура СформироватьЗаданияКДоначислениюНалогаНаИмущество(МенеджерВременныхТаблиц) Экспорт
	
	ИспользуемыеВТ = ОбщегоНазначенияУТ.СписокВременныхТаблиц(МенеджерВременныхТаблиц);
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ПорядокУчетаОСБУ.Организация КАК Организация,
	|	ПорядокУчетаОСБУ.ОсновноеСредство КАК ОсновноеСредство,
	|	МАКСИМУМ(ПорядокУчетаОСБУ.Период) КАК Период
	|ПОМЕСТИТЬ ДатыДляСрезаПоследних
	|ИЗ
	|	РегистрСведений.ПорядокУчетаОСБУ КАК ПорядокУчетаОСБУ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтТаблицаОбъектов КАК ВтТаблицаОбъектов
	|		ПО ПорядокУчетаОСБУ.Организация = ВтТаблицаОбъектов.Организация
	|			И ПорядокУчетаОСБУ.ОсновноеСредство = ВтТаблицаОбъектов.ОбъектУчета
	|ГДЕ
	|	ПорядокУчетаОСБУ.Период <= КОНЕЦПЕРИОДА(ВтТаблицаОбъектов.Дата, МЕСЯЦ)
	|
	|СГРУППИРОВАТЬ ПО
	|	ПорядокУчетаОСБУ.Организация,
	|	ПорядокУчетаОСБУ.ОсновноеСредство
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ОсновноеСредство
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПорядокУчетаОСБУ.Организация КАК Организация,
	|	ПорядокУчетаОСБУ.ОсновноеСредство КАК ОсновноеСредство,
	|	ПорядокУчетаОСБУ.НедвижимоеИмущество КАК НедвижимоеИмущество
	|ПОМЕСТИТЬ ПризнакНедвижимогоИмущества
	|ИЗ
	|	ДатыДляСрезаПоследних КАК ДатыДляСрезаПоследних
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПорядокУчетаОСБУ КАК ПорядокУчетаОСБУ
	|		ПО ДатыДляСрезаПоследних.Организация = ПорядокУчетаОСБУ.Организация
	|			И ДатыДляСрезаПоследних.ОсновноеСредство = ПорядокУчетаОСБУ.ОсновноеСредство
	|			И ДатыДляСрезаПоследних.Период = ПорядокУчетаОСБУ.Период
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ОсновноеСредство
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтТаблицаОбъектов.Ссылка КАК Ссылка,
	|	ВтТаблицаОбъектов.Организация КАК Организация,
	|	ВтТаблицаОбъектов.ОбъектУчета КАК ОбъектУчета,
	|	ВтТаблицаОбъектов.Дата КАК Месяц,
	|	ЕСТЬNULL(ПризнакНедвижимогоИмущества.НедвижимоеИмущество, ЛОЖЬ) КАК НедвижимоеИмущество
	|ПОМЕСТИТЬ ВтСписокОбъектов
	|ИЗ
	|	ВтТаблицаОбъектов КАК ВтТаблицаОбъектов
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПризнакНедвижимогоИмущества КАК ПризнакНедвижимогоИмущества
	|		ПО ВтТаблицаОбъектов.Организация = ПризнакНедвижимогоИмущества.Организация
	|			И ВтТаблицаОбъектов.ОбъектУчета = ПризнакНедвижимогоИмущества.ОсновноеСредство
	|ГДЕ
	|	КОНЕЦПЕРИОДА(ВтТаблицаОбъектов.Дата, МЕСЯЦ) = КОНЕЦПЕРИОДА(ВтТаблицаОбъектов.Дата, КВАРТАЛ)
	|	И ЕСТЬNULL(ПризнакНедвижимогоИмущества.НедвижимоеИмущество, ЛОЖЬ) = ИСТИНА
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТаблицаСтоимости.Ссылка КАК Ссылка,
	|	ТаблицаСтоимости.Организация КАК Организация,
	|	ТаблицаСтоимости.ОбъектУчета КАК ОбъектУчета
	|
	|ПОМЕСТИТЬ ВТ_РазницаВСтоимостиОС
	|
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТаблицаСтоимости.Регистратор КАК Ссылка,
	|		ТаблицаСтоимости.Организация КАК Организация,
	|		ТаблицаСтоимости.ОсновноеСредство КАК ОбъектУчета,
	|
	|		ТаблицаСтоимости.Стоимость КАК ФактическаяСтоимостьУУ,
	|		ТаблицаСтоимости.СтоимостьРегл + ТаблицаСтоимости.СтоимостьЦФ КАК ФактическаяСтоимостьБУ,
	|
	|		0 КАК ПредварительнаяСтоимостьУУ,
	|		0 КАК ПредварительнаяСтоимостьБУ
	|	ИЗ
	|		РегистрНакопления.СтоимостьОС КАК ТаблицаСтоимости
	|
	|	ГДЕ
	|		ТаблицаСтоимости.РасчетСтоимости
	|		И ТаблицаСтоимости.Регистратор В
	|				(ВЫБРАТЬ
	|					ВтСписокОбъектов.Ссылка
	|				ИЗ
	|					ВтСписокОбъектов КАК ВтСписокОбъектов)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ТаблицаСтоимости.Ссылка КАК Ссылка,
	|		ТаблицаСтоимости.Ссылка.Организация КАК Организация,
	|		ТаблицаСтоимости.ОсновноеСредство КАК ОбъектУчета,
	|
	|		0 КАК ФактическаяСтоимостьУУ,
	|		0 КАК ФактическаяСтоимостьБУ,
	|
	|		ТаблицаСтоимости.СтоимостьУУ КАК ПредварительнаяСтоимостьУУ,
	|		ТаблицаСтоимости.СтоимостьБУ КАК ПредварительнаяСтоимостьБУ
	|	ИЗ
	|		Документ.ПринятиеКУчетуОС2_4.ОС КАК ТаблицаСтоимости
	|
	|	ГДЕ
	|		ТаблицаСтоимости.Ссылка В
	|				(ВЫБРАТЬ
	|					ВтСписокОбъектов.Ссылка
	|				ИЗ
	|					ВтСписокОбъектов КАК ВтСписокОбъектов)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ТаблицаСтоимости.Ссылка КАК Ссылка,
	|		ТаблицаСтоимости.Ссылка.Организация КАК Организация,
	|		ТаблицаСтоимости.ОсновноеСредство КАК ОбъектУчета,
	|
	|		0 КАК ФактическаяСтоимостьУУ,
	|		0 КАК ФактическаяСтоимостьБУ,
	|
	|		ТаблицаСтоимости.СтоимостьУУ КАК ПредварительнаяСтоимостьУУ,
	|		ТаблицаСтоимости.СтоимостьБУ КАК ПредварительнаяСтоимостьБУ
	|
	|	ИЗ
	|		Документ.МодернизацияОС2_4.ОС КАК ТаблицаСтоимости
	|
	|	ГДЕ
	|		ТаблицаСтоимости.Ссылка В
	|				(ВЫБРАТЬ
	|					ВтСписокОбъектов.Ссылка
	|				ИЗ
	|					ВтСписокОбъектов КАК ВтСписокОбъектов)
	|
	|	) КАК ТаблицаСтоимости
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаСтоимости.Ссылка,
	|	ТаблицаСтоимости.Организация,
	|	ТаблицаСтоимости.ОбъектУчета
	|
	|ИМЕЮЩИЕ
	|	(СУММА(ТаблицаСтоимости.ФактическаяСтоимостьУУ) > СУММА(ТаблицаСтоимости.ПредварительнаяСтоимостьУУ)
	|		ИЛИ СУММА(ТаблицаСтоимости.ФактическаяСтоимостьБУ) > СУММА(ТаблицаСтоимости.ПредварительнаяСтоимостьБУ))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка,
	|	ОбъектУчета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВтСписокОбъектов.Ссылка КАК Документ,
	|	ВтСписокОбъектов.Организация КАК Организация,
	|	ВтСписокОбъектов.ОбъектУчета КАК ОбъектУчета,
	|	ВтСписокОбъектов.Месяц КАК Месяц
	|
	|ИЗ
	|	ВтСписокОбъектов КАК ВтСписокОбъектов
	|
	|ГДЕ
	|	(ВтСписокОбъектов.Ссылка, ВтСписокОбъектов.ОбъектУчета) В (
	|		ВЫБРАТЬ
	|			ВТ_РазницаВСтоимостиОС.Ссылка,
	|			ВТ_РазницаВСтоимостиОС.ОбъектУчета
	|		ИЗ
	|			ВТ_РазницаВСтоимостиОС КАК ВТ_РазницаВСтоимостиОС)
	|";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	УстановитьПривилегированныйРежим(Истина);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	РегистрыСведений.ЗаданияКДоначислениюНалогаНаИмущество.СоздатьЗаписиРегистраПоДаннымВыборки(РезультатЗапроса.Выбрать());
	
	ОбщегоНазначенияУТ.УничтожитьВременныеТаблицы(МенеджерВременныхТаблиц,, ИспользуемыеВТ);
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

//-- Локализация

#КонецОбласти
