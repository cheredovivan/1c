
#Область СлужебныйПрограммныйИнтерфейс

Процедура JSONВРеквизитыФормы(Форма, Текст) Экспорт 
	РеквизитыФормы = Новый Массив;
	Для Каждого Элт Из Форма.ПолучитьРеквизиты("") Цикл 
		РеквизитыФормы.Добавить(Элт.Имя);
	КонецЦикла;
	
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(Текст);
	
	Пока ЧтениеJSON.Прочитать() Цикл 
		Если ЧтениеJSON.ТипТекущегоЗначения = ТипЗначенияJSON.ИмяСвойства Тогда 
			ИмяСвойства = ЧтениеJSON.ТекущееЗначение;
			Если СтрНачинаетсяС(ИмяСвойства, УведомлениеОСпецрежимахНалогообложенияПовтИсп.ПрефиксРеквизита()) Тогда 
				ЧтениеJSON.Прочитать();
				ЗначениеСвойства = ?(ЧтениеJSON.ТипТекущегоЗначения = ТипЗначенияJSON.Строка, ЧтениеJSON.ТекущееЗначение, "");
				ИмяРеквизитаНаФорме = СтрЗаменить(ИмяСвойства, УведомлениеОСпецрежимахНалогообложенияПовтИсп.ПрефиксРеквизита(), "");
				
				Если ЗначениеЗаполнено(ИмяСвойства) И ЗначениеЗаполнено(ЗначениеСвойства) И РеквизитыФормы.Найти(ИмяРеквизитаНаФорме) <> Неопределено Тогда 
					ЗагрузитьПоказатель(Форма[ИмяРеквизитаНаФорме], ЗначениеСвойства)
				КонецЕсли;
			ИначеЕсли СтрНачинаетсяС(ИмяСвойства, УведомлениеОСпецрежимахНалогообложенияПовтИсп.ПрефиксТаблицы()) Тогда 
				СтрокаТаблицы = Неопределено;
				ИмяРеквизитаНаФорме = СтрЗаменить(ИмяСвойства, УведомлениеОСпецрежимахНалогообложенияПовтИсп.ПрефиксТаблицы(), "");
				Если РеквизитыФормы.Найти(ИмяРеквизитаНаФорме) = Неопределено Тогда
					СтрокаТаблицы = Неопределено;
					Продолжить;
				КонецЕсли;
				
				ЧтениеJSON.Прочитать();
				Если ЧтениеJSON.ТипТекущегоЗначения <> ТипЗначенияJSON.НачалоМассива Тогда 
					Продолжить;
				КонецЕсли;
				
				Если РеквизитыФормы.Найти(ИмяРеквизитаНаФорме) <> Неопределено Тогда 
					ТаблицаФормы = Форма[ИмяРеквизитаНаФорме];
					КолонкиТаблицы = Форма.РеквизитФормыВЗначение(ИмяРеквизитаНаФорме).Колонки;
					
					Пока ЧтениеJSON.Прочитать() Цикл 
						Если ЧтениеJSON.ТипТекущегоЗначения = ТипЗначенияJSON.КонецМассива Тогда 
							Прервать;
						ИначеЕсли ЧтениеJSON.ТипТекущегоЗначения = ТипЗначенияJSON.НачалоОбъекта Тогда 
							СтрокаТаблицы = ТаблицаФормы.Добавить();
						ИначеЕсли ЧтениеJSON.ТипТекущегоЗначения = ТипЗначенияJSON.ИмяСвойства Тогда
							ИмяСвойства = ЧтениеJSON.ТекущееЗначение;
							ЧтениеJSON.Прочитать();
							ЗначениеСвойства = ?(ЧтениеJSON.ТипТекущегоЗначения = ТипЗначенияJSON.Строка, ЧтениеJSON.ТекущееЗначение, "");
							Если КолонкиТаблицы.Найти(ИмяСвойства) <> Неопределено Тогда 
								ЗагрузитьПоказатель(СтрокаТаблицы[ИмяСвойства], ЗначениеСвойства);
							КонецЕсли;
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	ЧтениеJSON.Закрыть();
КонецПроцедуры

Функция ОбщиеСправочникиМайнеров() Экспорт 
	Возврат УведомлениеОСпецрежимахНалогообложенияПовтИсп.ОбщиеСправочникиМайнеров("СправочникиМайнеров");
КонецФункции

Процедура СправочникиМайнеровВТаблицыНаФорме(Форма) Экспорт 
	СправочникиМайнеров = УведомлениеОСпецрежимахНалогообложенияПовтИсп.ОбщиеСправочникиМайнеров("СправочникиМайнеров");
	
	ДобавляемыеРеквизиты = Новый Массив;
	Для Каждого КЗ Из СправочникиМайнеров Цикл 
		ДобавляемыеРеквизиты.Добавить(Новый РеквизитФормы(КЗ.Ключ, Новый ОписаниеТипов("ТаблицаЗначений")));
	КонецЦикла;
	Форма.ИзменитьРеквизиты(ДобавляемыеРеквизиты);
	
	ДобавляемыеРеквизиты.Очистить();
	Для Каждого КЗ Из СправочникиМайнеров Цикл 
		ДобавляемыеРеквизиты.Добавить(Новый РеквизитФормы("Код", ОбщегоНазначения.ОписаниеТипаСтрока("10"), КЗ.Ключ));
		ДобавляемыеРеквизиты.Добавить(Новый РеквизитФормы("Название", ОбщегоНазначения.ОписаниеТипаСтрока("100"), КЗ.Ключ));
	КонецЦикла;
	Форма.ИзменитьРеквизиты(ДобавляемыеРеквизиты);
	
	Для Каждого КЗ Из СправочникиМайнеров Цикл 
		Форма.ЗначениеВРеквизитФормы(КЗ.Значение, КЗ.Ключ);
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция ЗагрузитьПоказатель(РеквизитНаФорме, ЗначениеСвойства)
	ТекущийТип = Новый Массив;
	ТекущийТип.Добавить(ТипЗнч(РеквизитНаФорме));
	ОТ = Новый ОписаниеТипов(ТекущийТип);
	РеквизитНаФорме = ОТ.ПривестиЗначение(ЗначениеСвойства);
КонецФункции

Процедура ЗаписатьТаблицуПоказателей(Форма, ЗаписьJSON, ИмяТаблицы) Экспорт 
	Если ТипЗнч(Форма) = Тип("Структура") Тогда 
		Таблица = Форма[ИмяТаблицы];
	ИначеЕсли ТипЗнч(Форма) = Тип("ФормаКлиентскогоПриложения") Тогда 
		Таблица = Форма.РеквизитФормыВЗначение(ИмяТаблицы, Тип("ТаблицаЗначений"));
	КонецЕсли;
	
	ЗаписьJSON.ЗаписатьИмяСвойства(УведомлениеОСпецрежимахНалогообложенияПовтИсп.ПрефиксТаблицы() + ИмяТаблицы);
	ЗаписьJSON.ЗаписатьНачалоМассива();
	Для Каждого Стр Из Таблица Цикл 
		Если Не УведомлениеОСпецрежимахНалогообложенияСлужебный.СтрокаТаблицыЗначенийЗаполнена(Стр) Тогда 
			Продолжить;
		КонецЕсли;
		
		ЗаписьJSON.ЗаписатьНачалоОбъекта();
		Для Каждого Колонка Из Таблица.Колонки Цикл 
			ЗаписьJSON.ЗаписатьИмяСвойства(Колонка.Имя);
			ЗаписьJSON.ЗаписатьЗначение(УведомлениеОСпецрежимахНалогообложенияСлужебный.КонвертироватьПоказатель(Стр[Колонка.Имя]));
		КонецЦикла;
		ЗаписьJSON.ЗаписатьКонецОбъекта();
	КонецЦикла;
	ЗаписьJSON.ЗаписатьКонецМассива();
КонецПроцедуры

#КонецОбласти
