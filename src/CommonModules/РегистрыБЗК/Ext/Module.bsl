////////////////////////////////////////////////////////////////////////////////
// Серверные процедуры и функции работы с наборами записей и регистрами.
//
////////////////////////////////////////////////////////////////////////////////

#Область СлужебныйПрограммныйИнтерфейс

#Область ПереходныеПроцедурыИФункции

// Проверяет, что указанный режим соответствует добавлению набора записей.
//
// Параметры:
//  Замещение - Булево, РежимЗамещения
//
// Возвращаемое значение:
//  Булево
//
Функция ЭтоДобавлениеНабораЗаписей(Замещение) Экспорт
	Возврат Замещение = Ложь
		Или (Замещение <> Неопределено И Замещение = ЗарплатаКадрыПовтИсп.РежимДобавленияНабораЗаписей());
КонецФункции

// Проверяет, что указанный режим соответствует замещению набора записей.
//
// Параметры:
//  Замещение - Булево, РежимЗамещения
//
// Возвращаемое значение:
//  Булево
//
Функция ЭтоЗамещениеНабораЗаписей(Замещение) Экспорт
	Возврат Замещение = Истина
		Или (Замещение <> Неопределено И Замещение = ЗарплатаКадрыПовтИсп.РежимЗамещенияНабораЗаписей());
КонецФункции

// См. ОбщегоНазначения.ЭтоОбновлениеНабораЗаписей.
Функция ЭтоОбновлениеНабораЗаписей(Замещение) Экспорт
	Возврат ОбщегоНазначения.ЭтоОбновлениеНабораЗаписей(Замещение);
КонецФункции

// См. ОбщегоНазначения.ЭтоСлияниеНабораЗаписей.
Функция ЭтоСлияниеНабораЗаписей(Замещение) Экспорт
	Возврат ОбщегоНазначения.ЭтоСлияниеНабораЗаписей(Замещение);
КонецФункции

// См. ОбщегоНазначения.ЭтоУдалениеНабораЗаписей.
Функция ЭтоУдалениеНабораЗаписей(Замещение) Экспорт
	Возврат ОбщегоНазначения.ЭтоУдалениеНабораЗаписей(Замещение);
КонецФункции

// Возвращает таблицу значений с отборами, по которым набор записей будет записан в базу данных.
//
// Параметры:
//   НаборЗаписей - РегистрСведенийНаборЗаписей, РегистрНакопленияНаборЗаписей, РегистрБухгалтерииНаборЗаписей,
//     РегистрРасчетаНаборЗаписей - Набор записей, который используется для подготовки условия и параметров для запроса.
//   Замещение - РежимЗамещения, Булево - Передается "как есть" из параметров события ПередЗаписью или ПриЗаписи.
//     - Неопределено - Режим записи будет получен из "НаборЗаписей.ДополнительныеСвойства.Замещение".
//
// Возвращаемое значение:
//   ТаблицаЗначений - В таблице присутствуют колонки "<ИмяИзмерения>" и "<ИмяИзмерения>_Использование".
//       В колонках "<ИмяИзмерения>" хранятся значения отборов,
//       а в колонках "<ИмяИзмерения>_Использование" - признаки использования.
//
Функция ОтборыЗаписейНабора(НаборЗаписей, Знач Замещение = Неопределено) Экспорт
	Если НаборЗаписей.ДополнительныеСвойства.Свойство("ОтборыЗаписейНабора") Тогда
		Возврат НаборЗаписей.ДополнительныеСвойства.ОтборыЗаписейНабора;
	КонецЕсли;
	
	ПрочитатьИПроверитьПараметрЗамещение(НаборЗаписей, Замещение);
	
	// Пример описания ключа записи для регистра с регистратором:
	//   ПолноеИмя = "РегистрСведений.БухучетРаспределениеОсновногоЗаработка",
	//   СписокПолей = "Регистратор,ПериодРегистрации,Сотрудник,Организация,СтатьяФинансирования,
	//                 |СпособОтраженияЗарплатыВБухучете,ОблагаетсяЕНВД,ПодразделениеУчетаЗатрат",
	//   СписокПолейОбновления = "Регистратор,НомерСтроки".
	ОписаниеКлючаЗаписи = СтандартныеПодсистемыСервер.ОписаниеКлючаЗаписи(НаборЗаписей.Метаданные().ПолноеИмя());
	Ключи = ОписаниеКлючаЗаписи.СписокПолейОбновления;
	
	РежимыЗамещения = ЗарплатаКадрыПовтИсп.РежимыЗамещения();
	
	Если ЗначениеЗаполнено(Ключи) Тогда
		СуффиксИспользование = "_Использование";
		Если Замещение = Ложь // Добавление.
			Или Замещение = РежимыЗамещения.Добавление
			Или Замещение = РежимыЗамещения.Обновление
			Или Замещение = РежимыЗамещения.Слияние
			Или Замещение = РежимыЗамещения.Удаление Тогда
			
			// Получение значений отборов в колонках "<ИмяИзмерения>".
			ОтборыЗаписейНабора = НаборЗаписей.Выгрузить(, Ключи);
			
			// Добавление колонок "<ИмяИзмерения>_Использование".
			МассивКлючей = СтрРазделить(Ключи, ", ", Ложь);
			Для Каждого Ключ Из МассивКлючей Цикл
				ОтборыЗаписейНабора.Колонки.Добавить(Ключ + СуффиксИспользование, Новый ОписаниеТипов("Булево"));
			КонецЦикла;
			
			// Заполнение Истина в колонки "<ИмяИзмерения>_Использование".
			Если ОтборыЗаписейНабора.Количество() > 0 Тогда
				ИменаКлючейИспользование = СтрСоединить(МассивКлючей, СуффиксИспользование + ",") + СуффиксИспользование;
				ОтборыЗаписейНабора.ЗаполнитьЗначения(Истина, ИменаКлючейИспользование);
			КонецЕсли;
			
		Иначе // Замещение = Истина Или Замещение = РежимыЗамещения.Замещение.
			
			// Создание пустой таблицы с колонками "<ИмяИзмерения>".
			ОтборыЗаписейНабора = НаборЗаписей.ВыгрузитьКолонки(Ключи);
			
			// Добавление колонок "<ИмяИзмерения>_Использование".
			Для Каждого Ключ Из СтрРазделить(Ключи, ",", Ложь) Цикл
				ОтборыЗаписейНабора.Колонки.Добавить(Ключ + СуффиксИспользование, Новый ОписаниеТипов("Булево"));
			КонецЦикла;
			
			// Добавление отборов.
			СтрокаТаблицы = ОтборыЗаписейНабора.Добавить();
			ЕстьОтборы = Ложь;
			Для Каждого ЭлементОтбора Из НаборЗаписей.Отбор Цикл
				Если Не ЭлементОтбора.Использование Тогда
					Продолжить;
				КонецЕсли;
				ЕстьОтборы = Истина;
				СтрокаТаблицы[ЭлементОтбора.Имя]                        = ЭлементОтбора.Значение;
				СтрокаТаблицы[ЭлементОтбора.Имя + СуффиксИспользование] = ЭлементОтбора.Использование;
			КонецЦикла;
			Если Не ЕстьОтборы Тогда
				ОтборыЗаписейНабора.Удалить(СтрокаТаблицы);
			КонецЕсли;
			
		КонецЕсли;
		
	Иначе
		
		// Пустой регистр - пустая таблица без колонок.
		ОтборыЗаписейНабора = Новый ТаблицаЗначений;
		
	КонецЕсли;
	
	НаборЗаписей.ДополнительныеСвойства.Вставить("ОтборыЗаписейНабора", ОтборыЗаписейНабора);
	Возврат ОтборыЗаписейНабора;
КонецФункции

// Возвращает значение отбора с которым будет записан набор записей в базу данных.
//
// Параметры:
//   НаборЗаписей - См. одноименный параметр функции ОтборыЗаписейНабора.
//   Замещение - См. одноименный параметр функции ОтборыЗаписейНабора.
//   ИмяИзмерения - Строка
//   НеопределеноЕслиНеИспользуется - Булево
//
// Возвращаемое значение:
//   Массив - Значения отбора.
//   Неопределено - если НеопределеноЕслиНеВключен = Истина и отбор не используется.
//
Функция ЗначенияОтбораЗаписейНабора(НаборЗаписей, Замещение, ИмяИзмерения, НеопределеноЕслиНеИспользуется = Ложь) Экспорт
	ОтборыЗаписейНабора = ОтборыЗаписейНабора(НаборЗаписей, Замещение);
	Копия = ОтборыЗаписейНабора.Скопировать(Новый Структура(ИмяИзмерения + "_Использование", Истина));
	Если Копия.Количество() = 0 Тогда
		Если НеопределеноЕслиНеИспользуется И ЭтоЗамещениеНабораЗаписей(Замещение) Тогда
			Возврат Неопределено;
		Иначе
			Возврат Новый Массив;
		КонецЕсли;
	Иначе
		Возврат КоллекцииБЗК.УникальныеЗначенияКолонки(Копия, ИмяИзмерения);
	КонецЕсли;
КонецФункции

// Возвращает указанные поля строк регистра из базы данных, которые будут
// записаны при записи указанного набора записей с учетом режима замещения.
//
// Параметры:
//   НаборЗаписей - РегистрСведенийНаборЗаписей, РегистрНакопленияНаборЗаписей, РегистрБухгалтерииНаборЗаписей,
//       РегистрРасчетаНаборЗаписей - Набор записей, который используется для подготовки условия и параметров для запроса.
//   Замещение - РежимЗамещения, Булево - Передается "как есть" из параметров события ПередЗаписью или ПриЗаписи.
//     - Неопределено - Режим записи будет получен из "НаборЗаписей.ДополнительныеСвойства.Замещение".
//   СписокПолей - Строка - Имена полей (или фрагмент запроса полей) набора записей через запятую.
//       Если не указан, значит выбираются все поля набора записей.
//   Различные - Булево - Если Истина, тогда выбираются различные строки для указанных полей.
//       Если результат планируется передавать в функцию ИзменениеЗаписейНабора,
//       тогда для случая, когда Различные = Ложь и записи могут повторяться
//       (то есть указаны не все поля измерений), следует сделать свертку
//       полученной таблицы значений перед передачей в функцию ИзменениеЗаписейНабора.
//
// Возвращаемое значение:
//  ТаблицаЗначений - поля из параметра СписокПолей,
//    строки без повторений для указанного списка полей.
//
Функция ЗаписиНабораИзБазыДанных(НаборЗаписей, Знач Замещение = Неопределено, Знач СписокПолей = "", Знач Различные = Ложь) Экспорт
	ПрочитатьИПроверитьПараметрЗамещение(НаборЗаписей, Замещение);
	Если ЭтоДобавлениеНабораЗаписей(Замещение) И СтрНайти(СписокПолей, " КАК ") = 0 Тогда
		Возврат НаборЗаписей.Выгрузить(Новый Массив,
			?(ЗначениеЗаполнено(СписокПолей), СписокПолей, Неопределено));
	КонецЕсли;
	Возврат ЗапросНабораИзБазыДанных(НаборЗаписей, Замещение, СписокПолей, Различные).Выполнить().Выгрузить();
КонецФункции

// Возвращает указанные поля строк регистра из базы данных, которые будут
// записаны при записи указанного набора записей с учетом режима замещения.
//
// Параметры:
//   НаборЗаписей - РегистрСведенийНаборЗаписей, РегистрНакопленияНаборЗаписей, РегистрБухгалтерииНаборЗаписей,
//       РегистрРасчетаНаборЗаписей - Набор записей, который используется для подготовки условия и параметров для запроса.
//   Замещение - РежимЗамещения, Булево - Передается "как есть" из параметров события ПередЗаписью или ПриЗаписи.
//     - Неопределено - Режим записи будет получен из "НаборЗаписей.ДополнительныеСвойства.Замещение".
//   СписокПолей - Строка - Имена полей (или фрагмент запроса полей) набора записей через запятую.
//       Если не указан, значит выбираются все поля набора записей.
//   Различные - Булево - Если Истина, тогда выбираются различные строки для указанных полей.
//       Если результат планируется передавать в функцию ИзменениеЗаписейНабора,
//       тогда для случая, когда Различные = Ложь и записи могут повторяться
//       (то есть указаны не все поля измерений), следует сделать свертку
//       полученной таблицы значений перед передачей в функцию ИзменениеЗаписейНабора.
//   ИмяВТ - Строка - Имя временной таблицы, в которую необходимо поместить данные из регистра.
//
// Возвращаемое значение:
//  Запрос - поля из параметра СписокПолей,
//    строки без повторений для указанного списка полей.
//
Функция ЗапросНабораИзБазыДанных(НаборЗаписей, Знач Замещение = Неопределено, Знач СписокПолей = "", Знач Различные = Ложь, Знач ИмяВТ = "") Экспорт
	ПрочитатьИПроверитьПараметрЗамещение(НаборЗаписей, Замещение);
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	&ВыбираемыеПоля
	|ПОМЕСТИТЬ ИмяВТ
	|ИЗ
	|	&Таблица КАК ТекущаяТаблица
	|ГДЕ
	|	&УсловиеОтбора";
	Если Не Различные Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВЫБРАТЬ РАЗЛИЧНЫЕ", "ВЫБРАТЬ");
	КонецЕсли;
	Если ИмяВТ = "" Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ПОМЕСТИТЬ ИмяВТ", "");
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ПОМЕСТИТЬ ИмяВТ", "ПОМЕСТИТЬ " + ИмяВТ);
	КонецЕсли;
	ОтборЗаписейНабораИзБазыДанных(НаборЗаписей, Замещение, Запрос);
	
	Если Не ЗначениеЗаполнено(СписокПолей) Тогда
		Таблица = НаборЗаписей.Выгрузить(Новый Массив);
		Поля = Новый Массив;
		Для Каждого Колонка Из Таблица.Колонки Цикл
			Если Различные
				И Колонка.ТипЗначения.СодержитТип(Тип("Строка"))
				И Колонка.ТипЗначения.КвалификаторыСтроки.Длина = 0 Тогда
				Если Колонка.ТипЗначения.Типы().Количество() = 1 Тогда
					Шаблон = "ВЫРАЗИТЬ(%1 КАК СТРОКА(10000)) КАК %1";
				Иначе
					Шаблон = "ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(%1) = ТИП(СТРОКА) ТОГДА ВЫРАЗИТЬ(%1 КАК СТРОКА(10000)) ИНАЧЕ %1 КОНЕЦ КАК %1";
				КонецЕсли;
				Поля.Добавить(СтрШаблон(Шаблон, Колонка.Имя));
				Продолжить;
			КонецЕсли;
			Поля.Добавить(Колонка.Имя);
		КонецЦикла;
		СписокПолей = СтрСоединить(Поля, ",");
	КонецЕсли;
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Таблица", НаборЗаписей.Метаданные().ПолноеИмя());
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ВыбираемыеПоля", СписокПолей);
	
	Возврат Запрос;
КонецФункции

// См. ОбщегоНазначения.ИзменениеЗаписейНабора.
Функция ИзменениеЗаписейНабора(ЗаписиИзБазыДанных, НаборЗаписей, Замещение, ТолькоИзменения = Ложь) Экспорт
	Возврат ОбщегоНазначения.ИзменениеЗаписейНабора(ЗаписиИзБазыДанных, НаборЗаписей, Замещение, ТолькоИзменения);
КонецФункции

// См. ОбщегоНазначения.ОтборЗаписейНабораИзБазыДанных.
Функция ОтборЗаписейНабораИзБазыДанных(НаборЗаписей, Замещение = Неопределено, Запрос = Неопределено,
			ДополнительныеПараметры = Неопределено) Экспорт
	Возврат ОбщегоНазначения.ОтборЗаписейНабораИзБазыДанных(НаборЗаписей, Замещение, Запрос, ДополнительныеПараметры);
КонецФункции

// Рекомендуется вызывать из ПередЗаписью регистров подчиненных регистратору перед началом использования данных набора.
//   Заполняет "Регистратор" набора записей на основании значения соответствующего отбора.
//
Процедура ЗаполнитьРегистраторНабораЗаписей(НаборЗаписей, Замещение) Экспорт
	Если НаборЗаписей.ДополнительныеСвойства.Свойство("РегистраторЗаполнен") Тогда
		Возврат;
	КонецЕсли;
	Если НаборЗаписей.Отбор.Регистратор.Использование Тогда
		Регистратор = НаборЗаписей.Отбор.Регистратор.Значение;
		Для Каждого Запись Из НаборЗаписей Цикл
			Запись.Регистратор = Регистратор;
		КонецЦикла;
	КонецЕсли;
	НаборЗаписей.ДополнительныеСвойства.Вставить("РегистраторЗаполнен", Истина);
КонецПроцедуры

#КонецОбласти

#КонецОбласти


#Область СлужебныеПроцедурыИФункции

Процедура ПрочитатьИПроверитьПараметрЗамещение(НаборЗаписей, Замещение)
	Если Замещение = Неопределено Тогда
		НаборЗаписей.ДополнительныеСвойства.Свойство("Замещение", Замещение);
	КонецЕсли;
	Если ТипЗнч(Замещение) <> Тип("Булево") Тогда
		РежимДобавления = ЗарплатаКадрыПовтИсп.РежимДобавленияНабораЗаписей();
		ДоступнаПлатформа27 = (РежимДобавления <> Неопределено);
		Если Не ДоступнаПлатформа27 Или ТипЗнч(Замещение) <> ТипЗнч(РежимДобавления) Тогда
			ОжидаемыеТипы = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Тип("Булево"));
			Если ДоступнаПлатформа27 Тогда
				ОжидаемыеТипы.Добавить(ТипЗнч(РежимДобавления));
			КонецЕсли;
			ОбщегоНазначенияКлиентСервер.ПроверитьПараметр("ОбщегоНазначенияБЗК.ОтборыЗаписейНабора",
				"Замещение", Замещение, ОжидаемыеТипы);
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

#КонецОбласти
