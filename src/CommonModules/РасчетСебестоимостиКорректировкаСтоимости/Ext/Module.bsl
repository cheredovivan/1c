///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Механизм расчета себестоимости
//
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс

#Область ОсновнойИнтерфейсМеханизма

// Выполняется формирование движений по регистрам.
// Перечень исходящих регистров см. РасчетСебестоимости.ИсходящиеДанныеМеханизма
//
// Параметры:
//	ПараметрыЗапуска - Структура - параметры запуска процедуры 
//	ПараметрыРасчета - Структура - параметры расчета, сформированные в вызывающем механизме.
//	ПараметрыОтладки - Структура - предназначена для переопределения одноименных свойств структуры ПараметрыРасчета.
//		Подробнее см. пояснения в коде РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыРасчетаПартий к параметру ПараметрыОтладки. 
//
Процедура СформироватьДвиженияПоРегистрам(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки) Экспорт
	
	Если НЕ ПараметрыРасчета.ИспользоватьУчетСебестоимости Тогда
		Возврат;
	КонецЕсли;
	
	Если ПараметрыОтладки = Неопределено Тогда
		ПараметрыОтладки = Новый Структура; // для упрощения дальнейших обращений к этому свойству
	КонецЕсли;
	
	ПараметрыЗапуска.Вставить("ТолькоРасчетСебестоимости", Ложь);
	ПараметрыЗапуска.Вставить("РегламентноеЗадание", Ложь);
	ПараметрыЗапуска.Вставить("ПредварительныйРасчет", Ложь);
	
	// Инициализируем параметры расчета
	ИнициализироватьОбщиеПараметрыРасчетаСебестоимости(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки);
	
	СформироватьДвиженияПоОтклонениямВСтоимостиТоваров(ПараметрыРасчета);
	// Формирует движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	// - ПрочиеДоходы
	// - ДвиженияНоменклатураДоходыРасходы
	// - ДвиженияНоменклатураНоменклатура
	// - ПрочиеАктивыПассивы
	// - ОтклоненияВСтоимостиТоваров
	СкорректироватьСтоимостьСписанияЗапасов(ПараметрыРасчета);
		
	// Формирует движения по регистрам:
	// - ДетализацияСебестоимостиПартииТоваров
	РасчетСебестоимостиНДС.РасчетОтклонениеВыпускаФИФОСкользящая(ПараметрыРасчета);
	
	//++ НЕ УТ

	// Формирует движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	// - ПрочиеРасходыНезавершенногоПроизводства
	СкорректироватьСтоимостьСписанияНезавершенногоПроизводства22(ПараметрыРасчета);
		
	// Формирует движения по регистрам:
	// - ПрочиеРасходы
	// - РезервыПредстоящихРасходов
	СкорректироватьСтоимостьСписанияРезервовПредстоящихРасходов(ПараметрыРасчета);
		
	// Формирует движения по регистрам:
	// - ПрочиеРасходы
	// - СебестоимостьТоваров
	СкорректироватьСтоимостьДополнительныхРасходов(ПараметрыРасчета, Ложь);
	
	// Формирует движения по регистрам:
	// - ПрочиеРасходы
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходов Тогда
		СкорректироватьСтоимостьПрочегоСписанияНезавершенногоПроизводства(ПараметрыРасчета);
	КонецЕсли;
				
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВтСтоимостиНезавершенногоПроизводства, ВтСтоимостиНезавершенногоПроизводстваРегл,
		//++ Локализация
		|ВтНезавершенноеПроизводствоВключениеИсключениеНДС,
		//-- Локализация
		|РезервыПредстоящихРасходов, ДокументыДвиженияРезервов");
	//-- НЕ УТ
		
	// Формирует движения по регистрам:
	// - ВыручкаИСебестоимостьПродаж
	// - Закупки
	СкорректироватьСтоимостьПродаж(ПараметрыРасчета);
		
	// Формирует движения по регистрам:
	// - ВыручкаИСебестоимостьПродаж
	// - ПрочиеРасходы
	// - ДвиженияНоменклатураДоходыРасходы
	РасчетСебестоимостиЛокализация.ВключитьИсключитьНДСВСтоимостьПродаж(ПараметрыРасчета);
	
	
	// Этап Формирования движений по фактическим расходам НДД по себестоимости товаров и трудозатратам НЗП.
	// По прочим расходам движения формируются на этапе см. СформироватьДвиженияПоРегистрамФинансовыйРезультат,
	// т.к. для них необходимы данные по погрешностям расчета себестоимости.
	//
	// Формирует движения по регистрам:
	// - СебестоимостьТоваров
	// - ТрудозатратыНезавершенногоПроизводства
	// - ФактическиеРасходыНДДПроизводствоРеализация (если расходы признаются по объекту раздельного учета НДД)
	РасчетСебестоимостиЛокализация.СформироватьДвиженияПоФактическимРасходамНДДпоСебестоимостиТоваровИТрудозатратамНЗП(ПараметрыРасчета);
	
	// Формирует движения по регистрам:
	// - ОтклоненияВСтоимостиТоваров
	// - ВыручкаИСебестоимостьПродаж
	// - ПрочиеРасходы
	// - ПрочиеРасходыНезавершенногоПроизводства
	РаспределитьОтклоненияВСтоимостиТоваров(ПараметрыРасчета);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "СтоимостьВНЗП");
	
	// Записываем движения (в случае, если расчет себестоимости запущен самостоятельно, а не как этап расчета партий)
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаписатьСформированныеДвижения(
		ПараметрыРасчета,
		ПараметрыОтладки.ПротоколыРасчета);

КонецПроцедуры
	
// Выполняется формирование движений по регистрам.
// Перечень исходящих регистров см. РасчетСебестоимости.ИсходящиеДанныеМеханизма
//
// Параметры:
//	ПараметрыЗапуска - Структура - параметры запуска процедуры 
//	ПараметрыРасчета - Структура - параметры расчета, сформированные в вызывающем механизме.
//	ПараметрыОтладки - Структура - предназначена для переопределения одноименных свойств структуры ПараметрыРасчета.
//		Подробнее см. пояснения в коде РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыРасчетаПартий к параметру ПараметрыОтладки. 
//
Процедура СформироватьДвиженияПоРегистрамФинансовыйРезультат(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки) Экспорт
	
	Если НЕ ПараметрыРасчета.ИспользоватьУчетСебестоимости Тогда
		Возврат;
	КонецЕсли;
	
	Если ПараметрыОтладки = Неопределено Тогда
		ПараметрыОтладки = Новый Структура; // для упрощения дальнейших обращений к этому свойству
	КонецЕсли;
	
	ПараметрыЗапуска.Вставить("ТолькоРасчетСебестоимости", Ложь);
	ПараметрыЗапуска.Вставить("РегламентноеЗадание", Ложь);
	ПараметрыЗапуска.Вставить("ПредварительныйРасчет", Ложь);
	
	// Инициализируем параметры расчета
	ИнициализироватьОбщиеПараметрыРасчетаСебестоимости(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки);
	
	#Область КорректировкаОстатковРегистров
	
	// Выполняем операции корректировки остатков регистров на конец рассчитываемого периода:
	// - списываем остатки малоценных МЦ
	// - списываем ошибки округления расчета
	// - списываем отклонения в стоимости, которые не являются ошибками округления
	
	//++ НЕ УТ
	
	//++ Локализация
		
	// Формирует движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	// - ДвиженияНоменклатураДоходыРасходы
	СписатьОстаткиМалоценныхМЦ(ПараметрыРасчета);
	//-- Локализация
	
	//-- НЕ УТ
	
	Если ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиСебестоимостьРегл > 0
	 ИЛИ ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиСебестоимостьУпр > 0
	 ИЛИ ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиРасходыРегл > 0
	 ИЛИ ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиРасходыУпр > 0 Тогда
		// Формирует движения по регистрам:
		// - СебестоимостьТоваров
		// - ПрочиеРасходы
		// - ПрочиеРасходыНезавершенногоПроизводства
		// - ДвиженияНоменклатураДоходыРасходы
		// - ДвиженияНоменклатураНоменклатура
		СписатьОшибкиОкругленияРасчетаСебестоимости(ПараметрыРасчета);
	КонецЕсли;

	// Формирует движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеДоходы
	// - ПрочиеРасходы
	СписатьОтклоненияВСтоимостиТоваров(ПараметрыРасчета);
	
	#КонецОбласти
	
	// Этап Формирования движений по фактическим расходам НДД по прочим расходам.
	// Сделан отдельно от себестоимости товаров и трудозатрат НЗП (см. СформироватьДвиженияПоРегистрам), 
	// т.к. для прочих расходов нужны данные по погрешностям расчета себестоимости. 
	//
	// Формирует движения по регистрам:
	// - ПрочиеРасходы
	// - ФактическиеРасходыНДДПроизводствоРеализация (если расходы признаются по объекту раздельного учета НДД)
	РасчетСебестоимостиЛокализация.СформироватьДвиженияПоФактическимРасходамНДДпоПрочимРасходам(ПараметрыРасчета);
	
	// Формирует отклонения в движениях по регистрам относительно предыдущих расчетов
	РасчетРазницыСПредыдущимиРасчетами(ПараметрыРасчета);
	
	Если ПараметрыРасчета.ФО.ФормироватьФинансовыйРезультат Тогда
		// Формирует движения по регистрам:
		// - ФинансовыеРезультаты
		РаспределитьВыручкуПоНаправлениямДеятельности(ПараметрыРасчета);
	КонецЕсли;
	
	// Формирует движения по регистрам:
	// - ПрочиеАктивыПассивы
	ОтразитьПрибылиИУбытки(ПараметрыРасчета);
	
	// Этап Распределение расходов будущих периодов
	// Формирует движения по регистрам;
	// - ПрочиеРасходы
	РасчетСебестоимостиПостатейныеЗатраты.РаспределитьРасходыБудущихПериодов(ПараметрыРасчета);
	
	Если ПараметрыРасчета.ФО.ФормироватьУправленческийБаланс Тогда
		// Формирует движения управленческого баланса
		ОтразитьВУправленческомБалансе(ПараметрыРасчета);
	КонецЕсли;
	
	// Записываем движения (в случае, если расчет себестоимости запущен самостоятельно, а не как этап расчета партий)
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаписатьСформированныеДвижения(
		ПараметрыРасчета,
		ПараметрыОтладки.ПротоколыРасчета);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

#Область ОбработчикиЭтаповЗакрытияМесяца

#Область ИсправлениеОшибокВИсходныхДанных

// Добавляет этап в таблицу этапов закрытия месяца.
// Элементы данной таблицы являются элементами второго уровня в дереве этапов в форме закрытия месяца.
// 
// Параметры:
// 	ТаблицаЭтапов - см. Обработки.ОперацииЗакрытияМесяца.ЗаполнитьОписаниеЭтаповЗакрытияМесяца
// 	ТекущийРодитель - Строка - идентификатор группы.
Процедура ДобавитьЭтап_ОчисткаДвиженийПриОтключенномУчетеСебестоимости(ТаблицаЭтапов,ТекущийРодитель) Экспорт
	
	НоваяСтрока = ЗакрытиеМесяцаСервер.ДобавитьЭтапВТаблицу(ТаблицаЭтапов, ТекущийРодитель,
		Справочники.ОперацииЗакрытияМесяца.ОчисткаДвиженийПриОтключенномУчетеСебестоимости,
		Истина, Ложь, Ложь);
	
	НоваяСтрока.МультиязычноеНаименование = "ru = 'Очистка неиспользуемых движений по регистрам учета себестоимости';
											|en = 'Clearing unused records by cost accounting registers'"; // @НСтр-1
	НоваяСтрока.ВыполняетсяВручную = Истина;
	НоваяСтрока.ТекстВыполнить     = НСтр("ru = 'Очистить';
											|en = 'Clear'");
	НоваяСтрока.ДействиеИспользование = ЗакрытиеМесяцаСервер.ОписаниеДействия_СервернаяПроцедура(
		"РасчетСебестоимостиКорректировкаСтоимости.Использование_ОчисткаДвиженийПриОтключенномУчетеСебестоимости");
	НоваяСтрока.ДействиеВыполнить  = ЗакрытиеМесяцаСервер.ОписаниеДействия_ОткрытьФорму(
		Метаданные.Обработки.ОчисткаДвиженийПриОтключенномУчетеСебестоимости.Формы.Форма.ПолноеИмя());
	
КонецПроцедуры

// Обработчики этапа.

// Процедура определяет необходимость выполнения этапа.
//
// Параметры:
//  ПараметрыОбработчика - Структура - параметры обработчика события этапа.
//
Процедура Использование_ОчисткаДвиженийПриОтключенномУчетеСебестоимости(ПараметрыОбработчика) Экспорт
	
	КоличествоДокументов = Обработки.ОчисткаДвиженийПриОтключенномУчетеСебестоимости.КоличествоРегистраторовСНеиспользуемымиДвижениями();
	
	Если КоличествоДокументов = 0 Тогда
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеТребуется(
			ПараметрыОбработчика,
			НСтр("ru = 'При отключенном учете себестоимости отсутствуют документы с движениями по регистрам учета себестоимости.';
				|en = 'When the cost accounting is off, there are no documents with records by cost accounting registers.'"));
		
	Иначе
		
		ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'При отключенном учете себестоимости найдены документы с движениями по регистрам учета себестоимости: %1';
				|en = 'When the cost accounting is off, documents with records by cost accounting registers are found:%1'"),
			Формат(КоличествоДокументов, "ЧГ="));
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
			ПараметрыОбработчика,
			ТекстСообщения,
			,
			,
			Перечисления.ВажностьПроблемыУчета.Ошибка);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область РасчетПартийИСебестоимости

// Добавляет этап в таблицу этапов закрытия месяца.
// Элементы данной таблицы являются элементами второго уровня в дереве этапов в форме закрытия месяца.
// 
// Параметры:
// 	ТаблицаЭтапов - см. Обработки.ОперацииЗакрытияМесяца.ЗаполнитьОписаниеЭтаповЗакрытияМесяца
// 	ТекущийРодитель - Строка - идентификатор группы.
//
Процедура ДобавитьЭтап_РасчетПартийИСебестоимости(ТаблицаЭтапов,ТекущийРодитель) Экспорт
	НоваяСтрока = ЗакрытиеМесяцаСервер.ДобавитьЭтапВТаблицу(ТаблицаЭтапов, ТекущийРодитель,
		Справочники.ОперацииЗакрытияМесяца.РасчетПартийИСебестоимости);
	ПредшествующиеЭтапы = НоваяСтрока.ПредшествующиеЭтапы; // Массив	
	ПредшествующиеЭтапы.Добавить(Справочники.ОперацииЗакрытияМесяца.ОформлениеВыкупаТоваров);
	ПредшествующиеЭтапы.Добавить(Справочники.ОперацииЗакрытияМесяца.ОформлениеОстатковТоваровКПередаче);
	ПредшествующиеЭтапы.Добавить(Справочники.ОперацииЗакрытияМесяца.ОформлениеОтчетовКомитентамОСписании);
	ПредшествующиеЭтапы.Добавить(Справочники.ОперацииЗакрытияМесяца.ОформлениеОтчетовПоКомиссииМеждуОрганизациями);
	ПредшествующиеЭтапы.Добавить(Справочники.ОперацииЗакрытияМесяца.ОформлениеПередачТоваров);
	//++ НЕ УТ
	ПредшествующиеЭтапы.Добавить(Справочники.ОперацииЗакрытияМесяца.ОформлениеПроизводстваБезЗаказов);
	//-- НЕ УТ
	ПредшествующиеЭтапы.Добавить(Справочники.ОперацииЗакрытияМесяца.ФормированиеДвиженийПоРасчетамСПартнерамиИПереоценкаРасчетов);
	
	НоваяСтрока.МультиязычноеНаименование = "ru = 'Распределение затрат и расчет себестоимости';
											|en = 'Cost allocation and cost calculation'"; // @НСтр-1
	НоваяСтрока.ТекстВыполнить = НСтр("ru = 'Рассчитать';
										|en = 'Calculate'");
	НоваяСтрока.ДействиеИспользование = ЗакрытиеМесяцаСервер.ОписаниеДействия_СервернаяПроцедура(
		"РасчетСебестоимостиКорректировкаСтоимости.Использование_РасчетПартийИСебестоимости");
	НоваяСтрока.ДействиеОформление = ЗакрытиеМесяцаСервер.ОписаниеДействия_СервернаяПроцедура(
		"РасчетСебестоимостиКорректировкаСтоимости.Оформление_РасчетПартийИСебестоимости");
	НоваяСтрока.ДействиеВыполнить  = ЗакрытиеМесяцаСервер.ОписаниеДействия_ВыполнитьРасчет(
		"РасчетСебестоимостиКорректировкаСтоимости.Выполнить_РасчетПартийИСебестоимости");
	НоваяСтрока.ДействиеПодробнее = ЗакрытиеМесяцаСервер.ОписаниеДействия_ОткрытьФорму(
		Метаданные.РегистрыСведений.ПротоколыРасчетаПартийИСебестоимости.Формы.ФормаПросмотраПротоколов.ПолноеИмя());
	НоваяСтрока.ДействиеПодробнее.ОткрыватьВместоЖР = Истина;
	НоваяСтрока.ДействиеПодробнее.НеТребуетсяПриУспешномВыполнении = Истина;
	НоваяСтрока.ВыполняетсяПриПредварительномЗакрытииМесяца = Истина;
	
КонецПроцедуры

// Обработчики этапа.

Процедура Использование_РасчетПартийИСебестоимости(ПараметрыОбработчика) Экспорт
	
	ПараметрыРасчета = ПараметрыОбработчика.ПараметрыРасчета;
	ПериодРасчета    = ПараметрыРасчета.ПериодРегистрации;
	
	// Проверим ведение учета себестоимости - расчет возможен начиная с месяца, предшествующему началу учета (с момента ввода остатков).
	Если НЕ РасчетСебестоимостиПовтИсп.ВозможенРасчетСебестоимости(НачалоМесяца(ПериодРасчета)) Тогда
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеТребуется(
			ПараметрыОбработчика,
			НСтр("ru = 'Нет движений по регистрам себестоимости и прочих расходов.';
				|en = 'No records in registers of cost and other expenses.'"));
		Возврат;
	КонецЕсли;
	
	Если ПараметрыОбработчика.Свойство("ТолькоОднаОрганизация") И ПараметрыОбработчика.ТолькоОднаОрганизация Тогда
		ПараметрыОбработчика.ДанныеЭтапа.МассивОрганизаций = ОбщегоНазначенияУТКлиентСервер.Массив(ПараметрыРасчета.МассивОрганизаций);
	Иначе
		// Дополним связанными по Интеркампани организациями и добавим информационные сообщения.
		ПараметрыОбработчика.ДанныеЭтапа.МассивОрганизаций = РасчетСебестоимостиПрикладныеАлгоритмы.СвязиОрганизацийПоСхемеИнтеркампани(
			ПериодРасчета,
			ПараметрыРасчета.МассивОрганизаций);
	КонецЕсли;
	
	МассивОрганизаций = ПараметрыОбработчика.ДанныеЭтапа.МассивОрганизаций;
	МассивДополнительныеОрганизации = Новый Массив;
	
	Для Каждого ТекущаяОрганизация Из МассивОрганизаций Цикл
		Если ПараметрыРасчета.МассивОрганизаций.Найти(ТекущаяОрганизация) = Неопределено Тогда
			МассивДополнительныеОрганизации.Добавить(ТекущаяОрганизация);
		КонецЕсли;
	КонецЦикла;
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, МассивОрганизаций.Количество());
	
	Если МассивДополнительныеОрганизации.Количество() > 0 Тогда
		
		ТекстДополнительныеОрганизации = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'Также будет выполнен расчет для организаций, связанных по схеме Интеркампани: %1';
				|en = 'Calculation will be also performed for companies connected under Intercompany: %1'", ОбщегоНазначения.КодОсновногоЯзыка()),
			РасчетСебестоимостиПрикладныеАлгоритмы.ПредставлениеОрганизаций(МассивДополнительныеОрганизации, ", ", Истина));
		
		ЗакрытиеМесяцаСервер.ДобавитьПоясняющуюИнформациюКЭтапу(
			ПараметрыОбработчика,
			ТекстДополнительныеОрганизации,
			,
			,
			Перечисления.ВажностьПроблемыУчета.ВажнаяИнформация);
		
	КонецЕсли;
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, МассивОрганизаций.Количество());
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.ПроверитьНеобходимостьВключенияНастройкиРаспределениеДопРасходовПоВыбывшимТоварам(ПараметрыРасчета) Тогда
		
		ТекстРекомендации = НСтр("ru = 'Обнаружены расходы, которые можно списать на выбытия прошлых периодов.
			|Рекомендуется включить настройку ""Распределение доп. расходов по выбывшим товарам"".';
			|en = 'Expenses which can be written off as outflows of previous periods are detected.
			|It is recommended that you enable the ""Allocate add. expenses by retired goods"" setting.'", ОбщегоНазначения.КодОсновногоЯзыка());
		
		ОписаниеДействия = ЗакрытиеМесяцаСервер.ОписаниеДействия_ОткрытьФорму(
				Метаданные.Обработки.ПанельАдминистрированияУТ.Формы.ФинансовыйРезультатИКонтроллинг.ПолноеИмя());
		
		ЗакрытиеМесяцаСервер.ДобавитьПоясняющуюИнформациюКЭтапу(
			ПараметрыОбработчика,
			ТекстРекомендации,
			,
			ОписаниеДействия,
			Перечисления.ВажностьПроблемыУчета.ПолезныйСовет);
		
	КонецЕсли;
	
	НачалоПериодаРасчета = Макс(
		РасчетСебестоимостиПрикладныеАлгоритмы.НачалоПериодаРасчета(ПериодРасчета, МассивОрганизаций),
		НачалоМесяца(НачалоМесяца(Константы.ДатаНачалаУчетаСебестоимости.Получить()) - 1));
	
	Если НачалоПериодаРасчета <= ПериодРасчета Тогда
		
		ПараметрыОбработчика.ДанныеЭтапа.ДатаНачалаРасчета = НачалоПериодаРасчета;
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
			ПараметрыОбработчика,
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Требуется пересчет начиная с периода %1.';
					|en = 'Recalculation is required starting from the period of %1.'"),
				РасчетСебестоимостиПротоколРасчета.ПредставлениеПериодаРасчета(НачалоПериодаРасчета)));
		Возврат; // партии не актуальны
		
	КонецЕсли;
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, 1);
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.ЕстьНекорректныеДвиженияСебестоимости(ПериодРасчета, МассивОрганизаций) Тогда
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
			ПараметрыОбработчика,
			НСтр("ru = 'Период еще не был пересчитан в партионном учете версии 2.2.';
				|en = 'Period has not been recalculated in lot accounting 2.2.'"));
		Возврат; // период не рассчитывался в партионном учете версии 2.2
		
	КонецЕсли;
	
	ОрганизацииСДвижениямиПоСебестоимости = РасчетСебестоимостиПрикладныеАлгоритмы.ОрганизацииСДвижениямиПоСебестоимости(
		ПериодРасчета,
		МассивОрганизаций);
		
	Если РасчетСебестоимостиПрикладныеАлгоритмы.ЕстьОбязательныеКорректировкиОстатков(ПериодРасчета) Тогда
		ОрганизацииСОстаткамиПоСебестоимости = РасчетСебестоимостиПрикладныеАлгоритмы.ОрганизацииСОстаткамиПоСебестоимости(
			ПериодРасчета,
			МассивОрганизаций);
	Иначе
		ОрганизацииСОстаткамиПоСебестоимости = Неопределено;
	КонецЕсли;
	
	ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, ОрганизацииСДвижениямиПоСебестоимости.Количество());
	
	Если (ЗначениеЗаполнено(ОрганизацииСДвижениямиПоСебестоимости)
	 	И НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ЕстьДокументыРасчетаСебестоимости(ПериодРасчета, ОрганизацииСДвижениямиПоСебестоимости))
	 ИЛИ (ЗначениеЗаполнено(ОрганизацииСОстаткамиПоСебестоимости)
	 	И НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ЕстьДокументыРасчетаСебестоимости(НачалоМесяца(ПериодРасчета - 1), ОрганизацииСОстаткамиПоСебестоимости)) Тогда
		
		ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
			ПараметрыОбработчика,
			НСтр("ru = 'Расчет себестоимости в данном периоде еще не выполнялся.';
				|en = 'Cost has not been calculated in this period.'"),
			,
			,
			Перечисления.ВажностьПроблемыУчета.Предупреждение);
		Возврат;
		
	КонецЕсли;
	
	Если ПараметрыОбработчика.ПараметрыРасчета.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ОкончательноеЗакрытие
	 И РасчетСебестоимостиПрикладныеАлгоритмы.ЕстьДокументыПредварительногоРасчетаСебестоимости(ПериодРасчета, 
	 	ОрганизацииСДвижениямиПоСебестоимости) Тогда
	 		
	 	ЗакрытиеМесяцаСервер.УстановитьСостояниеНеВыполнен(
			ПараметрыОбработчика,
			НСтр("ru = 'В данном периоде было выполнено только предварительное закрытие месяца.';
				|en = 'Only preliminary month-end closing has been performed in this period.'"),
			,
			,
			Перечисления.ВажностьПроблемыУчета.Предупреждение);
		Возврат;
		
	КонецЕсли;
	
	РасчетСебестоимостиЛокализация.Использование_РасчетПартийИСебестоимости(ПараметрыОбработчика);
	
КонецПроцедуры

Процедура Оформление_РасчетПартийИСебестоимости(ПараметрыОбработчика) Экспорт
	
	ПараметрыОбработчика.ДанныеЭтапа.ТекстПодробнее = "";
	
	Если ЗакрытиеМесяцаСервер.ТребуетсяПересчетЭтапа(ПараметрыОбработчика.ДанныеЭтапа) Тогда
		
		ПротоколыРасчета = РегистрыСведений.ОшибкиРасчетаПартийИСебестоимости.ПолучитьПротоколыРасчета(
			ПараметрыОбработчика.ПараметрыРасчета.ПериодРегистрации,
			ПараметрыОбработчика.ПараметрыРасчета.МассивОрганизаций);
		
		ЗакрытиеМесяцаСервер.УвеличитьКоличествоОбработанныхДанныхДляЗамера(ПараметрыОбработчика, ПротоколыРасчета.Количество());
		
		Если ЗначениеЗаполнено(ПротоколыРасчета) Тогда
			ПараметрыОбработчика.ДанныеЭтапа.ТекстПодробнее = ЗакрытиеМесяцаСервер.ТекстПодробнееПоУмолчанию();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура Выполнить_РасчетПартийИСебестоимости(ПараметрыОбработчика) Экспорт
	
	РегистрыСведений.ЗаданияКРасчетуСебестоимости.СоздатьЗаписьРегистра(
		ПараметрыОбработчика.ПараметрыРасчета.ПериодРегистрации,
		Неопределено,
		ПараметрыОбработчика.ПараметрыРасчета.МассивОрганизаций);
		
	ПараметрыЗапуска = Новый Структура;
	ПараметрыЗапуска.Вставить("Дата", 					    ПараметрыОбработчика.ПараметрыРасчета.ПериодРегистрации);
	ПараметрыЗапуска.Вставить("НачалоПериода", 				ПараметрыОбработчика.ПараметрыРасчета.НачалоПериода);
	ПараметрыЗапуска.Вставить("КонецПериода", 				ПараметрыОбработчика.ПараметрыРасчета.КонецПериода);
	ПараметрыЗапуска.Вставить("МассивОрганизаций",  	    ПараметрыОбработчика.ПараметрыРасчета.МассивОрганизаций);
	ПараметрыЗапуска.Вставить("МестоВызоваРасчета", 	    "РасчетСебестоимостиКорректировкаСтоимости.Выполнить_РасчетПартийИСебестоимости");
	ПараметрыЗапуска.Вставить("ВыполняетсяЗакрытиеМесяца",  Истина);
	ПараметрыЗапуска.Вставить("АвтоматическоеТестирование", ПараметрыОбработчика.АвтоматическоеТестирование);
	ПараметрыЗапуска.Вставить("РежимЗакрытияМесяца",        ПараметрыОбработчика.РежимЗакрытияМесяца);
	ПараметрыЗапуска.Вставить("ИдентификаторРасчета", 		ПараметрыОбработчика.ИдентификаторРасчета);
	
	Если ПараметрыОбработчика.Свойство("ТолькоОднаОрганизация") Тогда 
		ПараметрыЗапуска.Вставить("ТолькоОднаОрганизация",	ПараметрыОбработчика.ТолькоОднаОрганизация);
	Иначе
		ПараметрыЗапуска.Вставить("ТолькоОднаОрганизация",	Ложь);
	КонецЕсли;
	
	РасчетСебестоимости.РассчитатьВсеВПопыткеИсключении(ПараметрыЗапуска);
	
КонецПроцедуры

// Проверки состояния системы, относящиеся к этапу.

Процедура ОписаниеПроверок_РасчетПартийИСебестоимости(ТаблицаПроверок) Экспорт
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗаполнитьПроверкиДляРегистрации(ТаблицаПроверок);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область Инициализация

// Перед началом расчета заполняет все необходимые параметры и инициализирует все структуры данных, используемые алгоритма расчета.
// Если расчет себестоимости вызывается не самостоятельно, а как этап расчета партий,
// то параметр ПараметрыРасчета уже будет инициализирован общими свойствами механизмов расчета.
//
// Внимание: если какая-то сущность используется более чем в одном этапе расчета, то ее стоит занести в ПараметрыРасчета.
//
Процедура ИнициализироватьОбщиеПараметрыРасчетаСебестоимости(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ИнициализироватьОбщиеПараметрыРасчетаСебестоимости");
	
	// Создадим контейнер всех параметров, используемых механизмом расчета партий
	ПараметрыИнициализации = Новый Структура;
	ТолькоРасчетСебестоимости =
		?(ПараметрыЗапуска.Свойство("ТолькоРасчетСебестоимости"), ПараметрыЗапуска.ТолькоРасчетСебестоимости, Ложь);
	ПредварительныйРасчет =
		?(ПараметрыЗапуска.Свойство("ПредварительныйРасчет"), ПараметрыЗапуска.ПредварительныйРасчет, Ложь);
	ПараметрыИнициализации.Вставить("Дата",
		?(ТолькоРасчетСебестоимости И ПредварительныйРасчет,
			КонецДня(ПараметрыЗапуска.Дата), КонецМесяца(ПараметрыЗапуска.Дата)));
	ПараметрыИнициализации.Вставить("НачалоПериода", НачалоМесяца(ПараметрыЗапуска.Дата));
	ПараметрыИнициализации.Вставить("КонецПериода", ПараметрыИнициализации.Дата);
	Если ПараметрыЗапуска.Свойство("ТолькоОднаОрганизация") И ПараметрыЗапуска.ТолькоОднаОрганизация Тогда
		ПараметрыИнициализации.Вставить("МассивОрганизаций", ПараметрыЗапуска.МассивОрганизаций);
	Иначе
		ПараметрыИнициализации.Вставить("МассивОрганизаций",
			?(ТипЗнч(ПараметрыЗапуска.МассивОрганизаций) <> Тип("Массив") И ЗначениеЗаполнено(ПараметрыЗапуска.МассивОрганизаций),
				РасчетСебестоимостиПрикладныеАлгоритмы.СвязиОрганизацийПоСхемеИнтеркампани(НачалоМесяца(ПараметрыЗапуска.Дата), ПараметрыЗапуска.МассивОрганизаций),
				ПараметрыЗапуска.МассивОрганизаций));
	КонецЕсли;
	ПараметрыИнициализации.Вставить("ЗапущенРасчетПартий", Ложь);
	ПараметрыИнициализации.Вставить("ТолькоПредварительныйРасчетСебестоимости",
		?(ТолькоРасчетСебестоимости, ПредварительныйРасчет, Ложь));
	ПараметрыИнициализации.Вставить("ЗапущеноРегламентнымЗаданием", 
		?(ПараметрыЗапуска.Свойство("РегламентноеЗадание"), ПараметрыЗапуска.РегламентноеЗадание, Ложь));
	
	Если ПараметрыЗапуска.Свойство("ИзмененоДокументов") Тогда
		// Штатный вызов из механизма партионного учета версии 2.1.
		ПараметрыИнициализации.Вставить("ИзмененоДокументов", ПараметрыЗапуска.ИзмененоДокументов);
	КонецЕсли;
	Если ПараметрыЗапуска.Свойство("ОписаниеЗамера") Тогда
		// Штатный вызов из механизма партионного учета версии 2.1.
		ПараметрыИнициализации.Вставить("ОписаниеЗамера", ПараметрыЗапуска.ОписаниеЗамера);
	КонецЕсли;
	
	Если ПараметрыЗапуска.Свойство("АвтоматическоеТестирование") И ПараметрыЗапуска.АвтоматическоеТестирование Тогда
		ПараметрыИнициализации.Вставить("АвтоматическоеТестирование", Истина); // вызывается при тестировании
	Иначе
		ПараметрыИнициализации.Вставить("АвтоматическоеТестирование", Ложь);
	КонецЕсли;
	
	Если ТолькоРасчетСебестоимости И ПараметрыЗапуска.Свойство("МестоВызоваРасчета") Тогда
		ПараметрыИнициализации.Вставить("МестоВызоваРасчета", ПараметрыЗапуска.МестоВызоваРасчета);
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьОбщиеПараметрыРасчета(
		ПараметрыИнициализации, ПараметрыРасчета, ПараметрыОтладки);
		
	Если ПараметрыРасчета.ЗапущенРасчетПартий Тогда
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполняетсяМеханизмРасчетаСебестоимости(ПараметрыРасчета, Истина);
		
		Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТСтоимостьПартийТоваров") > 0 Тогда
			
			РасчетСебестоимостиПротоколРасчета.ОчисткаСформированныхДвижений(
				ПараметрыРасчета,
				Метаданные.РегистрыСведений.СтоимостьТоваров.Имя);
			
		КонецЕсли;
		
		Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВтУзлыКорректировкиСебестоимости") > 0 Тогда
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ОчиститьВременнуюТаблицу(ПараметрыРасчета, "ВтУзлыКорректировкиСебестоимости");
			РасчетСебестоимостиПрикладныеАлгоритмы.ОчиститьВременнуюТаблицу(ПараметрыРасчета, "ВтСвязиУзловКорректировкиСебестоимости");
			
		КонецЕсли;
		
	Иначе
		
		НомерЗаданияДоРасчета = РегистрыСведений.ЗаданияКРасчетуСебестоимости.ПолучитьНомерЗадания();
		ПараметрыРасчета.Вставить("НомерЗаданияДоРасчета", НомерЗаданияДоРасчета - 1);
		
		// Запомним протокол расчета и вернем его в место вызова расчета
		ПараметрыОтладки.Вставить("ПротоколыРасчета", Новый Массив);
		
		// Инициализируем кэши регистров, обслуживаемых механизмом партионного учета
		// Непосредственное обновление кэшей будет выполнено в ИнициализироватьПараметрыРасчетаСебестоимостиПоГруппеОрганизаций
		Для Каждого КлючИЗначение Из ИспользуемыеКэшиРегистровПартионногоУчета() Цикл
			
			Регистр = КлючИЗначение.Ключ; // ОбъектМетаданныхРегистрНакопления
			РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьДанныеРегистра(ПараметрыРасчета, Регистр);
			
			ОписаниеРегистра = ПараметрыРасчета.Движения[Регистр.Имя];
			ОписаниеРегистра.ИспользоватьВТКэш = Ложь; // расчетные движения брать из данных ИБ
			
		КонецЦикла;
		
	КонецЕсли;
	
	// Общие параметры расчета себестоимости
	ПараметрыРасчета.Вставить("ПредварительныйРасчет", ПредварительныйРасчет);
	ПараметрыРасчета.Вставить("СохранитьСЛУ",
		ПараметрыЗапуска.Свойство("СохранитьСЛУ") И ПараметрыЗапуска.СохранитьСЛУ);
	
КонецПроцедуры

Процедура ИнициализироватьПараметрыРасчетаСебестоимостиПоГруппеОрганизаций(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ИнициализироватьПараметрыРасчетаСебестоимостиПоГруппеОрганизаций");
	
	РасчетСебестоимостиПротоколРасчета.УвеличитьКоличествоОбработанныхДанныхДляЗамера(
		ПараметрыРасчета,
		ПараметрыЗапуска.ГруппаОрганизаций.Количество());
	
	// Заменим основной отбор по организациям на текущую рассчитываемую группу.
	// При окончании расчета себестоимости основной отбор будет восстановлен из ПараметрыРасчета.КопияМассивОрганизаций
	ТолькоОднаОрганизация = ПараметрыЗапуска.Свойство("ТолькоОднаОрганизация") И ПараметрыЗапуска.ТолькоОднаОрганизация;
	Если НЕ ТолькоОднаОрганизация Тогда
		ПараметрыРасчета.Вставить("МассивОрганизаций", ПараметрыЗапуска.ГруппаОрганизаций);
	КонецЕсли;
	ПараметрыРасчета.Вставить("МетодОценки", 	   ПараметрыЗапуска.МетодОценки); // общий метод оценки для этой группы организаций
	
	// Обновим временные таблицы с отборами по организациям.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьВременныеТаблицыДляОтборов(ПараметрыРасчета);
	
	// Обновим все расчетные кэши остатков и оборотов - в них должны быть только записи по рассчитываемой группе организаций
	// Если расчет вызван регламентной операцией, то считаем стоимость по средней (без учета партий)
	// Для этого в расчетном кэше оборотов и остатков будут "очищены" поля, относящиеся к партиям
	// Если расчет себестоимости вызван из механизма партионного учета, то по окончании расчета себестоимости
	// расчетные кэши будут восстановлены автоматически.
	РасчетСебестоимостиПрикладныеАлгоритмы.ОбновитьРасчетныеКэшиРегистров(ПараметрыРасчета);
	
	ПараметрыРасчета.Вставить("КоличествоУзлов",     0);
	ПараметрыРасчета.Вставить("КоличествоУзловРегл", 0);
	
	// Добавим информацию о текущей итерации расчета себестоимости в протокол расчета
	СтрокаПротокола = НСтр("ru = 'Вид расчета себестоимости';
							|en = 'Cost calculation kind'", ОбщегоНазначения.КодОсновногоЯзыка()) + ": "
		+ ?(ПараметрыРасчета.ПредварительныйРасчет, НСтр("ru = 'Предварительный';
														|en = 'Preliminary'", ОбщегоНазначения.КодОсновногоЯзыка()), НСтр("ru = 'Фактический';
																																|en = 'Actual'", ОбщегоНазначения.КодОсновногоЯзыка()));
	РасчетСебестоимостиПротоколРасчета.ДополнительнаяИнформация(ПараметрыРасчета, СтрокаПротокола);
	
	Если ПараметрыРасчета.ПредварительныйРасчет Тогда
		// Метод оценки не влияет на алгоритм расчета
		ПредставлениеМетодаОценки = НСтр("ru = 'Не влияет на результат расчета';
										|en = 'Does not affect the calculation result'", ОбщегоНазначения.КодОсновногоЯзыка());
	ИначеЕсли ПараметрыРасчета.ПартионныйУчетВерсии22 И НЕ ЗначениеЗаполнено(ПараметрыРасчета.МетодОценки) Тогда
		// См. РасчетСебестоимостиПрикладныеАлгоритмы.ОпределитьМетодОценкиСтоимостиДляГруппыОрганизаций
		ПредставлениеМетодаОценки = НСтр("ru = 'Отличный от ""ФИФО (взвешенная оценка)""';
										|en = 'Different from ""FIFO (weighted estimate)""'", ОбщегоНазначения.КодОсновногоЯзыка());
	Иначе
		ПредставлениеМетодаОценки = ПараметрыРасчета.МетодОценки;
	КонецЕсли;
	
	СтрокаПротокола = НСтр("ru = 'Метод оценки стоимости';
							|en = 'Cost evaluation method'", ОбщегоНазначения.КодОсновногоЯзыка()) + ": "
		+ РасчетСебестоимостиПротоколРасчета.ПредставлениеЗначения(ПредставлениеМетодаОценки);
	РасчетСебестоимостиПротоколРасчета.ДополнительнаяИнформация(ПараметрыРасчета, СтрокаПротокола);
	
	СтрокаПротокола = НСтр("ru = 'Организации';
							|en = 'Companies'", ОбщегоНазначения.КодОсновногоЯзыка()) + ": "
		+ РасчетСебестоимостиПрикладныеАлгоритмы.ПредставлениеОрганизаций(ПараметрыРасчета.МассивОрганизаций, ", ", Истина);
	РасчетСебестоимостиПротоколРасчета.ДополнительнаяИнформация(ПараметрыРасчета, СтрокаПротокола);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ОчиститьВременнуюТаблицу(ПараметрыРасчета, "ВТПромежуточнаяСебестоимостьТоваров");
	
КонецПроцедуры

#КонецОбласти

#Область ЭтапыРасчета

// Этап 9 (вызов механизма расчета себестоимости)
//
Процедура КорректировкаСтоимостиВозвратовИсправленийПрошлыхПериодов(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки) Экспорт
	
	Если НЕ ПараметрыРасчета.ИспользоватьУчетСебестоимости Тогда
		Возврат;
	КонецЕсли;
	
	// Инициализируем параметры расчета
	ИнициализироватьОбщиеПараметрыРасчетаСебестоимости(ПараметрыЗапуска, ПараметрыРасчета, ПараметрыОтладки);
	
	// Формирует движения по регистрам (если выполняется фактический расчет):
	// - СебестоимостьТоваров
	// - ВыручкаИСебестоимостьПродаж
	// - ПрочиеРасходы
	// - ПрочиеДоходы
	// - ДвиженияНоменклатураДоходыРасходы
	// - ДвиженияНоменклатураНоменклатура
	СкорректироватьСтоимостьВозвратовПрошлыхПериодов(ПараметрыРасчета);
	
	// Формирует движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	// - ПрочиеДоходы
	// - ДвиженияНоменклатураДоходыРасходы
	// - ДвиженияНоменклатураНоменклатура
	СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов(ПараметрыРасчета);
	
	// Этап сохранения движений документа "Распределение расходов будущих периодов" в кэш.
	// Формирует движения по регистрам:
	// - ПрочиеРасходы
	ПодготовкаДанныхДляПрочихРасходов(ПараметрыРасчета);
	
	СохранитьДвиженияРасчетаСебестоимостиРассчитанныхДокументов(ПараметрыРасчета);
	
	Если ПараметрыРасчета.ЗапущенРасчетПартий Тогда
			
		// Возврат в механизм расчета партий из расчета себестоимости
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполняетсяМеханизмРасчетаСебестоимости(ПараметрыРасчета, Ложь);
			
		// Восстановим все расчетные кэши остатков и оборотов по всем организациям
		РасчетСебестоимостиПрикладныеАлгоритмы.ОбновитьРасчетныеКэшиРегистров(ПараметрыРасчета);
		
	КонецЕсли;
		
КонецПроцедуры

// Этап сохранения движений документа "Распределение расходов будущих периодов" в кэш.
//
Процедура ПодготовкаДанныхДляПрочихРасходов(ПараметрыРасчета) Экспорт

	Если ПараметрыРасчета.ПредварительныйРасчет Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ПодготовкаДанныхДляПрочихРасходов");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Период,
	|	Т.ВидДвижения,
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.Сумма,
	|	Т.СуммаБезНДС,
	|	Т.СуммаРегл,
	|	Т.СуммаУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.СуммаНДД,
	|	Т.КорПодразделение,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорСтатьяРасходов,
	|	Т.КорАналитикаРасходов,
	|	Т.ХозяйственнаяОперация
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходы
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеРасходовБудущихПериодов КАК Распределение
	|		ПО Распределение.Ссылка = Т.Регистратор 
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Активность
	|	И Распределение.Дата < &НачалоПериода
	|	И (Т.РасчетПартий ИЛИ Т.РасчетСебестоимости)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.ВидДвижения,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.НаправлениеДеятельности,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.НДСРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДСУпр,
	|	Т.НалогообложениеНДС,
	|	Т.ДокументРеализации,
	|	Т.СтатьяОтраженияРасходов,
	|	Т.АналитикаОтраженияРасходов,
	|	Т.ПериодБазы,
	|	Т.ИдентификаторСтроки,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.Сторно,
	|	Т.КорСтатьяРасходов,
	|	Т.КорАналитикаРасходов,
	|	Т.КорПодразделение,
	|	Т.КорНаправлениеДеятельности,
	|	Т.ВидИсточника,
	|	Т.КорГруппаПродукции
	|ПОМЕСТИТЬ ВтДвиженияПартииПрочихРасходов
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеРасходовБудущихПериодов КАК Распределение
	|		ПО Распределение.Ссылка = Т.Регистратор
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В(&МассивОрганизаций)
	|	И Т.Активность
	|	И Распределение.Дата < &НачалоПериода
	|	И (Т.РасчетПартий ИЛИ Т.РасчетСебестоимости)";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя, "РБП");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеРасходы";
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя, "РБП");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПартииПрочихРасходов";
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

// Этап 3.3
// Выполняет корректировку стоимости возвратов прошлых периодов
// К возвратам прошлых периодов относятся приходные движения в регистре себестоимости с хозяйственной операцией из массива МассивОперацийВозвратыПрошлыхПериодов()
// Отличия возвратов прошлых периодов от возвратов текущего периода заключается в методе определения стоимости возврата
// стоимость нужно взять из периода из периода первичного документа.
// - если в движении возврата заполненен ДокументИсточник (первичный документ), то стоимость берется из движений этого документа
//	= если первичный документ находится в периоде, когда не велся партионный учет 2.2, то при соединении с таблицей стоимостей не выполняется соединение по полям партионного учета 2.2
//	= если первичный документ находится в периоде партионного учета 2.2, то соединение выполняется по всем полям
// - если ДокументИсточник не заполнен, то стоимость берется из регистра сведений СтоимостьТоваров за период ПериодРеализации
// 	= для возврата по отчету комиссионера ПериодРеализации заполняется не в движениях возврата, а с использованием таблицы СторноОтчетыКомиссионера
// Помимо стоимости возвращаемого товара необходимо вернуть дополнительные расходы, отнесенные на этот товар.
// Суммы дополнительных расходов хранятся в таблице ВтСуммыДопРасходовПрошлыхПериодов
//
// Особенность заполнения полей ВидДеятельности и КорВиддеятельности:
// эти поля в движении возврата должны заполняться точно так же, как в первичном документе.
// Исходные значения этих полей определяется в процедуре РасчетСебестоимостиЗаполнениеПартий.ТекстРеализацииПрошлыхМесяцев()
// и из этих данных подставляются в движения возврата
// (также смотри РасчетСебестоимостиЗаполнениеПартий.ЗаполнитьРасчетнуюПартиюСебестоимостиТоваров, источник Прошлое, приемник ВозвратПрошлыхПериодов)
//
// Особенность включения/исключение НДС:
// помимо включения/исключения НДС в расходных движениях необходимо сторнировать данную операцию в движениях документа возврата.
// Сторнирование включения/исключения НДС нужно выполнять по тем же регистрам, что и в первичном документе.
//++ Локализация
// смотри РасчетСебестоимостиНДС.ВключитьИсключитьНДСВСтоимость24
// смотри РасчетСебестоимостиНДС.ВключитьИсключитьНДСВСтоимостьПродаж24
//-- Локализация
//
Процедура СкорректироватьСтоимостьВозвратовПрошлыхПериодов(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьВозвратовПрошлыхПериодов");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;

#Область ЗапросДанных
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	АналитикаПартнеров.Организация КАК Организация,
	|	СУММА(ДД.Количество) КАК Количество,
	|	МАКСИМУМ(Стоимости.Период) КАК Период
	|ПОМЕСТИТЬ СторноОтчетыКомиссионера
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаПартнеров
	|	ПО ДД.АналитикаУчетаПоПартнерам = АналитикаПартнеров.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|	ПО АналитикаПартнеров.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СтоимостьТоваров КАК Стоимости
	|		ПО Стоимости.Период < &НачалоПериода
	|		И Стоимости.АналитикаУчетаНоменклатуры = ДД.АналитикаУчетаНоменклатуры
	|		И Стоимости.РазделУчета = ДД.РазделУчета
	|		И Стоимости.ВидЗапасов = ДД.ВидЗапасов
	|		И Стоимости.Организация = АналитикаПартнеров.Организация
	|ГДЕ
	|	ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|СГРУППИРОВАТЬ ПО
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	АналитикаПартнеров.Организация
	|ИМЕЮЩИЕ
	|	СУММА(ДД.Количество) < 0
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Себестоимость.ДокументИсточник КАК Ссылка
	|ПОМЕСТИТЬ ВтРеализацииПрошлыхПериодов
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Себестоимость
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|	ПО Себестоимость.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	Себестоимость.СлужебноеВидДвиженияПриход
	|	И Себестоимость.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов)
	|	И Себестоимость.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	// Для записей "Сторно" стоимость определяется в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() 
	|	И НЕ Себестоимость.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Себестоимость.ДокументИсточник КАК Ссылка
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Себестоимость
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|	ПО Себестоимость.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|	ПО Реестр.Ссылка = Себестоимость.ДокументИсточник
	|		И Себестоимость.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|		И (НЕ Реестр.ДополнительнаяЗапись ИЛИ Реестр.ТипСсылки В (&ДокументыСДвумяОрганизациями))
	|ГДЕ
	|	НЕ Себестоимость.СлужебноеВидДвиженияПриход
	|	И Себестоимость.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|	И Себестоимость.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратБезДокументаИсточника)
	|	И Себестоимость.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|	И Реестр.ДатаДокументаИБ < &НачалоПериода
	// Условия выборки данных должны соответствовать функциям
	// - см. РасчетСебестоимостиРешениеСЛУ.ТекстВтУзлыКорректировки_МатериальныеИТрудозатраты
	// - СкорректироватьСтоимостьСписанияЗапасов()
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Себестоимость.Регистратор                         КАК Ссылка,
	|	Себестоимость.АналитикаУчетаНоменклатуры          КАК АналитикаУчетаНоменклатуры,
	|	Себестоимость.РазделУчета                         КАК РазделУчета,
	|	Себестоимость.ВидЗапасов                          КАК ВидЗапасов,
	|	Себестоимость.Организация               		  КАК Организация,
	|	Себестоимость.Партия                          	  КАК Партия,
	|	Себестоимость.АналитикаУчетаПартий                КАК АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета           КАК АналитикаФинансовогоУчета,
	|	ВЫБОР
	|		КОГДА НЕ &ПартионныйУчетВерсии22
	|		 ИЛИ Себестоимость.Период < &ДатаПереходаНаПартионныйУчетВерсии22
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		КОГДА Себестоимость.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			ТОГДА Себестоимость.ВидДеятельностиНДС
	|		ИНАЧЕ Себестоимость.КорВидДеятельностиНДС
	|	КОНЕЦ                                             КАК ВидДеятельностиНДС,
	|
	|	СУММА(Себестоимость.Количество)                   КАК Количество,
	|	СУММА(Себестоимость.Стоимость)                    КАК Стоимость,
	|	СУММА(Себестоимость.СтоимостьБезНДС)              КАК СтоимостьБезНДС,
	|	СУММА(Себестоимость.СтоимостьЗабалансовая)        КАК СтоимостьЗабалансовая,
	|	СУММА(Себестоимость.ДопРасходы)             	  КАК ДопРасходы,
	|	СУММА(Себестоимость.ДопРасходыБезНДС)       	  КАК ДопРасходыБезНДС,
	|	СУММА(Себестоимость.Трудозатраты)       		  КАК Трудозатраты,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеСНДС)    КАК ПостатейныеПостоянныеСНДС,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеБезНДС)  КАК ПостатейныеПостоянныеБезНДС,
	|	СУММА(Себестоимость.ПостатейныеПеременныеСНДС)    КАК ПостатейныеПеременныеСНДС,
	|	СУММА(Себестоимость.ПостатейныеПеременныеБезНДС)  КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(Себестоимость.СтоимостьРегл)                КАК СтоимостьРегл,
	|	СУММА(Себестоимость.СтоимостьЗабалансоваяРегл)    КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Себестоимость.ПостояннаяРазница)            КАК ПостояннаяРазница,
	|	СУММА(Себестоимость.ВременнаяРазница)             КАК ВременнаяРазница,
	|	СУММА(Себестоимость.СтоимостьНДД)                 КАК СтоимостьНДД,
	|	СУММА(Себестоимость.ДопРасходыРегл)               КАК ДопРасходыРегл,
	|	СУММА(Себестоимость.ТрудозатратыРегл)             КАК ТрудозатратыРегл,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеРегл)    КАК ПостатейныеПостоянныеРегл,
	|	СУММА(Себестоимость.ПостатейныеПеременныеРегл)    КАК ПостатейныеПеременныеРегл,
	|	СУММА(Себестоимость.СтоимостьУпр)    			  КАК СтоимостьУпр,
	|	СУММА(Себестоимость.ДопРасходыУпр)    			  КАК ДопРасходыУпр,
	|	СУММА(Себестоимость.ТрудозатратыУпр)    		  КАК ТрудозатратыУпр,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеУпр)     КАК ПостатейныеПостоянныеУпр,
	|	СУММА(Себестоимость.ПостатейныеПеременныеУпр)     КАК ПостатейныеПеременныеУпр
	|ПОМЕСТИТЬ ВтСуммыРеализацийПрошлыхПериодов
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Себестоимость
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРеализацииПрошлыхПериодов КАК Продажи
	|		ПО Продажи.Ссылка = Себестоимость.Регистратор
	|ГДЕ
	|	Себестоимость.Период < &НачалоПериода
	|	И Себестоимость.Организация В(&МассивОрганизаций)
	|	И Себестоимость.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Себестоимость.Активность
	|
	|СГРУППИРОВАТЬ ПО
	|	Себестоимость.Регистратор,
	|	Себестоимость.АналитикаУчетаНоменклатуры,
	|	Себестоимость.РазделУчета,
	|	Себестоимость.ВидЗапасов,
	|	Себестоимость.Организация,
	|	Себестоимость.Партия,
	|	Себестоимость.АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета,
	|	ВЫБОР
	|		КОГДА НЕ &ПартионныйУчетВерсии22
	|		 ИЛИ Себестоимость.Период < &ДатаПереходаНаПартионныйУчетВерсии22
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		КОГДА Себестоимость.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			ТОГДА Себестоимость.ВидДеятельностиНДС
	|		ИНАЧЕ Себестоимость.КорВидДеятельностиНДС
	|	КОНЕЦ
	|
	|ИМЕЮЩИЕ
	|	СУММА(Себестоимость.Количество) <> 0
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СебестоимостьПродаж.ДокументДвижения                  КАК Ссылка,
	|	СебестоимостьПродаж.АналитикаУчетаНоменклатуры        КАК АналитикаУчетаНоменклатуры,
	|	СебестоимостьПродаж.РазделУчета                       КАК РазделУчета,
	|	СебестоимостьПродаж.ВидЗапасов                        КАК ВидЗапасов,
	|	СебестоимостьПродаж.Организация               		  КАК Организация,
	|	СебестоимостьПродаж.Партия                            КАК Партия,
	|	СебестоимостьПродаж.АналитикаУчетаПартий              КАК АналитикаУчетаПартий,
	|	СебестоимостьПродаж.АналитикаФинансовогоУчета         КАК АналитикаФинансовогоУчета,
	|	СебестоимостьПродаж.ВидДеятельностиНДС                КАК ВидДеятельностиНДС,
	|
	|	СУММА(СебестоимостьПродаж.ДопРасходы)             	  КАК ДопРасходы,
	|	СУММА(СебестоимостьПродаж.ДопРасходыБезНДС)       	  КАК ДопРасходыБезНДС,
	|	СУММА(СебестоимостьПродаж.ДопРасходыРегл)             КАК ДопРасходыРегл,
	|	СУММА(СебестоимостьПродаж.ДопРасходыУпр)    		  КАК ДопРасходыУпр
	|
	|ПОМЕСТИТЬ ВтСуммыДопРасходовПрошлыхПериодов
	|ИЗ (
	|	ВЫБРАТЬ
	|		СебестоимостьПродаж.ДокументДвижения,
	|		СебестоимостьПродаж.АналитикаУчетаНоменклатуры,
	|		СебестоимостьПродаж.РазделУчета,
	|		СебестоимостьПродаж.ВидЗапасов,
	|		АналитикаПартнеров.Организация,
	|		СебестоимостьПродаж.Партия,
	|		СебестоимостьПродаж.АналитикаУчетаПартий,
	|		СебестоимостьПродаж.АналитикаФинансовогоУчета,
	|		СебестоимостьПродаж.ВидДеятельностиНДС,
	|
	|		СебестоимостьПродаж.ДопРасходы,
	|		СебестоимостьПродаж.ДопРасходыБезНДС,
	|		СебестоимостьПродаж.ДопРасходыРегл,
	|		СебестоимостьПродаж.ДопРасходыУпр
	|	ИЗ
	|		РегистрНакопления.ВыручкаИСебестоимостьПродаж КАК СебестоимостьПродаж
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаПартнеров
	|			ПО СебестоимостьПродаж.АналитикаУчетаПоПартнерам = АналитикаПартнеров.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРеализацииПрошлыхПериодов КАК Продажи
	|			ПО Продажи.Ссылка = СебестоимостьПродаж.ДокументДвижения
	|	ГДЕ
	|		СебестоимостьПродаж.Период < &НачалоПериода
	|		И АналитикаПартнеров.Организация В(&МассивОрганизаций)
	|		И СебестоимостьПродаж.РасчетПартий
	|		И СебестоимостьПродаж.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	ВЫБРАТЬ
	|		СебестоимостьПродаж.ДокументДвижения,
	|		СебестоимостьПродаж.АналитикаУчетаНоменклатуры,
	|		СебестоимостьПродаж.РазделУчета,
	|		СебестоимостьПродаж.ВидЗапасов,
	|		АналитикаПартнеров.Организация,
	|		СебестоимостьПродаж.Партия,
	|		СебестоимостьПродаж.АналитикаУчетаПартий,
	|		СебестоимостьПродаж.АналитикаФинансовогоУчета,
	|		СебестоимостьПродаж.ВидДеятельностиНДС,
	|
	|		СебестоимостьПродаж.ДопРасходы,
	|		СебестоимостьПродаж.ДопРасходыБезНДС,
	|		СебестоимостьПродаж.ДопРасходыРегл,
	|		СебестоимостьПродаж.ДопРасходыУпр
	|	ИЗ
	|		ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК СебестоимостьПродаж
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаПартнеров
	|			ПО СебестоимостьПродаж.АналитикаУчетаПоПартнерам = АналитикаПартнеров.Ссылка
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРеализацииПрошлыхПериодов КАК Продажи
	|			ПО Продажи.Ссылка = СебестоимостьПродаж.ДокументДвижения
	|	ГДЕ
	|		СебестоимостьПродаж.РасчетПартий
	|
	|	) КАК СебестоимостьПродаж
	|СГРУППИРОВАТЬ ПО
	|	СебестоимостьПродаж.ДокументДвижения,
	|	СебестоимостьПродаж.АналитикаУчетаНоменклатуры,
	|	СебестоимостьПродаж.РазделУчета,
	|	СебестоимостьПродаж.ВидЗапасов,
	|	СебестоимостьПродаж.Организация,
	|	СебестоимостьПродаж.Партия,
	|	СебестоимостьПродаж.АналитикаУчетаПартий,
	|	СебестоимостьПродаж.АналитикаФинансовогоУчета,
	|	СебестоимостьПродаж.ВидДеятельностиНДС
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Выручка.Регистратор,
	|	Выручка.АналитикаУчетаНоменклатуры,
	|	СпрКлючиАналитикиУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	СпрКлючиАналитикиУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	СпрКлючиАналитикиУчетаНоменклатуры.Серия КАК Серия,
	|	СпрКлючиАналитикиУчетаНоменклатуры.Назначение КАК Назначение,
	|	Выручка.ВидЗапасов,
	|	Выручка.ЗаказКлиента,
	|	МАКСИМУМ(Выручка.Соглашение) КАК Соглашение,
	|	МАКСИМУМ(Выручка.Менеджер) КАК Менеджер,
	|	МАКСИМУМ(Выручка.Склад) КАК Склад,
	|	МАКСИМУМ(Выручка.АналитикаУчетаНаборов) КАК АналитикаУчетаНаборов,
	|	МАКСИМУМ(Выручка.НаправлениеДеятельностиКонтрагента) КАК НаправлениеДеятельностиКонтрагента,
	|	МАКСИМУМ(Выручка.НаправлениеДеятельностиНоменклатуры) КАК НаправлениеДеятельностиНоменклатуры,
	|	МАКСИМУМ(Выручка.НалогообложениеНДС) КАК НалогообложениеНДС,
	|	МАКСИМУМ(Выручка.ВалютаВзаиморасчетов) КАК ВалютаВзаиморасчетов,
	|	МАКСИМУМ(Выручка.ВалютаДокумента) КАК ВалютаДокумента,
	|	МАКСИМУМ(Выручка.Договор) КАК Договор,
	|	МАКСИМУМ(Выручка.ИсточникГФУНоменклатуры) КАК ИсточникГФУНоменклатуры,
	|	МАКСИМУМ(Выручка.ИсточникГФУРасчетов) КАК ИсточникГФУРасчетов
	|ПОМЕСТИТЬ РеквизитыВыручки
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Выручка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК АналитикаПартнеров
	|	ПО Выручка.АналитикаУчетаПоПартнерам = АналитикаПартнеров.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|	ПО АналитикаПартнеров.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК СпрКлючиАналитикиУчетаНоменклатуры
	|		ПО Выручка.АналитикаУчетаНоменклатуры = СпрКлючиАналитикиУчетаНоменклатуры.Ссылка
	|ГДЕ
	|	Выручка.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов)
	|СГРУППИРОВАТЬ ПО
	|	Выручка.Регистратор,
	|	Выручка.АналитикаУчетаНоменклатуры,
	|	Выручка.ВидЗапасов,
	|	Выручка.ЗаказКлиента,
	|	СпрКлючиАналитикиУчетаНоменклатуры.Номенклатура,
	|	СпрКлючиАналитикиУчетаНоменклатуры.Характеристика,
	|	СпрКлючиАналитикиУчетаНоменклатуры.Серия,
	|	СпрКлючиАналитикиУчетаНоменклатуры.Назначение
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Движения.Регистратор,
	|	Движения.АналитикаУчетаНоменклатуры,
	|	Движения.ВидЗапасов,
	|	МАКСИМУМ(Движения.Склад) КАК Склад,
	|	МАКСИМУМ(Движения.ИсточникГФУНоменклатуры) КАК ИсточникГФУНоменклатуры
	|ПОМЕСТИТЬ РеквизитыДвиженияНоменклатураДоходыРасходы
	|ИЗ
	|	РегистрНакопления.ДвиженияНоменклатураДоходыРасходы КАК Движения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|	ПО Движения.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	Движения.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Движения.Организация В(&МассивОрганизаций)
	|	И Движения.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы)
	|	И НЕ Движения.РасчетСебестоимости
	|	И Движения.Активность
	|СГРУППИРОВАТЬ ПО
	|	Движения.Регистратор,
	|	Движения.АналитикаУчетаНоменклатуры,
	|	Движения.ВидЗапасов
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Реестр.Ссылка КАК Ссылка,
	|	МАКСИМУМ(Реестр.ДатаДокументаИБ) КАК ДатаДокументаИБ
	|
	|ПОМЕСТИТЬ ВтДатыДокументовИсточников
	|ИЗ (
	|	ВЫБРАТЬ
	|		Реестр.Ссылка КАК Ссылка,
	|		Реестр.ДатаДокументаИБ
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО УчетСебестоимости.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|			И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = УчетСебестоимости.ДокументИсточник
	|			И УчетСебестоимости.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|			И (НЕ Реестр.ДополнительнаяЗапись ИЛИ Реестр.ТипСсылки В (&ДокументыСДвумяОрганизациями))
	|	ГДЕ
	|		НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		И УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|		И УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратБезДокументаИсточника)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Реестр.Ссылка КАК Ссылка,
	|		Реестр.ДатаДокументаИБ
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО УчетСебестоимости.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|			И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = УчетСебестоимости.ДокументИсточник
	|			И УчетСебестоимости.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|			И (НЕ Реестр.ДополнительнаяЗапись ИЛИ Реестр.ТипСсылки В (&ДокументыСДвумяОрганизациями))
	|	ГДЕ
	|		УчетСебестоимости.Сторно
	|		И УчетСебестоимости.ТипЗаписи В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпускСторноПрошлогоПериода))
	|	) КАК Реестр
	|СГРУППИРОВАТЬ ПО
	|	Реестр.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Себестоимость.Период                              КАК Период,
	|	Себестоимость.Регистратор                         КАК Регистратор,
	|	ВЫБОР КОГДА Себестоимость.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ                   						  КАК ВидДвижения,
	|	Себестоимость.АналитикаУчетаНоменклатуры          КАК АналитикаУчетаНоменклатуры,
	|	Себестоимость.РазделУчета                         КАК РазделУчета,
	|	Себестоимость.ВидЗапасов                          КАК ВидЗапасов,
	|	Себестоимость.ВидЗапасов.ТипЗапасов               КАК ТипЗапасов,
	|	Себестоимость.Партия                          	  КАК Партия,
	|	Себестоимость.АналитикаУчетаПартий                КАК АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета           КАК АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС                  КАК ВидДеятельностиНДС,
	|	(ВЫБОР
	|		КОГДА Себестоимость.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			ТОГДА Себестоимость.ВидДеятельностиНДС
	|		ИНАЧЕ Себестоимость.КорВидДеятельностиНДС
	|	КОНЕЦ)                                            КАК КорВидДеятельностиНДС,
	|
	// В кор. части могут быть данные об исходной аналитике продажи (если возврат идет на другой склад)
	|	ВЫБОР КОГДА Себестоимость.КорВидЗапасов <> Значение(Справочник.ВидыЗапасов.ПустаяСсылка) ТОГДА
	|			Себестоимость.КорВидЗапасов
	|		ИНАЧЕ
	|			Себестоимость.ВидЗапасов
	|	КОНЕЦ                                             КАК ВидыЗапасовДляЦены,
	// В кор. части могут быть данные об исходном виде запасов продажи (в случае возврата проданного по Интеркампани товара)
	|	ВЫБОР КОГДА Себестоимость.КорАналитикаУчетаНоменклатуры <> Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) ТОГДА
	|			Себестоимость.КорАналитикаУчетаНоменклатуры
	|		ИНАЧЕ
	|			Себестоимость.АналитикаУчетаНоменклатуры
	|	КОНЕЦ                                             КАК АналитикаНоменклатурыДляЦены,
	|
	|	СУММА(Себестоимость.Количество)                   КАК Количество,
	|
	|	СУММА(Себестоимость.Стоимость)                    КАК Стоимость,
	|	СУММА(Себестоимость.СтоимостьБезНДС)              КАК СтоимостьБезНДС,
	|	СУММА(Себестоимость.СтоимостьЗабалансовая)        КАК СтоимостьЗабалансовая,
	|
	|	СУММА(Себестоимость.ДопРасходы)             	  КАК ДопРасходы,
	|	СУММА(Себестоимость.ДопРасходыБезНДС)       	  КАК ДопРасходыБезНДС,
	|	СУММА(Себестоимость.Трудозатраты)       		  КАК Трудозатраты,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеСНДС)	  КАК ПостатейныеПостоянныеСНДС,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеБезНДС)  КАК ПостатейныеПостоянныеБезНДС,
	|	СУММА(Себестоимость.ПостатейныеПеременныеСНДС)	  КАК ПостатейныеПеременныеСНДС,
	|	СУММА(Себестоимость.ПостатейныеПеременныеБезНДС)  КАК ПостатейныеПеременныеБезНДС,
	|
	|	СУММА(Себестоимость.СтоимостьРегл)                КАК СтоимостьРегл,
	|	СУММА(Себестоимость.СтоимостьЗабалансоваяРегл)    КАК СтоимостьЗабалансоваяРегл,
	|
	|	СУММА(Себестоимость.ПостояннаяРазница)            КАК ПостояннаяРазница,
	|	СУММА(Себестоимость.ВременнаяРазница)             КАК ВременнаяРазница,
	|
	|	СУММА(Себестоимость.СтоимостьНДД)                 КАК СтоимостьНДД,
	|
	|	СУММА(Себестоимость.ДопРасходыРегл)               КАК ДопРасходыРегл,
	|	СУММА(Себестоимость.ТрудозатратыРегл)             КАК ТрудозатратыРегл,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеРегл)	  КАК ПостатейныеПостоянныеРегл,
	|	СУММА(Себестоимость.ПостатейныеПеременныеРегл)	  КАК ПостатейныеПеременныеРегл,
	
	|	СУММА(Себестоимость.СтоимостьУпр)	  			  КАК СтоимостьУпр,
	|	СУММА(Себестоимость.ДопРасходыУпр)	  			  КАК ДопРасходыУпр,
	|	СУММА(Себестоимость.ТрудозатратыУпр)	  		  КАК ТрудозатратыУпр,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеУпр)	  КАК ПостатейныеПостоянныеУпр,
	|	СУММА(Себестоимость.ПостатейныеПеременныеУпр)	  КАК ПостатейныеПеременныеУпр,
	|
	|	Себестоимость.ХозяйственнаяОперация               КАК ХозяйственнаяОперация,
	|	Себестоимость.КорАналитикаУчетаНоменклатуры       КАК КорАналитикаУчетаНоменклатуры,
	|	Себестоимость.КорРазделУчета                      КАК КорРазделУчета,
	|	Себестоимость.КорВидЗапасов                       КАК КорВидЗапасов,
	|	Себестоимость.КорВидЗапасов.ТипЗапасов            КАК КорТипЗапасов,
	|	Себестоимость.АналитикаУчетаПоПартнерам           КАК АналитикаУчетаПоПартнерам,
	|	Себестоимость.ЗаказКлиента                        КАК ЗаказКлиента,
	|	Себестоимость.Подразделение                       КАК Подразделение,
	|	Себестоимость.Организация                         КАК Организация,
	|	Себестоимость.КорОрганизация                      КАК КорОрганизация,
	|	Себестоимость.ПериодПродажи                       КАК ПериодПродажи,
	|	ЕСТЬNULL(СторноОтчетыКомиссионера.Период,
	|		НАЧАЛОПЕРИОДА(Себестоимость.ПериодПродажи, МЕСЯЦ)) КАК ПериодРеализации,
	|	Себестоимость.АналитикаРасходов                   КАК АналитикаРасходов,
	|	Себестоимость.СтатьяРасходовСписания              КАК СтатьяРасходовСписания,
	|	Себестоимость.СтатьяДоходов                       КАК СтатьяДоходов,
	|	Себестоимость.АналитикаДоходов                    КАК АналитикаДоходов,
	|	Себестоимость.ГруппаПродукции                     КАК ГруппаПродукции,
	|	Себестоимость.ИдентификаторСтроки                 КАК ИдентификаторСтроки,
	|	Себестоимость.КодСтроки                 		  КАК КодСтроки,
	|	Себестоимость.КорПартия                 		  КАК КорПартия,
	|	Себестоимость.КорАналитикаУчетаПартий             КАК КорАналитикаУчетаПартий,
	|	Себестоимость.КорАналитикаФинансовогоУчета        КАК КорАналитикаФинансовогоУчета,
	|	Себестоимость.НДСРегл                 			  КАК НДСРегл,
	|	Себестоимость.НДСУпр                 			  КАК НДСУпр,
	|	Себестоимость.СтатьяКалькуляции                   КАК СтатьяКалькуляции,
	|	Себестоимость.ТипЗаписи                 		  КАК ТипЗаписи,
	|	Себестоимость.ДокументИсточник                 	  КАК ДокументИсточник,
	|	Себестоимость.КорНаправлениеДеятельности          КАК КорНаправлениеДеятельности,
	|	Себестоимость.НастройкаХозяйственнойОперации      КАК НастройкаХозяйственнойОперации,
	|	Себестоимость.ИдентификаторФинЗаписи              КАК ИдентификаторФинЗаписи,
	|	ЕСТЬNULL(РеквизитыВыручки.Соглашение, НЕОПРЕДЕЛЕНО) КАК Соглашение,
	|	ЕСТЬNULL(РеквизитыВыручки.Менеджер, НЕОПРЕДЕЛЕНО) КАК Менеджер,
	|	(ВЫБОР
	|		КОГДА НЕ СторноСписанияНаРасходы.Склад ЕСТЬ NULL
	|			ТОГДА РеквизитыДвиженияНоменклатураДоходыРасходы.Склад
	|		ИНАЧЕ ЕСТЬNULL(РеквизитыВыручки.Склад, НЕОПРЕДЕЛЕНО) КОНЕЦ) КАК Склад,
	|	ЕСТЬNULL(РеквизитыВыручки.АналитикаУчетаНаборов, НЕОПРЕДЕЛЕНО) КАК АналитикаУчетаНаборов,
	|	ЕСТЬNULL(РеквизитыВыручки.НаправлениеДеятельностиКонтрагента, НЕОПРЕДЕЛЕНО) КАК НаправлениеДеятельностиКонтрагента,
	|	ЕСТЬNULL(РеквизитыВыручки.НаправлениеДеятельностиНоменклатуры, НЕОПРЕДЕЛЕНО) КАК НаправлениеДеятельностиНоменклатуры,
	|	ЕСТЬNULL(РеквизитыВыручки.НалогообложениеНДС, НЕОПРЕДЕЛЕНО) КАК НалогообложениеНДС,
	|	ЕСТЬNULL(РеквизитыВыручки.Договор, НЕОПРЕДЕЛЕНО) КАК Договор,
	|	ЕСТЬNULL(РеквизитыВыручки.ВалютаВзаиморасчетов, НЕОПРЕДЕЛЕНО) КАК ВалютаВзаиморасчетов,
	|	ЕСТЬNULL(РеквизитыВыручки.ВалютаДокумента, НЕОПРЕДЕЛЕНО) КАК ВалютаДокумента,
	|	(ВЫБОР
	|		КОГДА НЕ СторноСписанияНаРасходы.Склад ЕСТЬ NULL
	|			ТОГДА РеквизитыДвиженияНоменклатураДоходыРасходы.ИсточникГФУНоменклатуры
	|		ИНАЧЕ ЕСТЬNULL(РеквизитыВыручки.ИсточникГФУНоменклатуры, НЕОПРЕДЕЛЕНО) КОНЕЦ) КАК ИсточникГФУНоменклатуры,
	|	ЕСТЬNULL(РеквизитыВыручки.ИсточникГФУРасчетов, НЕОПРЕДЕЛЕНО) КАК ИсточникГФУРасчетов,
	|
	|	ВЫБОР КОГДА Себестоимость.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|	  И Себестоимость.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов)
	|	  И (НЕ &ПартионныйУчетВерсии22 ИЛИ Себестоимость.ПериодПродажи < &ДатаПереходаНаПартионныйУчетВерсии22)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ											  КАК ПоЦенеПродажи,
	|	ВЫБОР КОГДА Себестоимость.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|	  И Себестоимость.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов)
	|	  И &ПартионныйУчетВерсии22
	|	  И Себестоимость.ПериодПродажи > &ДатаПереходаНаПартионныйУчетВерсии22
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ											  КАК ПоЦенеПродажи22
	|ПОМЕСТИТЬ ВтВозвратыПрошлыхПериодов
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Себестоимость
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|	ПО Себестоимость.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПрочееОприходованиеТоваров КАК СторноСписанияНаРасходы
	|		ПО СторноСписанияНаРасходы.Ссылка = Себестоимость.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ СторноОтчетыКомиссионера КАК СторноОтчетыКомиссионера
	|		ПО СторноОтчетыКомиссионера.АналитикаУчетаНоменклатуры = Себестоимость.АналитикаУчетаНоменклатуры
	|		И СторноОтчетыКомиссионера.РазделУчета = Себестоимость.РазделУчета
	|		И СторноОтчетыКомиссионера.ВидЗапасов = Себестоимость.ВидЗапасов
	|		И СторноОтчетыКомиссионера.Организация = Себестоимость.Организация
	|		И Себестоимость.Количество < 0
	|		И Себестоимость.ДокументИсточник = НЕОПРЕДЕЛЕНО
	|	ЛЕВОЕ СОЕДИНЕНИЕ РеквизитыВыручки КАК РеквизитыВыручки
	|		ПО РеквизитыВыручки.Регистратор = Себестоимость.Регистратор
	|		И РеквизитыВыручки.АналитикаУчетаНоменклатуры = Себестоимость.КорАналитикаУчетаНоменклатуры
	|		И (РеквизитыВыручки.ВидЗапасов = Себестоимость.ВидЗапасов
	|			ИЛИ РеквизитыВыручки.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
	|		И РеквизитыВыручки.ЗаказКлиента = Себестоимость.ЗаказКлиента
	|	ЛЕВОЕ СОЕДИНЕНИЕ РеквизитыДвиженияНоменклатураДоходыРасходы КАК РеквизитыДвиженияНоменклатураДоходыРасходы
	|		ПО РеквизитыДвиженияНоменклатураДоходыРасходы.Регистратор = Себестоимость.Регистратор
	|		И РеквизитыДвиженияНоменклатураДоходыРасходы.АналитикаУчетаНоменклатуры = Себестоимость.АналитикаУчетаНоменклатуры
	|		И РеквизитыДвиженияНоменклатураДоходыРасходы.ВидЗапасов = Себестоимость.ВидЗапасов
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтДатыДокументовИсточников КАК Реестр
	|		ПО Реестр.Ссылка = Себестоимость.ДокументИсточник
	|	ЛЕВОЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = Себестоимость.Период
	|		И РассчитанныеДокументы.Регистратор = Себестоимость.Регистратор
	|ГДЕ
	|	((Себестоимость.СлужебноеВидДвиженияПриход
	|		И Себестоимость.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов))
	|		ИЛИ (Себестоимость.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|			И НЕ СторноОтчетыКомиссионера.Период ЕСТЬ NULL)
	|		ИЛИ (НЕ Себестоимость.СлужебноеВидДвиженияПриход
	|			И Себестоимость.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|			И Себестоимость.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратБезДокументаИсточника)
	|			И Себестоимость.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|			И Реестр.ДатаДокументаИБ < &НачалоПериода)
	|		ИЛИ (НЕ Себестоимость.СлужебноеВидДвиженияПриход
	|			И Себестоимость.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|			И Себестоимость.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратБезДокументаИсточника)
	|			И Себестоимость.ДокументИсточник = НЕОПРЕДЕЛЕНО
	// ПериодРеализации должен быть заполнен, чтобы сформировались суммовые движения по возврату
	|			И ЕСТЬNULL(СторноОтчетыКомиссионера.Период,
	|				НАЧАЛОПЕРИОДА(Себестоимость.ПериодПродажи, МЕСЯЦ)) <> ДАТАВРЕМЯ(1,1,1,0,0,0)
	|			И Себестоимость.ПериодПродажи < &НачалоПериода)
	|	)
	|	И НЕ Себестоимость.РасчетСебестоимости
	// Для записей "Сторно" стоимость определяется в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() 
	|	И НЕ Себестоимость.Сторно
	// При предварительном расчете исключаем документы, для которых сохранены ранее рассчитанные движения
	|	И РассчитанныеДокументы.Регистратор ЕСТЬ NULL
	|	
	|СГРУППИРОВАТЬ ПО
	|	Себестоимость.Период,
	|	ВЫБОР КОГДА Себестоимость.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ,
	|	Себестоимость.РазделУчета,
	|	Себестоимость.ВидЗапасов,
	|	Себестоимость.ВидЗапасов.ТипЗапасов,
	|	Себестоимость.Подразделение,
	|	Себестоимость.АналитикаУчетаНоменклатуры,
	|	Себестоимость.Партия,
	|	Себестоимость.АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС,
	|	(ВЫБОР
	|		КОГДА Себестоимость.КорВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|			ТОГДА Себестоимость.ВидДеятельностиНДС
	|		ИНАЧЕ Себестоимость.КорВидДеятельностиНДС
	|	КОНЕЦ),
	|	ВЫБОР КОГДА Себестоимость.КорАналитикаУчетаНоменклатуры <> Значение(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		ТОГДА Себестоимость.КорАналитикаУчетаНоменклатуры
	|	ИНАЧЕ Себестоимость.АналитикаУчетаНоменклатуры КОНЕЦ,
	|	ВЫБОР КОГДА Себестоимость.КорВидЗапасов <> Значение(Справочник.ВидыЗапасов.ПустаяСсылка) ТОГДА
	|			Себестоимость.КорВидЗапасов
	|		ИНАЧЕ
	|			Себестоимость.ВидЗапасов
	|	КОНЕЦ,
	|	Себестоимость.КорАналитикаУчетаНоменклатуры,
	|	Себестоимость.ЗаказКлиента,
	|	Себестоимость.АналитикаУчетаПоПартнерам,
	|	Себестоимость.ХозяйственнаяОперация,
	|	Себестоимость.КорРазделУчета,
	|	Себестоимость.КорВидЗапасов,
	|	Себестоимость.КорВидЗапасов.ТипЗапасов,
	|	Себестоимость.ПериодПродажи,
	|	ЕСТЬNULL(СторноОтчетыКомиссионера.Период,
	|		НАЧАЛОПЕРИОДА(Себестоимость.ПериодПродажи, МЕСЯЦ)),
	|	Себестоимость.Организация,
	|	Себестоимость.КорОрганизация,
	|	Себестоимость.АналитикаРасходов,
	|	Себестоимость.СтатьяРасходовСписания,
	|	Себестоимость.СтатьяДоходов,
	|	Себестоимость.АналитикаДоходов,
	|	Себестоимость.ГруппаПродукции,
	|	Себестоимость.Регистратор,
	|	Себестоимость.ИдентификаторСтроки,
	|	Себестоимость.КодСтроки,
	|	Себестоимость.КорПартия,
	|	Себестоимость.КорАналитикаУчетаПартий,
	|	Себестоимость.КорАналитикаФинансовогоУчета,
	|	Себестоимость.НДСРегл,
	|	Себестоимость.НДСУпр,
	|	Себестоимость.СтатьяКалькуляции,
	|	Себестоимость.ТипЗаписи,
	|	Себестоимость.ДокументИсточник,
	|	Себестоимость.КорНаправлениеДеятельности,
	|	Себестоимость.НастройкаХозяйственнойОперации,
	|	Себестоимость.ИдентификаторФинЗаписи,
	|	ЕСТЬNULL(РеквизитыВыручки.Соглашение, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(РеквизитыВыручки.Менеджер, НЕОПРЕДЕЛЕНО),
	|	(ВЫБОР
	|		КОГДА НЕ СторноСписанияНаРасходы.Склад ЕСТЬ NULL
	|			ТОГДА РеквизитыДвиженияНоменклатураДоходыРасходы.Склад
	|		ИНАЧЕ ЕСТЬNULL(РеквизитыВыручки.Склад, НЕОПРЕДЕЛЕНО) КОНЕЦ), // Склад
	|	ЕСТЬNULL(РеквизитыВыручки.АналитикаУчетаНаборов, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(РеквизитыВыручки.НаправлениеДеятельностиКонтрагента, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(РеквизитыВыручки.НаправлениеДеятельностиНоменклатуры, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(РеквизитыВыручки.НалогообложениеНДС, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(РеквизитыВыручки.Договор, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(РеквизитыВыручки.ВалютаВзаиморасчетов, НЕОПРЕДЕЛЕНО),
	|	ЕСТЬNULL(РеквизитыВыручки.ВалютаДокумента, НЕОПРЕДЕЛЕНО),
	|	(ВЫБОР
	|		КОГДА НЕ СторноСписанияНаРасходы.Склад ЕСТЬ NULL
	|			ТОГДА РеквизитыДвиженияНоменклатураДоходыРасходы.ИсточникГФУНоменклатуры
	|		ИНАЧЕ ЕСТЬNULL(РеквизитыВыручки.ИсточникГФУНоменклатуры, НЕОПРЕДЕЛЕНО) КОНЕЦ), // ИсточникГФУНоменклатуры
	|	ЕСТЬNULL(РеквизитыВыручки.ИсточникГФУРасчетов, НЕОПРЕДЕЛЕНО),
	|	ВЫБОР КОГДА Себестоимость.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|	  И Себестоимость.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов)
	|	  И (НЕ &ПартионныйУчетВерсии22 ИЛИ Себестоимость.ПериодПродажи < &ДатаПереходаНаПартионныйУчетВерсии22)
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ВЫБОР КОГДА Себестоимость.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|	  И Себестоимость.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов)
	|	  И &ПартионныйУчетВерсии22
	|	  И Себестоимость.ПериодПродажи > &ДатаПереходаНаПартионныйУчетВерсии22
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ
	|;";
	#КонецОбласти
	
#Область ВтДанныеТаблицаКорректировки
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	ТаблицаВозвратов.Период                        КАК Период,
	|	ТаблицаВозвратов.Регистратор                   КАК Регистратор,
	|	ТаблицаВозвратов.Регистратор                   КАК ДокументДвижения,
	|	ТаблицаВозвратов.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаВозвратов.Организация                   КАК Организация,
	|	ТаблицаВозвратов.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаВозвратов.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаВозвратов.РазделУчета                   КАК РазделУчета,
	|	ТаблицаВозвратов.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаВозвратов.Партия                        КАК Партия,
	|	ТаблицаВозвратов.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаВозвратов.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаВозвратов.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	(ВЫБОР
	|		КОГДА Аналитика.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|		 И НЕ Аналитика.Номенклатура.ПрослеживаемыйТовар
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
	|		ИНАЧЕ ЕСТЬNULL(ТаблицаВозвратов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) КОНЕЦ) КАК ТипЗапасов,
	|	ТаблицаВозвратов.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|	ТаблицаВозвратов.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	ТаблицаВозвратов.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаВозвратов.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ТаблицаВозвратов.ТипЗапасов                    КАК КорТипЗапасов,
	|	ТаблицаВозвратов.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаВозвратов.ЗаказКлиента                  КАК ЗаказКлиента,
	|	ТаблицаВозвратов.Подразделение                 КАК Подразделение,
	|	ТаблицаВозвратов.ПериодРеализации              КАК ПериодРеализации,
	|	ТаблицаВозвратов.АналитикаДоходов              КАК АналитикаДоходов,
	|	ТаблицаВозвратов.СтатьяДоходов                 КАК СтатьяДоходов,
	|	ТаблицаВозвратов.АналитикаРасходов             КАК АналитикаРасходов,
	|	ТаблицаВозвратов.СтатьяРасходовСписания        КАК СтатьяРасходовСписания,
	|	ТаблицаВозвратов.ГруппаПродукции               КАК ГруппаПродукции,
	|	ЕСТЬNULL(Назначения.НаправлениеДеятельности, ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	ТаблицаВозвратов.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	//++ Локализация

	//++ НЕ УТ
	|	ЛОЖЬ                                           КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ

	//-- Локализация
	|	ЕСТЬNULL(СтатьиРасходов.ВариантРаспределенияРасходовУпр, НЕОПРЕДЕЛЕНО) КАК ВариантРаспределенияРасходовУпр,
	|	ЕСТЬNULL(СтатьиРасходов.ВариантРаспределенияРасходовРегл, НЕОПРЕДЕЛЕНО) КАК ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ЛОЖЬ) КАК ПринятиеКНалоговомуУчету,
	|	НЕОПРЕДЕЛЕНО                                   КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                   КАК СтатьяАктивовПассивов,
	|	ТаблицаВозвратов.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаВозвратов.КодСтроки                 	   КАК КодСтроки,
	|	ТаблицаВозвратов.Менеджер                      КАК Менеджер,
	|	ТаблицаВозвратов.Склад                         КАК Склад,
	|	ТаблицаВозвратов.Соглашение                    КАК Соглашение,
	|	ТаблицаВозвратов.Договор                       КАК Договор,
	|	ТаблицаВозвратов.АналитикаУчетаНаборов         КАК АналитикаУчетаНаборов,
	|	ТаблицаВозвратов.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	ТаблицаВозвратов.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	ТаблицаВозвратов.НалогообложениеНДС            КАК НалогообложениеНДС,
	|	ТаблицаВозвратов.ВалютаВзаиморасчетов          КАК ВалютаВзаиморасчетов,
	|	ТаблицаВозвратов.ВалютаДокумента               КАК ВалютаДокумента,
	|	ТаблицаВозвратов.ИсточникГФУНоменклатуры       КАК ИсточникГФУНоменклатуры,
	|	ТаблицаВозвратов.ИсточникГФУРасчетов           КАК ИсточникГФУРасчетов,
	|	ТаблицаВозвратов.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаВозвратов.КорПартия                     КАК КорПартия,
	|	ТаблицаВозвратов.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаВозвратов.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаВозвратов.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаВозвратов.НДСРегл                       КАК НДСРегл,
	|	ТаблицаВозвратов.НДСУпр                        КАК НДСУпр,
	|	ТаблицаВозвратов.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	ТаблицаВозвратов.ТипЗаписи                     КАК ТипЗаписи,
	|	ТаблицаВозвратов.ДокументИсточник              КАК ДокументИсточник,
	|	ТаблицаВозвратов.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ТаблицаВозвратов.ИдентификаторФинЗаписи        КАК ИдентификаторФинЗаписи,
	|	ЛОЖЬ                                           КАК Сторно,
	|	0                                              КАК КорСтоимость,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.Стоимость / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.Стоимость / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.Стоимость
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.Стоимость КАК ЧИСЛО(31,2)) 							КАК Стоимость,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.СтоимостьБезНДС / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.СтоимостьБезНДС / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.СтоимостьБезНДС
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.СтоимостьБезНДС КАК ЧИСЛО(31,2)) 					КАК СтоимостьБезНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.СтоимостьЗабалансовая / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.СтоимостьЗабалансовая / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.СтоимостьЗабалансовая
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.СтоимостьЗабалансовая КАК ЧИСЛО(31,2)) 				КАК СтоимостьЗабалансовая,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ДопРасходы / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА (СтоимостиПродаж22.ДопРасходы + ЕСТЬNULL(СуммыДопРасходов.ДопРасходы, 0)) / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.СтоимостьДопРасходы
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ДопРасходы КАК ЧИСЛО(31,2)) 						КАК ДопРасходы,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ДопРасходыБезНДС / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА (СтоимостиПродаж22.ДопРасходыБезНДС + ЕСТЬNULL(СуммыДопРасходов.ДопРасходыБезНДС, 0)) / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.СтоимостьДопРасходыБезНДС
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ДопРасходыБезНДС КАК ЧИСЛО(31,2)) 					КАК ДопРасходыБезНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.Трудозатраты / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.Трудозатраты / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.Трудозатраты
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.Трудозатраты КАК ЧИСЛО(31,2)) 						КАК Трудозатраты,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостатейныеПостоянныеСНДС / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостатейныеПостоянныеСНДС / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостатейныеПостоянныеСНДС
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостатейныеПостоянныеСНДС КАК ЧИСЛО(31,2)) 			КАК ПостатейныеПостоянныеСНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостатейныеПостоянныеБезНДС / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостатейныеПостоянныеБезНДС / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостатейныеПостоянныеБезНДС
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостатейныеПостоянныеБезНДС КАК ЧИСЛО(31,2)) 		КАК ПостатейныеПостоянныеБезНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостатейныеПеременныеСНДС / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостатейныеПеременныеСНДС / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостатейныеПеременныеСНДС
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостатейныеПеременныеСНДС КАК ЧИСЛО(31,2)) 			КАК ПостатейныеПеременныеСНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостатейныеПеременныеБезНДС / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостатейныеПеременныеБезНДС / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостатейныеПеременныеБезНДС
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостатейныеПеременныеБезНДС КАК ЧИСЛО(31,2)) 		КАК ПостатейныеПеременныеБезНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.СтоимостьРегл / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.СтоимостьРегл / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.СтоимостьРегл
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.СтоимостьРегл КАК ЧИСЛО(31,2)) 						КАК СтоимостьРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.СтоимостьЗабалансоваяРегл / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.СтоимостьЗабалансоваяРегл / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.СтоимостьЗабалансоваяРегл
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.СтоимостьЗабалансоваяРегл КАК ЧИСЛО(31,2)) 			КАК СтоимостьЗабалансоваяРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостояннаяРазница / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостояннаяРазница / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостояннаяРазница
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостояннаяРазница КАК ЧИСЛО(31,2)) 					КАК ПостояннаяРазница,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ВременнаяРазница / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ВременнаяРазница / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ВременнаяРазница
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ВременнаяРазница КАК ЧИСЛО(31,2)) 					КАК ВременнаяРазница,
	|	ВЫРАЗИТЬ(ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.СтоимостьНДД / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.СтоимостьНДД / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.СтоимостьНДД
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.СтоимостьНДД КАК ЧИСЛО(31,2)) 						КАК СтоимостьНДД,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ДопРасходыРегл / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА (СтоимостиПродаж22.ДопРасходыРегл + ЕСТЬNULL(СуммыДопРасходов.ДопРасходыРегл, 0)) / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ДопРасходыРегл
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ДопРасходыРегл КАК ЧИСЛО(31,2)) 					КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ТрудозатратыРегл / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ТрудозатратыРегл / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ТрудозатратыРегл
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ТрудозатратыРегл КАК ЧИСЛО(31,2)) 					КАК ТрудозатратыРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостатейныеПостоянныеРегл / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостатейныеПостоянныеРегл / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостатейныеПостоянныеРегл
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостатейныеПостоянныеРегл КАК ЧИСЛО(31,2)) 			КАК ПостатейныеПостоянныеРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостатейныеПеременныеРегл / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостатейныеПеременныеРегл / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостатейныеПеременныеРегл
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостатейныеПеременныеРегл КАК ЧИСЛО(31,2)) 			КАК ПостатейныеПеременныеРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.СтоимостьУпр / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.СтоимостьУпр / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.СтоимостьУпр
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.СтоимостьУпр КАК ЧИСЛО(31,2)) 						КАК СтоимостьУпр,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ДопРасходыУпр / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА (СтоимостиПродаж22.ДопРасходыУпр + ЕСТЬNULL(СуммыДопРасходов.ДопРасходыУпр, 0)) / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ДопРасходыУпр
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ДопРасходыУпр КАК ЧИСЛО(31,2)) 						КАК ДопРасходыУпр,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ТрудозатратыУпр / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ТрудозатратыУпр / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ТрудозатратыУпр
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ТрудозатратыУпр КАК ЧИСЛО(31,2)) 					КАК ТрудозатратыУпр,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостатейныеПостоянныеУпр / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостатейныеПостоянныеУпр / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостатейныеПостоянныеУпр
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостатейныеПостоянныеУпр КАК ЧИСЛО(31,2)) 			КАК ПостатейныеПостоянныеУпр,
	|	ВЫРАЗИТЬ(
	|		ВЫБОР КОГДА ТаблицаВозвратов.ПоЦенеПродажи И НЕ СтоимостиПродаж.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж.ПостатейныеПеременныеУпр / СтоимостиПродаж.Количество
	|		КОГДА ТаблицаВозвратов.ПоЦенеПродажи22 И НЕ СтоимостиПродаж22.Ссылка ЕСТЬ NULL
	|			ТОГДА СтоимостиПродаж22.ПостатейныеПеременныеУпр / СтоимостиПродаж22.Количество
	|			ИНАЧЕ СтоимостьТоваров.ПостатейныеПеременныеУпр
	|		КОНЕЦ * ТаблицаВозвратов.Количество
	|		- ТаблицаВозвратов.ПостатейныеПеременныеУпр КАК ЧИСЛО(31,2)) 			КАК ПостатейныеПеременныеУпр,
	|	0 КАК РезервПодОбесценениеРегл,
	|	0 КАК РезервПодОбесценениеУпр
	|
	|ПОМЕСТИТЬ ВтДанныеТаблицаКорректировки
	|ИЗ
	|	ВтВозвратыПрошлыхПериодов КАК ТаблицаВозвратов
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтСуммыРеализацийПрошлыхПериодов КАК СтоимостиПродаж
	|		ПО ТаблицаВозвратов.ПоЦенеПродажи
	|			И ТаблицаВозвратов.ДокументИсточник          	= СтоимостиПродаж.Ссылка
	|			И ТаблицаВозвратов.АналитикаНоменклатурыДляЦены = СтоимостиПродаж.АналитикаУчетаНоменклатуры
	|			И (ТаблицаВозвратов.ВидыЗапасовДляЦены        	= СтоимостиПродаж.ВидЗапасов
	|				ИЛИ СтоимостиПродаж.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
	|			И ТаблицаВозвратов.Организация               	= СтоимостиПродаж.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтСуммыРеализацийПрошлыхПериодов КАК СтоимостиПродаж22
	|		ПО ТаблицаВозвратов.ПоЦенеПродажи22
	|			И ТаблицаВозвратов.ДокументИсточник          	= СтоимостиПродаж22.Ссылка
	|			И ТаблицаВозвратов.АналитикаНоменклатурыДляЦены = СтоимостиПродаж22.АналитикаУчетаНоменклатуры
	|			И (ТаблицаВозвратов.ВидыЗапасовДляЦены        	= СтоимостиПродаж22.ВидЗапасов
	|				ИЛИ СтоимостиПродаж22.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
	|			И ТаблицаВозвратов.Организация               	= СтоимостиПродаж22.Организация
	|			И ТаблицаВозвратов.Партия               		= СтоимостиПродаж22.Партия
	|			И ТаблицаВозвратов.АналитикаУчетаПартий         = СтоимостиПродаж22.АналитикаУчетаПартий
	|			И ТаблицаВозвратов.АналитикаФинансовогоУчета    = СтоимостиПродаж22.АналитикаФинансовогоУчета
	|			И ТаблицаВозвратов.КорВидДеятельностиНДС        = СтоимостиПродаж22.ВидДеятельностиНДС
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтСуммыДопРасходовПрошлыхПериодов КАК СуммыДопРасходов
	|		ПО ТаблицаВозвратов.ДокументИсточник          		= СуммыДопРасходов.Ссылка
	|			И ТаблицаВозвратов.АналитикаНоменклатурыДляЦены = СуммыДопРасходов.АналитикаУчетаНоменклатуры
	|			И (ТаблицаВозвратов.ВидыЗапасовДляЦены        	= СуммыДопРасходов.ВидЗапасов
	|				ИЛИ СуммыДопРасходов.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
	|			И ТаблицаВозвратов.Организация               	= СуммыДопРасходов.Организация
	|			И ТаблицаВозвратов.Партия               		= СуммыДопРасходов.Партия
	|			И ТаблицаВозвратов.АналитикаУчетаПартий         = СуммыДопРасходов.АналитикаУчетаПартий
	|			И ТаблицаВозвратов.АналитикаФинансовогоУчета    = СуммыДопРасходов.АналитикаФинансовогоУчета
	|			И ТаблицаВозвратов.КорВидДеятельностиНДС        = СуммыДопРасходов.ВидДеятельностиНДС
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтоимостьТоваров КАК СтоимостьТоваров
	|		ПО ТаблицаВозвратов.ПериодРеализации          		= СтоимостьТоваров.Период
	|			И ТаблицаВозвратов.АналитикаНоменклатурыДляЦены = СтоимостьТоваров.АналитикаУчетаНоменклатуры
	|			И (ТаблицаВозвратов.ВидыЗапасовДляЦены        	= СтоимостьТоваров.ВидЗапасов
	|				ИЛИ СтоимостьТоваров.ВидЗапасов = ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка))
	|			И ТаблицаВозвратов.Организация               	= СтоимостьТоваров.Организация
	|			И ТаблицаВозвратов.РазделУчета               	= СтоимостьТоваров.РазделУчета
	|			И ТаблицаВозвратов.Партия = НЕОПРЕДЕЛЕНО
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО ТаблицаВозвратов.СтатьяРасходовСписания = СтатьиРасходов.Ссылка
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО ТаблицаВозвратов.АналитикаУчетаНоменклатуры = Аналитика.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
	|		ПО Назначения.Ссылка = Аналитика.Назначение
	|
	|ГДЕ
	|	(ТаблицаВозвратов.ПоЦенеПродажи И СтоимостиПродаж.Ссылка ЕСТЬ НЕ NULL)
	|		ИЛИ (ТаблицаВозвратов.ПоЦенеПродажи22 И СтоимостиПродаж22.Ссылка ЕСТЬ НЕ NULL)
	|		ИЛИ (НЕ ТаблицаВозвратов.ПоЦенеПродажи И СтоимостьТоваров.Период ЕСТЬ НЕ NULL)
	|		ИЛИ (НЕ ТаблицаВозвратов.ПоЦенеПродажи22 И СтоимостьТоваров.Период ЕСТЬ НЕ NULL)
	|;";
#КонецОбласти

#Область ДвиженияТаблицаКорректировки
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	ТаблицаВозвратов.Период                        КАК Период,
	|	ТаблицаВозвратов.Регистратор                   КАК Регистратор,
	|	ТаблицаВозвратов.Регистратор                   КАК ДокументДвижения,
	|	ТаблицаВозвратов.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаВозвратов.Организация                   КАК Организация,
	|	ТаблицаВозвратов.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаВозвратов.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаВозвратов.РазделУчета                   КАК РазделУчета,
	|	ТаблицаВозвратов.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаВозвратов.Партия                        КАК Партия,
	|	ТаблицаВозвратов.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаВозвратов.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаВозвратов.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ТаблицаВозвратов.ТипЗапасов                    КАК ТипЗапасов,
	|	ТаблицаВозвратов.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|	ТаблицаВозвратов.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	ТаблицаВозвратов.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаВозвратов.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ТаблицаВозвратов.ТипЗапасов                    КАК КорТипЗапасов,
	|	ТаблицаВозвратов.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаВозвратов.ЗаказКлиента                  КАК ЗаказКлиента,
	|	ТаблицаВозвратов.Подразделение                 КАК Подразделение,
	|	ТаблицаВозвратов.ПериодРеализации              КАК ПериодРеализации,
	|	ТаблицаВозвратов.АналитикаДоходов              КАК АналитикаДоходов,
	|	ТаблицаВозвратов.СтатьяДоходов                 КАК СтатьяДоходов,
	|	ТаблицаВозвратов.АналитикаРасходов             КАК АналитикаРасходов,
	|	ТаблицаВозвратов.СтатьяРасходовСписания        КАК СтатьяРасходовСписания,
	|	ТаблицаВозвратов.ГруппаПродукции               КАК ГруппаПродукции,
	|	ТаблицаВозвратов.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаВозвратов.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	//++ Локализация
	
	//++ НЕ УТ
	|	ЛОЖЬ                                           КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ
	
	//-- Локализация
	|	ТаблицаВозвратов.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	ТаблицаВозвратов.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ТаблицаВозвратов.ПринятиеКНалоговомуУчету      КАК ПринятиеКНалоговомуУчету,
	|	НЕОПРЕДЕЛЕНО                                   КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                   КАК СтатьяАктивовПассивов,
	|	ТаблицаВозвратов.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаВозвратов.КодСтроки                 	   КАК КодСтроки,
	|	ТаблицаВозвратов.Менеджер                      КАК Менеджер,
	|	ТаблицаВозвратов.Склад                         КАК Склад,
	|	ТаблицаВозвратов.Соглашение                    КАК Соглашение,
	|	ТаблицаВозвратов.Договор                       КАК Договор,
	|	ТаблицаВозвратов.АналитикаУчетаНаборов         КАК АналитикаУчетаНаборов,
	|	ТаблицаВозвратов.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	ТаблицаВозвратов.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	ТаблицаВозвратов.НалогообложениеНДС            КАК НалогообложениеНДС,
	|	ТаблицаВозвратов.ВалютаВзаиморасчетов          КАК ВалютаВзаиморасчетов,
	|	ТаблицаВозвратов.ВалютаДокумента               КАК ВалютаДокумента,
	|	ТаблицаВозвратов.ИсточникГФУНоменклатуры       КАК ИсточникГФУНоменклатуры,
	|	ТаблицаВозвратов.ИсточникГФУРасчетов           КАК ИсточникГФУРасчетов,
	|	ТаблицаВозвратов.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаВозвратов.КорПартия                     КАК КорПартия,
	|	ТаблицаВозвратов.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаВозвратов.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаВозвратов.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаВозвратов.НДСРегл                       КАК НДСРегл,
	|	ТаблицаВозвратов.НДСУпр                        КАК НДСУпр,
	|	ТаблицаВозвратов.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	ТаблицаВозвратов.ТипЗаписи                     КАК ТипЗаписи,
	|	ТаблицаВозвратов.ДокументИсточник              КАК ДокументИсточник,
	|	ТаблицаВозвратов.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ТаблицаВозвратов.ИдентификаторФинЗаписи        КАК ИдентификаторФинЗаписи,
	|	ЛОЖЬ                                           КАК Сторно,
	|	0                                              КАК КорСтоимость,
	|
	|	ТаблицаВозвратов.Стоимость                     КАК Стоимость,
	|	ТаблицаВозвратов.СтоимостьБезНДС               КАК СтоимостьБезНДС,
	|	ТаблицаВозвратов.СтоимостьЗабалансовая         КАК СтоимостьЗабалансовая,
	|	ТаблицаВозвратов.ДопРасходы                    КАК ДопРасходы,
	|	ТаблицаВозвратов.ДопРасходыБезНДС              КАК ДопРасходыБезНДС,
	|	ТаблицаВозвратов.Трудозатраты                  КАК Трудозатраты,
	|	ТаблицаВозвратов.ПостатейныеПостоянныеСНДС     КАК ПостатейныеПостоянныеСНДС,
	|	ТаблицаВозвратов.ПостатейныеПостоянныеБезНДС   КАК ПостатейныеПостоянныеБезНДС,
	|	ТаблицаВозвратов.ПостатейныеПеременныеСНДС     КАК ПостатейныеПеременныеСНДС,
	|	ТаблицаВозвратов.ПостатейныеПеременныеБезНДС   КАК ПостатейныеПеременныеБезНДС,
	|	ТаблицаВозвратов.СтоимостьРегл                 КАК СтоимостьРегл,
	|	ТаблицаВозвратов.СтоимостьЗабалансоваяРегл     КАК СтоимостьЗабалансоваяРегл,
	|	ТаблицаВозвратов.ПостояннаяРазница             КАК ПостояннаяРазница,
	|	ТаблицаВозвратов.ВременнаяРазница              КАК ВременнаяРазница,
	|	ТаблицаВозвратов.СтоимостьНДД                  КАК СтоимостьНДД,
	|	ТаблицаВозвратов.ДопРасходыРегл                КАК ДопРасходыРегл,
	|	ТаблицаВозвратов.ТрудозатратыРегл              КАК ТрудозатратыРегл,
	|	ТаблицаВозвратов.ПостатейныеПостоянныеРегл     КАК ПостатейныеПостоянныеРегл,
	|	ТаблицаВозвратов.ПостатейныеПеременныеРегл     КАК ПостатейныеПеременныеРегл,
	|	ТаблицаВозвратов.СтоимостьУпр                  КАК СтоимостьУпр,
	|	ТаблицаВозвратов.ДопРасходыУпр                 КАК ДопРасходыУпр,
	|	ТаблицаВозвратов.ТрудозатратыУпр               КАК ТрудозатратыУпр,
	|	ТаблицаВозвратов.ПостатейныеПостоянныеУпр      КАК ПостатейныеПостоянныеУпр,
	|	ТаблицаВозвратов.ПостатейныеПеременныеУпр      КАК ПостатейныеПеременныеУпр,
	|	0 КАК РезервПодОбесценениеРегл,
	|	0 КАК РезервПодОбесценениеУпр
	|
	|ПОМЕСТИТЬ ДвиженияТаблицаКорректировки
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаВозвратов
	|ГДЕ
	|	ТаблицаВозвратов.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов)
	|";
#КонецОбласти

#Область ДвиженияТаблицаКорректировки_ПрочиеДоходы

	// Отклонение в стоимости - отнесение на прочие доходы
	Запрос.Текст = Запрос.Текст + "
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаВозвратов.Период                        КАК Период,
	|	ТаблицаВозвратов.Регистратор                   КАК Регистратор,
	|	ТаблицаВозвратов.Регистратор                   КАК ДокументДвижения,
	|	ТаблицаВозвратов.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаВозвратов.Организация                   КАК Организация,
	|	ТаблицаВозвратов.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаВозвратов.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаВозвратов.РазделУчета                   КАК РазделУчета,
	|	ТаблицаВозвратов.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаВозвратов.Партия                        КАК Партия,
	|	ТаблицаВозвратов.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаВозвратов.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаВозвратов.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ТаблицаВозвратов.ТипЗапасов                    КАК ТипЗапасов,
	|	ТаблицаВозвратов.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|	ТаблицаВозвратов.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	ТаблицаВозвратов.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаВозвратов.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ТаблицаВозвратов.ТипЗапасов                    КАК КорТипЗапасов,
	|	ТаблицаВозвратов.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаВозвратов.ЗаказКлиента                  КАК ЗаказКлиента,
	|	ТаблицаВозвратов.Подразделение                 КАК Подразделение,
	|	ТаблицаВозвратов.ПериодРеализации              КАК ПериодРеализации,
	|	ТаблицаВозвратов.АналитикаДоходов              КАК АналитикаДоходов,
	|	ТаблицаВозвратов.СтатьяДоходов                 КАК СтатьяДоходов,
	|	НЕОПРЕДЕЛЕНО                                   КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                   КАК СтатьяРасходовСписания,
	|	ТаблицаВозвратов.ГруппаПродукции               КАК ГруппаПродукции,
	|	ТаблицаВозвратов.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаВозвратов.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	//++ Локализация
	
	//++ НЕ УТ
	|	ЛОЖЬ                                           КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ
	
	//-- Локализация
	|	НЕОПРЕДЕЛЕНО                                   КАК ВариантРаспределенияРасходовУпр,
	|	НЕОПРЕДЕЛЕНО                                   КАК ВариантРаспределенияРасходовРегл,
	|	ЛОЖЬ                                           КАК ПринятиеКНалоговомуУчету,
	|	НЕОПРЕДЕЛЕНО                                   КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                   КАК СтатьяАктивовПассивов,
	|	ТаблицаВозвратов.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаВозвратов.КодСтроки                 	   КАК КодСтроки,
	|	ТаблицаВозвратов.Менеджер                      КАК Менеджер,
	|	ТаблицаВозвратов.Склад                         КАК Склад,
	|	ТаблицаВозвратов.Соглашение                    КАК Соглашение,
	|	ТаблицаВозвратов.Договор                       КАК Договор,
	|	ТаблицаВозвратов.АналитикаУчетаНаборов         КАК АналитикаУчетаНаборов,
	|	ТаблицаВозвратов.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	ТаблицаВозвратов.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	ТаблицаВозвратов.НалогообложениеНДС            КАК НалогообложениеНДС,
	|	ТаблицаВозвратов.ВалютаВзаиморасчетов          КАК ВалютаВзаиморасчетов,
	|	ТаблицаВозвратов.ВалютаДокумента               КАК ВалютаДокумента,
	|	ТаблицаВозвратов.ИсточникГФУНоменклатуры       КАК ИсточникГФУНоменклатуры,
	|	ТаблицаВозвратов.ИсточникГФУРасчетов           КАК ИсточникГФУРасчетов,
	|	ТаблицаВозвратов.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаВозвратов.КорПартия                     КАК КорПартия,
	|	ТаблицаВозвратов.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаВозвратов.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаВозвратов.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаВозвратов.НДСРегл                       КАК НДСРегл,
	|	ТаблицаВозвратов.НДСУпр                        КАК НДСУпр,
	|	ТаблицаВозвратов.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	ТаблицаВозвратов.ТипЗаписи                     КАК ТипЗаписи,
	|	ТаблицаВозвратов.ДокументИсточник              КАК ДокументИсточник,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровДоходы) КАК НастройкаХозяйственнойОперации,
	// Отклонения в стоимости отражаем по идентификатору строки документа.
	|	(ВЫБОР
	|		КОГДА ТаблицаВозвратов.ИдентификаторСтроки <> """"
	|			ТОГДА ТаблицаВозвратов.ИдентификаторСтроки
	|		ИНАЧЕ ТаблицаВозвратов.ИдентификаторФинЗаписи КОНЕЦ) КАК ИдентификаторФинЗаписи,
	|	ЛОЖЬ                                           КАК Сторно,
	|	0                                              КАК КорСтоимость,
	|
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС >= 0
	|			ТОГДА Стоимость
	|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
	|	(ВЫБОР 
	|		КОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС >= 0
	|			ТОГДА СтоимостьБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
	|	(ВЫБОР 
	|		КОГДА СтоимостьЗабалансовая >= 0
	|			ТОГДА СтоимостьЗабалансовая
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансовая,
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС >= 0
	|			ТОГДА ДопРасходы
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходы,
	|	(ВЫБОР 
	|		КОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС >= 0
	|			ТОГДА ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС >= 0
	|			ТОГДА Трудозатраты
	|		ИНАЧЕ 0 КОНЕЦ) КАК Трудозатраты,
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС >= 0
	|			ТОГДА ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
	|	(ВЫБОР 
	|		КОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС >= 0
	|			ТОГДА ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС >= 0
	|			ТОГДА ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
	|	(ВЫБОР 
	|		КОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС >= 0
	|			ТОГДА ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
	|
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл >= 0
	|			ТОГДА СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьЗабалансоваяРегл >= 0
	|			ТОГДА СтоимостьЗабалансоваяРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл >= 0
	|			ТОГДА ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл >= 0
	|			ТОГДА ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	0 КАК СтоимостьНДД,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл >= 0
	|			ТОГДА ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл >= 0
	|			ТОГДА ТрудозатратыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл >= 0
	|			ТОГДА ПостатейныеПостоянныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл >= 0
	|			ТОГДА ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр >= 0
	|			ТОГДА СтоимостьУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьУпр,
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр >= 0
	|			ТОГДА ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр >= 0
	|			ТОГДА ТрудозатратыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыУпр,
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр >= 0
	|			ТОГДА ПостатейныеПостоянныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр >= 0
	|			ТОГДА ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	|
	|	0 КАК РезервПодОбесценениеРегл,
	|	0 КАК РезервПодОбесценениеУпр
	|
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаВозвратов
	|ГДЕ
	|	ТаблицаВозвратов.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов)
	// На прочие доходы будут отнесены отрицательные суммы отклонения в стоимости
	|	И (ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС >= 0
	|			ИЛИ СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС >= 0
	|			ИЛИ СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл >= 0
	|			ИЛИ СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр >= 0
	|			ИЛИ СтоимостьЗабалансовая >= 0
	|			ИЛИ СтоимостьЗабалансоваяРегл >= 0
	|				ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ)
	|";
#КонецОбласти

#Область ДвиженияТаблицаКорректировки_ПрочиеРасходы

	// Отклонение в стоимости - отнесение на прочие расходы
	Запрос.Текст = Запрос.Текст + "
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаВозвратов.Период                        КАК Период,
	|	ТаблицаВозвратов.Регистратор                   КАК Регистратор,
	|	ТаблицаВозвратов.Регистратор                   КАК ДокументДвижения,
	|	ТаблицаВозвратов.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаВозвратов.Организация                   КАК Организация,
	|	ТаблицаВозвратов.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаВозвратов.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаВозвратов.РазделУчета                   КАК РазделУчета,
	|	ТаблицаВозвратов.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаВозвратов.Партия                        КАК Партия,
	|	ТаблицаВозвратов.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаВозвратов.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаВозвратов.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ТаблицаВозвратов.ТипЗапасов                    КАК ТипЗапасов,
	|	ТаблицаВозвратов.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|	ТаблицаВозвратов.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	ТаблицаВозвратов.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаВозвратов.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ТаблицаВозвратов.ТипЗапасов                    КАК КорТипЗапасов,
	|	ТаблицаВозвратов.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаВозвратов.ЗаказКлиента                  КАК ЗаказКлиента,
	|	ТаблицаВозвратов.Подразделение                 КАК Подразделение,
	|	ТаблицаВозвратов.ПериодРеализации              КАК ПериодРеализации,
	|	НЕОПРЕДЕЛЕНО                                   КАК АналитикаДоходов,
	|	НЕОПРЕДЕЛЕНО                                   КАК СтатьяДоходов,
	|	ТаблицаВозвратов.АналитикаРасходов             КАК АналитикаРасходов,
	|	ТаблицаВозвратов.СтатьяРасходовСписания        КАК СтатьяРасходовСписания,
	|	ТаблицаВозвратов.ГруппаПродукции               КАК ГруппаПродукции,
	|	ТаблицаВозвратов.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаВозвратов.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	//++ Локализация
	
	//++ НЕ УТ
	|	ЛОЖЬ                                           КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ
	
	//-- Локализация
	|	ТаблицаВозвратов.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	ТаблицаВозвратов.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ТаблицаВозвратов.ПринятиеКНалоговомуУчету      КАК ПринятиеКНалоговомуУчету,
	|	НЕОПРЕДЕЛЕНО                                   КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                   КАК СтатьяАктивовПассивов,
	|	ТаблицаВозвратов.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаВозвратов.КодСтроки                 	   КАК КодСтроки,
	|	ТаблицаВозвратов.Менеджер                      КАК Менеджер,
	|	ТаблицаВозвратов.Склад                         КАК Склад,
	|	ТаблицаВозвратов.Соглашение                    КАК Соглашение,
	|	ТаблицаВозвратов.Договор                       КАК Договор,
	|	ТаблицаВозвратов.АналитикаУчетаНаборов         КАК АналитикаУчетаНаборов,
	|	ТаблицаВозвратов.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	ТаблицаВозвратов.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	ТаблицаВозвратов.НалогообложениеНДС            КАК НалогообложениеНДС,
	|	ТаблицаВозвратов.ВалютаВзаиморасчетов          КАК ВалютаВзаиморасчетов,
	|	ТаблицаВозвратов.ВалютаДокумента               КАК ВалютаДокумента,
	|	ТаблицаВозвратов.ИсточникГФУНоменклатуры       КАК ИсточникГФУНоменклатуры,
	|	ТаблицаВозвратов.ИсточникГФУРасчетов           КАК ИсточникГФУРасчетов,
	|	ТаблицаВозвратов.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаВозвратов.КорПартия                     КАК КорПартия,
	|	ТаблицаВозвратов.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаВозвратов.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаВозвратов.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаВозвратов.НДСРегл                       КАК НДСРегл,
	|	ТаблицаВозвратов.НДСУпр                        КАК НДСУпр,
	|	ТаблицаВозвратов.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	ТаблицаВозвратов.ТипЗаписи                     КАК ТипЗаписи,
	|	ТаблицаВозвратов.ДокументИсточник              КАК ДокументИсточник,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровРасходы) КАК НастройкаХозяйственнойОперации,
	// Отклонения в стоимости отражаем по идентификатору строки документа.
	|	(ВЫБОР
	|		КОГДА ТаблицаВозвратов.ИдентификаторСтроки <> """"
	|			ТОГДА ТаблицаВозвратов.ИдентификаторСтроки
	|		ИНАЧЕ ТаблицаВозвратов.ИдентификаторФинЗаписи КОНЕЦ) КАК ИдентификаторФинЗаписи,
	|	ЛОЖЬ                                           КАК Сторно,
	|	0                                              КАК КорСтоимость,
	|
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС < 0
	|			ТОГДА Стоимость
	|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
	|	(ВЫБОР 
	|		КОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА СтоимостьБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
	|	(ВЫБОР 
	|		КОГДА СтоимостьЗабалансовая < 0
	|			ТОГДА СтоимостьЗабалансовая
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансовая,
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС < 0
	|			ТОГДА ДопРасходы
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходы,
	|	(ВЫБОР 
	|		КОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС < 0
	|			ТОГДА Трудозатраты
	|		ИНАЧЕ 0 КОНЕЦ) КАК Трудозатраты,
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС < 0
	|			ТОГДА ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
	|	(ВЫБОР 
	|		КОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
	|	(ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС < 0
	|			ТОГДА ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
	|	(ВЫБОР 
	|		КОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
	|
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл < 0
	|			ТОГДА СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьЗабалансоваяРегл < 0
	|			ТОГДА СтоимостьЗабалансоваяРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл < 0
	|			ТОГДА ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл < 0
	|			ТОГДА ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	(ВЫБОР 
	|		КОГДА СтоимостьНДД < 0
	|			ТОГДА СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьНДД,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл < 0
	|			ТОГДА ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл < 0
	|			ТОГДА ТрудозатратыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл < 0
	|			ТОГДА ПостатейныеПостоянныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	(ВЫБОР 
	|		КОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл < 0
	|			ТОГДА ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр < 0
	|			ТОГДА СтоимостьУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьУпр,
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр < 0
	|			ТОГДА ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр < 0
	|			ТОГДА ТрудозатратыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыУпр,
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр < 0
	|			ТОГДА ПостатейныеПостоянныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	(ВЫБОР 
	|		КОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр < 0
	|			ТОГДА ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	|	0 КАК РезервПодОбесценениеРегл,
	|	0 КАК РезервПодОбесценениеУпр
	|
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаВозвратов
	|ГДЕ
	|	ТаблицаВозвратов.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов)
	// На прочие расходы будут отнесены положительные суммы отклонения в стоимости
	|	И (ВЫБОР 
	|		КОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС < 0
	|			ИЛИ СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС < 0
	|			ИЛИ СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл < 0
	|			ИЛИ СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр < 0
	|			ИЛИ СтоимостьЗабалансовая < 0
	|			ИЛИ СтоимостьЗабалансоваяРегл < 0
	|			ИЛИ СтоимостьНДД < 0
	|				ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ)
	|";
#КонецОбласти
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	УсловиеЗапроса = "
	|	ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы)
	|	)";
	
	СтруктураКорректировкиСумм = Новый Структура();
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыСНДС", -1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыБезНДС", -1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыРегл", -1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыУпр", -1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентКорСуммы", 0);

	СформироватьДвиженияНоменклатураДоходыРасходыЗапросом(ПараметрыРасчета, "ВтДоходыРасходыСторноСписаниеТоваров", 
		СоответствиеВременныхТаблицДвижений, УсловиеЗапроса, , , СтруктураКорректировкиСумм);

#Область СебестоимостьТоваров
	
	ИмяВременнойТаблицы = "ВтДвиженияВозвратыПрошлыхПериодов";
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ДвиженияТаблицаКорректировки");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

#КонецОбласти

#Область ВыручкаИСебестоимостьПродаж

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор,
	// Измерения
	|	ВЫБОР КОГДА Т.АналитикаУчетаНоменклатуры <> Т.КорАналитикаУчетаНоменклатуры
	|		И Т.ХозяйственнаяОперация В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиента),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов)) 
	|		И НЕ Т.КорАналитикаУчетаНоменклатуры В (НЕОПРЕДЕЛЕНО, 
	|			ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)) ТОГДА
	|		Т.КорАналитикаУчетаНоменклатуры
	|	ИНАЧЕ
	|		Т.АналитикаУчетаНоменклатуры
	|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
	|	Т.ЗаказКлиента,
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.Подразделение,
	|	Т.ТипЗапасов,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.Менеджер,
	|	Т.Склад,
	|	Т.Соглашение,
	|	Т.Договор,
	|	Т.ХозяйственнаяОперация,
	|	Т.АналитикаУчетаНаборов,
	|	Т.НаправлениеДеятельностиКонтрагента,
	|	Т.НаправлениеДеятельностиНоменклатуры,
	// Ресурсы
	|	-Т.Стоимость КАК Стоимость,
	|	-Т.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-Т.ДопРасходы КАК ДопРасходы,
	|	-Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-Т.СтоимостьУпр КАК СтоимостьУпр,
	|	-Т.СтоимостьРегл КАК СтоимостьРегл,
	|	-Т.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	-Т.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	-Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-Т.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	-Т.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	-Т.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	-Т.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	-Т.Трудозатраты КАК Трудозатраты,
	|	-Т.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	-Т.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	-Т.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	-Т.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	-Т.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	-Т.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	-Т.ВременнаяРазница КАК ВременнаяРазница,
	// Реквизиты
	|	Т.Регистратор КАК ДокументДвижения,
	|	Т.НалогообложениеНДС,
	|	Т.ВалютаВзаиморасчетов,
	|	Т.ВалютаДокумента,
	|	Т.ИсточникГФУНоменклатуры,
	|	Т.ИсточникГФУРасчетов,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВтДвиженияСебестоимостьПродаж
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	НЕ Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера))
	|";
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтДвиженияСебестоимостьПродажВозвратыПрошлыхПериодов";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияСебестоимостьПродаж";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

#КонецОбласти

#Область ПрочиеДоходы

	// Формирование прочих доходов при возврате тары от клиента
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Регистратор,
	// Измерения
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяДоходов,
	|	Т.АналитикаДоходов,
	// Ресурсы
	|	(ВЫБОР
	|		КОГДА Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС > 0
	|			ТОГДА Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК Сумма,
	|	(ВЫБОР
	|		КОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл > 0
	|			ТОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР
	|		КОГДА Т.СтоимостьУпр + Т.ДопРасходыУпр + Т.ТрудозатратыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр > 0
	|			ТОГДА Т.СтоимостьУпр + Т.ДопРасходыУпр + Т.ТрудозатратыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	// Реквизиты
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВтДвиженияПрочиеДоходы
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	&ИспользоватьУчетПрочихДоходовРасходов
	|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов)
	|	И (Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС > 0
	|		ИЛИ Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл > 0
	|		ИЛИ Т.СтоимостьУпр + Т.ДопРасходыУпр + Т.ТрудозатратыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр > 0
	|		)
	|";
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеДоходы.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтДвиженияВозвратыПрошлыхПериодовПрочиеДоходы";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеДоходы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

#КонецОбласти

#Область ПрочиеРасходы

	// Формирование прочих расходов при возврате тары от клиента
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Регистратор,
	// Измерения
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
	|	Т.АналитикаРасходов,
	// Реквизиты статьи расходов
	|	Т.ВариантРаспределенияРасходовУпр,
	|	Т.ВариантРаспределенияРасходовРегл,
	|	Т.ПринятиеКНалоговомуУчету,
	// Ресурсы
	|	-(ВЫБОР
	|		КОГДА Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС < 0
	|			ТОГДА Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК Сумма,
	// Условия по сумме без НДС должны совпадать с условиями в:
	// - см. СкорректироватьСтоимостьСписанияЗапасов и вызываемых методах.
	// - см. СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом в приходном движении.
	// - см. РегистрыНакопления.ПрочиеРасходы.ТекстЗапросаТаблицаВтПрочиеРасходы.
	|	-(ВЫБОР
	|		КОГДА Т.СтоимостьБезНДС + Т.ДопРасходыБезНДС + Т.Трудозатраты + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ВЫБОР
	|				КОГДА НЕ Т.ВариантРаспределенияРасходовУпр В (
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы))
	|					ТОГДА Т.СтоимостьБезНДС + Т.ДопРасходыБезНДС + Т.Трудозатраты + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС
	|				ИНАЧЕ 0 КОНЕЦ
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	-(ВЫБОР
	|		КОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл < 0
	|			ТОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	-(ВЫБОР
	|		КОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл < 0 И Т.ПринятиеКНалоговомуУчету
	|			ТОГДА Т.ПостояннаяРазница
	|		КОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл < 0 И НЕ Т.ПринятиеКНалоговомуУчету
	|			ТОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл + Т.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	-(ВЫБОР
	|		КОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл < 0 И Т.ПринятиеКНалоговомуУчету
	|			ТОГДА Т.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	-(ВЫБОР
	|		КОГДА Т.СтоимостьНДД < 0
	|			ТОГДА Т.СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаНДД,
	|	-(ВЫБОР
	|		КОГДА Т.СтоимостьУпр + Т.ДопРасходыУпр + Т.ТрудозатратыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр < 0
	|			ТОГДА Т.СтоимостьУпр + Т.ДопРасходыУпр + Т.ТрудозатратыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	// Реквизиты
	|	Т.ХозяйственнаяОперация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходы
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	&ИспользоватьУчетПрочихДоходовРасходов
	|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов)
	|	И (Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС < 0
	|		ИЛИ Т.СтоимостьБезНДС + Т.ДопРасходыБезНДС + Т.Трудозатраты + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС < 0
	|		ИЛИ Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл < 0
	|		ИЛИ Т.СтоимостьУпр + Т.ДопРасходыУпр + Т.ТрудозатратыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр < 0
	|		ИЛИ Т.СтоимостьНДД < 0
	|		)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Регистратор КАК ДокументДвижения,
	// Измерения
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	// Реквизиты статьи расходов
	|	Т.ВариантРаспределенияРасходовУпр,
	|	Т.ВариантРаспределенияРасходовРегл,
	|	Т.ПринятиеКНалоговомуУчету,
	// Ресурсы
	|	-(Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС) КАК Сумма,
	// Условия по сумме без НДС должны совпадать с условиями в:
	// - см. СкорректироватьСтоимостьСписанияЗапасов и вызываемых методах.
	// - см. СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом в приходном движении.
	// - см. РегистрыНакопления.ПрочиеРасходы.ТекстЗапросаТаблицаВтПрочиеРасходы.
	|	-(ВЫБОР
	|		КОГДА НЕ Т.ВариантРаспределенияРасходовУпр В (
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы),
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы))
	|			ТОГДА Т.СтоимостьБезНДС + Т.ДопРасходыБезНДС + Т.Трудозатраты + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	-(Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл) КАК СуммаРегл,
	|	-(ВЫБОР
	|		КОГДА НЕ Т.ПринятиеКНалоговомуУчету
	|			ТОГДА Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл
	|		ИНАЧЕ Т.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
	|	-Т.ВременнаяРазница КАК ВременнаяРазница,
	|	-Т.СтоимостьНДД КАК СуммаНДД,
	|	-(Т.СтоимостьУпр + Т.ДопРасходыУпр + Т.ТрудозатратыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр) КАК СуммаУпр,
	// Реквизиты
	|	Т.ХозяйственнаяОперация,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	&ИспользоватьУчетПрочихДоходовРасходов
	|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы)
	|";
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтДвиженияВозвратыПрошлыхПериодовПрочиеРасходы";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеРасходы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

#КонецОбласти

	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	СуществующиеВТ = РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(СуществующиеВТ, 
		"СторноОтчетыКомиссионера, ВтДатыДокументовИсточников");
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

// Выполняет формирование стоимостных движений для исправлений документов прошлых периодов и возвратов прошлых периодов в текущем периоде. 
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов");
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ВтДвиженияСебестоимости, ВтДвиженияОтклоненияВСтоимостиТоваров, 
		|ВтДвиженияСебестоимостьПродаж, ВтДвиженияТаблицаЗакупки,
		//++ НЕ УТ
		|ВтДвиженияПрочиеРасходыНезавершенногоПроизводства,
		//-- НЕ УТ
		|ВтДвиженияПрочиеРасходы, ВтДвиженияПрочиеДоходы, ВтДвиженияПрочиеАктивыПассивы, 
		|ВтДвиженияНоменклатураДоходыРасходы, ВтДвиженияНоменклатураНоменклатура
		| ");
	
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстСкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов(ПараметрыРасчета));
	
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов_ФормированиеДвижений");
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;

#Область ИсправлениеСебестоимостьТоваров
	
	ИмяВременнойТаблицы = "ВтСебестоимостьСторноДвижений";
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицыИсточник = "ВтДвиженияСебестоимости";
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти

#Область ОтклоненияВСтоимостиТоваров

	ИмяВременнойТаблицы = "ВтДвиженияПереносВОтклоненияВСтоимостиТоваров";
	ИмяРегистра = Метаданные.РегистрыНакопления.ОтклоненияВСтоимостиТоваров.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета,
		"ВтДвиженияОтклоненияВСтоимостиТоваров");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтДвиженияОтклоненияВСтоимостиТоваров", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

#КонецОбласти

#Область ИсправлениеВыручкаИСебестоимостьПродаж

	ИмяВременнойТаблицы = "ВтВыручкаИСебестоимостьПродажСторноДвижений";
	ИмяРегистра = Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтДвиженияСебестоимостьПродаж");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтДвиженияСебестоимостьПродаж", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

#КонецОбласти

#Область ИсправлениеЗакупки

	ИмяВременнойТаблицы = "ВтДвиженияЗакупки";
	ИмяРегистра = Метаданные.РегистрыНакопления.Закупки.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтДвиженияТаблицаЗакупки");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтДвиженияТаблицаЗакупки", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

#КонецОбласти

//++ НЕ УТ
#Область ИсправлениеПрочиеРасходыНезавершенногоПроизводства

	ИмяВременнойТаблицы = "ВтПрочиеРасходыНезавершенногоПроизводстваСторноДвижений";
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицыИсточник = "ВтДвиженияПрочиеРасходыНезавершенногоПроизводства";
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти
//-- НЕ УТ

#Область ИсправлениеПрочиеРасходы

	ИмяВременнойТаблицы = "ВтПрочиеРасходыСторноДвижений";
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтДвиженияПрочиеРасходы");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтДвиженияПрочиеРасходы", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти

#Область ИсправлениеПрочиеДоходы

	ИмяВременнойТаблицы = "ВтПрочиеДоходыСторноДвижений";
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеДоходы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтДвиженияПрочиеДоходы");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтДвиженияПрочиеДоходы", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти

#Область ИсправлениеПрочиеАктивыПассивы

	ИмяВременнойТаблицы = "ВтПрочиеАктивыПассивыСторноДвижений";
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтДвиженияПрочиеАктивыПассивы");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтДвиженияПрочиеАктивыПассивы", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти

#Область ИсправлениеДвиженияНоменклатураДоходыРасходы

	ИмяВременнойТаблицы = "ВтДвиженияНоменклатураДоходыРасходыСторноДвижений";
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтДвиженияНоменклатураДоходыРасходы");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтДвиженияНоменклатураДоходыРасходы", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти

#Область ИсправлениеДвиженияНоменклатураНоменклатура

	ИмяВременнойТаблицы = "ВтДвиженияНоменклатураНоменклатураСторноДвижений";
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураНоменклатура.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтДвиженияНоменклатураНоменклатура");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтДвиженияНоменклатураНоменклатура", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти

	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

Функция ТекстСкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов(ПараметрыРасчета)
	
	ТекстЗапроса = "";

	#Область ИсправленныеДокументы
	ТекстЗапроса = ТекстЗапроса + РасчетСебестоимостиЗаполнениеПартий.ТекстИсправленныеДокументы() // вт ИсправленныеДокументы
		+ ОбщегоНазначения.РазделительПакетаЗапросов();
	#КонецОбласти

	#Область ИсправлениеСебестоимостьТоваров // ВтДвиженияСебестоимости

	// Заполнение полей должно соответствовать функции РасчетСебестоимостиЗаполнениеПартий.ТекстСторноДвиженияИсправленныхДокументовПрошлогоПериода()
	// Поля: Регистратор, Период, ТипЗаписи, ДокументИсточник
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	(ВЫБОР
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпуск)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпускСторноПрошлогоПериода)
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДополнениеПрошлыйПериод)
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноВозвратаПрошлыхПериодов)
	|		КОГДА ДД.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода)
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		    И ДД.ТипЗаписи В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Перемещение),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПеремещениеОбособленно))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПеремещенияПрошлогоПериода)
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		 И НЕ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
	|		 ИЛИ ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода) КОНЕЦ) КАК ТипЗаписи,
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ВЫБОР
	|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
	//++ НЕ УТ
	|			ИЛИ ТИПЗНАЧЕНИЯ(ДД.Партия) = ТИП(Справочник.ПартииПроизводства)
	//-- НЕ УТ
	|			ИЛИ ДД.РазделУчета В (
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки),
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.СобственныеТоварыВПути))
	|		ТОГДА ДД.Партия
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК Партия,
	|	ВЫБОР
	|		КОГДА ДД.Организация В (&ОрганизацииСФИФОСкользящая)
	//++ НЕ УТ
	|			ИЛИ ТИПЗНАЧЕНИЯ(ДД.Партия) = ТИП(Справочник.ПартииПроизводства)
	//-- НЕ УТ
	|			ИЛИ ДД.РазделУчета В (
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки),
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.СобственныеТоварыВПути))
	|		ТОГДА ДД.АналитикаУчетаПартий
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|	КОНЕЦ КАК АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	// Ресурсы
	|	-ДД.Стоимость КАК Стоимость,
	|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	-ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	-ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	-ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	-ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	-ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	-ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	-ДД.ДопРасходы КАК ДопРасходы,
	|	-ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-ДД.Трудозатраты КАК Трудозатраты,
	|	-ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	-ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	-ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	-ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.СтоимостьНДД КАК СтоимостьНДД,
	|	-ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	-ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	-ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	-ДД.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	-ДД.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорРазделУчета,
	|	ДД.КорВидЗапасов,
	|	ДД.КорОрганизация,
	|	ДД.КорСтоимость,
	|	ДД.АналитикаУчетаПоПартнерам,
	|	ДД.ЗаказКлиента,
	|	ДД.Подразделение,
	|	ДД.АналитикаРасходов,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.СтатьяДоходов,
	|	ДД.АналитикаДоходов,
	|	ДД.ПериодПродажи,
	|	ДД.СтатьяАктивовПассивов,
	|	ДД.АналитикаАктивовПассивов,
	|	ИсправленныеДокументы.Регистратор КАК ДокументДвижения,
	|	ДД.ИдентификаторСтроки,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.ГруппаПродукции,
	|	ДД.КорПартия,
	|	ДД.КорАналитикаУчетаПартий,
	|	ДД.КорАналитикаФинансовогоУчета,
	|	ДД.КорВидДеятельностиНДС,
	|	-ДД.НДСУпр КАК НДСУпр,
	|	-ДД.НДСРегл КАК НДСРегл,
	|	ДД.СтатьяКалькуляции,
	|	ДД.Регистратор КАК ДокументИсточник,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.КодСтроки,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ИСТИНА КАК Сторно
	|ПОМЕСТИТЬ ВтДвиженияСебестоимости
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|	ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|	ПО ДД.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Период < &НачалоПериода
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ДД.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	|	И НЕ ДД.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	(ВЫБОР
	|		КОГДА ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноВозвратаПрошлыхПериодов)
	|		КОГДА ДД.СлужебноеВидДвиженияПриход
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода) КОНЕЦ) КАК ТипЗаписи,
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	|	(ВЫБОР
	|		КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КОНЕЦ) КАК ВидДвижения,
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	// Ресурсы
	|	-ДД.Стоимость КАК Стоимость,
	|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	-ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	-ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	-ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	-ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	-ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	-ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	-ДД.ДопРасходы КАК ДопРасходы,
	|	-ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-ДД.Трудозатраты КАК Трудозатраты,
	|	-ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	-ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	-ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	-ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.СтоимостьНДД КАК СтоимостьНДД,
	|	-ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	-ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	-ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	-ДД.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	-ДД.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорРазделУчета,
	|	ДД.КорВидЗапасов,
	|	ДД.КорОрганизация,
	|	ДД.КорСтоимость,
	|	ДД.АналитикаУчетаПоПартнерам,
	|	ДД.ЗаказКлиента,
	|	ДД.Подразделение,
	|	ДД.АналитикаРасходов,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.СтатьяДоходов,
	|	ДД.АналитикаДоходов,
	|	ДД.ПериодПродажи,
	|	ДД.СтатьяАктивовПассивов,
	|	ДД.АналитикаАктивовПассивов,
	|	ИсправленныеДокументы.Регистратор КАК ДокументДвижения,
	|	ДД.ИдентификаторСтроки,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.ГруппаПродукции,
	|	ДД.КорПартия,
	|	ДД.КорАналитикаУчетаПартий,
	|	ДД.КорАналитикаФинансовогоУчета,
	|	ДД.КорВидДеятельностиНДС,
	|	-ДД.НДСУпр КАК НДСУпр,
	|	-ДД.НДСРегл КАК НДСРегл,
	|	ДД.СтатьяКалькуляции,
	|	ДД.Регистратор КАК ДокументИсточник,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.КодСтроки,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ИСТИНА КАК Сторно
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|	ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.РасчетСебестоимости
	|	И НЕ ДД.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// При среднескользящей суммы доп расходов, трудозатрат и постатейных расходов нужно перенести
	// в регистр "Отклонения в стоимости товаров".
	// Такие суммы могут возникнуть при исправлении или стороно документов, отраженных до перехода
	// на среднескользящую стоимость.
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Дополнение) КАК ТипЗаписи,
	|	&КонецПериода										КАК Период,
	|	ДокументыРасчетаСебестоимости.Ссылка 				КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)				КАК ВидДвижения,
	|	
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	// Ресурсы
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьУпр,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ДопРасходыУпр
	|		ИНАЧЕ ДД.ДопРасходыУпр КОНЕЦ) КАК ДопРасходыУпр,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостатейныеПеременныеСНДС
	|		ИНАЧЕ ДД.ПостатейныеПеременныеСНДС КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ ДД.ПостатейныеПеременныеБезНДС КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ТрудозатратыУпр
	|		ИНАЧЕ ДД.ТрудозатратыУпр КОНЕЦ) КАК ТрудозатратыУпр,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостатейныеПостоянныеУпр
	|		ИНАЧЕ ДД.ПостатейныеПостоянныеУпр КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостатейныеПеременныеУпр
	|		ИНАЧЕ ДД.ПостатейныеПеременныеУпр КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ДопРасходы
	|		ИНАЧЕ ДД.ДопРасходы КОНЕЦ) КАК ДопРасходы,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ДопРасходыБезНДС
	|		ИНАЧЕ ДД.ДопРасходыБезНДС КОНЕЦ) КАК ДопРасходыБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.Трудозатраты
	|		ИНАЧЕ ДД.Трудозатраты КОНЕЦ) КАК Трудозатраты,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ ДД.ПостатейныеПостоянныеСНДС КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ ДД.ПостатейныеПостоянныеБезНДС КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостояннаяРазница
	|		ИНАЧЕ ДД.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ВременнаяРазница
	|		ИНАЧЕ ДД.ВременнаяРазница КОНЕЦ) КАК ВременнаяРазница,
	|	0 КАК СтоимостьНДД,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ДопРасходыРегл
	|		ИНАЧЕ ДД.ДопРасходыРегл КОНЕЦ) КАК ДопРасходыРегл,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ТрудозатратыРегл
	|		ИНАЧЕ ДД.ТрудозатратыРегл КОНЕЦ) КАК ТрудозатратыРегл,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостатейныеПостоянныеРегл
	|		ИНАЧЕ ДД.ПостатейныеПостоянныеРегл КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ ДД.СлужебноеВидДвиженияПриход ТОГДА -ДД.ПостатейныеПеременныеРегл
	|		ИНАЧЕ ДД.ПостатейныеПеременныеРегл КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|	0 КАК РезервПодОбесценениеРегл,
	|	0 КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СлужебноеИзменениеМетодаОценкиСтоимости) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК КорАналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК КорРазделУчета,
	|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК КорВидЗапасов,
	|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
	|	0 КАК КорСтоимость,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка) КАК СтатьяДоходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
	|	ДАТАВРЕМЯ(1,1,1) КАК ПериодПродажи,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка) КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	ДокументыРасчетаСебестоимости.Ссылка КАК ДокументДвижения,
	|	"""" КАК ИдентификаторСтроки,
	|	МАКСИМУМ(ДД.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК КорПартия,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК КорАналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО КАК КорАналитикаФинансовогоУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК КорВидДеятельностиНДС,
	|	0 КАК НДСУпр,
	|	0 КАК НДСРегл,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО КАК ДокументИсточник,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК КорНаправлениеДеятельности,
	|	0 КАК КодСтроки,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СлужебноеИзменениеМетодаОценкиСтоимости) КАК НастройкаХозяйственнойОперации,
	|	ЛОЖЬ КАК Сторно
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = ДД.Регистратор
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО ДД.Организация = ДокументыРасчетаСебестоимости.Организация
	|ГДЕ
	|	ДД.Организация В (&ОрганизацииСреднескользящая)
	|	И ДД.Сторно
	|	И (ДД.ДопРасходы <> 0 ИЛИ ДД.ДопРасходыБезНДС <> 0 ИЛИ ДД.Трудозатраты <> 0
	|		ИЛИ ДД.ПостатейныеПостоянныеСНДС <> 0 ИЛИ ДД.ПостатейныеПеременныеСНДС <> 0
	|		ИЛИ ДД.ПостатейныеПостоянныеБезНДС <> 0 ИЛИ ДД.ПостатейныеПеременныеБезНДС <> 0
	|		ИЛИ ДД.ДопРасходыРегл <> 0 ИЛИ ДД.ТрудозатратыРегл <> 0
	|		ИЛИ ДД.ПостатейныеПостоянныеРегл <> 0 ИЛИ ДД.ПостатейныеПеременныеРегл <> 0
	|		ИЛИ ДД.ПостояннаяРазница <> 0 ИЛИ ДД.ВременнаяРазница <> 0		
	|		ИЛИ ДД.ДопРасходыУпр <> 0 ИЛИ ДД.ТрудозатратыУпр <> 0
	|		ИЛИ ДД.ПостатейныеПостоянныеУпр <> 0 ИЛИ ДД.ПостатейныеПеременныеУпр <> 0
	|		)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДокументыРасчетаСебестоимости.Ссылка,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;";
	#КонецОбласти

	#Область ОтклоненияВСтоимостиТоваров // ВтДвиженияОтклоненияВСтоимостиТоваров
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.Период КАК Период,
	|	Т.Регистратор КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Измерения
	|	Т.Организация,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура КАК Номенклатура,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика КАК Характеристика,
	|	Т.ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).МестоХранения
	|		КОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	|	&НачалоПериода КАК ПериодОтклонения,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|
	|	СУММА(Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС) КАК ОтклоненияВСтоимостиСНДС,
	|	СУММА(Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС) КАК ОтклоненияВСтоимостиБезНДС,
	|	СУММА(Т.ТрудозатратыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл) КАК ОтклоненияВСтоимостиРегл,
	|	СУММА(Т.ТрудозатратыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр) КАК ОтклоненияВСтоимостиУпр,
	|	СУММА(Т.ДопРасходы) КАК ДопРасходыСНДС,
	|	СУММА(Т.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(Т.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Т.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Т.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) КАК ВременнаяРазница
	|
	|ПОМЕСТИТЬ ВтДвиженияОтклоненияВСтоимостиТоваров
	|ИЗ
	|	ВтДвиженияСебестоимости КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СлужебноеИзменениеМетодаОценкиСтоимости)
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.Организация,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Характеристика,
	|	Т.ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // НаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).МестоХранения
	|		КОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // Подразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // МестоХранения
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|;";
	#КонецОбласти

	#Область ИсправлениеВыручкаИСебестоимостьПродаж
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ЗаказКлиента,
	|	ДД.АналитикаУчетаПоПартнерам,
	|	ДД.Подразделение,
	|	ДД.ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.РазделУчета,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.Менеджер,
	|	ДД.Склад,
	|	ДД.Соглашение,
	|	ДД.Договор,
	|	ДД.ХозяйственнаяОперация,
	|	ДД.АналитикаУчетаНаборов,
	|	ДД.НаправлениеДеятельностиКонтрагента,
	|	ДД.НаправлениеДеятельностиНоменклатуры,
	// Ресурсы
	|	-ДД.Стоимость КАК Стоимость,
	|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-ДД.ДопРасходы КАК ДопРасходы,
	|	-ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	-ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	-ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	-ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	-ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	-ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	-ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	-ДД.Трудозатраты КАК Трудозатраты,
	|	-ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	-ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	-ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	-ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	-ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	-ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	-ДД.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	-ДД.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ДД.НалогообложениеНДС,
	|	ДД.ВалютаВзаиморасчетов,
	|	ДД.ВалютаДокумента,
	|	ДД.ИсточникГФУНоменклатуры,
	|	ДД.ИсточникГФУРасчетов,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ИСТИНА КАК Сторно
	|ПОМЕСТИТЬ ВтДвиженияСебестоимостьПродаж
	|ИЗ
	|	РегистрНакопления.ВыручкаИСебестоимостьПродаж КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.АналитикаУчетаПоПартнерам.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.АналитикаУчетаПоПартнерам.Организация В (&МассивОрганизаций)
	|	И ДД.Период < &НачалоПериода 
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ДД.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	|	И НЕ ДД.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ЗаказКлиента,
	|	ДД.АналитикаУчетаПоПартнерам,
	|	ДД.Подразделение,
	|	ДД.ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.РазделУчета,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.Менеджер,
	|	ДД.Склад,
	|	ДД.Соглашение,
	|	ДД.Договор,
	|	ДД.ХозяйственнаяОперация,
	|	ДД.АналитикаУчетаНаборов,
	|	ДД.НаправлениеДеятельностиКонтрагента,
	|	ДД.НаправлениеДеятельностиНоменклатуры,
	// Ресурсы
	|	-ДД.Стоимость КАК Стоимость,
	|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-ДД.ДопРасходы КАК ДопРасходы,
	|	-ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	-ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	-ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	-ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	-ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	-ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	-ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	-ДД.Трудозатраты КАК Трудозатраты,
	|	-ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	-ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	-ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	-ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	-ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	-ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	-ДД.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	-ДД.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ДД.НалогообложениеНДС,
	|	ДД.ВалютаВзаиморасчетов,
	|	ДД.ВалютаДокумента,
	|	ДД.ИсточникГФУНоменклатуры,
	|	ДД.ИсточникГФУРасчетов,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ИСТИНА КАК Сторно
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.АналитикаУчетаПоПартнерам.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.РасчетСебестоимости
	|	И НЕ ДД.Сторно
	|;";
	#КонецОбласти

	#Область ИсправлениеЗакупки
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор,
	// Измерения
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУДругойОрганизации) КАК ХозяйственнаяОперация,
	|	КлючиАналитикиУчетаПоПартнерам.Контрагент КАК Организация,
	|	Т.Подразделение,
	|	Т.Менеджер,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.Склад,
	|	Т.ТипЗапасов,
	|	Т.ВидЗапасов,
	|	КлючиАналитикиУчетаПоПартнерам.Партнер КАК Партнер,
	|	КлючиАналитикиУчетаПоПартнерам.Организация КАК Контрагент,
	|	Т.Соглашение,
	|	Т.Договор,
	// Ресурсы
	|	Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС КАК Стоимость,
	|	Т.СтоимостьБезНДС + Т.ДопРасходыБезНДС + Т.Трудозатраты + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС КАК СтоимостьБезНДС,
	// Реквизиты
	|	Т.ВалютаДокумента,
	|	Т.ВалютаВзаиморасчетов,
	|	Т.Регистратор КАК ДокументДвижения,
	|	Т.ИсточникГФУНоменклатуры,
	|	Т.ИсточникГФУРасчетов,
	|	Т.Сторно
	|ПОМЕСТИТЬ ВтДвиженияТаблицаЗакупки
	|ИЗ
	|	ВтДвиженияСебестоимостьПродаж КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаПоПартнерам КАК КлючиАналитикиУчетаПоПартнерам
	|	ПО КлючиАналитикиУчетаПоПартнерам.Ссылка = Т.АналитикаУчетаПоПартнерам
	|ГДЕ
	|	Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|;";
	#КонецОбласти

	//++ НЕ УТ
	#Область ИсправлениеПрочиеРасходыНезавершенногоПроизводства
	ТекстЗапроса = ТекстЗапроса + "
	// Сторно распределения на продукцию.
	|ВЫБРАТЬ
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.СтатьяРасходов,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности,
	|	ДД.ПартияПроизводства,
	|	ДД.ПартияПроизводства,
	|	ДД.СтатьяКалькуляции,
	|	ДД.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	// Ресурсы
	|	-ДД.Стоимость КАК Стоимость,
	|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.СтоимостьНДД КАК СтоимостьНДД,
	|	-ДД.СтоимостьУпр КАК СтоимостьУпр,
	// Реквизиты
	|	ДД.АналитикаУчетаПродукции,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.КорАналитикаУчетаПартий,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ИСТИНА КАК Сторно
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходыНезавершенногоПроизводства
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|	ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Период < &НачалоПериода
	|	И ДД.Активность
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ДД.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	|	И НЕ ДД.Сторно
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;";
	#КонецОбласти
	//-- НЕ УТ
	
	#Область ИсправлениеПрочиеРасходы
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	// Ресурсы
	|	-ДД.Сумма КАК Сумма,
	|	-ДД.СуммаБезНДС КАК СуммаБезНДС,
	|	-ДД.СуммаРегл КАК СуммаРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.СуммаНДД КАК СуммаНДД,
	|	-ДД.СуммаУпр КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ДокументДвижения,
	|	ДД.ИдентификаторСтроки,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ИСТИНА КАК Сторно
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходы
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Период < &НачалоПериода
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ДД.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	|	И НЕ ДД.Сторно
	|;";
	#КонецОбласти
	
	#Область ИсправлениеПрочиеДоходы
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяДоходов,
	|	ДД.АналитикаДоходов,
	// Ресурсы
	|	-ДД.Сумма КАК Сумма,
	|	-ДД.СуммаРегл КАК СуммаРегл,
	|	-ДД.СуммаУпр КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ИСТИНА КАК Сторно
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеДоходы
	|ИЗ
	|	РегистрНакопления.ПрочиеДоходы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Период < &НачалоПериода
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ДД.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	|	И НЕ ДД.Сторно
	|;";
	#КонецОбласти

	#Область ИсправлениеПрочиеАктивыПассивы
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.Статья,
	|	ДД.Аналитика,
	// Ресурсы
	|	-ДД.Сумма КАК Сумма,
	// Реквизиты
	|	ДД.ВидИсточника,
	|	ДД.Источник,
	|	ИСТИНА КАК Сторно
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеАктивыПассивы
	|ИЗ
	|	РегистрНакопления.ПрочиеАктивыПассивы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Период < &НачалоПериода
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ДД.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	|	И НЕ ДД.Сторно
	|;";
	#КонецОбласти

	#Область ИсправлениеДвиженияНоменклатураДоходыРасходы
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.ХозяйственнаяОперация,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельностиНоменклатуры,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.Склад,
	|	ДД.ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.НаправлениеДеятельностиСтатьи,
	|	ДД.СтатьяДоходовРасходов,
	|	ДД.АналитикаДоходов,
	|	ДД.АналитикаРасходов,
	|	ДД.АналитикаАктивовПассивов,
	// Ресурсы
	|	-ДД.Стоимость КАК Стоимость,
	|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	-ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	-ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	-ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	-ДД.ДопРасходы КАК ДопРасходы,
	|	-ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	-ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	-ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	-ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	-ДД.Трудозатраты КАК Трудозатраты,
	|	-ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	-ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	-ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	-ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	-ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	-ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	-ДД.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ДД.ИсточникГФУНоменклатуры,
	|	ИСТИНА КАК Сторно
	|ПОМЕСТИТЬ ВтДвиженияНоменклатураДоходыРасходы
	|ИЗ
	|	РегистрНакопления.ДвиженияНоменклатураДоходыРасходы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Период < &НачалоПериода 
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ДД.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	|	И НЕ ДД.Сторно
	|;";
	#КонецОбласти
	
	#Область ИсправлениеДвиженияНоменклатураНоменклатура
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ИсправленныеДокументы.Период КАК Период,
	|	ИсправленныеДокументы.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.ХозяйственнаяОперация,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.Склад,
	|	ДД.ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорСклад,
	|	ДД.КорТипЗапасов,
	|	ДД.КорВидЗапасов,
	// Ресурсы
	|	-ДД.Стоимость КАК Стоимость,
	|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	-ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	-ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	-ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	-ДД.ДопРасходы КАК ДопРасходы,
	|	-ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	-ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	-ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	-ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	-ДД.Трудозатраты КАК Трудозатраты,
	|	-ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	-ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	-ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	-ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	-ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	-ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	-ДД.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ДД.ИсточникГФУНоменклатуры,
	|	ДД.КорИсточникГФУНоменклатуры,
	|	ДД.КорОрганизация,
	|	ИСТИНА КАК Сторно
	|ПОМЕСТИТЬ ВтДвиженияНоменклатураНоменклатура
	|ИЗ
	|	РегистрНакопления.ДвиженияНоменклатураНоменклатура КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.СторнируемыйДокумент = ДД.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Период < &НачалоПериода 
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ДД.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	|	И НЕ ДД.Сторно
	|;";
#КонецОбласти
		
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

// Этап сохранения ранее рассчитанных движений.
// Выполняет сохранение стоимостных движений для ранее рассчитанных документов. 
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура СохранитьДвиженияРасчетаСебестоимостиРассчитанныхДокументов(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СохранитьДвиженияРасчетаСебестоимостиРассчитанныхДокументов");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
#Область СебестоимостьТоваров

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	// Ресурсы
	|	СУММА(ДД.Стоимость) КАК Стоимость,
	|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(ДД.СтоимостьЗабалансовая) КАК СтоимостьЗабалансовая,
	|	СУММА(ДД.СтоимостьУпр) КАК СтоимостьУпр,
	|	СУММА(ДД.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(ДД.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
	|	СУММА(ДД.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(ДД.ТрудозатратыУпр) КАК ТрудозатратыУпр,
	|	СУММА(ДД.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
	|	СУММА(ДД.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр,
	|	СУММА(ДД.ДопРасходы) КАК ДопРасходы,
	|	СУММА(ДД.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(ДД.Трудозатраты) КАК Трудозатраты,
	|	СУММА(ДД.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
	|	СУММА(ДД.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
	|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
	|	СУММА(ДД.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(ДД.СтоимостьНДД) КАК СтоимостьНДД,
	|	СУММА(ДД.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(ДД.ТрудозатратыРегл) КАК ТрудозатратыРегл,
	|	СУММА(ДД.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
	|	СУММА(ДД.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
	|	СУММА(ДД.РезервПодОбесценениеРегл) КАК РезервПодОбесценениеРегл,
	|	СУММА(ДД.РезервПодОбесценениеУпр) КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорРазделУчета,
	|	ДД.КорВидЗапасов,
	|	ДД.КорОрганизация,
	|	ДД.КорСтоимость,
	|	ДД.АналитикаУчетаПоПартнерам,
	|	ДД.ЗаказКлиента,
	|	ДД.Подразделение,
	|	ДД.АналитикаРасходов,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.СтатьяДоходов,
	|	ДД.АналитикаДоходов,
	|	ДД.ПериодПродажи,
	|	ДД.СтатьяАктивовПассивов,
	|	ДД.АналитикаАктивовПассивов,
	|	ДД.ДокументДвижения,
	|	ДД.ИдентификаторСтроки,
	|	ДД.ГруппаПродукции,
	|	ДД.КорПартия,
	|	ДД.КорАналитикаУчетаПартий,	
	|	ДД.КорАналитикаФинансовогоУчета,
	|	ДД.КорВидДеятельностиНДС,
	|	ДД.НДСУпр КАК НДСУпр,
	|	ДД.НДСРегл КАК НДСРегл,
	|	ДД.СтатьяКалькуляции,
	|	ДД.ТипЗаписи,
	|	ДД.ДокументИсточник,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.КодСтроки,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.Сторно,
	|	ДД.НастройкаСчетовУчета,
	|	(ВЫБОР
	|		КОГДА &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|		 ИЛИ НЕ &ВыделятьОтклоненияСебестоимостиОкончательногоРасчета
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ДД.ДокументРасчета КОНЕЦ) КАК ДокументРасчета,
	|	(ВЫБОР
	|		КОГДА ДД.РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПустаяСсылка)
	|			ТОГДА &РежимЗакрытияМесяца
	|		ИНАЧЕ ДД.РежимЗакрытияМесяца КОНЕЦ) КАК РежимЗакрытияМесяца
	|
	|ПОМЕСТИТЬ ВтДвиженияСебестоимости
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|
	// Проверка по рассчитанным документам так же есть в 
	// см. РасчетСебестоимостиРешениеСЛУ.ТекстВтУзлыКорректировки_МатериальныеИТрудозатраты
	
	//++ Локализация

	// см. РасчетСебестоимостиРешениеСЛУ.ТекстСебестоимостьНалоговыйУчет
	// см. РасчетСебестоимостиНДД.ТекстСебестоимостьСтоимостьНДД

	//-- Локализация
	
	// Условие соединения должно совпадать (кроме типа соединения).
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ ДД.Сторно
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорРазделУчета,
	|	ДД.КорВидЗапасов,
	|	ДД.КорОрганизация,
	|	ДД.КорСтоимость,
	|	ДД.АналитикаУчетаПоПартнерам,
	|	ДД.ЗаказКлиента,
	|	ДД.Подразделение,
	|	ДД.АналитикаРасходов,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.СтатьяДоходов,
	|	ДД.АналитикаДоходов,
	|	ДД.ПериодПродажи,
	|	ДД.СтатьяАктивовПассивов,
	|	ДД.АналитикаАктивовПассивов,
	|	ДД.ДокументДвижения,
	|	ДД.ИдентификаторСтроки,
	|	ДД.ГруппаПродукции,
	|	ДД.КорПартия,
	|	ДД.КорАналитикаУчетаПартий,	
	|	ДД.КорАналитикаФинансовогоУчета,
	|	ДД.КорВидДеятельностиНДС,
	|	ДД.НДСУпр,
	|	ДД.НДСРегл,
	|	ДД.СтатьяКалькуляции,
	|	ДД.ТипЗаписи,
	|	ДД.ДокументИсточник,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.КодСтроки,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.Сторно,
	|	ДД.НастройкаСчетовУчета,
	|	(ВЫБОР
	|		КОГДА &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|		 ИЛИ НЕ &ВыделятьОтклоненияСебестоимостиОкончательногоРасчета
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ДД.ДокументРасчета КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА ДД.РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПустаяСсылка)
	|			ТОГДА &РежимЗакрытияМесяца
	|		ИНАЧЕ ДД.РежимЗакрытияМесяца КОНЕЦ)
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтСебестоимостьСохранениеДвижений";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияСебестоимости";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

#Область ВыручкаИСебестоимостьПродаж

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ЗаказКлиента,
	|	ДД.АналитикаУчетаПоПартнерам,
	|	ДД.Подразделение,
	|	ДД.ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.РазделУчета,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.Менеджер,
	|	ДД.Склад,
	|	ДД.Соглашение,
	|	ДД.Договор,
	|	ДД.ХозяйственнаяОперация,
	|	ДД.АналитикаУчетаНаборов,
	|	ДД.НаправлениеДеятельностиКонтрагента,
	|	ДД.НаправлениеДеятельностиНоменклатуры,
	// Ресурсы
	|	ДД.Количество,
	|	ДД.СуммаВыручки,
	|	ДД.СуммаВыручкиБезНДС,
	|	ДД.Стоимость,
	|	ДД.СтоимостьБезНДС,
	|	ДД.ДопРасходы,
	|	ДД.ДопРасходыБезНДС,
	|	ДД.СтоимостьУпр,
	|	ДД.СтоимостьРегл,
	|	ДД.СтоимостьЗабалансовая,
	|	ДД.СтоимостьЗабалансоваяРегл,
	|	ДД.СуммаВыручкиРегл,
	|	ДД.ПостояннаяРазница,
	|	ДД.ДопРасходыУпр,
	|	ДД.ДопРасходыРегл,
	|	ДД.ПостатейныеПостоянныеСНДС,
	|	ДД.ПостатейныеПостоянныеБезНДС,
	|	ДД.ПостатейныеПостоянныеУпр,
	|	ДД.ПостатейныеПостоянныеРегл,
	|	ДД.Трудозатраты,
	|	ДД.ТрудозатратыУпр,
	|	ДД.ТрудозатратыРегл,
	|	ДД.ПостатейныеПеременныеСНДС,
	|	ДД.ПостатейныеПеременныеБезНДС,
	|	ДД.ПостатейныеПеременныеУпр,
	|	ДД.ПостатейныеПеременныеРегл,
	|	ДД.ВременнаяРазница,
	|	ДД.СуммаВыручкиСНДСРегл,
	|	ДД.СуммаРучнойСкидки,
	|	ДД.СуммаАвтоматическойСкидки,
	// Реквизиты
	|	ДД.НалогообложениеНДС,
	|	ДД.ВалютаВзаиморасчетов,
	|	ДД.СуммаВВалютеВзаиморасчетов,
	|	ДД.СуммаБезНДСВВалютеВзаиморасчетов,
	|	ДД.ВалютаДокумента,
	|	ДД.СуммаВВалютеДокумента,
	|	ДД.СуммаБезНДСВВалютеДокумента,
	|	ДД.ИсточникГФУНоменклатуры,
	|	ДД.ДокументДвижения,
	|	ДД.РасчетСебестоимости,
	|	ДД.РасчетПартий,
	|	ДД.РасчетНеЗавершен,
	|	ДД.НДСРегл,
	|	ДД.НДСУпр,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.ИсточникГФУРасчетов,
	|	(ВЫБОР
	|		КОГДА &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|		 ИЛИ НЕ &ВыделятьОтклоненияСебестоимостиОкончательногоРасчета
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ДД.ДокументРасчета КОНЕЦ) КАК ДокументРасчета,
	|	(ВЫБОР
	|		КОГДА ДД.РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПустаяСсылка)
	|			ТОГДА &РежимЗакрытияМесяца
	|		ИНАЧЕ ДД.РежимЗакрытияМесяца КОНЕЦ) КАК РежимЗакрытияМесяца
	|
	|ПОМЕСТИТЬ ВтДвиженияВыручкаИСебестоимостьПродаж
	|ИЗ
	|	РегистрНакопления.ВыручкаИСебестоимостьПродаж КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.АналитикаУчетаПоПартнерам.Организация В(&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя, "СохранениеДвижений");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияВыручкаИСебестоимостьПродаж";

	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

#Область ПрочиеРасходы

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	// Ресурсы
	|	ДД.Сумма КАК Сумма,
	|	ДД.СуммаБезНДС КАК СуммаБезНДС,
	|	ДД.СуммаРегл КАК СуммаРегл,
	|	ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	ДД.СуммаНДД КАК СуммаНДД,
	|	ДД.СуммаУпр КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ДокументДвижения,
	|	ДД.ИдентификаторСтроки,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.Сторно,
	|	(ВЫБОР
	|		КОГДА &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|		 ИЛИ НЕ &ВыделятьОтклоненияСебестоимостиОкончательногоРасчета
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ДД.ДокументРасчета КОНЕЦ) КАК ДокументРасчета,
	|	(ВЫБОР
	|		КОГДА ДД.РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПустаяСсылка)
	|			ТОГДА &РежимЗакрытияМесяца
	|		ИНАЧЕ ДД.РежимЗакрытияМесяца КОНЕЦ) КАК РежимЗакрытияМесяца
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходы
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя, "СохранениеДвижений");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеРасходы";

	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

//++ НЕ УТ
#Область ПрочиеРасходыНезавершенногоПроизводства

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.СтатьяРасходов,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности,
	|	ДД.ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.СтатьяКалькуляции,
	|	ДД.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	// Ресурсы
	|	СУММА(ДД.Стоимость) КАК Стоимость,
	|	СУММА(ДД.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(ДД.СтоимостьРегл) КАК СтоимостьРегл,
	|	СУММА(ДД.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(ДД.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(ДД.СтоимостьНДД) КАК СтоимостьНДД,
	|	СУММА(ДД.ДоляСтоимости) КАК ДоляСтоимости,
	|	СУММА(ДД.СтоимостьУпр) КАК СтоимостьУпр,
	// Реквизиты
	|	ДД.Продукция,
	|	ДД.ХарактеристикаПродукции,
	|	ДД.КоличествоПродукции,
	|	ДД.АналитикаУчетаПродукции,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.ДокументДвижения,
	|	ДД.ДокументИсточник,
	|	ДД.ДокументВыпуска,
	|	ДД.РасчетСебестоимости,
	|	ДД.РасчетПартий,
	|	ДД.ПоказательОтнесенияНаПартию,
	|	ДД.ПоказательОтнесенияНаПартиюБезНДС,
	|	ДД.ПоказательОтнесенияНаПартиюРегл,
	|	ДД.ПоказательОтнесенияНаПартиюУпр,
	|	ДД.АналитикаПартииВыпуска,
	|	ДД.КорАналитикаУчетаПартий,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходыНЗП
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.СтатьяРасходов,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности,
	|	ДД.ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.Этап,
	|	ДД.СтатьяКалькуляции,
	|	ДД.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск,
	// Реквизиты
	|	ДД.Продукция,
	|	ДД.ХарактеристикаПродукции,
	|	ДД.КоличествоПродукции,
	|	ДД.АналитикаУчетаПродукции,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.ДокументДвижения,
	|	ДД.ДокументИсточник,
	|	ДД.ДокументВыпуска,
	|	ДД.РасчетСебестоимости,
	|	ДД.РасчетПартий,
	|	ДД.ПоказательОтнесенияНаПартию,
	|	ДД.ПоказательОтнесенияНаПартиюБезНДС,
	|	ДД.ПоказательОтнесенияНаПартиюРегл,
	|	ДД.ПоказательОтнесенияНаПартиюУпр,
	|	ДД.АналитикаПартииВыпуска,
	|	ДД.КорАналитикаУчетаПартий,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтПрочиеРасходыНЗПСохранениеДвижений";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеРасходыНЗП";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти
//-- НЕ УТ

#Область ПрочиеДоходы

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяДоходов,
	|	ДД.АналитикаДоходов,
	// Ресурсы
	|	ДД.Сумма КАК Сумма,
	|	ДД.СуммаРегл КАК СуммаРегл,
	|	ДД.СуммаУпр КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.Сторно,
	|	(ВЫБОР
	|		КОГДА &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|		 ИЛИ НЕ &ВыделятьОтклоненияСебестоимостиОкончательногоРасчета
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ДД.ДокументРасчета КОНЕЦ) КАК ДокументРасчета,
	|	(ВЫБОР
	|		КОГДА ДД.РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПустаяСсылка)
	|			ТОГДА &РежимЗакрытияМесяца
	|		ИНАЧЕ ДД.РежимЗакрытияМесяца КОНЕЦ) КАК РежимЗакрытияМесяца
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеДоходы
	|ИЗ
	|	РегистрНакопления.ПрочиеДоходы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеДоходы.Имя, "СохранениеДвижений");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеДоходы";

	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

#Область ПрочиеАктивыПассивы

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.Статья,
	|	ДД.Аналитика,
	// Ресурсы
	|	ДД.Сумма КАК Сумма,
	// Реквизиты
	|	ДД.ВидИсточника,
	|	ДД.Источник,
	|	ДД.Сторно
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеАктивыПассивы
	|ИЗ
	|	РегистрНакопления.ПрочиеАктивыПассивы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя, "СохранениеДвижений");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеАктивыПассивы";

	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

#Область ДвиженияНоменклатураДоходыРасходы

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.ХозяйственнаяОперация,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельностиНоменклатуры,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.Склад,
	|	ДД.ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.НаправлениеДеятельностиСтатьи,
	|	ДД.СтатьяДоходовРасходов,
	|	ДД.АналитикаДоходов,
	|	ДД.АналитикаРасходов,
	|	ДД.АналитикаАктивовПассивов,
	// Ресурсы
	|	ДД.Стоимость КАК Стоимость,
	|	ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	ДД.ДопРасходы КАК ДопРасходы,
	|	ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	ДД.Трудозатраты КАК Трудозатраты,
	|	ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница КАК ВременнаяРазница,
	// Реквизиты
	|	ДД.ИсточникГФУНоменклатуры,
	|	ИСТИНА КАК Сторно
	|ПОМЕСТИТЬ ВтДвиженияНоменклатураДоходыРасходы
	|ИЗ
	|	РегистрНакопления.ДвиженияНоменклатураДоходыРасходы КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя, "СохранениеДвижений");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияНоменклатураДоходыРасходы";

	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

#Область ДвиженияНоменклатураНоменклатура

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.ХозяйственнаяОперация,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.Склад,
	|	ДД.ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорСклад,
	|	ДД.КорТипЗапасов,
	|	ДД.КорВидЗапасов,
	// Ресурсы
	|	ДД.Стоимость КАК Стоимость,
	|	ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	ДД.ДопРасходы КАК ДопРасходы,
	|	ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	ДД.Трудозатраты КАК Трудозатраты,
	|	ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница КАК ВременнаяРазница,
	// Реквизиты
	|	ДД.ИсточникГФУНоменклатуры,
	|	ДД.КорИсточникГФУНоменклатуры,
	|	ДД.КорОрганизация,
	|	ДД.Сторно
	|ПОМЕСТИТЬ ВтДвиженияНоменклатураНоменклатура
	|ИЗ
	|	РегистрНакопления.ДвиженияНоменклатураНоменклатура КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.Активность
	|	И ДД.РасчетСебестоимости
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ДвиженияНоменклатураНоменклатура.Имя, "СохранениеДвижений");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияНоменклатураНоменклатура";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

//++ НЕ УТ

#Область ПроцедураЭтапа_СторноЗависшихПроизводственныхЗатрат

// Выполняет формирование сторно зависших производственных затрат. Зависшие производственные затраты могут возникать
// по партиям производства, по которым в текущем периоде выполнялось сторнирование выпуска или отнесения затрат,
// в том числе распределяемых.
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура СторноЗависшихПроизводственныхЗатрат(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СторноЗависшихПроизводственныхЗатрат");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	// Расходные движения из НЗП.
	Запрос.Текст = ТекстСторноЗависшихПроизводственныхЗатратРасход(ПараметрыРасчета);
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	// Добавим идентификаторы строк в расходные движения.
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя],
		"ВтДвиженияСебестоимости");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя],
		"ВтДвиженияПрочиеРасходыНезавершенногоПроизводства",
		"Организация, Подразделение, СтатьяРасходов, АналитикаРасходов, НаправлениеДеятельности,
		|ПартияПроизводства, СтатьяКалькуляции, ГруппаПродукции, ПравилоОтнесенияНаВыпуск");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства.Имя],
		"ВтДвиженияТрудозатратыНезавершенногоПроизводства",
		"ПартияПроизводства");
	
	// Приходные движения в прочие расходы с соответствием по идентификаторам строк
	Запрос.Текст = ТекстСторноЗависшихПроизводственныхЗатратПриход(ПараметрыРасчета);
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
#Область СписаниеСебестоимостьТоваров
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтСебестоимостьСторноДвижений";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияСебестоимости";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти
	
#Область СписаниеПрочиеРасходыНезавершенногоПроизводства

	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтПрочиеРасходыНезавершенногоПроизводстваСторноДвижений";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеРасходыНезавершенногоПроизводства";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти
	
#Область СписаниеТрудозатратыНезавершенногоПроизводства

	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтТрудозатратыНезавершенногоПроизводстваСторноДвижений";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияТрудозатратыНезавершенногоПроизводства";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти
	
#Область ОприходованиеПрочиеРасходы
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтПрочиеРасходыСторноДвижений";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеРасходы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

Функция ТекстСторноЗависшихПроизводственныхЗатратРасход(ПараметрыРасчета)
	
	ТекстЗапроса = "";
	
	#Область ИсправлениеСебестоимостьТоваров // ВтДвиженияСебестоимости

	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДополнениеРасчетПартий) КАК ТипЗаписи,
	|	&КонецПериода                          КАК Период,
	|	ДокументыРасчетаСебестоимости.Ссылка   КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	// Измерения
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	// Ресурсы
	|	ДД.Количество КАК Количество,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СтоимостьНДД,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК РезервПодОбесценениеРегл,
	|	0 КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	ДокументыРасчетаСебестоимости.Ссылка КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.СторноПроизводственныхЗатрат) КАК СтатьяРасходовСписания,
	|	ПартииПроизводства.Номенклатура КАК АналитикаРасходов,
	|	ПартииПроизводства.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	ДД.АналитикаУчетаНоменклатуры.Подразделение КАК Подразделение,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПроизводственныхЗатрат)        КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СторноПроизводственныхЗатрат) КАК НастройкаХозяйственнойОперации
	|ПОМЕСТИТЬ ВтДвиженияСебестоимости
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводстваСводно КАК ПартииПроизводства
	|	ПО ПартииПроизводства.ПартияПроизводства = ДД.Партия
	|	И ПартииПроизводства.Организация = ДД.Организация
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|	ПО ДокументыРасчетаСебестоимости.Организация = ДД.Организация
	|
	|ГДЕ
	|	НЕ ДД.Количество = 0
	|	И НЕ ПартииПроизводства.РаспределениеЗатратНаВыпуск
	|;";
	#КонецОбласти
	
	#Область ИсправлениеПрочиеРасходыНезавершенногоПроизводства
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	&КонецПериода                          КАК Период,
	|	ДокументыРасчетаСебестоимости.Ссылка   КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	// Измерения
	|	ДД.СтатьяРасходов                      КАК СтатьяРасходов,
	|	ДД.Организация                         КАК Организация,
	|	ДД.Подразделение                       КАК Подразделение,
	|	ДД.АналитикаРасходов                   КАК АналитикаРасходов,
	|	ДД.НаправлениеДеятельности             КАК НаправлениеДеятельности,
	|	ДД.ПартияПроизводства                  КАК ПартияПроизводства,
	|	ДД.СтатьяКалькуляции                   КАК СтатьяКалькуляции,
	|	ДД.ГруппаПродукции                     КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск            КАК ПравилоОтнесенияНаВыпуск,
	// Ресурсы
	|	ДД.ДоляСтоимости                      КАК ДоляСтоимости,
	|	ДД.Стоимость                          КАК Стоимость,
	|	ДД.СтоимостьБезНДС                    КАК СтоимостьБезНДС,
	|	ДД.СтоимостьРегл                      КАК СтоимостьРегл,
	|	ДД.ПостояннаяРазница                  КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница                   КАК ВременнаяРазница,
	|	ДД.СтоимостьНДД                       КАК СтоимостьНДД,
	|	ДД.СтоимостьУпр                       КАК СтоимостьУпр,
	// Реквизиты
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПроизводственныхЗатрат)        КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СторноПроизводственныхЗатрат) КАК НастройкаХозяйственнойОперации
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходыНезавершенногоПроизводства
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводстваСводно КАК ПартииПроизводства
	|	ПО ПартииПроизводства.ПартияПроизводства = ДД.ПартияПроизводства
	|	И ПартииПроизводства.Организация = ДД.Организация
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|	ПО ДокументыРасчетаСебестоимости.Организация = ДД.Организация
	|
	|ГДЕ
	|	(НЕ ДД.ДоляСтоимости = 0
	|		ИЛИ НЕ ДД.Стоимость = 0
	|		ИЛИ НЕ ДД.СтоимостьБезНДС = 0
	|		ИЛИ НЕ ДД.СтоимостьРегл = 0
	|		ИЛИ НЕ ДД.ПостояннаяРазница = 0
	|		ИЛИ НЕ ДД.ВременнаяРазница = 0
	|		ИЛИ НЕ ДД.СтоимостьНДД = 0
	|		ИЛИ НЕ ДД.СтоимостьУпр = 0)
	|	И НЕ ПартииПроизводства.РаспределениеЗатратНаВыпуск
	|;";
	#КонецОбласти
	
	#Область ИсправлениеТрудозатратыНезавершенногоПроизводства
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	&КонецПериода                          КАК Период,
	|	ДокументыРасчетаСебестоимости.Ссылка   КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	// Измерения
	|	ДД.Организация                         КАК Организация,
	|	ДД.Подразделение                       КАК Подразделение,
	|	ДД.ВидРабот                            КАК ВидРабот,
	|	ДД.ВидФондаВзносов                     КАК ВидФондаВзносов,
	|	ДД.ПартияПроизводства                  КАК ПартияПроизводства,
	|	ДД.СтатьяКалькуляции                   КАК СтатьяКалькуляции,
	|	ДД.ГруппаПродукции                     КАК ГруппаПродукции,
	// Ресурсы
	|	ДД.Количество                         КАК Количество,
	|	ДД.НормативнаяСтоимость               КАК НормативнаяСтоимость,
	|	ДД.Стоимость                          КАК Стоимость,
	|	ДД.СтоимостьРегл                      КАК СтоимостьРегл,
	|	ДД.ПостояннаяРазница                  КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница                   КАК ВременнаяРазница,
	|	ДД.СтоимостьНДД                       КАК СтоимостьНДД,
	// Реквизиты
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПроизводственныхЗатрат)        КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СторноПроизводственныхЗатрат) КАК НастройкаХозяйственнойОперации
	|ПОМЕСТИТЬ ВтДвиженияТрудозатратыНезавершенногоПроизводства
	|ИЗ
	|	ВТКэшРасчетныеОстаткиТрудозатратыНезавершенногоПроизводства КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииПроизводстваСводно КАК ПартииПроизводства
	|	ПО ПартииПроизводства.ПартияПроизводства = ДД.ПартияПроизводства
	|	И ПартииПроизводства.Организация = ДД.Организация
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|	ПО ДокументыРасчетаСебестоимости.Организация = ДД.Организация
	|
	|ГДЕ
	|	(НЕ ДД.Количество = 0
	|		ИЛИ НЕ ДД.НормативнаяСтоимость = 0
	|		ИЛИ НЕ ДД.Стоимость = 0
	|		ИЛИ НЕ ДД.СтоимостьРегл = 0
	|		ИЛИ НЕ ДД.ПостояннаяРазница = 0
	|		ИЛИ НЕ ДД.ВременнаяРазница = 0
	|		ИЛИ НЕ ДД.СтоимостьНДД = 0)
	|	И НЕ ПартииПроизводства.РаспределениеЗатратНаВыпуск
	|;";
	#КонецОбласти
	
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

Функция ТекстСторноЗависшихПроизводственныхЗатратПриход(ПараметрыРасчета)
	
	ТекстЗапроса = "";
	
	#Область ИсправлениеПрочиеРасходы
	
	ТекстЗапроса = ТекстЗапроса + "
	// Для получения исходных подразделений для прихода в прочие расходы выбираем кор. движения из прочих расходов.
	// Для этого подходят только документы распределения прочих затрат.
	// Документов распределения может быть несколько, как и исходных подразделений, поэтому выбираем только 1 подразделение.
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПрочиеРасходыНЗП.Регистратор              КАК Регистратор,
	|	ПрочиеРасходыНЗП.ПартияПроизводства       КАК ПартияПроизводства,
	|	ПрочиеРасходыНЗП.АналитикаРасходов        КАК АналитикаРасходов,
	|	ПрочиеРасходыНЗП.СтатьяРасходов           КАК СтатьяРасходов,
	|	ПрочиеРасходыНЗП.НаправлениеДеятельности  КАК НаправлениеДеятельности,
	|	ПрочиеРасходыНЗП.ГруппаПродукции          КАК ГруппаПродукции,
	|	ПрочиеРасходыНЗП.СтатьяКалькуляции        КАК СтатьяКалькуляции,
	|	ПрочиеРасходыНЗП.Организация              КАК Организация,
	|	ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|	ПрочиеРасходыНЗП.Подразделение            КАК Подразделение
	|	
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходыНЗПИсправленийПроизводстваБезЗаказа
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК ПрочиеРасходыНЗП
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтДвиженияПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	ПО ПрочиеРасходыНЗП.Организация = ДД.Организация
	|	И ПрочиеРасходыНЗП.Подразделение = ДД.Подразделение
	|	И ПрочиеРасходыНЗП.СтатьяРасходов = ДД.СтатьяРасходов
	|	И ПрочиеРасходыНЗП.АналитикаРасходов = ДД.АналитикаРасходов
	|	И ПрочиеРасходыНЗП.НаправлениеДеятельности = ДД.НаправлениеДеятельности
	|	И ПрочиеРасходыНЗП.ПартияПроизводства = ДД.ПартияПроизводства
	|	И ПрочиеРасходыНЗП.СтатьяКалькуляции = ДД.СтатьяКалькуляции
	|	И ПрочиеРасходыНЗП.ГруппаПродукции = ДД.ГруппаПродукции
	|	И ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск = ДД.ПравилоОтнесенияНаВыпуск
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК ПартииПроизводства
	|	ПО ПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПроизводствоБезЗаказа КАК РеквизитыПбЗ
	|	ПО РеквизитыПбЗ.Ссылка = ПартииПроизводства.Документ
	|
	|ГДЕ
	|	ПрочиеРасходыНЗП.Период < &НачалоПериода
	|	И ПрочиеРасходыНЗП.Активность
	|	И ПрочиеРасходыНЗП.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ТИПЗНАЧЕНИЯ(ПрочиеРасходыНЗП.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|	И НЕ (&ИспользовалсяПартионныйУчетДоПереходаНаВерсию22 = ИСТИНА // значение параметра может быть НЕОПРЕДЕЛЕНО
	|		И ПрочиеРасходыНЗП.Период < &ДатаПереходаНаПартионныйУчетВерсии22)
	// Для старых цепочек исправлений сохраняем списание на "Сторно производственных затрат",
	// поэтому перечень исходных статей формируется только для новых цепочек.
	|	И ЕСТЬNULL(РеквизитыПбЗ.ИсправлениеСохраняетПартииПроизводства, ИСТИНА)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПрочиеРасходыНЗП.ПартияПроизводства                КАК ПартияПроизводства,
	|	ПрочиеРасходыНЗП.АналитикаРасходов                 КАК АналитикаРасходов,
	|	ПрочиеРасходыНЗП.СтатьяРасходов                    КАК СтатьяРасходов,
	|	ПрочиеРасходыНЗП.Подразделение                     КАК Подразделение,
	|	ПрочиеРасходыНЗП.НаправлениеДеятельности           КАК НаправлениеДеятельности,
	|	ПрочиеРасходыНЗП.СтатьяКалькуляции                 КАК СтатьяКалькуляции,
	|	ПрочиеРасходыНЗП.Организация                       КАК Организация,
	|	ПрочиеРасходыНЗП.ГруппаПродукции                   КАК ГруппаПродукции,
	|	ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск          КАК ПравилоОтнесенияНаВыпуск,
	|	МАКСИМУМ(КорПрочиеРасходы.Подразделение)           КАК ИсходноеПодразделение,
	|	МАКСИМУМ(КорПрочиеРасходы.НаправлениеДеятельности) КАК ИсходноеНаправлениеДеятельности
	|ПОМЕСТИТЬ ИсходныеПодразделенияИсправленийПроизводстваБезЗаказовПоПрочимРасходамНЗП
	|ИЗ
	|	ВтДвиженияПрочиеРасходыНЗПИсправленийПроизводстваБезЗаказа КАК ПрочиеРасходыНЗП
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ПрочиеРасходы КАК КорПрочиеРасходы
	|	ПО ПрочиеРасходыНЗП.Регистратор = КорПрочиеРасходы.Регистратор
	|
	|СГРУППИРОВАТЬ ПО
	|	ПрочиеРасходыНЗП.СтатьяРасходов,
	|	ПрочиеРасходыНЗП.Подразделение,
	|	ПрочиеРасходыНЗП.Организация,
	|	ПрочиеРасходыНЗП.АналитикаРасходов,
	|	ПрочиеРасходыНЗП.НаправлениеДеятельности,
	|	ПрочиеРасходыНЗП.ПартияПроизводства,
	|	ПрочиеРасходыНЗП.СтатьяКалькуляции,
	|	ПрочиеРасходыНЗП.ГруппаПродукции,
	|	ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПартияПроизводства,
	|	АналитикаРасходов,
	|	СтатьяРасходов,
	|	Подразделение,
	|	НаправлениеДеятельности,
	|	СтатьяКалькуляции,
	|	Организация,
	|	ГруппаПродукции,
	|	ПравилоОтнесенияНаВыпуск
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	// Отнесение стоимости пономенклатурных затрат на прочие расходы (при сторнировании производства без заказов)
	|ВЫБРАТЬ
	|	ДД.Период                                      КАК Период,
	|	ДД.Регистратор                                 КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)         КАК ВидДвижения,
	// Измерения
	|	ДД.Организация                                 КАК Организация,
	|	ДД.Подразделение                               КАК Подразделение,
	|	ДД.КорНаправлениеДеятельности                  КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходовСписания                      КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                           КАК АналитикаРасходов,
	// Ресурсы
	|	(ДД.Стоимость
	|		+ ДД.ДопРасходы
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеСНДС
	|		+ ДД.ПостатейныеПеременныеСНДС)            КАК Сумма,
	|	(ДД.СтоимостьБезНДС
	|		+ ДД.ДопРасходыБезНДС
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеБезНДС
	|		+ ДД.ПостатейныеПеременныеБезНДС)          КАК СуммаБезНДС,
	|	(ДД.СтоимостьРегл
	|		+ ДД.ДопРасходыРегл
	|		+ ДД.ТрудозатратыРегл
	|		+ ДД.ПостатейныеПостоянныеРегл
	|		+ ДД.ПостатейныеПеременныеРегл
	|		+ ДД.РезервПодОбесценениеРегл)             КАК СуммаРегл,
	|	ДД.ПостояннаяРазница                          КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница                           КАК ВременнаяРазница,
	|	ДД.СтоимостьНДД                               КАК СуммаНДД,
	|	(ДД.СтоимостьУпр
	|		+ ДД.ДопРасходыРегл
	|		+ ДД.ДопРасходыУпр
	|		+ ДД.ПостатейныеПостоянныеУпр
	|		+ ДД.ПостатейныеПеременныеУпр
	|		+ ДД.РезервПодОбесценениеУпр)              КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация                       КАК ХозяйственнаяОперация,
	|	ДД.АналитикаУчетаНоменклатуры                  КАК АналитикаУчетаНоменклатуры,
	|	ДД.ДокументДвижения                            КАК ДокументДвижения,
	|	ДД.НастройкаХозяйственнойОперации              КАК НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи                      КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходы
	|ИЗ
	|	ВтДвиженияСебестоимости КАК ДД
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Отнесение стоимости постатейных затрат на прочие расходы (при сторнировании производства без заказов)
	|ВЫБРАТЬ
	|	ДД.Период                         КАК Период,
	|	ДД.Регистратор                    КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Измерения
	|	ДД.Организация                    КАК Организация,
	|	ЕСТЬNULL(ИсходныеДанныеПостатейныхЗатрат.ИсходноеПодразделение, ДД.Подразделение) КАК Подразделение,
	|	ЕСТЬNULL(ИсходныеДанныеПостатейныхЗатрат.ИсходноеНаправлениеДеятельности, ДД.НаправлениеДеятельности) КАК НаправлениеДеятельности,
	|	ЕСТЬNULL(ИсходныеДанныеПостатейныхЗатрат.СтатьяРасходов, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.СторноПроизводственныхЗатрат)) КАК СтатьяРасходов,
	|	ЕСТЬNULL(ИсходныеДанныеПостатейныхЗатрат.АналитикаРасходов, ПартииПроизводства.ОсновноеИзделиеНоменклатура) КАК АналитикаРасходов,
	// Ресурсы
	|	ДД.Стоимость                      КАК Сумма,
	|	ДД.СтоимостьБезНДС                КАК СуммаБезНДС,
	|	ДД.СтоимостьРегл                  КАК СуммаРегл,
	|	ДД.ПостояннаяРазница              КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница               КАК ВременнаяРазница,
	|	ДД.СтоимостьНДД                   КАК СуммаНДД,
	|	ДД.СтоимостьУпр                   КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация          КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                      КАК АналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                      КАК ДокументДвижения,
	|	ДД.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи         КАК ИдентификаторФинЗаписи
	|ИЗ
	|	ВтДвиженияПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсходныеПодразделенияИсправленийПроизводстваБезЗаказовПоПрочимРасходамНЗП КАК ИсходныеДанныеПостатейныхЗатрат
	|	ПО ИсходныеДанныеПостатейныхЗатрат.Организация = ДД.Организация
	|		И ИсходныеДанныеПостатейныхЗатрат.Подразделение = ДД.Подразделение
	|		И ИсходныеДанныеПостатейныхЗатрат.СтатьяРасходов = ДД.СтатьяРасходов
	|		И ИсходныеДанныеПостатейныхЗатрат.АналитикаРасходов = ДД.АналитикаРасходов
	|		И ИсходныеДанныеПостатейныхЗатрат.НаправлениеДеятельности = ДД.НаправлениеДеятельности
	|		И ИсходныеДанныеПостатейныхЗатрат.ПартияПроизводства = ДД.ПартияПроизводства
	|		И ИсходныеДанныеПостатейныхЗатрат.СтатьяКалькуляции = ДД.СтатьяКалькуляции
	|		И ИсходныеДанныеПостатейныхЗатрат.ГруппаПродукции = ДД.ГруппаПродукции
	|		И ИсходныеДанныеПостатейныхЗатрат.ПравилоОтнесенияНаВыпуск = ДД.ПравилоОтнесенияНаВыпуск
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК ПартииПроизводства
	|	ПО ПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Отнесение стоимости трудозатрат на прочие расходы (при сторнировании производства без заказов)
	|ВЫБРАТЬ
	|	ДД.Период                                      КАК Период,
	|	ДД.Регистратор                                 КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)         КАК ВидДвижения,
	// Измерения
	|	ДД.Организация                                 КАК Организация,
	|	ДД.Подразделение                               КАК Подразделение,
	|	ПартииПроизводства.НаправлениеДеятельности     КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.СторноПроизводственныхЗатрат) КАК СтатьяРасходов,
	|	ПартииПроизводства.ОсновноеИзделиеНоменклатура КАК АналитикаРасходов,
	// Ресурсы
	|	ДД.Стоимость                                  КАК Сумма,
	|	ДД.Стоимость                                  КАК СуммаБезНДС,
	|	ДД.СтоимостьРегл                              КАК СуммаРегл,
	|	ДД.ПостояннаяРазница                          КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница                           КАК ВременнаяРазница,
	|	ДД.СтоимостьНДД                               КАК СуммаНДД,
	|	ДД.Стоимость                                  КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация                       КАК ХозяйственнаяОперация,
	|	НЕОПРЕДЕЛЕНО                                   КАК АналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО                                   КАК ДокументДвижения,
	|	ДД.НастройкаХозяйственнойОперации              КАК НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи                      КАК ИдентификаторФинЗаписи
	|ИЗ
	|	ВтДвиженияТрудозатратыНезавершенногоПроизводства КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ПартииПроизводства КАК ПартииПроизводства
	|	ПО ПартииПроизводства.Ссылка = ДД.ПартияПроизводства
	|;";
	#КонецОбласти
	
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

#КонецОбласти

// Этап 3.4
// Формирует временные таблицы ВтНезавершенноеПроизводство
//
Процедура РаспределитьПрочиеРасходыНезавершенногоПроизводства(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределитьПрочиеРасходыНезавершенногоПроизводства");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Если ПараметрыРасчета.ПредварительныйРасчет Тогда
		
		Запрос.Текст =
			"ВЫБРАТЬ ПЕРВЫЕ 0
			|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)				КАК Организация,
			|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) КАК РазделУчета,
			|	ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)		КАК Партия,
			|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)	КАК ВидДеятельностиНДС,
			|	НЕОПРЕДЕЛЕНО												КАК АналитикаУчетаПартий,
			|	0															КАК КодСтрокиПродукция,
			|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)	КАК НаправлениеДеятельности,
			|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
			|	НЕОПРЕДЕЛЕНО												КАК АналитикаРасходов,
			|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)		КАК Подразделение,
			|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)			КАК СтатьяКалькуляции,
			|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка)			КАК Этап,
			|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
			|	ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка) КАК ПравилоОтнесенияНаВыпуск,
			
			|	0 КАК Количество,
			|	0 КАК КоличествоБезНДС,
			|	0 КАК КоличествоРегл,
			|	0 КАК КоличествоНУ,
			|	0 КАК КоличествоУпр,
			
			|	0 КАК Сумма,
			|	0 КАК СуммаБезНДС,
			|	0 КАК СуммаУпр,
			|	0 КАК СуммаРегл,
			|	0 КАК СуммаНУ,
			|	0 КАК ПостояннаяРазница,
			|	0 КАК ВременнаяРазница,
			|	0 КАК СтоимостьНДД
			|
			|ПОМЕСТИТЬ ВтНезавершенноеПроизводство
			|;
			|
			|ВЫБРАТЬ ПЕРВЫЕ 0
			|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)				КАК Организация,
			|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)	КАК НаправлениеДеятельности,
			|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
			|	НЕОПРЕДЕЛЕНО												КАК АналитикаРасходов,
			|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)		КАК Подразделение,
			|	0 КАК СуммаРегл,
			|	0 КАК СуммаУпр,
			|	0 КАК СтоимостьНДД
			|ПОМЕСТИТЬ ПокрываемыеРезервамиСтатьиРасходов";
		
		Запрос.Выполнить();
		
		Возврат;
		
	КонецЕсли;
	
	//++ Локализация
	Если НЕ РасчетСебестоимостиПрикладныеАлгоритмы.ВременнаяТаблицаСуществует(ПараметрыРасчета, "ВТСписаниеПостатейныхЗатрат") Тогда
		
		Запрос.Текст = РасчетСебестоимостиНДС.ТекстОписаниеДанныхДляРаспределениеПартийНДСФИФОСкользящаяПоПартиямПрочихРасходов();
		Запрос.Текст = РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПриемникЗапросаОписанияДанных(Запрос.Текст, "ВТСписаниеПостатейныхЗатрат");
		
		Запрос.Выполнить();
		
	КонецЕсли;
	//-- Локализация
	
	Запрос.Текст = ТекстВтНезавершенноеПроизводство(ПараметрыРасчета);
	Запрос.Текст = УстановитьРазрядностьЧиселВТекстеЗапроса(ПараметрыРасчета, Запрос.Текст);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина, "ВтНезавершенноеПроизводство");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ДолиСписанияКосвенныхРасходов, ПрочиеРасходыНезавершенногоПроизводстваОстатки, 
		|ПокрываемыеРезервамиСтатьиРасходовПредварительная, СуммыРасходов, ВтОстаткиНезавершенногоПроизводства, ВтРаспределениеНаПартии");
	
КонецПроцедуры

Функция ТекстВтНезавершенноеПроизводство(ПараметрыРасчета = Неопределено) Экспорт
	
	ТекстыЗапросов = Новый Массив;
	
	#Область ПрочиеРасходыНезавершенногоПроизводстваОстатки
	ТекстЗапросаВтРаспределениеНаПартии = "
	|ВЫБРАТЬ
	|	ДД.Организация                                   КАК Организация,
	|	ДД.ПартияПроизводства                            КАК ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство                           КАК ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция                            КАК КодСтрокиПродукция,
	|	ДД.НаправлениеДеятельности                       КАК НаправлениеДеятельности,
	|	ДД.Подразделение                                 КАК Подразделение,
	|	ДД.СтатьяРасходов                                КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                             КАК АналитикаРасходов,
	|	ДД.СтатьяКалькуляции                             КАК СтатьяКалькуляции,
	|	ДД.Этап                                			 КАК Этап,
	|	ДД.ГруппаПродукции                               КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                      КАК ПравилоОтнесенияНаВыпуск,
	|	СУММА(ДД.СтоимостьОстаток)                       КАК СтоимостьОстаток,
	|	СУММА(ДД.СтоимостьБезНДСОстаток)                 КАК СтоимостьБезНДСОстаток,
	|	СУММА(ДД.СтоимостьУпрОстаток)                    КАК СтоимостьУпрОстаток,
	|	СУММА(ДД.СтоимостьРеглОстаток)                   КАК СтоимостьРеглОстаток,
	|	СУММА(ДД.ПостояннаяРазницаОстаток)               КАК ПостояннаяРазницаОстаток,
	|	СУММА(ДД.ВременнаяРазницаОстаток)                КАК ВременнаяРазницаОстаток,
	|	СУММА(ДД.ДоляСтоимостиОстаток)                   КАК ДоляСтоимостиОстаток,
	|	СУММА(ДД.СтоимостьНДДОстаток)					 КАК СтоимостьНДДОстаток
	|ПОМЕСТИТЬ ПрочиеРасходыНезавершенногоПроизводстваОстатки
	|ИЗ (
	|	ВЫБРАТЬ
	|		ДД.Организация                                   КАК Организация,
	|		ДД.ПартияПроизводства                            КАК ПартияПроизводства,
	|		ДД.ЗаказНаПроизводство                           КАК ЗаказНаПроизводство,
	|		ДД.КодСтрокиПродукция                            КАК КодСтрокиПродукция,
	|		ДД.НаправлениеДеятельности                       КАК НаправлениеДеятельности,
	|		ДД.Подразделение                                 КАК Подразделение,
	|		ДД.СтатьяРасходов                                КАК СтатьяРасходов,
	|		ДД.АналитикаРасходов                             КАК АналитикаРасходов,
	|		ДД.СтатьяКалькуляции                             КАК СтатьяКалькуляции,
	|		ДД.Этап                                			 КАК Этап,
	|		ДД.ГруппаПродукции                               КАК ГруппаПродукции,
	|		ДД.ПравилоОтнесенияНаВыпуск                      КАК ПравилоОтнесенияНаВыпуск,
	|		ДД.СтоимостьОстаток                              КАК СтоимостьОстаток,
	|		ДД.СтоимостьБезНДСОстаток                        КАК СтоимостьБезНДСОстаток,
	|		ДД.СтоимостьУпрОстаток                           КАК СтоимостьУпрОстаток,
	|		ДД.СтоимостьРеглОстаток                          КАК СтоимостьРеглОстаток,
	|		ДД.ПостояннаяРазницаОстаток                      КАК ПостояннаяРазницаОстаток,
	|		ДД.ВременнаяРазницаОстаток                       КАК ВременнаяРазницаОстаток,
	|		ДД.ДоляСтоимостиОстаток                          КАК ДоляСтоимостиОстаток,
	|		ДД.СтоимостьНДДОстаток							 КАК СтоимостьНДДОстаток
	|	ИЗ
	|		РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства.Остатки(&НачалоПериода,
	|			Организация В (&МассивОрганизаций) И &ПартионныйУчетВерсии22) КАК ДД
	|
	//++ НЕ УТКА
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ДД.Организация                                   КАК Организация,
	|		ДД.ПартияПроизводства                            КАК ПартияПроизводства,
	|		ДД.ЗаказНаПроизводство                           КАК ЗаказНаПроизводство,
	|		ДД.КодСтрокиПродукция                            КАК КодСтрокиПродукция,
	|		ДД.НаправлениеДеятельности                       КАК НаправлениеДеятельности,
	|		ДД.Подразделение                                 КАК Подразделение,
	|		ДД.СтатьяРасходов                                КАК СтатьяРасходов,
	|		ДД.АналитикаРасходов                             КАК АналитикаРасходов,
	|		ДД.СтатьяКалькуляции                             КАК СтатьяКалькуляции,
	|		ДД.Этап                                			 КАК Этап,
	|		ДД.ГруппаПродукции                               КАК ГруппаПродукции,
	|		ДД.ПравилоОтнесенияНаВыпуск                      КАК ПравилоОтнесенияНаВыпуск,
	|		ДД.Стоимость                                     КАК СтоимостьОстаток,
	|		ДД.СтоимостьБезНДС                               КАК СтоимостьБезНДСОстаток,
	|		ДД.СтоимостьУпр                                  КАК СтоимостьУпрОстаток,
	|		ДД.СтоимостьРегл                                 КАК СтоимостьРеглОстаток,
	|		ДД.ПостояннаяРазница                             КАК ПостояннаяРазницаОстаток,
	|		ДД.ВременнаяРазница                              КАК ВременнаяРазницаОстаток,
	|		ДД.ДоляСтоимости                                 КАК ДоляСтоимостиОстаток,
	|		ДД.СтоимостьНДД									 КАК СтоимостьНДДОстаток
	|	ИЗ
	|		ВТКэшРасчетныеОборотыПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.НачальныеОстаткиНЗППоПартиямПроизводства КАК НачальныеОстатки
	|			ПО НачальныеОстатки.Ссылка = ДД.Регистратор
	//-- НЕ УТКА
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	// Данные по сторно распределения прочих расходов НЗП.
	|	ВЫБРАТЬ
	|		ДД.Организация                                   КАК Организация,
	|		ДД.ПартияПроизводства                            КАК ПартияПроизводства,
	|		ДД.ЗаказНаПроизводство                           КАК ЗаказНаПроизводство,
	|		ДД.КодСтрокиПродукция                            КАК КодСтрокиПродукция,
	|		ДД.НаправлениеДеятельности                       КАК НаправлениеДеятельности,
	|		ДД.Подразделение                                 КАК Подразделение,
	|		ДД.СтатьяРасходов                                КАК СтатьяРасходов,
	|		ДД.АналитикаРасходов                             КАК АналитикаРасходов,
	|		ДД.СтатьяКалькуляции                             КАК СтатьяКалькуляции,
	|		ДД.Этап                                          КАК Этап,
	|		ДД.ГруппаПродукции                               КАК ГруппаПродукции,
	|		ДД.ПравилоОтнесенияНаВыпуск                      КАК ПравилоОтнесенияНаВыпуск,
	// Сторно выполнено отрицательным расходом, поэтому меняем знак.
	|		-ДД.Стоимость                                    КАК СтоимостьОстаток,
	|		-ДД.СтоимостьБезНДС                              КАК СтоимостьБезНДСОстаток,
	|		-ДД.СтоимостьУпр                                 КАК СтоимостьУпрОстаток,
	|		-ДД.СтоимостьРегл                                КАК СтоимостьРеглОстаток,
	|		-ДД.ПостояннаяРазница                            КАК ПостояннаяРазницаОстаток,
	|		-ДД.ВременнаяРазница                             КАК ВременнаяРазницаОстаток,
	|		-ДД.ДоляСтоимости                                КАК ДоляСтоимостиОстаток,
	|		-ДД.СтоимостьНДД								 КАК СтоимостьНДДОстаток
	|	ИЗ
	|		ВТКэшРасчетныеОборотыПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	ГДЕ
	|		ДД.Сторно
	|		И НЕ ДД.СлужебноеВидДвиженияПриход
	|		И &ПартионныйУчетВерсии22
	|		И &РежимЗакрытияМесяца <> ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|	) КАК ДД
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.ПартияПроизводства,
	|	ДД.ЗаказНаПроизводство,
	|	ДД.КодСтрокиПродукция,
	|	ДД.НаправлениеДеятельности,
	|	ДД.Подразделение,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.Этап,
	|	ДД.СтатьяКалькуляции,
	|	ДД.ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ПартияПроизводства,
	|	ЗаказНаПроизводство,
	|	КодСтрокиПродукция,
	|	НаправлениеДеятельности,
	|	Подразделение,
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Этап,
	|	СтатьяКалькуляции,
	|	ГруппаПродукции,
	|	ПравилоОтнесенияНаВыпуск
	|;";
	#КонецОбласти
	
	#Область ВтОстаткиНезавершенногоПроизводства
	ТекстЗапросаВтРаспределениеНаПартии = ТекстЗапросаВтРаспределениеНаПартии + "
	|ВЫБРАТЬ
	|	ДД.Организация                                   КАК Организация,
	|	ДД.Подразделение                                 КАК Подразделение,
	|	ДД.НаправлениеДеятельности                       КАК НаправлениеДеятельности,
	|	ДД.ДокументВыпуска                               КАК Партия,
	|	ДД.АналитикаПартииВыпуска                        КАК АналитикаУчетаПартий,
	|	ДД.КодСтрокиПродукция                            КАК КодСтрокиПродукция,
	|	ДД.СтатьяРасходов                                КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                             КАК АналитикаРасходов,
	|	ДД.СтатьяКалькуляции                             КАК СтатьяКалькуляции,
	|	ДД.Этап                                			 КАК Этап,
	|	ДД.ГруппаПродукции                               КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                      КАК ПравилоОтнесенияНаВыпуск,
	|	ЕСТЬNULL(ОстаткиНЗП.СтоимостьОстаток, 0)            КАК Стоимость,
	|	ЕСТЬNULL(ОстаткиНЗП.СтоимостьБезНДСОстаток, 0)      КАК СтоимостьБезНДС,
	|	ЕСТЬNULL(ОстаткиНЗП.СтоимостьУпрОстаток, 0)         КАК СтоимостьУпр,
	|	ЕСТЬNULL(ОстаткиНЗП.СтоимостьРеглОстаток, 0)        КАК СтоимостьРегл,
	|	ЕСТЬNULL(ОстаткиНЗП.ПостояннаяРазницаОстаток, 0)    КАК ПостояннаяРазница,
	|	ЕСТЬNULL(ОстаткиНЗП.ВременнаяРазницаОстаток, 0)     КАК ВременнаяРазница,
	|	ЕСТЬNULL(ОстаткиНЗП.ДоляСтоимостиОстаток, 0)        КАК ДоляСтоимости,
	|	ВЫРАЗИТЬ((ЕСТЬNULL(Материальные.Остаток, 0) + ЕСТЬNULL(Трудозатраты.Остаток, 0) + ЕСТЬNULL(Продукция.Остаток, 0) + ЕСТЬNULL(Продукция21.Остаток, 0)) / ЕСТЬNULL(Коэффициенты.Коэффициент, 1) КАК ЧИСЛО (23, 10)) КАК ПоказательОтнесенияНаВыпуск,
	|	ВЫРАЗИТЬ((ЕСТЬNULL(Материальные.ОстатокБезНДС, 0) + ЕСТЬNULL(Трудозатраты.ОстатокБезНДС, 0) + ЕСТЬNULL(Продукция.ОстатокБезНДС, 0) + ЕСТЬNULL(Продукция21.ОстатокБезНДС, 0)) / ЕСТЬNULL(Коэффициенты.КоэффициентБезНДС, 1) КАК ЧИСЛО (23, 10)) КАК ПоказательОтнесенияНаВыпускБезНДС,
	|	ВЫРАЗИТЬ((ЕСТЬNULL(Материальные.ОстатокРегл, 0) + ЕСТЬNULL(Трудозатраты.ОстатокРегл, 0) + ЕСТЬNULL(Продукция.ОстатокРегл, 0) + ЕСТЬNULL(Продукция21.ОстатокРегл, 0)) / ЕСТЬNULL(Коэффициенты.КоэффициентРегл, 1) КАК ЧИСЛО (23, 10)) КАК ПоказательОтнесенияНаВыпускРегл,
	|	ВЫРАЗИТЬ((ЕСТЬNULL(Материальные.ОстатокУпр, 0) + ЕСТЬNULL(Трудозатраты.ОстатокУпр, 0) + ЕСТЬNULL(Продукция.ОстатокУпр, 0) + ЕСТЬNULL(Продукция21.ОстатокУпр, 0)) / ЕСТЬNULL(Коэффициенты.КоэффициентУпр, 1) КАК ЧИСЛО (23, 10)) КАК ПоказательОтнесенияНаВыпускУпр,
	|	ЕСТЬNULL(ОстаткиНЗП.СтоимостьНДДОстаток, 0) КАК СтоимостьНДД
	|ПОМЕСТИТЬ ВтОстаткиНезавершенногоПроизводства
	|ИЗ
	|	ПартииДляОтнесенияРасходов КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПрочиеРасходыНезавершенногоПроизводстваОстатки КАК ОстаткиНЗП
	|		ПО ДД.Организация = ОстаткиНЗП.Организация
	|		И ДД.Подразделение = ОстаткиНЗП.Подразделение
	|		И ДД.ПартияПроизводства = ОстаткиНЗП.ПартияПроизводства
	|		И ДД.ЗаказНаПроизводство = ОстаткиНЗП.ЗаказНаПроизводство
	|		И ДД.КодСтрокиПродукция = ОстаткиНЗП.КодСтрокиПродукция
	|		И ДД.НаправлениеДеятельности = ОстаткиНЗП.НаправлениеДеятельности
	|		И ДД.СтатьяКалькуляции = ОстаткиНЗП.СтатьяКалькуляции
	|		И ДД.СтатьяРасходов = ОстаткиНЗП.СтатьяРасходов
	|		И ДД.АналитикаРасходов = ОстаткиНЗП.АналитикаРасходов
	|		И ДД.Этап = ОстаткиНЗП.Этап
	|		И ДД.ГруппаПродукции = ОстаткиНЗП.ГруппаПродукции
	|		И ДД.ПравилоОтнесенияНаВыпуск = ОстаткиНЗП.ПравилоОтнесенияНаВыпуск
	|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиБазРаспределения КАК Материальные
	|		ПО ДД.Организация = Материальные.Организация
	|			И ДД.Подразделение = Материальные.Подразделение
	|			И ДД.ПартияПроизводства = Материальные.ПартияПроизводства
	|			И ДД.ЗаказНаПроизводство = Материальные.ЗаказНаПроизводство
	|			И ДД.КодСтрокиПродукция = Материальные.КодСтрокиПродукция
	|			И (ВЫБОР
	|				КОГДА ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымЗатратам)
	|						ИЛИ ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымИТрудозатратам)
	|					ТОГДА Материальные.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымЗатратам)
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиБазРаспределения КАК Трудозатраты
	|		ПО ДД.Организация = Трудозатраты.Организация
	|			И ДД.Подразделение = Трудозатраты.Подразделение
	|			И ДД.ПартияПроизводства = Трудозатраты.ПартияПроизводства
	|			И ДД.ЗаказНаПроизводство = Трудозатраты.ЗаказНаПроизводство
	|			И ДД.КодСтрокиПродукция = Трудозатраты.КодСтрокиПродукция
	|			И (ВЫБОР
	|				КОГДА ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоТрудозатратам)
	|						ИЛИ ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымИТрудозатратам)
	|					ТОГДА Трудозатраты.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоТрудозатратам)
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиБазРаспределения КАК Продукция
	|		ПО ДД.Организация = Продукция.Организация
	|			И Продукция.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|			И ДД.ПартияПроизводства = Продукция.ПартияПроизводства
	|			И ДД.ЗаказНаПроизводство = Продукция.ЗаказНаПроизводство
	|			И ДД.КодСтрокиПродукция = Продукция.КодСтрокиПродукция
	|			И (ВЫБОР
	|				КОГДА ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоПродукцииСУчетомБудущихВыпусков)
	|					ТОГДА Продукция.ПравилоОтнесенияНаВыпуск = ДД.ПравилоОтнесенияНаВыпуск
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиБазРаспределения КАК Продукция21
	|		ПО ДД.Организация = Продукция21.Организация
	|			И Продукция21.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|			И ДД.ПартияПроизводства = Продукция21.ПартияПроизводства
	|			И ДД.ЗаказНаПроизводство = Продукция21.ЗаказНаПроизводство
	|			И ДД.КодСтрокиПродукция = Продукция21.КодСтрокиПродукция
	|			И (ВЫБОР
	|				КОГДА ДД.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка)
	|					ТОГДА Продукция21.ПравилоОтнесенияНаВыпуск = ДД.ПравилоОтнесенияНаВыпуск
	|				ИНАЧЕ ЛОЖЬ
	|			КОНЕЦ)
	|	ЛЕВОЕ СОЕДИНЕНИЕ КоэффициентыПриведения КАК Коэффициенты
	|		ПО Коэффициенты.Организация = ДД.Организация
	|		И Коэффициенты.ПартияПроизводства = ДД.ПартияПроизводства
	|		И Коэффициенты.ЗаказНаПроизводство = ДД.ЗаказНаПроизводство
	|		И Коэффициенты.ПравилоОтнесенияНаВыпуск = ДД.ПравилоОтнесенияНаВыпуск
	|ГДЕ
	|	ДД.Организация В (&МассивОрганизаций)
	|	И (ЕСТЬNULL(ОстаткиНЗП.СтоимостьОстаток,0) <> 0
	|	ИЛИ ЕСТЬNULL(ОстаткиНЗП.СтоимостьБезНДСОстаток,0) <> 0
	|	ИЛИ ЕСТЬNULL(ОстаткиНЗП.СтоимостьРеглОстаток,0) <> 0
	|	ИЛИ ЕСТЬNULL(ОстаткиНЗП.ПостояннаяРазницаОстаток,0) <> 0
	|	ИЛИ ЕСТЬNULL(ОстаткиНЗП.ВременнаяРазницаОстаток,0) <> 0
	|	ИЛИ ЕСТЬNULL(ОстаткиНЗП.СтоимостьУпрОстаток,0) <> 0
	|	ИЛИ ЕСТЬNULL(ОстаткиНЗП.СтоимостьНДДОстаток,0) <> 0
	|	ИЛИ (ЕСТЬNULL(Материальные.Остаток, 0) + ЕСТЬNULL(Трудозатраты.Остаток, 0) + ЕСТЬNULL(Продукция.Остаток, 0)) <> 0)
	|;";
	#КонецОбласти
	
	#Область РезервыПоРасходам
	ТекстЗапросаВтРаспределениеНаПартии = ТекстЗапросаВтРаспределениеНаПартии + "
	|ВЫБРАТЬ
	|	ДД.Организация,
	|	ДД.НаправлениеДеятельности,
	|	ДД.ВидРезервов,
	|	ДД.ОбъектУчетаРезервов,
	|	СуммыРасходов.СтатьяРасходов,
	|	СуммыРасходов.АналитикаРасходов,
	|	СуммыРасходов.Подразделение,
	|	МАКСИМУМ(-ДД.СуммаРегл) КАК РезервРегл,
	|	МАКСИМУМ(-ДД.СуммаНУ) КАК РезервНУ,
	|	МАКСИМУМ(-ДД.СуммаУпр) КАК РезервУпр
	|ПОМЕСТИТЬ РезервыПоРасходам
	|ИЗ
	|	ВТКэшРасчетныеОстаткиРезервыПредстоящихРасходов КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ОбъектыУчетаРезервовПредстоящихРасходов.ИспользованиеРезерва КАК Статьи
	|		ПО ДД.ОбъектУчетаРезервов = Статьи.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ СуммыРасходов КАК СуммыРасходов
	|		ПО ДД.Организация = СуммыРасходов.Организация
	|		И ДД.НаправлениеДеятельности = СуммыРасходов.НаправлениеДеятельности
	|		И Статьи.СтатьяРасходов = СуммыРасходов.СтатьяРасходов
	|		И (Статьи.АналитикаРасходов = СуммыРасходов.АналитикаРасходов ИЛИ Статьи.ЛюбаяАналитикаРасходов)
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И (СуммыРасходов.СуммаУпр >= 0 ИЛИ СуммыРасходов.СуммаРегл >= 0)
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.НаправлениеДеятельности,
	|	ДД.ВидРезервов,
	|	ДД.ОбъектУчетаРезервов,
	|	СуммыРасходов.СтатьяРасходов,
	|	СуммыРасходов.АналитикаРасходов,
	|	СуммыРасходов.Подразделение
	|;";
	#КонецОбласти
	
	#Область ПокрываемыеРезервамиСтатьиРасходов
	ТекстЗапросаВтРаспределениеНаПартии = ТекстЗапросаВтРаспределениеНаПартии + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Организация,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.Подразделение
	|ПОМЕСТИТЬ ПокрываемыеРезервамиСтатьиРасходовПредварительная
	|ИЗ
	|	РезервыПоРасходам КАК ДД
	|;
	|
	|////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	АВТОНОМЕРЗАПИСИ() КАК НомерУзла,
	|	ДД.Организация,
	|	ДД.НаправлениеДеятельности,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.Подразделение,
	|	ЕСТЬNULL(СуммыРасходов.СуммаРегл, 0) КАК СуммаРегл,
	|	ЕСТЬNULL(СуммыРасходов.СуммаРегл, 0)
	|		- ЕСТЬNULL(СуммыРасходов.ПостояннаяРазница, 0)
	|		- ЕСТЬNULL(СуммыРасходов.ВременнаяРазница, 0) КАК СуммаНУ,
	|	ЕСТЬNULL(СуммыРасходов.ПостояннаяРазница, 0) КАК ПостояннаяРазница,
	|	ЕСТЬNULL(СуммыРасходов.ВременнаяРазница, 0) КАК ВременнаяРазница,
	|	ЕСТЬNULL(СуммыРасходов.СуммаУпр, 0) КАК СуммаУпр,
	|	ЕСТЬNULL(СуммыРасходов.СуммаНДД, 0) КАК СтоимостьНДД
	|ПОМЕСТИТЬ ПокрываемыеРезервамиСтатьиРасходов
	|ИЗ
	|	ПокрываемыеРезервамиСтатьиРасходовПредварительная КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ СуммыРасходов КАК СуммыРасходов
	|		ПО ДД.Организация = СуммыРасходов.Организация
	|			И ДД.Подразделение = СуммыРасходов.Подразделение
	|			И ДД.НаправлениеДеятельности = СуммыРасходов.НаправлениеДеятельности
	|			И ДД.СтатьяРасходов = СуммыРасходов.СтатьяРасходов
	|			И ДД.АналитикаРасходов = СуммыРасходов.АналитикаРасходов
	|;";
	#КонецОбласти
	
	#Область ДокументыДвиженияРезервов
	ТекстЗапросаВтРаспределениеНаПартии = ТекстЗапросаВтРаспределениеНаПартии + "
	|ВЫБРАТЬ
	|	ОстаткиРезервов.Организация КАК Организация,
	|	ОстаткиРезервов.ВидРезервов КАК ВидРезервов,
	|	МАКСИМУМ(Реквизиты.Ссылка)	КАК ДокументДвижения
	|ПОМЕСТИТЬ ДокументыДвиженияРезервов
	|ИЗ
	|	ВТКэшРасчетныеОстаткиРезервыПредстоящихРасходов КАК ОстаткиРезервов
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.НачислениеСписаниеРезервовПредстоящихРасходов КАК Реквизиты
	|		ПО ОстаткиРезервов.Организация = Реквизиты.Организация
	|			И ОстаткиРезервов.ВидРезервов = Реквизиты.ВидРезервов
	|ГДЕ
	|	Реквизиты.Проведен
	|	И Реквизиты.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|
	|СГРУППИРОВАТЬ ПО
	|	ОстаткиРезервов.Организация,
	|	ОстаткиРезервов.ВидРезервов		
	|;";
	#КонецОбласти
	
	#Область ВтРаспределениеНаПартии
	ТекстЗапросаВтРаспределениеНаПартии = ТекстЗапросаВтРаспределениеНаПартии + "
	|ВЫБРАТЬ
	|	Расходы.Организация				КАК Организация,
	|	Расходы.СтатьяРасходов			КАК СтатьяРасходов,
	|	Расходы.АналитикаРасходов		КАК АналитикаРасходов,
	|	Расходы.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	Расходы.Подразделение			КАК Подразделение,
	|	СУММА(Расходы.Количество)		КАК Количество,
	|	СУММА(Расходы.КоличествоБезНДС)	КАК КоличествоБезНДС,
	|	СУММА(Расходы.КоличествоРегл)	КАК КоличествоРегл,
	|	СУММА(Расходы.КоличествоУпр)	КАК КоличествоУпр,
	|	СУММА(Расходы.КоличествоНДД)	КАК КоличествоНДД,
	|	СУММА(Расходы.КоличествоНУ)		КАК КоличествоНУ
	|ПОМЕСТИТЬ ВтРаспределениеНаПартии
	|ИЗ (
	// распределение на этапы при ПУ21
	|	ВЫБРАТЬ
	|		Расходы.Организация					КАК Организация,
	|		Операция.СтатьяРасходов				КАК СтатьяРасходов,
	|		Операция.АналитикаРасходов			КАК АналитикаРасходов,
	|		Операция.Подразделение				КАК Подразделение,
	|		Операция.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|		Расходы.ДоляСтоимости				КАК Количество,
	|		Расходы.ДоляСтоимости				КАК КоличествоБезНДС,
	|		Расходы.ДоляСтоимости				КАК КоличествоРегл,
	|		Расходы.ДоляСтоимости				КАК КоличествоУпр,
	|		Расходы.ДоляСтоимости				КАК КоличествоНДД,
	|		Расходы.ДоляСтоимости				КАК КоличествоНУ
	|	ИЗ
	|		ВТКэшРасчетныеОборотыПрочиеРасходыНезавершенногоПроизводства КАК Расходы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Операция
	|			ПО Операция.Ссылка = Расходы.Регистратор
	|	ГДЕ
	|		Расходы.СлужебноеВидДвиженияПриход
	|		И НЕ &ПартионныйУчетВерсии22
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	// распределение на другие статьи при ПУ21
	|	ВЫБРАТЬ
	|		Операция.Организация,
	|		Операция.СтатьяРасходов,
	|		Операция.АналитикаРасходов,
	|		Операция.Подразделение,
	|		Операция.НаправлениеДеятельности,
	|		Строки.ДоляСтоимости,
	|		Строки.ДоляСтоимости,
	|		Строки.ДоляСтоимости,
	|		Строки.ДоляСтоимости,
	|		Строки.ДоляСтоимости,
	|		Строки.ДоляСтоимости
	|	ИЗ
	|		Документ.РаспределениеПрочихЗатрат КАК Операция
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
	|			ПО Строки.Ссылка = Операция.Ссылка
	|	ГДЕ
	|		Операция.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Операция.Организация В(&МассивОрганизаций)
	|		И Операция.Проведен
	|		И НЕ &ПартионныйУчетВерсии22
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	// распределение для ПУ 2.2
	|	ВЫБРАТЬ
	|		ДД.Организация,
	|		ДД.СтатьяРасходов,
	|		ДД.АналитикаРасходов,
	|		ДД.Подразделение,
	|		ДД.НаправлениеДеятельности,
	|		ДД.ДоляСтоимости,
	|		ДД.ДоляСтоимостиБезНДС,
	|		ДД.ДоляСтоимостиРегл,
	|		ДД.ДоляСтоимостиУпр,
	|		ДД.ДоляСтоимостиНДД,
	|		ДД.ДоляСтоимостиНУ
	|	ИЗ
	|		ДолиПроизводственныхРасходов КАК ДД
	|	ГДЕ
	|		ДД.Организация В(&МассивОрганизаций)
	|		И &ПартионныйУчетВерсии22
	|		И НЕ (ДД.ДоляСтоимости = 0
	|			И ДД.ДоляСтоимостиБезНДС = 0
	|			И ДД.ДоляСтоимостиРегл = 0
	|			И ДД.ДоляСтоимостиУпр = 0
	|			И ДД.ДоляСтоимостиНДД = 0
	|			И ДД.ДоляСтоимостиНУ = 0)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	// распределение для расходов на себестоимость производства
	|	ВЫБРАТЬ
	|		ДД.Организация,
	|		ДД.СтатьяРасходов,
	|		ДД.АналитикаРасходов,
	|		ДД.Подразделение,
	|		ДД.НаправлениеДеятельности,
	|		ДД.ДоляСтоимости,
	|		ДД.ДоляСтоимостиБезНДС,
	|		ДД.ДоляСтоимостиРегл,
	|		ДД.ДоляСтоимостиУпр,
	|		ДД.ДоляСтоимостиНДД,
	|		ДД.ДоляСтоимостиНУ
	|	ИЗ
	|		ПрямыеПроизводственныеРасходы КАК ДД
	|	ГДЕ
	|		ДД.Организация В(&МассивОрганизаций)
	|	) КАК Расходы
	|
	|СГРУППИРОВАТЬ ПО
	|	Расходы.Организация,
	|	Расходы.СтатьяРасходов,
	|	Расходы.АналитикаРасходов,
	|	Расходы.Подразделение,
	|	Расходы.НаправлениеДеятельности
	|";
	#КонецОбласти
	
	ТекстЗапросаНастройкиСтатейИОВЗПоНДД = РасчетСебестоимостиЛокализация.ТекстЗапросаНастроекНДД("ВтРаспределениеНаПартии", "РасчетСебестоимостиКорректировкаСтоимости_ТекстВтНезавершенноеПроизводство", ПараметрыРасчета);
	
	ТекстЗапросаВтНезавершенноеПроизводство = "";
	//++ Локализация
	#Область ВтНезавершенноеПроизводствоВключениеИсключениеНДСПредварительная
	ТекстЗапросаВтНезавершенноеПроизводство = ТекстЗапросаВтНезавершенноеПроизводство + "
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Остатки.Партия ЕСТЬ NULL ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ КАК ОстаткиНЗП,
	|	ДД.Регистратор                           КАК Регистратор,
	|	ДД.Организация                           КАК Организация,
	|	ДД.Партия                                КАК Партия,
	|	НЕОПРЕДЕЛЕНО					 		 КАК ВидДеятельностиНДС,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|	ЕСТЬNULL(ДД.АналитикаУчетаПартий.КодСтроки, 0) КАК КодСтрокиПродукция,
	|	ВЫРАЗИТЬ(ДД.СтатьяРасходовАктивов КАК ПланВидовХарактеристик.СтатьиРасходов) КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                     КАК АналитикаРасходов,
	|	ЕСТЬNULL(Доли.КорПодразделение, ДД.Подразделение) КАК Подразделение,
	|	ДД.КорНаправлениеДеятельности            КАК НаправлениеДеятельности,
	|	ЕСТЬNULL(Доли.СтатьяКалькуляции, ЕСТЬNULL(Остатки.СтатьяКалькуляции, ДД.СтатьяКалькуляции)) КАК СтатьяКалькуляции,
	|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка)        КАК Этап,
	|	ЕСТЬNULL(Доли.ГруппаПродукции, ДД.ГруппаПродукции) КАК ГруппаПродукции,
	|	ЕСТЬNULL(Доли.ПравилоОтнесенияНаВыпуск, ЕСТЬNULL(Остатки.ПравилоОтнесенияНаВыпуск, ДД.ПравилоОтнесенияНаВыпуск)) КАК ПравилоОтнесенияНаВыпуск,
	|	0  			 							 КАК ПоказательОтнесенияНаВыпуск,
	|	0	 	 								 КАК ПоказательОтнесенияНаВыпускБезНДС,
	|	0	 	 								 КАК ПоказательОтнесенияНаВыпускРегл,
	|	0		 	 							 КАК ПоказательОтнесенияНаВыпускУпр,
	|	0              							 КАК Сумма,
	|	0                       				 КАК СуммаБезНДС,
	|	СУММА(ВЫБОР КОГДА НЕ ЕСТЬNULL(Распределение.УправленческийУчет, ИСТИНА)
	|		ТОГДА 0
	|	КОГДА ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	 И ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА ДД.НДСУпр
	|
	|	КОГДА ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	 И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|	 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА ДД.НДСУпр
	|
	|	КОГДА ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|	 И ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА -ДД.НДСУпр
	|	КОГДА ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|	 И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|	 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА -ДД.НДСУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ
	|		* ВЫБОР КОГДА Остатки.Партия ЕСТЬ NULL ТОГДА 1 ИНАЧЕ -1 КОНЕЦ) КАК СуммаУпр,
	|
	|	СУММА(ВЫБОР КОГДА НЕ ЕСТЬNULL(Распределение.РегламентированныйУчет, ИСТИНА)
	|		ТОГДА 0
	|	КОГДА ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	 И ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		ТОГДА ДД.НДСРегл
	|
	|	КОГДА ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|	 И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|	 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА ДД.НДСРегл
	|
	|	КОГДА ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|	 И ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		ТОГДА -ДД.НДСРегл
	|	КОГДА ДД.КорВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|	 И ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.РеализацияРаботУслугНаЭкспорт)
	|	 И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаВозможностиВычетаПриОказанииУслугНеВРФ
	|		ТОГДА -ДД.НДСРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ
	|		* ВЫБОР КОГДА Остатки.Партия ЕСТЬ NULL ТОГДА 1 ИНАЧЕ -1 КОНЕЦ) КАК СуммаРегл,
	|	0                     					 КАК ПостояннаяРазница,
	|	0                      					 КАК ВременнаяРазница,
	|	0										 КАК СтоимостьНДД,
	|	ЕСТЬNULL(Распределение.НалоговыйУчет, Истина) КАК НалоговыйУчет
	|
	// Данные для включения/исключения НДС НЗП
	|ПОМЕСТИТЬ ВтНезавершенноеПроизводствоВключениеИсключениеНДСПредварительная
	|ИЗ
	|	ВТСписаниеПостатейныхЗатрат КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДолиПроизводственныхРасходов КАК Доли
	|		ПО ДД.Организация = Доли.Организация
	|		И ДД.Регистратор = Доли.Регистратор
	|		И ДД.Партия = Доли.ПартияПроизводства
	|		И ДД.КорНаправлениеДеятельности = Доли.КорНаправлениеДеятельности
	|		И ДД.КорПодразделение = Доли.КорПодразделение
	|		И ДД.СтатьяРасходовАктивов = Доли.СтатьяРасходов
	|		И ДД.АналитикаРасходов = Доли.АналитикаРасходов
	|		И (ДД.СтатьяКалькуляции = Доли.СтатьяКалькуляции
	|			ИЛИ (ДД.СтатьяКалькуляции В (ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
	|		  	  И Доли.СтатьяКалькуляции В (ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка), НЕОПРЕДЕЛЕНО)))
	|		И (ДД.ГруппаПродукции = Доли.ГруппаПродукции
	|			ИЛИ (ДД.ГруппаПродукции В (ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
	|		  	  И Доли.ГруппаПродукции В (ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка), НЕОПРЕДЕЛЕНО)))
	|		И (ДД.ПравилоОтнесенияНаВыпуск = Доли.ПравилоОтнесенияНаВыпуск
	|			ИЛИ (ДД.ПравилоОтнесенияНаВыпуск В (ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка), НЕОПРЕДЕЛЕНО)
	|		  	  И Доли.ПравилоОтнесенияНаВыпуск В (ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка), НЕОПРЕДЕЛЕНО)))
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтОстаткиНезавершенногоПроизводства КАК Остатки
	|		ПО ДД.Организация = Остатки.Организация
	|		И ДД.Партия = Остатки.Партия
	|		И ДД.Подразделение = Остатки.Подразделение
	|		И ДД.ГруппаПродукции = Остатки.ГруппаПродукции
	|		И ДД.НаправлениеДеятельности = Остатки.НаправлениеДеятельности
	|		И ДД.СтатьяРасходовАктивов = Остатки.СтатьяРасходов
	|		И ДД.АналитикаРасходов = Остатки.АналитикаРасходов
	|		И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпускПостатейные)
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО ДанныеПервичныхДокументов.Организация = ДД.Организация
	|		И ДанныеПервичныхДокументов.Документ = ДД.ДокументПоступления
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Распределение
	|		ПО Распределение.Ссылка = ДД.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО ДД.СтатьяРасходовАктивов = СтатьиРасходов.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНастройкиУчетаНДС КАК НастройкиУчетаНДС
	|		ПО НастройкиУчетаНДС.Организация = ДД.Организация
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И ДД.Организация В(&МассивОрганизаций)
	|	И ДД.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	И ДД.ВидДеятельностиНДС <> НЕОПРЕДЕЛЕНО
	|	И ДД.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	И ДД.КорВидДеятельностиНДС <> НЕОПРЕДЕЛЕНО
	|	И ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходы)
	|	И ДД.ЕстьЦена
	// Условия определения видов деятельности НДС должны совпадать с соответствующими полями
	// таблицы ВТСтоимостьПартийНДСБезКорректировокНДС в общем модуле РасчетСебестоимостиНДС
	|	И ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			И ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|			И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|			И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|			И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|		ТОГДА ДД.КорВидДеятельностиНДС
	|		ИНАЧЕ ДД.ВидДеятельностиНДС
	|	КОНЕЦ <>
	|		ВЫБОР
	|			КОГДА ДД.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|				И НЕ ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|				И ЕСТЬNULL(НастройкиУчетаНДС.СписыватьНДСПоРасходамНеПринимаемымВНУ, ЛОЖЬ)
	|				И ДД.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|			КОГДА ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат)
	|			ТОГДА ДД.ВидДеятельностиНДС
	|			ИНАЧЕ ДД.КорВидДеятельностиНДС
	|		КОНЕЦ
	|	
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР КОГДА Остатки.Партия ЕСТЬ NULL ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Партия,
	|	ЕСТЬNULL(ДД.АналитикаУчетаПартий.КодСтроки, 0),
	|	ВЫРАЗИТЬ(ДД.СтатьяРасходовАктивов КАК ПланВидовХарактеристик.СтатьиРасходов),
	|	ДД.АналитикаРасходов,
	|	ЕСТЬNULL(Доли.КорПодразделение, ДД.Подразделение),
	|	ДД.КорНаправлениеДеятельности,
	|	ЕСТЬNULL(Доли.СтатьяКалькуляции, ЕСТЬNULL(Остатки.СтатьяКалькуляции, ДД.СтатьяКалькуляции)),
	|	ЕСТЬNULL(Доли.ГруппаПродукции, ДД.ГруппаПродукции),
	|	ЕСТЬNULL(Доли.ПравилоОтнесенияНаВыпуск, ЕСТЬNULL(Остатки.ПравилоОтнесенияНаВыпуск, ДД.ПравилоОтнесенияНаВыпуск)),
	|	ЕСТЬNULL(Распределение.НалоговыйУчет, Истина)
	|;";
	#КонецОбласти
	//-- Локализация
	
	#Область ВтНезавершенноеПроизводство
	ТекстЗапросаВтНезавершенноеПроизводство = ТекстЗапросаВтНезавершенноеПроизводство + "
	// Распределение на партии
	|ВЫБРАТЬ ПЕРВЫЕ 9999999999999
	|	АВТОНОМЕРЗАПИСИ() КАК НомерУзла,
	|	Расходы.Организация,
	|	Расходы.РазделУчета,
	|	Расходы.Партия,
	|	Расходы.ВидДеятельностиНДС,
	|	Расходы.АналитикаУчетаПартий,
	|	Расходы.КодСтрокиПродукция,
	|	Расходы.НаправлениеДеятельности,
	|	Расходы.СтатьяРасходов,
	|	Расходы.АналитикаРасходов,
	|	Расходы.Подразделение,
	|	Расходы.СтатьяКалькуляции,
	|	Расходы.Этап,
	|	Расходы.ГруппаПродукции,
	|	Расходы.ПравилоОтнесенияНаВыпуск,
	|	Расходы.Количество,
	|	Расходы.КоличествоБезНДС,
	|	Расходы.КоличествоРегл,
	|	Расходы.КоличествоНУ,
	|	Расходы.КоличествоНДД,
	|	Расходы.КоличествоУпр,
	
	|	Расходы.Сумма,
	|	Расходы.СуммаБезНДС,
	|	Расходы.СуммаУпр,
	|	Расходы.СуммаРегл,
	|	Расходы.СуммаНУ,
	|	Расходы.ПостояннаяРазница,
	|	Расходы.ВременнаяРазница,
	|	Расходы.СтоимостьНДД
	|
	|ПОМЕСТИТЬ ВтНезавершенноеПроизводство
	|ИЗ (
	|
	|ВЫБРАТЬ
	|	Расходы.Организация                                        КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты) КАК РазделУчета,
	|	ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)	   КАК Партия,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                               КАК АналитикаУчетаПартий,
	|	0													       КАК КодСтрокиПродукция,
	|	Расходы.НаправлениеДеятельности                            КАК НаправлениеДеятельности,
	|	Расходы.СтатьяРасходов                                     КАК СтатьяРасходов,
	|	Расходы.АналитикаРасходов                                  КАК АналитикаРасходов,
	|	Расходы.Подразделение                                      КАК Подразделение,
	|	ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)        КАК СтатьяКалькуляции,
	|	ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка)        КАК Этап,
	|	ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка) КАК ГруппаПродукции,
	|	ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка) КАК ПравилоОтнесенияНаВыпуск,
	|	Расходы.Количество                                  		КАК Количество,
	|	Расходы.КоличествоБезНДС                            		КАК КоличествоБезНДС,
	|	Расходы.КоличествоРегл                              		КАК КоличествоРегл,
	|	Расходы.КоличествоНУ                              			КАК КоличествоНУ,
	|	Расходы.КоличествоНДД                              			КАК КоличествоНДД,
	|	Расходы.КоличествоУпр                               		КАК КоличествоУпр,
	|	ЕСТЬNULL(СуммыРасходовУпр.Сумма, 0)              			КАК Сумма,
	|	ЕСТЬNULL(СуммыРасходовУпр.СуммаБезНДС, 0)        			КАК СуммаБезНДС,
	|	ЕСТЬNULL(СуммыРасходовУпр.СуммаУпр, 0)           			КАК СуммаУпр,
	|	ЕСТЬNULL(СуммыРасходовРегл.СуммаРегл, 0)         			КАК СуммаРегл,
	|	ЕСТЬNULL(СуммыРасходовНУ.СуммаНУ, 0)						КАК СуммаНУ,
	|	ЕСТЬNULL(СуммыРасходовРегл.ПостояннаяРазница, 0)			КАК ПостояннаяРазница,
	|	ЕСТЬNULL(СуммыРасходовРегл.СуммаРегл, 0) - ЕСТЬNULL(СуммыРасходовРегл.ПостояннаяРазница, 0)
	|	+ ЕСТЬNULL(СуммыРасходовНУ.ПостояннаяРазница, 0) + ЕСТЬNULL(СуммыРасходовНУ.ВременнаяРазница, 0) 
	|		- ЕСТЬNULL(СуммыРасходовНУ.СуммаРегл, 0)				КАК ВременнаяРазница,
	|	ЕСТЬNULL(СуммыРасходовНДД.СуммаНДД, 0)						КАК СтоимостьНДД
	|ИЗ
	|	ВтРаспределениеНаПартии КАК Расходы
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
	|		ПО Статьи.Ссылка = Расходы.СтатьяРасходов
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтОВЗ КАК ВтОВЗ
	|		ПО Расходы.АналитикаРасходов = ВтОВЗ.ОВЗ
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ НастройкиРаспределенияСтатейНДД КАК НастройкиРаспределенияСтатейНДД
	|	ПО Расходы.Организация = НастройкиРаспределенияСтатейНДД.Организация
	|		И Расходы.СтатьяРасходов = НастройкиРаспределенияСтатейНДД.СтатьяРасходов
	|		И &Расходы_ОбъектРаздельногоУчетаНДД = НастройкиРаспределенияСтатейНДД.ОбъектРаздельногоУчетаНДД
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ НастройкиРаспределенияСтатейНДДПоОВЗ КАК НастройкиРаспределенияСтатейНДДПоОВЗ
	|	ПО Расходы.АналитикаРасходов = НастройкиРаспределенияСтатейНДДПоОВЗ.ОВЗ
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ СуммыРасходов КАК СуммыРасходовУпр
	|		ПО СуммыРасходовУпр.Организация = Расходы.Организация
	|		И СуммыРасходовУпр.СтатьяРасходов = Расходы.СтатьяРасходов
	|		И СуммыРасходовУпр.АналитикаРасходов = Расходы.АналитикаРасходов
	|		И СуммыРасходовУпр.Подразделение = Расходы.Подразделение
	|		И СуммыРасходовУпр.НаправлениеДеятельности = Расходы.НаправлениеДеятельности
	|		И ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовУпр, Статьи.ВариантРаспределенияРасходовУпр) В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности), // для расчета резервов 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|		)
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ СуммыРасходов КАК СуммыРасходовРегл
	|		ПО СуммыРасходовРегл.Организация = Расходы.Организация
	|		И СуммыРасходовРегл.СтатьяРасходов = Расходы.СтатьяРасходов
	|		И СуммыРасходовРегл.АналитикаРасходов = Расходы.АналитикаРасходов
	|		И СуммыРасходовРегл.Подразделение = Расходы.Подразделение
	|		И СуммыРасходовРегл.НаправлениеДеятельности = Расходы.НаправлениеДеятельности
	|		И ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовРегл, Статьи.ВариантРаспределенияРасходовРегл) В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности), // для расчета резервов 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|		)
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ СуммыРасходов КАК СуммыРасходовНУ
	|		ПО СуммыРасходовНУ.Организация = Расходы.Организация
	|		И СуммыРасходовНУ.СтатьяРасходов = Расходы.СтатьяРасходов
	|		И СуммыРасходовНУ.АналитикаРасходов = Расходы.АналитикаРасходов
	|		И СуммыРасходовНУ.Подразделение = Расходы.Подразделение
	|		И СуммыРасходовНУ.НаправлениеДеятельности = Расходы.НаправлениеДеятельности
	|		И ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовНУ, Статьи.ВариантРаспределенияРасходовНУ) В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности), // для расчета резервов 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|		)
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ СуммыРасходов КАК СуммыРасходовНДД
	|		ПО СуммыРасходовНДД.Организация = Расходы.Организация
	|		И СуммыРасходовНДД.СтатьяРасходов = Расходы.СтатьяРасходов
	|		И СуммыРасходовНДД.АналитикаРасходов = Расходы.АналитикаРасходов
	|		И СуммыРасходовНДД.Подразделение = Расходы.Подразделение
	|		И СуммыРасходовНДД.НаправлениеДеятельности = Расходы.НаправлениеДеятельности
	|		И ЕСТЬNULL(НастройкиРаспределенияСтатейНДДПоОВЗ.ВариантРаспределенияРасходовНДД, 
	|			ЕСТЬNULL(НастройкиРаспределенияСтатейНДД.ВариантРаспределенияРасходовНДД,
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.ПустаяСсылка))) В (
	|					ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|					ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства))
	|
	|ГДЕ
	|	ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовУпр, Статьи.ВариантРаспределенияРасходовУпр) В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности), // для расчета резервов 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|		)
	|	ИЛИ ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовРегл, Статьи.ВариантРаспределенияРасходовРегл) В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности), // для расчета резервов 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|		)
	|	ИЛИ ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовНУ, Статьи.ВариантРаспределенияРасходовНУ) В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности), // для расчета резервов 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|		)
	|	ИЛИ ЕСТЬNULL(НастройкиРаспределенияСтатейНДДПоОВЗ.ВариантРаспределенияРасходовНДД, 
	|				ЕСТЬNULL(НастройкиРаспределенияСтатейНДД.ВариантРаспределенияРасходовНДД,
	|					ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.ПустаяСсылка))) В (
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|					)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// распределение на продукцию
	|ВЫБРАТЬ
	|	ДД.Организация                                       КАК Организация,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета,
	|	ДД.Партия                                            КАК Партия,
	|	ДД.ВидДеятельностиНДС								 КАК ВидДеятельностиНДС,
	|	ДД.АналитикаУчетаПартий                              КАК АналитикаУчетаПартий,
	|	ДД.КодСтрокиПродукция								 КАК КодСтрокиПродукция,
	|	ДД.НаправлениеДеятельности							 КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходов                                    КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов                                 КАК АналитикаРасходов,
	|	ДД.Подразделение                                     КАК Подразделение,
	|	ДД.СтатьяКалькуляции                                 КАК СтатьяКалькуляции,
	|	ДД.Этап												 КАК Этап,
	|	ДД.ГруппаПродукции                                   КАК ГруппаПродукции,
	|	ДД.ПравилоОтнесенияНаВыпуск                          КАК ПравилоОтнесенияНаВыпуск,
	|	СУММА(ДД.ПоказательОтнесенияНаВыпуск)                КАК Количество,
	|	СУММА(ДД.ПоказательОтнесенияНаВыпускБезНДС)          КАК КоличествоБезНДС,
	|	СУММА(ДД.ПоказательОтнесенияНаВыпускРегл)            КАК КоличествоРегл,
	|	СУММА(ДД.ПоказательОтнесенияНаВыпускНУ)              КАК КоличествоНУ,
	|	СУММА(ДД.ПоказательОтнесенияНаВыпускНДД)             КАК КоличествоНДД,
	|	СУММА(ДД.ПоказательОтнесенияНаВыпускУпр)             КАК КоличествоУпр,
	|	СУММА(ДД.Сумма)                                      КАК Сумма,
	|	СУММА(ДД.СуммаБезНДС)                                КАК СуммаБезНДС,
	|	СУММА(ДД.СуммаУпр)                                   КАК СуммаУпр,
	|	СУММА(ДД.СуммаРегл)                                  КАК СуммаРегл,
	|	СУММА(ДД.СуммаРегл
	|	 - ДД.ПостояннаяРазница - ДД.ВременнаяРазница)       КАК СуммаНУ,
	|	СУММА(ДД.ПостояннаяРазница)                          КАК ПостояннаяРазница,
	|	СУММА(ДД.ВременнаяРазница)                           КАК ВременнаяРазница,
	|	СУММА(ДД.СтоимостьНДД)								 КАК СтоимостьНДД
	|ИЗ (
	|	ВЫБРАТЬ
	|		ДД.Организация                           КАК Организация,
	|		ДД.ДокументВыпуска                       КАК Партия,
	|		ДД.ВидДеятельностиНДС					 КАК ВидДеятельностиНДС,
	|		ДД.АналитикаПартииВыпуска      			 КАК АналитикаУчетаПартий,
	|		ДД.КодСтрокиПродукция      				 КАК КодСтрокиПродукция,
	|		ДД.СтатьяРасходов                        КАК СтатьяРасходов,
	|		ДД.АналитикаРасходов                     КАК АналитикаРасходов,
	|		ДД.Подразделение                         КАК Подразделение,
	|		ДД.НаправлениеДеятельности               КАК НаправлениеДеятельности,
	|		ДД.СтатьяКалькуляции                     КАК СтатьяКалькуляции,
	|		ДД.Этап              					 КАК Этап,
	|		ДД.ГруппаПродукции                       КАК ГруппаПродукции,
	|		ДД.ПравилоОтнесенияНаВыпуск              КАК ПравилоОтнесенияНаВыпуск,
	|		ДД.ПоказательОтнесенияНаВыпуск			 КАК ПоказательОтнесенияНаВыпуск,
	|		ДД.ПоказательОтнесенияНаВыпускБезНДС	 КАК ПоказательОтнесенияНаВыпускБезНДС,
	|		ДД.ПоказательОтнесенияНаВыпускРегл		 КАК ПоказательОтнесенияНаВыпускРегл,
	|		ДД.ПоказательОтнесенияНаВыпускНУ		 КАК ПоказательОтнесенияНаВыпускНУ,
	|		ДД.ПоказательОтнесенияНаВыпускНДД		 КАК ПоказательОтнесенияНаВыпускНДД,
	|		ДД.ПоказательОтнесенияНаВыпускУпр		 КАК ПоказательОтнесенияНаВыпускУпр,
	|		0                                        КАК Сумма,
	|		0                                        КАК СуммаБезНДС,
	|		0                                        КАК СуммаУпр,
	|		0                                        КАК СуммаРегл,
	|		0                                        КАК ПостояннаяРазница,
	|		0                                        КАК ВременнаяРазница,
	|		0										 КАК СтоимостьНДД
	|	ИЗ
	|		втПрочиеРасходыНезавершенногоПроизводства КАК ДД
	|	ГДЕ
	|		ДД.Организация В (&МассивОрганизаций)
	|		И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И &ПартионныйУчетВерсии22
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	//++ Локализация
	
	// Включение / исключение НДС в стоимость незавершенного производства должно выполняться аналогично 
	// процедуре СкорректироватьСтоимостьСписанияНезавершенногоПроизводства22 - формирование временной таблицы ДвиженияТаблицаКорректировки.
	|	ВЫБРАТЬ
	|		ДД.Организация                           КАК Организация,
	|		ДД.Партия                                КАК Партия,
	|		ДД.ВидДеятельностиНДС				 	 КАК ВидДеятельностиНДС,
	|		ДД.АналитикаУчетаПартий 				 КАК АналитикаУчетаПартий,
	|		ДД.КодСтрокиПродукция 					 КАК КодСтрокиПродукция,
	|		ДД.СтатьяРасходов 						 КАК СтатьяРасходов,
	|		ДД.АналитикаРасходов                     КАК АналитикаРасходов,
	|		ДД.Подразделение                         КАК Подразделение,
	|		ДД.НаправлениеДеятельности               КАК НаправлениеДеятельности,
	|		ДД.СтатьяКалькуляции                     КАК СтатьяКалькуляции,
	|		ДД.Этап        							 КАК Этап,
	|		ДД.ГруппаПродукции                       КАК ГруппаПродукции,
	|		ДД.ПравилоОтнесенияНаВыпуск              КАК ПравилоОтнесенияНаВыпуск,
	|		ДД.ПоказательОтнесенияНаВыпуск			 КАК ПоказательОтнесенияНаВыпуск,
	|		ДД.ПоказательОтнесенияНаВыпускБезНДС	 КАК ПоказательОтнесенияНаВыпускБезНДС,
	|		ДД.ПоказательОтнесенияНаВыпускРегл		 КАК ПоказательОтнесенияНаВыпускРегл,
	|		ДД.ПоказательОтнесенияНаВыпускРегл		 КАК ПоказательОтнесенияНаВыпускНУ,
	|		ДД.ПоказательОтнесенияНаВыпускРегл		 КАК ПоказательОтнесенияНаВыпускНДД,
	|		ДД.ПоказательОтнесенияНаВыпускУпр		 КАК ПоказательОтнесенияНаВыпускУпр,
	|		ДД.Сумма       							 КАК Сумма,
	|		ДД.СуммаБезНДС                       	 КАК СуммаБезНДС,
	|		ДД.СуммаУпр								 КАК СуммаУпр,
	|		ДД.СуммаРегл							 КАК СуммаРегл,
	// При включении/исключении НДС в стоимость для статьи, не принимаемой к налоговому учету по налогу на прибыль,
	// должна возникать постоянная разница на сумму НДС.
	|		(ВЫБОР
	|			КОГДА НЕ ЕСТЬNULL(ДД.СтатьяРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|				ТОГДА ДД.СуммаРегл
	|			ИНАЧЕ ДД.ПостояннаяРазница КОНЕЦ)	 КАК ПостояннаяРазница,
	// При включении/исключении НДС в стоимость для статьи, не распределяемой на себестоимость производства в НУ,
	// должна возникать временная разница на сумму НДС.
	|		(ВЫБОР
	|			КОГДА НЕ ДД.НалоговыйУчет
	|			 И ЕСТЬNULL(ДД.СтатьяРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|				ТОГДА ДД.СуммаРегл
	|			ИНАЧЕ 0 КОНЕЦ)                       КАК ВременнаяРазница,
	|		ДД.СтоимостьНДД							 КАК СтоимостьНДД
	|	ИЗ
	|		ВтНезавершенноеПроизводствоВключениеИсключениеНДСПредварительная КАК ДД
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	//-- Локализация
	|
	|	ВЫБРАТЬ
	|		ДД.Организация                           КАК Организация,
	|		ДД.Партия                                КАК Партия,
	|		ЕСТЬNULL(
	|			ВЫРАЗИТЬ(ДД.АналитикаУчетаПартий КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Назначение.ВидДеятельностиНДС, НЕОПРЕДЕЛЕНО) КАК ВидДеятельностиНДС,
	|		ДД.АналитикаУчетаПартий                  КАК АналитикаУчетаПартий,
	|		ДД.КодСтрокиПродукция      				 КАК КодСтрокиПродукция,
	|		ДД.СтатьяРасходов                        КАК СтатьяРасходов,
	|		ДД.АналитикаРасходов                     КАК АналитикаРасходов,
	|		ДД.Подразделение                         КАК Подразделение,
	|		ДД.НаправлениеДеятельности               КАК НаправлениеДеятельности,
	|		ДД.СтатьяКалькуляции                     КАК СтатьяКалькуляции,
	|		ДД.Этап              					 КАК Этап,
	|		ДД.ГруппаПродукции                       КАК ГруппаПродукции,
	|		ДД.ПравилоОтнесенияНаВыпуск              КАК ПравилоОтнесенияНаВыпуск,
	|		ДД.ПоказательОтнесенияНаВыпуск           КАК ПоказательОтнесенияНаВыпуск,
	|		ДД.ПоказательОтнесенияНаВыпускБезНДС	 КАК ПоказательОтнесенияНаВыпускБезНДС,
	|		ДД.ПоказательОтнесенияНаВыпускРегл		 КАК ПоказательОтнесенияНаВыпускРегл,
	|		ДД.ПоказательОтнесенияНаВыпускРегл		 КАК ПоказательОтнесенияНаВыпускНУ,
	|		ДД.ПоказательОтнесенияНаВыпускРегл		 КАК ПоказательОтнесенияНаВыпускНДД,
	|		ДД.ПоказательОтнесенияНаВыпускУпр		 КАК ПоказательОтнесенияНаВыпускУпр,
	|		ДД.Стоимость                             КАК Сумма,
	|		ДД.СтоимостьБезНДС                       КАК СуммаБезНДС,
	|		ДД.СтоимостьУпр                          КАК СуммаУпр,
	|		ДД.СтоимостьРегл                         КАК СуммаРегл,
	|		ДД.ПостояннаяРазница                     КАК ПостояннаяРазница,
	|		ДД.ВременнаяРазница                      КАК ВременнаяРазница,
	|		ДД.СтоимостьНДД							 КАК СтоимостьНДД
	|	ИЗ
	|		ВтОстаткиНезавершенногоПроизводства КАК ДД
	|	ГДЕ
	|		&ПартионныйУчетВерсии22
	|	) КАК ДД
	|
	|	СГРУППИРОВАТЬ ПО
	|		ДД.Партия,
	|		ДД.ВидДеятельностиНДС,
	|		ДД.АналитикаУчетаПартий,
	|		ДД.КодСтрокиПродукция,
	|		ДД.Организация,
	|		ДД.СтатьяРасходов,
	|		ДД.АналитикаРасходов,
	|		ДД.Подразделение,
	|		ДД.НаправлениеДеятельности,
	|		ДД.СтатьяКалькуляции,
	|		ДД.Этап,
	|		ДД.ГруппаПродукции,
	|		ДД.ПравилоОтнесенияНаВыпуск
	|) КАК Расходы
	|
	|УПОРЯДОЧИТЬ ПО
	|	Организация,
	|	НаправлениеДеятельности,
	|	Подразделение,
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Партия
	//++ Локализация
	|;";
	#КонецОбласти
	
	#Область ВтНезавершенноеПроизводствоВключениеИсключениеНДС
	ТекстЗапросаВтНезавершенноеПроизводство = ТекстЗапросаВтНезавершенноеПроизводство + "
	|ВЫБРАТЬ
	|	Т.ОстаткиНЗП,
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.Партия,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаУчетаПартий,
	|	Т.КодСтрокиПродукция,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.Подразделение,
	|	Т.СтатьяКалькуляции,
	|	Т.ГруппаПродукции,
	|	Т.ПравилоОтнесенияНаВыпуск,
	|	Т.СуммаУпр,
	|	Т.СуммаРегл,
	|	Т.СтоимостьНДД КАК СуммаНДД
	|ПОМЕСТИТЬ ВтНезавершенноеПроизводствоВключениеИсключениеНДС
	|ИЗ
	|	ВтНезавершенноеПроизводствоВключениеИсключениеНДСПредварительная КАК Т
	|ГДЕ
	|	Т.СуммаРегл <> 0 ИЛИ Т.СуммаУпр <> 0
	|	ИЛИ Т.СтоимостьНДД <> 0
	//-- Локализация
	|";
	#КонецОбласти
	
	ТекстыЗапросов.Добавить(ТекстСуммыПрочихРасходов(ПараметрыРасчета));
	ТекстыЗапросов.Добавить(ТекстЗапросаВтРаспределениеНаПартии);
	ТекстыЗапросов.Добавить(ТекстЗапросаНастройкиСтатейИОВЗПоНДД);
	ТекстыЗапросов.Добавить(ТекстЗапросаВтНезавершенноеПроизводство);
	
	ТекстЗапроса = СтрСоединить(ТекстыЗапросов,
		ОбщегоНазначения.РазделительПакетаЗапросов());
	
	РасчетСебестоимостиЛокализация.ПодставитьВЗапросеТипОбъектаРаздельногоУчетаНДД(ТекстЗапроса, "Расходы_ОбъектРаздельногоУчетаНДД");
	
	Возврат ТекстЗапроса;
		
КонецФункции

//-- НЕ УТ

Функция ТекстСуммыПрочихРасходов(ПараметрыРасчета) Экспорт
	
	// При изменении текста запроса Вт СуммыРасходов, необхоимо так же исправить см. РасчетСебестоимостиЛокализация.ИзменитьТекстСуммыПрочихРасходов
	
	#Область СписаниеНаРасходыИсключения
	ТекстЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СписанияНаРасходыПоФиксированнойСтоимости.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	СписанияНаРасходыПоФиксированнойСтоимости.РазделУчета КАК РазделУчета,
	|	СписанияНаРасходыПоФиксированнойСтоимости.ВидЗапасов КАК ВидЗапасов,
	|	СписанияНаРасходыПоФиксированнойСтоимости.Организация КАК Организация,
	|	СписанияНаРасходыПоФиксированнойСтоимости.Партия КАК Партия,
	|	СписанияНаРасходыПоФиксированнойСтоимости.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	СписанияНаРасходыПоФиксированнойСтоимости.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|	СписанияНаРасходыПоФиксированнойСтоимости.ВидДеятельностиНДС КАК ВидДеятельностиНДС
	|ПОМЕСТИТЬ СписаниеНаРасходыИсключения
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК СписанияНаРасходыПоФиксированнойСтоимости
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК СписанияНаРасходыПоРасчетнойСтоимости
	|	ПО
	|		СписанияНаРасходыПоФиксированнойСтоимости.АналитикаУчетаНоменклатуры = СписанияНаРасходыПоРасчетнойСтоимости.АналитикаУчетаНоменклатуры
	|		И СписанияНаРасходыПоФиксированнойСтоимости.РазделУчета = СписанияНаРасходыПоРасчетнойСтоимости.РазделУчета
	|		И СписанияНаРасходыПоФиксированнойСтоимости.ВидЗапасов = СписанияНаРасходыПоРасчетнойСтоимости.ВидЗапасов
	|		И СписанияНаРасходыПоФиксированнойСтоимости.Организация = СписанияНаРасходыПоРасчетнойСтоимости.Организация
	|		И СписанияНаРасходыПоФиксированнойСтоимости.Партия = СписанияНаРасходыПоРасчетнойСтоимости.Партия
	|		И СписанияНаРасходыПоФиксированнойСтоимости.АналитикаУчетаПартий = СписанияНаРасходыПоРасчетнойСтоимости.АналитикаУчетаПартий
	|		И СписанияНаРасходыПоФиксированнойСтоимости.АналитикаФинансовогоУчета = СписанияНаРасходыПоРасчетнойСтоимости.АналитикаФинансовогоУчета
	|		И СписанияНаРасходыПоФиксированнойСтоимости.ВидДеятельностиНДС = СписанияНаРасходыПоРасчетнойСтоимости.ВидДеятельностиНДС
	|		И СписанияНаРасходыПоФиксированнойСтоимости.СлужебноеВидДвиженияПриход = СписанияНаРасходыПоРасчетнойСтоимости.СлужебноеВидДвиженияПриход
	|		И СписанияНаРасходыПоФиксированнойСтоимости.ХозяйственнаяОперация = 
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|		И СписанияНаРасходыПоРасчетнойСтоимости.ХозяйственнаяОперация = 
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|
	|ГДЕ
	|	НЕ СписанияНаРасходыПоФиксированнойСтоимости.СлужебноеВидДвиженияПриход
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;";
	#КонецОбласти
	
	#Область ВТРасчетныеОборотыСебестоимостьИндексированная
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	ДД.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации
	|ПОМЕСТИТЬ ВТРасчетныеОборотыСебестоимостьИндексированная
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ СписаниеНаРасходыИсключения КАК СписаниеНаРасходыИсключения
	|			ПО ДД.АналитикаУчетаНоменклатуры = СписаниеНаРасходыИсключения.АналитикаУчетаНоменклатуры
	|			И ДД.РазделУчета = СписаниеНаРасходыИсключения.РазделУчета
	|			И ДД.ВидЗапасов = СписаниеНаРасходыИсключения.ВидЗапасов
	|			И ДД.Организация = СписаниеНаРасходыИсключения.Организация
	|			И ДД.Партия = СписаниеНаРасходыИсключения.Партия
	|			И ДД.АналитикаУчетаПартий = СписаниеНаРасходыИсключения.АналитикаУчетаПартий
	|			И ДД.АналитикаФинансовогоУчета = СписаниеНаРасходыИсключения.АналитикаФинансовогоУчета
	|			И ДД.ВидДеятельностиНДС = СписаниеНаРасходыИсключения.ВидДеятельностиНДС
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|	И НЕ ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.РаспределениеДоходовПоНаправлениямДеятельности)
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	ИдентификаторФинЗаписи,
	|	НастройкаХозяйственнойОперации,
	|	Период
	|;";
	#КонецОбласти
	
	#Область ДопРасходыПоПартииПрошлогоПериода
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор КАК Регистратор
	|
	|ПОМЕСТИТЬ ДопРасходыПоПартииПрошлогоПериода
	|ИЗ
	|	ПриемникиПоТоварам КАК ДД
	|ГДЕ
	|	ДД.ЭтоПартияПрошлогоПериода
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;";
	#КонецОбласти
	
	#Область ВТРасчетныеОборотыПрочиеРасходыИндексированная
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	ДД.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ДД.Организация,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности,
	|
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ КАК Знак,
	|	ДД.Сумма КАК Сумма,
	|	ДД.СуммаБезНДС КАК СуммаБезНДС,
	|	ДД.СуммаУпр КАК СуммаУпр,
	|	ДД.СуммаРегл КАК СуммаРегл,
	|	ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	(ВЫБОР
	// Исключаем суммы НУ, сформированные при распределении дополнительных расходов на выбытия товаров в прошлых периодах.
	// Суммы по таким расходам будут рассчитаны при решении СЛУ.
	// Связи доп расходов с производственным расходами формируются в функции СвязиУзловПроизводственныхРасходовПрошлыхПериодов()
	|		КОГДА НЕ Распределение.Регистратор ЕСТЬ NULL
	|			ТОГДА 0
	|		ИНАЧЕ ДД.СуммаРегл
	|		- ДД.ПостояннаяРазница
	|		- ДД.ВременнаяРазница КОНЕЦ) КАК СуммаНУ,
	|	ДД.СуммаНДД КАК СуммаНДД
	|ПОМЕСТИТЬ ВТРасчетныеОборотыПрочиеРасходыИндексированная
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеРасходы КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = ДД.Период
	|		И РассчитанныеДокументы.Регистратор = ДД.Регистратор
	|		И &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ДопРасходыПоПартииПрошлогоПериода КАК Распределение
	|		ПО Распределение.Регистратор = ДД.Регистратор
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И НЕ ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.РаспределениеДоходовПоНаправлениямДеятельности)
	// В старых релизах у документа РаспределениеПрочихЗатрат были движения списания на финансовый результат, формируемые без признака "Расчетное"
	|	И НЕ (ТИПЗНАЧЕНИЯ(ДД.Регистратор) = ТИП(Документ.РаспределениеПрочихЗатрат) И НЕ ДД.РасчетПартий И НЕ ДД.РасчетСебестоимости)
	// При предварительном расчете исключаем документы, для которых сохранены ранее рассчитанные движения
	|	И РассчитанныеДокументы.Регистратор ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Из суммы расходов вычитаем выпуск продукции по плановой стоимости.
	// Начальная стоимость таких расходов будет определена в функции ТекстНачальнаяСтоимостьПостатейныеРасходы().
	// При списании отклонений на себестоимость продаж не вычитаем плановую стоимость в управленческом и налоговом учете
	// такие расходы распределяются исходя из плановой стоимости.
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	ДД.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ДД.Организация					КАК Организация,
	|	ДД.СтатьяРасходовСписания		КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов			КАК АналитикаРасходов,
	|	ДД.Подразделение				КАК Подразделение,
	|	ДД.КорНаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	1 КАК Знак,
	|	-ДД.Стоимость КАК Сумма,
	|	-ДД.СтоимостьБезНДС КАК СуммаБезНДС,
	|	-(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА 0
	|		ИНАЧЕ ДД.СтоимостьУпр КОНЕЦ) КАК СуммаУпр,
	|	-(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА 0
	|		ИНАЧЕ ДД.СтоимостьРегл КОНЕЦ) КАК СуммаРегл,
	|	0 КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	-ДД.СтоимостьРегл КАК СуммаНУ,
	|	0 КАК СуммаНДД
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ДД.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	НЕ ДД.СлужебноеВидДвиженияПриход
	|	И ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|	И НЕ ДД.РасчетПартий
	|	И НЕ ДД.РасчетСебестоимости
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	ИдентификаторФинЗаписи,
	|	НастройкаХозяйственнойОперации,
	|	Период
	|;";
	#КонецОбласти
	
	#Область СуммыРасходовПредварительная
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	""1""						КАК ЗапросИсточник,
	|	ДД.Организация				КАК Организация,
	|	ДД.СтатьяРасходов			КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов		КАК АналитикаРасходов,
	|	ДД.Подразделение			КАК Подразделение,
	|	ДД.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ДД.СуммаОстаток				КАК Сумма,
	|	ДД.СуммаБезНДСОстаток		КАК СуммаБезНДС,
	|	ДД.СуммаУпрОстаток			КАК СуммаУпр,
	|	ДД.СуммаРеглОстаток			КАК СуммаРегл,
	|	ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА 0 // Для удобства расстановки тегов

	//++ НЕ УТ
	|		КОГДА ДД.СтатьяРасходов.ВидРасходов В (&ВидыРасходовНормируемые)
	|			ТОГДА 0
	//-- НЕ УТ
	|		ИНАЧЕ
	|			ДД.ПостояннаяРазницаОстаток
	|	КОНЕЦ КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазницаОстаток КАК ВременнаяРазница,
	|	ДД.СуммаРеглОстаток
	|		- ДД.ПостояннаяРазницаОстаток
	|		- ДД.ВременнаяРазницаОстаток КАК СуммаНУ,
	|	ДД.СуммаНДДОстаток КАК СуммаНДД
	|
	|ПОМЕСТИТЬ СуммыРасходовПредварительная
	|ИЗ
	|	РегистрНакопления.ПрочиеРасходы.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		&ПартионныйУчетВерсии22
	|		И Организация В (&МассивОрганизаций)) КАК ДД
	|
	|ОБЪЕДИНИТЬ ВСЕ	
	|
	|ВЫБРАТЬ
	|	""2""							КАК ЗапросИсточник,
	|	ДД.Организация					КАК Организация,
	|	ДД.СтатьяРасходов				КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов			КАК АналитикаРасходов,
	|	ДД.Подразделение				КАК Подразделение,
	|	ДД.НаправлениеДеятельности		КАК НаправлениеДеятельности,
	|	ДД.Знак * ДД.Сумма				КАК Сумма,
	|	ДД.Знак * ДД.СуммаБезНДС		КАК СуммаБезНДС,
	|	ДД.Знак * ДД.СуммаУпр			КАК СуммаУпр,
	|	ДД.Знак * ДД.СуммаРегл			КАК СуммаРегл,
	|	ДД.Знак * ДД.ПостояннаяРазница	КАК ПостояннаяРазница,
	|	ДД.Знак * ДД.ВременнаяРазница	КАК ВременнаяРазница,
	|	ДД.Знак * ДД.СуммаНУ			КАК СуммаНУ,
	|	ДД.Знак * ДД.СуммаНДД			КАК СуммаНДД
	|ИЗ
	|	ВТРасчетныеОборотыПрочиеРасходыИндексированная КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРасчетныеОборотыСебестоимостьИндексированная КАК ДвиженияСебестоимости
	|		ПО ДвиженияСебестоимости.Период = ДД.Период
	|		И ДвиженияСебестоимости.Регистратор = ДД.Регистратор
	|		И ДвиженияСебестоимости.ИдентификаторФинЗаписи = ДД.ИдентификаторФинЗаписи
	|		И ДвиженияСебестоимости.НастройкаХозяйственнойОперации = ДД.НастройкаХозяйственнойОперации
	|
	|ГДЕ
	// Исключаем суммы расходов, сформированные документами выпуска продукции (работ), где выпуск проходит как по фиксированной, так и по расчетной оценке.
	// Суммы таких расходов будут взяты из себестоимости товаров.
	|	ДвиженияСебестоимости.Регистратор ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ	
	|
	|ВЫБРАТЬ
	|	""3""						КАК ЗапросИсточник,
	|	ДД.Организация				КАК Организация,
	|	ДД.СтатьяРасходов			КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов		КАК АналитикаРасходов,
	|	ДД.Подразделение			КАК Подразделение,
	|	ДД.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ * ДД.Сумма				КАК Сумма,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ * ДД.СуммаБезНДС			КАК СуммаБезНДС,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ * ДД.СуммаУпр				КАК СуммаУпр,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ * ДД.СуммаРегл			КАК СуммаРегл,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ * ДД.ПостояннаяРазница	КАК ПостояннаяРазница,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ * ДД.ВременнаяРазница		КАК ВременнаяРазница,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ
	|		* (ДД.СуммаРегл
	|		- ДД.ПостояннаяРазница
	|		- ДД.ВременнаяРазница) КАК СуммаНУ,
	|	ВЫБОР КОГДА ДД.СлужебноеВидДвиженияПриход ТОГДА 1 ИНАЧЕ - 1 КОНЕЦ * ДД.СуммаНДД				КАК СуммаНДД
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеРасходы КАК ДД
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Т
	|		ПО ДД.Регистратор = Т.Ссылка
	|ГДЕ
	|	НЕ &ПартионныйУчетВерсии22
	|	И ДД.РасчетСебестоимости
	|	И НЕ ДД.Регистратор Ссылка Документ.РаспределениеДоходовПоНаправлениямДеятельности
	|	И (Т.Ссылка ЕСТЬ NULL
	|		ИЛИ НЕ Т.НазначениеНастройкиРаспределения = ЗНАЧЕНИЕ(Перечисление.НазначениеПравилРаспределенияРасходов.РаспределениеРасходовНаФинансовыйРезультат))
	|
	|ОБЪЕДИНИТЬ ВСЕ	
	|
	// Списания на расходы, суммы которых калькулируются в процессе расчета себестоимости
	// Признак таких движений - заполненный реквизит СтатьяРасходовСписания в РН СебестоимостьТоваров
	|ВЫБРАТЬ
	|	""4""							КАК ЗапросИсточник,
	|	ДД.Организация					КАК Организация,
	|	ДД.СтатьяРасходовСписания		КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов			КАК АналитикаРасходов,
	|	ДД.Подразделение				КАК Подразделение,
	|	ДД.КорНаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	0 КАК Сумма,
	|	0 КАК СуммаБезНДС,
	|	0 КАК СуммаУпр,
	|	0 КАК СуммаРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СуммаНУ,
	|	0 КАК СуммаНДД
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Получение данных по отклонениям в стоимости должно соответствовать запросу 
	// в процедуре СформироватьДвиженияПоОтклонениямВСтоимостиТоваров() #Область ОтклоненияВСтоимостиПрочиеРасходы.
	|ВЫБРАТЬ
	|	""5""							КАК ЗапросИсточник,
	|	ДД.Организация					КАК Организация,
	|	ДД.СтатьяРасходовСписания		КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов			КАК АналитикаРасходов,
	|	ДД.Подразделение				КАК Подразделение,
	|	ДД.КорНаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ДД.Стоимость					КАК Сумма,
	|	ДД.СтоимостьБезНДС				КАК СуммаБезНДС,
	|	ДД.СтоимостьУпр					КАК СуммаУпр,
	|	ДД.СтоимостьРегл				КАК СуммаРегл,
	|	(ВЫБОР
	|		КОГДА НЕ ЕСТЬNULL(ВЫРАЗИТЬ(ДД.СтатьяРасходовСписания КАК ПланВидовХарактеристик.СтатьиРасходов).ПринятиеКНалоговомуУчету, ИСТИНА)
	|			ТОГДА ДД.СтоимостьРегл
	|		ИНАЧЕ ДД.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	ДД.СтоимостьРегл
	|		- ДД.ПостояннаяРазница
	|		- ДД.ВременнаяРазница КАК СуммаНУ,
	|	ДД.СтоимостьНДД КАК СуммаНДД
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов
	|;";
	#КонецОбласти
	
	#Область СуммыРасходов
	ТекстЗапроса = ТекстЗапроса + "
	// Поля временной таблицы СуммыРасходов должны соответствовать временным таблицам СуммыРасходовПредварительная и
	// СуммыРасходов в функции ИзменитьТекстСуммыПрочихРасходов() общего модуля РасчетСебестоимостиНДД. 
	|ВЫБРАТЬ
	|	ДД.Организация КАК Организация,
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	СУММА(ДД.Сумма) КАК Сумма,
	|	СУММА(ДД.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(ДД.СуммаУпр) КАК СуммаУпр,
	|	СУММА(ВЫБОР
	|			КОГДА НЕ ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовРегл, Статьи.ВариантРаспределенияРасходовРегл) 
	|					В (	
	//++ НЕ УТ
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	//-- НЕ УТ
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|					)
	|				ТОГДА 0
	|			ИНАЧЕ
	|				ДД.СуммаРегл
	|		КОНЕЦ) КАК СуммаРегл,
	//++ НЕ УТ
	|	СУММА(ВЫБОР
	|			КОГДА ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовРегл, Статьи.ВариантРаспределенияРасходовРегл) 
	|					В (	
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|					)
	|				ТОГДА ДД.ПостояннаяРазница
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ) + 
	//-- НЕ УТ
	|	0 КАК ПостояннаяРазница,
	//++ НЕ УТ
	|	СУММА(
	|		ВЫБОР
	|			КОГДА ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовРегл, Статьи.ВариантРаспределенияРасходовРегл) 
	|					В (	
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|					)
	|				ТОГДА ДД.СуммаРегл - ДД.ПостояннаяРазница
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ +
	|		ВЫБОР
	|			КОГДА ЕСТЬNULL(ВтОВЗ.ВариантРаспределенияРасходовНУ, Статьи.ВариантРаспределенияРасходовНУ) 
	|					В (	
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности),
	|						ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров)
	|					)
	|				ТОГДА ДД.ПостояннаяРазница + ДД.ВременнаяРазница - ДД.СуммаРегл
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ) +
	//-- НЕ УТ
	|	0 КАК ВременнаяРазница,
	|	СУММА(ДД.СуммаНУ) КАК СуммаНУ,
	|	&СуммаНДД КАК СуммаНДД
	|ПОМЕСТИТЬ СуммыРасходов
	|ИЗ
	|	ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ СуммыРасходовПредварительная КАК ДД
	|		ПО Статьи.Ссылка = ДД.СтатьяРасходов
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтОВЗ КАК ВтОВЗ
	|		ПО ДД.АналитикаРасходов = ВтОВЗ.ОВЗ
	|	
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.Подразделение,
	|	ДД.НаправлениеДеятельности
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	НаправлениеДеятельности,
	|	Подразделение,
	|	СтатьяРасходов,
	|	АналитикаРасходов
	|";
	#КонецОбласти
	
	ТекстЗапроса = РасчетСебестоимостиЛокализация.ИзменитьТекстСуммыПрочихРасходов(ТекстЗапроса, ПараметрыРасчета);
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&СуммаНДД", "0");
	
	Возврат ТекстЗапроса;
КонецФункции

// Корректировка стоимости списания номенклатуры (используется при партионном учета 2.2, 2.1 и при выключенном партионном учете.
// Процедура рассчитывает отклонения в суммах движений по регистру СебестоимостьТоваров от рассчитанной себестоимости 
// и производит корректировку движений следующих регистров:
// СебестоимостьТоваров, ПрочиеРасходы
//
Процедура СкорректироватьСтоимостьСписанияЗапасов(ПараметрыРасчета) Экспорт

	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьСписанияЗапасов");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	#Область ВыборкаДанных
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьСписанияЗапасов_ПодготовкаДанных");
	
	#Область ИсправленныеДокументы
	Запрос.Текст = РасчетСебестоимостиЗаполнениеПартий.ТекстИсправленныеДокументы(); // вт ИсправленныеДокументы
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	#КонецОбласти
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ДвиженияТаблицаКорректировки");
	
	ХозОперацииТаблицыКорректировки  = Новый Массив;
	ХозОперацииТаблицыКорректировки.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику);
	ХозОперацииТаблицыКорректировки.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями);
	ХозОперацииТаблицыКорректировки.Добавить(Перечисления.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой);
	ХозОперацииТаблицыКорректировки.Добавить(Перечисления.ХозяйственныеОперации.ПорчаТоваровСПереоценкой);
	ХозОперацииТаблицыКорректировки.Добавить(Перечисления.ХозяйственныеОперации.РеализацияПереданнойВозвратнойТары);
	ХозОперацииТаблицыКорректировки.Добавить(Перечисления.ХозяйственныеОперации.СторноПереданнойТары);
	ХозОперацииТаблицыКорректировки.Добавить(Перечисления.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад);
	
	Если ПараметрыРасчета.Свойство("УзлыСПереполнениемПоля") Тогда
		УзлыСПереполнениемПоля = ПараметрыРасчета.УзлыСПереполнениемПоля;
	Иначе
		УзлыСПереполнениемПоля = Новый Массив;
	КонецЕсли;
	
	ДопПараметры = ПараметрыРасчета.ДополнительныеПараметрыЗапросаЭтапа;
	ДопПараметры.Вставить("ХозОперацииТаблицыКорректировки", ХозОперацииТаблицыКорректировки);
	ДопПараметры.Вставить("УзлыСПереполнениемПоля", УзлыСПереполнениемПоля);
	ДопПараметры.Вставить("ЗначениеПогрешности", 0.01);
	
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстСкорректироватьСтоимостьСписанияЗапасовПодготовкаДанных(ПараметрыРасчета));
	
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
	
	#КонецОбласти
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьСписанияЗапасов_ФормированиеДвижений");
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	// Корректировка списания товаров
	СформироватьДвиженияСебестоимостьТоваровЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	СформироватьДвиженияСебестоимостьТоваровСписаниеРезервовЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

	// Если есть кор. раздел - необходимо скорректировать стоимость в кор. части.
	СформироватьКорДвиженияСебестоимостьТоваровЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
		
	// Сторнирование себестоимости товаров по управленческой организации.
	СформироватьДвиженияСебестоимостьТоваровСторноВУпрУчетеЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Отражение отклонений фактической стоимости от плановой в регистре "Отклонения в стоимости товаров"
	СформироватьДвиженияОтклоненияВСтоимостиТоваровЗапросом(ПараметрыРасчета, Запрос, "ВтДвиженияОтклоненияВСтоимостиТоваров", СоответствиеВременныхТаблицДвижений);
	
	// Корректировка списания товаров на затраты в регистре учет прочих расходов.
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходов Тогда
		УсловиеГДЕ = "(
		|	(
		|		ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваров),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНедостачЗаСчетПоклажедателя),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОприходованиеИзлишковТоваровВПользуКомитента),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОприходованиеИзлишковТоваровВПользуПоклажедателя),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтгруженныхТоваров),
		//++ НЕ УТ
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровУПереработчика),
		//++ НЕ УТКА
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровДавальцаЗаСчетДавальца),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровДавальцаНаРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями),
		//-- НЕ УТКА
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставОС),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставНМА),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПроизводственныхЗатрат),
		//-- НЕ УТ
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаПрочиеЦели),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионераОСписании))
		|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
		|			И (НЕ КорОрганизация ЕСТЬ NULL И КорОрганизация <> Неопределено И КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
		|	)
		|)
		| И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
		| И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|";
	
		УсловиеГДЕПрочиеРасходы = УсловиеГДЕ + "
		| И (НЕ СтатьяРасходовСписания ЕСТЬ NULL 
		|		И СтатьяРасходовСписания <> Неопределено 
		|		И СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|		И СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка))
		|";
		
		СтруктураТекстовСуммовыхПоказателей = Новый Структура;
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСумма", "(СуммаСНДС + ВЫБОР КОГДА ЭтоВыпускПродукции ТОГДА ИсходнаяСтоимость ИНАЧЕ 0 КОНЕЦ)");
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаБезНДС", "(СуммаБезНДС + ВЫБОР КОГДА ЭтоВыпускПродукции ТОГДА ИсходнаяСтоимостьБезНДС ИНАЧЕ 0 КОНЕЦ)");
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаРегл", "(СуммаРегл + ВЫБОР КОГДА ЭтоВыпускПродукции ТОГДА ИсходнаяСтоимостьРегл ИНАЧЕ 0 КОНЕЦ)");
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаУпр", "(СуммаУпр + ВЫБОР КОГДА ЭтоВыпускПродукции ТОГДА ИсходнаяСтоимостьУпр ИНАЧЕ 0 КОНЕЦ)");
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстПостояннаяРазница", "ПостояннаяРазница");
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстВременнаяРазница", "ВременнаяРазница");
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаНДД", "СуммаНДД");
		
		СформироватьДвиженияПрочиеРасходыЗапросом(ПараметрыРасчета, "ВтПрочиеРасходыНаЗатраты", СоответствиеВременныхТаблицДвижений, УсловиеГДЕПрочиеРасходы,
			СтруктураТекстовСуммовыхПоказателей);

	КонецЕсли;
	
	СформироватьДвиженияПрочиеАктивыПассивыЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений);
	СформироватьДвиженияПоПрочимАктивамПассивамЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений);
	
	// Формирование прочих доходов/расходов при отклонениях в стоимости товаров
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходов Тогда
		
		УсловиеГДЕ = "
		|	(
		|		ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровПоставщику),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПорчаТоваровСПереоценкой),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияПереданнойВозвратнойТары),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТары),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаПартийТоваров),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасхожденийПоступлениеПриобретение),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОприходованиеИзлишковОтгруженныхТоваров),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНедостачЗаСчетКомитента))
		|		ИЛИ ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеДоходы)
		|		ИЛИ ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
		|	)
		|	И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
		|	И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.МатериалыПринятыеВПереработку)
		|	";
		
		СтруктураТекстовСуммовыхПоказателей = Новый Структура;
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСумма", "СуммаСНДС");
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаБезНДС", "СуммаБезНДС");
		СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаУпр", "СуммаУпр");
		
		СформироватьДвиженияПрочиеРасходыВУпрУчетеЗапросом(ПараметрыРасчета, "ВтПрочиеРасходыВозвратПоставщикуУпр", СоответствиеВременныхТаблицДвижений, 
			УсловиеГДЕ + "
				|	И (НЕ СтатьяРасходовСписанияУпр ЕСТЬ NULL 
				|		И СтатьяРасходовСписанияУпр <> Неопределено 
				|		И СтатьяРасходовСписанияУпр <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
				|		И СтатьяРасходовСписанияУпр <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
				|	)"
				,
			СтруктураТекстовСуммовыхПоказателей);

		СформироватьДвиженияПрочиеДоходыВУпрУчетеЗапросом(ПараметрыРасчета, "ВтПрочиеДоходыВозвратПоставщикуУпр", СоответствиеВременныхТаблицДвижений, 
			УсловиеГДЕ + "
				|	И (НЕ СтатьяДоходовУпр ЕСТЬ NULL 
				|		И СтатьяДоходовУпр <> Неопределено 
				|		И СтатьяДоходовУпр <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
				|	)"
				,
			"-СуммаСНДС",
			"- СуммаУпр");
	
		// Формирование прочих доходов/расходов при отклонения в стоимости товаров.
		Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
			
			СтруктураТекстовСуммовыхПоказателей = Новый Структура;
			СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСумма", "0");
			СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаБезНДС", "0");
			СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаУпр", "0");
			СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаРегл", "СуммаРегл");
			СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстПостояннаяРазница", "ПостояннаяРазница");
			СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстВременнаяРазница", "ВременнаяРазница");
			СтруктураТекстовСуммовыхПоказателей.Вставить("ТекстСуммаНДД", "СуммаНДД");
			
			СформироватьДвиженияПрочиеРасходыЗапросом(ПараметрыРасчета, "ВтПрочиеРасходыВозвратПоставщику", СоответствиеВременныхТаблицДвижений, 
				УсловиеГДЕ + "
					|	И (НЕ СтатьяРасходовСписания ЕСТЬ NULL 
					|		И СтатьяРасходовСписания <> Неопределено 
					|		И СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
					|		И СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
					|	)"
					,
				СтруктураТекстовСуммовыхПоказателей);

			СформироватьДвиженияПрочиеДоходыЗапросом(ПараметрыРасчета, "ВтПрочиеДоходыВозвратПоставщику", СоответствиеВременныхТаблицДвижений, 
				УсловиеГДЕ + "
					|	И (НЕ СтатьяДоходов ЕСТЬ NULL 
					|		И СтатьяДоходов <> Неопределено 
					|		И СтатьяДоходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
					|	)"
					,
				"0",
				"- СуммаРегл",
				"0");

		КонецЕсли;
				
	КонецЕсли;			
	
	// Восстановление резервов под обесценение запасов.
	// Отклонения фактической стоимости выпущенной продукции от плановой.
	СформироватьДвиженияВыручкаИСебестоимостьПродажЗапросом(ПараметрыРасчета, Запрос, "ВтДвиженияВыручкаИСебестоимостьРезервыИОтклонения", СоответствиеВременныхТаблицДвижений);
	
	// Корректировка движений по оборотным регистрам управленческого учета.
	СформироватьДвиженияПоОборотнымРегистрамУпрУчетаЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	//++ НЕ УТ
	
	// Формирование движений по регистру сведений СтоимостьТМЦВЭксплуатации
	СформироватьДвиженияСтоимостьТМЦВЭксплуатацииЗапросом(ПараметрыРасчета, Запрос, "ВтСтоимостьТМЦВЭксплуатации", СоответствиеВременныхТаблицДвижений);
	
	//-- НЕ УТ
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

Функция ТекстСкорректироватьСтоимостьСписанияЗапасовПодготовкаДанных(ПараметрыРасчета)
	
	ТекстЗапроса = "";
	
	#Область ЕстьВозвратныеОтходы
	
	ТекстЗапроса = ТекстЗапроса + РасчетСебестоимостиРешениеСЛУ.ТекстВтЕстьВозвратныеОтходы() + ";";
	
	#КонецОбласти
	
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	#Область РаботыДляДавальца
	
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Регистратор,
	|	ДД.РазделУчета,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ДД.ВидЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.КорАналитикаУчетаНоменклатуры,
	|	ДД.КорВидЗапасов,
	|	ДД.АналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
	|	ИСТИНА КАК РаботаДляДавальца
	|ПОМЕСТИТЬ
	|	РаботыДляДавальца
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия)
	|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|	И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	И ДД.КорАналитикаУчетаНоменклатуры <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|	И НЕ ДД.Сторно
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	КорАналитикаУчетаНоменклатуры,
	|	КорВидЗапасов
	|;";
	#КонецОбласти
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	
	#Область РеквизитыКорДвижений
	
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ДД.Организация КАК Организация,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	ДД.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета КАК РазделУчета,
	|	МАКСИМУМ(ДД.КорАналитикаУчетаНоменклатуры) КАК КорАналитикаУчетаНоменклатуры,
	|	МАКСИМУМ(ДД.ХозяйственнаяОперация) КАК ХозяйственнаяОперация,
	|	МАКСИМУМ(ДД.ТипЗаписи) КАК ТипЗаписи,
	|	МАКСИМУМ(ДД.НастройкаХозяйственнойОперации) КАК НастройкаХозяйственнойОперации
	|
	|ПОМЕСТИТЬ РеквизитыКорДвижений
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.СлужебноеВидДвиженияПриход
	|	И ДД.Количество <> 0
	|	И ДД.ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)
	|	И ДД.НастройкаХозяйственнойОперации <> ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка)
	|СГРУППИРОВАТЬ ПО
	|	ДД.Организация,
	|	ДД.Регистратор,
	|	ДД.ИдентификаторФинЗаписи,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	ИдентификаторФинЗаписи,
	|	АналитикаУчетаНоменклатуры,
	|	Организация
	|;";
	#КонецОбласти
	
	#Область ВТАналитикиУчетаНоменклатуры
	// Оптимизация присоединения ВТКэшРасчетныеОборотыСебестоимостьТоваров к справочникам КлючиАналитикиУчетаНоменклатуры и НаправленияДеятельности,
	// с учетом составного типа колонок АналитикаУчетаНоменклатуры и КорАналитикаУчетаНоменклатуры в ВТКэшРасчетныеОборотыСебестоимостьТоваров.
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫРАЗИТЬ(ДД.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры) КАК Ссылка
	|ПОМЕСТИТЬ ВТИспользуемыеАналитикиУчетаНоменклатуры
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(ДД.АналитикаУчетаНоменклатуры) = ТИП(Справочник.КлючиАналитикиУчетаНоменклатуры)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВЫРАЗИТЬ(ДД.КорАналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры)
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(ДД.КорАналитикаУчетаНоменклатуры) = ТИП(Справочник.КлючиАналитикиУчетаНоменклатуры)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ИспользуемыеАналитикиУчетаНоменклатуры.Ссылка КАК Ссылка,
	|	КлючиАналитикиУчетаНоменклатуры.МестоХранения КАК МестоХранения,
	|	КлючиАналитикиУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	КлючиАналитикиУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	КлючиАналитикиУчетаНоменклатуры.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности
	|ПОМЕСТИТЬ ВТАналитикиУчетаНоменклатуры
	|ИЗ
	|	ВТИспользуемыеАналитикиУчетаНоменклатуры КАК ИспользуемыеАналитикиУчетаНоменклатуры
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КлючиАналитикиУчетаНоменклатуры
	|		ПО ИспользуемыеАналитикиУчетаНоменклатуры.Ссылка = КлючиАналитикиУчетаНоменклатуры.Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТИспользуемыеАналитикиУчетаНоменклатуры
	|;";
	
	#КонецОбласти
	
	#Область ВтТаблицаКорректировки
	
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	УчетСебестоимости.Период                        	КАК Период,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ                   							КАК ВидДвижения,
	|	ВЫБОР КОГДА УчетСебестоимости.Организация В(&ОрганизацииСреднескользящая)
	|		ТОГДА РегистраторыРасчета.Ссылка
	|		ИНАЧЕ УчетСебестоимости.Регистратор
	|	КОНЕЦ 												КАК ДокументДвижения,
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка,
	|		ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка)) КАК ДокументРасчета,
	|	УчетСебестоимости.Организация                   	КАК Организация,
	|	АналитикаНоменклатуры.МестоХранения             	КАК Склад,
	|	АналитикаНоменклатуры.Номенклатура             		КАК Номенклатура,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры    	КАК АналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		 И УчетСебестоимости.Количество < 0
	|		 И НЕ ЕстьВозвратныеОтходы.Организация ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) // возвратные отходы учитываем по пустому разделу учета
	|		ИНАЧЕ УчетСебестоимости.РазделУчета КОНЕЦ) КАК РазделУчета,
	|	УчетСебестоимости.ВидЗапасов                    	КАК ВидЗапасов,
	|	ЕСТЬNULL(УчетСебестоимости.ВидЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) КАК ТипЗапасов,
	|	УчетСебестоимости.ХозяйственнаяОперация				КАК ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры 	КАК КорАналитикаУчетаНоменклатуры,
	|	КорАналитикаНоменклатуры.МестоХранения          	КАК КорСклад,
	|	КорАналитикаНоменклатуры.Номенклатура           	КАК КорНоменклатура,
	// При использовании среднескользящей стоимости из раздела "Выпуск продукции" разница между фактической и плановой стоимостью
	// отражается в регистре "Отклонения в стоимости товаров", поэтому поле КорРазделУчета не заполняется.
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		ИНАЧЕ УчетСебестоимости.КорРазделУчета КОНЕЦ)   КАК КорРазделУчета,
	|	УчетСебестоимости.КорВидЗапасов                 	КАК КорВидЗапасов,
	|	ЕСТЬNULL(УчетСебестоимости.КорВидЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) КАК КорТипЗапасов,
	|	УчетСебестоимости.КорОрганизация                	КАК КорОрганизация,
	|	УчетСебестоимости.Подразделение                 	КАК Подразделение,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам     	КАК АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента                  	КАК ЗаказКлиента,
	|	УчетСебестоимости.АналитикаРасходов            		КАК АналитикаРасходов,
	|	УчетСебестоимости.СтатьяРасходовСписания        	КАК СтатьяРасходовСписания,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр		  КАК ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл		  КАК ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ) КАК ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.СтатьяДоходов                 	КАК СтатьяДоходов,
	|	УчетСебестоимости.АналитикаДоходов              	КАК АналитикаДоходов,
	|	УчетСебестоимости.СтатьяАктивовПассивов         	КАК СтатьяАктивовПассивов,
	|	УчетСебестоимости.АналитикаАктивовПассивов      	КАК АналитикаАктивовПассивов,
	|	УчетСебестоимости.ИдентификаторСтроки           	КАК ИдентификаторСтроки,
	|	УчетСебестоимости.КодСтроки                     	КАК КодСтроки,
	|	УчетСебестоимости.ПериодПродажи                 	КАК ПериодПродажи,
	|	УчетСебестоимости.ГруппаПродукции               	КАК ГруппаПродукции,
	|	ЕСТЬNULL(АналитикаНоменклатуры.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности        КАК КорНаправлениеДеятельности,
	|	ВЫБОР КОГДА НЕ СторноОтчетыКомиссионера.Период ЕСТЬ NULL
	|	 И УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|	 И УчетСебестоимости.Количество < 0
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ 												КАК СторноОтчетПоКомиссии,
	|	УчетСебестоимости.Партия                          	КАК Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий              КАК АналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета         КАК АналитикаФинансовогоУчета,
	|	УчетСебестоимости.ВидДеятельностиНДС                КАК ВидДеятельностиНДС,
	|	УчетСебестоимости.КорПартия                 		КАК КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий           КАК КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета      КАК КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.КорВидДеятельностиНДС             КАК КорВидДеятельностиНДС,
	|	УчетСебестоимости.ВидДеятельностиНДСОтгрузки        КАК ВидДеятельностиНДСОтгрузки,
	|	УчетСебестоимости.СтатьяКалькуляции                 КАК СтатьяКалькуляции,
	|	УчетСебестоимости.ТипЗаписи                 		КАК ТипЗаписи,
	// В суммовых движениях поле ДокументИсточник не заполняем для исключения возникновения лишний округлений
	// при разбивке исходного количества на разные документы источники.
	|	НЕОПРЕДЕЛЕНО                                        КАК ДокументИсточник,
	// Для организаций на среднескользящей признак Сторно не заполняется, т.к. движения формируются под служебным
	// документом "Регистратор расчета себестоимости" и это расчетные движения, а не сторно движения исправленного документа.
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ УчетСебестоимости.Сторно КОНЕЦ			КАК Сторно,
	|	УчетСебестоимости.НастройкаХозяйственнойОперации	КАК НастройкаХозяйственнойОперации,
	|	УчетСебестоимости.ИдентификаторФинЗаписи			КАК ИдентификаторФинЗаписи,
	|	УчетСебестоимости.НастройкаСчетовУчета              КАК НастройкаСчетовУчета,
	|	УчетСебестоимости.ОперацияУчетаСебестоимости        КАК ОперацияУчетаСебестоимости,
	|	УчетСебестоимости.СпособОпределенияСебестоимости    КАК СпособОпределенияСебестоимости,
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	ЕСТЬNULL(РаботыДляДавальца.РаботаДляДавальца, ЛОЖЬ) КАК ПродукцияДавальца,
	|	ЛОЖЬ												КАК РаботаДляДавальца,
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	
	|	ВЫБОР
	// Выпуск продукции по плановой стоимости, если отклонения списываются на себестоимость продаж.
	// Резервы под обеспечение запасов списываются на себестоимость продаж при выпуске продукции.
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	// Условия формирования поля ВосстанавливатьРезервы должны соответствовать условиям формирования аналогичного поля
	// в функции ТекстВтТаблицаСвязейПостатейныеРасходы() #Область ТекстЗапросаСписаниеМатериаловНаСтатьи.
	|		КОГДА УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|			ТОГДА ИСТИНА
	|		КОГДА УчетСебестоимости.Организация В (&ОрганизацииСВосстановлениемРезервовПриСписанииЗапасовНаРасходы)
	|		 И НЕ УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВосстанавливатьРезервы,
	|
	|	ЕСТЬNULL(РеквизитыКорДвижений.ХозяйственнаяОперация,
	|		УчетСебестоимости.ХозяйственнаяОперация)        КАК ПриходХозяйственнаяОперация,
	|	ЕСТЬNULL(РеквизитыКорДвижений.ТипЗаписи,
	|		УчетСебестоимости.ТипЗаписи)                    КАК ПриходТипЗаписи,
	|	ЕСТЬNULL(РеквизитыКорДвижений.НастройкаХозяйственнойОперации,
	|		УчетСебестоимости.НастройкаХозяйственнойОперации) КАК ПриходНастройкаХозяйственнойОперации,
	|	ЕСТЬNULL(РеквизитыКорДвижений.КорАналитикаУчетаНоменклатуры,
	|		УчетСебестоимости.КорАналитикаУчетаНоменклатуры) КАК ПриходКорАналитикаУчетаНоменклатуры,
	|
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	|
	|	СУММА(УчетСебестоимости.Количество)        			КАК Количество,
	|	СУММА(УчетСебестоимости.Стоимость)              	КАК Стоимость,
	|	СУММА(УчетСебестоимости.СтоимостьБезНДС)        	КАК СтоимостьБезНДС,
	|	СУММА(УчетСебестоимости.СтоимостьРегл)          	КАК СтоимостьРегл,
	|	СУММА(УчетСебестоимости.ДопРасходы)					КАК ДопРасходы,
	|	СУММА(УчетСебестоимости.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
	|	СУММА(УчетСебестоимости.ДопРасходыРегл)				КАК ДопРасходыРегл,
	|	СУММА(УчетСебестоимости.Трудозатраты)				КАК Трудозатраты,
	|	СУММА(УчетСебестоимости.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
	|	СУММА(УчетСебестоимости.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
	|	СУММА(УчетСебестоимости.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
	|	СУММА(УчетСебестоимости.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
	|	СУММА(УчетСебестоимости.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
	|	СУММА(УчетСебестоимости.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(УчетСебестоимости.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
	|	СУММА(УчетСебестоимости.ПостояннаяРазница)      	КАК ПостояннаяРазница,
	|	СУММА(УчетСебестоимости.ВременнаяРазница)       	КАК ВременнаяРазница,
	|	СУММА(УчетСебестоимости.СтоимостьНДД)       		КАК СтоимостьНДД,
	|	СУММА(УчетСебестоимости.СтоимостьЗабалансовая)      КАК СтоимостьЗабалансовая,
	|	СУММА(УчетСебестоимости.СтоимостьЗабалансоваяРегл)  КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(УчетСебестоимости.РезервПодОбесценениеРегл)   КАК РезервПодОбесценениеРегл,
	|	СУММА(УчетСебестоимости.РезервПодОбесценениеУпр)    КАК РезервПодОбесценениеУпр,
	|	СУММА(УчетСебестоимости.КорСтоимость)           	КАК КорСтоимость,
	|	СУММА(УчетСебестоимости.НДСРегл)           			КАК НДСРегл,
	|	СУММА(УчетСебестоимости.СтоимостьУпр)				КАК СтоимостьУпр,
	|	СУММА(УчетСебестоимости.ДопРасходыУпр)				КАК ДопРасходыУпр,
	|	СУММА(УчетСебестоимости.ТрудозатратыУпр)			КАК ТрудозатратыУпр,
	|	СУММА(УчетСебестоимости.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
	|	СУММА(УчетСебестоимости.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
	|	СУММА(УчетСебестоимости.НДСУпр)           			КАК НДСУпр
	|ПОМЕСТИТЬ ВтТаблицаКорректировки
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО УчетСебестоимости.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО УчетСебестоимости.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТАналитикиУчетаНоменклатуры КАК КорАналитикаНоменклатуры
	|		ПО УчетСебестоимости.КорАналитикаУчетаНоменклатуры = КорАналитикаНоменклатуры.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ СторноОтчетыКомиссионера КАК СторноОтчетыКомиссионера // Создается в процедуре СкорректироватьСтоимостьВозвратовПрошлыхПериодов()
	|		ПО СторноОтчетыКомиссионера.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И СторноОтчетыКомиссионера.РазделУчета = УчетСебестоимости.РазделУчета
	|		И СторноОтчетыКомиссионера.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И СторноОтчетыКомиссионера.Организация = УчетСебестоимости.Организация
	|		И УчетСебестоимости.Количество < 0
	|		И УчетСебестоимости.ДокументИсточник = НЕОПРЕДЕЛЕНО

	|	ЛЕВОЕ СОЕДИНЕНИЕ ЕстьВозвратныеОтходы КАК ЕстьВозвратныеОтходы
	|		ПО ЕстьВозвратныеОтходы.Организация = УчетСебестоимости.Организация
	|		И ЕстьВозвратныеОтходы.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И ЕстьВозвратныеОтходы.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И ЕстьВозвратныеОтходы.РазделУчета = УчетСебестоимости.РазделУчета
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	ЛЕВОЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
	|		ПО РаботыДляДавальца.Регистратор = УчетСебестоимости.Регистратор
	|		И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры = УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|		И РаботыДляДавальца.КорВидЗапасов = УчетСебестоимости.КорВидЗапасов
	|		И РаботыДляДавальца.КорАналитикаУчетаПартий = УчетСебестоимости.КорАналитикаУчетаПартий
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|	ЛЕВОЕ СОЕДИНЕНИЕ РеквизитыКорДвижений КАК РеквизитыКорДвижений
	|		ПО ВЫБОР КОГДА УчетСебестоимости.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				ТОГДА РеквизитыКорДвижений.Организация = УчетСебестоимости.Организация
	|				ИНАЧЕ РеквизитыКорДвижений.Организация = УчетСебестоимости.КорОрганизация
	|			КОНЕЦ
	|		И РеквизитыКорДвижений.Регистратор = УчетСебестоимости.Регистратор
	|		И РеквизитыКорДвижений.ИдентификаторФинЗаписи = УчетСебестоимости.ИдентификаторФинЗаписи
	|		И РеквизитыКорДвижений.АналитикаУчетаНоменклатуры = УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|		И РеквизитыКорДвижений.РазделУчета = УчетСебестоимости.КорРазделУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = УчетСебестоимости.Период
	|		И РассчитанныеДокументы.Регистратор = УчетСебестоимости.Регистратор
	|		И &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = УчетСебестоимости.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтДатыДокументовИсточников КАК Реестр
	|		ПО Реестр.Ссылка = УчетСебестоимости.ДокументИсточник
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = УчетСебестоимости.Регистратор
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументыПоДокументуИсточнику
	|		ПО ИсправленныеДокументыПоДокументуИсточнику.СторнируемыйДокумент = УчетСебестоимости.Регистратор
	|ГДЕ
	|	(НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		И НЕ УчетСебестоимости.ТипЗаписи В (ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Партия),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимости),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимостиНаПрочиеДоходы),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимостиНаПрочиеРасходы),
	|		 									ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаСтоимости),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыСПартией),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДопРасходыБезПартии),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноДопРасходов),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеАкцизаВСтоимость),
	|											ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретенияПрошлогоПериода))
	|		ИЛИ (УчетСебестоимости.Количество <> 0
	|			 И УчетСебестоимости.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализацииВозвратНаДругойСклад),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
	|			 И НЕ УчетСебестоимости.Сторно
	|		ИЛИ УчетСебестоимости.Количество <> 0
	|			И УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СторноВозвратНаДругойСклад)
	|			)
	// При расчете себестоимости сторнируется плановая стоимость выпуска, т.к. фактическая себестоимость формируется от стоимости
	// списания материалов и рассчитать отклонения от плановой стоимости не представляется возможным. 
	|		ИЛИ УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтражениеПлановойСтоимостиВыпуска)
	|			И &РежимЗакрытияМесяца <> ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|	)
	|	И (УчетСебестоимости.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
	|		ИЛИ УчетСебестоимости.ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.ВыбытиеПоФиксированнойСтоимости)
	|		ИЛИ УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаПартийТоваров))
	// Исключаем возвраты прошлого периода.
	// Условия выборки данных должны соответствовать функции СкорректироватьСтоимостьВозвратовПрошлыхПериодов()
	|	И НЕ (НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			И УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|			И УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратБезДокументаИсточника)
	|			И УчетСебестоимости.ДокументИсточник <> НЕОПРЕДЕЛЕНО
	|			И Реестр.ДатаДокументаИБ < &НачалоПериода
	|			)
	|	И НЕ (НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			И УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|			И УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратБезДокументаИсточника)
	|			И УчетСебестоимости.ДокументИсточник = НЕОПРЕДЕЛЕНО
	|			И (ЕСТЬNULL(СторноОтчетыКомиссионера.Период,
	|				НАЧАЛОПЕРИОДА(УчетСебестоимости.ПериодПродажи, МЕСЯЦ)) <> ДАТАВРЕМЯ(1,1,1,0,0,0)
	// Дополнительно надо исключить суммовое движение, сформированное в СкорректироватьСтоимостьВозвратовПрошлыхПериодов()
	|					ИЛИ УчетСебестоимости.РасчетСебестоимости)
	|			И УчетСебестоимости.ПериодПродажи < &НачалоПериода)
	//++ НЕ УТ
	
	//++ Устарело_Переработка24
	|	И НЕ (УчетСебестоимости.Регистратор ССЫЛКА Документ.ПоступлениеОтПереработчика
	|		И НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		И УчетСебестоимости.ДокументДвижения = УчетСебестоимости.Регистратор)
	// Исключаем сторно онлайн движений отчета переработчика, которые не требуют расчета стоимости.
	// В таких движениях заполнен реквизит ДокументДвижения.
	|	И НЕ (ТИПЗНАЧЕНИЯ(УчетСебестоимости.Регистратор) = ТИП(Документ.Сторно)
	|		И ТИПЗНАЧЕНИЯ(УчетСебестоимости.ДокументИсточник) = ТИП(Документ.ОтчетПереработчика)
	|		И УчетСебестоимости.ДокументДвижения = УчетСебестоимости.ДокументИсточник)
	|	И НЕ (ТИПЗНАЧЕНИЯ(УчетСебестоимости.Регистратор) = ТИП(Документ.ОтчетПереработчика)
	|		И НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		И УчетСебестоимости.ДокументДвижения = УчетСебестоимости.Регистратор)
	//-- Устарело_Переработка24
	|
	//-- НЕ УТ
	
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеСебестоимостьТоваров
	// Кроме движений по разделу учета "Выпуск продукции" при использовании метода "Среднескользящая", т.к. при этом методе исходные
	// движения сформированы у регистраторов расчета себестоимости и по ним не формируются Сторно движения
	// в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() 
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаСторнируемогоДокумента ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|		И УчетСебестоимости.Сторно
	|		И НЕ (УчетСебестоимости.Организация В (&ОрганизацииСреднескользящая)
	|			И УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(ПЕречисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции))
	|	)
	|
	|	И НЕ (УчетСебестоимости.Сторно
	|		И УчетСебестоимости.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|		И УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость))
	// Исключаем расчет отклонений для выбытия по фиксированной стоимости, если для записи не была подобрана партия.
	// Расчет отклонений в стоимости такой записи будет выполнен в этапе пересортицы партий товаров.
	// Условия выборки данных должны соответствовать функции см. РасчетСебестоимостиРешениеСЛУ.ТекстВтУзлыКорректировки_МатериальныеИТрудозатраты
	|	И НЕ (УчетСебестоимости.ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.ВыбытиеПоФиксированнойСтоимости)
	|		И УчетСебестоимости.РасчетНеЗавершен
	|		И УчетСебестоимости.Стоимость <> 0)
	|
	// Исключаем списания на расходы и передачу продукции из производства по фиксированной стоимости.
	|	И НЕ УчетСебестоимости.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость))
	// При предварительном расчете исключаем документы, для которых сохранены ранее рассчитанные движения
	|	И РассчитанныеДокументы.Регистратор ЕСТЬ NULL
	// Исключаем корректировку плановой стоимости выпуска.
	|	И НЕ (УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтражениеПлановойСтоимостиВыпуска)
	|		И УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции))
	|	И УчетСебестоимости.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СлужебноеИзменениеМетодаОценкиСтоимости)
	// Исключаем сторно документов возврата товаров от клиента (исправлений по ним нет, только сторно).
	|	И НЕ (ИсправленныеДокументыПоДокументуИсточнику.СторнируемыйДокумент ЕСТЬ НЕ NULL
	|		И ТИПЗНАЧЕНИЯ(УчетСебестоимости.Регистратор) = ТИП(Документ.ВозвратТоваровОтКлиента))
	|	
	|СГРУППИРОВАТЬ ПО
	|	УчетСебестоимости.Период,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ,
	|	ВЫБОР КОГДА УчетСебестоимости.Организация В(&ОрганизацииСреднескользящая)
	|		ТОГДА РегистраторыРасчета.Ссылка
	|		ИНАЧЕ УчетСебестоимости.Регистратор
	|	КОНЕЦ,
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка,
	|		ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка)), // ДокументРасчета
	|	УчетСебестоимости.Организация,
	|	АналитикаНоменклатуры.МестоХранения,
	|	АналитикаНоменклатуры.Номенклатура,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		 И УчетСебестоимости.Количество < 0
	|		 И НЕ ЕстьВозвратныеОтходы.Организация ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) // возвратные отходы учитываем по пустому разделу учета
	|			ИНАЧЕ УчетСебестоимости.РазделУчета КОНЕЦ),
	|	УчетСебестоимости.ВидЗапасов,
	|	ЕСТЬNULL(УчетСебестоимости.ВидЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)),
	|	УчетСебестоимости.ХозяйственнаяОперация,
	|	УчетСебестоимости.КорАналитикаУчетаНоменклатуры,
	|	КорАналитикаНоменклатуры.МестоХранения,
	|	КорАналитикаНоменклатуры.Номенклатура,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		ИНАЧЕ УчетСебестоимости.КорРазделУчета КОНЕЦ), // КорРазделУчета
	|	УчетСебестоимости.КорВидЗапасов,
	|	ЕСТЬNULL(УчетСебестоимости.КорВидЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)),
	|	УчетСебестоимости.КорОрганизация,
	|	УчетСебестоимости.Подразделение,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента,
	|	УчетСебестоимости.АналитикаРасходов,
	|	УчетСебестоимости.СтатьяРасходовСписания,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ),
	|	УчетСебестоимости.СтатьяДоходов,
	|	УчетСебестоимости.АналитикаДоходов,
	|	УчетСебестоимости.СтатьяАктивовПассивов,
	|	УчетСебестоимости.АналитикаАктивовПассивов,
	|	УчетСебестоимости.ИдентификаторСтроки,
	|	УчетСебестоимости.КодСтроки,
	|	УчетСебестоимости.ПериодПродажи,
	|	УчетСебестоимости.ГруппаПродукции,
	|	ЕСТЬNULL(АналитикаНоменклатуры.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
	|	УчетСебестоимости.КорНаправлениеДеятельности,
	|	ВЫБОР КОГДА НЕ СторноОтчетыКомиссионера.Период ЕСТЬ NULL
	|	 И УчетСебестоимости.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|	 И УчетСебестоимости.Количество < 0
	|		ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	УчетСебестоимости.ВидДеятельностиНДС,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	УчетСебестоимости.КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.КорВидДеятельностиНДС,
	|	УчетСебестоимости.ВидДеятельностиНДСОтгрузки,
	|	УчетСебестоимости.СтатьяКалькуляции,
	|	УчетСебестоимости.ТипЗаписи,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ УчетСебестоимости.Сторно КОНЕЦ, // Сторно
	|	УчетСебестоимости.НастройкаХозяйственнойОперации,
	|	УчетСебестоимости.ИдентификаторФинЗаписи,
	|	УчетСебестоимости.НастройкаСчетовУчета,
	|	УчетСебестоимости.ОперацияУчетаСебестоимости,
	|	УчетСебестоимости.СпособОпределенияСебестоимости,
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	ЕСТЬNULL(РаботыДляДавальца.РаботаДляДавальца, ЛОЖЬ),
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		КОГДА УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|			ТОГДА ИСТИНА
	|		КОГДА УчетСебестоимости.Организация В (&ОрганизацииСВосстановлениемРезервовПриСписанииЗапасовНаРасходы)
	|		 И НЕ УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ, // ВосстанавливатьРезервы
	|	ЕСТЬNULL(РеквизитыКорДвижений.ХозяйственнаяОперация,
	|		УчетСебестоимости.ХозяйственнаяОперация), // ПриходХозяйственнаяОперация
	|	ЕСТЬNULL(РеквизитыКорДвижений.ТипЗаписи,
	|		УчетСебестоимости.ТипЗаписи),
	|	ЕСТЬNULL(РеквизитыКорДвижений.НастройкаХозяйственнойОперации,
	|		УчетСебестоимости.НастройкаХозяйственнойОперации), // ПриходНастройкаХозяйственнойОперации
	|	ЕСТЬNULL(РеквизитыКорДвижений.КорАналитикаУчетаНоменклатуры,
	|		УчетСебестоимости.КорАналитикаУчетаНоменклатуры), // ПриходКорАналитикаУчетаНоменклатуры
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) // СписыватьОтклоненияНаСебестоимостьПродаж
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	УчетСебестоимости.Период                        	КАК Период,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ                   							КАК ВидДвижения,
	|	ВЫБОР КОГДА УчетСебестоимости.Организация В(&ОрганизацииСреднескользящая)
	|		ТОГДА РегистраторыРасчета.Ссылка
	|		ИНАЧЕ УчетСебестоимости.Регистратор
	|	КОНЕЦ 												КАК ДокументДвижения,
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка,
	|		ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка)) КАК ДокументРасчета,
	|	УчетСебестоимости.Организация                   	КАК Организация,
	|	АналитикаНоменклатуры.МестоХранения             	КАК Склад,
	|	АналитикаНоменклатуры.Номенклатура             		КАК Номенклатура,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры    	КАК АналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		 И УчетСебестоимости.Количество < 0
	|		 И НЕ ЕстьВозвратныеОтходы.Организация ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) // возвратные отходы учитываем по пустому разделу учета
	|		ИНАЧЕ УчетСебестоимости.РазделУчета КОНЕЦ) КАК РазделУчета,
	|	УчетСебестоимости.ВидЗапасов                    	КАК ВидЗапасов,
	|	УчетСебестоимости.ВидЗапасов.ТипЗапасов            	КАК ТипЗапасов,
	|	УчетСебестоимости.ХозяйственнаяОперация         	КАК ХозяйственнаяОперация,
	|	РаботыДляДавальца.АналитикаУчетаНоменклатуры 		КАК КорАналитикаУчетаНоменклатуры,
	|	КорАналитикаНоменклатуры.МестоХранения          	КАК КорСклад,
	|	КорАналитикаНоменклатуры.Номенклатура           	КАК КорНоменклатура,
	|	РаботыДляДавальца.РазделУчета                		КАК КорРазделУчета,
	|	РаботыДляДавальца.ВидЗапасов                 		КАК КорВидЗапасов,
	|	РаботыДляДавальца.ТипЗапасов         				КАК КорТипЗапасов,
	|	УчетСебестоимости.КорОрганизация                	КАК КорОрганизация,
	|	УчетСебестоимости.Подразделение                 	КАК Подразделение,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам     	КАК АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента                  	КАК ЗаказКлиента,
	|	УчетСебестоимости.АналитикаРасходов            		КАК АналитикаРасходов,
	|	УчетСебестоимости.СтатьяРасходовСписания        	КАК СтатьяРасходовСписания,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр		  КАК ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл		  КАК ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ) КАК ПринятиеКНалоговомуУчету,
	|	УчетСебестоимости.СтатьяДоходов                 	КАК СтатьяДоходов,
	|	УчетСебестоимости.АналитикаДоходов              	КАК АналитикаДоходов,
	|	УчетСебестоимости.СтатьяАктивовПассивов         	КАК СтатьяАктивовПассивов,
	|	УчетСебестоимости.АналитикаАктивовПассивов      	КАК АналитикаАктивовПассивов,
	|	УчетСебестоимости.ИдентификаторСтроки           	КАК ИдентификаторСтроки,
	|	УчетСебестоимости.КодСтроки                     	КАК КодСтроки,
	|	УчетСебестоимости.ПериодПродажи                 	КАК ПериодПродажи,
	|	УчетСебестоимости.ГруппаПродукции               	КАК ГруппаПродукции,
	|	ЕСТЬNULL(АналитикаНоменклатуры.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	УчетСебестоимости.КорНаправлениеДеятельности        КАК КорНаправлениеДеятельности,
	|	ЛОЖЬ 												КАК СторноОтчетПоКомиссии,
	|	УчетСебестоимости.Партия                          	КАК Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий              КАК АналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета         КАК АналитикаФинансовогоУчета,
	|	УчетСебестоимости.ВидДеятельностиНДС                КАК ВидДеятельностиНДС,
	|	УчетСебестоимости.КорПартия                 		КАК КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий           КАК КорАналитикаУчетаПартий,
	|	РаботыДляДавальца.АналитикаФинансовогоУчета         КАК КорАналитикаФинансовогоУчета,
	|	УчетСебестоимости.КорВидДеятельностиНДС             КАК КорВидДеятельностиНДС,
	|	УчетСебестоимости.ВидДеятельностиНДСОтгрузки        КАК ВидДеятельностиНДСОтгрузки,
	|	УчетСебестоимости.СтатьяКалькуляции                 КАК СтатьяКалькуляции,
	|	УчетСебестоимости.ТипЗаписи                 		КАК ТипЗаписи,
	|	УчетСебестоимости.ДокументИсточник                 	КАК ДокументИсточник,
	|	УчетСебестоимости.Сторно                            КАК Сторно,
	// Для продукции из собственного сырья при переработке 2.4 настройка хозяйственной операции заполняется
	// отдельным предопределенным значением для разделения строк с балансовыми и забалансовыми суммами.
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииМатериальные) КАК НастройкаХозяйственнойОперации,
	|	УчетСебестоимости.ИдентификаторФинЗаписи            КАК ИдентификаторФинЗаписи,
	|	УчетСебестоимости.НастройкаСчетовУчета              КАК НастройкаСчетовУчета,
	|	УчетСебестоимости.ОперацияУчетаСебестоимости        КАК ОперацияУчетаСебестоимости,
	|	УчетСебестоимости.СпособОпределенияСебестоимости    КАК СпособОпределенияСебестоимости,
	|	ЛОЖЬ												КАК ПродукцияДавальца,
	|	ИСТИНА												КАК РаботаДляДавальца,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ВосстанавливатьРезервы,
	|
	|	ЕСТЬNULL(РеквизитыКорДвижений.ХозяйственнаяОперация,
	|		УчетСебестоимости.ХозяйственнаяОперация)        КАК ПриходХозяйственнаяОперация,
	|	ЕСТЬNULL(РеквизитыКорДвижений.ТипЗаписи,
	|		УчетСебестоимости.ТипЗаписи)                    КАК ПриходТипЗаписи,
	// Для продукции из собственного сырья при переработке 2.4 настройка хозяйственной операции заполняется
	// отдельным предопределенным значением для разделения строк с балансовыми и забалансовыми суммами.
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииМатериальные) КАК ПриходНастройкаХозяйственнойОперации,
	|	ЕСТЬNULL(РеквизитыКорДвижений.КорАналитикаУчетаНоменклатуры,
	|		УчетСебестоимости.КорАналитикаУчетаНоменклатуры) КАК ПриходКорАналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	|
	|	СУММА(УчетСебестоимости.Количество)        			КАК Количество,
	|	СУММА(УчетСебестоимости.Стоимость)              	КАК Стоимость,
	|	СУММА(УчетСебестоимости.СтоимостьБезНДС)        	КАК СтоимостьБезНДС,
	|	СУММА(УчетСебестоимости.СтоимостьРегл)          	КАК СтоимостьРегл,
	|	СУММА(УчетСебестоимости.ДопРасходы)					КАК ДопРасходы,
	|	СУММА(УчетСебестоимости.ДопРасходыБезНДС)			КАК ДопРасходыБезНДС,
	|	СУММА(УчетСебестоимости.ДопРасходыРегл)				КАК ДопРасходыРегл,
	|	СУММА(УчетСебестоимости.Трудозатраты)				КАК Трудозатраты,
	|	СУММА(УчетСебестоимости.ТрудозатратыРегл)			КАК ТрудозатратыРегл,
	|	СУММА(УчетСебестоимости.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
	|	СУММА(УчетСебестоимости.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
	|	СУММА(УчетСебестоимости.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
	|	СУММА(УчетСебестоимости.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
	|	СУММА(УчетСебестоимости.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(УчетСебестоимости.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
	|	СУММА(УчетСебестоимости.ПостояннаяРазница)      	КАК ПостояннаяРазница,
	|	СУММА(УчетСебестоимости.ВременнаяРазница)       	КАК ВременнаяРазница,
	|	СУММА(УчетСебестоимости.СтоимостьНДД)       		КАК СтоимостьНДД,
	|	СУММА(УчетСебестоимости.СтоимостьЗабалансовая)      КАК СтоимостьЗабалансовая,
	|	СУММА(УчетСебестоимости.СтоимостьЗабалансоваяРегл)  КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(УчетСебестоимости.РезервПодОбесценениеРегл)   КАК РезервПодОбесценениеРегл,
	|	СУММА(УчетСебестоимости.РезервПодОбесценениеУпр)    КАК РезервПодОбесценениеУпр,
	|	СУММА(УчетСебестоимости.КорСтоимость)           	КАК КорСтоимость,
	|	СУММА(УчетСебестоимости.НДСРегл)           			КАК НДСРегл,
	|	СУММА(УчетСебестоимости.СтоимостьУпр)				КАК СтоимостьУпр,
	|	СУММА(УчетСебестоимости.ДопРасходыУпр)				КАК ДопРасходыУпр,
	|	СУММА(УчетСебестоимости.ТрудозатратыУпр)			КАК ТрудозатратыУпр,
	|	СУММА(УчетСебестоимости.ПостатейныеПостоянныеУпр)	КАК ПостатейныеПостоянныеУпр,
	|	СУММА(УчетСебестоимости.ПостатейныеПеременныеУпр)	КАК ПостатейныеПеременныеУпр,
	|	СУММА(УчетСебестоимости.НДСУпр)           			КАК НДСУпр
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК УчетСебестоимости
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО УчетСебестоимости.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РаботыДляДавальца КАК РаботыДляДавальца
	|		ПО РаботыДляДавальца.Регистратор = УчетСебестоимости.Регистратор
	|		И РаботыДляДавальца.КорАналитикаУчетаНоменклатуры = УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|		И РаботыДляДавальца.КорВидЗапасов = УчетСебестоимости.КорВидЗапасов
	|		И РаботыДляДавальца.КорАналитикаУчетаПартий = УчетСебестоимости.КорАналитикаУчетаПартий
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО УчетСебестоимости.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТАналитикиУчетаНоменклатуры КАК КорАналитикаНоменклатуры
	|		ПО РаботыДляДавальца.АналитикаУчетаНоменклатуры = КорАналитикаНоменклатуры.Ссылка

	|	ЛЕВОЕ СОЕДИНЕНИЕ ЕстьВозвратныеОтходы КАК ЕстьВозвратныеОтходы
	|		ПО ЕстьВозвратныеОтходы.Организация = УчетСебестоимости.Организация
	|		И ЕстьВозвратныеОтходы.АналитикаУчетаНоменклатуры = УчетСебестоимости.АналитикаУчетаНоменклатуры
	|		И ЕстьВозвратныеОтходы.ВидЗапасов = УчетСебестоимости.ВидЗапасов
	|		И ЕстьВозвратныеОтходы.РазделУчета = УчетСебестоимости.РазделУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ РеквизитыКорДвижений КАК РеквизитыКорДвижений
	|		ПО ВЫБОР КОГДА УчетСебестоимости.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				ТОГДА РеквизитыКорДвижений.Организация = УчетСебестоимости.Организация
	|				ИНАЧЕ РеквизитыКорДвижений.Организация = УчетСебестоимости.КорОрганизация
	|			КОНЕЦ
	|		И РеквизитыКорДвижений.Регистратор = УчетСебестоимости.Регистратор
	|		И РеквизитыКорДвижений.ИдентификаторФинЗаписи = УчетСебестоимости.ИдентификаторФинЗаписи
	|		И РеквизитыКорДвижений.АналитикаУчетаНоменклатуры = УчетСебестоимости.КорАналитикаУчетаНоменклатуры
	|		И РеквизитыКорДвижений.РазделУчета = УчетСебестоимости.КорРазделУчета
	|	ЛЕВОЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = УчетСебестоимости.Период
	|		И РассчитанныеДокументы.Регистратор = УчетСебестоимости.Регистратор
	|		И &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = УчетСебестоимости.Организация
	|ГДЕ
	|	НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|	И НЕ УчетСебестоимости.Сторно
	// При предварительном расчете исключаем документы, для которых сохранены ранее рассчитанные движения
	|	И РассчитанныеДокументы.Регистратор ЕСТЬ NULL
	// Исключаем формирование движений, для которых выполнен расчет по среднескользящей
	|	И УчетСебестоимости.СпособОпределенияСебестоимости <> ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей)
	|	
	|СГРУППИРОВАТЬ ПО
	|	УчетСебестоимости.Период,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.СлужебноеВидДвиженияПриход
	|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ,
	|	ВЫБОР КОГДА УчетСебестоимости.Организация В(&ОрганизацииСреднескользящая)
	|		ТОГДА РегистраторыРасчета.Ссылка
	|		ИНАЧЕ УчетСебестоимости.Регистратор
	|	КОНЕЦ, // ДокументДвижения
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка,
	|		ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка)), // ДокументРасчета
	|	УчетСебестоимости.Организация,
	|	АналитикаНоменклатуры.МестоХранения,
	|	АналитикаНоменклатуры.Номенклатура,
	|	УчетСебестоимости.АналитикаУчетаНоменклатуры,
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		 И УчетСебестоимости.Количество < 0
	|		 И НЕ ЕстьВозвратныеОтходы.Организация ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка) // возвратные отходы учитываем по пустому разделу учета
	|			ИНАЧЕ УчетСебестоимости.РазделУчета КОНЕЦ),
	|	УчетСебестоимости.ВидЗапасов,
	|	УчетСебестоимости.ВидЗапасов.ТипЗапасов,
	|	УчетСебестоимости.ХозяйственнаяОперация,
	|	РаботыДляДавальца.АналитикаУчетаНоменклатуры,
	|	КорАналитикаНоменклатуры.МестоХранения,
	|	КорАналитикаНоменклатуры.Номенклатура,
	|	РаботыДляДавальца.РазделУчета,
	|	РаботыДляДавальца.ВидЗапасов,
	|	РаботыДляДавальца.ТипЗапасов,
	|	УчетСебестоимости.КорОрганизация,
	|	УчетСебестоимости.Подразделение,
	|	УчетСебестоимости.АналитикаУчетаПоПартнерам,
	|	УчетСебестоимости.ЗаказКлиента,
	|	УчетСебестоимости.АналитикаРасходов,
	|	УчетСебестоимости.СтатьяРасходовСписания,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр,
	|	УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл,
	|	ЕСТЬNULL(УчетСебестоимости.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету, ЛОЖЬ),
	|	УчетСебестоимости.СтатьяДоходов,
	|	УчетСебестоимости.АналитикаДоходов,
	|	УчетСебестоимости.СтатьяАктивовПассивов,
	|	УчетСебестоимости.АналитикаАктивовПассивов,
	|	УчетСебестоимости.ИдентификаторСтроки,
	|	УчетСебестоимости.КодСтроки,
	|	УчетСебестоимости.ПериодПродажи,
	|	УчетСебестоимости.ГруппаПродукции,
	|	ЕСТЬNULL(АналитикаНоменклатуры.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)),
	|	УчетСебестоимости.КорНаправлениеДеятельности,
	|	УчетСебестоимости.Партия,
	|	УчетСебестоимости.АналитикаУчетаПартий,
	|	УчетСебестоимости.АналитикаФинансовогоУчета,
	|	УчетСебестоимости.ВидДеятельностиНДС,
	|	УчетСебестоимости.КорПартия,
	|	УчетСебестоимости.КорАналитикаУчетаПартий,
	|	РаботыДляДавальца.АналитикаФинансовогоУчета,
	|	УчетСебестоимости.КорВидДеятельностиНДС,
	|	УчетСебестоимости.ВидДеятельностиНДСОтгрузки,
	|	УчетСебестоимости.СтатьяКалькуляции,
	|	УчетСебестоимости.ТипЗаписи,
	|	УчетСебестоимости.ДокументИсточник,
	|	УчетСебестоимости.Сторно,
	|	УчетСебестоимости.ИдентификаторФинЗаписи,
	|	УчетСебестоимости.НастройкаСчетовУчета,
	|	УчетСебестоимости.ОперацияУчетаСебестоимости,
	|	УчетСебестоимости.СпособОпределенияСебестоимости,
	|	ВЫБОР
	|		КОГДА УчетСебестоимости.СтатьяРасходовСписания.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	ЕСТЬNULL(РеквизитыКорДвижений.ХозяйственнаяОперация,
	|		УчетСебестоимости.ХозяйственнаяОперация),
	|	ЕСТЬNULL(РеквизитыКорДвижений.ТипЗаписи,
	|		УчетСебестоимости.ТипЗаписи),
	|	ЕСТЬNULL(РеквизитыКорДвижений.КорАналитикаУчетаНоменклатуры,
	|		УчетСебестоимости.КорАналитикаУчетаНоменклатуры),
	|	(ВЫБОР
	|		КОГДА УчетСебестоимости.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И НЕ УчетСебестоимости.СлужебноеВидДвиженияПриход
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) // СписыватьОтклоненияНаСебестоимостьПродаж
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	ВидЗапасов,
	|	Организация,
	|	РазделУчета
	|;";
	#КонецОбласти
	
	#Область НастройкиПризнанияРасходовНДДПоАналитикеУчетаНоменклатуры
	
	ТекстЗапроса = ТекстЗапроса + РасчетСебестоимостиЛокализация.ТекстЗапросаНастроекНДД("ВтТаблицаКорректировки",
		"РасчетСебестоимостиКорректировкаСтоимости_СкорректироватьСтоимостьСписанияЗапасов",
		ПараметрыРасчета) + 
		ОбщегоНазначения.РазделительПакетаЗапросов();
		
	#КонецОбласти
	
	#Область ВтДанныеТаблицаКорректировки
	
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Реестр.Ссылка КАК Ссылка,
	|	МАКСИМУМ(Реестр.Подразделение) КАК Подразделение
	|ПОМЕСТИТЬ ВтРеестрДокументовДвижений
	|ИЗ
	|	ВтТаблицаКорректировки КАК ТаблицаКорректировки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|	ПО Реестр.Ссылка = ТаблицаКорректировки.ДокументДвижения
	|		И НЕ Реестр.ДополнительнаяЗапись
	|СГРУППИРОВАТЬ ПО
	|	Реестр.Ссылка
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|ВЫБРАТЬ
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ТаблицаКорректировки.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаКорректировки.ДокументДвижения              КАК ДокументДвижения,
	|	ТаблицаКорректировки.ДокументРасчета               КАК ДокументРасчета,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.Склад                         КАК Склад,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	Аналитика.Номенклатура                             КАК Номенклатура,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		ИНАЧЕ ТаблицаКорректировки.РазделУчета КОНЕЦ) КАК РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов                    КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ТаблицаКорректировки.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|		 ИЛИ (ТаблицаКорректировки.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|				И НЕ ТаблицаКорректировки.Номенклатура.ПрослеживаемыйТовар)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ЕСТЬNULL(ТаблицаКорректировки.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|	КОНЕЦ                                              КАК ТипЗапасов,
	|	ТаблицаКорректировки.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|	ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	//++ НЕ УТ
	|	ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоНазначениям
	|			ТОГДА РаспределениеВозвратныхОтходов.АналитикаУчетаНоменклатуры
	|		ИНАЧЕ АналитикаНоменклатурыБезНазначения.КлючАналитики
	|	КОНЕЦ                                              КАК АналитикаУчетаНоменклатурыВО,
	|	ВЫБОР
	|		КОГДА &АналитическийУчетПоГруппамПродукции
	|			И НЕ ЕСТЬNULL(СпрНоменклатура.ГруппаАналитическогоУчета,
	|					ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)) =
	|						ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|			ТОГДА СпрНоменклатура.ГруппаАналитическогоУчета
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ                                              КАК АналитикаФинансовогоУчетаВО,
	//-- НЕ УТ
	|	ТаблицаКорректировки.КорСклад                      КАК КорСклад,
	|	ТаблицаКорректировки.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаКорректировки.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ВЫБОР
	|		КОГДА ТаблицаКорректировки.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|		 ИЛИ (ТаблицаКорректировки.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|				И НЕ ТаблицаКорректировки.Номенклатура.ПрослеживаемыйТовар)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ ЕСТЬNULL(ТаблицаКорректировки.КорТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|	КОНЕЦ                                              КАК КорТипЗапасов,
	|	ТаблицаКорректировки.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаКорректировки.Подразделение                 КАК Подразделение,
	|	ТаблицаКорректировки.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаКорректировки.ЗаказКлиента                  КАК ЗаказКлиента,
	|	ТаблицаКорректировки.АналитикаРасходов             КАК АналитикаРасходов,
	|	ТаблицаКорректировки.СтатьяРасходовСписания        КАК СтатьяРасходовСписания,
	|	ТаблицаКорректировки.СтатьяРасходовСписания        КАК СтатьяРасходовСписанияУпр,
	|	ТаблицаКорректировки.АналитикаРасходов             КАК АналитикаРасходовУпр,
	|	ТаблицаКорректировки.ВариантРаспределенияРасходовУпр  КАК ВариантРаспределенияРасходовУпр,
	|	ТаблицаКорректировки.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ТаблицаКорректировки.ПринятиеКНалоговомуУчету      КАК ПринятиеКНалоговомуУчету,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	|	ТаблицаКорректировки.СтатьяДоходов                 КАК СтатьяДоходов,
	|	ТаблицаКорректировки.АналитикаДоходов              КАК АналитикаДоходов,
	|	ТаблицаКорректировки.СтатьяДоходов                 КАК СтатьяДоходовУпр,
	|	ТаблицаКорректировки.АналитикаДоходов              КАК АналитикаДоходовУпр,
	|	ТаблицаКорректировки.СтатьяАктивовПассивов         КАК СтатьяАктивовПассивов,
	|	ТаблицаКорректировки.АналитикаАктивовПассивов      КАК АналитикаАктивовПассивов,
	|	ТаблицаКорректировки.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаКорректировки.КодСтроки                     КАК КодСтроки,
	|	ТаблицаКорректировки.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаКорректировки.ГруппаПродукции               КАК ГруппаПродукции,
	|	ТаблицаКорректировки.СторноОтчетПоКомиссии		   КАК СторноОтчетПоКомиссии,
	|	ТаблицаКорректировки.Партия                        КАК Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ТаблицаКорректировки.КорПартия                 	   КАК КорПартия,
	|	ТаблицаКорректировки.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаКорректировки.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаКорректировки.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	ТаблицаКорректировки.ТипЗаписи                 	   КАК ТипЗаписи,
	|	ТаблицаКорректировки.ДокументИсточник              КАК ДокументИсточник,
	|	ТаблицаКорректировки.Сторно                        КАК Сторно,
	|	ТаблицаКорректировки.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ИдентификаторФинЗаписи        КАК ИдентификаторФинЗаписи,
	|	ТаблицаКорректировки.НастройкаСчетовУчета          КАК НастройкаСчетовУчета,
	|	ТаблицаКорректировки.ОперацияУчетаСебестоимости    КАК ОперацияУчетаСебестоимости,
	|	ТаблицаКорректировки.СпособОпределенияСебестоимости КАК СпособОпределенияСебестоимости,
	|	ТаблицаКорректировки.ВосстанавливатьРезервы        КАК ВосстанавливатьРезервы,
	|	ТаблицаКорректировки.ПриходХозяйственнаяОперация   КАК ПриходХозяйственнаяОперация,
	|	ТаблицаКорректировки.ПриходТипЗаписи               КАК ПриходТипЗаписи,
	|	ТаблицаКорректировки.ПриходНастройкаХозяйственнойОперации КАК ПриходНастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ПриходКорАналитикаУчетаНоменклатуры  КАК ПриходКорАналитикаУчетаНоменклатуры,
	|	ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	//++ Локализация

	//++ НЕ УТ
	|	ВЫБОР ЕСТЬNULL(ПартииТМЦВЭксплуатации.СпособПогашенияСтоимостиНУ, ЗНАЧЕНИЕ(Перечисление.СпособыПогашенияСтоимостиТМЦ.ПриПередаче))
	|		КОГДА ЗНАЧЕНИЕ(Перечисление.СпособыПогашенияСтоимостиТМЦ.ПриПередаче) ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ

	//-- Локализация
	|	ЕСТЬNULL(Реестр.Подразделение, НЕОПРЕДЕЛЕНО) КАК ПодразделениеДокумента,
	|
	|	ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА ТаблицаКорректировки.ВидЗапасов
	|		ИНАЧЕ 
	|			ТаблицаКорректировки.Номенклатура
	|	КОНЕЦ КАК ИсточникГФУНоменклатуры,
	|	ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА ТаблицаКорректировки.КорВидЗапасов
	|		ИНАЧЕ 
	|			ТаблицаКорректировки.КорНоменклатура
	|	КОНЕЦ КАК КорИсточникГФУНоменклатуры,
	|	ВЫБОР КОГДА ТаблицаКорректировки.ХозяйственнаяОперация В (&МассивОперацийПередачи) ТОГДА
	|			ИСТИНА
	|		ИНАЧЕ
	|			ЛОЖЬ
	|	КОНЕЦ                                              КАК ЭтоПередачаМеждуОрганизациями,
	|	(ВЫБОР
	|		КОГДА ЕСТЬNULL(КорУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров, НЕОПРЕДЕЛЕНО)
	|				= ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ)                              КАК КорОрганизацияНаСреднескользящей,
	|	ТаблицаКорректировки.КорСтоимость                  КАК КорСтоимость,
	|
	|	ВЫБОР
	//++ Устарело_Производство21

	//++ НЕ УТ
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.ДокументДвижения) = ТИП(Документ.ВыпускПродукции) ТОГДА
	|			ИСТИНА
	//-- НЕ УТ

	//-- Устарело_Производство21
	|		КОГДА ИСТИНА ТОГДА // для удобства расстановки тегов
	|			ЛОЖЬ
	|		ИНАЧЕ
	|			ЛОЖЬ
	|	КОНЕЦ ЭтоВыпускПродукции,
	|
	|	ВЫБОР
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями) ТОГДА
	|			ИСТИНА
	|		ИНАЧЕ
	|			ЛОЖЬ
	|	КОНЕЦ ЭтоВозвратМеждуОрганизациями,
	// Резервы под обесценение запасов не списываются, если
	//	- не меняется номенклатура и характеристика
	//	- номенклатура списывается на выпуск продукции из раздела Незавершенное производство
	// или списываеиая партия это справочник "Партии производства".
	// Условия формирования поля СписыватьРезервы должны соответствовать условиям формирования поля ПереноситьРезерв
	// в функции РасчетСебестоимостиРешениеСЛУ.ТекстСвязиУзловРезервовПодОбесценениеЗапасов().
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		 И Аналитика.Номенклатура = ЕСТЬNULL(КорАналитика.Номенклатура, НЕОПРЕДЕЛЕНО)
	|		 И Аналитика.Характеристика = ЕСТЬNULL(КорАналитика.Характеристика, НЕОПРЕДЕЛЕНО)
	|		 И НЕ ТаблицаКорректировки.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
	|				)
	|			ТОГДА ЛОЖЬ
	|		КОГДА ТаблицаКорректировки.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|			ТОГДА ЛОЖЬ
	//++ НЕ УТ
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.Партия) = ТИП(Справочник.ПартииПроизводства)
	|			ТОГДА ЛОЖЬ
	//-- НЕ УТ
	|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК СписыватьРезервы,
	|
	|	(ВЫБОР
	// Исключаем расчет стоимости движений, для которых выполнен расчет по среднескользящей.
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА - ТаблицаКорректировки.Стоимость
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|			ТОГДА 0
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|			* ЕСТЬNULL(СтоимостьВозвратаТоваров.Стоимость, ЕСТЬNULL(СтоимостьТоваров.Стоимость, 0)) КАК ЧИСЛО(31,2))
	|			- ТаблицаКорректировки.Стоимость
	|	КОНЕЦ) КАК Стоимость,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|			ТОГДА 0
	|		КОГДА ТаблицаКорректировки.РаботаДляДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|		* ЕСТЬNULL(СтоимостьВозвратаТоваров.СтоимостьЗабалансовая, ЕСТЬNULL(СтоимостьТоваров.СтоимостьЗабалансовая, 0)) КАК ЧИСЛО(31,2))
	|		- ТаблицаКорректировки.СтоимостьЗабалансовая
	|	КОНЕЦ) КАК СтоимостьЗабалансовая,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА - ТаблицаКорректировки.СтоимостьБезНДС
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|			ТОГДА 0
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.СтоимостьБезНДС, ЕСТЬNULL(СтоимостьТоваров.СтоимостьБезНДС, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.СтоимостьБезНДС
	|	КОНЕЦ) КАК СтоимостьБезНДС,
	|
	//++ НЕ УТ
	
	//++ Локализация
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(
	|					ТаблицаКорректировки.Количество
	|					* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостояннаяРазница, ЕСТЬNULL(СтоимостьТоваров.ПостояннаяРазница, 0)) КАК ЧИСЛО(31,2))
	|					- ТаблицаКорректировки.ПостояннаяРазница КОНЕЦ) +
	//-- Локализация
	
	//-- НЕ УТ
	|	0 КАК ПостояннаяРазница,
	|
	//++ УТ
	
	//++ Локализация
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(
	|					ТаблицаКорректировки.Количество
	|					* ЕСТЬNULL(СтоимостьВозвратаТоваров.ВременнаяРазница, ЕСТЬNULL(СтоимостьТоваров.ВременнаяРазница, 0)) КАК ЧИСЛО(31,2))
	|					- ТаблицаКорректировки.ВременнаяРазница КОНЕЦ) +
	//-- Локализация
	
	//-- УТ
	|	0 КАК ВременнаяРазница,
	|
	|	(ВЫБОР
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	
	// Условия заполненния поля СтоимостьНДД должны соответствовать условиям выборки данных для формирования временной таблицы СебестоимостьПредварительная 
	// в функции см. РасчетСебестоимостиНДД.ТекстЗапросаПодготовкаДанныхДляРаспределенияФактическихРасходовНДД
	|		КОГДА ТаблицаКорректировки.ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.Реализация)
	|		 ИЛИ ТаблицаКорректировки.ХозяйственнаяОперация В (&МассивОперацийРеализации)
	|			ТОГДА 0
	|		КОГДА ТаблицаКорректировки.ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.СписаниеНаРасходыАктивы)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА 0
	|		КОГДА ТаблицаКорректировки.ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.ВыбытиеПоФиксированнойСтоимости)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|		 И НастройкиПризнанияРасходовНДДпоПодразделению.ВариантПризнанияРасходов ЕСТЬ NULL
	|		 И НастройкиПризнанияРасходовНДДпоНаправлениюДеятельности.ВариантПризнанияРасходов ЕСТЬ NULL
	|			ТОГДА 0
	// Для движений, связанных с НЗП проверяем вариант признания расходов НДД. Если не включаются в стоимость, то стоимость НДД = 0 
	|		КОГДА ТаблицаКорректировки.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|		 И КорНастройкиПризнанияРасходовНДД.ВариантПризнанияРасходов ЕСТЬ NULL
	|			ТОГДА 0
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|			ТОГДА 0
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.СтоимостьНДД, ЕСТЬNULL(СтоимостьТоваров.СтоимостьНДД, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.СтоимостьНДД 
	|	КОНЕЦ) КАК СтоимостьНДД,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.СтоимостьДопРасходы, ЕСТЬNULL(СтоимостьТоваров.СтоимостьДопРасходы, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.ДопРасходы
	|	КОНЕЦ) КАК ДопРасходы,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.СтоимостьДопРасходыБезНДС, ЕСТЬNULL(СтоимостьТоваров.СтоимостьДопРасходыБезНДС, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.ДопРасходыБезНДС
	|	КОНЕЦ) КАК ДопРасходыБезНДС,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.Трудозатраты, ЕСТЬNULL(СтоимостьТоваров.Трудозатраты, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.Трудозатраты
	|	КОНЕЦ) КАК Трудозатраты,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостатейныеПостоянныеСНДС, ЕСТЬNULL(СтоимостьТоваров.ПостатейныеПостоянныеСНДС, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.ПостатейныеПостоянныеСНДС
	|	КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостатейныеПостоянныеБезНДС, ЕСТЬNULL(СтоимостьТоваров.ПостатейныеПостоянныеБезНДС, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС
	|	КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.ДокументДвижения) = ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	|		 И ТаблицаКорректировки.Количество < 0
	|		 И НЕ &ПартионныйУчетВерсии22
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|		ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		ИНАЧЕ ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|			* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостатейныеПеременныеСНДС, ЕСТЬNULL(СтоимостьТоваров.ПостатейныеПеременныеСНДС, 0)) КАК ЧИСЛО(31,2))
	|			- ТаблицаКорректировки.ПостатейныеПеременныеСНДС
	|	КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.ДокументДвижения) = ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	|		 И ТаблицаКорректировки.Количество < 0
	|		 И НЕ &ПартионныйУчетВерсии22
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|		ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|	ИНАЧЕ
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|		* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостатейныеПеременныеБезНДС, ЕСТЬNULL(СтоимостьТоваров.ПостатейныеПеременныеБезНДС, 0)) КАК ЧИСЛО(31,2))
	|		- ТаблицаКорректировки.ПостатейныеПеременныеБезНДС
	|	КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.ДопРасходыРегл, ЕСТЬNULL(СтоимостьТоваров.ДопРасходыРегл, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.ДопРасходыРегл
	|	КОНЕЦ) КАК ДопРасходыРегл,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.ТрудозатратыРегл, ЕСТЬNULL(СтоимостьТоваров.ТрудозатратыРегл, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.ТрудозатратыРегл
	|	КОНЕЦ) КАК ТрудозатратыРегл,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостатейныеПостоянныеРегл, ЕСТЬNULL(СтоимостьТоваров.ПостатейныеПостоянныеРегл, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|	КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.ДокументДвижения) = ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	|		 И ТаблицаКорректировки.Количество < 0
	|		 И НЕ &ПартионныйУчетВерсии22
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|		ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|	ИНАЧЕ
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|		* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостатейныеПеременныеРегл, ЕСТЬNULL(СтоимостьТоваров.ПостатейныеПеременныеРегл, 0)) КАК ЧИСЛО(31,2))
	|		- ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|	КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА - ТаблицаКорректировки.СтоимостьРегл
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|			ТОГДА 0
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(
	|					ТаблицаКорректировки.Количество
	|					* ЕСТЬNULL(СтоимостьВозвратаТоваров.СтоимостьРегл, ЕСТЬNULL(СтоимостьТоваров.СтоимостьРегл, 0)) КАК ЧИСЛО(31,2))
	|					- ТаблицаКорректировки.СтоимостьРегл 
	|	КОНЕЦ) КАК СтоимостьРегл,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.РаботаДляДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|			ТОГДА 0
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(
	|					ТаблицаКорректировки.Количество
	|					* ЕСТЬNULL(СтоимостьВозвратаТоваров.СтоимостьЗабалансоваяРегл, ЕСТЬNULL(СтоимостьТоваров.СтоимостьЗабалансоваяРегл, 0)) КАК ЧИСЛО(31,2))
	|					- ТаблицаКорректировки.СтоимостьЗабалансоваяРегл 
	|	КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|
	|	(ВЫБОР
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|					* ЕСТЬNULL(СтоимостьВозвратаТоваров.РезервПодОбесценениеРегл, ЕСТЬNULL(СтоимостьТоваров.РезервПодОбесценениеРегл, 0)) КАК ЧИСЛО(31,2))
	|					- ТаблицаКорректировки.РезервПодОбесценениеРегл
	|	КОНЕЦ) КАК РезервПодОбесценениеРегл,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА - ТаблицаКорректировки.СтоимостьУпр
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|			ТОГДА 0
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(
	|					ТаблицаКорректировки.Количество
	|					* ЕСТЬNULL(СтоимостьВозвратаТоваров.СтоимостьУпр, ЕСТЬNULL(СтоимостьТоваров.СтоимостьУпр, 0)) КАК ЧИСЛО(31,2))
	|					- ТаблицаКорректировки.СтоимостьУпр
	|	КОНЕЦ) КАК СтоимостьУпр,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.ДокументДвижения) = ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	|		 И ТаблицаКорректировки.Количество < 0
	|		 И НЕ &ПартионныйУчетВерсии22
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|		ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|	ИНАЧЕ
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|		* ЕСТЬNULL(СтоимостьВозвратаТоваров.ДопРасходыУпр, ЕСТЬNULL(СтоимостьТоваров.ДопРасходыУпр, 0)) КАК ЧИСЛО(31,2))
	|		- ТаблицаКорректировки.ДопРасходыУпр
	|	КОНЕЦ) КАК ДопРасходыУпр,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.ДокументДвижения) = ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	|		 И ТаблицаКорректировки.Количество < 0
	|		 И НЕ &ПартионныйУчетВерсии22
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|		ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|	ИНАЧЕ
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|		* ЕСТЬNULL(СтоимостьВозвратаТоваров.ТрудозатратыУпр, ЕСТЬNULL(СтоимостьТоваров.ТрудозатратыУпр, 0)) КАК ЧИСЛО(31,2))
	|		- ТаблицаКорректировки.ТрудозатратыУпр
	|	КОНЕЦ) КАК ТрудозатратыУпр,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.ДокументДвижения) = ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	|		 И ТаблицаКорректировки.Количество < 0
	|		 И НЕ &ПартионныйУчетВерсии22
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|		ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|	ИНАЧЕ
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|		* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостатейныеПостоянныеУпр, ЕСТЬNULL(СтоимостьТоваров.ПостатейныеПостоянныеУпр, 0)) КАК ЧИСЛО(31,2))
	|		- ТаблицаКорректировки.ПостатейныеПостоянныеУпр
	|	КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СпособОпределенияСебестоимости В (
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ИзДокумента),
	|			ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей),
	|		 	ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоДвижениямДокументаИсточника))
	|		  И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|		  И ТаблицаКорректировки.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА 0
	|		КОГДА ТИПЗНАЧЕНИЯ(ТаблицаКорректировки.ДокументДвижения) = ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	|		 И ТаблицаКорректировки.Количество < 0
	|		 И НЕ &ПартионныйУчетВерсии22
	|			ТОГДА 0
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|	КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|		ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|	ИНАЧЕ
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|		* ЕСТЬNULL(СтоимостьВозвратаТоваров.ПостатейныеПеременныеУпр, ЕСТЬNULL(СтоимостьТоваров.ПостатейныеПеременныеУпр, 0)) КАК ЧИСЛО(31,2))
	|		- ТаблицаКорректировки.ПостатейныеПеременныеУпр
	|	КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	|
	|	(ВЫБОР
	//++ НЕ УТКА
	
	//++ Устарело_Переработка24
	|		КОГДА ТаблицаКорректировки.ПродукцияДавальца
	|			ТОГДА 0
	//-- Устарело_Переработка24
	
	//-- НЕ УТКА
	|		КОГДА ИСТИНА
	|			ТОГДА ВЫРАЗИТЬ(ТаблицаКорректировки.Количество
	|				* ЕСТЬNULL(СтоимостьВозвратаТоваров.РезервПодОбесценениеУпр, ЕСТЬNULL(СтоимостьТоваров.РезервПодОбесценениеУпр, 0)) КАК ЧИСЛО(31,2))
	|				- ТаблицаКорректировки.РезервПодОбесценениеУпр
	|	КОНЕЦ) КАК РезервПодОбесценениеУпр,
	|
	|	ВЫБОР
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|		ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.НДСРегл
	|	КОНЕЦ КАК НДСРегл,
	|	ВЫБОР
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость)
	|		ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.НДСУпр
	|	КОНЕЦ КАК НДСУпр,
	|	ТаблицаКорректировки.Стоимость КАК ИсходнаяСтоимость,
	|	ТаблицаКорректировки.СтоимостьБезНДС КАК ИсходнаяСтоимостьБезНДС,
	|	ТаблицаКорректировки.СтоимостьРегл КАК ИсходнаяСтоимостьРегл,
	|	ТаблицаКорректировки.СтоимостьРегл КАК ИсходнаяСтоимостьУпр,
	|	ТаблицаКорректировки.Количество КАК Количество,
	|
	|	(ВЫБОР
	|		КОГДА СтоимостьТоваров.НомерУзла В (&УзлыСПереполнениемПоля)
	|		 И &ПартионныйУчетВерсии22
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК РасчетНеЗавершен,
	|
	|	ВЫБОР
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы)
	|			И НачалоПериода(ТаблицаКорректировки.ПериодПродажи, МЕСЯЦ) < НачалоПериода(ТаблицаКорректировки.Период, МЕСЯЦ) ТОГДА
	|			-1
	|		ИНАЧЕ
	|			1
	|	КОНЕЦ КАК Знак,
	|	ВЫБОР
	|		КОГДА ТаблицаКорректировки.Сторно ИЛИ ТаблицаКорректировки.ХозяйственнаяОперация В
	|			(ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТары))
	|		ТОГДА -1
	|		ИНАЧЕ 1
	|	КОНЕЦ КАК ЗнакСторно
	|
	|ПОМЕСТИТЬ ВтДанныеТаблицаКорректировки
	|
	|ИЗ
	|	ВтТаблицаКорректировки КАК ТаблицаКорректировки
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ТаблицаКорректировки.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК КорУчетныеПолитикиФинУчета
	|		ПО ТаблицаКорректировки.КорОрганизация = КорУчетныеПолитикиФинУчета.Организация
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО Аналитика.Ссылка = ТаблицаКорректировки.АналитикаУчетаНоменклатуры
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТАналитикиУчетаНоменклатуры КАК КорАналитика
	|		ПО КорАналитика.Ссылка = ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВТСтоимостьПартийТоваров КАК СтоимостьТоваров
	|	ПО 
	|		СтоимостьТоваров.АналитикаУчетаНоменклатуры 	= ТаблицаКорректировки.АналитикаУчетаНоменклатуры
	|		И СтоимостьТоваров.ВидЗапасов               	= ТаблицаКорректировки.ВидЗапасов
	|		И СтоимостьТоваров.Организация              	= ТаблицаКорректировки.Организация
	|		И СтоимостьТоваров.РазделУчета              	= ТаблицаКорректировки.РазделУчета
	|		И СтоимостьТоваров.Партия 						= ТаблицаКорректировки.Партия
	|		И СтоимостьТоваров.АналитикаУчетаПартий 		= ТаблицаКорректировки.АналитикаУчетаПартий
	|		И СтоимостьТоваров.АналитикаФинансовогоУчета 	= ТаблицаКорректировки.АналитикаФинансовогоУчета
	|		И СтоимостьТоваров.ВидДеятельностиНДС 			= ТаблицаКорректировки.ВидДеятельностиНДС
	|		И (ТаблицаКорректировки.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			ИЛИ ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление)
	|			ИЛИ ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|		)
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВТСтоимостьПартийТоваров КАК СтоимостьВозвратаТоваров
	|	ПО 
	|		СтоимостьВозвратаТоваров.АналитикаУчетаНоменклатуры = ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры
	|		И СтоимостьВозвратаТоваров.Организация = ТаблицаКорректировки.Организация
	|		И СтоимостьВозвратаТоваров.Партия = ТаблицаКорректировки.Партия
	|		И СтоимостьВозвратаТоваров.АналитикаУчетаПартий = ТаблицаКорректировки.АналитикаУчетаПартий
	|		И СтоимостьВозвратаТоваров.АналитикаФинансовогоУчета = ТаблицаКорректировки.АналитикаФинансовогоУчета
	|		И СтоимостьВозвратаТоваров.ВидЗапасов = ТаблицаКорректировки.КорВидЗапасов
	|		И СтоимостьВозвратаТоваров.ВидДеятельностиНДС = ТаблицаКорректировки.ВидДеятельностиНДСОтгрузки
	|		И (ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Сторно)
	|			И ТаблицаКорректировки.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализации),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы))
	// Поле "ВидДеятельностиНДСОтгрузки" заполняется в функции ЗаполнитьРасчетнуюПартиюСебестоимостиТоваров()
	// общего модуля РасчетСебестоимостиЗаполнениеПартий по условию на поля ТипЗаписи и ХозяйственнаяОперация
	|			И (ТаблицаКорректировки.ВидДеятельностиНДС <> ТаблицаКорректировки.ВидДеятельностиНДСОтгрузки
	|			ИЛИ ТаблицаКорректировки.АналитикаУчетаНоменклатуры <> ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры)
	|			И СтоимостьВозвратаТоваров.РазделУчета = ТаблицаКорректировки.РазделУчета
	|		ИЛИ ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратНаДругойСклад))
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтРеестрДокументовДвижений КАК Реестр
	|	ПО Реестр.Ссылка = ТаблицаКорректировки.ДокументДвижения
	|	
	//++ НЕ УТ
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеВозвратныхОтходов КАК РаспределениеВозвратныхОтходов
	|	ПО РаспределениеВозвратныхОтходов.Ссылка = ТаблицаКорректировки.ДокументДвижения
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|	ПО АналитикаНоменклатуры.Ссылка = РаспределениеВозвратныхОтходов.АналитикаУчетаНоменклатуры
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатурыБезНазначения
	|	ПО АналитикаНоменклатурыБезНазначения.Номенклатура = АналитикаНоменклатуры.Номенклатура
	|		И АналитикаНоменклатурыБезНазначения.Характеристика = АналитикаНоменклатуры.Характеристика
	|		И АналитикаНоменклатурыБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		И АналитикаНоменклатурыБезНазначения.Серия = АналитикаНоменклатуры.Серия
	|		И АналитикаНоменклатурыБезНазначения.МестоХранения = АналитикаНоменклатуры.МестоХранения
	|		И АналитикаНоменклатурыБезНазначения.СтатьяКалькуляции = АналитикаНоменклатуры.СтатьяКалькуляции
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
	|	ПО СпрНоменклатура.Ссылка = АналитикаНоменклатуры.Номенклатура
	|	
	//++ Локализация
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление.Товары КАК ПередачиВЭксплуатацию
	|	ПО ТаблицаКорректировки.ДокументДвижения = ПередачиВЭксплуатацию.Ссылка
	|		И ТаблицаКорректировки.ИдентификаторСтроки = ПередачиВЭксплуатацию.ИдентификаторСтроки
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ПартииТМЦВЭксплуатации КАК ПартииТМЦВЭксплуатации
	|	ПО ПередачиВЭксплуатацию.Партия = ПартииТМЦВЭксплуатации.Ссылка
	|
	//-- Локализация

	//-- НЕ УТ
	|	ЛЕВОЕ СОЕДИНЕНИЕ НастройкиПризнанияРасходовНДД КАК НастройкиПризнанияРасходовНДДпоПодразделению
	|	ПО НастройкиПризнанияРасходовНДДпоПодразделению.ОбъектРаздельногоУчетаНДД = ТаблицаКорректировки.Подразделение
	|		И НастройкиПризнанияРасходовНДДпоПодразделению.Организация = ТаблицаКорректировки.Организация
	|		И НастройкиПризнанияРасходовНДДпоПодразделению.РасходыВключаютсяВСтоимость
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ НастройкиПризнанияРасходовНДД КАК НастройкиПризнанияРасходовНДДпоНаправлениюДеятельности
	|	ПО НастройкиПризнанияРасходовНДДпоНаправлениюДеятельности.ОбъектРаздельногоУчетаНДД = ТаблицаКорректировки.КорНаправлениеДеятельности
	|		И НастройкиПризнанияРасходовНДДпоНаправлениюДеятельности.Организация = ТаблицаКорректировки.Организация
	|		И НастройкиПризнанияРасходовНДДпоНаправлениюДеятельности.РасходыВключаютсяВСтоимость
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ НастройкиПризнанияРасходовНДДПоАналитикеУчетаНоменклатуры КАК КорНастройкиПризнанияРасходовНДД
	|	ПО КорНастройкиПризнанияРасходовНДД.АналитикаУчетаНоменклатуры = ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры
	|		И КорНастройкиПризнанияРасходовНДД.Организация = ТаблицаКорректировки.Организация
	|		И КорНастройкиПризнанияРасходовНДД.РасходыВключаютсяВСтоимость
	|
	|ГДЕ
	|	НЕ ТаблицаКорректировки.СторноОтчетПоКомиссии
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ХозяйственнаяОперация
	|;";
	
	#КонецОбласти
	
	#Область ДвиженияТаблицаКорректировки // ВТ ДвиженияТаблицаКорректировки
	
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ТаблицаКорректировки.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаКорректировки.ДокументДвижения              КАК ДокументДвижения,
	|	ТаблицаКорректировки.ДокументРасчета               КАК ДокументРасчета,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.Склад                         КАК Склад,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаКорректировки.РазделУчета КАК РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаКорректировки.ТипЗапасов КАК ТипЗапасов,
	|	ТаблицаКорректировки.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|	ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	//++ НЕ УТ
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатурыВО КАК АналитикаУчетаНоменклатурыВО,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчетаВО КАК АналитикаФинансовогоУчетаВО,
	//-- НЕ УТ
	|	ТаблицаКорректировки.КорСклад                      КАК КорСклад,
	|	ТаблицаКорректировки.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаКорректировки.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ТаблицаКорректировки.КорТипЗапасов КАК КорТипЗапасов,
	|	ТаблицаКорректировки.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаКорректировки.Подразделение                 КАК Подразделение,
	|	ТаблицаКорректировки.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаКорректировки.ЗаказКлиента                  КАК ЗаказКлиента,
	|	ТаблицаКорректировки.АналитикаРасходов             КАК АналитикаРасходов,
	|	ТаблицаКорректировки.СтатьяРасходовСписания        КАК СтатьяРасходовСписания,
	|	ТаблицаКорректировки.СтатьяРасходовСписанияУпр     КАК СтатьяРасходовСписанияУпр,
	|	ТаблицаКорректировки.АналитикаРасходовУпр          КАК АналитикаРасходовУпр,
	|	ТаблицаКорректировки.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	ТаблицаКорректировки.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ТаблицаКорректировки.ПринятиеКНалоговомуУчету      КАК ПринятиеКНалоговомуУчету,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	|	ТаблицаКорректировки.СтатьяДоходов                 КАК СтатьяДоходов,
	|	ТаблицаКорректировки.АналитикаДоходов              КАК АналитикаДоходов,
	|	ТаблицаКорректировки.СтатьяДоходовУпр              КАК СтатьяДоходовУпр,
	|	ТаблицаКорректировки.АналитикаДоходовУпр           КАК АналитикаДоходовУпр,
	|	ТаблицаКорректировки.СтатьяАктивовПассивов         КАК СтатьяАктивовПассивов,
	|	ТаблицаКорректировки.АналитикаАктивовПассивов      КАК АналитикаАктивовПассивов,
	|	ТаблицаКорректировки.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаКорректировки.КодСтроки                     КАК КодСтроки,
	|	ТаблицаКорректировки.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаКорректировки.ГруппаПродукции               КАК ГруппаПродукции,
	|	ТаблицаКорректировки.СторноОтчетПоКомиссии		   КАК СторноОтчетПоКомиссии,
	|	ТаблицаКорректировки.Партия                        КАК Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ТаблицаКорректировки.КорПартия                 	   КАК КорПартия,
	|	ТаблицаКорректировки.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаКорректировки.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаКорректировки.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	ТаблицаКорректировки.ТипЗаписи                 	   КАК ТипЗаписи,
	|	ТаблицаКорректировки.ДокументИсточник              КАК ДокументИсточник,
	|	ТаблицаКорректировки.Сторно                        КАК Сторно,
	// При выпуске по плановой стоимости отклонения склад выделяем отдельной настройкой хоз операции для
	// формирования проводки на сумму отклонения.
	// Кроме организаций на среднескользящей, т.к. при среднескользящей отклонения отражаются в отдельном регистре.
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж
	|		 И ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
	|		 И НЕ ТаблицаКорректировки.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаПродукцииИзПроизводстваОтклонения)
	|		ИНАЧЕ ТаблицаКорректировки.НастройкаХозяйственнойОперации КОНЕЦ) КАК НастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ИдентификаторФинЗаписи        КАК ИдентификаторФинЗаписи,
	|	ТаблицаКорректировки.НастройкаСчетовУчета          КАК НастройкаСчетовУчета,
	|	ТаблицаКорректировки.ОперацияУчетаСебестоимости    КАК ОперацияУчетаСебестоимости,
	|	ТаблицаКорректировки.СпособОпределенияСебестоимости КАК СпособОпределенияСебестоимости,
	|	ТаблицаКорректировки.ВосстанавливатьРезервы        КАК ВосстанавливатьРезервы,
	|	ТаблицаКорректировки.ПриходХозяйственнаяОперация   КАК ПриходХозяйственнаяОперация,
	|	ТаблицаКорректировки.ПриходТипЗаписи               КАК ПриходТипЗаписи,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж
	|		 И ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
	|		 И НЕ ТаблицаКорректировки.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаПродукцииИзПроизводстваОтклонения)
	|		ИНАЧЕ ТаблицаКорректировки.ПриходНастройкаХозяйственнойОперации КОНЕЦ) КАК ПриходНастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ПриходКорАналитикаУчетаНоменклатуры  КАК ПриходКорАналитикаУчетаНоменклатуры,
	//++ Локализация

	//++ НЕ УТ
	|	ТаблицаКорректировки.СписаниеПриПередачеНУ КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ

	//-- Локализация
	|	
	|	ТаблицаКорректировки.ПодразделениеДокумента КАК ПодразделениеДокумента,
	|	ТаблицаКорректировки.ИсточникГФУНоменклатуры КАК ИсточникГФУНоменклатуры,
	|	ТаблицаКорректировки.КорИсточникГФУНоменклатуры КАК КорИсточникГФУНоменклатуры,
	|	ТаблицаКорректировки.ЭтоПередачаМеждуОрганизациями КАК ЭтоПередачаМеждуОрганизациями,
	|	ТаблицаКорректировки.КорОрганизацияНаСреднескользящей КАК КорОрганизацияНаСреднескользящей,
	|	ТаблицаКорректировки.КорСтоимость                  КАК КорСтоимость,
	|	ТаблицаКорректировки.Стоимость КАК Стоимость,
	|	ТаблицаКорректировки.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	ТаблицаКорректировки.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ПостояннаяРазница КОНЕЦ)  КАК ПостояннаяРазница,
	|
	// Если в движении сумма НУ в пределах погрешности огругления, то скорректируем сумму временной разницы для исключения 
	// возникновения погрешности по сумме НУ. 
	|	(ВЫБОР
	// При выпуске продукции со списанием отклонений на себестоимость продаж стоимость по регл учету будет нулевая,
	// поэтому сумма временной разницы по отклонениям в стоимости должна быть отражена на полную сумму налогового учета (НУ = БУ - ПР - ВР).
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж
	|			ТОГДА -(ТаблицаКорректировки.СтоимостьРегл
	|				+ ТаблицаКорректировки.ДопРасходыРегл
	|				+ ТаблицаКорректировки.ТрудозатратыРегл
	|				+ ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|				+ ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|				- ТаблицаКорректировки.ПостояннаяРазница
	|				- ТаблицаКорректировки.ВременнаяРазница)
	|		КОГДА (ТаблицаКорректировки.СтоимостьРегл
	|			+ ТаблицаКорректировки.ДопРасходыРегл
	|			+ ТаблицаКорректировки.ТрудозатратыРегл
	|			+ ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|			+ ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|			- ТаблицаКорректировки.ПостояннаяРазница
	|			- ТаблицаКорректировки.ВременнаяРазница) МЕЖДУ -&ЗначениеПогрешности И &ЗначениеПогрешности
	|		 И ТаблицаКорректировки.ВременнаяРазница > &ЗначениеПогрешности
	|			ТОГДА ТаблицаКорректировки.СтоимостьРегл
	|			+ ТаблицаКорректировки.ДопРасходыРегл
	|			+ ТаблицаКорректировки.ТрудозатратыРегл
	|			+ ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|			+ ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|			- ТаблицаКорректировки.ПостояннаяРазница
	|		ИНАЧЕ ТаблицаКорректировки.ВременнаяРазница КОНЕЦ) КАК ВременнаяРазница,
	|	ТаблицаКорректировки.СтоимостьНДД КАК СтоимостьНДД,
	|
	|	ТаблицаКорректировки.ДопРасходы КАК ДопРасходы,
	|
	|	ТаблицаКорректировки.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	ТаблицаКорректировки.Трудозатраты КАК Трудозатраты,
	|	ТаблицаКорректировки.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	ТаблицаКорректировки.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	ТаблицаКорректировки.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ДопРасходыРегл КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ТрудозатратыРегл КОНЕЦ) КАК ТрудозатратыРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ПостатейныеПостоянныеРегл КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ПостатейныеПеременныеРегл КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.СтоимостьРегл КОНЕЦ) КАК СтоимостьРегл,
	|	ТаблицаКорректировки.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.РезервПодОбесценениеРегл КОНЕЦ) КАК РезервПодОбесценениеРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.СтоимостьУпр КОНЕЦ) КАК СтоимостьУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ДопРасходыУпр КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ТрудозатратыУпр КОНЕЦ) КАК ТрудозатратыУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ПостатейныеПостоянныеУпр КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.ПостатейныеПеременныеУпр КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.РезервПодОбесценениеУпр КОНЕЦ) КАК РезервПодОбесценениеУпр,
	|
	|	ТаблицаКорректировки.НДСРегл КАК НДСРегл,
	|	ТаблицаКорректировки.НДСУпр КАК НДСУпр,
	|	ТаблицаКорректировки.ИсходнаяСтоимость КАК ИсходнаяСтоимость,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьБезНДС КАК ИсходнаяСтоимостьБезНДС,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьРегл КАК ИсходнаяСтоимостьРегл,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьУпр КАК ИсходнаяСтоимостьУпр,
	|	ТаблицаКорректировки.Количество КАК Количество,
	|
	|	ТаблицаКорректировки.ЭтоВыпускПродукции КАК ЭтоВыпускПродукции,
	|	ТаблицаКорректировки.ЭтоВозвратМеждуОрганизациями КАК ЭтоВозвратМеждуОрганизациями,
	|	ТаблицаКорректировки.СписыватьРезервы,
	|	ТаблицаКорректировки.РасчетНеЗавершен,
	|	
	|	(ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|	+ ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС)
	|	- ТаблицаКорректировки.КорСтоимость КАК ПолнаяСуммаПереоценки,
	|
	|	Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС КАК СуммаСНДС,
	|	СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС КАК СуммаБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.СтоимостьРегл
	|			+ ТаблицаКорректировки.ДопРасходыРегл
	|			+ ТаблицаКорректировки.ТрудозатратыРегл
	|			+ ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|			+ ТаблицаКорректировки.ПостатейныеПеременныеРегл КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ ТаблицаКорректировки.СтоимостьУпр
	|			+ ТаблицаКорректировки.ДопРасходыУпр
	|			+ ТаблицаКорректировки.ТрудозатратыУпр
	|			+ ТаблицаКорректировки.ПостатейныеПостоянныеУпр
	|			+ ТаблицаКорректировки.ПостатейныеПеременныеУпр КОНЕЦ) КАК СуммаУпр,
	|	ТаблицаКорректировки.СтоимостьНДД КАК СуммаНДД,
	|	ТаблицаКорректировки.Знак КАК Знак
	|
	|ПОМЕСТИТЬ ДвиженияТаблицаКорректировки
	|
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаКорректировки
	|ГДЕ
	|	НЕ (ТаблицаКорректировки.ХозяйственнаяОперация В (&ХозОперацииТаблицыКорректировки)
	|		И ТаблицаКорректировки.РазделУчета В (&БалансовыеРазделыУчета)
	|			ИЛИ ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаПартийТоваров)
	|			ИЛИ ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	// Отклонения по выбытию по фиксированной стоимости по балансовым разделаи учета и по полуфабрикатам давальца 
	// отражается на прочие доходы или прочие расходы.
	|			ИЛИ ТаблицаКорректировки.ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.ВыбытиеПоФиксированнойСтоимости)
	|	 			И (ТаблицаКорректировки.РазделУчета В (&БалансовыеРазделыУчета)
	|					ИЛИ ТаблицаКорректировки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца))
	|	)
	|";
	#КонецОбласти
	
	#Область ДвиженияТаблицаКорректировки_СписаниеОтклоненийНаСебестоимостьПродаж
	
	ТекстЗапроса = ТекстЗапроса + "
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ТаблицаКорректировки.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаКорректировки.ДокументДвижения              КАК ДокументДвижения,
	|	ТаблицаКорректировки.ДокументРасчета               КАК ДокументРасчета,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.Склад                         КАК Склад,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаКорректировки.РазделУчета КАК РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаКорректировки.ТипЗапасов КАК ТипЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж) КАК ХозяйственнаяОперация,
	|	ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	//++ НЕ УТ
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатурыВО КАК АналитикаУчетаНоменклатурыВО,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчетаВО КАК АналитикаФинансовогоУчетаВО,
	//-- НЕ УТ
	|	ТаблицаКорректировки.КорСклад                      КАК КорСклад,
	|	ТаблицаКорректировки.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаКорректировки.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ТаблицаКорректировки.КорТипЗапасов КАК КорТипЗапасов,
	|	ТаблицаКорректировки.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаКорректировки.Подразделение                 КАК Подразделение,
	|	ТаблицаКорректировки.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаКорректировки.ЗаказКлиента                  КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписанияУпр,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаРасходовУпр,
	|	ТаблицаКорректировки.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	ТаблицаКорректировки.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ТаблицаКорректировки.ПринятиеКНалоговомуУчету      КАК ПринятиеКНалоговомуУчету,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка) КАК СтатьяДоходов,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаДоходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка) КАК СтатьяДоходовУпр,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаДоходовУпр,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка) КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаАктивовПассивов,
	|	ТаблицаКорректировки.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаКорректировки.КодСтроки                     КАК КодСтроки,
	|	ТаблицаКорректировки.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаКорректировки.ГруппаПродукции               КАК ГруппаПродукции,
	|	ТаблицаКорректировки.СторноОтчетПоКомиссии		   КАК СторноОтчетПоКомиссии,
	|	ТаблицаКорректировки.Партия                        КАК Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ТаблицаКорректировки.КорПартия                 	   КАК КорПартия,
	|	ТаблицаКорректировки.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаКорректировки.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаКорректировки.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	ТаблицаКорректировки.ТипЗаписи                 	   КАК ТипЗаписи,
	|	ТаблицаКорректировки.ДокументИсточник              КАК ДокументИсточник,
	|	ТаблицаКорректировки.Сторно                        КАК Сторно,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОтклоненийНаСебестоимостьПродаж) КАК НастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ИдентификаторФинЗаписи        КАК ИдентификаторФинЗаписи,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаСчетовУчета,
	|	ТаблицаКорректировки.ОперацияУчетаСебестоимости    КАК ОперацияУчетаСебестоимости,
	|	ТаблицаКорректировки.СпособОпределенияСебестоимости КАК СпособОпределенияСебестоимости,
	|	ТаблицаКорректировки.ВосстанавливатьРезервы        КАК ВосстанавливатьРезервы,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж) КАК ПриходХозяйственнаяОперация,
	|	ТаблицаКорректировки.ПриходТипЗаписи               КАК ПриходТипЗаписи,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОтклоненийНаСебестоимостьПродаж) КАК ПриходНастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ПриходКорАналитикаУчетаНоменклатуры  КАК ПриходКорАналитикаУчетаНоменклатуры,
	//++ Локализация

	//++ НЕ УТ
	|	ТаблицаКорректировки.СписаниеПриПередачеНУ КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ

	//-- Локализация
	|	
	|	ТаблицаКорректировки.ПодразделениеДокумента КАК ПодразделениеДокумента,
	|	ТаблицаКорректировки.ИсточникГФУНоменклатуры КАК ИсточникГФУНоменклатуры,
	|	ТаблицаКорректировки.КорИсточникГФУНоменклатуры КАК КорИсточникГФУНоменклатуры,
	|	ТаблицаКорректировки.ЭтоПередачаМеждуОрганизациями КАК ЭтоПередачаМеждуОрганизациями,
	|	ТаблицаКорректировки.КорОрганизацияНаСреднескользящей КАК КорОрганизацияНаСреднескользящей,
	|	0 КАК КорСтоимость,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьБезНДС,
	|	ТаблицаКорректировки.ПостояннаяРазница КАК ПостояннаяРазница,
	// При выпуске продукции со списанием отклонений на себестоимость продаж стоимость по налоговому учету будет нулевая,
	// поэтому сумма временной разницы по отклонениям в стоимости должна быть отражена на полную сумму регл учета
	// за минусовм постоянной разницы.
	|	ТаблицаКорректировки.СтоимостьРегл
	|		+ ТаблицаКорректировки.ДопРасходыРегл
	|		+ ТаблицаКорректировки.ТрудозатратыРегл
	|		+ ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|		+ ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|		- ТаблицаКорректировки.ПостояннаяРазница КАК ВременнаяРазница,
	|	0 КАК СтоимостьНДД,
	|
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	ТаблицаКорректировки.ДопРасходыРегл КАК ДопРасходыРегл,
	|	ТаблицаКорректировки.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	ТаблицаКорректировки.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	ТаблицаКорректировки.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	ТаблицаКорректировки.СтоимостьРегл КАК СтоимостьРегл,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	ТаблицаКорректировки.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	ТаблицаКорректировки.СтоимостьУпр КАК СтоимостьУпр,
	|	ТаблицаКорректировки.ДопРасходыУпр КАК ДопРасходыУпр,
	|	ТаблицаКорректировки.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	ТаблицаКорректировки.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	ТаблицаКорректировки.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	ТаблицаКорректировки.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	|
	|	ТаблицаКорректировки.НДСРегл КАК НДСРегл,
	|	ТаблицаКорректировки.НДСУпр КАК НДСУпр,
	|	0 КАК ИсходнаяСтоимость,
	|	0 КАК ИсходнаяСтоимостьБезНДС,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьРегл КАК ИсходнаяСтоимостьРегл,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьУпр КАК ИсходнаяСтоимостьУпр,
	|	ТаблицаКорректировки.Количество КАК Количество,
	|
	|	ТаблицаКорректировки.ЭтоВыпускПродукции КАК ЭтоВыпускПродукции,
	|	ТаблицаКорректировки.ЭтоВозвратМеждуОрганизациями КАК ЭтоВозвратМеждуОрганизациями,
	|	ТаблицаКорректировки.СписыватьРезервы,
	|	ТаблицаКорректировки.РасчетНеЗавершен,
	|	
	|	0 КАК ПолнаяСуммаПереоценки,
	|
	|	0 КАК СуммаСНДС,
	|	0 КАК СуммаБезНДС,
	|	СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл КАК СуммаРегл,
	|	СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр КАК СуммаУпр,
	|	0 КАК СуммаНДД,
	|	ТаблицаКорректировки.Знак КАК Знак
	|
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаКорректировки
	|ГДЕ
	|	ТаблицаКорректировки.СписыватьОтклоненияНаСебестоимостьПродаж
	|";
	#КонецОбласти
	
	#Область ДвиженияТаблицаКорректировки_ПрочиеДоходы
	
	// Отклонение в стоимости - отнесение на прочие доходы
	ТекстЗапроса = ТекстЗапроса + "
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ТаблицаКорректировки.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаКорректировки.ДокументДвижения              КАК ДокументДвижения,
	|	ТаблицаКорректировки.ДокументРасчета               КАК ДокументРасчета,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.Склад                         КАК Склад,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаКорректировки.РазделУчета КАК РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаКорректировки.ТипЗапасов КАК ТипЗапасов,
	|	ТаблицаКорректировки.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|	ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	//++ НЕ УТ
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатурыВО  КАК АналитикаУчетаНоменклатурыВО,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчетаВО   КАК АналитикаФинансовогоУчетаВО,
	//-- НЕ УТ
	|	ТаблицаКорректировки.КорСклад                      КАК КорСклад,
	|	ТаблицаКорректировки.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаКорректировки.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ТаблицаКорректировки.КорТипЗапасов                 КАК КорТипЗапасов,
	|	ТаблицаКорректировки.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаКорректировки.Подразделение                 КАК Подразделение,
	|	ТаблицаКорректировки.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаКорректировки.ЗаказКлиента                  КАК ЗаказКлиента,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО                                       КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО                                       КАК СтатьяРасходовСписанияУпр,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаРасходовУпр,
	|	НЕОПРЕДЕЛЕНО                                       КАК ВариантРаспределенияРасходовУпр,
	|	НЕОПРЕДЕЛЕНО                                       КАК ВариантРаспределенияРасходовРегл,
	|	ТаблицаКорректировки.ПринятиеКНалоговомуУчету      КАК ПринятиеКНалоговомуУчету,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтатьяДоходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ОтклонениеВСтоимостиТоваров)
	|		ИНАЧЕ ТаблицаКорректировки.СтатьяДоходов КОНЕЦ) КАК СтатьяДоходов,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтатьяДоходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ТаблицаКорректировки.Номенклатура
	|		ИНАЧЕ ТаблицаКорректировки.АналитикаДоходов КОНЕЦ) КАК АналитикаДоходов,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтатьяДоходовУпр = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ОтклонениеВСтоимостиТоваров)
	|		ИНАЧЕ ТаблицаКорректировки.СтатьяДоходовУпр КОНЕЦ) КАК СтатьяДоходовУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтатьяДоходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ТаблицаКорректировки.Номенклатура
	|		ИНАЧЕ ТаблицаКорректировки.АналитикаДоходовУпр КОНЕЦ) КАК АналитикаДоходовУпр,
	|	ТаблицаКорректировки.СтатьяАктивовПассивов         КАК СтатьяАктивовПассивов,
	|	ТаблицаКорректировки.АналитикаАктивовПассивов      КАК АналитикаАктивовПассивов,
	|	ТаблицаКорректировки.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаКорректировки.КодСтроки                     КАК КодСтроки,
	|	ТаблицаКорректировки.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаКорректировки.ГруппаПродукции               КАК ГруппаПродукции,
	|	ТаблицаКорректировки.СторноОтчетПоКомиссии		   КАК СторноОтчетПоКомиссии,
	|	ТаблицаКорректировки.Партия                        КАК Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ТаблицаКорректировки.КорПартия                 	   КАК КорПартия,
	|	ТаблицаКорректировки.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаКорректировки.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаКорректировки.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимостиНаПрочиеДоходы)
	|		ИНАЧЕ ТаблицаКорректировки.ТипЗаписи КОНЕЦ)    КАК ТипЗаписи,
	|	ТаблицаКорректировки.ДокументИсточник              КАК ДокументИсточник,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ТаблицаКорректировки.Сторно КОНЕЦ)       КАК Сторно,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровДоходы) КАК НастройкаХозяйственнойОперации,
	// Отклонения в стоимости отражаем по идентификатору строки документа.
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ИдентификаторСтроки <> """"
	|			ТОГДА ТаблицаКорректировки.ИдентификаторСтроки
	|		ИНАЧЕ ТаблицаКорректировки.ИдентификаторФинЗаписи КОНЕЦ) КАК ИдентификаторФинЗаписи,
	|	ТаблицаКорректировки.НастройкаСчетовУчета          КАК НастройкаСчетовУчета,
	|	ТаблицаКорректировки.ОперацияУчетаСебестоимости    КАК ОперацияУчетаСебестоимости,
	|	ТаблицаКорректировки.СпособОпределенияСебестоимости КАК СпособОпределенияСебестоимости,
	|	ТаблицаКорректировки.ВосстанавливатьРезервы        КАК ВосстанавливатьРезервы,
	|	ТаблицаКорректировки.ПриходХозяйственнаяОперация   КАК ПриходХозяйственнаяОперация,
	|	ТаблицаКорректировки.ПриходТипЗаписи               КАК ПриходТипЗаписи,
	|	ТаблицаКорректировки.ПриходНастройкаХозяйственнойОперации КАК ПриходНастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ПриходКорАналитикаУчетаНоменклатуры  КАК ПриходКорАналитикаУчетаНоменклатуры,
	//++ Локализация

	//++ НЕ УТ
	|	ТаблицаКорректировки.СписаниеПриПередачеНУ КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ

	//-- Локализация
	|	
	|	ТаблицаКорректировки.ПодразделениеДокумента КАК ПодразделениеДокумента,
	|	ТаблицаКорректировки.ИсточникГФУНоменклатуры КАК ИсточникГФУНоменклатуры,
	|	ТаблицаКорректировки.КорИсточникГФУНоменклатуры КАК КорИсточникГФУНоменклатуры,
	|	ТаблицаКорректировки.ЭтоПередачаМеждуОрганизациями КАК ЭтоПередачаМеждуОрганизациями,
	|	ТаблицаКорректировки.КорОрганизацияНаСреднескользящей КАК КорОрганизацияНаСреднескользящей,
	|	ТаблицаКорректировки.КорСтоимость                  КАК КорСтоимость,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) < 0
	|			ТОГДА Стоимость
	|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * СтоимостьЗабалансовая < 0
	|			ТОГДА СтоимостьЗабалансовая
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансовая,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) < 0
	|			ТОГДА СтоимостьБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
	//++ НЕ УТ
	
	//++ Локализация
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) +
	//-- Локализация
	
	//-- НЕ УТ
	|	0 КАК ПостояннаяРазница,
	//++ НЕ УТ
	
	//++ Локализация
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) +
	//-- Локализация
	
	//-- НЕ УТ
	|	0 КАК ВременнаяРазница,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * СтоимостьНДД < 0
	|			ТОГДА СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьНДД,
	|
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) < 0
	|			ТОГДА ДопРасходы
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходы,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) < 0
	|			ТОГДА ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) < 0
	|			ТОГДА Трудозатраты
	|		ИНАЧЕ 0 КОНЕЦ) КАК Трудозатраты,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) < 0
	|			ТОГДА ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) < 0
	|			ТОГДА ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) < 0
	|			ТОГДА ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) < 0
	|			ТОГДА ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
	|
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА ТрудозатратыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА ПостатейныеПостоянныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * СтоимостьЗабалансоваяРегл < 0
	|			ТОГДА СтоимостьЗабалансоваяРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА РезервПодОбесценениеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК РезервПодОбесценениеРегл,
	|
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) < 0
	|			ТОГДА СтоимостьУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) < 0
	|			ТОГДА ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) < 0
	|			ТОГДА ТрудозатратыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) < 0
	|			ТОГДА ПостатейныеПостоянныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) < 0
	|			ТОГДА ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) < 0
	|			ТОГДА РезервПодОбесценениеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК РезервПодОбесценениеУпр,
	|
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	ТаблицаКорректировки.ИсходнаяСтоимость КАК ИсходнаяСтоимость,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьБезНДС КАК ИсходнаяСтоимостьБезНДС,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьРегл КАК ИсходнаяСтоимостьРегл,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьУпр КАК ИсходнаяСтоимостьУпр,
	|	ТаблицаКорректировки.Количество КАК Количество,
	|
	|	ТаблицаКорректировки.ЭтоВыпускПродукции КАК ЭтоВыпускПродукции,
	|	ТаблицаКорректировки.ЭтоВозвратМеждуОрганизациями КАК ЭтоВозвратМеждуОрганизациями,
	|	ТаблицаКорректировки.СписыватьРезервы,
	|	ТаблицаКорректировки.РасчетНеЗавершен,
	|	
	|	(ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|	+ ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС)
	|	- ТаблицаКорректировки.КорСтоимость КАК ПолнаяСуммаПереоценки,
	|
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) < 0
	|			ТОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаСНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) < 0
	|			ТОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ТОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) < 0
	|			ТОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	0 КАК СуммаНДД,
	|	ТаблицаКорректировки.Знак КАК Знак
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаКорректировки
	|ГДЕ
	|	(ТаблицаКорректировки.ХозяйственнаяОперация В (&ХозОперацииТаблицыКорректировки)
	|	 И ТаблицаКорректировки.РазделУчета В (&БалансовыеРазделыУчета)
	|		ИЛИ ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаПартийТоваров)
	|		ИЛИ ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|		ИЛИ ТаблицаКорректировки.ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.ВыбытиеПоФиксированнойСтоимости)
	|	 		И (ТаблицаКорректировки.РазделУчета В (&БалансовыеРазделыУчета)
	|				ИЛИ ТаблицаКорректировки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца))
	|	)
	// На прочие доходы будут отнесены отрицательные суммы отклонения в стоимости или положительные суммы отклонений для сторно движений.
	|	И (ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) < 0
	|			ИЛИ ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) < 0
	|			ИЛИ ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) < 0
	|			ИЛИ ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) < 0
	|			ИЛИ ЗнакСторно * СтоимостьЗабалансовая < 0
	|			ИЛИ ЗнакСторно * СтоимостьЗабалансоваяРегл < 0
	|			ИЛИ ЗнакСторно * СтоимостьНДД < 0
	|				ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ)
	|";
	#КонецОбласти
	
	#Область ДвиженияТаблицаКорректировки_ПрочиеРасходы
	
	// Отклонение в стоимости - отнесение на прочие расходы
	ТекстЗапроса = ТекстЗапроса + "
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ТаблицаКорректировки.ВидДвижения                   КАК ВидДвижения,
	|	ТаблицаКорректировки.ДокументДвижения              КАК ДокументДвижения,
	|	ТаблицаКорректировки.ДокументРасчета               КАК ДокументРасчета,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.Склад                         КАК Склад,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаКорректировки.РазделУчета КАК РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаКорректировки.ТипЗапасов КАК ТипЗапасов,
	|	ТаблицаКорректировки.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|	ТаблицаКорректировки.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	//++ НЕ УТ
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатурыВО КАК АналитикаУчетаНоменклатурыВО,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчетаВО КАК АналитикаФинансовогоУчетаВО,
	//-- НЕ УТ
	|	ТаблицаКорректировки.КорСклад                      КАК КорСклад,
	|	ТаблицаКорректировки.КорРазделУчета                КАК КорРазделУчета,
	|	ТаблицаКорректировки.КорВидЗапасов                 КАК КорВидЗапасов,
	|	ТаблицаКорректировки.КорТипЗапасов КАК КорТипЗапасов,
	|	ТаблицаКорректировки.КорОрганизация                КАК КорОрганизация,
	|	ТаблицаКорректировки.Подразделение                 КАК Подразделение,
	|	ТаблицаКорректировки.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|	ТаблицаКорректировки.ЗаказКлиента                  КАК ЗаказКлиента,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ТаблицаКорректировки.Номенклатура
	|		ИНАЧЕ ТаблицаКорректировки.АналитикаРасходов КОНЕЦ) КАК АналитикаРасходов,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ОтклонениеВСтоимостиТоваров)
	|		ИНАЧЕ ТаблицаКорректировки.СтатьяРасходовСписания КОНЕЦ) КАК СтатьяРасходовСписания,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтатьяРасходовСписанияУпр = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ОтклонениеВСтоимостиТоваров)
	|		ИНАЧЕ ТаблицаКорректировки.СтатьяРасходовСписанияУпр КОНЕЦ) КАК СтатьяРасходовСписанияУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтатьяРасходовСписанияУпр = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И ТаблицаКорректировки.СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|			ТОГДА ТаблицаКорректировки.Номенклатура
	|		ИНАЧЕ ТаблицаКорректировки.АналитикаРасходовУпр КОНЕЦ) КАК АналитикаРасходовУпр,
	|	ТаблицаКорректировки.ВариантРаспределенияРасходовУпр КАК ВариантРаспределенияРасходовУпр,
	|	ТаблицаКорректировки.ВариантРаспределенияРасходовРегл КАК ВариантРаспределенияРасходовРегл,
	|	ТаблицаКорректировки.ПринятиеКНалоговомуУчету      КАК ПринятиеКНалоговомуУчету,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.КорНаправлениеДеятельности    КАК КорНаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                       КАК СтатьяДоходов,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаДоходов,
	|	НЕОПРЕДЕЛЕНО                                       КАК СтатьяДоходовУпр,
	|	НЕОПРЕДЕЛЕНО                                       КАК АналитикаДоходовУпр,
	|	ТаблицаКорректировки.СтатьяАктивовПассивов         КАК СтатьяАктивовПассивов,
	|	ТаблицаКорректировки.АналитикаАктивовПассивов      КАК АналитикаАктивовПассивов,
	|	ТаблицаКорректировки.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|	ТаблицаКорректировки.КодСтроки                     КАК КодСтроки,
	|	ТаблицаКорректировки.ПериодПродажи                 КАК ПериодПродажи,
	|	ТаблицаКорректировки.ГруппаПродукции               КАК ГруппаПродукции,
	|	ТаблицаКорректировки.СторноОтчетПоКомиссии		   КАК СторноОтчетПоКомиссии,
	|	ТаблицаКорректировки.Партия                        КАК Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ТаблицаКорректировки.КорПартия                 	   КАК КорПартия,
	|	ТаблицаКорректировки.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|	ТаблицаКорректировки.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|	ТаблицаКорректировки.СтатьяКалькуляции             КАК СтатьяКалькуляции,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
	|		ИНАЧЕ ТаблицаКорректировки.ТипЗаписи КОНЕЦ)    КАК ТипЗаписи,
	|	ТаблицаКорректировки.ДокументИсточник              КАК ДокументИсточник,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ТаблицаКорректировки.Сторно КОНЕЦ)    КАК Сторно,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровРасходы) КАК НастройкаХозяйственнойОперации,
	// Отклонения в стоимости отражаем по идентификатору строки документа.
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ИдентификаторСтроки <> """"
	|			ТОГДА ТаблицаКорректировки.ИдентификаторСтроки
	|		ИНАЧЕ ТаблицаКорректировки.ИдентификаторФинЗаписи КОНЕЦ) КАК ИдентификаторФинЗаписи,
	|	ТаблицаКорректировки.НастройкаСчетовУчета          КАК НастройкаСчетовУчета,
	|	ТаблицаКорректировки.ОперацияУчетаСебестоимости    КАК ОперацияУчетаСебестоимости,
	|	ТаблицаКорректировки.СпособОпределенияСебестоимости КАК СпособОпределенияСебестоимости,
	|	ТаблицаКорректировки.ВосстанавливатьРезервы        КАК ВосстанавливатьРезервы,
	|	ТаблицаКорректировки.ПриходХозяйственнаяОперация   КАК ПриходХозяйственнаяОперация,
	|	ТаблицаКорректировки.ПриходТипЗаписи               КАК ПриходТипЗаписи,
	|	ТаблицаКорректировки.ПриходНастройкаХозяйственнойОперации КАК ПриходНастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ПриходКорАналитикаУчетаНоменклатуры  КАК ПриходКорАналитикаУчетаНоменклатуры,
	//++ Локализация

	//++ НЕ УТ
	|	ТаблицаКорректировки.СписаниеПриПередачеНУ КАК СписаниеПриПередачеНУ,
	//-- НЕ УТ

	//-- Локализация
	|	
	|	ТаблицаКорректировки.ПодразделениеДокумента КАК ПодразделениеДокумента,
	|	ТаблицаКорректировки.ИсточникГФУНоменклатуры КАК ИсточникГФУНоменклатуры,
	|	ТаблицаКорректировки.КорИсточникГФУНоменклатуры КАК КорИсточникГФУНоменклатуры,
	|	ТаблицаКорректировки.ЭтоПередачаМеждуОрганизациями КАК ЭтоПередачаМеждуОрганизациями,
	|	ТаблицаКорректировки.КорОрганизацияНаСреднескользящей КАК КорОрганизацияНаСреднескользящей,
	|	ТаблицаКорректировки.КорСтоимость                  КАК КорСтоимость,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) >= 0
	|			ТОГДА Стоимость
	|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * СтоимостьЗабалансовая > 0
	|			ТОГДА СтоимостьЗабалансовая
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансовая,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) >= 0
	|			ТОГДА СтоимостьБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
	//++ НЕ УТ
	
	//++ Локализация
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) +
	//-- Локализация
	
	//-- НЕ УТ
	|	0 КАК ПостояннаяРазница,
	//++ НЕ УТ
	
	//++ Локализация
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) +
	//-- Локализация
	
	//-- НЕ УТ
	|	0 КАК ВременнаяРазница,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * СтоимостьНДД >= 0
	|			ТОГДА СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьНДД,
	|
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) >= 0
	|			ТОГДА ДопРасходы
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходы,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) >= 0
	|			ТОГДА ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) >= 0
	|			ТОГДА Трудозатраты
	|		ИНАЧЕ 0 КОНЕЦ) КАК Трудозатраты,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) >= 0
	|			ТОГДА ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) >= 0
	|			ТОГДА ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) >= 0
	|			ТОГДА ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) >= 0
	|			ТОГДА ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
	|
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА ТрудозатратыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА ПостатейныеПостоянныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * СтоимостьЗабалансоваяРегл > 0
	|			ТОГДА СтоимостьЗабалансоваяРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА РезервПодОбесценениеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК РезервПодОбесценениеРегл,
	|
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) >= 0
	|			ТОГДА СтоимостьУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) >= 0
	|			ТОГДА ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) >= 0
	|			ТОГДА ТрудозатратыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) >= 0
	|			ТОГДА ПостатейныеПостоянныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) >= 0
	|			ТОГДА ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) >= 0
	|			ТОГДА РезервПодОбесценениеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК РезервПодОбесценениеУпр,
	|
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	ТаблицаКорректировки.ИсходнаяСтоимость КАК ИсходнаяСтоимость,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьБезНДС КАК ИсходнаяСтоимостьБезНДС,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьРегл КАК ИсходнаяСтоимостьРегл,
	|	ТаблицаКорректировки.ИсходнаяСтоимостьУпр КАК ИсходнаяСтоимостьУпр,
	|	ТаблицаКорректировки.Количество КАК Количество,
	|
	|	ТаблицаКорректировки.ЭтоВыпускПродукции КАК ЭтоВыпускПродукции,
	|	ТаблицаКорректировки.ЭтоВозвратМеждуОрганизациями КАК ЭтоВозвратМеждуОрганизациями,
	|	ТаблицаКорректировки.СписыватьРезервы,
	|	ТаблицаКорректировки.РасчетНеЗавершен,
	|	
	|	(ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|	+ ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС)
	|	- ТаблицаКорректировки.КорСтоимость КАК ПолнаяСуммаПереоценки,
	|
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) >= 0
	|			ТОГДА Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаСНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) >= 0
	|			ТОГДА СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ТОГДА СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) >= 0
	|			ТОГДА СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	(ВЫБОР 
	|		КОГДА ЗнакСторно * СтоимостьНДД >= 0
	|			ТОГДА СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаНДД,
	|	ТаблицаКорректировки.Знак КАК Знак
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаКорректировки
	|ГДЕ
	|	(ТаблицаКорректировки.ХозяйственнаяОперация В (&ХозОперацииТаблицыКорректировки)
	|	 И ТаблицаКорректировки.РазделУчета В (&БалансовыеРазделыУчета)
	|		ИЛИ ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаПартийТоваров)
	|		ИЛИ ТаблицаКорректировки.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения)
	|		ИЛИ ТаблицаКорректировки.ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.ВыбытиеПоФиксированнойСтоимости)
	|	 		И (ТаблицаКорректировки.РазделУчета В (&БалансовыеРазделыУчета)
	|				ИЛИ ТаблицаКорректировки.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца))
	|	)
	// На прочие расходы будут отнесены положительные суммы отклонения в стоимости или отрицательные суммы отклонения для сторно движений.
	|	И (ВЫБОР 
	|		КОГДА ЗнакСторно * (Стоимость + ДопРасходы + Трудозатраты + ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС) >= 0
	|			ИЛИ ЗнакСторно * (СтоимостьБезНДС + ДопРасходыБезНДС + Трудозатраты + ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС) >= 0
	|			ИЛИ ЗнакСторно * (СтоимостьРегл + ДопРасходыРегл + ТрудозатратыРегл + ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл + РезервПодОбесценениеРегл) >= 0
	|			ИЛИ ЗнакСторно * (СтоимостьУпр + ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр + РезервПодОбесценениеУпр) >= 0
	|			ИЛИ ЗнакСторно * СтоимостьЗабалансовая > 0
	|			ИЛИ ЗнакСторно * СтоимостьЗабалансоваяРегл > 0
	|			ИЛИ ЗнакСторно * СтоимостьНДД > 0
	|				ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ХозяйственнаяОперация
	|;
	|";
	
	#КонецОбласти
	
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

Процедура СформироватьДвиженияСебестоимостьТоваровЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	ИмяВременнойТаблицы = "ВтСебестоимостьТоваров";
	
	// Кор. стоимость не включается в список полей.
	КопируемыеПоля = "
	|Период, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, Организация,
	|ХозяйственнаяОперация, ДокументРасчета,
	|КорАналитикаУчетаНоменклатуры, КорРазделУчета, КорВидЗапасов,КорОрганизация,
	|АналитикаУчетаПоПартнерам, ЗаказКлиента,
	|Подразделение, АналитикаРасходов, СтатьяРасходовСписания, СтатьяДоходов, АналитикаДоходов,
	|СтатьяАктивовПассивов, АналитикаАктивовПассивов,
	|ИдентификаторСтроки, КодСтроки, ДокументДвижения, ПериодПродажи, ГруппаПродукции,
	|КорНаправлениеДеятельности,
	|Стоимость, СтоимостьБезНДС, СтоимостьЗабалансовая, ДопРасходы, ДопРасходыБезНДС,
	|ПостояннаяРазница, ВременнаяРазница, СтоимостьРегл, СтоимостьЗабалансоваяРегл,
	|СтоимостьНДД,
	|КорПартия, КорАналитикаУчетаПартий, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС,
	|НДСРегл, НДСУпр, СтатьяКалькуляции, ТипЗаписи, ДокументИсточник, Сторно,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи, НастройкаСчетовУчета, РасчетНеЗавершен,
	|ОперацияУчетаСебестоимости, СпособОпределенияСебестоимости
	|";
	
	Если ПараметрыРасчета.ПартионныйУчетВерсии22 Тогда
		КопируемыеПоля = КопируемыеПоля + ",
		|Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
		|Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС,
		|ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл,
		|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеРегл,
		|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр,
		|РезервПодОбесценениеРегл, РезервПодОбесценениеУпр,
		|";
	КонецЕсли;

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеРегл",
	"ВЫБОР
	|	КОГДА НЕ СписыватьРезервы ТОГДА РезервПодОбесценениеРегл
	|	ИНАЧЕ 0
	|КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеУпр",
	"ВЫБОР
	|	КОГДА НЕ СписыватьРезервы ТОГДА РезервПодОбесценениеУпр
	|	ИНАЧЕ 0
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Количество", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ВидДвижения");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияСебестоимостьТоваровСписаниеРезервовЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	ИмяВременнойТаблицы = "ВтСебестоимостьТоваровРезервы";
	
	КопируемыеПоля = "
	|Период, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, Организация,
	|ХозяйственнаяОперация, ДокументРасчета,
	|КорАналитикаУчетаНоменклатуры, КорВидЗапасов, КорОрганизация,
	|АналитикаУчетаПоПартнерам, ЗаказКлиента,
	|Подразделение, АналитикаРасходов, СтатьяРасходовСписания, СтатьяДоходов, АналитикаДоходов,
	|СтатьяАктивовПассивов, АналитикаАктивовПассивов,
	|ИдентификаторСтроки, КодСтроки, ДокументДвижения, ПериодПродажи, ГруппаПродукции,
	|КорНаправлениеДеятельности,
	|КорПартия, КорАналитикаУчетаПартий, КорАналитикаФинансовогоУчета, КорВидДеятельностиНДС,
	|СтатьяКалькуляции, ТипЗаписи, ДокументИсточник, Сторно,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи, НастройкаСчетовУчета,
	|ОперацияУчетаСебестоимости, СпособОпределенияСебестоимости,
	|Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС,
	|РезервПодОбесценениеРегл, РезервПодОбесценениеУпр
	|";
	
	Если ПараметрыРасчета.Движения.Свойство(ИмяРегистра) Тогда
		ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	Иначе
		ОписаниеПриемника = ПараметрыРасчета.ВспомогательныеВременныеТаблицы[ИмяРегистра];
	КонецЕсли;
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорРазделУчета", "
	|ВЫБОР
	|	КОГДА ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
	|			)
	|		ТОГДА НЕОПРЕДЕЛЕНО
	|	ИНАЧЕ
	|		КорРазделУчета
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеРегл",
	"ВЫБОР
	|	КОГДА СписыватьРезервы ТОГДА РезервПодОбесценениеРегл
	|	ИНАЧЕ 0
	|КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеУпр",
	"ВЫБОР
	|	КОГДА СписыватьРезервы ТОГДА РезервПодОбесценениеУпр
	|	ИНАЧЕ 0
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Количество", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ВидДвижения");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация",
	"ВЫБОР
	|	КОГДА ВосстанавливатьРезервы ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВосстановлениеРезервовПодОбесценениеЗапасов)
	|	ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРезервовПодОбесценениеЗапасов)
	|КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации",
	"ВЫБОР
	|	КОГДА ВосстанавливатьРезервы ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВосстановлениеРезервовПодОбесценениеЗапасов)
	|	ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеРезервовПодОбесценениеЗапасов)
	|КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходовСписания",
	"ВЫБОР
	|	КОГДА ВосстанавливатьРезервы ТОГДА НЕОПРЕДЕЛЕНО
	|	ИНАЧЕ СтатьяРасходовСписания
	|КОНЕЦ");
	
	УсловиеГДЕ = "
	|	СписыватьРезервы
	|	И (РезервПодОбесценениеРегл <> 0 ИЛИ РезервПодОбесценениеУпр <> 0)
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьКорДвиженияСебестоимостьТоваровЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	ИмяВременнойТаблицы = "ВтСебестоимостьТоваровКор";
	
	КопируемыеПоля = "
	|Период, ДокументДвижения, ИдентификаторСтроки, Сторно,
	|Подразделение, ГруппаПродукции, ДокументРасчета,
	|Стоимость, СтоимостьЗабалансовая, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС,
	|СтоимостьРегл, СтоимостьЗабалансоваяРегл, ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьНДД,
	|ИдентификаторФинЗаписи, НастройкаСчетовУчета,
	|ОперацияУчетаСебестоимости, СпособОпределенияСебестоимости";
	Если ПараметрыРасчета.ПартионныйУчетВерсии22 Тогда
		КопируемыеПоля = КопируемыеПоля + ",
		|СтатьяКалькуляции,
		|Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС,
		|ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл,
		|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеРегл,
		|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр, НДСУпр
		|РезервПодОбесценениеРегл, РезервПодОбесценениеУпр";
	КонецЕсли;
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаНоменклатуры", "КорАналитикаУчетаНоменклатуры");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РазделУчета", "КорРазделУчета");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидЗапасов", "КорВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"ХозяйственнаяОперация",
		"
	//++ НЕ УТКА
		|ВЫБОР
		|	КОГДА ДокументДвижения ССЫЛКА Документ.ОтчетДавальцуМеждуОрганизациями
		|			И ОперацияУчетаСебестоимости = ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.Реализация)
		|			И РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
		|			И КорОрганизация ССЫЛКА Справочник.Организации
		|			И НЕ КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|		ТОГДА ХозяйственнаяОперация
		|	ИНАЧЕ 
	//-- НЕ УТКА
		|		ПриходХозяйственнаяОперация
	//++ НЕ УТКА
		|КОНЕЦ
	//-- НЕ УТКА
		|");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТипЗаписи", "ПриходТипЗаписи");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации", "ПриходНастройкаХозяйственнойОперации");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", 
			"ВЫБОР 
			|	КОГДА КорОрганизация ЕСТЬ NULL ИЛИ КорОрганизация = Неопределено 
			|		ИЛИ КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) ТОГДА 
			|		Организация 
			|	ИНАЧЕ 
			|		КорОрганизация 
			|КОНЕЦ"); 
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Количество", "0");
	
	Если ПараметрыРасчета.ПартионныйУчетВерсии22 Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Партия", "КорПартия");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаПартий", "КорАналитикаУчетаПартий");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаФинансовогоУчета", "КорАналитикаФинансовогоУчета");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДеятельностиНДС", "КорВидДеятельностиНДС");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорВидДеятельностиНДС", "ВидДеятельностиНДС");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорАналитикаФинансовогоУчета", "
		|ВЫБОР 
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) ТОГДА
		|		ВЫБОР 
		|			КОГДА АналитикаФинансовогоУчета ССЫЛКА Справочник.ГруппыАналитическогоУчетаНоменклатуры ТОГДА
		|				АналитикаФинансовогоУчета
		|			ИНАЧЕ
		|				ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
		|		КОНЕЦ
		|	ИНАЧЕ
		|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "АналитикаФинансовогоУчета") + "
		|КОНЕЦ");
				
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ГруппаПродукции", "
		|ВЫБОР 
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
		|	 И ТипЗаписи <> ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Выпуск) ТОГДА
		|		КорАналитикаФинансовогоУчета
		|	ИНАЧЕ
		|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "ГруппаПродукции") + "
		|КОНЕЦ");
		
		//++ НЕ УТ
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорАналитикаУчетаНоменклатуры", "
		|ВЫБОР 
		|	КОГДА ДокументДвижения ССЫЛКА Документ.РаспределениеВозвратныхОтходов
		|		И КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) ТОГДА
		|		АналитикаУчетаНоменклатурыВО
		|	ИНАЧЕ
		|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "ПриходКорАналитикаУчетаНоменклатуры") + "
		|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорАналитикаФинансовогоУчета", "
		|ВЫБОР 
		|	КОГДА ДокументДвижения ССЫЛКА Документ.РаспределениеВозвратныхОтходов
		|		И КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) ТОГДА
		|		АналитикаФинансовогоУчетаВО
		|	ИНАЧЕ
		|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "АналитикаФинансовогоУчета") + "
		|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ИдентификаторФинЗаписи", "
		// В документе "Отчет давальцу" расходное движение в регистре "Себестоимости товаров" корреспондирует с регистром "Ввыручка и себестоимость продаж"
		// по идентификатору фин записи и настройке хоз операции по балансовым стоимостям.
		// По забалансовой стоимости должна быть отдельная корреспонденция.
		// Но в связи с отсутствием отдельного движения по забалансовой стоимости идентификатор фин записи в приходном движении
		// заполняется служебным идентификатором для отключения лишней корреспонденции приходного и расходного движения по себестоимости.
		|ВЫБОР 
		|	КОГДА ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
		|	 И КорВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца)
		|		ТОГДА &ИдентификаторНеиспользуемойФинЗаписи
		|	КОГДА КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
		|		ТОГДА &ИдентификаторНеиспользуемойФинЗаписи
		|	ИНАЧЕ
		|		ИдентификаторФинЗаписи
		|КОНЕЦ");
		
		//-- НЕ УТ
		
	КонецЕсли;
	
	// Суммы в валюте управленческого учета.
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Стоимость",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ Стоимость КОНЕЦ");
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДС",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ СтоимостьБезНДС КОНЕЦ");
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходы",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ ДопРасходы КОНЕЦ");
			
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыБезНДС",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ ДопРасходыБезНДС КОНЕЦ");
			
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Трудозатраты",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ Трудозатраты КОНЕЦ");
			
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеСНДС",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ ПостатейныеПостоянныеСНДС КОНЕЦ");
			
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеБезНДС",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ ПостатейныеПостоянныеБезНДС КОНЕЦ");
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеСНДС",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ ПостатейныеПеременныеСНДС КОНЕЦ");
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеБезНДС",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
		|	  ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
		|	  ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания) ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями И КорОрганизацияНаСреднескользящей ТОГДА 0
		|	ИНАЧЕ ПостатейныеПеременныеБезНДС КОНЕЦ");
			
	// Суммы в валюте регламентированного учета.
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьРегл",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
		|		)
		|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
		|		ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0 
		|	ИНАЧЕ СтоимостьРегл 
		|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьЗабалансовая",
		// Условие должно быть аналогично РасчетСебестоимостиРешениеСЛУ.ТекстВтПеремещенияСписания(), поле НеПеремещатьЗабалансовуюСтоимость
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыкупТоваровДавальца)
		|	ТОГДА 0
		|	КОГДА ВидЗапасов.ТипЗапасов В
		|		(ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца),
		|		 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
		|		 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца))
		|		И (НЕ КорВидЗапасов.ТипЗапасов В
		|		     (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца),
		|		      ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
		|		      ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца))
		|			ИЛИ КорАналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа))
		|	ТОГДА 0
		|	ИНАЧЕ СтоимостьЗабалансовая КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьЗабалансоваяРегл",
		// Условие должно быть аналогично РасчетСебестоимостиРешениеСЛУ.ТекстВтПеремещенияСписания(), поле НеПеремещатьЗабалансовуюСтоимость
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыкупТоваровДавальца)
		|	ТОГДА 0
		|	КОГДА ВидЗапасов.ТипЗапасов В
		|		(ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца),
		|		 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
		|		 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца))
		|		И (НЕ КорВидЗапасов.ТипЗапасов В
		|		     (ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.МатериалДавальца),
		|		      ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
		|		      ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияДавальца))
		|			ИЛИ КорАналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа))
		|	ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0 ИНАЧЕ СтоимостьЗабалансоваяРегл КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", 
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
		|		)
		|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
		|		ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
		|	ИНАЧЕ ПостояннаяРазница
		|КОНЕЦ");
			
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница",
		"ВЫБОР
		|	КОГДА ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
		|		)
		|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
		|		ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0 
		|	ИНАЧЕ ВременнаяРазница 
		|КОНЕЦ");
			
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьНДД","
		|ВЫБОР
		|	КОГДА ХозяйственнаяОперация В (
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
		|		)
		|		ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
		|		ТОГДА 0
		|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0 
		|	ИНАЧЕ СтоимостьНДД 
		|КОНЕЦ");
	
	Если ПараметрыРасчета.ПартионныйУчетВерсии22 Тогда
	
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыРегл",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	ИНАЧЕ ДопРасходыРегл
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТрудозатратыРегл",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0 
			|	ИНАЧЕ ТрудозатратыРегл
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеРегл",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	ИНАЧЕ ПостатейныеПостоянныеРегл
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеРегл",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	ИНАЧЕ ПостатейныеПеременныеРегл
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеРегл",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	КОГДА НЕ СписыватьРезервы ТОГДА РезервПодОбесценениеРегл
			|	ИНАЧЕ 0
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьУпр",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	ИНАЧЕ СтоимостьУпр
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыУпр",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	ИНАЧЕ ДопРасходыУпр
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТрудозатратыУпр",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	ИНАЧЕ ТрудозатратыУпр
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеУпр",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	ИНАЧЕ ПостатейныеПостоянныеУпр
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеУпр",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	ИНАЧЕ ПостатейныеПеременныеУпр
			|КОНЕЦ");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеУпр",
			"ВЫБОР
			|	КОГДА ХозяйственнаяОперация В (
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
			|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
			|		)
			|	 ИЛИ КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранениеКОформлениюСписания)
			|		ТОГДА 0
			|	КОГДА ЭтоПередачаМеждуОрганизациями ТОГДА 0
			|	КОГДА НЕ СписыватьРезервы ТОГДА РезервПодОбесценениеУпр
			|	ИНАЧЕ 0
			|КОНЕЦ");
			
	КонецЕсли;
	
	УсловиеГДЕ = "
	|	НЕ КорРазделУчета ЕСТЬ NULL 
	|	И КорРазделУчета <> Неопределено
	|	И КорРазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|	И ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями)
	|	И ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)
	|	И НЕ (
	|		ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию) 
	|		И РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	)
	|";
	
	Если ПараметрыРасчета.Свойство("ТолькоОднаОрганизация") И ПараметрыРасчета.ТолькоОднаОрганизация Тогда
		УсловиеГДЕ = УсловиеГДЕ + "
		|	И (ВЫБОР 
		|		КОГДА КорОрганизация ЕСТЬ NULL ИЛИ КорОрганизация = НЕОПРЕДЕЛЕНО 
		|		 ИЛИ КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
		|			ТОГДА ИСТИНА
		|		КОГДА НЕ КорОрганизация В (&МассивОрганизаций)
		|			ТОГДА ЛОЖЬ
		|		ИНАЧЕ ИСТИНА КОНЕЦ)
		|";
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	// Отражение списания резервов под обесценение запасов.
	ИмяВременнойТаблицыРезервы = ИмяВременнойТаблицы + "Резервы";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации", 
		"ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеРезервовПодОбесценениеЗапасов)");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Стоимость", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДС", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьЗабалансовая", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходы", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыБезНДС", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Трудозатраты", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеСНДС", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеСНДС", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеБезНДС", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеБезНДС", "0");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьРегл",
		"ВЫБОР
		|	КОГДА СпособОпределенияСебестоимости = ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей)
		|		ТОГДА 0
		|	КОГДА ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
		|		ТОГДА 0
		| 	КОГДА НЕ ЭтоПередачаМеждуОрганизациями И СписыватьРезервы
		|		ТОГДА РезервПодОбесценениеРегл
		|	ИНАЧЕ 0
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьЗабалансоваяРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "0"); 
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница",
		"ВЫБОР
		|	КОГДА СпособОпределенияСебестоимости = ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей)
		|		ТОГДА 0
		|	КОГДА ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
		|		ТОГДА 0
		|	КОГДА НЕ ЭтоПередачаМеждуОрганизациями И СписыватьРезервы ТОГДА РезервПодОбесценениеРегл
		|		ИНАЧЕ 0
		|	КОНЕЦ");
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьНДД","0"); 
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТрудозатратыРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьУпр",
		"ВЫБОР
		|	КОГДА СпособОпределенияСебестоимости = ЗНАЧЕНИЕ(Перечисление.СпособыОпределенияСебестоимостиТоваров.ПоСреднескользящей)
		|		ТОГДА 0
		|	КОГДА ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
		|		ТОГДА 0
		|	КОГДА НЕ ЭтоПередачаМеждуОрганизациями И СписыватьРезервы
		|		ТОГДА РезервПодОбесценениеУпр
		|	ИНАЧЕ 0
		|	КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыУпр", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТрудозатратыУпр", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеУпр", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеУпр", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеУпр", "0");
	
	УсловиеГДЕ = УсловиеГДЕ + "
		|	И (ВЫБОР
		|		КОГДА НЕ ЭтоПередачаМеждуОрганизациями 
		|		 И СписыватьРезервы 
		|		 И РезервПодОбесценениеРегл <> 0 ИЛИ РезервПодОбесценениеУпр <> 0 ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ КОНЕЦ)
		|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицыРезервы, УсловиеГДЕ);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицыРезервы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияСебестоимостьТоваровСторноВУпрУчетеЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)

	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	ИмяВременнойТаблицы = "ВтСебестоимостьТоваровСторноУпр";
	
	КопируемыеПоля = "
	|Период, Организация, РазделУчета,
	|ХозяйственнаяОперация, ДокументДвижения, Регистратор, ДокументРасчета,
	|Подразделение, АналитикаРасходов, СтатьяРасходовСписания,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи, НастройкаСчетовУчета,
	|Стоимость, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС,
	|СтатьяКалькуляции, ТипЗаписи, ДокументИсточник, Сторно,
	|Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС";
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", "КорОрганизация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаНоменклатуры", "КорАналитикаУчетаНоменклатуры");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидЗапасов", "КорВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьУпр", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Количество", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РазделУчета", "
	|ВЫБОР
	|	КОГДА РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "РазделУчета") + "
	|КОНЕЦ
	|");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Партия", "КорПартия");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаПартий", "КорАналитикаУчетаПартий");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаФинансовогоУчета", "КорАналитикаФинансовогоУчета");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДеятельностиНДС", "КорВидДеятельностиНДС");
	
	УсловиеГДЕ = "
	|	ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет)
	|	ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет)
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияОтклоненияВСтоимостиТоваровЗапросом(ПараметрыРасчета, Запрос, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений)
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Организация,
	|	Т.КорВидЗапасов КАК ВидЗапасов,
	|	Т.КорАналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.КорАналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|		ТОГДА Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоСкладам
	|		ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	|	ВЫБОР
	|		КОГДА НЕ ФинУчет.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	&НачалоПериода КАК ПериодОтклонения,
	|	&РежимЗакрытияМесяца КАК РежимЗакрытияМесяца,
	|	Т.Сторно,
	|
	|	СУММА(Т.СуммаСНДС) 			КАК ОтклоненияВСтоимостиСНДС,
	|	СУММА(Т.СуммаБезНДС) 		КАК ОтклоненияВСтоимостиБезНДС,
	|	СУММА(Т.СуммаРегл)			КАК ОтклоненияВСтоимостиРегл,
	|	СУММА(Т.СуммаУпр)			КАК ОтклоненияВСтоимостиУпр,
	|	СУММА(Т.ПостояннаяРазница)	КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница)	КАК ВременнаяРазница,
	|	СУММА(Т.СтоимостьНДД) 		КАК НДД
	|ПОМЕСТИТЬ ВтОтклоненияВСтоимостиТоваров
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ФинУчет
	|		ПО Т.Организация = ФинУчет.Организация
	|ГДЕ
	|	Т.Организация В(&ОрганизацииСреднескользящая)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.ДокументДвижения,
	|	Т.Организация,
	|	Т.КорВидЗапасов,
	|	Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|		ТОГДА Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоСкладам
	|		ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ФинУчет.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.Сторно
	|ИМЕЮЩИЕ
	|	СУММА(Т.СуммаСНДС) <> 0
	|	ИЛИ СУММА(Т.СуммаБезНДС) <> 0
	|	ИЛИ СУММА(Т.СуммаРегл) <> 0
	|	ИЛИ СУММА(Т.СуммаУпр) <> 0
	|	ИЛИ СУММА(Т.ПостояннаяРазница) <> 0
	|	ИЛИ СУММА(Т.ВременнаяРазница) <> 0
	|	ИЛИ СУММА(Т.СуммаРегл) <> 0
	|	ИЛИ СУММА(Т.СтоимостьНДД) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Организация,
	|	Т.КорВидЗапасов КАК ВидЗапасов,
	|	Т.КорАналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.КорАналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|		ТОГДА Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоСкладам
	|		ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	|	ВЫБОР
	|		КОГДА НЕ ФинУчет.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	Т.ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеРезервовПодОбесценениеЗапасов) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	&НачалоПериода КАК ПериодОтклонения,
	|	&РежимЗакрытияМесяца КАК РежимЗакрытияМесяца,
	|	Т.Сторно,
	|
	|	0 КАК ОтклоненияВСтоимостиСНДС,
	|	0 КАК ОтклоненияВСтоимостиБезНДС,
	|	СУММА(Т.РезервПодОбесценениеРегл) КАК ОтклоненияВСтоимостиРегл,
	|	СУММА(Т.РезервПодОбесценениеУпр)  КАК ОтклоненияВСтоимостиУпр,
	|	0	КАК ПостояннаяРазница,
	|	СУММА(Т.РезервПодОбесценениеРегл) КАК ВременнаяРазница,
	|	0 КАК НДД
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ФинУчет
	|		ПО Т.Организация = ФинУчет.Организация
	|ГДЕ
	|	Т.Организация В(&ОрганизацииСреднескользящая)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НЕ Т.ЭтоПередачаМеждуОрганизациями
	|	И Т.СписыватьРезервы
	|	И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.ДокументДвижения,
	|	Т.Организация,
	|	Т.КорВидЗапасов,
	|	Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|		ТОГДА Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоСкладам
	|		ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА НЕ ФинУчет.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ,
	|	Т.ХозяйственнаяОперация,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.Сторно
	|ИМЕЮЩИЕ
	|	СУММА(Т.РезервПодОбесценениеРегл) <> 0
	|	ИЛИ СУММА(Т.РезервПодОбесценениеУпр) <> 0
	|";
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ОтклоненияВСтоимостиТоваров.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтОтклоненияВСтоимостиТоваров");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтОтклоненияВСтоимостиТоваров", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияНоменклатураДоходыРасходыЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ,
			ЭтоДоход = Ложь, ХозяйственнаяОперация = Неопределено, СтруктураКорректировкиСумм = Неопределено)

	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя;
	
	КопируемыеПоля =
	"Период, ХозяйственнаяОперация, Организация, Подразделение,
	|АналитикаУчетаНоменклатуры,Склад,ТипЗапасов,ВидЗапасов,
	|ИсточникГФУНоменклатуры, ДокументДвижения, Сторно";
	
	СуммовыеПоля = "
	|Стоимость, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, 
	|СтоимостьРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр,
	|СтоимостьЗабалансовая, СтоимостьЗабалансоваяРегл,
	|ПостояннаяРазница, ВременнаяРазница,
	|НДСРегл, НДСУпр, 
	|РезервПодОбесценениеРегл, РезервПодОбесценениеУпр
	|";
	
	КопируемыеПоля = КопируемыеПоля + ", " + СуммовыеПоля;

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	СкладКолонка = РасчетСебестоимостиПрикладныеАлгоритмы.КолонкиВременнойТаблицы(ПараметрыРасчета, "ДвиженияТаблицаКорректировки", Ложь).Найти("Склад");
	Если Не СкладКолонка = Неопределено
		И СкладКолонка.ТипЗначения.СодержитТип(Тип("СправочникСсылка.ДоговорыКонтрагентов")) Тогда
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(
			ТаблицаОписанияПолей,
			"Склад",
			"ВЫБОР
			|	КОГДА ТИПЗНАЧЕНИЯ(Склад) = ТИП(Справочник.ДоговорыКонтрагентов)
			|		ТОГДА ВЫРАЗИТЬ(Склад КАК Справочник.ДоговорыКонтрагентов).Партнер
			|	ИНАЧЕ Склад
			|КОНЕЦ");
		
	КонецЕсли;
	
	Если ХозяйственнаяОперация <> Неопределено Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", "&ХозяйственнаяОперация");
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеРегл",
	"ВЫБОР
	|	КОГДА СписыватьРезервы ТОГДА РезервПодОбесценениеРегл
	|	ИНАЧЕ 0
	|КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеУпр",
	"ВЫБОР
	|	КОГДА СписыватьРезервы ТОГДА РезервПодОбесценениеУпр
	|	ИНАЧЕ 0
	|КОНЕЦ");
	
	Если ЭтоДоход Тогда
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяДоходовРасходов",
			"ВЫБОР КОГДА (СтатьяАктивовПассивов ЕСТЬ NULL ИЛИ СтатьяАктивовПассивов = Неопределено ИЛИ СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка))
		    |	ТОГДА СтатьяДоходов
		    |	ИНАЧЕ СтатьяАктивовПассивов
		    |КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаДоходов", "АналитикаДоходов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельностиНоменклатуры", "НаправлениеДеятельности");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельностиСтатьи", "КорНаправлениеДеятельности");
		
	Иначе
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяДоходовРасходов",
			"ВЫБОР КОГДА (СтатьяАктивовПассивов ЕСТЬ NULL ИЛИ СтатьяАктивовПассивов = Неопределено ИЛИ СтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка))
		    |	ТОГДА СтатьяРасходовСписания
		    |	ИНАЧЕ СтатьяАктивовПассивов
		    |КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов", "АналитикаРасходов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельностиСтатьи", "КорНаправлениеДеятельности");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельностиНоменклатуры", "
		|ВЫБОР
		|	КОГДА " + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация") 
					+ " = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию) И КорТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
		|		КорНаправлениеДеятельности
		|	ИНАЧЕ
		|		НаправлениеДеятельности
		|	КОНЕЦ");
		
	КонецЕсли;
	
	Если СтруктураКорректировкиСумм <> Неопределено Тогда
		
		МассивПолей = СтрРазделить(СуммовыеПоля, ",");
		Для Каждого Поле Из МассивПолей Цикл
			
			мПоле = СтрЗаменить(СтрЗаменить(СокрЛП(Поле), Символы.ПС, ""), Символы.Таб, "");
			НовоеПоле = СкорректироватьСуммовоеПолеДвиженияНоменклатурыЗапросом(мПоле, СтруктураКорректировкиСумм);
			
			РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, мПоле, НовоеПоле);
			
		КонецЦикла;
		
	КонецЕсли;
	
	СтруктураПараметров = Новый Структура("ХозяйственнаяОперация", ХозяйственнаяОперация);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ, СтруктураПараметров);
			
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияНоменклатураНоменклатураЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ, ТекстХозяйственнаяОперация)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураНоменклатура.Имя;
	
	КопируемыеПоля =
	"Период, ХозяйственнаяОперация, Организация,
	|АналитикаУчетаНоменклатуры,Склад,ТипЗапасов,ВидЗапасов,
	|КорАналитикаУчетаНоменклатуры,КорСклад,КорТипЗапасов,КорВидЗапасов,
	|ИсточникГФУНоменклатуры, КорИсточникГФУНоменклатуры, ДокументДвижения, КорОрганизация, Сторно";

	СуммовыеПоля = "
	|Стоимость, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, 
	|СтоимостьРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр,
	|СтоимостьЗабалансовая, СтоимостьЗабалансоваяРегл,
	|ПостояннаяРазница, ВременнаяРазница,
	|НДСРегл, НДСУпр, 
	|РезервПодОбесценениеРегл, РезервПодОбесценениеУпр
	|";
	
	КопируемыеПоля = КопируемыеПоля + ", " + СуммовыеПоля;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Подразделение", "
	|ВЫБОР
	|	КОГДА ПодразделениеДокумента <> ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		ТОГДА ПодразделениеДокумента
	|	ИНАЧЕ Подразделение
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельности", "
	|ВЫБОР
	|	КОГДА ЛОЖЬ ТОГДА НЕОПРЕДЕЛЕНО // Для удобства расстановки тегов

	//++ НЕ УТ
	|	КОГДА ТИПЗНАЧЕНИЯ(Партия) = ТИП(Справочник.ПартииПроизводства)
	|		ТОГДА ВЫРАЗИТЬ(Партия КАК Справочник.ПартииПроизводства).НаправлениеДеятельности
	//-- НЕ УТ
	|	ИНАЧЕ АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорНаправлениеДеятельности", "
	|КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", ТекстХозяйственнаяОперация);
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", "
	|ВЫБОР
	|	КОГДА " + ТекстХозяйственнаяОперация + " В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВнутреннееПоступлениеТоваров), ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВнутреннееПоступлениеРабот)) ТОГДА
	|		КорОрганизация
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "Организация") + "
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорОрганизация", "
	|ВЫБОР
	|	КОГДА " + ТекстХозяйственнаяОперация + " В (ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВнутреннееПоступлениеТоваров), 
	|												ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВнутреннееПоступлениеРабот)) ТОГДА
	|		Организация
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "КорОрганизация") + "
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Количество", "
	|ВЫБОР
	|	КОГДА Склад ССЫЛКА Справочник.Партнеры ТОГДА
	|		Количество
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "Количество") + "
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорНаправлениеДеятельности", "
	|ВЫБОР
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссию) ТОГДА
	|		НаправлениеДеятельности
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "КорНаправлениеДеятельности") + "
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияПоОборотнымРегистрамУпрУчетаЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)
	
	ТекстЕстьНенулеваяПолнаяСумма = "
	|	ВЫБОР 
	|		КОГДА СуммаСНДС <> 0 ИЛИ СуммаБезНДС  <> 0 ИЛИ СуммаРегл  <> 0 ИЛИ СуммаУпр <> 0
	|		 ИЛИ РезервПодОбесценениеРегл <> 0 ИЛИ РезервПодОбесценениеУпр <> 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ
	|			ЛОЖЬ
	|	КОНЕЦ
	|";
	
	УсловиеЗапроса = ТекстЕстьНенулеваяПолнаяСумма + "
	|	И ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваров),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноСписанияНаРасходы),
	//++ НЕ УТ
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставОС),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВСоставНМА),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровУПереработчика),
	//++ НЕ УТКА
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровДавальцаЗаСчетДавальца),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровДавальцаНаРасходы),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы),
	//-- НЕ УТКА

	//-- НЕ УТ
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаПрочиеЦели),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионераОСписании),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакрытиеМесяца),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНедостачЗаСчетПоклажедателя),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНедостачЗаСчетКомитента),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОприходованиеИзлишковТоваровВПользуКомитента),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОприходованиеИзлишковТоваровВПользуПоклажедателя)
	|	)";

	СформироватьДвиженияНоменклатураДоходыРасходыЗапросом(ПараметрыРасчета, "ВтДоходыРасходыСписаниеТоваров", СоответствиеВременныхТаблицДвижений, УсловиеЗапроса);
			
	УсловиеЗапроса = ТекстЕстьНенулеваяПолнаяСумма + "
	|	И (
	|		(
	|			(
	|				ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами)
	|				ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеПолуфабрикатовМеждуФилиалами)
	|				ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами)
	|			)
	|			И ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		)
	|		
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратИзПроизводства)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратМатериаловИзПроизводства)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратМатериаловИзКладовой)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтКомиссионера)
	//++ Устарело_Переработка24
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика)
	//-- Устарело_Переработка24
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтПереработчика2_5)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	//++ Устарело_Переработка24
	|		ИЛИ (ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика)
	|			И ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	//-- Устарело_Переработка24
	|		ИЛИ (ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПоступлениеОтПереработчика2_5)
	|			И ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзКладовой)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаОбособленногоУчета)
	|		ИЛИ ((ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваров) ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеПолуфабрикатов) ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуПодразделениями)) И ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВПроизводство)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаМатериаловВПроизводство)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаМатериаловВКладовую)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссию)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию)
	//++ Устарело_Переработка24
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику)
	//-- Устарело_Переработка24
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПереработчику2_5)
	|		ИЛИ (ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаТоваров) И ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	|		ИЛИ (ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПорчаТоваров) И ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
	|		ИЛИ (ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности) И РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути))
	|		ИЛИ (ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности)
	|			И НЕ РазделУчета В (
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути),
	|				ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути)))
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РазборкаТоваров)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСНеотфактурованнаяПоставка)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСПоступлениеИзТоваровВПути)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаПоИмпортуПоступлениеИзТоваровВПути)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаНеотфактурованнаяПоставка)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаПоступлениеИзТоваровВПути)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаХранениеСПравомПродажи)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратОтХранителя)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыкупТоваровДавальца)
	|	)
	|
	|	И НЕ ((КорАналитикаУчетаНоменклатуры ЕСТЬ NULL ИЛИ КорАналитикаУчетаНоменклатуры = Неопределено ИЛИ КорАналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка))
	|		И (
	|			ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СборкаТоваров)
	|			ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РазборкаТоваров)
	|		 	ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности)
	|		 	ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности)
	|		)	
	|	)
	|	И НЕ ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВключениеАкцизаВСтоимость)
	|";
			
	СформироватьДвиженияНоменклатураНоменклатураЗапросом(ПараметрыРасчета
		,"ВтДвиженияНоменклатураНоменклатураПеремещение"
		,СоответствиеВременныхТаблицДвижений
		,УсловиеЗапроса
		,"ВЫБОР
		|	КОГДА ХозяйственнаяОперация В (
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности),
		|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности)) ТОГДА
		|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтгрузкаБезПереходаПраваСобственности)
		|	ИНАЧЕ
		|		ХозяйственнаяОперация
		|КОНЕЦ");
				
	УсловиеЗапросаВнутреннееПоступлениеТоваров = УсловиеЗапроса + "
	|	И (
	|		ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами)
	|		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеПолуфабрикатовМеждуФилиалами)
	|	)";

	СформироватьДвиженияНоменклатураНоменклатураЗапросом(ПараметрыРасчета
		,"ВтДвиженияНоменклатураНоменклатураВнутреннееПоступлениеТоваров"
		,СоответствиеВременныхТаблицДвижений
		,УсловиеЗапросаВнутреннееПоступлениеТоваров
		,"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВнутреннееПоступлениеТоваров)");
	
	УсловиеЗапросаВнутреннееПоступлениеРабот = УсловиеЗапроса + "
	|	И ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами)";

	СформироватьДвиженияНоменклатураНоменклатураЗапросом(ПараметрыРасчета
		,"ВтДвиженияНоменклатураНоменклатураВнутреннееПоступлениеРабот"
		,СоответствиеВременныхТаблицДвижений
		,УсловиеЗапросаВнутреннееПоступлениеРабот
		,"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВнутреннееПоступлениеРабот)");
	
	УсловиеЗапроса = "
	|	(ПолнаяСуммаПереоценки > 0 ИЛИ СуммаРегл > 0 ИЛИ СуммаУпр > 0)
	|	И ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровПоставщику),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПорчаТоваровСПереоценкой),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияПереданнойВозвратнойТары),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТары),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаПартийТоваров))
	|";
	
	СтруктураКорректировкиСумм = Новый Структура();
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыСНДС", 1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыБезНДС", 1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыРегл", 1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыУпр", 1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентКорСуммы", 1);
	
	СформироватьДвиженияНоменклатураДоходыРасходыЗапросом(ПараметрыРасчета, "ВтДоходыРасходыРасходыОтПереоценкиТоваров", СоответствиеВременныхТаблицДвижений, УсловиеЗапроса, 
		Ложь, 
		Перечисления.ХозяйственныеОперации.РасходыОтПереоценкиТоваров, 
		СтруктураКорректировкиСумм);
	
	УсловиеЗапроса = "
	|	(ПолнаяСуммаПереоценки < 0 ИЛИ (СуммаРегл + РезервПодОбесценениеРегл) < 0 ИЛИ (СуммаУпр + РезервПодОбесценениеУпр) < 0)
	|	И ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровПоставщику),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПорчаТоваровСПереоценкой),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияПереданнойВозвратнойТары),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТары),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПересортицаПартийТоваров))
	|";
	
	СтруктураКорректировкиСумм = Новый Структура();
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыСНДС", -1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыБезНДС", -1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыРегл", -1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентСуммыУпр", -1);
	СтруктураКорректировкиСумм.Вставить("КоэффициентКорСуммы", 1);
	
	СформироватьДвиженияНоменклатураДоходыРасходыЗапросом(ПараметрыРасчета, "ВтДоходыРасходыДоходыОтПереоценкиТоваров", СоответствиеВременныхТаблицДвижений, УсловиеЗапроса, 
		Истина, 
		Перечисления.ХозяйственныеОперации.ДоходыОтПереоценкиТоваров, 
		СтруктураКорректировкиСумм);
	
КонецПроцедуры

Функция СкорректироватьСуммовоеПолеДвиженияНоменклатурыЗапросом(Поле, СтруктураКорректировкиСумм)
	
	ИменаПолейСНДС   = Новый Структура("Стоимость, ДопРасходы, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС");
	ИменаПолейБезНДС = Новый Структура("СтоимостьБезНДС, ДопРасходыБезНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС");
	ИменаПолейРегл   = Новый Структура("СтоимостьРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл");
	ИменаПолейУпр 	 = Новый Структура("СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	ИменаПолейУменьшаемойСтоимости = Новый Структура("Стоимость, СтоимостьБезНДС");
	
	НовоеПоле = Поле;
	
	Если ИменаПолейСНДС.Свойство(Поле) Тогда
		
		Если ИменаПолейУменьшаемойСтоимости.Свойство(Поле) Тогда
			НовоеПоле = "(" + Поле + " - КорСтоимость * " + Формат(СтруктураКорректировкиСумм.КоэффициентКорСуммы, "ЧРД=.; ЧН=0; ЧГ=0") + ") * " + Формат(СтруктураКорректировкиСумм.КоэффициентСуммыСНДС, "ЧРД=.; ЧН=0; ЧГ=0");
		Иначе
			НовоеПоле = Поле + " * " + Формат(СтруктураКорректировкиСумм.КоэффициентСуммыСНДС, "ЧРД=.; ЧН=0; ЧГ=0");
		КонецЕсли;
		
	ИначеЕсли ИменаПолейБезНДС.Свойство(Поле) Тогда
		
		Если ИменаПолейУменьшаемойСтоимости.Свойство(Поле) Тогда
			НовоеПоле = "(" + Поле + " - КорСтоимость * " + Формат(СтруктураКорректировкиСумм.КоэффициентКорСуммы, "ЧРД=.; ЧН=0; ЧГ=0") + ") * " + Формат(СтруктураКорректировкиСумм.КоэффициентСуммыБезНДС, "ЧРД=.; ЧН=0; ЧГ=0");
		Иначе
			НовоеПоле = Поле + " * " + Формат(СтруктураКорректировкиСумм.КоэффициентСуммыБезНДС, "ЧРД=.; ЧН=0; ЧГ=0");
		КонецЕсли;
	
	ИначеЕсли ИменаПолейРегл.Свойство(Поле) Тогда
		
		НовоеПоле = Поле + " * " + Формат(СтруктураКорректировкиСумм.КоэффициентСуммыРегл, "ЧРД=.; ЧН=0; ЧГ=0");
	
	ИначеЕсли ИменаПолейУпр.Свойство(Поле) Тогда
		
		НовоеПоле = Поле + " * " + Формат(СтруктураКорректировкиСумм.КоэффициентСуммыУпр, "ЧРД=.; ЧН=0; ЧГ=0");
		
	КонецЕсли;
		
	Возврат НовоеПоле;
	
КонецФункции

Процедура СформироватьДвиженияПрочиеАктивыПассивыЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений)
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	(ВЫБОР
	|		КОГДА (Т.СуммаСНДС >= 0 И НЕ Т.Сторно) ИЛИ (Т.СуммаСНДС < 0 И Т.Сторно)
	|			ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КОНЕЦ) КАК ВидДвижения,
	|	Т.ДокументДвижения КАК Регистратор,
	// Измерения
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяАктивовПассивов КАК Статья,
	|	Т.АналитикаАктивовПассивов КАК Аналитика,
	// Ресурсы
	|	(ВЫБОР
	|		КОГДА (Т.СуммаСНДС >= 0 И НЕ Т.Сторно) ИЛИ (Т.СуммаСНДС < 0 И Т.Сторно)
	|			ТОГДА Т.СуммаСНДС
	|			+ ВЫБОР КОГДА Т.ЭтоВыпускПродукции ТОГДА Т.ИсходнаяСтоимость ИНАЧЕ 0 КОНЕЦ
	|		ИНАЧЕ -Т.СуммаСНДС КОНЕЦ) КАК Сумма,
	// Реквизиты
	|	Т.Сторно
	|
	|ПОМЕСТИТЬ ВтТаблицаДвиженияПрочиеАктивыПассивы
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И Т.СтатьяАктивовПассивов ССЫЛКА ПланВидовХарактеристик.СтатьиАктивовПассивов
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя);
	ОписаниеВТ.ИмяВТИсточника = "ВтТаблицаДвиженияПрочиеАктивыПассивы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
КонецПроцедуры

Процедура СформироватьДвиженияПоПрочимАктивамПассивамЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений)
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	// Измерения
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяАктивовПассивов КАК Статья,
	|	Т.АналитикаАктивовПассивов КАК Аналитика,
	|	Т.НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Дебет) КАК ДебетКредит,
	// Ресурсы
	|	(ВЫБОР
	|		КОГДА Т.СуммаСНДС > 0 И НЕ Т.Сторно ИЛИ Т.СуммаСНДС < 0 И Т.Сторно
	|			ТОГДА Т.СуммаСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаСНДС,
	|	(ВЫБОР
	|		КОГДА Т.СуммаБезНДС > 0 И НЕ Т.Сторно ИЛИ Т.СуммаБезНДС < 0 И Т.Сторно
	|			ТОГДА Т.СуммаБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	(ВЫБОР
	|		КОГДА Т.СуммаРегл > 0 И НЕ Т.Сторно ИЛИ Т.СуммаРегл < 0 И Т.Сторно
	|			ТОГДА Т.СуммаРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР
	|		КОГДА Т.СуммаУпр > 0 И НЕ Т.Сторно ИЛИ Т.СуммаУпр < 0 И Т.Сторно
	|			ТОГДА Т.СуммаУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	(ВЫБОР
	|		КОГДА Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница < 0 И Т.Сторно
	|			ТОГДА Т.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница < 0 И Т.Сторно
	|			ТОГДА Т.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	// Реквизиты
	|	Т.ДокументДвижения,
	|	Т.Сторно,
	|	Т.НастройкаХозяйственнойОперации,
	|	ВЫБОР
	|		КОГДА Т.ДокументДвижения ССЫЛКА Документ.РаспределениеПрочихЗатрат
	|			ТОГДА &ИдентификаторНеиспользуемойФинЗаписи
	|		ИНАЧЕ Т.ИдентификаторФинЗаписи
	|	КОНЕЦ КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВтТаблицаДвиженияПоПрочимАктивамПассивам
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И Т.СтатьяАктивовПассивов ССЫЛКА ПланВидовХарактеристик.СтатьиАктивовПассивов
	|	И ((Т.СуммаСНДС > 0 ИЛИ Т.СуммаБезНДС > 0 ИЛИ Т.СуммаРегл > 0 ИЛИ Т.СуммаУпр > 0)
	|		И НЕ Т.Сторно
	|		ИЛИ (Т.СуммаСНДС < 0 ИЛИ Т.СуммаБезНДС < 0 ИЛИ Т.СуммаРегл < 0 ИЛИ Т.СуммаУпр < 0)
	|		И Т.Сторно)
	|	И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	// Измерения
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяАктивовПассивов КАК Статья,
	|	Т.АналитикаАктивовПассивов КАК Аналитика,
	|	Т.НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Кредит) КАК ДебетКредит,
	// Ресурсы
	|	(ВЫБОР
	|		КОГДА Т.СуммаСНДС < 0 И НЕ Т.Сторно ИЛИ Т.СуммаСНДС > 0 И Т.Сторно
	|			ТОГДА -Т.СуммаСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаСНДС,
	|	(ВЫБОР
	|		КОГДА Т.СуммаБезНДС < 0 И НЕ Т.Сторно ИЛИ Т.СуммаБезНДС > 0 И Т.Сторно 
	|			ТОГДА -Т.СуммаБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	(ВЫБОР
	|		КОГДА Т.СуммаРегл < 0 И НЕ Т.Сторно ИЛИ Т.СуммаРегл > 0 И Т.Сторно 
	|			ТОГДА -Т.СуммаРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР
	|		КОГДА Т.СуммаУпр < 0 И НЕ Т.Сторно ИЛИ Т.СуммаУпр > 0 И Т.Сторно 
	|			ТОГДА -Т.СуммаУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	(ВЫБОР
	|		КОГДА Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница > 0 И Т.Сторно 
	|			ТОГДА -Т.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.СуммаРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница > 0 И Т.Сторно 
	|			ТОГДА -Т.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	// Реквизиты
	|	Т.ДокументДвижения,
	|	Т.Сторно,
	|	Т.НастройкаХозяйственнойОперации,
	|	ВЫБОР
	|		КОГДА Т.ДокументДвижения ССЫЛКА Документ.РаспределениеПрочихЗатрат
	|			ТОГДА &ИдентификаторНеиспользуемойФинЗаписи
	|		ИНАЧЕ Т.ИдентификаторФинЗаписи
	|	КОНЕЦ КАК ИдентификаторФинЗаписи
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И Т.СтатьяАктивовПассивов ССЫЛКА ПланВидовХарактеристик.СтатьиАктивовПассивов
	|	И ((Т.СуммаСНДС < 0 ИЛИ Т.СуммаБезНДС < 0 ИЛИ Т.СуммаРегл < 0 ИЛИ Т.СуммаУпр < 0)
	|		И НЕ Т.Сторно
	|		ИЛИ (Т.СуммаСНДС > 0 ИЛИ Т.СуммаБезНДС > 0 ИЛИ Т.СуммаРегл > 0 ИЛИ Т.СуммаУпр > 0)
	|		И Т.Сторно)
	|	И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)
	|
	// Передача в филиал (на стороне отправителя)
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	// Измерения
	|	Т.Организация,
	|	(ВЫБОР
	|		КОГДА НЕ Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение ЕСТЬ NULL
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение
	|		ИНАЧЕ Т.АналитикаУчетаНоменклатуры.Подразделение КОНЕЦ) КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.РасчетыСФилиалами) КАК Статья,
	|	Т.КорОрганизация КАК Аналитика,
	|	Т.НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Дебет) КАК ДебетКредит,
	// РесурсыS
	|	Т.СуммаСНДС КАК СуммаСНДС,
	|	Т.СуммаБезНДС КАК СуммаБезНДС,
	|	Т.СуммаРегл КАК СуммаРегл,
	|	Т.СуммаУпр КАК СуммаУпр,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	// Реквизиты
	|	Т.ДокументДвижения,
	|	Т.Сторно,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеПолуфабрикатовМеждуФилиалами),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами))
	|
	// Передача в филиал (на стороне получателя)
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	// Измерения
	|	Т.КорОрганизация КАК Организация,
	|	(ВЫБОР
	|		КОГДА НЕ Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение ЕСТЬ NULL
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение
	|		ИНАЧЕ Т.АналитикаУчетаНоменклатуры.Подразделение КОНЕЦ) КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.РасчетыСФилиалами) КАК Статья,
	|	Т.Организация КАК Аналитика,
	|	Т.НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Кредит) КАК ДебетКредит,
	// Ресурсы
	|	Т.СуммаСНДС КАК СуммаСНДС,
	|	Т.СуммаБезНДС КАК СуммаБезНДС,
	|	Т.СуммаРегл КАК СуммаРегл,
	|	Т.СуммаУпр КАК СуммаУпр,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	// Реквизиты
	|	Т.ДокументДвижения,
	|	Т.Сторно,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеПолуфабрикатовМеждуФилиалами),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами))
	|";
	Запрос.УстановитьПараметр("ИдентификаторНеиспользуемойФинЗаписи", ПроведениеДокументов.ИдентификаторНеиспользуемойФинЗаписи());
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ДвиженияПоПрочимАктивамПассивам.Имя);
	ОписаниеВТ.ИмяВТИсточника = "ВтТаблицаДвиженияПоПрочимАктивамПассивам";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
КонецПроцедуры

Процедура СформироватьДвиженияПрочиеРасходыВУпрУчетеЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ,
			СтруктураТекстовСуммовыхПоказателей)
			
	ТекстПред = "ВЫБОР КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * ";
	ТекстСумма = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстСумма;
	ТекстСуммаБезНДС = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстСуммаБезНДС;
	ТекстСуммаУпр = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстСуммаУпр;

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, АналитикаРасходов, ХозяйственнаяОперация,
	|АналитикаУчетаНоменклатуры, ГруппаПродукции, ДокументДвижения, Сторно,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи, ДокументРасчета";

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СтруктураПараметров = Новый Структура();
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "Знак * (" + ТекстСумма + ")");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходов", "СтатьяРасходовСписанияУпр");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов", "АналитикаРасходовУпр");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельности", "КорНаправлениеДеятельности");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", "
	|ВЫБОР
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию) ТОГДА
	|		КорОрганизация
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "Организация") + " 
	|КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаНоменклатуры", "
	|ВЫБОР
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад) ТОГДА
	|		КорАналитикаУчетаНоменклатуры
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаНоменклатуры") + " 
	|КОНЕЦ");

	// Условия по сумме без НДС должны совпадать с условиями в:
	// - см. СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом в приходном движении.
	// - см. СкорректироватьСтоимостьВозвратовПрошлыхПериодов.
	// - см. РегистрыНакопления.ПрочиеРасходы.ТекстЗапросаТаблицаВтПрочиеРасходы.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС", "
	|ВЫБОР
	|	КОГДА НЕ ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы))
	|		ТОГДА Знак * (" + ТекстСуммаБезНДС + ")
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС") + " 
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "
	|ВЫБОР
	|	КОГДА НЕ ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы) ТОГДА
	|		ВЫБОР
	|			КОГДА НЕ &УправленческийУчетОрганизаций ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию) ТОГДА
	|				0
	|			КОГДА ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы) И НЕ &ИспользуетсяУправлениеВНА_2_4 ТОГДА
	|				0
	|			ИНАЧЕ
	|				Знак * (" + ТекстСуммаУпр + ")
	|		КОНЕЦ
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "СуммаУпр") + " 
	|КОНЕЦ");
	
	СтруктураПараметров.Вставить("УправленческийУчетОрганизаций", ПараметрыРасчета.УправленческийУчетОрганизаций);
	СтруктураПараметров.Вставить("ИспользуетсяУправлениеВНА_2_4", ПараметрыРасчета.ИспользуетсяУправлениеВНА_2_4);
	СтруктураПараметров.Вставить("ИспользоватьУчетПрочихДоходовРасходовРегл", ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ, СтруктураПараметров);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	// Кор движения
	СформироватьДвиженияПрочиеРасходыКорЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ,
			ТекстСумма, ТекстСуммаБезНДС, ТекстСуммаУпр);
	
КонецПроцедуры

Процедура СформироватьДвиженияПрочиеРасходыЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ,
			СтруктураТекстовСуммовыхПоказателей)
			
	ТекстПред = "ВЫБОР КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад) ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * ";
	ТекстСумма = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстСумма;
	ТекстСуммаБезНДС = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстСуммаБезНДС;
	ТекстСуммаРегл = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстСуммаРегл;
	ТекстСуммаУпр = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстСуммаУпр;
	ТекстПостояннаяРазница = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстПостояннаяРазница;
	ТекстВременнаяРазница = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстВременнаяРазница;
	ТекстСуммаНДД = ТекстПред + СтруктураТекстовСуммовыхПоказателей.ТекстСуммаНДД;

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, АналитикаРасходов, ХозяйственнаяОперация,
	|АналитикаУчетаНоменклатуры, ГруппаПродукции, ДокументДвижения, Сторно,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи, ДокументРасчета";

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СтруктураПараметров = Новый Структура();
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "Знак * (" + ТекстСумма + ")");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходов", "СтатьяРасходовСписания");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельности", "КорНаправлениеДеятельности");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", "
	|ВЫБОР
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию) ТОГДА
	|		КорОрганизация
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "Организация") + " 
	|КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаНоменклатуры", "
	|ВЫБОР
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад) ТОГДА
	|		КорАналитикаУчетаНоменклатуры
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаНоменклатуры") + " 
	|КОНЕЦ");

	// Условия по сумме без НДС должны совпадать с условиями в:
	// - см. СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом в приходном движении.
	// - см. СкорректироватьСтоимостьВозвратовПрошлыхПериодов.
	// - см. РегистрыНакопления.ПрочиеРасходы.ТекстЗапросаТаблицаВтПрочиеРасходы
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС", "
	|ВЫБОР
	|	КОГДА НЕ ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы))
	|		ТОГДА Знак * (" + ТекстСуммаБезНДС + ")
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС") + " 
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "
	|ВЫБОР
	|	КОГДА НЕ ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы) ТОГДА
	|		ВЫБОР
	|			КОГДА НЕ &УправленческийУчетОрганизаций ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию) ТОГДА
	|				0
	|			КОГДА ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы) И НЕ &ИспользуетсяУправлениеВНА_2_4 ТОГДА
	|				0
	|			ИНАЧЕ
	|				Знак * (" + ТекстСуммаУпр + ")
	|		КОНЕЦ
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "СуммаУпр") + " 
	|КОНЕЦ");
	
	СтруктураПараметров.Вставить("УправленческийУчетОрганизаций", ПараметрыРасчета.УправленческийУчетОрганизаций);
	СтруктураПараметров.Вставить("ИспользуетсяУправлениеВНА_2_4", ПараметрыРасчета.ИспользуетсяУправлениеВНА_2_4);
	СтруктураПараметров.Вставить("ИспользоватьУчетПрочихДоходовРасходовРегл", ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл);
	
	// СуммаРегл
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", "
	|ВЫБОР
	|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл
	| 		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	| 		ИЛИ ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы)
	| 		ИЛИ (ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы) И НЕ &ИспользуетсяУправлениеВНА_2_4) ТОГДА
	|		0
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию) ТОГДА
	|		0
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ) ТОГДА
	|		0
	|	ИНАЧЕ
	|		Знак * (" + ТекстСуммаРегл + ")
	|КОНЕЦ");
	
	// ПостояннаяРазница
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "
	|ВЫБОР
	|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл
	| 		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	| 		ИЛИ ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы)
	| 		ИЛИ (ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы) И НЕ &ИспользуетсяУправлениеВНА_2_4) ТОГДА
	|		0
	//++ НЕ УТ
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию) ТОГДА
	|		ВЫБОР 
	|			КОГДА ЛОЖЬ ТОГДА 0 // для удобства расстановки тегов
	//++ Локализация
	|			КОГДА СписаниеПриПередачеНУ И НЕ ПринятиеКНалоговомуУчету ТОГДА
	|				(" + ТекстСуммаРегл + ") - (" + ТекстВременнаяРазница + ") - (" + ТекстПостояннаяРазница + ")
	//-- Локализация
	|			ИНАЧЕ
	|				0
	|			КОНЕЦ
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ) ТОГДА
	|		0
	|	КОГДА НЕ ПринятиеКНалоговомуУчету ТОГДА
	|		Знак * (" + ТекстСуммаРегл + ") - Знак * (" + ТекстВременнаяРазница + ")
	//-- НЕ УТ
	|	ИНАЧЕ
	|		Знак * " + ТекстПостояннаяРазница + "
	|КОНЕЦ");
	
	// ВременнаяРазница
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", "
	|ВЫБОР
	|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл
	| 		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	| 		ИЛИ ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы)
	| 		ИЛИ (ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы) И НЕ &ИспользуетсяУправлениеВНА_2_4) ТОГДА
	|		0
	//++ НЕ УТ
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию) ТОГДА
	|		ВЫБОР
	|			КОГДА ЛОЖЬ ТОГДА 0 // для удобства расстановки тегов
	//++ Локализация
	|			КОГДА СписаниеПриПередачеНУ И НЕ ПринятиеКНалоговомуУчету ТОГДА
	|				-((" + ТекстСуммаРегл + ") - (" + ТекстВременнаяРазница + ") - (" + ТекстПостояннаяРазница + "))
	|			КОГДА СписаниеПриПередачеНУ И ПринятиеКНалоговомуУчету ТОГДА
	|				-((" + ТекстСуммаРегл + ") - (" + ТекстВременнаяРазница + ") - (" + ТекстПостояннаяРазница + "))
	//-- Локализация
	|			ИНАЧЕ
	|				0
	|		КОНЕЦ
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ) ТОГДА
	|		0
	//-- НЕ УТ
	|	ИНАЧЕ
	|		Знак * (" + ТекстВременнаяРазница + ")
	|КОНЕЦ");
	
	// СуммаНДД
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаНДД", "
	|ВЫБОР
	|	КОГДА НЕ ЕСТЬNULL(СтатьяРасходовСписания.ПризнаютсяВРасходахНДД, ИСТИНА)
	|		ТОГДА 0
	|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл
	| 		ИЛИ ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	| 		ИЛИ ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы)
	| 		ИЛИ (ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы) И НЕ &ИспользуетсяУправлениеВНА_2_4) ТОГДА
	|		0
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию) ТОГДА
	|		0
	|	КОГДА ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ) ТОГДА
	|		0
	|	ИНАЧЕ
	|		Знак * (" + ТекстСуммаНДД + ")
	|КОНЕЦ");
	
	УсловиеГДЕ = УсловиеГДЕ + "
		|	И ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)";
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ, СтруктураПараметров);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	// Отражение списания резервов под обесценение запасов.
	ИмяВременнойТаблицыРезервы = ИмяВременнойТаблицы + "Резервы";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", 
		"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРезервовПодОбесценениеЗапасов)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации", 
		"ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеРезервовПодОбесценениеЗапасов)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "РезервПодОбесценениеУпр");
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", "РезервПодОбесценениеРегл");
	КонецЕсли;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", "РезервПодОбесценениеРегл");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаНДД", "0");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", 
		ИмяВременнойТаблицыРезервы, 
		УсловиеГДЕ + "
			|	И НЕ ВосстанавливатьРезервы
			|	И ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)
			|"
		, 
		СтруктураПараметров);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицыРезервы, ИмяРегистра);
	
	// Кор движения
	СформироватьДвиженияПрочиеРасходыКорЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ,
			ТекстСумма, ТекстСуммаБезНДС, ТекстСуммаУпр);
	
КонецПроцедуры

Процедура СформироватьДвиженияПрочиеРасходыКорЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ,
			ТекстСумма, ТекстСуммаБезНДС, ТекстСуммаУпр)

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, АналитикаРасходов, ХозяйственнаяОперация,
	|АналитикаУчетаНоменклатуры, ГруппаПродукции, ДокументДвижения, Сторно, ДокументРасчета";
	
	УсловиеГДЕКор = УсловиеГДЕ + "
	|	И (НЕ КорОрганизация ЕСТЬ NULL И КорОрганизация <> Неопределено И КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|	И КорОрганизация <> Организация
	|	И ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|";
	 
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	// СторнированиеРасходовУУ
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "Истина");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходов", "СтатьяРасходовСписания");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "-(" + ТекстСумма + ")");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаНДД", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация",
		"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторнированиеРасходовУУ)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	// Условия по сумме без НДС должны совпадать с условиями в:
	// - см. СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом в приходном движении.
	// - см. СкорректироватьСтоимостьВозвратовПрошлыхПериодов.
	// - см. РегистрыНакопления.ПрочиеРасходы.ТекстЗапросаТаблицаВтПрочиеРасходы.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС", "
	|ВЫБОР
	|	КОГДА НЕ ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы))
	|		ТОГДА -Знак * (" + ТекстСуммаБезНДС + ")
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС") + " 
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы + "КорСторнированиеРасходовУУ", УсловиеГДЕКор);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы + "КорСторнированиеРасходовУУ", ИмяРегистра);
	
	// РегистрацияРасходовУУ
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "Истина");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", "КорОрганизация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходов", "СтатьяРасходовСписания");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", ТекстСумма);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаНДД", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	// Условия по сумме без НДС должны совпадать с условиями в:
	// - см. СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом в приходном движении.
	// - см. РегистрыНакопления.ПрочиеРасходы.ТекстЗапросаТаблицаВтПрочиеРасходы.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС", "
	|ВЫБОР
	|	КОГДА НЕ ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы))
	|		ТОГДА Знак * (" + ТекстСуммаБезНДС + ")
	|	ИНАЧЕ
	|		" + РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьЗначениеПоляЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС") + " 
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация",
		"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РегистрацияРасходовУУ)");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы + "КорРегистрацияРасходовУУ", УсловиеГДЕКор);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы + "КорРегистрацияРасходовУУ", ИмяРегистра);
	
	
	// Добавим движения по регистру "Активы и пассивы".
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, НаправлениеДеятельности";
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Статья", "ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПрибылиИУбытки)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Аналитика", "Организация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "Знак * (" + ТекстСумма + ")");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы + "ПрочиеАктивыПассивы_Приход", УсловиеГДЕКор);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы + "ПрочиеАктивыПассивы_Приход", ИмяРегистра);
	
	// Добавим движение и заполним его основные свойства
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ЛОЖЬ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", "КорОрганизация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Статья", "ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПрибылиИУбытки)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Аналитика", "КорОрганизация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "Знак * (" + ТекстСумма + ")");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы + "ПрочиеАктивыПассивы_Расход", УсловиеГДЕКор);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы + "ПрочиеАктивыПассивы_Расход", ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияПрочиеДоходыВУпрУчетеЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ,
			ТекстСумма, ТекстСуммаУпр)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеДоходы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, СтатьяДоходов, АналитикаДоходов, ХозяйственнаяОперация, Сторно,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи, ДокументРасчета";
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СтруктураПараметров = Новый Структура();
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяДоходов", "СтатьяДоходовУпр");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаДоходов", "АналитикаДоходовУпр");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельности", "КорНаправлениеДеятельности");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", ТекстСумма);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", ТекстСуммаУпр);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ, СтруктураПараметров);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияПрочиеДоходыЗапросом(ПараметрыРасчета, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений, УсловиеГДЕ,
			ТекстСумма, ТекстСуммаРегл, ТекстСуммаУпр)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеДоходы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, СтатьяДоходов, АналитикаДоходов, ХозяйственнаяОперация, Сторно,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи, ДокументРасчета";
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СтруктураПараметров = Новый Структура();
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельности", "КорНаправлениеДеятельности");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", ТекстСумма);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", ТекстСуммаУпр);
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", ТекстСуммаРегл);
	КонецЕсли;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ, СтруктураПараметров);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
		
	// Отражение списания резервов под обесценение запасов.
	ИмяВременнойТаблицыРезервы = ИмяВременнойТаблицы + "Резервы";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", 
		"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРезервовПодОбесценениеЗапасов)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации", 
		"ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеРезервовПодОбесценениеЗапасов)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "-РезервПодОбесценениеУпр");
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", "-РезервПодОбесценениеРегл");
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицыРезервы, УсловиеГДЕ, СтруктураПараметров);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицыРезервы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияВыручкаИСебестоимостьПродажЗапросом(ПараметрыРасчета, Запрос, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений)
	
	СоздатьКлючиАналитикиПоПартнерам(ПараметрыРасчета, Запрос);
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	// Измерения
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ЗаказКлиента,
	|	АналитикаПартнера.КлючАналитики КАК АналитикаУчетаПоПартнерам,
	|	Т.Подразделение,
	|	(ВЫБОР
	|		КОГДА Т.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|		 И НЕ Т.АналитикаУчетаНоменклатуры.Номенклатура.ПрослеживаемыйТовар
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
	|		ИНАЧЕ Т.ТипЗапасов КОНЕЦ) КАК ТипЗапасов,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка) КАК Менеджер,
	|	Т.Склад,
	|	ЗНАЧЕНИЕ(Справочник.СоглашенияСКлиентами.ПустаяСсылка) КАК Соглашение,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВосстановлениеРезервовПодОбесценениеЗапасов) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНаборов.ПустаяСсылка) КАК АналитикаУчетаНаборов,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельностиКонтрагента,
	|	Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельностиНоменклатуры,
	// Ресурсы
	|	0 КАК Количество,
	|	0 КАК СуммаВыручки,
	|	0 КАК СуммаВыручкиБезНДС,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьУпр,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СуммаВыручкиРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК Трудозатраты,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК ПостатейныеПеременныеУпр,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СуммаВыручкиСНДСРегл,
	|	0 КАК СуммаРучнойСкидки,
	|	0 КАК СуммаАвтоматическойСкидки,
	|	0 КАК РасходыНаПродажуСНДС,
	|	0 КАК РасходыНаПродажуБезНДС,
	|	0 КАК РасходыНаПродажуУпр,
	|	0 КАК РасходыНаПродажуРегл,
	|	Т.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	|	Т.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	// Реквизиты
	|	Т.ДокументДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,  //НалогообложениеНДС,
	|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) КАК ВалютаВзаиморасчетов,
	|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) КАК ВалютаДокумента,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка) КАК ИсточникГФУРасчетов,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВосстановлениеРезервовПодОбесценениеЗапасов) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.Сторно
	|
	|ПОМЕСТИТЬ ВтТаблицаДвиженияВыручкаИСебестоимостьРезервыИОтклонения
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПартнера
	|	ПО (АналитикаПартнера.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|		И (АналитикаПартнера.Организация = Т.Организация)
	|		И (АналитикаПартнера.Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|		И (АналитикаПартнера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка))
	|		И (АналитикаПартнера.НаправлениеДеятельности = Т.НаправлениеДеятельности)
	|ГДЕ
	|	Т.ВосстанавливатьРезервы
	|	И (Т.РезервПодОбесценениеУпр <> 0 ИЛИ Т.РезервПодОбесценениеРегл <> 0)
	|	И ТИПЗНАЧЕНИЯ(Т.ДокументДвижения) В (&ТипыРегистраторовВыручки)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	// Измерения
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ЗаказКлиента,
	|	АналитикаПартнера.КлючАналитики КАК АналитикаУчетаПоПартнерам,
	|	Т.Подразделение,
	|	(ВЫБОР
	|		КОГДА Т.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|		 И НЕ Т.АналитикаУчетаНоменклатуры.Номенклатура.ПрослеживаемыйТовар
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
	|		ИНАЧЕ Т.ТипЗапасов КОНЕЦ) КАК ТипЗапасов,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка) КАК Менеджер,
	|	Т.Склад,
	|	ЗНАЧЕНИЕ(Справочник.СоглашенияСКлиентами.ПустаяСсылка) КАК Соглашение,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНаборов.ПустаяСсылка) КАК АналитикаУчетаНаборов,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК НаправлениеДеятельностиКонтрагента,
	|	Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельностиНоменклатуры,
	// Ресурсы
	|	0 КАК Количество,
	|	0 КАК СуммаВыручки,
	|	0 КАК СуммаВыручкиБезНДС,
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК СтоимостьУпр,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК СуммаВыручкиРегл,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.СуммаУпр КАК ДопРасходыУпр,
	|	Т.СуммаРегл КАК ДопРасходыРегл,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК Трудозатраты,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК ПостатейныеПеременныеУпр,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	Т.СуммаРегл - Т.ПостояннаяРазница КАК ВременнаяРазница,
	|	0 КАК СуммаВыручкиСНДСРегл,
	|	0 КАК СуммаРучнойСкидки,
	|	0 КАК СуммаАвтоматическойСкидки,
	|	0 КАК РасходыНаПродажуСНДС,
	|	0 КАК РасходыНаПродажуБезНДС,
	|	0 КАК РасходыНаПродажуУпр,
	|	0 КАК РасходыНаПродажуРегл,
	|	0 КАК РезервПодОбесценениеУпр,
	|	0 КАК РезервПодОбесценениеРегл,
	// Реквизиты
	|	Т.ДокументДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,  //НалогообложениеНДС,
	|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) КАК ВалютаВзаиморасчетов,
	|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка) КАК ВалютаДокумента,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка) КАК ИсточникГФУРасчетов,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.Сторно
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПартнера
	|	ПО (АналитикаПартнера.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|		И (АналитикаПартнера.Организация = Т.Организация)
	|		И (АналитикаПартнера.Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|		И (АналитикаПартнера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка))
	|		И (АналитикаПартнера.НаправлениеДеятельности = Т.НаправлениеДеятельности)
	// Условия выборки данных должны соответствовать процедуре СоздатьКлючиАналитикиПоПартнерам().
	|ГДЕ
	|	Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)
	|	И (Т.СуммаРегл<> 0 ИЛИ Т.РезервПодОбесценениеРегл <> 0 ИЛИ Т.СуммаУпр <> 0 ИЛИ Т.РезервПодОбесценениеУпр <> 0)
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВтТаблицаДвиженияВыручкаИСебестоимостьРезервыИОтклонения");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВтТаблицаДвиженияВыручкаИСебестоимостьРезервыИОтклонения", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СоздатьКлючиАналитикиПоПартнерам(ПараметрыРасчета, Запрос)
	
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности
	|
	|ПОМЕСТИТЬ ВтАналитики
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	// Условия выборки данных должны соответствовать процедуре СформироватьДвиженияВыручкаИСебестоимостьПродажЗапросом().
	|ГДЕ
	|	Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)
	|	И (Т.СуммаРегл<> 0 ИЛИ Т.РезервПодОбесценениеРегл <> 0 ИЛИ Т.СуммаУпр <> 0 ИЛИ Т.РезервПодОбесценениеУпр <> 0)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	НаправлениеДеятельности
	|;
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка) КАК Партнер,
	|	ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка) КАК Контрагент,
	|	ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка) КАК Договор,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности
	|ИЗ
	|	ВтАналитики КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПартнера
	|		ПО (АналитикаПартнера.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|		И (АналитикаПартнера.Организация = Т.Организация)
	|		И (АналитикаПартнера.Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|		И (АналитикаПартнера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка))
	|		И (АналитикаПартнера.НаправлениеДеятельности = Т.НаправлениеДеятельности)
	|ГДЕ
	|	АналитикаПартнера.КлючАналитики ЕСТЬ NULL
	|";
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	Пока Выборка.Следующий() Цикл
		РегистрыСведений.АналитикаУчетаПоПартнерам.СоздатьКлючАналитики(Выборка);
	КонецЦикла;
	
КонецПроцедуры

//++ НЕ УТ

Процедура СформироватьДвиженияСтоимостьТМЦВЭксплуатацииЗапросом(ПараметрыРасчета, Запрос, ИмяВременнойТаблицы, СоответствиеВременныхТаблицДвижений)
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ДокументДвижения КАК Регистратор,
	// Измерения
	|	Т.Организация,
	|	ПередачиВЭксплуатацию.Номенклатура КАК Номенклатура,
	|	ПередачиВЭксплуатацию.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ПередачиВЭксплуатацию.СтатусУказанияСерийПолучатель = 20
	|			ТОГДА ПередачиВЭксплуатацию.Серия
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка)
	|	КОНЕЦ КАК Серия,
	|	ПередачиВЭксплуатацию.ИнвентарныйНомер,
	|	ПередачиВЭксплуатацию.Партия,
	|	Т.ИдентификаторСтроки,
	// Ресурсы
	|	Т.Количество КАК Количество,
	|	Т.СуммаУпр КАК СтоимостьУпр,
	|	Т.СуммаРегл КАК СтоимостьРегл
	// Реквизиты
	|	
	|ПОМЕСТИТЬ ВтТаблицаСтоимостьТМЦВЭксплуатации
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ВнутреннееПотребление.Товары КАК ПередачиВЭксплуатацию
	|		ПО Т.ДокументДвижения = ПередачиВЭксплуатацию.Ссылка
	|		И Т.ИдентификаторСтроки = ПередачиВЭксплуатацию.ИдентификаторСтроки
	|ГДЕ
	|	ВЫРАЗИТЬ(Т.ДокументДвижения КАК Документ.ВнутреннееПотребление).ХозяйственнаяОперация В(
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатацию),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ))
	|";
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыСведений.СтоимостьТМЦВЭксплуатации.Имя);
	ОписаниеВТ.ИмяВТРезультата = ИмяВременнойТаблицы;
	ОписаниеВТ.ИмяВТИсточника = "ВтТаблицаСтоимостьТМЦВЭксплуатации";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
КонецПроцедуры

// Этап 3.15
Процедура СкорректироватьСтоимостьСписанияНезавершенногоПроизводства22(ПараметрыРасчета)
	
	Если ПараметрыРасчета.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьСписанияНезавершенногоПроизводства");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	#Область Выпуски
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов, 
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС,
	|	МАКСИМУМ(ДД.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ Выпуски
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И ДД.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами))
	|
	|	И ДД.СлужебноеВидДвиженияПриход
	|	И ДД.Количество > 0
	|	И НЕ ДД.Сторно
	|
	|СГРУППИРОВАТЬ ПО
	|	ДД.Регистратор,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.РазделУчета,
	|	ДД.ВидЗапасов, 
	|	ДД.Партия,
	|	ДД.АналитикаУчетаПартий,
	|	ДД.АналитикаФинансовогоУчета,
	|	ДД.ВидДеятельностиНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|";
	#КонецОбласти
	
	#Область ВтТаблицаКорректировки
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	//++ Устарело_Производство21
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Движения.Регистратор) = ТИП(Документ.ВыпускПродукции)
	|			ТОГДА ВЫРАЗИТЬ(Движения.Регистратор КАК Документ.ВыпускПродукции).Дата
	|		ИНАЧЕ
	//-- Устарело_Производство21 
	|			Движения.Период
	//++ Устарело_Производство21
	|	КОНЕЦ
	//-- Устарело_Производство21
	|	КАК Период,
	|	Движения.ВидДвижения КАК ВидДвижения,
	|	Движения.Регистратор КАК ДокументДвижения,
	|	Движения.Организация КАК Организация,
	|	Движения.ПартияПроизводства КАК ПартияПроизводства,
	// для приходов стоимость формируется без учета партий, аналитик учета партий, групп продукции, статьи калькуляции, правила отнесения,
	// а для расходов - в разрезе этих полей
	|	ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|		ИНАЧЕ 
	|			Движения.ДокументВыпуска
	|	КОНЕЦ КАК Партия,
	|	ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ 
	|			Движения.АналитикаПартииВыпуска
	|	КОНЕЦ КАК АналитикаУчетаПартий,
	|	ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|		ИНАЧЕ 
	|			Движения.СтатьяКалькуляции
	|	КОНЕЦ КАК СтатьяКалькуляцииСтоимости,
	|	ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		ИНАЧЕ 
	|			Движения.ГруппаПродукции
	|	КОНЕЦ КАК ГруппаПродукцииСтоимости,
	|	ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка)
	|		ИНАЧЕ 
	|			Движения.ПравилоОтнесенияНаВыпуск
	|	КОНЕЦ КАК ПравилоОтнесенияНаВыпускСтоимости,
	|	Движения.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Движения.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА 0
	|		ИНАЧЕ
	|			Движения.КодСтрокиПродукция
	|	КОНЕЦ КАК КодСтрокиПродукцияДляСтоимости,
	|	Движения.Этап КАК Этап,
	|	Движения.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	(ВЫБОР
	|		КОГДА &УчитыватьСебестоимостьТоваровПоНазначениям ТОГДА Движения.АналитикаУчетаПродукции
	|		ИНАЧЕ АналитикаПродукцииБезНазначения.КлючАналитики КОНЕЦ) КАК АналитикаУчетаПродукции,
	|	Движения.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
	|	Движения.РазделУчета КАК РазделУчета,
	|	Движения.ВидЗапасов КАК ВидЗапасов,
	|	Движения.АналитикаУчетаПродукции.Назначение КАК Назначение,
	|	Движения.Подразделение КАК Подразделение,
	// для приходов выбирается исходное подразделение расхода, а для расходов - подразделение, на которое расход отнесен
	|	ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА Распределение.Подразделение
	|		ИНАЧЕ Движения.Подразделение
	|	КОНЕЦ КАК ПодразделениеСтоимости,
	|	Движения.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Движения.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Движения.АналитикаРасходов КАК АналитикаРасходов,
	|	Движения.СтатьяРасходов КАК СтатьяРасходов,
	|	ВЫБОР 
	|		КОГДА Распределение.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА ВтОВЗ.ВариантРаспределенияРасходовРегл
	|		ИНАЧЕ Движения.СтатьяРасходов.ВариантРаспределенияРасходовРегл
	|	КОНЕЦ В (
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|	) КАК ПрямыеЗатратыРегл,
	|	ВЫБОР 
	|		КОГДА Распределение.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|			ТОГДА ВтОВЗ.ВариантРаспределенияРасходовНУ
	|		ИНАЧЕ Движения.СтатьяРасходов.ВариантРаспределенияРасходовНУ
	|	КОНЕЦ В (
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства)
	|	) КАК ПрямыеЗатратыНУ,
	|	Движения.СтатьяРасходов.ПринятиеКНалоговомуУчету КАК ПринимаемыеВНУ,
	|	Движения.Продукция КАК Продукция,
	|	Движения.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|	Движения.ГруппаПродукции КАК ГруппаПродукции,
	|	Движения.ВидДеятельностиНДС,
	|	ВЫБОР 
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|	КОНЕЦ КАК РазделУчетаСтоимости,
	|	Движения.ДокументВыпуска КАК ДокументВыпуска,
	|	Движения.АналитикаПартииВыпуска КАК АналитикаПартииВыпуска,
	|	Движения.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	// для приходов количество это ПоказательОтнесенияНаПартию, а для расходов - ПоказательОтнесенияНаВыпуск
	|	Движения.ДоляСтоимости КАК ДоляСтоимости,
	|	ВЫРАЗИТЬ(ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА Движения.ПоказательОтнесенияНаПартию
	|		ИНАЧЕ Движения.ПоказательОтнесенияНаВыпуск
	|	КОНЕЦ КАК ЧИСЛО(28,10)) КАК Количество,
	|	ВЫРАЗИТЬ(ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА Движения.ПоказательОтнесенияНаПартиюБезНДС
	|		ИНАЧЕ Движения.ПоказательОтнесенияНаВыпускБезНДС
	|	КОНЕЦ КАК ЧИСЛО(28,10)) КАК КоличествоБезНДС,
	|	ВЫРАЗИТЬ(ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА Движения.ПоказательОтнесенияНаПартиюРегл
	|		ИНАЧЕ Движения.ПоказательОтнесенияНаВыпускРегл
	|	КОНЕЦ КАК ЧИСЛО(28,10)) КАК КоличествоРегл,
	|	ВЫРАЗИТЬ(ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА Движения.ПоказательОтнесенияНаПартиюНУ
	|		ИНАЧЕ Движения.ПоказательОтнесенияНаВыпускНУ
	|	КОНЕЦ КАК ЧИСЛО(28,10)) КАК КоличествоНУ,
	|	ВЫРАЗИТЬ(ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА Движения.ПоказательОтнесенияНаПартиюУпр
	|		ИНАЧЕ Движения.ПоказательОтнесенияНаВыпускУпр
	|	КОНЕЦ КАК ЧИСЛО(28,10)) КАК КоличествоУпр,
	|	ВЫРАЗИТЬ(ВЫБОР
	|		КОГДА Движения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА Движения.ПоказательОтнесенияНаПартиюНДД
	|		ИНАЧЕ Движения.ПоказательОтнесенияНаВыпускНДД
	|	КОНЕЦ КАК ЧИСЛО(28,10)) КАК КоличествоНДД
	|ПОМЕСТИТЬ ВтТаблицаКорректировкиБезИдентификаторов_Предварительная
	|ИЗ
	|	втПрочиеРасходыНезавершенногоПроизводства КАК Движения
	|	ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Распределение
	|		ПО Движения.Регистратор = Распределение.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО Аналитика.Ссылка = Движения.АналитикаУчетаПродукции
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаПродукцииБезНазначения
	|		ПО НЕ &УчитыватьСебестоимостьТоваровПоНазначениям
	|		И АналитикаПродукцииБезНазначения.Номенклатура = Аналитика.Номенклатура
	|		И АналитикаПродукцииБезНазначения.Характеристика = Аналитика.Характеристика
	|		И АналитикаПродукцииБезНазначения.Серия = Аналитика.Серия
	|		И АналитикаПродукцииБезНазначения.МестоХранения = Аналитика.МестоХранения
	|		И АналитикаПродукцииБезНазначения.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|		И АналитикаПродукцииБезНазначения.СтатьяКалькуляции = ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтОВЗ КАК ВтОВЗ
	|		ПО Движения.АналитикаРасходов = ВтОВЗ.ОВЗ
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = Движения.Период
	|		И РассчитанныеДокументы.Регистратор = Движения.Регистратор
	|		И &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|ГДЕ
	|	Движения.Организация В (&МассивОрганизаций)
	// При предварительном расчете исключаем документы, для которых сохранены ранее рассчитанные движения
	|	И РассчитанныеДокументы.Регистратор ЕСТЬ NULL
	|;
	|
	|ВЫБРАТЬ
	|	Предварительная.Период КАК Период,
	|	Предварительная.ВидДвижения КАК ВидДвижения,
	|	Предварительная.ДокументДвижения КАК ДокументДвижения,
	|	Предварительная.Организация КАК Организация,
	|	Предварительная.ПартияПроизводства КАК ПартияПроизводства,
	|	Предварительная.Партия КАК Партия,
	|	Предварительная.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Предварительная.СтатьяКалькуляцииСтоимости КАК СтатьяКалькуляцииСтоимости,
	|	Предварительная.ГруппаПродукцииСтоимости КАК ГруппаПродукцииСтоимости,
	|	Предварительная.ПравилоОтнесенияНаВыпускСтоимости КАК ПравилоОтнесенияНаВыпускСтоимости,
	|	Предварительная.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Предварительная.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	Предварительная.КодСтрокиПродукцияДляСтоимости КАК КодСтрокиПродукцияДляСтоимости,
	|	Предварительная.Этап КАК Этап,
	|	Предварительная.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	Предварительная.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
	|	Предварительная.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
	|	Предварительная.РазделУчета КАК РазделУчета,
	|	Предварительная.ВидЗапасов КАК ВидЗапасов,
	|	Предварительная.Назначение КАК Назначение,
	|	Предварительная.Подразделение КАК Подразделение,
	|	Предварительная.ПодразделениеСтоимости КАК ПодразделениеСтоимости,
	|	Предварительная.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Предварительная.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Предварительная.АналитикаРасходов КАК АналитикаРасходов,
	|	Предварительная.СтатьяРасходов КАК СтатьяРасходов,
	|	Предварительная.ПрямыеЗатратыРегл КАК ПрямыеЗатратыРегл,
	|	Предварительная.ПрямыеЗатратыНУ КАК ПрямыеЗатратыНУ,
	|	Предварительная.ПринимаемыеВНУ КАК ПринимаемыеВНУ,
	|	Предварительная.Продукция КАК Продукция,
	|	Предварительная.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|	Предварительная.ГруппаПродукции КАК ГруппаПродукции,
	|	Предварительная.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Предварительная.РазделУчетаСтоимости КАК РазделУчетаСтоимости,
	|	Предварительная.ДокументВыпуска КАК ДокументВыпуска,
	|	Предварительная.АналитикаПартииВыпуска КАК АналитикаПартииВыпуска,
	|	Предварительная.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|	СУММА(Предварительная.ДоляСтоимости) КАК ДоляСтоимости,
	|	СУММА(Предварительная.Количество) КАК Количество,
	|	СУММА(Предварительная.КоличествоБезНДС) КАК КоличествоБезНДС,
	|	СУММА(Предварительная.КоличествоРегл) КАК КоличествоРегл,
	|	СУММА(Предварительная.КоличествоНУ) КАК КоличествоНУ,
	|	СУММА(Предварительная.КоличествоУпр) КАК КоличествоУпр,
	|	СУММА(Предварительная.КоличествоНДД) КАК КоличествоНДД
	|ПОМЕСТИТЬ ВтТаблицаКорректировкиБезИдентификаторов
	|ИЗ
	|	ВтТаблицаКорректировкиБезИдентификаторов_Предварительная КАК Предварительная
	|
	|СГРУППИРОВАТЬ ПО
	|	Предварительная.Период,
	|	Предварительная.ВидДвижения,
	|	Предварительная.ДокументДвижения,
	|	Предварительная.Организация,
	|	Предварительная.ПартияПроизводства,
	|	Предварительная.Партия,
	|	Предварительная.АналитикаУчетаПартий,
	|	Предварительная.СтатьяКалькуляцииСтоимости,
	|	Предварительная.ГруппаПродукцииСтоимости,
	|	Предварительная.ПравилоОтнесенияНаВыпускСтоимости,
	|	Предварительная.ЗаказНаПроизводство,
	|	Предварительная.КодСтрокиПродукция,
	|	Предварительная.КодСтрокиПродукцияДляСтоимости,
	|	Предварительная.Этап,
	|	Предварительная.СтатьяКалькуляции,
	|	Предварительная.АналитикаУчетаПродукции,
	|	Предварительная.КорАналитикаУчетаПартий,
	|	Предварительная.РазделУчета,
	|	Предварительная.ВидЗапасов,
	|	Предварительная.Назначение,
	|	Предварительная.Подразделение,
	|	Предварительная.ПодразделениеСтоимости,
	|	Предварительная.НаправлениеДеятельности,
	|	Предварительная.КорНаправлениеДеятельности,
	|	Предварительная.АналитикаРасходов,
	|	Предварительная.СтатьяРасходов,
	|	Предварительная.ПрямыеЗатратыРегл,
	|	Предварительная.ПрямыеЗатратыНУ,
	|	Предварительная.ПринимаемыеВНУ,
	|	Предварительная.Продукция,
	|	Предварительная.ХарактеристикаПродукции,
	|	Предварительная.ГруппаПродукции,
	|	Предварительная.ВидДеятельностиНДС,
	|	Предварительная.РазделУчетаСтоимости,
	|	Предварительная.ДокументВыпуска,
	|	Предварительная.АналитикаПартииВыпуска,
	|	Предварительная.ПравилоОтнесенияНаВыпуск
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументДвижения,
	|	ПартияПроизводства,
	|	СтатьяРасходов,
	|	Подразделение
	|;
	|	
	|УНИЧТОЖИТЬ ВтТаблицаКорректировкиБезИдентификаторов_Предварительная;
	|
	|ВЫБРАТЬ
	|	Т.Период КАК Период,
	|	Т.ВидДвижения КАК ВидДвижения,
	|	Т.ДокументДвижения КАК ДокументДвижения,
	|	Т.Организация КАК Организация,
	|	Т.ПартияПроизводства КАК ПартияПроизводства,
	|	Т.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Т.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	Т.Этап КАК Этап,
	|	Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	Т.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
	|	Т.Продукция КАК Продукция,
	|	Т.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.ГруппаПродукции КАК ГруппаПродукции,
	|	Т.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|	МАКСИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ИдентификаторыПоПолямТаблицыКорректировки
	|ИЗ
	|	(ВЫБРАТЬ
	|		ИСТИНА КАК НовоеДвижение,
	|		Т.Период КАК Период,
	|		Т.ВидДвижения КАК ВидДвижения,
	|		Т.ДокументДвижения КАК ДокументДвижения,
	|		Т.Организация КАК Организация,
	|		Т.ПартияПроизводства КАК ПартияПроизводства,
	|		Т.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|		Т.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.Этап) = ТИП(Справочник.ЭтапыПроизводства)
	|			ТОГДА Т.Этап
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка)
	|		КОНЕЦ КАК Этап,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.СтатьяКалькуляции) = ТИП(Справочник.СтатьиКалькуляции)
	|			ТОГДА Т.СтатьяКалькуляции
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|		КОНЕЦ КАК СтатьяКалькуляции,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.АналитикаУчетаПродукции) = ТИП(Справочник.КлючиАналитикиУчетаНоменклатуры)
	|			ТОГДА Т.АналитикаУчетаПродукции
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		КОНЕЦ КАК АналитикаУчетаПродукции,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.Продукция) = ТИП(Справочник.Номенклатура)
	|			ТОГДА Т.Продукция
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|		КОНЕЦ КАК Продукция,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.ХарактеристикаПродукции) = ТИП(Справочник.ХарактеристикиНоменклатуры)
	|			ТОГДА Т.ХарактеристикаПродукции
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|		КОНЕЦ КАК ХарактеристикаПродукции,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.РазделУчета) = ТИП(Перечисление.РазделыУчетаСебестоимостиТоваров)
	|			ТОГДА Т.РазделУчета
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		КОНЕЦ КАК РазделУчета,
	|		Т.Подразделение КАК Подразделение,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.НаправлениеДеятельности) = ТИП(Справочник.НаправленияДеятельности)
	|			ТОГДА Т.НаправлениеДеятельности
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|		КОНЕЦ КАК НаправлениеДеятельности,
	|		Т.АналитикаРасходов КАК АналитикаРасходов,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.СтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|			ТОГДА Т.СтатьяРасходов
	|			ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		КОНЕЦ КАК СтатьяРасходов,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.ГруппаПродукции) = ТИП(Справочник.ГруппыАналитическогоУчетаНоменклатуры)
	|			ТОГДА Т.ГруппаПродукции
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		КОНЕЦ КАК ГруппаПродукции,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.ПравилоОтнесенияНаВыпуск) = ТИП(Перечисление.ПравилаОтнесенияНаВыпуск)
	|			ТОГДА Т.ПравилоОтнесенияНаВыпуск
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка)
	|		КОНЕЦ КАК ПравилоОтнесенияНаВыпуск,
	|		"""" КАК ИдентификаторФинЗаписи
	|	ИЗ
	|		ВтТаблицаКорректировкиБезИдентификаторов КАК Т
	|	ГДЕ
	|		Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ЛОЖЬ КАК НовоеДвижение,
	|		Т.Период КАК Период,
	|		Т.ВидДвижения КАК ВидДвижения,
	|		Т.Регистратор КАК ДокументДвижения,
	|		Т.Организация КАК Организация,
	|		Т.ПартияПроизводства КАК ПартияПроизводства,
	|		Т.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|		Т.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|		Т.Этап КАК Этап,
	|		Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		Т.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
	|		Т.Продукция КАК Продукция,
	|		Т.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Подразделение КАК Подразделение,
	|		ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.Регистратор) <> ТИП(Документ.РаспределениеПрочихЗатрат)
	|			ТОГДА Т.НаправлениеДеятельности
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|		КОНЕЦ КАК НаправлениеДеятельности,
	|		Т.АналитикаРасходов КАК АналитикаРасходов,
	|		Т.СтатьяРасходов КАК СтатьяРасходов,
	|		Т.ГруппаПродукции КАК ГруппаПродукции,
	|		Т.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|		Т.ИдентификаторФинЗаписи ИдентификаторФинЗаписи
	|	ИЗ
	|		РегистрНакопления.ПрочиеРасходыНезавершенногоПроизводства КАК Т
	|	ГДЕ
	|		Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Т.Организация В (&МассивОрганизаций)
	|		И Т.Активность
	|		И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И Т.НастройкаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукции)
	|) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.ВидДвижения,
	|	Т.ДокументДвижения,
	|	Т.Организация,
	|	Т.ПартияПроизводства,
	|	Т.ЗаказНаПроизводство,
	|	Т.КодСтрокиПродукция,
	|	Т.Этап,
	|	Т.СтатьяКалькуляции,
	|	Т.АналитикаУчетаПродукции,
	|	Т.Продукция,
	|	Т.ХарактеристикаПродукции,
	|	Т.РазделУчета,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяРасходов,
	|	Т.ГруппаПродукции,
	|	Т.ПравилоОтнесенияНаВыпуск
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(Т.НовоеДвижение) = ИСТИНА
	|	И МАКСИМУМ(Т.ИдентификаторФинЗаписи) <> """"
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументДвижения,
	|	ПартияПроизводства,
	|	СтатьяРасходов,
	|	Подразделение
	|;
	|
	|ВЫБРАТЬ
	|	АВТОНОМЕРЗАПИСИ() КАК НомерЗаписи,
	|	Т.Период КАК Период,
	|	Т.ВидДвижения КАК ВидДвижения,
	|	Т.ДокументДвижения КАК ДокументДвижения,
	|	Т.Организация КАК Организация,
	|	Т.ПартияПроизводства КАК ПартияПроизводства,
	|	Т.Партия КАК Партия,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.СтатьяКалькуляцииСтоимости КАК СтатьяКалькуляцииСтоимости,
	|	Т.ГруппаПродукцииСтоимости КАК ГруппаПродукцииСтоимости,
	|	Т.ПравилоОтнесенияНаВыпускСтоимости КАК ПравилоОтнесенияНаВыпускСтоимости,
	|	Т.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Т.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	Т.КодСтрокиПродукцияДляСтоимости КАК КодСтрокиПродукцияДляСтоимости,
	|	Т.Этап КАК Этап,
	|	Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	Т.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
	|	Т.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	ВЫРАЗИТЬ(Т.ВидЗапасов КАК Справочник.ВидыЗапасов).ТипЗапасов КАК ТипЗапасов,
	|	Т.Назначение КАК Назначение,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.ПодразделениеСтоимости КАК ПодразделениеСтоимости,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.ПрямыеЗатратыРегл КАК ПрямыеЗатратыРегл,
	|	Т.ПрямыеЗатратыНУ КАК ПрямыеЗатратыНУ,
	|	Т.ПринимаемыеВНУ КАК ПринимаемыеВНУ,
	|	Т.Продукция КАК Продукция,
	|	Т.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|	Т.ГруппаПродукции КАК ГруппаПродукции,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.РазделУчетаСтоимости КАК РазделУчетаСтоимости,
	|	Т.ДокументВыпуска КАК ДокументВыпуска,
	|	Т.АналитикаПартииВыпуска КАК АналитикаПартииВыпуска,
	|	Т.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|	Т.ДоляСтоимости КАК ДоляСтоимости,
	|	Т.Количество КАК Количество,
	|	Т.КоличествоБезНДС КАК КоличествоБезНДС,
	|	Т.КоличествоРегл КАК КоличествоРегл,
	|	Т.КоличествоНУ КАК КоличествоНУ,
	|	Т.КоличествоУпр КАК КоличествоУпр,
	|	Т.КоличествоНДД,
	|	ЕСТЬNULL(Идентификаторы.ИдентификаторФинЗаписи, """") КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВтТаблицаКорректировки
	|ИЗ
	|	ВтТаблицаКорректировкиБезИдентификаторов КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИдентификаторыПоПолямТаблицыКорректировки КАК Идентификаторы
	|		 ПО Т.Период = Идентификаторы.Период
	|		 И Т.ВидДвижения = Идентификаторы.ВидДвижения
	|		 И Т.ДокументДвижения = Идентификаторы.ДокументДвижения
	|		 И Т.Организация = Идентификаторы.Организация
	|		 И Т.ПартияПроизводства = Идентификаторы.ПартияПроизводства
	|		 И Т.ЗаказНаПроизводство = Идентификаторы.ЗаказНаПроизводство
	|		 И Т.КодСтрокиПродукция = Идентификаторы.КодСтрокиПродукция
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.Этап) = ТИП(Справочник.ЭтапыПроизводства)
	|			ТОГДА Т.Этап
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ЭтапыПроизводства.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.Этап
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.СтатьяКалькуляции) = ТИП(Справочник.СтатьиКалькуляции)
	|			ТОГДА Т.СтатьяКалькуляции
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтатьиКалькуляции.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.СтатьяКалькуляции
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.АналитикаУчетаПродукции) = ТИП(Справочник.КлючиАналитикиУчетаНоменклатуры)
	|			ТОГДА Т.АналитикаУчетаПродукции
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.АналитикаУчетаПродукции
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.Продукция) = ТИП(Справочник.Номенклатура)
	|			ТОГДА Т.Продукция
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.Продукция
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.ХарактеристикаПродукции) = ТИП(Справочник.ХарактеристикиНоменклатуры)
	|			ТОГДА Т.ХарактеристикаПродукции
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.ХарактеристикаПродукции
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.РазделУчета) = ТИП(Перечисление.РазделыУчетаСебестоимостиТоваров)
	|			ТОГДА Т.РазделУчета
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.РазделУчета
	|		 И Т.Подразделение = Идентификаторы.Подразделение
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.НаправлениеДеятельности) = ТИП(Справочник.НаправленияДеятельности)
	|			ТОГДА Т.НаправлениеДеятельности
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.НаправлениеДеятельности
	|		 И Т.АналитикаРасходов = Идентификаторы.АналитикаРасходов
	|		 И Т.СтатьяРасходов = Идентификаторы.СтатьяРасходов
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.ГруппаПродукции) = ТИП(Справочник.ГруппыАналитическогоУчетаНоменклатуры)
	|			ТОГДА Т.ГруппаПродукции
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.ГруппаПродукции
	|		 И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.ПравилоОтнесенияНаВыпуск) = ТИП(Перечисление.ПравилаОтнесенияНаВыпуск)
	|			ТОГДА Т.ПравилоОтнесенияНаВыпуск
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка)
	|		  КОНЕЦ = Идентификаторы.ПравилоОтнесенияНаВыпуск
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ПодразделениеСтоимости,
	|	СтатьяРасходов,
	|	АналитикаРасходов
	|;
	|
	|ВЫБРАТЬ
	|	Т.НомерЗаписи
	|ИЗ
	|	ВтТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.ИдентификаторФинЗаписи = """"
	|";
	#КонецОбласти
	
	ТаблицаИдентификаторов = Новый ТаблицаЗначений;
	ТаблицаИдентификаторов.Колонки.Добавить("Идентификатор", ОбщегоНазначения.ОписаниеТипаСтрока(36));
	ТаблицаИдентификаторов.Колонки.Добавить("НомерЗаписи", ОбщегоНазначения.ОписаниеТипаЧисло(31));
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаИдентификаторов.Добавить();
		НоваяСтрока.Идентификатор = Новый УникальныйИдентификатор;
		НоваяСтрока.НомерЗаписи = Выборка.НомерЗаписи;
	КонецЦикла;
	
	Запрос.УстановитьПараметр("ТаблицаИдентификаторов", ТаблицаИдентификаторов);
	
	#Область ВтТаблицаКорректировкиВрем
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ТаблицаИдентификаторов.Идентификатор КАК Идентификатор,
	|	ТаблицаИдентификаторов.НомерЗаписи КАК НомерЗаписи
	|ПОМЕСТИТЬ ТаблицаИдентификаторов
	|ИЗ
	|	&ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерЗаписи
	|;
	|ВЫБРАТЬ
	|	ТаблицаКорректировки.Период КАК Период,
	|	ТаблицаКорректировки.ВидДвижения КАК ВидДвижения,
	|	ТаблицаКорректировки.ДокументДвижения КАК ДокументДвижения,
	|	ТаблицаКорректировки.Организация КАК Организация,
	|	ТаблицаКорректировки.ПартияПроизводства КАК ПартияПроизводства,
	|	ТаблицаКорректировки.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	ТаблицаКорректировки.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	ТаблицаКорректировки.Этап КАК Этап,
	|	ТаблицаКорректировки.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	ТаблицаКорректировки.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
	|	ТаблицаКорректировки.АналитикаУчетаПродукции КАК АналитикаУчетаПродукцииСебестоимость,
	|	ТаблицаКорректировки.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
	|	ТаблицаКорректировки.Продукция КАК Продукция,
	|	ТаблицаКорректировки.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|	ТаблицаКорректировки.РазделУчета КАК РазделУчета,
	|	ЕСТЬNULL(Выпуски.ВидЗапасов, ТаблицаКорректировки.ВидЗапасов) КАК ВидЗапасов,
	|	ЕСТЬNULL(Выпуски.Партия, НЕОПРЕДЕЛЕНО) КАК Партия,
	|	ЕСТЬNULL(Выпуски.АналитикаУчетаПартий, НЕОПРЕДЕЛЕНО) КАК АналитикаУчетаПартий,
	|	ЕСТЬNULL(Выпуски.АналитикаФинансовогоУчета, НЕОПРЕДЕЛЕНО) КАК АналитикаФинансовогоУчета,
	|	ЕСТЬNULL(Выпуски.ВидДеятельностиНДС, НЕОПРЕДЕЛЕНО) КАК ВидДеятельностиНДС,
	|	ЕСТЬNULL(ТаблицаКорректировки.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) КАК ТипЗапасов,
	|	ТаблицаКорректировки.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	ТаблицаКорректировки.Подразделение КАК Подразделение,
	|	ТаблицаКорректировки.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	ТаблицаКорректировки.АналитикаРасходов КАК АналитикаРасходов,
	|	ТаблицаКорректировки.СтатьяРасходов КАК СтатьяРасходов,
	|	ТаблицаКорректировки.ГруппаПродукции КАК ГруппаПродукции,
	|	ТаблицаКорректировки.ПодразделениеСтоимости КАК ИсходноеПодразделение,
	|	ТаблицаКорректировки.Подразделение КАК КорПодразделение,
	|	ТаблицаКорректировки.АналитикаПартииВыпуска КАК АналитикаПартииВыпуска,
	|	ТаблицаКорректировки.ДокументВыпуска КАК ДокументВыпуска,
	|	ТаблицаКорректировки.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|	ТаблицаКорректировки.КоличествоРегл КАК БазаРаспределения,
	|	ТаблицаКорректировки.ДоляСтоимости КАК ДоляСтоимости,
	|	ТаблицаКорректировки.Количество КАК Количество,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(Стоимости.Стоимость, 0) КАК ЧИСЛО(31,2)) КАК Стоимость,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоБезНДС КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(Стоимости.СтоимостьБезНДС, 0) КАК ЧИСЛО(31,2)) КАК СтоимостьБезНДС,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(Стоимости.СтоимостьДопРасходы, 0) КАК ЧИСЛО(31,2)) КАК ДопРасходы,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоБезНДС КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(Стоимости.СтоимостьДопРасходыБезНДС, 0) КАК ЧИСЛО(31,2)) КАК ДопРасходыБезНДС,
	|
	//++ Локализация
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.ПостояннаяРазница, 0) КАК ЧИСЛО(31,2)) +
	//-- Локализация
	|	0 КАК ПостояннаяРазница,
	|
	//++ Локализация
	|	ВЫБОР
	// При распределении на выпуск берем рассчитанную сумму временной разницы.
	|		КОГДА ТаблицаКорректировки.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) ТОГДА
	|			ВЫРАЗИТЬ(ВЫБОР КОГДА ТаблицаКорректировки.ПрямыеЗатратыНУ ТОГДА
	|				ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоНУ КАК ЧИСЛО(23,10))
	|					* ЕСТЬNULL(СтоимостиРегл.ВременнаяРазница, 0)
	|			ИНАЧЕ
	|				ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|					* ЕСТЬNULL(СтоимостиРегл.ВременнаяРазница, 0)
	|			КОНЕЦ КАК ЧИСЛО(31,2))
	// При распределении на партию производства рассчитываем временную разницу в зависимости от вариантов распределения статьи. 
	|	ИНАЧЕ
	|		ВЫРАЗИТЬ(
	|			ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|				* ЕСТЬNULL(СтоимостиРегл.СтоимостьРегл, 0) КАК ЧИСЛО(31,2))
	|		+ ВЫРАЗИТЬ(
	|			ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|				* ЕСТЬNULL(СтоимостиРегл.ДопРасходыРегл, 0) КАК ЧИСЛО(31,2))
	|		+ ВЫРАЗИТЬ(
	|			ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|				* ЕСТЬNULL(СтоимостиРегл.ТрудозатратыРегл, 0) КАК ЧИСЛО(31,2))
	|		+ ВЫРАЗИТЬ(
	|			ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|				* ВЫБОР
	|				КОГДА НЕ ТаблицаКорректировки.ПрямыеЗатратыРегл И ТаблицаКорректировки.ПрямыеЗатратыНУ
	|					ТОГДА 0
	|				ИНАЧЕ 
	|					ВЫРАЗИТЬ(ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеРегл, 0) КАК ЧИСЛО(23,10)) КОНЕЦ
	|		КАК ЧИСЛО(31,2))
	|		+ ВЫРАЗИТЬ(
	|			ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|				* ВЫБОР
	|				КОГДА НЕ ТаблицаКорректировки.ПрямыеЗатратыРегл И ТаблицаКорректировки.ПрямыеЗатратыНУ
	|					ТОГДА 0
	|				ИНАЧЕ 
	|					ВЫРАЗИТЬ(ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеРегл, 0) КАК ЧИСЛО(23,10)) КОНЕЦ
	|		КАК ЧИСЛО(31,2))
	|		- ВЫРАЗИТЬ(
	|			ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|				* ЕСТЬNULL(СтоимостиРегл.ПостояннаяРазница, 0) КАК ЧИСЛО(31,2))
	|		- ВЫРАЗИТЬ(
	|			ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоНУ КАК ЧИСЛО(23,10))
	|				* ЕСТЬNULL(СтоимостиРегл.СтоимостьНУ, 0) КАК ЧИСЛО(31,2))
	|	КОНЕЦ +
	//-- Локализация
	|	0 КАК ВременнаяРазница,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоНДД КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.СтоимостьНДД, 0)КАК ЧИСЛО(31,2)) КАК СтоимостьНДД,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.СтоимостьРегл, 0) КАК ЧИСЛО(31,2)) КАК СтоимостьРегл,
	|
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.Количество
	|			* ЕСТЬNULL(Стоимости.СтоимостьЗабалансовая, 0) КАК ЧИСЛО(31,2)) 		КАК СтоимостьЗабалансовая,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(Стоимости.Трудозатраты, 0) КАК ЧИСЛО(31,2)) 					КАК Трудозатраты,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество КАК ЧИСЛО(23,10))
	|			* ВЫРАЗИТЬ(ЕСТЬNULL(Стоимости.ПостатейныеПостоянныеСНДС, 0) КАК ЧИСЛО(23,10)) КАК ЧИСЛО(31,2)) 	КАК ПостатейныеПостоянныеСНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоБезНДС КАК ЧИСЛО(23,10))
	|			* ВЫРАЗИТЬ(ЕСТЬNULL(Стоимости.ПостатейныеПостоянныеБезНДС, 0) КАК ЧИСЛО(23,10)) КАК ЧИСЛО(31,2)) 	КАК ПостатейныеПостоянныеБезНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.Количество КАК ЧИСЛО(23,10))
	|			* ВЫРАЗИТЬ(ЕСТЬNULL(Стоимости.ПостатейныеПеременныеСНДС, 0) КАК ЧИСЛО(23,10)) КАК ЧИСЛО(31,2)) 	КАК ПостатейныеПеременныеСНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоБезНДС КАК ЧИСЛО(23,10))
	|			* ВЫРАЗИТЬ(ЕСТЬNULL(Стоимости.ПостатейныеПеременныеБезНДС, 0) КАК ЧИСЛО(23,10)) КАК ЧИСЛО(31,2)) 	КАК ПостатейныеПеременныеБезНДС,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.СтоимостьЗабалансоваяРегл, 0) КАК ЧИСЛО(31,2)) КАК СтоимостьЗабалансоваяРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.ДопРасходыРегл, 0) КАК ЧИСЛО(31,2)) 			КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.ТрудозатратыРегл, 0) КАК ЧИСЛО(31,2)) 			КАК ТрудозатратыРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоБезНДС КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(Стоимости.ТрудозатратыБезНДС, 0) КАК ЧИСЛО(31,2)) 			КАК ТрудозатратыБезНДС,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|			* ВЫБОР
	|			КОГДА НЕ ТаблицаКорректировки.ПрямыеЗатратыРегл И ТаблицаКорректировки.ПрямыеЗатратыНУ
	|				ТОГДА 0
	|			ИНАЧЕ 
	|				ВЫРАЗИТЬ(ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеРегл, 0) КАК ЧИСЛО(23,10)) КОНЕЦ
	|	КАК ЧИСЛО(31,2)) КАК ПостатейныеПостоянныеРегл,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|			* ВЫБОР
	|			КОГДА НЕ ТаблицаКорректировки.ПрямыеЗатратыРегл И ТаблицаКорректировки.ПрямыеЗатратыНУ
	|				ТОГДА 0
	|			ИНАЧЕ 
	|				ВЫРАЗИТЬ(ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеРегл, 0) КАК ЧИСЛО(23,10)) КОНЕЦ
	|	КАК ЧИСЛО(31,2)) КАК ПостатейныеПеременныеРегл,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.РезервРегл, 0) КАК ЧИСЛО(31,2)) 				КАК РезервРегл,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоУпр КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.СтоимостьУпр, 0) КАК ЧИСЛО(31,2))				КАК СтоимостьУпр,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоУпр КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.ДопРасходыУпр, 0) КАК ЧИСЛО(31,2)) 			КАК ДопРасходыУпр,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоУпр КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.ТрудозатратыУпр, 0) КАК ЧИСЛО(31,2)) 			КАК ТрудозатратыУпр,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоУпр КАК ЧИСЛО(23,10))
	|			* ВЫРАЗИТЬ(ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеУпр, 0) КАК ЧИСЛО(23,10)) КАК ЧИСЛО(31,2))	КАК ПостатейныеПостоянныеУпр,
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоУпр КАК ЧИСЛО(23,10))
	|			* ВЫРАЗИТЬ(ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеУпр, 0) КАК ЧИСЛО(23,10)) КАК ЧИСЛО(31,2))	КАК ПостатейныеПеременныеУпр,
	|
	|	ВЫРАЗИТЬ(
	|		ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоУпр КАК ЧИСЛО(23,10))
	|			* ЕСТЬNULL(СтоимостиРегл.РезервУпр, 0) КАК ЧИСЛО(31,2)) 				КАК РезервУпр,
	|
	|	ВЫБОР
	|		КОГДА ТаблицаКорректировки.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			И НЕ (ЕСТЬNULL(Стоимости.Стоимость, 0) = 0
	|					И ЕСТЬNULL(Стоимости.СтоимостьБезНДС, 0) = 0
	|					И ЕСТЬNULL(Стоимости.СтоимостьДопРасходы, 0) = 0
	|					И ЕСТЬNULL(Стоимости.СтоимостьДопРасходыБезНДС, 0) = 0
	|					И ЕСТЬNULL(Стоимости.Трудозатраты, 0) = 0
	|					И ЕСТЬNULL(Стоимости.ПостатейныеПостоянныеСНДС, 0) = 0
	|					И ЕСТЬNULL(Стоимости.ПостатейныеПостоянныеБезНДС, 0) = 0
	|					И ЕСТЬNULL(Стоимости.ПостатейныеПеременныеСНДС, 0) = 0
	|					И ЕСТЬNULL(Стоимости.ПостатейныеПеременныеБезНДС, 0) = 0
	|					И ЕСТЬNULL(Стоимости.ТрудозатратыБезНДС, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.СтоимостьУпр, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ДопРасходыУпр, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ТрудозатратыУпр, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеУпр, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеУпр, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеРегл, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеРегл, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ТрудозатратыРегл, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ДопРасходыРегл, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.СтоимостьНУ, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.ПостояннаяРазница, 0) = 0
	
	|					И ЕСТЬNULL(СтоимостиРегл.СтоимостьНДД, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.СтоимостьРегл, 0) = 0
	|					И ЕСТЬNULL(Стоимости.СтоимостьЗабалансовая, 0) = 0
	|					И ЕСТЬNULL(СтоимостиРегл.СтоимостьЗабалансоваяРегл, 0) = 0)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ
	|			ЛОЖЬ
	|	КОНЕЦ КАК ЕстьРасход,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииПостатейные)
	|		ИНАЧЕ НастройкиХозОпераций.Ссылка КОНЕЦ) КАК НастройкаХозяйственнойОперации,
	|	ЕСТЬNULL(Выпуски.ИдентификаторФинЗаписи,
	|		ЕСТЬNULL(ТаблицаИдентификаторов.Идентификатор, ТаблицаКорректировки.ИдентификаторФинЗаписи)) КАК ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ ВтТаблицаКорректировкиВрем
	|
	|ИЗ
	|	ВтТаблицаКорректировки КАК ТаблицаКорректировки
	|	ЛЕВОЕ СОЕДИНЕНИЕ Выпуски КАК Выпуски
	|		ПО Выпуски.Регистратор = ТаблицаКорректировки.ДокументДвижения
	|		И Выпуски.АналитикаУчетаНоменклатуры = ТаблицаКорректировки.АналитикаУчетаПродукции
	|		И Выпуски.РазделУчета = ТаблицаКорректировки.РазделУчета
	|		И Выпуски.АналитикаУчетаПартий = ТаблицаКорректировки.КорАналитикаУчетаПартий
	|		И Выпуски.ВидЗапасов = ТаблицаКорректировки.ВидЗапасов
	|		И (Выпуски.ВидДеятельностиНДС = ТаблицаКорректировки.ВидДеятельностиНДС
	|			ИЛИ ТаблицаКорректировки.ВидДеятельностиНДС = НЕОПРЕДЕЛЕНО)
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтСтоимостиНезавершенногоПроизводства КАК Стоимости
	|	ПО 
	|		ТаблицаКорректировки.Партия = Стоимости.Партия
	|		И ТаблицаКорректировки.АналитикаУчетаПартий = Стоимости.АналитикаУчетаПартий
	|		И ТаблицаКорректировки.СтатьяРасходов = Стоимости.СтатьяРасходов
	|		И ТаблицаКорректировки.АналитикаРасходов = Стоимости.АналитикаРасходов
	|		И ТаблицаКорректировки.ПодразделениеСтоимости = Стоимости.Подразделение
	|		И ТаблицаКорректировки.Этап = Стоимости.Этап
	|		И ТаблицаКорректировки.Организация = Стоимости.Организация
	|		И ТаблицаКорректировки.НаправлениеДеятельности = Стоимости.НаправлениеДеятельности
	|		И ТаблицаКорректировки.СтатьяКалькуляцииСтоимости = Стоимости.СтатьяКалькуляции
	|		И ТаблицаКорректировки.ГруппаПродукцииСтоимости = Стоимости.ГруппаПродукции
	|		И ТаблицаКорректировки.ПравилоОтнесенияНаВыпускСтоимости = Стоимости.ПравилоОтнесенияНаВыпуск
	|		И ТаблицаКорректировки.КодСтрокиПродукцияДляСтоимости = Стоимости.КодСтрокиПродукция
	|		И ТаблицаКорректировки.РазделУчетаСтоимости = Стоимости.РазделУчета
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтСтоимостиНезавершенногоПроизводстваРегл КАК СтоимостиРегл
	|	ПО 
	|		ТаблицаКорректировки.Партия = СтоимостиРегл.Партия
	|		И ТаблицаКорректировки.АналитикаУчетаПартий = СтоимостиРегл.АналитикаУчетаПартий
	|		И ТаблицаКорректировки.СтатьяРасходов = СтоимостиРегл.СтатьяРасходов
	|		И ТаблицаКорректировки.АналитикаРасходов = СтоимостиРегл.АналитикаРасходов
	|		И ТаблицаКорректировки.ПодразделениеСтоимости = СтоимостиРегл.Подразделение
	|		И ТаблицаКорректировки.Этап = СтоимостиРегл.Этап
	|		И ТаблицаКорректировки.Организация = СтоимостиРегл.Организация
	|		И ТаблицаКорректировки.НаправлениеДеятельности = СтоимостиРегл.НаправлениеДеятельности
	|		И ТаблицаКорректировки.СтатьяКалькуляцииСтоимости = СтоимостиРегл.СтатьяКалькуляции
	|		И ТаблицаКорректировки.ГруппаПродукцииСтоимости = СтоимостиРегл.ГруппаПродукции
	|		И ТаблицаКорректировки.ПравилоОтнесенияНаВыпускСтоимости = СтоимостиРегл.ПравилоОтнесенияНаВыпуск
	|		И ТаблицаКорректировки.КодСтрокиПродукцияДляСтоимости = СтоимостиРегл.КодСтрокиПродукция
	|		И ТаблицаКорректировки.РазделУчетаСтоимости = СтоимостиРегл.РазделУчета
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		Справочник.Назначения КАК СпрНазначения
	|	ПО
	|		ТаблицаКорректировки.Назначение = СпрНазначения.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|		ПО ТаблицаИдентификаторов.НомерЗаписи = ТаблицаКорректировки.НомерЗаписи
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиХозяйственныхОпераций КАК НастройкиХозОпераций
	|		ПО НастройкиХозОпераций.ХозяйственнаяОперация = ТаблицаКорректировки.ХозяйственнаяОперация
	|ГДЕ
	|	ТаблицаКорректировки.Количество <> 0
	|	ИЛИ ТаблицаКорректировки.КоличествоБезНДС <> 0	
	|	ИЛИ ТаблицаКорректировки.КоличествоРегл <> 0	
	|	ИЛИ ТаблицаКорректировки.КоличествоНУ <> 0	
	|	ИЛИ ТаблицаКорректировки.КоличествоУпр <> 0	
	|	ИЛИ ТаблицаКорректировки.КоличествоНДД <> 0
	|;";
	#КонецОбласти
	
	#Область ПогрешностиПеремещения
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	ТаблицаКорректировки.Период,
	|	ТаблицаКорректировки.Организация,
	|	ТаблицаКорректировки.АналитикаУчетаПродукцииСебестоимость,
	|	ТаблицаКорректировки.РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов,
	|	ТаблицаКорректировки.Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС,
	|	СУММА(ТаблицаКорректировки.Количество),
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.ПостатейныеПостоянныеСНДС
	|	   	- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеСНДС КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2))  КАК ПостатейныеПостоянныеСНДС,
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС
	|	   	- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2))  КАК ПостатейныеПостоянныеБезНДС,
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.ПостатейныеПеременныеСНДС
	|	   	- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеСНДС КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2))  КАК ПостатейныеПеременныеСНДС,
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.ПостатейныеПеременныеБезНДС
	|	   	- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеБезНДС КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2))  КАК ПостатейныеПеременныеБезНДС,
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|	   	- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеРегл КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2))  КАК ПостатейныеПостоянныеРегл,
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|	   	- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеРегл КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2))  КАК ПостатейныеПеременныеРегл,
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.ПостатейныеПостоянныеУпр
	|	   	- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеУпр КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2))  КАК ПостатейныеПостоянныеУпр,
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.ПостатейныеПеременныеУпр
	|	   	- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеУпр КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2))  КАК ПостатейныеПеременныеУпр,
	|	ВЫРАЗИТЬ(СУММА(ТаблицаКорректировки.СтоимостьНДД
	|		- ВЫРАЗИТЬ(ТаблицаКорректировки.СтоимостьНДД КАК ЧИСЛО(31,2))) КАК ЧИСЛО(31, 2)) КАК СтоимостьНДД
	|ПОМЕСТИТЬ ПогрешностиОкругления
	|ИЗ
	|	ВтТаблицаКорректировкиВрем КАК ТаблицаКорректировки
	|ГДЕ
	|	ТаблицаКорректировки.Количество <> 0
	|	И ТаблицаКорректировки.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НЕ (ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеСНДС
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеСНДС КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0 
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеСНДС
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеСНДС КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеБезНДС
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеБезНДС КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеСНДС
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеСНДС КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеРегл КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеРегл КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеУпр
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПостоянныеУпр КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеУпр
	|	   		- ВЫРАЗИТЬ(ТаблицаКорректировки.ПостатейныеПеременныеУпр КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		И ВЫРАЗИТЬ(ТаблицаКорректировки.СтоимостьНДД
	|			- ВЫРАЗИТЬ(ТаблицаКорректировки.СтоимостьНДД КАК ЧИСЛО(31,2)) КАК ЧИСЛО(31, 2)) = 0
	|		)
	|
	|СГРУППИРОВАТЬ ПО
	|	ТаблицаКорректировки.Период,
	|	ТаблицаКорректировки.Организация,
	|	ТаблицаКорректировки.АналитикаУчетаПродукцииСебестоимость,
	|	ТаблицаКорректировки.РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов,
	|	ТаблицаКорректировки.Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС
	|;
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.ВидДвижения,
	|	Т.ДокументДвижения,
	|	Т.Организация,
	|	Т.ПартияПроизводства,
	|	Т.ЗаказНаПроизводство,
	|	Т.КодСтрокиПродукция,
	|	Т.Этап,
	|	Т.СтатьяКалькуляции,
	|	Т.АналитикаУчетаПродукции,
	|	Т.АналитикаУчетаПродукцииСебестоимость,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.Продукция,
	|	Т.ХарактеристикаПродукции,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ТипЗапасов,
	|	Т.ХозяйственнаяОперация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяРасходов,
	|	Т.ГруппаПродукции,
	|	Т.ИсходноеПодразделение,
	|	Т.КорПодразделение,
	|	Т.АналитикаПартииВыпуска,
	|	Т.ДокументВыпуска,
	|	Т.ПравилоОтнесенияНаВыпуск,
	|	Т.БазаРаспределения,
	|	Т.ДоляСтоимости,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	СУММА(Т.Количество) КАК Количество
	|ПОМЕСТИТЬ ПриемникиПогрешностей
	|ИЗ
	|	ВтТаблицаКорректировкиВрем КАК Т
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПогрешностиОкругления КАК Погрешности
	|		ПО Погрешности.Организация = Т.Организация
	|			И Погрешности.АналитикаУчетаПродукцииСебестоимость = Т.АналитикаУчетаПродукцииСебестоимость 
	|			И Погрешности.РазделУчета = Т.РазделУчета
	|			И Погрешности.ВидЗапасов = Т.ВидЗапасов
	|			И Погрешности.Партия = Т.Партия
	|			И Погрешности.АналитикаУчетаПартий = Т.АналитикаУчетаПартий
	|			И Погрешности.АналитикаФинансовогоУчета = Т.АналитикаФинансовогоУчета
	|			И Погрешности.ВидДеятельностиНДС = Т.ВидДеятельностиНДС
	|ГДЕ
	|	Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)	
	|	И НЕ Погрешности.Организация ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	|	Т.ВидДвижения,
	|	Т.ДокументДвижения,
	|	Т.Организация,
	|	Т.ПартияПроизводства,
	|	Т.ЗаказНаПроизводство,
	|	Т.КодСтрокиПродукция,
	|	Т.Этап,
	|	Т.СтатьяКалькуляции,
	|	Т.АналитикаУчетаПродукции,
	|	Т.АналитикаУчетаПродукцииСебестоимость,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.Продукция,
	|	Т.ХарактеристикаПродукции,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ТипЗапасов,
	|	Т.ХозяйственнаяОперация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяРасходов,
	|	Т.ГруппаПродукции,
	|	Т.ИсходноеПодразделение,
	|	Т.КорПодразделение,
	|	Т.АналитикаПартииВыпуска,
	|	Т.ДокументВыпуска,
	|	Т.ПравилоОтнесенияНаВыпуск,
	|	Т.БазаРаспределения,
	|	Т.ДоляСтоимости,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|;";
	#КонецОбласти
	
	#Область АналитикиРасходныхДвиженийПостатейныхРасходов
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.ПартияПроизводства КАК ПартияПроизводства,
	|	Т.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Т.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|	Т.Этап КАК Этап,
	|	Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|	Т.ГруппаПродукции КАК ГруппаПродукции,
	|	Т.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск
	|
	|ПОМЕСТИТЬ АналитикиРасходныхДвиженийПостатейныхРасходов
	|ИЗ (
	|	ВЫБРАТЬ
	|		ТаблицаКорректировки.Организация				КАК Организация,
	|		ТаблицаКорректировки.Подразделение				КАК Подразделение,
	|		ТаблицаКорректировки.СтатьяРасходов				КАК СтатьяРасходов,
	|		ТаблицаКорректировки.АналитикаРасходов			КАК АналитикаРасходов,
	|		ТаблицаКорректировки.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|		ТаблицаКорректировки.ПартияПроизводства			КАК ПартияПроизводства,
	|		ТаблицаКорректировки.ЗаказНаПроизводство		КАК ЗаказНаПроизводство,
	|		ТаблицаКорректировки.КодСтрокиПродукция			КАК КодСтрокиПродукция,
	|		ТаблицаКорректировки.Этап						КАК Этап,
	|		ТаблицаКорректировки.СтатьяКалькуляции			КАК СтатьяКалькуляции,
	|		ТаблицаКорректировки.ГруппаПродукции			КАК ГруппаПродукции,
	|		ТаблицаКорректировки.ПравилоОтнесенияНаВыпуск	КАК ПравилоОтнесенияНаВыпуск
	|
	|	ИЗ
	|		ВтТаблицаКорректировкиВрем КАК ТаблицаКорректировки
	|	ГДЕ
	|		ТаблицаКорректировки.ЕстьРасход
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ПрочиеРасходыНЗП.Организация				КАК Организация,
	|		ПрочиеРасходыНЗП.Подразделение				КАК Подразделение,
	|		ПрочиеРасходыНЗП.СтатьяРасходов				КАК СтатьяРасходов,
	|		ПрочиеРасходыНЗП.АналитикаРасходов			КАК АналитикаРасходов,
	|		ПрочиеРасходыНЗП.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|		ПрочиеРасходыНЗП.ПартияПроизводства			КАК ПартияПроизводства,
	|		ПрочиеРасходыНЗП.ЗаказНаПроизводство		КАК ЗаказНаПроизводство,
	|		ПрочиеРасходыНЗП.КодСтрокиПродукция			КАК КодСтрокиПродукция,
	|		ПрочиеРасходыНЗП.Этап						КАК Этап,
	|		ПрочиеРасходыНЗП.СтатьяКалькуляции			КАК СтатьяКалькуляции,
	|		ПрочиеРасходыНЗП.ГруппаПродукции			КАК ГруппаПродукции,
	|		ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск	КАК ПравилоОтнесенияНаВыпуск
	|	ИЗ
	|		ВТКэшРасчетныеОборотыПрочиеРасходыНезавершенногоПроизводства КАК ПрочиеРасходыНЗП
	|	ГДЕ
	|		НЕ ПрочиеРасходыНЗП.СлужебноеВидДвиженияПриход
	|		И ПрочиеРасходыНЗП.Сторно
	|	) КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Подразделение,
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	НаправлениеДеятельности,
	|	ПартияПроизводства,
	|	ЗаказНаПроизводство,
	|	КодСтрокиПродукция,
	|	Этап,
	|	СтатьяКалькуляции,
	|	ГруппаПродукции,
	|	ПравилоОтнесенияНаВыпуск
	|;";
	#КонецОбласти
	
	Запрос.Выполнить();
	
	#Область РаспределениеДанных
	
	// Инициализируем распределение
	ПоляСвязи = "Период, Организация, АналитикаУчетаПродукцииСебестоимость, ВидЗапасов, РазделУчета, Партия, АналитикаУчетаПартий,
		|АналитикаФинансовогоУчета, ВидДеятельностиНДС";
	ПараметрыРаспределения = РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПараметрыРаспределенияМетодомУменьшаемогоОстатка(
		"ПогрешностиОкругления",
		"ПриемникиПогрешностей",
		ПоляСвязи);
	
	РаспределяемыеРесурсы = "ПостатейныеПостоянныеСНДС,ПостатейныеПеременныеСНДС,ПостатейныеПостоянныеБезНДС,ПостатейныеПеременныеБезНДС,
		|ПостатейныеПостоянныеРегл,ПостатейныеПеременныеРегл,ПостатейныеПостоянныеУпр,ПостатейныеПеременныеУпр,СтоимостьНДД";
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьЧисловыеПоляРаспределенияМетодомУменьшаемогоОстатка(
		ПараметрыРаспределения,
		РаспределяемыеРесурсы);
		
	ПрочиеПоляБазы = "ВидДвижения, ДокументДвижения, ПартияПроизводства, ЗаказНаПроизводство, КодСтрокиПродукция, Этап, СтатьяКалькуляции, АналитикаУчетаПродукции, КорАналитикаУчетаПартий,
		|Продукция, ХарактеристикаПродукции, ТипЗапасов, ХозяйственнаяОперация, Подразделение, НаправлениеДеятельности, КорНаправлениеДеятельности, АналитикаРасходов, СтатьяРасходов,
		|ГруппаПродукции, ИсходноеПодразделение, КорПодразделение, АналитикаПартииВыпуска, ДокументВыпуска, ПравилоОтнесенияНаВыпуск, БазаРаспределения, ДоляСтоимости, НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи";
		
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПрочиеПоляРаспределенияМетодомУменьшаемогоОстатка(
		ПараметрыРаспределения,
		,
		ПрочиеПоляБазы);
		
	// Распределяем
	РасчетСебестоимостиУниверсальныеАлгоритмы.РаспределитьМетодомУменьшаемогоОстатка(Запрос.МенеджерВременныхТаблиц, ПараметрыРаспределения);
	
	#КонецОбласти
	
	#Область ДвиженияТаблицаКорректировки
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.ЭтоКорректировка,
	|	Т.ОстаткиНЗП,
	|	Т.Период,
	|	Т.ВидДвижения,
	|	Т.ДокументДвижения,
	|	Т.Организация,
	|	Т.ПартияПроизводства,
	|	Т.ЗаказНаПроизводство,
	|	Т.КодСтрокиПродукция,
	|	Т.Этап,
	|	Т.СтатьяКалькуляции,
	|	Т.АналитикаУчетаПродукции,
	|	Т.АналитикаУчетаПродукцииСебестоимость,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.Продукция,
	|	Т.ХарактеристикаПродукции,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ТипЗапасов,
	|	Т.ХозяйственнаяОперация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА Т.ВидЗапасов
	|		ИНАЧЕ 
	|			Т.Продукция
	|	КОНЕЦ КАК ИсточникГФУНоменклатуры,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяРасходов,
	|	Т.ГруппаПродукции,
	|	Т.ИсходноеПодразделение,
	|	Т.КорПодразделение,
	|	Т.АналитикаПартииВыпуска,
	|	Т.ДокументВыпуска,
	|	Т.ПравилоОтнесенияНаВыпуск,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	МАКСИМУМ(Т.БазаРаспределения) КАК БазаРаспределения,
	|	СУММА(Т.ДоляСтоимости) КАК ДоляСтоимости,
	|	СУММА(Т.Стоимость) КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.ДопРасходы) КАК ДопРасходы,
	|	СУММА(Т.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(Т.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(Т.СтоимостьНДД) КАК СтоимостьНДД,
	|	СУММА(Т.СтоимостьРегл) КАК СтоимостьРегл,
	|	СУММА(Т.СтоимостьЗабалансовая) КАК СтоимостьЗабалансовая,
	|	СУММА(Т.Трудозатраты) КАК Трудозатраты,
	|	ВЫРАЗИТЬ(СУММА(Т.ПостатейныеПостоянныеСНДС) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеСНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.ПостатейныеПостоянныеБезНДС) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.ПостатейныеПеременныеСНДС) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеСНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.ПостатейныеПеременныеБезНДС) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(Т.СтоимостьЗабалансоваяРегл) КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Т.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Т.ТрудозатратыРегл) КАК ТрудозатратыРегл,
	|	СУММА(Т.ТрудозатратыБезНДС) КАК ТрудозатратыБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.ПостатейныеПостоянныеРегл) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.ПостатейныеПеременныеРегл) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеРегл,
	|	СУММА(Т.РезервРегл) КАК РезервРегл,
	|	СУММА(Т.СтоимостьУпр) КАК СтоимостьУпр,
	|	СУММА(Т.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Т.ТрудозатратыУпр) КАК ТрудозатратыУпр,
	|	ВЫРАЗИТЬ(СУММА(Т.ПостатейныеПостоянныеУпр) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеУпр,
	|	ВЫРАЗИТЬ(СУММА(Т.ПостатейныеПеременныеУпр) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеУпр,
	|	СУММА(Т.РезервУпр) КАК РезервУпр,
	|  	
	|	ВЫРАЗИТЬ(СУММА(Т.СуммаСНДС) КАК ЧИСЛО(31, 2)) КАК СуммаСНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СуммаБезНДС) КАК ЧИСЛО(31, 2)) КАК СуммаБезНДС,
	|	ВЫРАЗИТЬ(СУММА(Т.СуммаРегл) КАК ЧИСЛО(31, 2)) КАК СуммаРегл,
	|	ВЫРАЗИТЬ(СУММА(Т.СуммаУпр) КАК ЧИСЛО(31, 2)) КАК СуммаУпр,
	|	ВЫРАЗИТЬ(СУММА(Т.СуммаНДД) КАК ЧИСЛО(31, 2)) КАК СуммаНДД
	|ПОМЕСТИТЬ ДвиженияТаблицаКорректировки
	|ИЗ
	|	(ВЫБРАТЬ
	|		ЛОЖЬ КАК ЭтоКорректировка,
	|		ЛОЖЬ КАК ОстаткиНЗП,
	|		ВтТаблицаКорректировкиВрем.Период КАК Период,
	|		ВтТаблицаКорректировкиВрем.ВидДвижения КАК ВидДвижения,
	|		ВтТаблицаКорректировкиВрем.ДокументДвижения КАК ДокументДвижения,
	|		ВтТаблицаКорректировкиВрем.Организация КАК Организация,
	|		ВтТаблицаКорректировкиВрем.ПартияПроизводства КАК ПартияПроизводства,
	|		ВтТаблицаКорректировкиВрем.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|		ВтТаблицаКорректировкиВрем.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|		ВтТаблицаКорректировкиВрем.Этап КАК Этап,
	|		ВтТаблицаКорректировкиВрем.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		ВтТаблицаКорректировкиВрем.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
	|		ВтТаблицаКорректировкиВрем.АналитикаУчетаПродукции КАК АналитикаУчетаПродукцииСебестоимость,
	|		ВтТаблицаКорректировкиВрем.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
	|		ВтТаблицаКорректировкиВрем.Продукция КАК Продукция,
	|		ВтТаблицаКорректировкиВрем.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|		ВтТаблицаКорректировкиВрем.РазделУчета КАК РазделУчета,
	|		ВтТаблицаКорректировкиВрем.ВидЗапасов КАК ВидЗапасов,
	|		ВтТаблицаКорректировкиВрем.Партия КАК Партия,
	|		ВтТаблицаКорректировкиВрем.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		ВтТаблицаКорректировкиВрем.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		ВтТаблицаКорректировкиВрем.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		ВтТаблицаКорректировкиВрем.ТипЗапасов КАК ТипЗапасов,
	|		ВтТаблицаКорректировкиВрем.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|		ВтТаблицаКорректировкиВрем.Подразделение КАК Подразделение,
	|		ВтТаблицаКорректировкиВрем.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		ВтТаблицаКорректировкиВрем.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|		ВтТаблицаКорректировкиВрем.АналитикаРасходов КАК АналитикаРасходов,
	|		ВтТаблицаКорректировкиВрем.СтатьяРасходов КАК СтатьяРасходов,
	|		ВтТаблицаКорректировкиВрем.ГруппаПродукции КАК ГруппаПродукции,
	|		ВтТаблицаКорректировкиВрем.ИсходноеПодразделение КАК ИсходноеПодразделение,
	|		ВтТаблицаКорректировкиВрем.Подразделение КАК КорПодразделение,
	|		ВтТаблицаКорректировкиВрем.АналитикаПартииВыпуска КАК АналитикаПартииВыпуска,
	|		ВтТаблицаКорректировкиВрем.ДокументВыпуска КАК ДокументВыпуска,
	|		ВтТаблицаКорректировкиВрем.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|		ВтТаблицаКорректировкиВрем.БазаРаспределения КАК БазаРаспределения,
	|		ВтТаблицаКорректировкиВрем.ДоляСтоимости КАК ДоляСтоимости,
	|		ВтТаблицаКорректировкиВрем.Стоимость КАК Стоимость,
	|		ВтТаблицаКорректировкиВрем.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|		ВтТаблицаКорректировкиВрем.ДопРасходы КАК ДопРасходы,
	|		ВтТаблицаКорректировкиВрем.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|		ВтТаблицаКорректировкиВрем.ПостояннаяРазница КАК ПостояннаяРазница,
	|		ВтТаблицаКорректировкиВрем.ВременнаяРазница КАК ВременнаяРазница,
	|		ВтТаблицаКорректировкиВрем.СтоимостьНДД КАК СтоимостьНДД,
	|		ВтТаблицаКорректировкиВрем.СтоимостьРегл КАК СтоимостьРегл,
	|		ВтТаблицаКорректировкиВрем.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|		ВтТаблицаКорректировкиВрем.Трудозатраты КАК Трудозатраты,
	|		ВЫРАЗИТЬ(ВтТаблицаКорректировкиВрем.ПостатейныеПостоянныеСНДС КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеСНДС,
	|		ВЫРАЗИТЬ(ВтТаблицаКорректировкиВрем.ПостатейныеПостоянныеБезНДС КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеБезНДС,
	|		ВЫРАЗИТЬ(ВтТаблицаКорректировкиВрем.ПостатейныеПеременныеСНДС КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеСНДС,
	|		ВЫРАЗИТЬ(ВтТаблицаКорректировкиВрем.ПостатейныеПеременныеБезНДС КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеБезНДС,
	|		ВтТаблицаКорректировкиВрем.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|		ВтТаблицаКорректировкиВрем.ДопРасходыРегл КАК ДопРасходыРегл,
	|		ВтТаблицаКорректировкиВрем.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|		ВтТаблицаКорректировкиВрем.ТрудозатратыБезНДС КАК ТрудозатратыБезНДС,
	|		ВЫРАЗИТЬ(ВтТаблицаКорректировкиВрем.ПостатейныеПостоянныеРегл КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеРегл,
	|		ВЫРАЗИТЬ(ВтТаблицаКорректировкиВрем.ПостатейныеПеременныеРегл КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеРегл,
	|		ВтТаблицаКорректировкиВрем.РезервРегл КАК РезервРегл,
	|		ВтТаблицаКорректировкиВрем.СтоимостьУпр КАК СтоимостьУпр,
	|		ВтТаблицаКорректировкиВрем.ДопРасходыУпр КАК ДопРасходыУпр,
	|		ВтТаблицаКорректировкиВрем.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|		ВЫРАЗИТЬ(ВтТаблицаКорректировкиВрем.ПостатейныеПостоянныеУпр КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеУпр,
	|		ВЫРАЗИТЬ(ВтТаблицаКорректировкиВрем.ПостатейныеПеременныеУпр КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеУпр,
	|		ВтТаблицаКорректировкиВрем.РезервУпр КАК РезервУпр,
	|		ВтТаблицаКорректировкиВрем.НастройкаХозяйственнойОперации,
	|		ВтТаблицаКорректировкиВрем.ИдентификаторФинЗаписи,
	|		
	|		ВЫРАЗИТЬ(Стоимость КАК ЧИСЛО(31, 2)) 
	|			+ ВЫРАЗИТЬ(ДопРасходы КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(Трудозатраты КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ПостатейныеПостоянныеСНДС КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ПостатейныеПеременныеСНДС КАК ЧИСЛО(31, 2)) КАК СуммаСНДС,
	|		ВЫРАЗИТЬ(СтоимостьБезНДС КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ДопРасходыБезНДС КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ТрудозатратыБезНДС КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ПостатейныеПостоянныеБезНДС КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ПостатейныеПеременныеБезНДС КАК ЧИСЛО(31, 2)) КАК СуммаБезНДС,
	|		ВЫРАЗИТЬ(СтоимостьРегл КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ДопРасходыРегл КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ТрудозатратыРегл КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ПостатейныеПостоянныеРегл КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ПостатейныеПеременныеРегл КАК ЧИСЛО(31, 2)) КАК СуммаРегл,
	|		ВЫРАЗИТЬ(СтоимостьУпр КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ДопРасходыУпр КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ТрудозатратыУпр КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ПостатейныеПостоянныеУпр КАК ЧИСЛО(31, 2))  
	|			+ ВЫРАЗИТЬ(ПостатейныеПеременныеУпр КАК ЧИСЛО(31, 2)) КАК СуммаУпр,
	|		ВЫРАЗИТЬ(СтоимостьНДД КАК ЧИСЛО(31, 2)) КАК СуммаНДД
	|
	|	ИЗ
	|		ВтТаблицаКорректировкиВрем КАК ВтТаблицаКорректировкиВрем
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	//++ Локализация
	
	// Включение / исключение НДС в стоимость незавершенного производства должно выполняться аналогично 
	// функции ТекстВтНезавершенноеПроизводство - формирование временной таблицы ВтНезавершенноеПроизводство. 
	|	ВЫБРАТЬ
	|		ИСТИНА КАК ЭтоКорректировка,
	|		Корректировки.ОстаткиНЗП,
	|		ВтТаблицаКорректировкиВрем.Период КАК Период,
	|		ВтТаблицаКорректировкиВрем.ВидДвижения КАК ВидДвижения,
	|		ВтТаблицаКорректировкиВрем.ДокументДвижения КАК ДокументДвижения,
	|		ВтТаблицаКорректировкиВрем.Организация КАК Организация,
	|		ВтТаблицаКорректировкиВрем.ПартияПроизводства КАК ПартияПроизводства,
	|		ВтТаблицаКорректировкиВрем.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|		ВтТаблицаКорректировкиВрем.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|		ВтТаблицаКорректировкиВрем.Этап КАК Этап,
	|		ВтТаблицаКорректировкиВрем.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		ВтТаблицаКорректировкиВрем.АналитикаУчетаПродукции КАК АналитикаУчетаПродукции,
	|		ВтТаблицаКорректировкиВрем.АналитикаУчетаПродукции КАК АналитикаУчетаПродукцииСебестоимость,
	|		ВтТаблицаКорректировкиВрем.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
	|		ВтТаблицаКорректировкиВрем.Продукция КАК Продукция,
	|		ВтТаблицаКорректировкиВрем.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|		ВтТаблицаКорректировкиВрем.РазделУчета КАК РазделУчета,
	|		ВтТаблицаКорректировкиВрем.ВидЗапасов КАК ВидЗапасов,
	|		ВтТаблицаКорректировкиВрем.Партия КАК Партия,
	|		ВтТаблицаКорректировкиВрем.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		ВтТаблицаКорректировкиВрем.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		ВтТаблицаКорректировкиВрем.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		ВтТаблицаКорректировкиВрем.ТипЗапасов КАК ТипЗапасов,
	|		ВтТаблицаКорректировкиВрем.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|		ВтТаблицаКорректировкиВрем.Подразделение КАК Подразделение,
	|		ВтТаблицаКорректировкиВрем.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		ВтТаблицаКорректировкиВрем.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|		ВтТаблицаКорректировкиВрем.АналитикаРасходов КАК АналитикаРасходов,
	|		ВтТаблицаКорректировкиВрем.СтатьяРасходов КАК СтатьяРасходов,
	|		ВтТаблицаКорректировкиВрем.ГруппаПродукции КАК ГруппаПродукции,
	|		ВтТаблицаКорректировкиВрем.ИсходноеПодразделение КАК ИсходноеПодразделение,
	|		ВтТаблицаКорректировкиВрем.Подразделение КАК КорПодразделение,
	|		ВтТаблицаКорректировкиВрем.АналитикаПартииВыпуска КАК АналитикаПартииВыпуска,
	|		ВтТаблицаКорректировкиВрем.ДокументВыпуска КАК ДокументВыпуска,
	|		ВтТаблицаКорректировкиВрем.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|		ВтТаблицаКорректировкиВрем.БазаРаспределения КАК БазаРаспределения,
	|		0 КАК ДоляСтоимости,
	|		0 КАК Стоимость,
	|		0 КАК СтоимостьБезНДС,
	|		0 КАК ДопРасходы,
	|		0 КАК ДопРасходыБезНДС,
	// При включении/исключении НДС в стоимость для статьи, не принимаемой к налоговому учету по налогу на прибыль,
	// должна возникать постоянная разница на сумму НДС.
	|		(ВЫБОР
	|			КОГДА НЕ ЕСТЬNULL(ВтТаблицаКорректировкиВрем.СтатьяРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|				ТОГДА Корректировки.СуммаРегл
	|			ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	// При включении/исключении НДС в стоимость для статьи, не распределяемой на себестоимость производства в НУ,
	// должна возникать временная разница на сумму НДС.
	|		(ВЫБОР
	|			КОГДА НЕ ДокументРаспределения.НалоговыйУчет
	|			 И ЕСТЬNULL(ВтТаблицаКорректировкиВрем.СтатьяРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|				ТОГДА Корректировки.СуммаРегл
	|			ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|		0 КАК СтоимостьНДД,
	|		0 КАК СтоимостьРегл,
	|		0 КАК СтоимостьЗабалансовая,
	|		0 КАК Трудозатраты,
	|		0 КАК ПостатейныеПостоянныеСНДС,
	|		0 КАК ПостатейныеПостоянныеБезНДС,
	|		0 КАК ПостатейныеПеременныеСНДС,
	|		0 КАК ПостатейныеПеременныеБезНДС,
	|		0 КАК СтоимостьЗабалансоваяРегл,
	|		0 КАК ДопРасходыРегл,
	|		0 КАК ТрудозатратыРегл,
	|		0 КАК ТрудозатратыБезНДС,
	|		ВЫБОР КОГДА ВтТаблицаКорректировкиВрем.СтатьяРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
	|			ТОГДА ВЫРАЗИТЬ(Корректировки.СуммаРегл КАК Число(31,2))
	|			ИНАЧЕ 0
	|		КОНЕЦ	КАК ПостатейныеПостоянныеРегл,
	|		ВЫБОР КОГДА ВтТаблицаКорректировкиВрем.СтатьяРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
	|			ТОГДА ВЫРАЗИТЬ(Корректировки.СуммаРегл КАК Число(31,2))
	|			ИНАЧЕ 0
	|		КОНЕЦ	КАК ПостатейныеПеременныеРегл,
	|		0 КАК РезервРегл,
	|		0 КАК СтоимостьУпр,
	|		0 КАК ДопРасходыУпр,
	|		0 КАК ТрудозатратыУпр,
	|		ВЫБОР КОГДА ВтТаблицаКорректировкиВрем.СтатьяРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Постоянные)
	|			ТОГДА ВЫРАЗИТЬ(Корректировки.СуммаУпр КАК Число(31,2))
	|			ИНАЧЕ 0
	|		КОНЕЦ	КАК ПостатейныеПостоянныеУпр,
	|		ВЫБОР КОГДА ВтТаблицаКорректировкиВрем.СтатьяРасходов.ХарактерПроизводственныхЗатрат = ЗНАЧЕНИЕ(Перечисление.ХарактерПроизводственныхЗатрат.Переменные)
	|			ТОГДА ВЫРАЗИТЬ(Корректировки.СуммаУпр КАК Число(31,2))
	|			ИНАЧЕ 0
	|		КОНЕЦ	КАК ПостатейныеПеременныеУпр,
	|		0 КАК РезервУпр,
	|		ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВключениеИсключениеНДСВСтоимости),
	|		ВтТаблицаКорректировкиВрем.ИдентификаторФинЗаписи,
	|  	
	|		0 КАК СуммаСНДС,
	|		0 КАК СуммаБезНДС,
	|		ВЫБОР КОГДА Корректировки.ОстаткиНЗП ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Корректировки.СуммаРегл КАК СуммаРегл,
	|		ВЫБОР КОГДА Корректировки.ОстаткиНЗП ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Корректировки.СуммаУпр КАК СуммаУпр,
	|		ВЫБОР КОГДА Корректировки.ОстаткиНЗП ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * Корректировки.СуммаНДД КАК СуммаНДД
	|
	|	ИЗ
	|		ВтТаблицаКорректировкиВрем КАК ВтТаблицаКорректировкиВрем
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтНезавершенноеПроизводствоВключениеИсключениеНДС КАК Корректировки
	|			ПО ВтТаблицаКорректировкиВрем.Организация = Корректировки.Организация
	|			И ВтТаблицаКорректировкиВрем.СтатьяРасходов = Корректировки.СтатьяРасходов
	|			И ВтТаблицаКорректировкиВрем.АналитикаРасходов = Корректировки.АналитикаРасходов
	|			И ВтТаблицаКорректировкиВрем.ПартияПроизводства = Корректировки.Партия
	|			И ВтТаблицаКорректировкиВрем.КорНаправлениеДеятельности = Корректировки.НаправлениеДеятельности
	|			И ВтТаблицаКорректировкиВрем.Подразделение = Корректировки.Подразделение
	|			И ВтТаблицаКорректировкиВрем.СтатьяКалькуляции = Корректировки.СтатьяКалькуляции
	|			И ВтТаблицаКорректировкиВрем.ГруппаПродукции = Корректировки.ГруппаПродукции
	|			И ВтТаблицаКорректировкиВрем.КодСтрокиПродукция = Корректировки.КодСтрокиПродукция
	|			И ВтТаблицаКорректировкиВрем.ПравилоОтнесенияНаВыпуск = Корректировки.ПравилоОтнесенияНаВыпуск
	|			И ВтТаблицаКорректировкиВрем.ДокументДвижения = Корректировки.Регистратор
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДокументРаспределения
	|			ПО ДокументРаспределения.Ссылка = ВтТаблицаКорректировкиВрем.ДокументДвижения
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	//-- Локализация
	|	ВЫБРАТЬ
	|		ЛОЖЬ КАК ЭтоКорректировка,
	|		ЛОЖЬ КАК ОстаткиНЗП,
	|		Т.Период КАК Период,
	|		Т.ВидДвижения КАК ВидДвижения,
	|		Т.ДокументДвижения КАК ДокументДвижения,
	|		Т.Организация КАК Организация,
	|		Т.ПартияПроизводства КАК ПартияПроизводства,
	|		Т.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|		Т.КодСтрокиПродукция КАК КодСтрокиПродукция,
	|		Т.Этап КАК Этап,
	|		Т.СтатьяКалькуляции КАК СтатьяКалькуляции,
	|		Т.АналитикаУчетаПродукцииСебестоимость КАК АналитикаУчетаПродукции,
	|		Т.АналитикаУчетаПродукцииСебестоимость КАК АналитикаУчетаПродукцииСебестоимость,
	|		Т.КорАналитикаУчетаПартий КАК КорАналитикаУчетаПартий,
	|		Т.Продукция КАК Продукция,
	|		Т.ХарактеристикаПродукции КАК ХарактеристикаПродукции,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.Партия КАК Партия,
	|		Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		Т.АналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
	|		Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|		Т.ТипЗапасов КАК ТипЗапасов,
	|		Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|		Т.Подразделение КАК Подразделение,
	|		Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|		Т.АналитикаРасходов КАК АналитикаРасходов,
	|		Т.СтатьяРасходов КАК СтатьяРасходов,
	|		Т.ГруппаПродукции КАК ГруппаПродукции,
	|		Т.ИсходноеПодразделение КАК ИсходноеПодразделение,
	|		Т.Подразделение КАК КорПодразделение,
	|		Т.АналитикаПартииВыпуска КАК АналитикаПартииВыпуска,
	|		Т.ДокументВыпуска КАК ДокументВыпуска,
	|		Т.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
	|		Т.БазаРаспределения КАК БазаРаспределения,
	|		Т.ДоляСтоимости КАК ДоляСтоимости,
	|		0 КАК Стоимость,
	|		0 КАК СтоимостьБезНДС,
	|		0 КАК ДопРасходы,
	|		0 КАК ДопРасходыБезНДС,
	|		0 КАК ПостояннаяРазница,
	|		0 КАК ВременнаяРазница,
	|		0 КАК СтоимостьНДД,
	|		0 КАК СтоимостьРегл,
	|		0 КАК СтоимостьЗабалансовая,
	|		0 КАК Трудозатраты,
	|		Т.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|		Т.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|		Т.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|		Т.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|		0 КАК СтоимостьЗабалансоваяРегл,
	|		0 КАК ДопРасходыРегл,
	|		0 КАК ТрудозатратыРегл,
	|		0 КАК ТрудозатратыБезНДС,
	|		Т.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|		Т.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|		0 КАК РезервРегл,
	|		0 КАК СтоимостьУпр,
	|		0 КАК ДопРасходыУпр,
	|		0 КАК ТрудозатратыУпр,
	|		Т.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|		Т.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|		0 КАК РезервУпр,
	|		Т.НастройкаХозяйственнойОперации,
	|		Т.ИдентификаторФинЗаписи,
	|	
	|		ПостатейныеПостоянныеСНДС + ПостатейныеПеременныеСНДС КАК СуммаСНДС,
	|		ПостатейныеПостоянныеБезНДС + ПостатейныеПеременныеБезНДС КАК СуммаБезНДС,
	|		ПостатейныеПостоянныеРегл + ПостатейныеПеременныеРегл КАК СуммаРегл,
	|		ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр КАК СуммаУпр,
	|		0 КАК СуммаНДД
	|	ИЗ
	|		ВТРезультатРаспределения КАК Т) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ЭтоКорректировка,
	|	Т.ОстаткиНЗП,
	|	Т.Период,
	|	Т.ВидДвижения,
	|	Т.ДокументДвижения,
	|	Т.Организация,
	|	Т.ПартияПроизводства,
	|	Т.ЗаказНаПроизводство,
	|	Т.КодСтрокиПродукция,
	|	ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА Т.ВидЗапасов
	|		ИНАЧЕ 
	|			Т.Продукция
	|	КОНЕЦ,
	|	Т.Этап,
	|	Т.СтатьяКалькуляции,
	|	Т.АналитикаУчетаПродукции,
	|	Т.АналитикаУчетаПродукцииСебестоимость,
	|	Т.КорАналитикаУчетаПартий,
	|	Т.Продукция,
	|	Т.ХарактеристикаПродукции,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ТипЗапасов,
	|	Т.ХозяйственнаяОперация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяРасходов,
	|	Т.ГруппаПродукции,
	|	Т.ИсходноеПодразделение,
	|	Т.КорПодразделение,
	|	Т.АналитикаПартииВыпуска,
	|	Т.ДокументВыпуска,
	|	Т.ПравилоОтнесенияНаВыпуск,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи	
	|";
	#КонецОбласти
	
	Запрос.Текст = УстановитьРазрядностьЧиселВТекстеЗапроса(ПараметрыРасчета, Запрос.Текст);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВтТаблицаКорректировкиБезИдентификаторов, ИдентификаторыПоПолямТаблицыКорректировки, ВтТаблицаКорректировкиВрем");
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	// Формируются движения по регистрам:
	// - ПрочиеРасходы
	// - ПрочиеРасходыНезавершенногоПроизводства
	// - СебестоимостьТоваров
		
	СформироватьДвиженияПрочиеРасходыНезавершенногоПроизводстваЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	СформироватьДвиженияСебестоимостьТоваровСписаниеНЗПЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	СформироватьДвиженияНоменклатураНоменклатураСписаниеНЗПЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходов Тогда
		СформироватьДвиженияПрочиеРасходыСписаниеНЗПЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	КонецЕсли;
		
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	МассивЛокальныхВременныхТаблиц = Новый Массив;
	МассивЛокальныхВременныхТаблиц.Добавить("ДвиженияТаблицаКорректировки");
	МассивЛокальныхВременныхТаблиц.Добавить("ТаблицаИдентификаторов");
	МассивЛокальныхВременныхТаблиц.Добавить("ПриемникиПогрешностей");
	МассивЛокальныхВременныхТаблиц.Добавить("ПогрешностиОкругления");
	Для Каждого КлючЗначение Из СоответствиеВременныхТаблицДвижений Цикл
		МассивЛокальныхВременныхТаблиц.Добавить(КлючЗначение.Ключ);
	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВтТаблицаКорректировки, Выпуски,
		|" + СтрСоединить(МассивЛокальныхВременныхТаблиц, ","));
	
КонецПроцедуры

// Этап 3.15б
Процедура СкорректироватьСтоимостьСписанияРезервовПредстоящихРасходов(ПараметрыРасчета)
	
	Если ПараметрыРасчета.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьСписанияРезервовПредстоящихРасходов");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	&КонецПериода КАК Период,
		|	ДокументыДвиженияРезервов.ДокументДвижения КАК Регистратор,
		|	Движение.Организация,
		|	Движение.НаправлениеДеятельности,
		|	Движение.ВидРезервов,
		|	Движение.ОбъектУчетаРезервов,
		|	Движение.СтатьяРасходов,
		|	Движение.АналитикаРасходов,
		|	Движение.Подразделение,
		|	Движение.СуммаРегл КАК СуммаРегл,
		//++ Локализация
		|	Движение.СуммаНУ +
		//-- Локализация
		|	0 КАК СуммаНУ,
		//++ Локализация
		|	Движение.ПостояннаяРазница +
		//-- Локализация
		|	0 КАК ПостояннаяРазница,
		//++ Локализация
		|	Движение.СуммаРегл - Движение.СуммаНУ - Движение.ПостояннаяРазница +
		//-- Локализация
		|	0 КАК ВременнаяРазница,
		|	Движение.СуммаУпр КАК СуммаУпр,	
		|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовЗаСчетРезервов) КАК ХозяйственнаяОперация,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеРасходовЗаСчетРезервов) КАК НастройкаХозяйственнойОперации,
		|	Движение.ВидРезервов КАК КорВидРезервов,
		|	Движение.ОбъектУчетаРезервов КАК КорОбъектУчетаРезервов
		|
		|ПОМЕСТИТЬ ВтДвиженияСписаниеРасходов
		|ИЗ
		|	РезервыПредстоящихРасходов КАК Движение
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыДвиженияРезервов КАК ДокументыДвиженияРезервов
		|		ПО Движение.Организация = ДокументыДвиженияРезервов.Организация
		|			И Движение.ВидРезервов = ДокументыДвиженияРезервов.ВидРезервов";
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОбщегоНазначенияУТ.ДобавитьИдентификаторыВоВременнуюТаблицу("ВтДвиженияСписаниеРасходов", ПараметрыРасчета.МенеджерВременныхТаблиц, "ИдентификаторФинЗаписи");
	
	#Область СписаниеРасходовЗаСчетРезервов_ПрочиеРасходы
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицы = "ВтПрочиеРасходыСписаниеЗаСчетРезервов";
	ИмяВременнойТаблицыИсточник = "ВтДвиженияСписаниеРасходов";
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ЛОЖЬ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	#КонецОбласти
	
	#Область СписаниеРасходовЗаСчетРезервов_РезервыПредстоящихРасходов
	
	ИмяРегистра = Метаданные.РегистрыНакопления.РезервыПредстоящихРасходов.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицы = "ВтРезервыПредстоящихРасходовСписаниеЗаСчетРезервов";
	ИмяВременнойТаблицыИсточник = "ВтДвиженияСписаниеРасходов";
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

// Этап 3.16
Процедура СкорректироватьСтоимостьПрочегоСписанияНезавершенногоПроизводства(ПараметрыРасчета) Экспорт
	
	Если ПараметрыРасчета.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьПрочегоСписанияНезавершенногоПроизводства");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Операция.Дата КАК Период,
	|	Операция.Ссылка КАК Регистратор,
	|	Операция.Организация КАК Организация,
	|	Операция.Подразделение КАК Подразделение,
	|	Операция.Подразделение КАК КорПодразделение,
	|	Операция.СтатьяРасходов КАК СтатьяРасходов,
	|	Операция.АналитикаРасходов КАК АналитикаРасходов,
	|	Операция.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Строки.НаправлениеДеятельности КАК НаправлениеДеятельностиПолучатель,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Строки.СтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|			ТОГДА Строки.СтатьяРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СтатьяРасходовПолучатель,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Строки.СтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|			ТОГДА Строки.АналитикаРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК АналитикаРасходовПолучатель,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Строки.СтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиАктивовПассивов)
	|			ТОГДА Строки.СтатьяРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СтатьяАктивовПассивов,
	|	ВЫБОР
	|		КОГДА ТИПЗНАЧЕНИЯ(Строки.СтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиАктивовПассивов)
	|			ТОГДА Строки.АналитикаРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК АналитикаАктивовПассивов,
	|	Строки.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПрочихРасходов) КАК ХозяйственнаяОперация,
	|	СУММА(Строки.ДоляСтоимости) КАК Количество,
	|	СУММА(Строки.ДоляСтоимости) КАК КоличествоБезНДС,
	|	СУММА(Строки.ДоляСтоимости) КАК КоличествоРегл,
	|	СУММА(Строки.ДоляСтоимости) КАК КоличествоНУ,
	|	СУММА(Строки.ДоляСтоимости) КАК КоличествоНДД,
	|	СУММА(Строки.ДоляСтоимости) КАК КоличествоУпр
	|ПОМЕСТИТЬ ВтТаблицаКорректировки
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК Операция
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат.Списание КАК Строки
	|		ПО Строки.Ссылка = Операция.Ссылка
	|ГДЕ
	|	Операция.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Операция.Организация В(&МассивОрганизаций)
	|	И Операция.Проведен
	|	И НЕ &ПартионныйУчетВерсии22
	|	
	|СГРУППИРОВАТЬ ПО
	|	Операция.Дата,
	|	Операция.Ссылка,
	|	Операция.Организация,
	|	Операция.Подразделение,
	|	Операция.СтатьяРасходов,
	|	Операция.АналитикаРасходов,
	|	Операция.НаправлениеДеятельности,
	|	Строки.НаправлениеДеятельности,
	|	Строки.СтатьяРасходов,
	|	Строки.АналитикаРасходов,
	|	Строки.ИдентификаторСтроки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.КорПодразделение КАК КорПодразделение,
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельностиПолучатель,
	|	ДД.КорСтатьяРасходов КАК СтатьяРасходовПолучатель,
	|	ДД.КорАналитикаРасходов КАК АналитикаРасходовПолучатель,
	|	ДД.КорСтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	ДД.КорАналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	ДД.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ДД.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	СУММА(ДД.ДоляСтоимости) КАК Количество,
	|	СУММА(ДД.ДоляСтоимостиБезНДС) КАК КоличествоБезНДС,
	|	СУММА(ДД.ДоляСтоимостиРегл) КАК КоличествоРегл,
	|	СУММА(ДД.ДоляСтоимостиНУ) КАК КоличествоНУ,
	|	СУММА(ДД.ДоляСтоимостиНДД) КАК КоличествоНДД,
	|	СУММА(ДД.ДоляСтоимостиУпр) КАК КоличествоУпр
	|ИЗ
	|	ДолиПроизводственныхРасходов КАК ДД
	|ГДЕ
	|	ДД.Организация В(&МассивОрганизаций)
	|	И &ПартионныйУчетВерсии22
	|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПрочихРасходов)
	|	И НЕ (ДД.ДоляСтоимости = 0
	|		И ДД.ДоляСтоимостиБезНДС = 0
	|		И ДД.ДоляСтоимостиРегл = 0
	|		И ДД.ДоляСтоимостиНУ = 0
	|		И ДД.ДоляСтоимостиНДД = 0
	|		И ДД.ДоляСтоимостиУпр = 0)
	|	
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорПодразделение,
	|	ДД.СтатьяРасходов,
	|	ДД.КорСтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.КорАналитикаРасходов,
	|	ДД.КорСтатьяАктивовПассивов,
	|	ДД.КорАналитикаАктивовПассивов,
	|	ДД.НаправлениеДеятельности,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.ИдентификаторСтроки,
	|	ДД.ХозяйственнаяОперация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.КорПодразделение КАК КорПодразделение,
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельностиПолучатель,
	|	ДД.КорСтатьяРасходов КАК СтатьяРасходовПолучатель,
	|	ДД.КорАналитикаРасходов КАК АналитикаРасходовПолучатель,
	|	ДД.КорСтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	ДД.КорАналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	ДД.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	ДД.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	СУММА(ДД.ДоляСтоимости) КАК Количество,
	|	СУММА(ДД.ДоляСтоимостиБезНДС) КАК КоличествоБезНДС,
	|	СУММА(ДД.ДоляСтоимостиРегл) КАК КоличествоРегл,
	|	СУММА(ДД.ДоляСтоимостиНУ) КАК КоличествоНУ,
	|	СУММА(ДД.ДоляСтоимостиНДД) КАК КоличествоНДД,
	|	СУММА(ДД.ДоляСтоимостиУпр) КАК КоличествоУпр
	|ИЗ
	|	ПрямыеПроизводственныеРасходы КАК ДД
	|ГДЕ
	|	ДД.Организация В(&МассивОрганизаций)
	|	И &ПартионныйУчетВерсии22
	|	И ДД.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПрочихРасходов)
	|	И НЕ (ДД.ДоляСтоимости = 0
	|		И ДД.ДоляСтоимостиБезНДС = 0
	|		И ДД.ДоляСтоимостиРегл = 0
	|		И ДД.ДоляСтоимостиНУ = 0
	|		И ДД.ДоляСтоимостиНДД = 0
	|		И ДД.ДоляСтоимостиУпр = 0)
	|	
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорПодразделение,
	|	ДД.СтатьяРасходов,
	|	ДД.КорСтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.КорАналитикаРасходов,
	|	ДД.КорСтатьяАктивовПассивов,
	|	ДД.КорАналитикаАктивовПассивов,
	|	ДД.НаправлениеДеятельности,
	|	ДД.КорНаправлениеДеятельности,
	|	ДД.ИдентификаторСтроки,
	|	ДД.ХозяйственнаяОперация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Операция.Дата КАК Период,
	|	ДД.ДокументДвижения КАК Регистратор,
	|	ДД.Организация КАК Организация,
	|	ДД.Подразделение КАК Подразделение,
	|	ДД.КорПодразделение КАК КорПодразделение,
	|	ДД.СтатьяРасходов КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.НаправлениеДеятельности КАК НаправлениеДеятельностиПолучатель,
	|	ДД.СтатьяРасходов КАК СтатьяРасходовПолучатель,
	|	ДД.КорАналитикаРасходов КАК АналитикаРасходовПолучатель,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ТранзитРасходовМеждуОВЗ) КАК ХозяйственнаяОперация,
	|	СУММА(ВЫБОР 
	|			КОГДА Операция.ДоляСтоимостиНаОВЗ = 0 ТОГДА 0 
	|			ИНАЧЕ ДД.ПриведенныйВес
	|			КОНЕЦ) КАК Количество,
	|	СУММА(ВЫБОР 
	|			КОГДА Операция.ДоляСтоимостиНаОВЗ = 0 ТОГДА 0 
	|			ИНАЧЕ ДД.ПриведенныйВес
	|			КОНЕЦ) КАК КоличествоБезНДС,
	|	СУММА(ВЫБОР 
	|			КОГДА Операция.ДоляСтоимостиНаОВЗ = 0 ТОГДА 0 
	|			ИНАЧЕ ДД.ПриведенныйВесРегл
	|			КОНЕЦ) КАК КоличествоРегл,
	|	СУММА(ВЫБОР 
	|			КОГДА Операция.ДоляСтоимостиНаОВЗ = 0 ТОГДА 0 
	|			ИНАЧЕ ДД.ПриведенныйВесРегл
	|			КОНЕЦ) КАК КоличествоНУ,
	|	СУММА(ВЫБОР 
	|			КОГДА Операция.ДоляСтоимостиНаОВЗ = 0 ТОГДА 0 
	|			ИНАЧЕ ДД.ПриведенныйВесРегл
	|			КОНЕЦ) КАК КоличествоНДД,
	|	СУММА(ВЫБОР 
	|			КОГДА Операция.ДоляСтоимостиНаОВЗ = 0 ТОГДА 0 
	|			ИНАЧЕ ДД.ПриведенныйВес
	|			КОНЕЦ) КАК КоличествоУпр
	|ИЗ
	|	ВтТранзитРасходовМеждуОВЗ КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтДолиРаспределенияПрочихЗатрат КАК Операция
	|		ПО
	|			Операция.Документ = ДД.ДокументДвижения
	|
	|ГДЕ
	|	ДД.Организация В(&МассивОрганизаций)
	|	И НЕ (ДД.ПриведенныйВес = 0 И ДД.ПриведенныйВесРегл = 0)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Операция.Дата,
	|	ДД.ДокументДвижения,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорПодразделение,
	|	ДД.СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	|	ДД.НаправлениеДеятельности,
	|	ДД.КорАналитикаРасходов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Операция.Дата КАК Период,
	|	Операция.Ссылка КАК Регистратор,
	|	Операция.Организация КАК Организация,
	|	Операция.Подразделение КАК Подразделение,
	|	СтатьиСписания.Подразделение КАК КорПодразделение,
	|	УзлыТранзита.СтатьяРасходов КАК СтатьяРасходов,
	|	Операция.АналитикаРасходов КАК АналитикаРасходов,
	|	УзлыТранзита.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	СтатьиСписания.НаправлениеДеятельности КАК НаправлениеДеятельностиПолучатель,
	|	СтатьиСписания.СтатьяРасходов КАК СтатьяРасходовПолучатель,
	|	СтатьиСписания.АналитикаРасходов КАК АналитикаРасходовПолучатель,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК ИдентификаторСтроки,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПрочихРасходов) КАК ХозяйственнаяОперация,
	|	СУММА(ВЫБОР КОГДА Операция.УправленческийУчет ТОГДА СтатьиСписания.ДоляСтоимости*УзлыТранзита.Вес ИНАЧЕ 0 КОНЕЦ) КАК Количество,
	|	СУММА(ВЫБОР КОГДА Операция.УправленческийУчет ТОГДА СтатьиСписания.ДоляСтоимости*УзлыТранзита.Вес ИНАЧЕ 0 КОНЕЦ) КАК КоличествоБезНДС,
	|	СУММА(ВЫБОР КОГДА Операция.РегламентированныйУчет ТОГДА СтатьиСписания.ДоляСтоимости*УзлыТранзита.ВесРегл ИНАЧЕ 0 КОНЕЦ) КАК КоличествоРегл,
	|	СУММА(ВЫБОР КОГДА Операция.НалоговыйУчет ТОГДА СтатьиСписания.ДоляСтоимости*УзлыТранзита.ВесРегл ИНАЧЕ 0 КОНЕЦ) КАК КоличествоНУ,
	|	СУММА(ВЫБОР КОГДА Операция.НДД ТОГДА СтатьиСписания.ДоляСтоимости*УзлыТранзита.ВесРегл ИНАЧЕ 0 КОНЕЦ) КАК КоличествоНДД,
	|	СУММА(ВЫБОР КОГДА Операция.УправленческийУчет ТОГДА СтатьиСписания.ДоляСтоимости*УзлыТранзита.Вес ИНАЧЕ 0 КОНЕЦ) КАК КоличествоУпр
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат.Списание КАК СтатьиСписания
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтДолиРаспределенияПрочихЗатрат КАК Операция
	|		ПО
	|			СтатьиСписания.Ссылка = Операция.Документ
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ВтИсходныеДанныеУзловТранзитаРасходовМеждуОВЗ КАК УзлыТранзита
	|		ПО
	|			УзлыТранзита.Организация = Операция.Организация
	|			И УзлыТранзита.Подразделение = Операция.Подразделение
	|			И УзлыТранзита.АналитикаРасходов = Операция.АналитикаРасходов
	|
	|ГДЕ
	|	Операция.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И Операция.РаспределятьНаСтатьи
	|	
	|СГРУППИРОВАТЬ ПО
	|	Операция.Дата,
	|	Операция.Ссылка,
	|	Операция.Организация,
	|	Операция.Подразделение,
	|	СтатьиСписания.Подразделение,
	|	УзлыТранзита.СтатьяРасходов,
	|	СтатьиСписания.СтатьяРасходов,
	|	Операция.АналитикаРасходов,
	|	УзлыТранзита.НаправлениеДеятельности,
	|	СтатьиСписания.НаправлениеДеятельности,
	|	СтатьиСписания.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеПрочихРасходов)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|";

	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	СопоставлениеКолонок = Новый Структура;
	СопоставлениеКолонок.Вставить(
		Метаданные.РегистрыНакопления.ПрочиеРасходы.Реквизиты.КорАналитикаРасходов.Имя,
		"АналитикаРасходовПолучатель");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя],
		"ВтТаблицаКорректировки",
		"Организация, Подразделение, СтатьяРасходов, АналитикаРасходов",
		СопоставлениеКолонок);
	
	Запрос.Текст =
	"ВЫБРАТЬ 
	|	Статьи.Ссылка
	|ПОМЕСТИТЬ ВтСтатьиИсключенияДляСтоимостиБезНДС
	|ИЗ
	|	ПланВидовХарактеристик.СтатьиРасходов КАК Статьи
	|ГДЕ
	|	Статьи.ВариантРаспределенияРасходовУпр В (
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы),
	|		ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы))
	|;
	|ВЫБРАТЬ
	|	ТаблицаКорректировки.Период,
	|	ТаблицаКорректировки.Регистратор КАК ДокументДвижения,
	|	ТаблицаКорректировки.Организация,
	|	ТаблицаКорректировки.Подразделение,
	|	ТаблицаКорректировки.КорПодразделение,
	|	ТаблицаКорректировки.СтатьяРасходов,
	|	ТаблицаКорректировки.АналитикаРасходов,
	|	ТаблицаКорректировки.НаправлениеДеятельности,
	|	ТаблицаКорректировки.НаправлениеДеятельностиПолучатель КАК КорНаправлениеДеятельности,
	|	ТаблицаКорректировки.СтатьяРасходовПолучатель,
	|	ТаблицаКорректировки.АналитикаРасходовПолучатель,
	|	ТаблицаКорректировки.СтатьяАктивовПассивов,
	|	ТаблицаКорректировки.АналитикаАктивовПассивов,
	|	ТаблицаКорректировки.ИдентификаторСтроки,
	|	ТаблицаКорректировки.ХозяйственнаяОперация,
	|	НастройкиХозОпераций.Ссылка КАК НастройкаХозяйственнойОперации,
	|	ТаблицаКорректировки.ИдентификаторФинЗаписи,
	|	НЕ СтатьиИсключения.Ссылка ЕСТЬ NULL КАК ИсключитьСтоимостьБезНДС,
	// При транзите расходов между ОВЗ не учитывается признак ПринятиеКНалоговомуУчету статьи расходов,
	// т.к. при этой операции не происходит изменение статьи расходов, меняются только ОВЗ. 
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ТранзитРасходовМеждуОВЗ)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЕСТЬNULL(КорСтатьяРасходов.ПринятиеКНалоговомуУчету, ИСТИНА) КОНЕЦ) КАК ПринятиеКНУПриСписании,
	|	ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоРегл КАК ЧИСЛО(31,2)) КАК БазаРаспределения,
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.Количество
	|			* (ЕСТЬNULL(Стоимости.Стоимость, 0)
	|				+ ЕСТЬNULL(Стоимости.ПостатейныеПостоянныеСНДС, 0)
	|				+ ЕСТЬNULL(Стоимости.ПостатейныеПеременныеСНДС, 0)
	|				+ ЕСТЬNULL(Стоимости.Трудозатраты, 0)) КАК ЧИСЛО(31,2)) КАК Стоимость,
	|
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.КоличествоБезНДС
	|			* (ЕСТЬNULL(Стоимости.СтоимостьБезНДС, 0)
	|				+ ЕСТЬNULL(Стоимости.ПостатейныеПостоянныеБезНДС, 0)
	|				+ ЕСТЬNULL(Стоимости.ПостатейныеПеременныеБезНДС, 0)
	|				+ ЕСТЬNULL(Стоимости.ТрудозатратыБезНДС, 0)) КАК ЧИСЛО(31,2)) КАК СтоимостьБезНДС,
	|
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.Количество
	|			* ЕСТЬNULL(Стоимости.СтоимостьДопРасходы, 0) КАК ЧИСЛО(31,2)) КАК ДопРасходы,
	|
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.КоличествоБезНДС
	|			* ЕСТЬNULL(Стоимости.СтоимостьДопРасходыБезНДС, 0) КАК ЧИСЛО(31,2)) КАК ДопРасходыБезНДС,
	|
	//++ Локализация
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.КоличествоРегл
	|			* ЕСТЬNULL(СтоимостиРегл.ПостояннаяРазница, 0) КАК ЧИСЛО(31,2)) +
	//-- Локализация
	|	0 КАК ПостояннаяРазница,
	|
	//++ Локализация
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.КоличествоРегл
	|			* (ЕСТЬNULL(СтоимостиРегл.СтоимостьРегл, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ДопРасходыРегл, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеРегл, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеРегл, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ТрудозатратыРегл, 0)) КАК ЧИСЛО(31,2))
	|	- ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.КоличествоРегл
	|			* ЕСТЬNULL(СтоимостиРегл.ПостояннаяРазница, 0) КАК ЧИСЛО(31,2))
	|	- ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.КоличествоНУ
	|			* ЕСТЬNULL(СтоимостиРегл.СтоимостьНУ, 0) КАК ЧИСЛО(31,2)) +
	//-- Локализация
	|	0 КАК ВременнаяРазница,
	|
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.КоличествоРегл
	|			* (ЕСТЬNULL(СтоимостиРегл.СтоимостьРегл, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ДопРасходыРегл, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеРегл, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеРегл, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ТрудозатратыРегл, 0)) КАК ЧИСЛО(31,2)) КАК СтоимостьРегл,
	|
	|	ВЫРАЗИТЬ(ТаблицаКорректировки.КоличествоНДД
	|			* ЕСТЬNULL(СтоимостиРегл.СтоимостьНДД, 0) КАК ЧИСЛО(31,2)) КАК СтоимостьНДД,
	|
	|	ВЫРАЗИТЬ(
	|		ТаблицаКорректировки.КоличествоУпр
	|			* (ЕСТЬNULL(СтоимостиРегл.СтоимостьУпр, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ДопРасходыУпр, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеУпр, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеУпр, 0)
	|				+ ЕСТЬNULL(СтоимостиРегл.ТрудозатратыУпр, 0)) КАК ЧИСЛО(31,2)) КАК СтоимостьУпр
	|ИЗ
	|	ВтТаблицаКорректировки КАК ТаблицаКорректировки
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК КорСтатьяРасходов
	|	ПО КорСтатьяРасходов.Ссылка = ТаблицаКорректировки.СтатьяРасходовПолучатель
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтСтатьиИсключенияДляСтоимостиБезНДС КАК СтатьиИсключения
	|	ПО СтатьиИсключения.Ссылка = ТаблицаКорректировки.СтатьяРасходовПолучатель
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиХозяйственныхОпераций КАК НастройкиХозОпераций
	|	ПО НастройкиХозОпераций.ХозяйственнаяОперация = ТаблицаКорректировки.ХозяйственнаяОперация
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтСтоимостиНезавершенногоПроизводства КАК Стоимости
	|	ПО 
	|		ТаблицаКорректировки.Организация = Стоимости.Организация
	|		И ТаблицаКорректировки.Подразделение = Стоимости.Подразделение
	|		И ТаблицаКорректировки.НаправлениеДеятельности = Стоимости.НаправлениеДеятельности
	|		И ТаблицаКорректировки.СтатьяРасходов = Стоимости.СтатьяРасходов
	|		И ТаблицаКорректировки.АналитикаРасходов = Стоимости.АналитикаРасходов
	|		И Стоимости.Партия = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВтСтоимостиНезавершенногоПроизводстваРегл КАК СтоимостиРегл
	|	ПО 
	|		ТаблицаКорректировки.Организация = СтоимостиРегл.Организация
	|		И ТаблицаКорректировки.Подразделение = СтоимостиРегл.Подразделение
	|		И ТаблицаКорректировки.НаправлениеДеятельности = СтоимостиРегл.НаправлениеДеятельности
	|		И ТаблицаКорректировки.СтатьяРасходов = СтоимостиРегл.СтатьяРасходов
	|		И ТаблицаКорректировки.АналитикаРасходов = СтоимостиРегл.АналитикаРасходов
	|		И СтоимостиРегл.Партия = ЗНАЧЕНИЕ(Справочник.ПартииПроизводства.ПустаяСсылка)
	|ГДЕ
	|	НЕ (ТаблицаКорректировки.Количество = 0
	|		И ТаблицаКорректировки.КоличествоБезНДС = 0
	|		И ТаблицаКорректировки.КоличествоРегл = 0
	|		И ТаблицаКорректировки.КоличествоНУ = 0
	|		И ТаблицаКорректировки.КоличествоНДД = 0
	|		И ТаблицаКорректировки.КоличествоУпр = 0)
	|
	|УПОРЯДОЧИТЬ ПО
	|	ТаблицаКорректировки.Организация,
	|	ТаблицаКорректировки.СтатьяРасходов,
	|	ТаблицаКорректировки.АналитикаРасходов,
	|	ТаблицаКорректировки.Подразделение,
	|	ТаблицаКорректировки.СтатьяРасходовПолучатель,
	|	ТаблицаКорректировки.АналитикаРасходовПолучатель,
	|	ТаблицаКорректировки.Период,
	|	ТаблицаКорректировки.Регистратор,
	|	ТаблицаКорректировки.ИдентификаторСтроки
	|";
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	// Формируются движения по регистрам:
	// - ПрочиеРасходы
	Пока Выборка.Следующий() Цикл
		
		СформироватьДвиженияПрочиеРасходыПрочееСписаниеНЗП(ПараметрыРасчета, Выборка);
		СформироватьДвиженияДоходыРасходыПрочиеАктивыПассивыПрочееСписаниеНЗП(ПараметрыРасчета, Выборка);
		
	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ВтТаблицаКорректировки, ВтСтатьиИсключенияДляСтоимостиБезНДС");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

//-- НЕ УТ

Процедура СкорректироватьСтоимостьДополнительныхРасходов(ПараметрыРасчета, Первичные) Экспорт
	
	Если ПараметрыРасчета.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие
	 И НЕ ПараметрыРасчета.РаспределениеДопРасходовМеждуПартиямиИТоварами Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьДополнительныхРасходов");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	#Область ВтТаблицаКорректировкиВрем
	
	Если Первичные Тогда
		//@skip-check bsl-ql-hub
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	АВТОНОМЕРЗАПИСИ() КАК НомерЗаписи,
			|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
			|	Движения.Регистратор КАК Регистратор,
			|	Движения.ПериодПоступления КАК ПериодПоступления,
			|	Реквизиты.Дата КАК Период,
			|	Реквизиты.Организация КАК Организация,
			|	Реквизиты.Подразделение КАК Подразделение,
			|	Реквизиты.НаправлениеДеятельности КАК НаправлениеДеятельности,
			|	Реквизиты.СтатьяРасходов КАК СтатьяРасходов,
			|	Реквизиты.СтатьяРасходов.ПринятиеКНалоговомуУчету КАК ПринятиеКНалоговомуУчету,
			|	Реквизиты.АналитикаРасходов КАК АналитикаРасходов,
			|	Движения.КорОрганизация КАК КорОрганизация,
			|	Движения.КорРазделУчета КАК РазделУчета,
			|	Движения.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
			|	Движения.КорВидЗапасов КАК ВидЗапасов,
			|	Движения.КорПартия КАК Партия,
			|	Движения.КорАналитикаУчетаПартий КАК АналитикаУчетаПартий,
			|	Движения.КорАналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
			|	Движения.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
			|	Движения.КорСтатьяРасходов КАК КорСтатьяРасходов,
			|	Движения.КорАналитикаРасходов КАК КорАналитикаРасходов,
			|	Движения.КорСтатьяАктивовПассивов КАК КорСтатьяАктивовПассивов,
			|	Движения.КорАналитикаАктивовПассивов КАК КорАналитикаАктивовПассивов,
			|	Движения.КорНастройкаСчетовУчета КАК КорНастройкаСчетовУчета,
			|	Движения.КорПодразделение КАК КорПодразделение,
			|	Движения.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
			|	Движения.ХозяйственнаяОперация,
			|	Движения.ТипЗаписи,
			|	Движения.ИсточникГФУНоменклатуры,
			|	Движения.АналитикаУчетаПоПартнерам,
			|	Движения.ЗаказКлиента,
			|	Движения.Менеджер,
			|	Движения.Склад,
			|	Движения.Соглашение,
			|	Движения.Договор,
			|	Движения.ТипЗапасов,
			|	Движения.НаправлениеДеятельностиКонтрагента,
			|	Движения.ИсточникГФУРасчетов,
			|	Движения.ВидДеятельностиНДСПартии,
			|	Движения.ВидДеятельностиНДСВыбытия,
			|	(ВЫБОР
			|		КОГДА Реквизиты.УправленческийУчет
			|			ТОГДА ВЫРАЗИТЬ(Движения.ДоляСтоимости * ЕСТЬNULL(Стоимости.СтоимостьСНДС, 0) КАК ЧИСЛО(31, 2))
			|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходы,
			|	(ВЫБОР
			|		КОГДА Реквизиты.УправленческийУчет
			|			ТОГДА ВЫРАЗИТЬ(Движения.ДоляСтоимостиБезНДС * ЕСТЬNULL(Стоимости.СтоимостьБезНДС, 0) КАК ЧИСЛО(31, 2))
			|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
			|	(ВЫБОР
			|		КОГДА Реквизиты.РегламентированныйУчет
			|			ТОГДА ВЫРАЗИТЬ(Движения.ДоляСтоимостиРегл * ЕСТЬNULL(Стоимости.СтоимостьРегл, 0) КАК ЧИСЛО(31, 2))
			|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
			|	(ВЫБОР
			|		КОГДА Реквизиты.УправленческийУчет
			|			ТОГДА ВЫРАЗИТЬ(Движения.ДоляСтоимостиУпр * ЕСТЬNULL(Стоимости.СтоимостьУпр, 0) КАК ЧИСЛО(31, 2))
			|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
			|	0 КАК ПостатейныеПостоянныеСНДС,
			|	0 КАК ПостатейныеПеременныеСНДС,
			|	0 КАК ПостатейныеПостоянныеБезНДС,
			|	0 КАК ПостатейныеПеременныеБезНДС,
			|	0 КАК ПостатейныеПостоянныеРегл,
			|	0 КАК ПостатейныеПеременныеРегл,
			|	0 КАК ПостатейныеПостоянныеУпр,
			|	0 КАК ПостатейныеПеременныеУпр,
			|	0 КАК ПостояннаяРазница,
			|	0 КАК ВременнаяРазница,
			|	0 КАК СтоимостьНДД
			|
			|ПОМЕСТИТЬ ВтТаблицаКорректировкиВрем
			|ИЗ
			|	ДолиДополнительныхРасходов КАК Движения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Реквизиты
			|		ПО Движения.Регистратор = Реквизиты.Ссылка
			|		ЛЕВОЕ СОЕДИНЕНИЕ СтоимостьДополнительныхРасходов КАК Стоимости
			|		ПО Реквизиты.Организация = Стоимости.Организация
			|			И Реквизиты.Подразделение = Стоимости.Подразделение
			|			И Реквизиты.НаправлениеДеятельности = Стоимости.НаправлениеДеятельности
			|			И Реквизиты.СтатьяРасходов = Стоимости.СтатьяРасходов
			|			И Реквизиты.АналитикаРасходов = Стоимости.АналитикаРасходов
			|ГДЕ
			|	Реквизиты.Организация В(&МассивОрганизаций)
			|ИНДЕКСИРОВАТЬ ПО
			|	Регистратор,
			|	Партия,
			|	РазделУчета,
			|	АналитикаУчетаНоменклатуры";
	Иначе
		Запрос.Текст = 
			"ВЫБРАТЬ
			|	АВТОНОМЕРЗАПИСИ() КАК НомерЗаписи,
			|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
			|	Движения.Регистратор КАК Регистратор,
			|	Движения.ПериодПоступления КАК ПериодПоступления,
			|	Реквизиты.Дата КАК Период,
			|	Реквизиты.Организация КАК Организация,
			|	Реквизиты.Подразделение КАК Подразделение,
			|	Реквизиты.НаправлениеДеятельности КАК НаправлениеДеятельности,
			|	Реквизиты.СтатьяРасходов КАК СтатьяРасходов,
			|	Реквизиты.СтатьяРасходов.ПринятиеКНалоговомуУчету КАК ПринятиеКНалоговомуУчету,
			|	Реквизиты.АналитикаРасходов КАК АналитикаРасходов,
			|	Движения.КорОрганизация КАК КорОрганизация,
			|	Движения.КорРазделУчета КАК РазделУчета,
			|	Движения.КорАналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
			|	Движения.КорВидЗапасов КАК ВидЗапасов,
			|	Движения.КорПартия КАК Партия,
			|	Движения.КорАналитикаУчетаПартий КАК АналитикаУчетаПартий,
			|	Движения.КорАналитикаФинансовогоУчета КАК АналитикаФинансовогоУчета,
			|	Движения.КорВидДеятельностиНДС КАК ВидДеятельностиНДС,
			|	Движения.КорСтатьяРасходов КАК КорСтатьяРасходов,
			|	Движения.КорАналитикаРасходов КАК КорАналитикаРасходов,
			|	Движения.КорСтатьяАктивовПассивов КАК КорСтатьяАктивовПассивов,
			|	Движения.КорАналитикаАктивовПассивов КАК КорАналитикаАктивовПассивов,
			|	Движения.КорНастройкаСчетовУчета КАК КорНастройкаСчетовУчета,
			|	Движения.КорПодразделение КАК КорПодразделение,
			|	Движения.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
			|	Движения.ХозяйственнаяОперация,
			|	Движения.ТипЗаписи,
			|	Движения.ИсточникГФУНоменклатуры,
			|	Движения.АналитикаУчетаПоПартнерам,
			|	Движения.ЗаказКлиента,
			|	Движения.Менеджер,
			|	Движения.Склад,
			|	Движения.Соглашение,
			|	Движения.Договор,
			|	Движения.ТипЗапасов,
			|	Движения.НаправлениеДеятельностиКонтрагента,
			|	Движения.ИсточникГФУРасчетов,
			|	Движения.ВидДеятельностиНДСПартии,
			|	Движения.ВидДеятельностиНДСВыбытия,
			|
			|	0 КАК ДопРасходы,
			|	0 КАК ДопРасходыБезНДС,
			|	0 КАК ДопРасходыРегл,
			|	0 КАК ДопРасходыУпр,
			|
			|	ВЫБОР КОГДА Реквизиты.УправленческийУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		ВЫРАЗИТЬ(Движения.ДоляСтоимости
			|			* ЕСТЬNULL(Стоимости.ПостатейныеПостоянныеСНДС, 0) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеСНДС,
			|	ВЫБОР КОГДА Реквизиты.УправленческийУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		ВЫРАЗИТЬ(Движения.ДоляСтоимости
			|			* ЕСТЬNULL(Стоимости.ПостатейныеПеременныеСНДС, 0) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеСНДС,
			|	ВЫБОР КОГДА Реквизиты.УправленческийУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		ВЫРАЗИТЬ(Движения.ДоляСтоимостиБезНДС
			|			* ЕСТЬNULL(Стоимости.ПостатейныеПостоянныеБезНДС, 0) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеБезНДС,
			|	ВЫБОР КОГДА Реквизиты.УправленческийУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		ВЫРАЗИТЬ(Движения.ДоляСтоимостиБезНДС
			|			* ЕСТЬNULL(Стоимости.ПостатейныеПеременныеБезНДС, 0) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеБезНДС,
			|	ВЫБОР КОГДА Реквизиты.РегламентированныйУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		ВЫРАЗИТЬ(Движения.ДоляСтоимостиРегл 
			|			* ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеРегл, 0) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеРегл,
			|	ВЫБОР КОГДА Реквизиты.РегламентированныйУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		ВЫРАЗИТЬ(Движения.ДоляСтоимостиРегл 
			|			* ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеРегл, 0) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеРегл,
			//++ НЕ УТ
			
			//++ Локализация
			|	ВЫБОР КОГДА Реквизиты.РегламентированныйУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		ВЫРАЗИТЬ(Движения.ДоляСтоимостиРегл 
			|			* ЕСТЬNULL(СтоимостиРегл.ПостояннаяРазница, 0) КАК ЧИСЛО(31, 2)) +
			//-- Локализация
			
			//-- НЕ УТ
			|	0 КАК ПостояннаяРазница,
			//++ НЕ УТ
			
			//++ Локализация
			|	ВЫБОР КОГДА Реквизиты.РегламентированныйУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		(ВЫРАЗИТЬ(Движения.ДоляСтоимостиРегл 
			|			* ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеРегл, 0) КАК ЧИСЛО(31, 2))
			|		+ ВЫРАЗИТЬ(Движения.ДоляСтоимостиРегл 
			|			* ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеРегл, 0) КАК ЧИСЛО(31, 2))
			// Т.к. доп. расходы формируются в два этапа (сначала только по БУ, затем по НУ и ПР), 
			// то при первичном отражении необходимо сформировать ВР на всю сумму БУ
			|		+ ВЫРАЗИТЬ(Движения.ДоляСтоимостиРегл 
			|			* ЕСТЬNULL(СтоимостиБУ.СтоимостьРегл, 0) КАК ЧИСЛО(31, 2))
			|		- ВЫРАЗИТЬ(Движения.ДоляСтоимостиРегл 
			|			* ЕСТЬNULL(СтоимостиРегл.ПостояннаяРазница, 0) КАК ЧИСЛО(31, 2)))
			|	- ВЫБОР КОГДА Реквизиты.НалоговыйУчет ТОГДА 1 ИНАЧЕ 0 КОНЕЦ *
			|		ВЫРАЗИТЬ(Движения.ДоляСтоимостиНУ 
			|			* ЕСТЬNULL(СтоимостиРегл.СтоимостьНУ, 0) КАК ЧИСЛО(31, 2)) +
			//-- Локализация
			
			//-- НЕ УТ
			|	0 КАК ВременнаяРазница,
			|	ВЫРАЗИТЬ(Движения.ДоляСтоимостиНДД 
			|			* ЕСТЬNULL(СтоимостиРегл.СтоимостьНДД, 0) КАК ЧИСЛО(31, 2)) КАК СтоимостьНДД,
			|	ВЫРАЗИТЬ(Движения.ДоляСтоимостиУпр 
			|		* ЕСТЬNULL(СтоимостиРегл.ПостатейныеПостоянныеУпр, 0) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПостоянныеУпр,
			|	ВЫРАЗИТЬ(Движения.ДоляСтоимостиУпр 
			|		* ЕСТЬNULL(СтоимостиРегл.ПостатейныеПеременныеУпр, 0) КАК ЧИСЛО(31, 2)) КАК ПостатейныеПеременныеУпр
			|ПОМЕСТИТЬ ВтТаблицаКорректировкиВрем
			|ИЗ
			|	ДолиДополнительныхРасходов КАК Движения
			|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК Реквизиты
			|		ПО Движения.Регистратор = Реквизиты.Ссылка
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВтСтоимостиДополнительныхРасходов КАК Стоимости
			|		ПО Реквизиты.Организация = Стоимости.Организация
			|			И Реквизиты.Подразделение = Стоимости.Подразделение
			|			И Реквизиты.НаправлениеДеятельности = Стоимости.НаправлениеДеятельности
			|			И Реквизиты.СтатьяРасходов = Стоимости.СтатьяРасходов
			|			И Реквизиты.АналитикаРасходов = Стоимости.АналитикаРасходов
			|		ЛЕВОЕ СОЕДИНЕНИЕ СтоимостьДополнительныхРасходов КАК СтоимостиБУ
			|		ПО Реквизиты.Организация = СтоимостиБУ.Организация
			|			И Реквизиты.Подразделение = СтоимостиБУ.Подразделение
			|			И Реквизиты.НаправлениеДеятельности = СтоимостиБУ.НаправлениеДеятельности
			|			И Реквизиты.СтатьяРасходов = СтоимостиБУ.СтатьяРасходов
			|			И Реквизиты.АналитикаРасходов = СтоимостиБУ.АналитикаРасходов
			|		ЛЕВОЕ СОЕДИНЕНИЕ ВтСтоимостиДополнительныхРасходовРегл КАК СтоимостиРегл
			|		ПО Реквизиты.Организация = СтоимостиРегл.Организация
			|			И Реквизиты.Подразделение = СтоимостиРегл.Подразделение
			|			И Реквизиты.НаправлениеДеятельности = СтоимостиРегл.НаправлениеДеятельности
			|			И Реквизиты.СтатьяРасходов = СтоимостиРегл.СтатьяРасходов
			|			И Реквизиты.АналитикаРасходов = СтоимостиРегл.АналитикаРасходов
			|ГДЕ
			|	Реквизиты.Организация В(&МассивОрганизаций)
			|ИНДЕКСИРОВАТЬ ПО
			|	Регистратор,
			|	Партия,
			|	РазделУчета,
			|	АналитикаУчетаНоменклатуры";
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	#КонецОбласти
	
	#Область ДвиженияТаблицаКорректировкиВрем
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.КорНаправлениеДеятельности,
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.ХозяйственнаяОперация,
	|	Т.ТипЗаписи,
	|	МАКСИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВТСтарыеИдентификаторыРасход
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДокументРаспределениеЗатрат
	|		ПО Т.Регистратор = ДокументРаспределениеЗатрат.Ссылка
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Регистратор В (ВЫБРАТЬ РАЗЛИЧНЫЕ Отбор.Регистратор ИЗ ВтТаблицаКорректировкиВрем КАК Отбор)
	|	И Т.Активность
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.КорНаправлениеДеятельности,
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.ХозяйственнаяОперация,
	|	Т.ТипЗаписи
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Партия,
	|	РазделУчета,
	|	АналитикаУчетаНоменклатуры
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.ТипЗаписи,
	|	МАКСИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВТСтарыеИдентификаторыПриход
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДокументРаспределениеЗатрат
	|		ПО Т.Регистратор = ДокументРаспределениеЗатрат.Ссылка
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Регистратор В (ВЫБРАТЬ РАЗЛИЧНЫЕ Отбор.Регистратор ИЗ ВтТаблицаКорректировкиВрем КАК Отбор)
	|	И Т.Активность
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.ВидЗапасов,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.Подразделение,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.ТипЗаписи
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Партия,
	|	РазделУчета,
	|	АналитикаУчетаНоменклатуры
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.ПериодОтклонения,
	|	Т.ХозяйственнаяОперация,
	|	МАКСИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВТСтарыеИдентификаторыОтклонений
	|ИЗ
	|	РегистрНакопления.ОтклоненияВСтоимостиТоваров КАК Т
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РаспределениеПрочихЗатрат КАК ДокументРаспределениеЗатрат
	|		ПО Т.Регистратор = ДокументРаспределениеЗатрат.Ссылка
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.Регистратор В (ВЫБРАТЬ РАЗЛИЧНЫЕ Отбор.Регистратор ИЗ ВтТаблицаКорректировкиВрем КАК Отбор)
	|	И Т.Активность
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Период,
	|	Т.Организация,
	|	Т.ВидЗапасов,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.ПериодОтклонения,
	|	Т.ХозяйственнаяОперация
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Т.Организация,
	|	ВидЗапасов
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Движения.НомерЗаписи,
	|	Движения.ВидДвижения,
	|	Движения.Регистратор,
	|	Движения.Период,
	|	Движения.Организация,
	|	Движения.Подразделение,
	|	Движения.НаправлениеДеятельности,
	|	Движения.СтатьяРасходов,
	|	Движения.ПринятиеКНалоговомуУчету,
	|	Движения.АналитикаРасходов,
	|	Движения.РазделУчета,
	|	Движения.АналитикаУчетаНоменклатуры,
	|	Движения.ВидЗапасов,
	|	Движения.КорОрганизация,
	|	Движения.Партия,
	|	Движения.АналитикаУчетаПартий,
	|	Движения.АналитикаФинансовогоУчета,
	|	Движения.ВидДеятельностиНДС,
	|	Движения.КорСтатьяРасходов,
	|	Движения.КорАналитикаРасходов,
	|	Движения.КорСтатьяАктивовПассивов,
	|	Движения.КорАналитикаАктивовПассивов,
	|	Движения.КорНастройкаСчетовУчета,
	|	Движения.КорПодразделение,
	|	Движения.КорНаправлениеДеятельности,
	|	Движения.ХозяйственнаяОперация,
	|	Движения.ТипЗаписи,
	|	Движения.ИсточникГФУНоменклатуры,
	|	Движения.АналитикаУчетаПоПартнерам,
	|	Движения.ЗаказКлиента,
	|	Движения.Менеджер,
	|	Движения.Склад,
	|	Движения.Соглашение,
	|	Движения.Договор,
	|	Движения.ТипЗапасов,
	|	Движения.НаправлениеДеятельностиКонтрагента,
	|	Движения.ИсточникГФУРасчетов,
	|	Движения.ВидДеятельностиНДСПартии,
	|	Движения.ВидДеятельностиНДСВыбытия,
	|
	|	Движения.ДопРасходы,
	|	Движения.ДопРасходыБезНДС,
	|	Движения.ДопРасходыРегл,
	|	Движения.ДопРасходыУпр,
	|
	|	Движения.ПостатейныеПостоянныеСНДС,
	|	Движения.ПостатейныеПеременныеСНДС,
	|	Движения.ПостатейныеПостоянныеБезНДС,
	|	Движения.ПостатейныеПеременныеБезНДС,
	|	Движения.ПостатейныеПостоянныеРегл,
	|	Движения.ПостатейныеПеременныеРегл,
	|	Движения.ПостатейныеПостоянныеУпр,
	|	Движения.ПостатейныеПеременныеУпр,
	|	Движения.ПостояннаяРазница,
	|	Движения.ВременнаяРазница,
	|	Движения.СтоимостьНДД,
	|	ЕСТЬNULL(ИдентификаторыРасход.ИдентификаторФинЗаписи, ЕСТЬNULL(ИдентификаторыПриход.ИдентификаторФинЗаписи,
	|		ЕСТЬNULL(Идентификаторы.ИдентификаторФинЗаписи, """"))) КАК ИдентификаторФинЗаписи,
	|	Движения.ПериодПоступления КАК ПериодПоступления
	|ПОМЕСТИТЬ ДвиженияТаблицаКорректировкиВрем
	|ИЗ
	|	ВтТаблицаКорректировкиВрем КАК Движения
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтарыеИдентификаторыРасход КАК ИдентификаторыРасход
	|		ПО Движения.Регистратор = ИдентификаторыРасход.Регистратор
	|		И НЕ Движения.Организация В (&ОрганизацииСреднескользящая)
	|		И Движения.Период = ИдентификаторыРасход.Период
	|		И Движения.Организация = ИдентификаторыРасход.Организация
	|		И Движения.РазделУчета = ИдентификаторыРасход.РазделУчета
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.ВидЗапасов) = ТИП(Справочник.ВидыЗапасов)
	|			ТОГДА Движения.ВидЗапасов
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.ВидЗапасов
	|		И Движения.Партия = ИдентификаторыРасход.Партия
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.АналитикаУчетаПартий) = ТИП(Справочник.КлючиАналитикиУчетаПартий)
	|			ТОГДА Движения.АналитикаУчетаПартий
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.АналитикаУчетаПартий
	|		И Движения.АналитикаФинансовогоУчета = ИдентификаторыРасход.АналитикаФинансовогоУчета
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.АналитикаУчетаНоменклатуры) = ТИП(Справочник.КлючиАналитикиУчетаНоменклатуры)
	|			ТОГДА Движения.АналитикаУчетаНоменклатуры
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.АналитикаУчетаНоменклатуры
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.ВидДеятельностиНДС) = ТИП(Перечисление.ТипыНалогообложенияНДС)
	|			ТОГДА Движения.ВидДеятельностиНДС
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.ВидДеятельностиНДС
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.КорПодразделение) = ТИП(Справочник.СтруктураПредприятия)
	|			ТОГДА Движения.КорПодразделение
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.Подразделение
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.КорСтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|			ТОГДА Движения.КорСтатьяРасходов
	|			ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.СтатьяРасходовСписания
	|		И Движения.КорАналитикаРасходов = ИдентификаторыРасход.АналитикаРасходов
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.КорСтатьяАктивовПассивов) = ТИП(ПланВидовХарактеристик.СтатьиАктивовПассивов)
	|			ТОГДА Движения.КорСтатьяАктивовПассивов
	|			ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.СтатьяАктивовПассивов
	|		И Движения.КорАналитикаАктивовПассивов = ИдентификаторыРасход.АналитикаАктивовПассивов
	|		И Движения.КорНастройкаСчетовУчета = ИдентификаторыРасход.АналитикаАктивовПассивов
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.КорНаправлениеДеятельности) = ТИП(Справочник.НаправленияДеятельности)
	|			ТОГДА Движения.КорНаправлениеДеятельности
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.КорНаправлениеДеятельности
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.АналитикаУчетаПоПартнерам) = ТИП(Справочник.КлючиАналитикиУчетаПоПартнерам)
	|			ТОГДА Движения.АналитикаУчетаПоПартнерам
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыРасход.АналитикаУчетаПоПартнерам
	|		И Движения.ХозяйственнаяОперация = ИдентификаторыРасход.ХозяйственнаяОперация
	|		И Движения.ТипЗаписи = ИдентификаторыРасход.ТипЗаписи
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСтарыеИдентификаторыПриход КАК ИдентификаторыПриход
	|		ПО Движения.Регистратор = ИдентификаторыПриход.Регистратор
	|		И НЕ Движения.Организация В (&ОрганизацииСреднескользящая)
	|		И Движения.Период = ИдентификаторыПриход.Период
	|		И Движения.Организация = ИдентификаторыПриход.Организация
	|		И Движения.РазделУчета = ИдентификаторыПриход.РазделУчета
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.ВидЗапасов) = ТИП(Справочник.ВидыЗапасов)
	|			ТОГДА Движения.ВидЗапасов
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыПриход.ВидЗапасов
	|		И Движения.Партия = ИдентификаторыПриход.Партия
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.АналитикаУчетаПартий) = ТИП(Справочник.КлючиАналитикиУчетаПартий)
	|			ТОГДА Движения.АналитикаУчетаПартий
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыПриход.АналитикаУчетаПартий
	|		И Движения.АналитикаФинансовогоУчета = ИдентификаторыПриход.АналитикаФинансовогоУчета
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.АналитикаУчетаНоменклатуры) = ТИП(Справочник.КлючиАналитикиУчетаНоменклатуры)
	|			ТОГДА Движения.АналитикаУчетаНоменклатуры
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыПриход.АналитикаУчетаНоменклатуры
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.ВидДеятельностиНДС) = ТИП(Перечисление.ТипыНалогообложенияНДС)
	|			ТОГДА Движения.ВидДеятельностиНДС
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыПриход.ВидДеятельностиНДС
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.Подразделение) = ТИП(Справочник.СтруктураПредприятия)
	|			ТОГДА Движения.Подразделение
	|			ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыПриход.Подразделение
	|		И ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Движения.СтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	|			ТОГДА Движения.СтатьяРасходов
	|			ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		  КОНЕЦ = ИдентификаторыПриход.СтатьяРасходовСписания
	|		И Движения.АналитикаРасходов = ИдентификаторыПриход.АналитикаРасходов
	|		И Движения.ТипЗаписи = ИдентификаторыПриход.ТипЗаписи
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтарыеИдентификаторыОтклонений КАК Идентификаторы
	|		ПО Движения.Регистратор = Идентификаторы.Регистратор
	|			И Движения.Организация В (&ОрганизацииСреднескользящая)
	|			И Движения.Период = Идентификаторы.Период
	|			И Движения.Организация = Идентификаторы.Организация
	|			И Движения.ВидЗапасов = Идентификаторы.ВидЗапасов
	|			И Движения.АналитикаУчетаНоменклатуры.Номенклатура = Идентификаторы.Номенклатура
	|			И Движения.АналитикаУчетаНоменклатуры.Характеристика = Идентификаторы.Характеристика
	|			И Движения.АналитикаУчетаНоменклатуры.МестоХранения = Идентификаторы.МестоХранения
	|			И Движения.Подразделение = Идентификаторы.Подразделение
	|			И Движения.НаправлениеДеятельности = Идентификаторы.НаправлениеДеятельности
	|			И Движения.ХозяйственнаяОперация = Идентификаторы.ХозяйственнаяОперация
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерЗаписи
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Т.НомерЗаписи
	|ИЗ
	|	ДвиженияТаблицаКорректировкиВрем КАК Т
	|ГДЕ
	|	Т.ИдентификаторФинЗаписи = """"
	|";
	
	ТаблицаИдентификаторов = Новый ТаблицаЗначений;
	ТаблицаИдентификаторов.Колонки.Добавить("Идентификатор", ОбщегоНазначения.ОписаниеТипаСтрока(36));
	ТаблицаИдентификаторов.Колонки.Добавить("НомерЗаписи", ОбщегоНазначения.ОписаниеТипаЧисло(31));
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаИдентификаторов.Добавить();
		НоваяСтрока.Идентификатор = Новый УникальныйИдентификатор;
		НоваяСтрока.НомерЗаписи = Выборка.НомерЗаписи;
	КонецЦикла;
	
	#КонецОбласти
	
	#Область ДвиженияТаблицаКорректировки
	
	Запрос.УстановитьПараметр("ТаблицаИдентификаторов", ТаблицаИдентификаторов);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ТаблицаИдентификаторов.Идентификатор КАК Идентификатор,
	|	ТаблицаИдентификаторов.НомерЗаписи КАК НомерЗаписи
	|ПОМЕСТИТЬ ТаблицаИдентификаторов
	|ИЗ
	|	&ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерЗаписи
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Движения.Организация <> Движения.КорОрганизация ТОГДА ИСТИНА ИНАЧЕ ЛОЖЬ КОНЕЦ КАК ПередачаМеждуОрганизациями,
	|	Движения.ВидДвижения,
	|	Движения.Регистратор,
	|	Движения.Регистратор КАК ДокументДвижения,
	|	Движения.Период,
	|	Движения.ПериодПоступления,
	|	Движения.Организация,
	|	Движения.Подразделение,
	|	Движения.НаправлениеДеятельности,
	|	Движения.СтатьяРасходов,
	|	Движения.ПринятиеКНалоговомуУчету,
	|	Движения.АналитикаРасходов,
	|
	|	Движения.РазделУчета,
	|	Движения.АналитикаУчетаНоменклатуры,
	|	Движения.ВидЗапасов,
	|	Движения.КорОрганизация,
	|	Движения.Партия,
	|	Движения.АналитикаУчетаПартий,
	|	Движения.АналитикаФинансовогоУчета,
	|	Движения.ВидДеятельностиНДС,
	|
	|	Движения.КорСтатьяРасходов,
	|	Движения.КорАналитикаРасходов,
	|	Движения.КорСтатьяАктивовПассивов,
	|	Движения.КорАналитикаАктивовПассивов,
	|	Движения.КорНастройкаСчетовУчета,
	|	Движения.КорПодразделение,
	|	Движения.КорНаправлениеДеятельности,
	|	Движения.ХозяйственнаяОперация,
	|	Движения.ТипЗаписи,
	|	Движения.ИсточникГФУНоменклатуры,
	|
	|	Движения.АналитикаУчетаПоПартнерам,
	|	Движения.ЗаказКлиента,
	|	Движения.Менеджер,
	|	Движения.Склад,
	|	Движения.Соглашение,
	|	Движения.Договор,
	|	Движения.ТипЗапасов,
	|	Движения.НаправлениеДеятельностиКонтрагента,
	|	Движения.ИсточникГФУРасчетов,
	|	Движения.ВидДеятельностиНДСПартии,
	|	Движения.ВидДеятельностиНДСВыбытия,
	|
	|	Движения.ДопРасходы,
	|	Движения.ДопРасходыБезНДС,
	|	Движения.ДопРасходыРегл,
	|	Движения.ДопРасходыУпр,
	|
	|	Движения.ПостатейныеПостоянныеСНДС,
	|	Движения.ПостатейныеПеременныеСНДС,
	|	Движения.ПостатейныеПостоянныеБезНДС,
	|	Движения.ПостатейныеПеременныеБезНДС,
	|	Движения.ПостатейныеПостоянныеРегл,
	|	Движения.ПостатейныеПеременныеРегл,
	|	Движения.ПостатейныеПостоянныеУпр,
	|	Движения.ПостатейныеПеременныеУпр,
	|	Движения.ПостояннаяРазница,
	|	Движения.ВременнаяРазница,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьУпр,
	|	Движения.СтоимостьНДД,
	|
	|	НастройкиХозОпераций.Ссылка КАК НастройкаХозяйственнойОперации,
	|	ЕСТЬNULL(ТаблицаИдентификаторов.Идентификатор, Движения.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ ДвиженияТаблицаКорректировки
	|ИЗ
	|	ДвиженияТаблицаКорректировкиВрем КАК Движения
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|		ПО ТаблицаИдентификаторов.НомерЗаписи = Движения.НомерЗаписи
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиХозяйственныхОпераций КАК НастройкиХозОпераций
	|		ПО НастройкиХозОпераций.ХозяйственнаяОперация = Движения.ХозяйственнаяОперация
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Движения.ВидДвижения,
	|	Движения.Регистратор,
	|	Движения.Период,
	|	Движения.Организация,
	|	Движения.Подразделение,
	|	Движения.НаправлениеДеятельности,
	|	Движения.СтатьяРасходов,
	|	Движения.ПринятиеКНалоговомуУчету,
	|	Движения.АналитикаРасходов,
	|
	|	Движения.РазделУчета,
	|	Движения.АналитикаУчетаНоменклатуры,
	|	Движения.ВидЗапасов,
	|	Движения.КорОрганизация,
	|	Движения.Партия,
	|	Движения.АналитикаУчетаПартий,
	|	Движения.АналитикаФинансовогоУчета,
	|	Движения.ВидДеятельностиНДС,
	|
	|	Движения.КорСтатьяРасходов,
	|	Движения.КорАналитикаРасходов,
	|	Движения.КорСтатьяАктивовПассивов,
	|	Движения.КорАналитикаАктивовПассивов,
	|	Движения.КорНастройкаСчетовУчета,
	|	Движения.КорПодразделение,
	|	Движения.КорНаправлениеДеятельности,
	|	Движения.ХозяйственнаяОперация,
	|	Движения.ТипЗаписи,
	|	Движения.ИсточникГФУНоменклатуры,
	|
	|	Движения.АналитикаУчетаПоПартнерам,
	|	Движения.ЗаказКлиента,
	|	Движения.Менеджер,
	|	Движения.Склад,
	|	Движения.Соглашение,
	|	Движения.Договор,
	|	Движения.ТипЗапасов,
	|	Движения.НаправлениеДеятельностиКонтрагента,
	|	Движения.ИсточникГФУРасчетов,
	|	Движения.ВидДеятельностиНДСПартии,
	|	Движения.ВидДеятельностиНДСВыбытия,
	|
	|	Движения.НастройкаХозяйственнойОперации,
	|	Движения.ИдентификаторФинЗаписи
	|
	// Временная таблица используется в этапе СкорректироватьСтоимостьДополнительныхРасходовНДС
	|ПОМЕСТИТЬ ДолиДополнительныхРасходовДляНДС
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Движения
	|ГДЕ
	|	Движения.ВидДеятельностиНДСВыбытия <> НЕОПРЕДЕЛЕНО
	|	И Движения.ВидДеятельностиНДСВыбытия <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	И Движения.ВидДеятельностиНДСПартии <> Движения.ВидДеятельностиНДСВыбытия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	ИдентификаторФинЗаписи
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВтТаблицаКорректировкиВрем, ДвиженияТаблицаКорректировкиВрем, ВТСтарыеИдентификаторыРасход, ВТСтарыеИдентификаторыПриход, ТаблицаИдентификаторов");
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	// Формируются движения по регистрам:
	// - ПрочиеРасходы
	// - СебестоимостьТоваров
	
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходов Тогда
		СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
		СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, Ложь);
	КонецЕсли;
	СформироватьДвиженияПрочиеАктивыПассивыДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	СформироватьДвиженияПоПрочимАктивамПассивамДопРасходыЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений);

	СформироватьДвиженияСебестоимостьТоваровДополнительныхРасходовЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, Ложь);
	СформироватьДвиженияСебестоимостьТоваровДополнительныхРасходовЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, Истина);
	
	СформироватьДвиженияНоменклатураДоходыДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	СформироватьДвиженияВыручкаИСебестоимостьДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	СформироватьДвиженияОтклоненияВСтоимостиТоваровДополнительныеРасходыЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	ВременныеТаблицыКУдалению = Новый Массив;
	ВременныеТаблицыКУдалению.Добавить("ДвиженияТаблицаКорректировки");
	Для Каждого КлючЗначение Из СоответствиеВременныхТаблицДвижений Цикл
		ВременныеТаблицыКУдалению.Добавить(КлючЗначение.Ключ);
	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, СтрСоединить(ВременныеТаблицыКУдалению, ","));
	
КонецПроцедуры

//++ Локализация

Процедура СкорректироватьСтоимостьДополнительныхРасходовНДС(ПараметрыРасчета) Экспорт
	
	Если ПараметрыРасчета.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие
	 И НЕ ПараметрыРасчета.РаспределениеДопРасходовМеждуПартиямиИТоварами Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьДополнительныхРасходовНДС");
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ДвиженияТаблицаКорректировки");
		
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстСкорректироватьСтоимостьДополнительныхРасходовНДС(ПараметрыРасчета));
		
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	СформироватьДвиженияПоПрочимАктивамПассивамДопРасходыЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений);
	СформироватьДвиженияСебестоимостьТоваровДополнительныхРасходовЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, Истина);
	СформироватьДвиженияВыручкаИСебестоимостьДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	ВременныеТаблицыКУдалению = Новый Массив;
	ВременныеТаблицыКУдалению.Добавить("ДолиДополнительныхРасходовДляНДС");
	ВременныеТаблицыКУдалению.Добавить("ДвиженияТаблицаКорректировки");
	Для Каждого КлючЗначение Из СоответствиеВременныхТаблицДвижений Цикл
		ВременныеТаблицыКУдалению.Добавить(КлючЗначение.Ключ);
	КонецЦикла;
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, СтрСоединить(ВременныеТаблицыКУдалению, ","));
	
КонецПроцедуры

Функция ТекстСкорректироватьСтоимостьДополнительныхРасходовНДС(ПараметрыРасчета)
	
	ТекстЗапроса = "";
	
	#Область ДвиженияТаблицаКорректировкиНДС
	
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Регистратор,
	|	Т.ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ РегистраторыДопРасходовДляНДС
	|ИЗ
	|	ДолиДополнительныхРасходовДляНДС КАК Т
	|;
	|ВЫБРАТЬ
	|	Т.Регистратор КАК Регистратор,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|
	|ПОМЕСТИТЬ СуммыНДСДопРасходов
	|ИЗ
	|	ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистраторыДопРасходовДляНДС КАК Отбор
	|		ПО Отбор.Регистратор = Т.Регистратор
	|		И Отбор.ИдентификаторФинЗаписи = Т.ИдентификаторФинЗаписи
	|ГДЕ
	|	НЕ Т.СлужебноеВидДвиженияПриход
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.ИдентификаторФинЗаписи
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	ИдентификаторФинЗаписи
	|;
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ПередачаМеждуОрганизациями,
	|	Движения.ВидДвижения,
	|	Движения.Регистратор,
	|	Движения.Регистратор КАК ДокументДвижения,
	|	Движения.Период,
	|	Движения.Организация,
	|	Движения.Подразделение,
	|	Движения.НаправлениеДеятельности,
	|	Движения.СтатьяРасходов,
	|	Движения.ПринятиеКНалоговомуУчету,
	|	Движения.АналитикаРасходов,
	|
	|	Движения.РазделУчета,
	|	Движения.АналитикаУчетаНоменклатуры,
	|	Движения.ВидЗапасов,
	|	Движения.КорОрганизация,
	|	Движения.Партия,
	|	Движения.АналитикаУчетаПартий,
	|	Движения.АналитикаФинансовогоУчета,
	|	Движения.ВидДеятельностиНДС,
	|
	|	Движения.КорСтатьяРасходов,
	|	Движения.КорАналитикаРасходов,
	|	Движения.КорСтатьяАктивовПассивов,
	|	Движения.КорАналитикаАктивовПассивов,
	|	Движения.КорНастройкаСчетовУчета,
	|	Движения.КорПодразделение,
	|	Движения.КорНаправлениеДеятельности,
	|	Движения.ХозяйственнаяОперация,
	|	Движения.ИсточникГФУНоменклатуры,
	|
	|	Движения.АналитикаУчетаПоПартнерам,
	|	Движения.ЗаказКлиента,
	|	Движения.Менеджер,
	|	Движения.Склад,
	|	Движения.Соглашение,
	|	Движения.Договор,
	|	Движения.ТипЗапасов,
	|	Движения.НаправлениеДеятельностиКонтрагента,
	|	Движения.ИсточникГФУРасчетов,
	|	Движения.ВидДеятельностиНДСПартии,
	|	Движения.ВидДеятельностиНДСВыбытия,
	|
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СтоимостьНДД,
	|
	|	ВЫБОР
	|		КОГДА Движения.ВидДеятельностиНДСПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Движения.ВидДеятельностиНДСВыбытия В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|			ТОГДА Суммы.НДСРегл
	|		КОГДА Движения.ВидДеятельностиНДСПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Движения.ВидДеятельностиНДСВыбытия В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|			ТОГДА -Суммы.НДСРегл
	|			ИНАЧЕ 0
	|	КОНЕЦ КАК СтоимостьРегл,
	|	ВЫБОР
	|		КОГДА Движения.ВидДеятельностиНДСПартии В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|		 И Движения.ВидДеятельностиНДСВыбытия В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|			ТОГДА Суммы.НДСУпр
	|		КОГДА Движения.ВидДеятельностиНДСПартии В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости)
	|		 И Движения.ВидДеятельностиНДСВыбытия В (&ТипыНалогообложенияНДСНеУчитываетсяВСтоимости)
	|			ТОГДА -Суммы.НДСУпр
	|			ИНАЧЕ 0
	|	КОНЕЦ КАК СтоимостьУпр,
	|
	|	Движения.ТипЗаписи,
	|	Движения.НастройкаХозяйственнойОперации,
	|	Движения.ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ ДвиженияТаблицаКорректировки
	|ИЗ
	|	ДолиДополнительныхРасходовДляНДС КАК Движения
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ СуммыНДСДопРасходов КАК Суммы
	|		ПО Суммы.Регистратор = Движения.Регистратор
	|		И Суммы.ИдентификаторФинЗаписи = Движения.ИдентификаторФинЗаписи	
	|";
	#КонецОбласти
	
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

//-- Локализация

//++ НЕ УТ

//++ Локализация
Процедура СписатьОстаткиМалоценныхМЦ(ПараметрыРасчета)
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СписатьОстаткиМалоценныхМЦ");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ПорядокОтражения.Организация,
	|	ПорядокОтражения.МестоУчета,
	|	ПорядокОтражения.АналитикаУчета,
	|	ПорядокОтражения.ОтноситсяКМалоценнымТМЦ
	|
	|ПОМЕСТИТЬ ПорядокОтраженияНаСчетахУчета
	|ИЗ
	|	РегистрСведений.ПорядокОтраженияНаСчетахУчета КАК ПорядокОтражения
	|ГДЕ
	|	ПорядокОтражения.ВидСчета = ЗНАЧЕНИЕ(Перечисление.ВидыСчетовРеглУчета.НаСкладе)
	|;
	|ВЫБРАТЬ
	|	Себестоимость.Организация 					КАК Организация,
	|	Себестоимость.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	Себестоимость.РазделУчета 					КАК РазделУчета,
	|	Себестоимость.ВидЗапасов 					КАК ВидЗапасов,
	|	Себестоимость.Партия                        КАК Партия,
	|	Себестоимость.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	УчетнаяПолитика.СтатьяРасходовДляСписанияМалоценныхТМЦ КАК СтатьяРасходовДляСписанияМалоценныхТМЦ,
	|	УчетнаяПолитика.АналитикаСписанияМалоценныхТМЦ КАК АналитикаСписанияМалоценныхТМЦ,
	|	ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА Себестоимость.ВидЗапасов.ГруппаФинансовогоУчета
	|		ИНАЧЕ Себестоимость.АналитикаУчетаНоменклатуры.Номенклатура.ГруппаФинансовогоУчета
	|	КОНЕЦ КАК ГруппаФинансовогоУчета,
	|
	|	Себестоимость.СтоимостьРегл 				КАК СтоимостьРегл,
	|	Себестоимость.ПостояннаяРазница 			КАК ПостояннаяРазница,
	|	Себестоимость.СтоимостьЗабалансоваяРегл     КАК СтоимостьЗабалансоваяРегл,
	|	Себестоимость.ДопРасходыРегл                КАК ДопРасходыРегл,
	|	Себестоимость.ТрудозатратыРегл              КАК ТрудозатратыРегл,
	|	Себестоимость.ПостатейныеПостоянныеРегл     КАК ПостатейныеПостоянныеРегл,
	|	Себестоимость.ПостатейныеПеременныеРегл     КАК ПостатейныеПеременныеРегл,
	|	Себестоимость.РезервПодОбесценениеРегл      КАК РезервПодОбесценениеРегл,
	|	Себестоимость.СтоимостьУпр     				КАК СтоимостьУпр,
	|	Себестоимость.ДопРасходыУпр     			КАК ДопРасходыУпр,
	|	Себестоимость.ТрудозатратыУпр     			КАК ТрудозатратыУпр,
	|	Себестоимость.ПостатейныеПостоянныеУпр     	КАК ПостатейныеПостоянныеУпр,
	|	Себестоимость.ПостатейныеПеременныеУпр     	КАК ПостатейныеПеременныеУпр,
	|	Себестоимость.РезервПодОбесценениеУпр       КАК РезервПодОбесценениеУпр
	|
	|ПОМЕСТИТЬ ВТОстаткиПредварительная
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК Себестоимость
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.УчетнаяПолитикаБухУчета.СрезПоследних(&КонецПериода) КАК УчетнаяПолитика
	|		ПО Себестоимость.Организация.ГоловнаяОрганизация = УчетнаяПолитика.Организация
	|		И УчетнаяПолитика.СписыватьСтоимостьМалоценныхТМЦНаРасходы
	|ГДЕ
	|	НЕ Себестоимость.РазделУчета В (
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути))
	// Условие должно быть обратным с см. СписатьОшибкиОкругленияРасчетаСебестоимости область СебестоимостьТоваров
	// в 1 запросе ВТОкруглениеСебестоимостьТоваров.
	|	И НЕ (Себестоимость.Количество = 0
	|		И Себестоимость.Стоимость МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.СтоимостьБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ДопРасходы МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ДопРасходыБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.СтоимостьРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.СтоимостьУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостояннаяРазница МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ВременнаяРазница МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.СтоимостьНДД МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.СтоимостьЗабалансовая МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.Трудозатраты МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПостоянныеСНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПостоянныеБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПеременныеСНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПеременныеБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.СтоимостьЗабалансоваяРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ДопРасходыРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ТрудозатратыРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ПостатейныеПостоянныеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ПостатейныеПеременныеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.СтоимостьУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ДопРасходыУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ТрудозатратыУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПостоянныеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПеременныеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.РезервПодОбесценениеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.РезервПодОбесценениеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		)
	|;
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|
	|	Себестоимость.Организация 					КАК Организация,
	|	Себестоимость.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	Себестоимость.РазделУчета 					КАК РазделУчета,
	|	Себестоимость.ВидЗапасов 					КАК ВидЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар) 	КАК ТипЗапасов,
	|	Себестоимость.Партия                        КАК Партия,
	|	Себестоимость.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	Себестоимость.СтатьяРасходовДляСписанияМалоценныхТМЦ КАК СтатьяРасходов,
	|	Себестоимость.СтатьяРасходовДляСписанияМалоценныхТМЦ КАК СтатьяРасходовСписания,
	|	Себестоимость.СтатьяРасходовДляСписанияМалоценныхТМЦ КАК СтатьяДоходовРасходов,
	|	Себестоимость.АналитикаСписанияМалоценныхТМЦ КАК АналитикаРасходов,
	|	ВЫБОР
	|		КОГДА АналитикаНоменклатуры.Назначение = ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)
	|				ИЛИ АналитикаНоменклатуры.Назначение.Заказ = НЕОПРЕДЕЛЕНО
	|			ТОГДА ВЫРАЗИТЬ(АналитикаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		ИНАЧЕ АналитикаНоменклатуры.Назначение.Заказ.Подразделение
	|	КОНЕЦ 										КАК Подразделение,
	|	ВЫРАЗИТЬ(АналитикаНоменклатуры.МестоХранения КАК Справочник.Склады) КАК Склад,
	|	ЕСТЬNULL(АналитикаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
	|	ЕСТЬNULL(АналитикаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК КорНаправлениеДеятельности,
	|	ЕСТЬNULL(АналитикаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельностиСтатьи,
	|	ИСТИНА										КАК РасчетСебестоимости,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыМалоценныхТМЦВМесяцеПриобретения) КАК ХозяйственнаяОперация,
	|	НастройкиХозяйственныхОпераций.Ссылка  		КАК НастройкаХозяйственнойОперации,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Потребление) КАК ТипЗаписи,
	|	ЗНАЧЕНИЕ(Перечисление.ОперацииУчетаСебестоимости.СписаниеНаРасходыАктивы) КАК ОперацияУчетаСебестоимости,
	|	&РежимЗакрытияМесяца						КАК РежимЗакрытияМесяца,
	|	Себестоимость.ВидЗапасов 					КАК КорВидЗапасов,
	|	Себестоимость.ВидДеятельностиНДС         	КАК КорВидДеятельностиНДС,
	|	ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА Себестоимость.ВидЗапасов
	|		ИНАЧЕ АналитикаНоменклатуры.Номенклатура
	|	КОНЕЦ КАК ИсточникГФУНоменклатуры,
	|	ЕСТЬNULL(АналитикаНоменклатуры.Назначение.НаправлениеДеятельности, 
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельностиНоменклатуры,
	|	ДокументыРасчетаСебестоимости.Ссылка		КАК ДокументДвижения,
	|	0 											КАК Стоимость,
	|	0 											КАК СтоимостьБезНДС,
	|	0 											КАК Сумма,
	|	0 											КАК СуммаБезНДС,
	|	0 											КАК ДопРасходы,
	|	0 											КАК ДопРасходыБезНДС,
	|	0         									КАК СтоимостьЗабалансовая,
	|	0       		    						КАК Трудозатраты,
	|	0     										КАК ПостатейныеПостоянныеСНДС,
	|	0   										КАК ПостатейныеПостоянныеБезНДС,
	|	0     										КАК ПостатейныеПеременныеСНДС,
	|	0   										КАК ПостатейныеПеременныеБезНДС,
	|	Себестоимость.СтоимостьРегл 				КАК СтоимостьРегл,
	|	Себестоимость.СтоимостьРегл
	|		+Себестоимость.ПостатейныеПостоянныеРегл
	|		+Себестоимость.ПостатейныеПеременныеРегл
	|		+Себестоимость.ТрудозатратыРегл
	|		+Себестоимость.ДопРасходыРегл 			КАК СуммаРегл,
	|	Себестоимость.ПостояннаяРазница 			КАК ПостояннаяРазница,
	|	Себестоимость.СтоимостьРегл
	|		+Себестоимость.ПостатейныеПостоянныеРегл
	|		+Себестоимость.ПостатейныеПеременныеРегл
	|		+Себестоимость.ТрудозатратыРегл
	|		+Себестоимость.ДопРасходыРегл
	|		-Себестоимость.ПостояннаяРазница 		КАК ВременнаяРазница,
	|	Себестоимость.СтоимостьЗабалансоваяРегл     КАК СтоимостьЗабалансоваяРегл,
	|	Себестоимость.ДопРасходыРегл                КАК ДопРасходыРегл,
	|	Себестоимость.ТрудозатратыРегл              КАК ТрудозатратыРегл,
	|	Себестоимость.ПостатейныеПостоянныеРегл     КАК ПостатейныеПостоянныеРегл,
	|	Себестоимость.ПостатейныеПеременныеРегл     КАК ПостатейныеПеременныеРегл,
	|	Себестоимость.РезервПодОбесценениеРегл      КАК РезервПодОбесценениеРегл,
	|	Себестоимость.СтоимостьУпр     				КАК СтоимостьУпр,
	|	Себестоимость.СтоимостьУпр
	|		+Себестоимость.ПостатейныеПостоянныеУпр
	|		+Себестоимость.ПостатейныеПеременныеУпр
	|		+Себестоимость.ТрудозатратыУпр
	|		+Себестоимость.ДопРасходыУпр			КАК СуммаУпр,
	|	Себестоимость.ДопРасходыУпр     			КАК ДопРасходыУпр,
	|	Себестоимость.ТрудозатратыУпр     			КАК ТрудозатратыУпр,
	|	Себестоимость.ПостатейныеПостоянныеУпр     	КАК ПостатейныеПостоянныеУпр,
	|	Себестоимость.ПостатейныеПеременныеУпр     	КАК ПостатейныеПеременныеУпр,
	|	Себестоимость.РезервПодОбесценениеУпр       КАК РезервПодОбесценениеУпр
	|ПОМЕСТИТЬ ВТОстаткиМалоценныхМЦ
	|ИЗ
	|	ВТОстаткиПредварительная КАК Себестоимость
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|			ПО Себестоимость.Организация = ДокументыРасчетаСебестоимости.Организация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО Себестоимость.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.КлючАналитики
	
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.НастройкиХозяйственныхОпераций КАК НастройкиХозяйственныхОпераций
	|			ПО НастройкиХозяйственныхОпераций.ХозяйственнаяОперация =
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыМалоценныхТМЦВМесяцеПриобретения)
	|
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПорядокОтраженияНаСчетахУчета КАК НастройкиПоМестуУчета
	|		ПО НастройкиПоМестуУчета.Организация = Себестоимость.Организация
	|			И НастройкиПоМестуУчета.АналитикаУчета = Себестоимость.ГруппаФинансовогоУчета
	|			И НастройкиПоМестуУчета.МестоУчета = АналитикаНоменклатуры.МестоХранения
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПорядокОтраженияНаСчетахУчета КАК НастройкиПоОрганизации
	|		ПО НастройкиПоОрганизации.Организация = Себестоимость.Организация
	|			И НастройкиПоОрганизации.АналитикаУчета = Себестоимость.ГруппаФинансовогоУчета
	|			И НастройкиПоОрганизации.МестоУчета = НЕОПРЕДЕЛЕНО
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПорядокОтраженияНаСчетахУчета КАК НастройкиПоАналитике
	|		ПО НастройкиПоАналитике.Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			И НастройкиПоАналитике.АналитикаУчета = Себестоимость.ГруппаФинансовогоУчета
	|			И НастройкиПоАналитике.МестоУчета = НЕОПРЕДЕЛЕНО
	|ГДЕ
	|	ЕСТЬNULL(НастройкиПоМестуУчета.ОтноситсяКМалоценнымТМЦ,
	|		ЕСТЬNULL(НастройкиПоОрганизации.ОтноситсяКМалоценнымТМЦ,
	|			ЕСТЬNULL(НастройкиПоАналитике.ОтноситсяКМалоценнымТМЦ, ЛОЖЬ)))
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
		
#Область СебестоимостьТоваров
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя,, Истина);
	ОписаниеВТ.ИмяВТРезультата = "ВтДвиженияСебестоимостьТоваров";
	ОписаниеВТ.ИмяВТИсточника = "ВТОстаткиМалоценныхМЦ";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти
		
#Область ПрочиеРасходы
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицы = "ВтДвиженияПрочиеРасходы";
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ОписаниеВТ.ИмяВТИсточника);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ОписаниеВТ.ИмяВТИсточника, ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти
		
#Область ДвиженияНоменклатураДоходыРасходы
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтДвиженияНоменклатураДоходыРасходы";
	ОписаниеВТ.ИмяВТИсточника = "ВТОстаткиМалоценныхМЦ";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
КонецПроцедуры
//-- Локализация

//-- НЕ УТ

Процедура РаспределитьОтклоненияВСтоимостиТоваров(ПараметрыРасчета)
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределитьОтклоненияВСтоимостиТоваров_СторноДвижения");

	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	#Область ФормированиеСторноДвижений
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	#Область ВтРеализацииПрошлыхПериодов
	Запрос.Текст = Запрос.Текст + "
	|ВЫБРАТЬ
	|	МИНИМУМ(ДД.Период) КАК Период,
	|	ДД.ДокументИсточник КАК ДокументРеализации,
	|	Реестр.ДатаДокументаИБ КАК ДатаДокументаИсточника,
	|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	ДД.КорАналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ДД.КорВидЗапасов КАК ВидЗапасов,
	|	ДД.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов КАК АналитикаРасходов,
	|	ДД.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	ДД.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	МИНИМУМ(ДД.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	СУММА(ДД.Количество) КАК Количество
	|
	|ПОМЕСТИТЬ ВтРеализацииПрошлыхПериодов
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = ДД.ДокументИсточник
	|		И НЕ Реестр.ДополнительнаяЗапись
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
	|	И ДД.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов)
	|	И ДД.Количество > 0
	|	И НЕ ДД.Сторно
	|СГРУППИРОВАТЬ ПО
	|	ДД.ДокументИсточник,
	|	Реестр.ДатаДокументаИБ,
	|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|	ДД.КорАналитикаУчетаНоменклатуры.Характеристика,
	|	ДД.КорВидЗапасов,
	|	ДД.СтатьяРасходовСписания,
	|	ДД.АналитикаРасходов,
	|	ДД.ХозяйственнаяОперация,
	|	ДД.НастройкаХозяйственнойОперации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	МИНИМУМ(ДД.Период) КАК Период,
	|	КорректировкаРеализации.Ссылка КАК ДокументРеализации,
	|	Реестр.ДатаДокументаИБ КАК ДатаДокументаИсточника,
	|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	ДД.КорАналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ДД.КорВидЗапасов КАК ВидЗапасов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	ДД.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	ДД.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	МИНИМУМ(ДД.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	СУММА(ДД.Количество) КАК Количество
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации КАК КорректировкаРеализации
	|		ПО КорректировкаРеализации.ДокументОснование = ДД.ДокументИсточник
	|		И НЕ КорректировкаРеализации.Ссылка = ДД.Регистратор
	|		И КорректировкаРеализации.Дата < &НачалоПериода
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК Реестр
	|		ПО Реестр.Ссылка = КорректировкаРеализации.Ссылка
	|		И НЕ Реестр.ДополнительнаяЗапись
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ВозвратПрошлыхПериодов)
	|	И ДД.ХозяйственнаяОперация В (&МассивОперацийВозвратыПрошлыхПериодов)
	|	И ДД.Количество > 0
	|	И НЕ ДД.Сторно
	|СГРУППИРОВАТЬ ПО
	|	КорректировкаРеализации.Ссылка,
	|	Реестр.ДатаДокументаИБ,
	|	ДД.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|	ДД.КорАналитикаУчетаНоменклатуры.Характеристика,
	|	ДД.КорВидЗапасов,
	|	ДД.ХозяйственнаяОперация,
	|	ДД.НастройкаХозяйственнойОперации
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ДокументРеализации
	|;";
	#КонецОбласти
	
	#Область ИсправленныеДокументы
	
	Запрос.Текст = Запрос.Текст + РасчетСебестоимостиЗаполнениеПартий.ТекстИсправленныеДокументы(); // вт ИсправленныеДокументы
	Запрос.Текст = Запрос.Текст + ОбщегоНазначения.РазделительПакетаЗапросов() + "
	|ВЫБРАТЬ
	|	МИНИМУМ(НАЧАЛОПЕРИОДА(Т.МинимальныйПериод, МЕСЯЦ)) КАК МинимальныйПериод
	|ИЗ (	
	|	ВЫБРАТЬ
	|		МИНИМУМ(Т.ДатаСторнируемогоДокумента) КАК МинимальныйПериод
	|	ИЗ
	|		ИсправленныеДокументы КАК Т
	|	ГДЕ
	|		Т.ДатаСторнируемогоДокумента <> ДАТАВРЕМЯ(1,1,1)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		МИНИМУМ(Т.ДатаДокументаИсточника) КАК МинимальныйПериод
	|	ИЗ
	|		ВтРеализацииПрошлыхПериодов КАК Т
	|	ГДЕ
	|		Т.ДатаДокументаИсточника <> ДАТАВРЕМЯ(1,1,1)
	|	) КАК Т
	|";

	#КонецОбласти
	
	РезультатЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,, Истина);
	Выборка = РезультатЗапроса.Выбрать();
	
	НачалоПериода = ПараметрыРасчета.РасчетныйПериод.НачалоПериода;
	Если Выборка.Следующий() Тогда
		МинимальныйПериод = ?(ЗначениеЗаполнено(Выборка.МинимальныйПериод), Выборка.МинимальныйПериод, НачалоПериода);
	Иначе
		МинимальныйПериод = НачалоПериода; 
	КонецЕсли;
	
	ДопПараметры = ПараметрыРасчета.ДополнительныеПараметрыЗапросаЭтапа;
	ДопПараметры.Вставить("МинимальныйПериод", МинимальныйПериод);
	ДопПараметры.Вставить("МинимальныйПрошлыйПериод", Мин(МинимальныйПериод, ПараметрыРасчета.РасчетныйПериод.КонецПредыдущегоПериода));
	
	Запрос.УстановитьПараметр("МинимальныйПериод", ДопПараметры.МинимальныйПериод);
	Запрос.УстановитьПараметр("МинимальныйПрошлыйПериод", ДопПараметры.МинимальныйПрошлыйПериод);
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ВтСторноОтклоненийПрошлогоПериода");
		
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстРаспределитьОтклоненияВСтоимостиТоваровВозвратыИСторноДвижения(ПараметрыРасчета));
		
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
		
	#КонецОбласти
	
	#Область ПодготовкаДанных
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределитьОтклоненияВСтоимостиТоваров_ПодготовкаДанных");
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ВтДвиженияСебестоимостиТоваровПоПериодам, ВтДвиженияСебестоимостиТоваровПоПериодамДетальные,
		|ВтОстаткиОтклоненийНаНачалоПериодаДетальные, ВТСвязиОтклоненийПредварительная,
		|ВтСвязиРаспределениеДопРасходов, ВтСвязиРаспределениеПостатейныхНаВыпуск,
		|ВТУзлыОтклонений, ВТСвязиОтклонений");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	#Область МинимальныйПериод
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	МИНИМУМ(НАЧАЛОПЕРИОДА(Т.МинимальныйПериод, МЕСЯЦ)) КАК МинимальныйПериод
	|ИЗ (
	|	ВЫБРАТЬ
	|		МИНИМУМ(Т.ПериодОтклонения) КАК МинимальныйПериод
	|	ИЗ
	|		ВТКэшРасчетныеОборотыОтклоненияВСтоимостиТоваров КАК Т
	|	ГДЕ
	|		Т.СлужебноеВидДвиженияПриход
	|		И Т.ПериодОтклонения <> ДАТАВРЕМЯ(1,1,1)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		МИНИМУМ(Т.ПериодОтклонения) КАК МинимальныйПериод
	|	ИЗ
	|		ВтСторноОтклоненийПрошлогоПериода КАК Т
	|	ГДЕ
	|		Т.ПериодОтклонения <> ДАТАВРЕМЯ(1,1,1)
	|) КАК Т
	|";
	
	РезультатЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,, Истина);
	Выборка = РезультатЗапроса.Выбрать();
	
	НачалоПериода = ПараметрыРасчета.РасчетныйПериод.НачалоПериода;
	Если Выборка.Следующий() Тогда
		МинимальныйПериод = ?(ЗначениеЗаполнено(Выборка.МинимальныйПериод), Выборка.МинимальныйПериод, НачалоПериода);
	Иначе
		МинимальныйПериод = НачалоПериода; 
	КонецЕсли;
	
	#КонецОбласти
	
	#Область ПоследниеНомераУзлов
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	МАКСИМУМ(ЕСТЬNULL(Т.НомерУзлаДопРасходы, 0)) КАК НомерУзлаДопРасходы,
	|	МАКСИМУМ(ЕСТЬNULL(Т.НомерУзлаПостатейные, 0)) КАК НомерУзлаПостатейные
	|ИЗ (
	|	ВЫБРАТЬ
	|		МАКСИМУМ(Т.НомерУзла) КАК НомерУзлаДопРасходы,
	|		0 КАК НомерУзлаПостатейные
	|	ИЗ
	|		УзлыКорректировкиДополнительныхРасходов КАК Т
	|
	//++ НЕ УТ
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		0 КАК НомерУзлаДопРасходы,
	|		МАКСИМУМ(Т.НомерУзла) КАК НомерУзлаПостатейные
	|	ИЗ
	|		ВтУзлыКорректировкиПостатейныеРасходыНЗП КАК Т
	//-- НЕ УТ
	|	) КАК Т
	|;
	|";
	РезультатЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,, Истина);
	Выборка = РезультатЗапроса.Выбрать();
	
	НачалоПериода = ПараметрыРасчета.РасчетныйПериод.НачалоПериода;
	Если Выборка.Следующий() Тогда
		ПоследнийНомерУзла = Макс(Выборка.НомерУзлаДопРасходы, Выборка.НомерУзлаПостатейные);
	Иначе
		ПоследнийНомерУзла = 0; 
	КонецЕсли;
	
	#КонецОбласти
	
	ДопПараметры = ПараметрыРасчета.ДополнительныеПараметрыЗапросаЭтапа;
	ДопПараметры.Вставить("МинимальныйПериод", МинимальныйПериод);
	ДопПараметры.Вставить("МинимальныйПрошлыйПериод", Мин(МинимальныйПериод, ПараметрыРасчета.РасчетныйПериод.КонецПредыдущегоПериода));
	ДопПараметры.Вставить("ПоследнийНомерУзла", ПоследнийНомерУзла);
	
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстРаспределитьОтклоненияВСтоимостиТоваровПодготовкаДанных(ПараметрыРасчета));
	
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
	
	#КонецОбласти
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВТУзлыОтклонений") = 0
	 И РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ВтСторноОтклоненийПрошлогоПериода") = 0 Тогда
		
		НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);	
		
		Возврат;
		
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределитьОтклоненияВСтоимостиТоваров_РешениеСЛУ");
	
	#Область ПодготовкаДанныхИРешениеСЛУ
	
	ЗапросУзлы = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(ЗапросУзлы, ПараметрыРасчета);
	
	#Область Узлы
	ЗапросУзлы.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзла,
	|	Т.ОтклоненияВСтоимостиСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл,
	|	Т.ОтклоненияВСтоимостиУпр,
	|	Т.ДопРасходыСНДС,
	|	Т.ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл,
	|	Т.ДопРасходыУпр,
	|	Т.НДСРегл,
	|	Т.НДСУпр,
	|	Т.ПостояннаяРазница,
	|	Т.СтоимостьНУ,
	|	Т.НДД
	|ИЗ
	|	ВТУзлыОтклонений КАК Т
	|УПОРЯДОЧИТЬ ПО
	|	НомерУзла
	|";
	#КонецОбласти
	
	ЗапросСвязи = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(ЗапросСвязи, ПараметрыРасчета);
	
	#Область Связи
	ЗапросСвязи.Текст =
	"ВЫБРАТЬ
	|	Т.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник КАК НомерУзлаПриемник,
	|	-Т.КоличествоСНДС КАК ВесСНДС,
	|	-Т.КоличествоБезНДС КАК ВесБезНДС,
	|	-Т.КоличествоРегл КАК ВесРегл,
	|	-Т.КоличествоНУ КАК ВесНУ,
	|	-Т.КоличествоУпр КАК ВесУпр
	|ИЗ
	|	ВТСвязиОтклонений КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.НомерУзла КАК НомерУзлаИсточник,
	|	Т.НомерУзла КАК НомерУзлаПриемник,
	|	СУММА(Т.ВесСНДС) КАК ВесСНДС,
	|	СУММА(Т.ВесБезНДС) КАК ВесБезНДС,
	|	СУММА(Т.ВесРегл) КАК ВесРегл,
	|	СУММА(Т.ВесНУ) КАК ВесНУ,
	|	СУММА(Т.ВесУпр) КАК ВесУпр
	|ИЗ (
	|	ВЫБРАТЬ
	|		Т.НомерУзла,
	|		Т.КоличествоСНДС КАК ВесСНДС,
	|		Т.КоличествоБезНДС КАК ВесБезНДС,
	|		Т.КоличествоРегл КАК ВесРегл,
	|		Т.КоличествоНУ КАК ВесНУ,
	|		Т.КоличествоУпр КАК ВесУпр
	|	ИЗ
	|		ВТУзлыОтклонений КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	// Уменьшим начальное количества в узле при встречных перемещениях в один и тот же узел.
	// Актуально при отключенном учете отклонений по местам хранения. 
	|	ВЫБРАТЬ
	|		Т.НомерУзлаИсточник,
	|		-Т.КоличествоСНДС КАК ВесСНДС,
	|		-Т.КоличествоБезНДС КАК ВесБезНДС,
	|		-Т.КоличествоРегл КАК ВесРегл,
	|		-Т.КоличествоНУ КАК ВесНУ,
	|		-Т.КоличествоУпр КАК ВесУпр
	|	ИЗ
	|		ВТСвязиОтклоненийПредварительная КАК Т
	|	ГДЕ
	|		Т.НомерУзлаИсточник = Т.НомерУзлаПриемник
	|	) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерУзла
	|";
	#КонецОбласти
	
	#Область РешениеСЛУОбщаяЧасть
	
	ПояснениеДляЗамера = НСтр("ru = 'Решение для отклонений';
								|en = 'Solution for variances'", ОбщегоНазначения.КодОсновногоЯзыка());
	
	ПараметрыРасчета.Вставить("ОптимизироватьСЛУ", Истина);
	
	// корректируем стоимости узлов с нулевым весом
	СтруктураПолейСЛУ = Новый Структура;
	СтруктураПолейСЛУ.Вставить("ВесСНДС", "ОтклоненияВСтоимостиСНДС, ДопРасходыСНДС");
	СтруктураПолейСЛУ.Вставить("ВесБезНДС", "ОтклоненияВСтоимостиБезНДС, ДопРасходыБезНДС");
	СтруктураПолейСЛУ.Вставить("ВесУпр", "ОтклоненияВСтоимостиУпр, ДопРасходыУпр, НДСУпр");
	СтруктураПолейСЛУ.Вставить("ВесРегл", "ОтклоненияВСтоимостиРегл, ДопРасходыРегл, НДСРегл, ПостояннаяРазница");
	СтруктураПолейСЛУ.Вставить("ВесНУ", "СтоимостьНУ, НДД");

	РасчетСебестоимостиПрикладныеАлгоритмы.СкорректироватьСтоимостьУзловСЛУИзЗапросов(
		ПараметрыРасчета,
		ЗапросУзлы,
		"НомерУзла",
		ЗапросСвязи,
		"НомерУзлаИсточник, НомерУзлаПриемник",
		СтруктураПолейСЛУ,
		ПояснениеДляЗамера);
		
	ПараметрыРасчета.Вставить("ОптимизироватьСЛУ", Ложь);
		
	МатрицаУзлов  = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, ЗапросУзлы,,, Истина, ПояснениеДляЗамера + ", " + НСтр("ru = 'узлы';
																																										|en = 'nodes'", ОбщегоНазначения.КодОсновногоЯзыка()));
	МатрицаСвязей = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, ЗапросСвязи,,, Истина, ПояснениеДляЗамера + ", " + НСтр("ru = 'связи';
																																										|en = 'links'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	ФорматВыгрузки = СокрЛП(НРег(ПараметрыРасчета.ВыгрузкаДанныхРасчета.ФорматСохраненияДанныхСЛУ));
	ИмяКаталога = СокрЛП(ПараметрыРасчета.ВыгрузкаДанныхРасчета.КаталогДляСохраненияДанныхСЛУ);
 	Если ФорматВыгрузки = "txt" И ЗначениеЗаполнено(ИмяКаталога) Тогда  
		
		ИмяКаталога = ОбщегоНазначенияКлиентСервер.ДобавитьКонечныйРазделительПути(ИмяКаталога);
			
		ТаблицаУзлов = МатрицаУзлов.Выгрузить();
		ИмяФайла = ИмяКаталога + "ИсточникДанныхУзлов_ОтклоненияВСтоимостиТоваров.txt";
		ЗначениеВФайл(ИмяФайла, ТаблицаУзлов);
			
		ТаблицаСвязей = МатрицаСвязей.Выгрузить();
		ИмяФайла = ИмяКаталога + "ИсточникДанныхСвязей_ОтклоненияВСтоимостиТоваров.txt";
		ЗначениеВФайл(ИмяФайла, ТаблицаСвязей);
		
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоВыполненияФрагментаКода(ПараметрыРасчета, "РассчитатьСистемыЛинейныхУравненийУпрСНДС", ПояснениеДляЗамера);
	РасчетСистемЛинейныхУравнений = РасчетСебестоимостиРешениеСЛУ.ПолучитьКомпонентуДляРешенияСЛУ(ПараметрыРасчета);
	
	РасчетСистемЛинейныхУравнений.ИсточникДанныхУзлов = МатрицаУзлов;
	РасчетСистемЛинейныхУравнений.ИсточникДанныхСвязей = МатрицаСвязей;
	
	// описание ключевых колонок
	РасчетСистемЛинейныхУравнений.КолонкаУравненияВУзлах = "НомерУзла";
	РасчетСистемЛинейныхУравнений.КолонкаУравненияВСвязях = "НомерУзлаПриемник";
	РасчетСистемЛинейныхУравнений.КолонкаПеременныеВСвязях = "НомерУзлаИсточник";
	
	#КонецОбласти
	
	#Область РешениеСЛУ_УправленческийУчетСНДС
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ОтклоненияВСтоимостиСНДС";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесСНДС";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ДопРасходыСНДС";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесСНДС";
	
	// решение
	ТаблицаРешенийСНДС = РасчетСистемЛинейныхУравнений.РассчитатьСистемыЛинейныхУравнений(НЕ ПараметрыРасчета.ОтключитьРедуцированиеГрафа);
	РасчетСебестоимостиПротоколРасчета.ОкончаниеВыполненияФрагментаКода(ПараметрыРасчета);

	// Загрузка решений во временную таблицу.
	ИменаКолонокРешений = "ОтклоненияВСтоимостиСНДС, ДопРасходыСНДС";
	
	ПараметрыЗагрузкиСЛУ = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗагрузкиРешенияСЛУ(ИменаКолонокРешений);
	ПараметрыЗагрузкиСЛУ.ЧислоРазрядов = 31;
	ПараметрыЗагрузкиСЛУ.УчитыватьНулевыеРешения = Ложь;
	ПараметрыЗагрузкиСЛУ.ИмяВременнойТаблицы = "ТаблицаРешенийСНДС";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗагрузитьРешениеСЛУВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыЗагрузкиСЛУ,
		ТаблицаРешенийСНДС,
		ПояснениеДляЗамера);
	
	#КонецОбласти
	
	#Область РешениеСЛУ_УправленческийУчетБезНДС
	
	РасчетСебестоимостиПротоколРасчета.НачалоВыполненияФрагментаКода(ПараметрыРасчета, "РассчитатьСистемыЛинейныхУравненийУпрБезНДС", ПояснениеДляЗамера);
	
	// сброс для следующего набора описаний
	РасчетСистемЛинейныхУравнений.ОписанияСистем.Очистить();
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ОтклоненияВСтоимостиБезНДС";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесБезНДС";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ДопРасходыБезНДС";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесБезНДС";
	
	// решение
	ТаблицаРешенийБезНДС = РасчетСистемЛинейныхУравнений.РассчитатьСистемыЛинейныхУравнений(НЕ ПараметрыРасчета.ОтключитьРедуцированиеГрафа);
	РасчетСебестоимостиПротоколРасчета.ОкончаниеВыполненияФрагментаКода(ПараметрыРасчета);
	
	// Загрузка решений во временную таблицу.
	ИменаКолонокРешений = "ОтклоненияВСтоимостиБезНДС, ДопРасходыБезНДС";
	
	ПараметрыЗагрузкиСЛУ = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗагрузкиРешенияСЛУ(ИменаКолонокРешений);
	ПараметрыЗагрузкиСЛУ.ЧислоРазрядов = 31;
	ПараметрыЗагрузкиСЛУ.УчитыватьНулевыеРешения = Ложь;
	ПараметрыЗагрузкиСЛУ.ИмяВременнойТаблицы = "ТаблицаРешенийБезНДС";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗагрузитьРешениеСЛУВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыЗагрузкиСЛУ,
		ТаблицаРешенийБезНДС,
		ПояснениеДляЗамера);
	
	#КонецОбласти
	
	#Область РешениеСЛУ_УправленческийУчетОрганизаций
	
	РасчетСебестоимостиПротоколРасчета.НачалоВыполненияФрагментаКода(ПараметрыРасчета, "РассчитатьСистемыЛинейныхУравненийУпр", ПояснениеДляЗамера);
	
	// сброс для следующего набора описаний
	РасчетСистемЛинейныхУравнений.ОписанияСистем.Очистить();
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ОтклоненияВСтоимостиУпр";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесУпр";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ДопРасходыУпр";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесУпр";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "НДСУпр";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесУпр";
	
	// решение
	ТаблицаРешенийУпр = РасчетСистемЛинейныхУравнений.РассчитатьСистемыЛинейныхУравнений(НЕ ПараметрыРасчета.ОтключитьРедуцированиеГрафа);
	РасчетСебестоимостиПротоколРасчета.ОкончаниеВыполненияФрагментаКода(ПараметрыРасчета);

	// Загрузка решений во временную таблицу.
	ИменаКолонокРешений = "ОтклоненияВСтоимостиУпр, ДопРасходыУпр, НДСУпр";
	
	ПараметрыЗагрузкиСЛУ = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗагрузкиРешенияСЛУ(ИменаКолонокРешений);
	ПараметрыЗагрузкиСЛУ.ЧислоРазрядов = 31;
	ПараметрыЗагрузкиСЛУ.УчитыватьНулевыеРешения = Ложь;
	ПараметрыЗагрузкиСЛУ.ИмяВременнойТаблицы = "ТаблицаРешенийУпр";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗагрузитьРешениеСЛУВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыЗагрузкиСЛУ,
		ТаблицаРешенийУпр,
		ПояснениеДляЗамера);
		
	#КонецОбласти
	
	#Область РешениеСЛУ_Регл
	
	РасчетСебестоимостиПротоколРасчета.НачалоВыполненияФрагментаКода(ПараметрыРасчета, "РассчитатьСистемыЛинейныхУравненийРегл", ПояснениеДляЗамера);
	
	// сброс для следующего набора описаний
	РасчетСистемЛинейныхУравнений.ОписанияСистем.Очистить();
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ОтклоненияВСтоимостиРегл";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесРегл";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ДопРасходыРегл";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесРегл";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "НДСРегл";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесРегл";
	
	// решение
	ТаблицаРешенийРегл = РасчетСистемЛинейныхУравнений.РассчитатьСистемыЛинейныхУравнений(НЕ ПараметрыРасчета.ОтключитьРедуцированиеГрафа);
	РасчетСебестоимостиПротоколРасчета.ОкончаниеВыполненияФрагментаКода(ПараметрыРасчета);

	// Загрузка решений во временную таблицу.
	ИменаКолонокРешений = "ОтклоненияВСтоимостиРегл, ДопРасходыРегл, НДСРегл";
	
	ПараметрыЗагрузкиСЛУ = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗагрузкиРешенияСЛУ(ИменаКолонокРешений);
	ПараметрыЗагрузкиСЛУ.ЧислоРазрядов = 31;
	ПараметрыЗагрузкиСЛУ.УчитыватьНулевыеРешения = Ложь;
	ПараметрыЗагрузкиСЛУ.ИмяВременнойТаблицы = "ТаблицаРешенийРегл";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗагрузитьРешениеСЛУВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыЗагрузкиСЛУ,
		ТаблицаРешенийРегл,
		ПояснениеДляЗамера);
		
	#КонецОбласти

	#Область РешениеСЛУ_НУ
	
	РасчетСебестоимостиПротоколРасчета.НачалоВыполненияФрагментаКода(ПараметрыРасчета, "РассчитатьСистемыЛинейныхУравненийНУ", ПояснениеДляЗамера);
	
	// сброс для следующего набора описаний
	РасчетСистемЛинейныхУравнений.ОписанияСистем.Очистить();
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "СтоимостьНУ";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесНУ";
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "НДД";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесНУ";
	
	// решение
	ТаблицаРешенийНУ = РасчетСистемЛинейныхУравнений.РассчитатьСистемыЛинейныхУравнений(НЕ ПараметрыРасчета.ОтключитьРедуцированиеГрафа);
	РасчетСебестоимостиПротоколРасчета.ОкончаниеВыполненияФрагментаКода(ПараметрыРасчета);

	// Загрузка решений во временную таблицу.
	ИменаКолонокРешений = "СтоимостьНУ, НДД";
	
	ПараметрыЗагрузкиСЛУ = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗагрузкиРешенияСЛУ(ИменаКолонокРешений);
	ПараметрыЗагрузкиСЛУ.ЧислоРазрядов = 31;
	ПараметрыЗагрузкиСЛУ.УчитыватьНулевыеРешения = Ложь;
	ПараметрыЗагрузкиСЛУ.ИмяВременнойТаблицы = "ТаблицаРешенийНУ";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗагрузитьРешениеСЛУВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыЗагрузкиСЛУ,
		ТаблицаРешенийНУ,
		ПояснениеДляЗамера);
		
	#КонецОбласти
	
	#Область Узлы_ПостояннаяРазница
	ЗапросУзлы.Текст = "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	0 КАК НомерУзла,
	|	0 КАК ПостояннаяРазница
	|
	|ПОМЕСТИТЬ НачальнаяСтоимостьПостояннаяРазница
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	УзлыКорректировки.НомерУзла КАК НомерУзла,
	|
	// Постоянная разница по расходам, не принимаемым к налоговому учету.
	|	ВЫРАЗИТЬ(СУММА(ВЫБОР
	|		КОГДА ЕСТЬNULL(НЕ УзлыКорректировки.СтатьяРасходов.ПринятиеКНалоговомуУчету, ЛОЖЬ)
	|			ТОГДА ЕСТЬNULL(ТаблицаРешений.СтоимостьНУ, 0)
	|				* ЕСТЬNULL(ПеремещенияСписания.КоличествоНУ, 0)
	|		ИНАЧЕ 0 КОНЕЦ) КАК ЧИСЛО(28,10)) КАК ПостояннаяРазница
	|ИЗ
	|	ВтУзлыКорректировкиПостатейныеРасходыНЗП КАК УзлыКорректировки
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСвязиОтклонений КАК ПеремещенияСписания
	|		ПО УзлыКорректировки.НомерУзла = ПеремещенияСписания.НомерУзлаПриемник
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийНУ КАК ТаблицаРешений
	|		ПО ТаблицаРешений.НомерУзла = ПеремещенияСписания.НомерУзлаИсточник
	|ГДЕ
	|	УзлыКорректировки.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	И НЕ ПеремещенияСписания.НомерУзлаПриемник ЕСТЬ NULL
	|	И НЕ ПеремещенияСписания.НомерУзлаИсточник ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО
	|	УзлыКорректировки.НомерУзла
	//-- НЕ УТ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	УзлыКорректировки.НомерУзла КАК НомерУзла,
	|
	// Постоянная разница по расходам, не принимаемым к налоговому учету.
	|	ВЫРАЗИТЬ(СУММА(ВЫБОР
	|		КОГДА ЕСТЬNULL(НЕ УзлыКорректировки.СтатьяРасходов.ПринятиеКНалоговомуУчету, ЛОЖЬ)
	|			ТОГДА ЕСТЬNULL(ТаблицаРешений.СтоимостьНУ, 0)
	|				* ЕСТЬNULL(ПеремещенияСписания.КоличествоНУ, 0)
	|		ИНАЧЕ 0 КОНЕЦ) КАК ЧИСЛО(28,10)) КАК ПостояннаяРазница
	|ИЗ
	|	УзлыКорректировкиДополнительныхРасходов КАК УзлыКорректировки
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТСвязиОтклонений КАК ПеремещенияСписания
	|		ПО УзлыКорректировки.НомерУзла = ПеремещенияСписания.НомерУзлаПриемник
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийНУ КАК ТаблицаРешений
	|		ПО ТаблицаРешений.НомерУзла = ПеремещенияСписания.НомерУзлаИсточник
	|ГДЕ
	|	НЕ ПеремещенияСписания.НомерУзлаПриемник ЕСТЬ NULL
	|	И НЕ ПеремещенияСписания.НомерУзлаИсточник ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО
	|	УзлыКорректировки.НомерУзла
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;
	|ВЫБРАТЬ
	|	Т.НомерУзла КАК НомерУзла,
	|	ВЫРАЗИТЬ(ЕСТЬNULL(Т.ПостояннаяРазница, 0)
	|		+ ЕСТЬNULL(НачальнаяСтоимость.ПостояннаяРазница, 0) КАК ЧИСЛО(28, 10)) КАК ПостояннаяРазница
	|ИЗ
	|	ВТУзлыОтклонений КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ НачальнаяСтоимостьПостояннаяРазница КАК НачальнаяСтоимость
	|		ПО НачальнаяСтоимость.НомерУзла = Т.НомерУзла
	|УПОРЯДОЧИТЬ ПО
	|	НомерУзла
	|";
	#КонецОбласти
	
	МатрицаУзлов  = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, ЗапросУзлы,,, Истина, ПояснениеДляЗамера + ", " + НСтр("ru = 'узлы';
																																										|en = 'nodes'", ОбщегоНазначения.КодОсновногоЯзыка()));
	РасчетСистемЛинейныхУравнений.ИсточникДанныхУзлов = МатрицаУзлов;

	#Область РешениеСЛУ_ПостояннаяРазница
	
	РасчетСебестоимостиПротоколРасчета.НачалоВыполненияФрагментаКода(ПараметрыРасчета, "РассчитатьСистемыЛинейныхУравненийРегл", ПояснениеДляЗамера);
	
	// сброс для следующего набора описаний
	РасчетСистемЛинейныхУравнений.ОписанияСистем.Очистить();
	
	ОписаниеСистемы = РасчетСистемЛинейныхУравнений.ОписанияСистем.Добавить();
	ОписаниеСистемы.КолонкаКоэффициентовВУзлах = "ПостояннаяРазница";
	ОписаниеСистемы.КолонкаКоэффициентовВСвязях = "ВесРегл";
	
	// решение
	ТаблицаРешенийПР = РасчетСистемЛинейныхУравнений.РассчитатьСистемыЛинейныхУравнений(НЕ ПараметрыРасчета.ОтключитьРедуцированиеГрафа);
	РасчетСебестоимостиПротоколРасчета.ОкончаниеВыполненияФрагментаКода(ПараметрыРасчета);

	// Загрузка решений во временную таблицу.
	ИменаКолонокРешений = "ПостояннаяРазница";
	
	ПараметрыЗагрузкиСЛУ = РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПараметрыЗагрузкиРешенияСЛУ(ИменаКолонокРешений);
	ПараметрыЗагрузкиСЛУ.ЧислоРазрядов = 31;
	ПараметрыЗагрузкиСЛУ.УчитыватьНулевыеРешения = Ложь;
	ПараметрыЗагрузкиСЛУ.ИмяВременнойТаблицы = "ТаблицаРешенийПР";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗагрузитьРешениеСЛУВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыЗагрузкиСЛУ,
		ТаблицаРешенийПР,
		ПояснениеДляЗамера);
		
	#КонецОбласти
	
	#КонецОбласти

	#Область ТаблицаИдентификаторов
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник
	|ИЗ
	|	ВТСвязиОтклонений КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ УзлыКорректировкиДополнительныхРасходов КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзла = Т.НомерУзлаИсточник
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник
	|ИЗ
	|	ВтТаблицаСвязейПостатейныеРасходы КАК Т
	//-- НЕ УТ
	|";
	
	ТаблицаИдентификаторов = Новый ТаблицаЗначений;
	ТаблицаИдентификаторов.Колонки.Добавить("Идентификатор", ОбщегоНазначения.ОписаниеТипаСтрока(36));
	ТаблицаИдентификаторов.Колонки.Добавить("НомерУзлаИсточник", ОбщегоНазначения.ОписаниеТипаЧисло(31));
	ТаблицаИдентификаторов.Колонки.Добавить("НомерУзлаПриемник", ОбщегоНазначения.ОписаниеТипаЧисло(31));
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = ТаблицаИдентификаторов.Добавить();
		НоваяСтрока.Идентификатор = Новый УникальныйИдентификатор;
		НоваяСтрока.НомерУзлаИсточник = Выборка.НомерУзлаИсточник;
		НоваяСтрока.НомерУзлаПриемник = Выборка.НомерУзлаПриемник;
	КонецЦикла;
	
	#КонецОбласти
		
	#Область ФормированиеДвижений
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределитьОтклоненияВСтоимостиТоваров_ФормированиеДвижений");
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ВтДвиженияОтклонения, ВтДвиженияВыручка, ВтДвиженияПрочиеРасходы, 
		|ВтДвиженияПрочиеРасходыНезавершенногоПроизводства, ВтДвиженияПрочиеАктивыПассивы");
		
	ДопПараметры = ПараметрыРасчета.ДополнительныеПараметрыЗапросаЭтапа;
	ДопПараметры.Вставить("МинимальныйПрошлыйПериод", Мин(МинимальныйПериод, ПараметрыРасчета.РасчетныйПериод.КонецПредыдущегоПериода));
	ДопПараметры.Вставить("ТаблицаИдентификаторов", ТаблицаИдентификаторов);
		
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстРаспределитьОтклоненияВСтоимостиТоваровФормированиеДвижений(ПараметрыРасчета));
		
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
		
	#КонецОбласти
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	#Область СохранениеДвижений_ОтклоненияВСтоимостиТоваров
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ОтклоненияВСтоимостиТоваров.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяТаблицыИсточника = "ВтДвиженияОтклонения";
	ИмяТаблицыПриемника = "ВТДанныеОтклонения";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, ИмяТаблицыИсточника, 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		ИмяТаблицыИсточника,
		ИмяТаблицыПриемника);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяТаблицыПриемника, ИмяРегистра);
	
	#КонецОбласти

	#Область СохранениеДвижений_ВыручкаИСебестоимостьПродаж
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяТаблицыИсточника = "ВтДвиженияВыручка";
	ИмяТаблицыПриемника = "ВТДанныеВыручка";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, ИмяТаблицыИсточника, 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		ИмяТаблицыИсточника,
		ИмяТаблицыПриемника);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяТаблицыПриемника, ИмяРегистра);
	
	#КонецОбласти

	#Область СохранениеДвижений_ПрочиеРасходы
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяТаблицыИсточника = "ВтДвиженияПрочиеРасходы";
	ИмяТаблицыПриемника = "ВТДанныеПрочиеРасходы";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, ИмяТаблицыИсточника, 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		ИмяТаблицыИсточника,
		ИмяТаблицыПриемника);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяТаблицыПриемника, ИмяРегистра);
	
	#КонецОбласти

	//++ НЕ УТ

	#Область СохранениеДвижений_ПрочиеРасходыНезавершенногоПроизводства
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяТаблицыИсточника = "ВтДвиженияПрочиеРасходыНезавершенногоПроизводства";
	ИмяТаблицыПриемника = "ВТДанныеПрочиеРасходыНезавершенногоПроизводства";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, ИмяТаблицыИсточника, 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		ИмяТаблицыИсточника,
		ИмяТаблицыПриемника);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяТаблицыПриемника, ИмяРегистра);
	
	#КонецОбласти

	//-- НЕ УТ

	#Область СохранениеДвижений_ПрочиеАктивыПассивы
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяТаблицыИсточника = "ВтДвиженияПрочиеАктивыПассивы";
	ИмяТаблицыПриемника = "ВТДанныеПрочиеАктивыПассивы";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, ИмяТаблицыИсточника, 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		ИмяТаблицыИсточника,
		ИмяТаблицыПриемника);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяТаблицыПриемника, ИмяРегистра);
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияПоПрочимАктивамПассивам.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяТаблицыИсточника = "ВтДвиженияПрочиеАктивыПассивы";
	ИмяТаблицыПриемника = "ВТДанныеДвиженияПоПрочимАктивамПассивам";
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, ИмяТаблицыИсточника, 0));
	
	КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
		ПараметрыРасчета,
		ТаблицаОписанияПолей,
		ИмяРегистра,
		ИмяТаблицыИсточника,
		ИмяТаблицыПриемника);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяТаблицыПриемника, ИмяРегистра);
	
	#КонецОбласти

	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);	
		
КонецПроцедуры

Функция ТекстРаспределитьОтклоненияВСтоимостиТоваровВозвратыИСторноДвижения(ПараметрыРасчета)
	
	ТекстЗапроса = "";
	
	#Область ВтАналитикаИсправленныхДокументов // использует ВтРеализацииПрошлыхПериодов
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК ПериодОтклонения,
	|	МИНИМУМ(ИсправленныеДокументы.Период) КАК Период,
	// Условия заполнения поля ЕстьКорЧасть должны соответствовать функции ТекстРаспределитьОтклоненияВСтоимостиТоваровПодготовкаДанных()
	// #Область ВтДвиженияСебестоимостиТоваровПоПериодам
	|	ВЫБОР
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.Номенклатура ЕСТЬ NULL
	|		 ИЛИ Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		 ИЛИ Т.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ КАК ЕстьКорЧасть,
	// Измерения
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация КАК КорОрганизация,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК КорНоменклатура,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК КорХарактеристика,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК КорПодразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.МестоХранения, НЕОПРЕДЕЛЕНО)
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорМестоХранения,
	// Прочее
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперацияВозврата,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперацииВозврата,
	|	ИСТИНА КАК Сторно,
	|	МАКСИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	СУММА(Т.Количество) КАК Количество
	|
	|ПОМЕСТИТЬ ВтАналитикаИсправленныхДокументовИВозвратов
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.СторнируемыйДокумент = Т.Регистратор
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСреднескользящая)
	|	И Т.Период МЕЖДУ &МинимальныйПрошлыйПериод И &КонецПредыдущегоПериода
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НЕ Т.РазделУчета В (
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
	|	И Т.Количество <> 0
	|	И Т.Активность
	|	И НЕ Т.Сторно
	|
	|СГРУППИРОВАТЬ ПО
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ), // ПериодОтклонения
	|	ВЫБОР
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.Номенклатура ЕСТЬ NULL
	|		 ИЛИ Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		 ИЛИ Т.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ, // ЕстьКорЧасть
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // РазделУчета
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	Т.ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // НаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // Подразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // МестоХранения
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)),
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)),
	|	Т.КорВидЗапасов,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // КорНаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // КорПодразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.МестоХранения, НЕОПРЕДЕЛЕНО)
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // КорМестоХранения
	// Прочее
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК ПериодОтклонения,
	|	МИНИМУМ(Прошлые.Период) КАК Период,
	// Условия заполнения поля ЕстьКорЧасть должны соответствовать функции ТекстРаспределитьОтклоненияВСтоимостиТоваровПодготовкаДанных()
	// #Область ВтДвиженияСебестоимостиТоваровПоПериодам
	|	ВЫБОР
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.Номенклатура ЕСТЬ NULL
	|		 ИЛИ Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		 ИЛИ Т.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ КАК ЕстьКорЧасть,
	// Измерения
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация КАК КорОрганизация,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК КорНоменклатура,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК КорХарактеристика,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК КорПодразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.МестоХранения, НЕОПРЕДЕЛЕНО)
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорМестоХранения,
	// Прочее
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	МАКСИМУМ(Прошлые.ХозяйственнаяОперация) КАК ХозяйственнаяОперацияВозврата,
	|	МАКСИМУМ(Прошлые.НастройкаХозяйственнойОперации) КАК НастройкаХозяйственнойОперацииВозврата,
	|	ЛОЖЬ КАК Сторно,
	|	МИНИМУМ(Прошлые.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	МИНИМУМ(Прошлые.Количество) КАК Количество
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРеализацииПрошлыхПериодов КАК Прошлые
	|		ПО Т.Регистратор = Прошлые.ДокументРеализации
	|		И Т.АналитикаУчетаНоменклатуры.Номенклатура = Прошлые.Номенклатура
	|		И Т.АналитикаУчетаНоменклатуры.Характеристика = Прошлые.Характеристика
	|		И Т.ВидЗапасов = Прошлые.ВидЗапасов
	|		И Т.СтатьяРасходовСписания = Прошлые.СтатьяРасходовСписания
	|		И Т.АналитикаРасходов = Прошлые.АналитикаРасходов
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСреднескользящая)
	|	И Т.Период МЕЖДУ &МинимальныйПрошлыйПериод И &КонецПредыдущегоПериода
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.Количество <> 0
	|	И (Т.АналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)
	|		ИЛИ Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
	|	И Т.Активность
	|	И НЕ Т.Сторно
	|
	|СГРУППИРОВАТЬ ПО
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ), // ПериодОтклонения
	|	ВЫБОР
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.Номенклатура ЕСТЬ NULL
	|		 ИЛИ Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		 ИЛИ Т.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ, // ЕстьКорЧасть
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // РазделУчета
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	Т.ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // НаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // Подразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // МестоХранения
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура, ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)),
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика, ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)),
	|	Т.КорВидЗапасов,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // КорНаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // КорПодразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.МестоХранения, НЕОПРЕДЕЛЕНО)
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // КорМестоХранения
	// Прочее
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Номенклатура,
	|	Характеристика,
	|	ВидЗапасов,
	|	НаправлениеДеятельности,
	|	Подразделение,
	|	МестоХранения
	|;	
	|";
	#КонецОбласти

	#Область ВтОтклоненияПрошлыхПериодов
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Аналитики.Период,
	|	Аналитики.ЕстьКорЧасть,
	// Измерения
	|	Аналитики.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Аналитики.ПериодОтклонения КАК ПериодОтклонения,
	// Кор реквизиты
	|	Аналитики.КорОрганизация КАК КорОрганизация,
	|	Аналитики.КорНоменклатура КАК КорНоменклатура,
	|	Аналитики.КорХарактеристика КАК КорХарактеристика,
	|	Аналитики.КорВидЗапасов КАК КорВидЗапасов,
	|	Аналитики.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Аналитики.КорПодразделение КАК КорПодразделение,
	|	Аналитики.КорМестоХранения КАК КорМестоХранения,
	// Прочее
	|	Аналитики.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Аналитики.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Аналитики.АналитикаРасходов КАК АналитикаРасходов,
	|	Аналитики.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Аналитики.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Аналитики.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Аналитики.ХозяйственнаяОперацияВозврата КАК ХозяйственнаяОперация,
	|	Аналитики.НастройкаХозяйственнойОперацииВозврата КАК НастройкаХозяйственнойОперации,
	|	Аналитики.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	Аналитики.Количество КАК КоличествоПоДокументу,
	|	Аналитики.Сторно КАК Сторно,
	|	СУММА(Т.ОтклоненияВСтоимостиСНДС) КАК ОтклоненияВСтоимостиСНДС,
	|	СУММА(Т.ОтклоненияВСтоимостиБезНДС) КАК ОтклоненияВСтоимостиБезНДС,
	|	СУММА(Т.ОтклоненияВСтоимостиРегл) КАК ОтклоненияВСтоимостиРегл,
	|	СУММА(Т.ОтклоненияВСтоимостиУпр) КАК ОтклоненияВСтоимостиУпр,
	|	СУММА(Т.ДопРасходыСНДС) КАК ДопРасходыСНДС,
	|	СУММА(Т.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(Т.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Т.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр,
	|	СУММА(Т.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(Т.НДД) КАК НДД,
	|	СУММА(Т.Количество) КАК Количество
	|
	|ПОМЕСТИТЬ ВтОтклоненияПрошлыхПериодов
	|ИЗ
	|	ВтАналитикаИсправленныхДокументовИВозвратов КАК Аналитики
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ОтклоненияВСтоимостиТоваров КАК Т
	|		ПО Аналитики.ПериодОтклонения = НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ)
	// Измерения
	|		И Аналитики.Организация = Т.Организация
	|		И Аналитики.Номенклатура = Т.Номенклатура
	|		И Аналитики.Характеристика = Т.Характеристика
	|		И Аналитики.ВидЗапасов = Т.ВидЗапасов
	|		И Аналитики.НаправлениеДеятельности = Т.НаправлениеДеятельности
	|		И Аналитики.Подразделение = Т.Подразделение
	|		И Аналитики.МестоХранения = Т.МестоХранения
	// Реквизиты
	|		И Аналитики.ХозяйственнаяОперация = Т.ХозяйственнаяОперация
	|ГДЕ
	|	Т.Период МЕЖДУ &МинимальныйПрошлыйПериод И &КонецПредыдущегоПериода
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.Активность
	|	И НЕ Т.Сторно
	|
	|СГРУППИРОВАТЬ ПО
	|	Аналитики.Период,
	|	Аналитики.ЕстьКорЧасть,
	|	Аналитики.РазделУчета,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Аналитики.ПериодОтклонения,
	// Кор реквизиты
	|	Аналитики.КорОрганизация,
	|	Аналитики.КорНоменклатура,
	|	Аналитики.КорХарактеристика,
	|	Аналитики.КорВидЗапасов,
	|	Аналитики.КорНаправлениеДеятельности,
	|	Аналитики.КорПодразделение,
	|	Аналитики.КорМестоХранения,
	// Прочее
	|	Аналитики.АналитикаУчетаПоПартнерам,
	|	Аналитики.СтатьяРасходовСписания,
	|	Аналитики.АналитикаРасходов,
	|	Аналитики.СтатьяАктивовПассивов,
	|	Аналитики.АналитикаАктивовПассивов,
	|	Аналитики.НастройкаСчетовУчета,
	|	Аналитики.ХозяйственнаяОперацияВозврата,
	|	Аналитики.НастройкаХозяйственнойОперацииВозврата,
	|	Аналитики.ИдентификаторФинЗаписи,
	|	Аналитики.Количество,
	|	Аналитики.Сторно
	|;	
	|";

	#КонецОбласти
	
	#Область ВтСторноОтклоненийПрошлогоПериода
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Регистраторы.Ссылка КАК Регистратор,
	|	Т.ЕстьКорЧасть,
	// Измерения
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.ПериодОтклонения КАК ПериодОтклонения,
	// Кор реквизиты
	|	Т.КорОрганизация КАК КорОрганизация,
	|	Т.КорНоменклатура КАК КорНоменклатура,
	|	Т.КорХарактеристика КАК КорХарактеристика,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Т.КорПодразделение КАК КорПодразделение,
	|	Т.КорМестоХранения КАК КорМестоХранения,
	// Прочее
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	Т.Сторно КАк Сторно,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	|	(ВЫБОР КОГДА Т.Сторно ТОГДА -1 ИНАЧЕ 1 КОНЕЦ) КАК Знак,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ОтклоненияВСтоимостиСНДС
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ОтклоненияВСтоимостиСНДС / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ОтклоненияВСтоимостиСНДС,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ОтклоненияВСтоимостиБезНДС
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ОтклоненияВСтоимостиБезНДС / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ОтклоненияВСтоимостиБезНДС,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ОтклоненияВСтоимостиРегл
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ОтклоненияВСтоимостиРегл / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ОтклоненияВСтоимостиРегл,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ОтклоненияВСтоимостиУпр
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ОтклоненияВСтоимостиУпр / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ОтклоненияВСтоимостиУпр,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ДопРасходыСНДС
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ДопРасходыСНДС / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ДопРасходыСНДС,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ДопРасходыБезНДС
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ДопРасходыБезНДС / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ДопРасходыРегл
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ДопРасходыРегл / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ДопРасходыУпр
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ДопРасходыУпр / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.НДСРегл
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.НДСРегл / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК НДСРегл,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.НДСУпр
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.НДСУпр / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК НДСУпр,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ПостояннаяРазница
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ПостояннаяРазница / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.ВременнаяРазница
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.ВременнаяРазница / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК ВременнаяРазница,
	|	(ВЫБОР
	|		КОГДА Т.КоличествоПоДокументу = Т.Количество ИЛИ Т.Количество = 0
	|			ТОГДА Т.НДД
	|		ИНАЧЕ ВЫРАЗИТЬ(Т.КоличествоПоДокументу * (Т.НДД / Т.Количество) КАК ЧИСЛО(31,2))
	|		КОНЕЦ) КАК НДД,
	|	Т.КоличествоПоДокументу КАК Количество
	|
	|ПОМЕСТИТЬ ВтСторноОтклоненийПрошлогоПериода
	|ИЗ
	|	ВтОтклоненияПрошлыхПериодов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК Регистраторы
	|		ПО Т.Организация = Регистраторы.Организация
	|;	
	|";

	#КонецОбласти
	
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

Функция ТекстРаспределитьОтклоненияВСтоимостиТоваровПодготовкаДанных(ПараметрыРасчета)
	
	ТекстЗапроса = "";
	
	#Область ВтОтклоненияКРаспределению
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.ПериодОтклонения КАК ПериодОтклонения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.Сторно КАК Сторно,
	|	СУММА(Т.ОтклоненияВСтоимостиСНДС) КАК ОтклоненияВСтоимостиСНДС,
	|	СУММА(Т.ОтклоненияВСтоимостиБезНДС) КАК ОтклоненияВСтоимостиБезНДС,
	|	СУММА(Т.ОтклоненияВСтоимостиРегл) КАК ОтклоненияВСтоимостиРегл,
	|	СУММА(Т.ОтклоненияВСтоимостиУпр) КАК ОтклоненияВСтоимостиУпр,
	|	СУММА(Т.ДопРасходыСНДС) КАК ДопРасходыСНДС,
	|	СУММА(Т.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(Т.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Т.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр,
	|	СУММА(Т.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(Т.СтоимостьНУ) КАК СтоимостьНУ,
	|	СУММА(Т.НДД) КАК НДД
	|
	|ПОМЕСТИТЬ ВтОтклоненияКРаспределению
	|ИЗ (
	|	ВЫБРАТЬ
	|		Т.ПериодОтклонения КАК ПериодОтклонения,
	|		НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.Номенклатура КАК Номенклатура,
	|		Т.Характеристика КАК Характеристика,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		Т.Подразделение КАК Подразделение,
	|		Т.МестоХранения КАК МестоХранения,
	|		Т.Сторно,
	|		Т.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|		Т.ОтклоненияВСтоимостиБезНДС КАК ОтклоненияВСтоимостиБезНДС,
	|		Т.ОтклоненияВСтоимостиРегл КАК ОтклоненияВСтоимостиРегл,
	|		Т.ОтклоненияВСтоимостиУпр КАК ОтклоненияВСтоимостиУпр,
	|		Т.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|		Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|		Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|		Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|		Т.НДСРегл КАК НДСРегл,
	|		Т.НДСУпр КАК НДСУпр,
	|		Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница,
	|		Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница КАК СтоимостьНУ,
	|		Т.НДД КАК НДД
	|	ИЗ
	|		ВТКэшРасчетныеОборотыОтклоненияВСтоимостиТоваров КАК Т
	|	ГДЕ
	|		Т.СлужебноеВидДвиженияПриход
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.ПериодОтклонения КАК ПериодОтклонения,
	|		Т.РазделУчета КАК РазделУчета,
	|		Т.Организация КАК Организация,
	|		Т.Номенклатура КАК Номенклатура,
	|		Т.Характеристика КАК Характеристика,
	|		Т.ВидЗапасов КАК ВидЗапасов,
	|		Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|		Т.Подразделение КАК Подразделение,
	|		Т.МестоХранения КАК МестоХранения,
	|		ИСТИНА КАК Сторно,
	|		Т.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|		Т.ОтклоненияВСтоимостиБезНДС КАК ОтклоненияВСтоимостиБезНДС,
	|		Т.ОтклоненияВСтоимостиРегл КАК ОтклоненияВСтоимостиРегл,
	|		Т.ОтклоненияВСтоимостиУпр КАК ОтклоненияВСтоимостиУпр,
	|		Т.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|		Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|		Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|		Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|		Т.НДСРегл КАК НДСРегл,
	|		Т.НДСУпр КАК НДСУпр,
	|		Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница,
	|		(Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница) КАК СтоимостьНУ,
	|		Т.НДД КАК НДД
	|	ИЗ
	|		ВтСторноОтклоненийПрошлогоПериода КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.ПериодОтклонения КАК ПериодОтклонения,
	|		Т.РазделУчета КАК РазделУчета,
	|		(ВЫБОР
	|			КОГДА Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				ТОГДА Т.КорОрганизация
	|			ИНАЧЕ Т.Организация КОНЕЦ) КАК Организация,
	|		Т.КорНоменклатура КАК Номенклатура,
	|		Т.КорХарактеристика КАК Характеристика,
	|		Т.КорВидЗапасов КАК ВидЗапасов,
	|		Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|		Т.КорПодразделение КАК Подразделение,
	|		Т.КорМестоХранения КАК МестоХранения,
	|		ИСТИНА КАК Сторно,
	|		-Т.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|		-Т.ОтклоненияВСтоимостиБезНДС КАК ОтклоненияВСтоимостиБезНДС,
	|		-Т.ОтклоненияВСтоимостиРегл КАК ОтклоненияВСтоимостиРегл,
	|		-Т.ОтклоненияВСтоимостиУпр КАК ОтклоненияВСтоимостиУпр,
	|		-Т.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|		-Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|		-Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|		-Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|		-Т.НДСРегл КАК НДСРегл,
	|		-Т.НДСУпр КАК НДСУпр,
	|		-Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|		-Т.ВременнаяРазница КАК ВременнаяРазница,
	|		-(Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл - Т.ПостояннаяРазница - Т.ВременнаяРазница) КАК СтоимостьНУ,
	|		-Т.НДД КАК НДД
	|	ИЗ
	|		ВтСторноОтклоненийПрошлогоПериода КАК Т
	|	ГДЕ
	|		Т.ЕстьКорЧасть
	|	) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ПериодОтклонения,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.Сторно
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	МИНИМУМ(Т.ПериодОтклонения) КАК ПериодОтклонения
	|
	|ПОМЕСТИТЬ МинимальныеПериоды
	|ИЗ
	|	ВтОтклоненияКРаспределению КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация
	|;";
	#КонецОбласти
	
	#Область ВтДвиженияСебестоимостиТоваровПоПериодам
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ИСТИНА КАК ЭтоТекущийПериод,
	|	ВЫБОР
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.Номенклатура ЕСТЬ NULL
	|		 ИЛИ Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	// Условие проверки на реализация в другую организацию должны соответствовать функции ТекстВтПеремещенияСписания()
	// в общем модуле РасчетСебестоимостиРешениеСЛУ.
	|		 ИЛИ Т.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ КАК ЕстьКорЧасть,
	|	МИНИМУМ(Т.Период) КАК Период,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК ПериодРаспределения,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК РазделУчета,
	// Измерения
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	// Кор реквизиты
	|	(ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.КорРазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК КорРазделУчета,
	|	Т.КорОрганизация КАК КорОрганизация,
	|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК КорНоменклатура,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК КорХарактеристика,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|		 ИЛИ Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК КорПодразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|		 И НЕ Т.КорАналитикаУчетаНоменклатуры.МестоХранения ЕСТЬ NULL
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорМестоХранения,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	|	МИНИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	СУММА(Т.Количество) КАК Количество
	|
	|ПОМЕСТИТЬ ВтДвиженияСебестоимостиТоваровПоПериодамДетальные
	|ИЗ
	|	ВтКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	НЕ Т.СлужебноеВидДвиженияПриход
	|	И Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
	// Исклюсаем забалансовые разделы учета, кроме полуфабриката давальца - по нему могут быть балансовые стоимости.
	|	И (НЕ Т.РазделУчета В (&ЗабалансовыеРазделыУчета)
	|		ИЛИ ЕСТЬNULL(Т.ВидЗапасов.ТипЗапасов, НЕОПРЕДЕЛЕНО) = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца))
	|	И Т.Количество <> 0
	|	И НЕ Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНаРасходыФиксированнаяСтоимость),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость))
	// Исключаем сторно документов прошлого периода. Стоимость по таким записям определяется в 
	// процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов().
	|	И НЕ (Т.Сторно
	|		И Т.ТипЗаписи В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПрошлогоПериода),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДополнениеПрошлыйПериод),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.СписанияНаВыпускСторноПрошлогоПериода)))
	|
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.Номенклатура ЕСТЬ NULL
	|		 ИЛИ Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		 ИЛИ Т.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ),
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // РазделУчета
	|	Т.Организация,
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // НаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // Подразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // МестоХранения
	// Кор реквизиты
	|	(ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.КорРазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // КорРазделУчета
	|	Т.КорОрганизация,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)), // КорНоменклатура
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)), // КорХарактеристика
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // КорНаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|		 ИЛИ Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // КорПодразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|		 И НЕ Т.КорАналитикаУчетаНоменклатуры.МестоХранения ЕСТЬ NULL
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // КорМестоХранения
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) // СписыватьОтклоненияНаСебестоимостьПродаж
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ЭтоТекущийПериод,
	|	ВЫБОР
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.Номенклатура ЕСТЬ NULL
	|		 ИЛИ Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	// Условие проверки на реализация в другую организацию должны соответствовать функции ТекстВтПеремещенияСписания()
	// в общем модуле РасчетСебестоимостиРешениеСЛУ.
	|		 ИЛИ Т.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ КАК ЕстьКорЧасть,
	// Распределение отклонений, относящихся к прошлому периоду, отражается датой начала текущего периода.
	|	&НачалоПериода КАК Период,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК ПериодРаспределения,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК РазделУчета,
	// Измерения
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	// Кор реквизиты
	|	(ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.КорРазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК КорРазделУчета,
	|	Т.КорОрганизация КАК КорОрганизация,
	|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК КорНоменклатура,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК КорХарактеристика,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|		 ИЛИ Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК КорПодразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|		 И НЕ Т.КорАналитикаУчетаНоменклатуры.МестоХранения ЕСТЬ NULL
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорМестоХранения,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	|	МИНИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	СУММА(Т.Количество) КАК Количество
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МинимальныеПериоды КАК МинимальныеПериоды
	|		ПО МинимальныеПериоды.Организация = Т.Организация
	|		И МинимальныеПериоды.ПериодОтклонения <= Т.Период
	// Исключаем документы по которым введена корректировка или сторнирование в текущем периоде
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|	ПО ИсправленныеДокументы.СторнируемыйДокумент = Т.Регистратор
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РеестрДокументов КАК РеестрИсточник
	|		ПО РеестрИсточник.Ссылка = Т.ДокументИсточник
	|		И НЕ РеестрИсточник.ДополнительнаяЗапись
	|		И РеестрИсточник.ДатаДокументаИБ < МинимальныеПериоды.ПериодОтклонения
	|		И Т.Сторно
	|ГДЕ
	|	Т.Период МЕЖДУ &МинимальныйПрошлыйПериод И &КонецПредыдущегоПериода
	|	И Т.Организация В (&ОрганизацииСреднескользящая)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
	// Исклюсаем забалансовые разделы учета, кроме полуфабриката давальца - по нему могут быть балансовые стоимости.
	|	И (НЕ Т.РазделУчета В (&ЗабалансовыеРазделыУчета)
	|		ИЛИ ЕСТЬNULL(Т.ВидЗапасов.ТипЗапасов, НЕОПРЕДЕЛЕНО) = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца))
	|	И Т.Количество <> 0
	// Исключаем движения сторнирование документов с датой данее минимального прошлого периода.
	|	И РеестрИсточник.Ссылка ЕСТЬ NULL
	// Исключаем выборку документов прошлого периода, по которым есть сторно или исправления в текущем периоде.
	|	И ИсправленныеДокументы.СторнируемыйДокумент ЕСТЬ NULL
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.Номенклатура ЕСТЬ NULL
	|		 ИЛИ Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|		 ИЛИ Т.ХозяйственнаяОперация В (
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияКлиентуРеглУчет),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5),
	|					ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями))
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ),
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // РазделУчета
	|	Т.Организация,
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // НаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // Подразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // МестоХранения
	// Кор реквизиты
	|	(ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.КорРазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // КорРазделУчета
	|	Т.КорОрганизация,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)), // КорНоменклатура
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)), // КорХарактеристика
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // КорНаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|		 ИЛИ Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // КорПодразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|		 И НЕ Т.КорАналитикаУчетаНоменклатуры.МестоХранения ЕСТЬ NULL
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // КорМестоХранения
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) // СписыватьОтклоненияНаСебестоимостьПродаж
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;
	|
	|ВЫБРАТЬ
	|	Т.ЭтоТекущийПериод,
	|	Т.ЕстьКорЧасть,
	|	Т.ПериодРаспределения,
	|	МИНИМУМ(Т.Период) КАК Период,
	|	Т.РазделУчета,
	|	Т.Организация,
	// Измерения
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	// Кор реквизиты
	|	Т.КорРазделУчета,
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.СписыватьОтклоненияНаСебестоимостьПродаж,
	|	МИНИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	СУММА(Т.Количество) КАК Количество
	|
	|ПОМЕСТИТЬ ВтДвиженияСебестоимостиТоваровПоПериодам
	|ИЗ
	|	ВтДвиженияСебестоимостиТоваровПоПериодамДетальные КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ЭтоТекущийПериод,
	|	Т.ЕстьКорЧасть,
	|	Т.ПериодРаспределения,
	|	Т.РазделУчета,
	|	Т.Организация,
	// Измерения
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	// Кор реквизиты
	|	Т.КорРазделУчета,
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;";
	#КонецОбласти
	
	#Область ВтСторноПеремещенийПрошлогоПериода
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК ПериодРаспределения,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК РазделУчета,
	// Измерения
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	// Кор реквизиты
	|	(ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.КорРазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК КорРазделУчета,
	|	Т.КорОрганизация КАК КорОрганизация,
	|	Т.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)) КАК КорНоменклатура,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)) КАК КорХарактеристика,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|		 ИЛИ Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК КорПодразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|		 И НЕ Т.КорАналитикаУчетаНоменклатуры.МестоХранения ЕСТЬ NULL
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорМестоХранения,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	|	МИНИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	СУММА(Т.Количество) КАК Количество
	|
	|ПОМЕСТИТЬ ВтСторноПеремещенийПрошлогоПериода
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ МинимальныеПериоды КАК МинимальныеПериоды
	|		ПО МинимальныеПериоды.Организация = Т.Организация
	|		И МинимальныеПериоды.ПериодОтклонения <= Т.Период
	|ГДЕ
	|	Т.Период МЕЖДУ &МинимальныйПрошлыйПериод И &КонецПредыдущегоПериода
	|	И Т.Организация В (&ОрганизацииСреднескользящая)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НЕ Т.РазделУчета В(
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка),
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки))
	|	И Т.Количество <> 0
	|	И Т.Сторно
	|
	|СГРУППИРОВАТЬ ПО
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ),
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // РазделУчета
	|	Т.Организация,
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // НаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // Подразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // МестоХранения
	// Кор реквизиты
	|	(ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.КорРазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // КорРазделУчета
	|	Т.КорОрганизация,
	|	Т.КорАналитикаУчетаНоменклатуры,
	|	Т.КорВидЗапасов,
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Номенклатура,
	|		ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)), // КорНоменклатура
	|	ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Характеристика,
	|		ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка)), // КорХарактеристика
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.КорНаправлениеДеятельности
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.КорАналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // КорНаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА Т.КорРазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПустаяСсылка)
	|			ТОГДА Т.Подразделение
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|		 ИЛИ Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.КорАналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.КорАналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // КорПодразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|		 И НЕ Т.КорАналитикаУчетаНоменклатуры.МестоХранения ЕСТЬ NULL
	|			ТОГДА Т.КорАналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // КорМестоХранения
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|		 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) // СписыватьОтклоненияНаСебестоимостьПродаж
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;";
	
	#КонецОбласти
	
	#Область ВтЕстьДвиженияТоваров
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.ПериодРаспределения,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.Сторно КАК Сторно
	|
	|ПОМЕСТИТЬ ВтЕстьДвиженияТоваровДетальные
	|ИЗ (
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.ПериодРаспределения,
	|		Т.Организация,
	|		Т.Номенклатура,
	|		Т.Характеристика,
	|		Т.ВидЗапасов,
	|		Т.НаправлениеДеятельности,
	|		Т.Подразделение,
	|		Т.МестоХранения,
	|		ЛОЖЬ КАК Сторно
	|	ИЗ
	|		ВтДвиженияСебестоимостиТоваровПоПериодам КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		Т.ПериодРаспределения,
	|		(ВЫБОР
	|			КОГДА Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				ТОГДА Т.КорОрганизация
	|			ИНАЧЕ Т.Организация КОНЕЦ) КАК Организация,
	|		Т.КорНоменклатура,
	|		Т.КорХарактеристика,
	|		Т.КорВидЗапасов,
	|		Т.КорНаправлениеДеятельности,
	|		Т.КорПодразделение,
	|		Т.КорМестоХранения,
	|		ЛОЖЬ КАК Сторно
	|	ИЗ
	|		ВтДвиженияСебестоимостиТоваровПоПериодам КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		&НачалоПериода КАК ПериодРаспределения,
	|		Т.Организация,
	|		Т.Номенклатура,
	|		Т.Характеристика,
	|		Т.ВидЗапасов,
	|		Т.НаправлениеДеятельности,
	|		Т.Подразделение,
	|		Т.МестоХранения,
	|		Т.Сторно
	|	ИЗ
	|		ВтСторноОтклоненийПрошлогоПериода КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		&НачалоПериода КАК ПериодРаспределения,
	|		(ВЫБОР
	|			КОГДА Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|				ТОГДА Т.КорОрганизация
	|			ИНАЧЕ Т.Организация КОНЕЦ) КАК Организация,
	|		Т.КорНоменклатура,
	|		Т.КорХарактеристика,
	|		Т.КорВидЗапасов,
	|		Т.КорНаправлениеДеятельности,
	|		Т.КорПодразделение,
	|		Т.КорМестоХранения,
	|		Т.Сторно
	|	ИЗ
	|		ВтСторноОтклоненийПрошлогоПериода КАК Т
	|	ГДЕ
	|		Т.ЕстьКорЧасть
	|
	|	) КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.ПериодРаспределения,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения
	|
	|ПОМЕСТИТЬ ВтЕстьДвиженияТоваров
	|ИЗ
	|	ВтЕстьДвиженияТоваровДетальные КАК Т
	|;";
	#КонецОбласти
	
	#Область ВтУзлыКорректировкиПрошлыхПериодовПредварительная
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	""1"" КАК ЗапросИсточник,
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК ПериодРаспределения,
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ) КАК НаправлениеДеятельности,
	|	(ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ) КАК Подразделение,
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ) КАК МестоХранения,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	0 КАК НомерУзлаПостатейные,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК КоличествоНачальныйОстаток,
	|	СУММА(Т.КоличествоКонечныйОстаток) КАК КоличествоКонечныйОстаток,
	|	СУММА(Т.КоличествоПриход) КАК КоличествоПриход
	|
	|ПОМЕСТИТЬ ВтУзлыКорректировкиПрошлыхПериодовПредварительная
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров.ОстаткиИОбороты(&МинимальныйПрошлыйПериод, &КонецПериода, Месяц, , 
	|		Организация В (&ОрганизацииСреднескользящая)
	|		И &МинимальныйПрошлыйПериод <> &КонецПредыдущегоПериода
	|	) КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Т.КоличествоНачальныйОстаток <> 0
	|	ИЛИ Т.КоличествоПриход <> 0
	|
	|СГРУППИРОВАТЬ ПО
	|	НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ), // ПериодРаспределения
	|	(ВЫБОР
	|		КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Т.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // РазделУчета
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	Т.ВидЗапасов,
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ), // НаправлениеДеятельности
	|	(ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ), // Подразделение
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ) // МестоХранения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Увеличение количества в узле на сторно перемещений.
	|ВЫБРАТЬ
	|	""2"" КАК ЗапросИсточник,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	0 КАК НомерУзлаПостатейные,
	|	0 КАК КоличествоНачальныйОстаток,
	|	0 КАК КоличествоКонечныйОстаток,
	|	СУММА(-Т.Количество) КАК КоличествоПриход
	|ИЗ
	|	ВтСторноПеремещенийПрошлогоПериода КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ПериодРаспределения,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Корректировка прихода в узел на сторно перемещений.
	|ВЫБРАТЬ
	|	""3"" КАК ЗапросИсточник,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	Т.КорРазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.КорНоменклатура КАК Номенклатура,
	|	Т.КорХарактеристика КАК Характеристика,
	|	Т.КорВидЗапасов КАК ВидЗапасов,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорМестоХранения КАК МестоХранения,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	0 КАК НомерУзлаПостатейные,
	|	0 КАК КоличествоНачальныйОстаток,
	|	0 КАК КоличествоКонечныйОстаток,
	|	СУММА(-Т.Количество) КАК КоличествоПриход
	|ИЗ
	|	ВтСторноПеремещенийПрошлогоПериода КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ПериодРаспределения,
	|	Т.КорРазделУчета,
	|	Т.Организация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения
	|;";
	#КонецОбласти
	
	#Область ВтУзлыКорректировкиПрошлыхПериодовСгруппированная
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.НомерУзлаПостатейные КАК НомерУзлаПостатейные,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК КоличествоНачальныйОстаток,
	|	СУММА(Т.КоличествоКонечныйОстаток) КАК КоличествоКонечныйОстаток,
	|	СУММА(Т.КоличествоПриход) КАК КоличествоПриход
	|
	|ПОМЕСТИТЬ ВтУзлыКорректировкиПрошлыхПериодовСгруппированная
	|ИЗ
	|	ВтУзлыКорректировкиПрошлыхПериодовПредварительная КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ПериодРаспределения,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.НомерУзлаПостатейные
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение,
	|	МестоХранения
	|;";
	#КонецОбласти
	
	#Область ВтУзлыКорректировкиПрошлыхПериодов
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	МАКСИМУМ(ЕСТЬNULL(Т2.ПериодРаспределения, НЕОПРЕДЕЛЕНО)) КАК ПериодРаспределенияПредыдущий,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.НомерУзлаПостатейные КАК НомерУзлаПостатейные,
	|	Т.КоличествоНачальныйОстаток КАК КоличествоНачальныйОстаток,
	|	Т.КоличествоКонечныйОстаток КАК КоличествоКонечныйОстаток,
	|	Т.КоличествоПриход КАК КоличествоПриход
	|
	|ПОМЕСТИТЬ ВтУзлыКорректировкиПрошлыхПериодов
	|ИЗ
	|	ВтУзлыКорректировкиПрошлыхПериодовСгруппированная КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиПрошлыхПериодовСгруппированная КАК Т2
	|		ПО Т.Организация = Т2.Организация
	|		И Т.Номенклатура = Т2.Номенклатура
	|		И Т.Характеристика = Т2.Характеристика
	|		И Т.ВидЗапасов = Т2.ВидЗапасов
	|		И Т.НаправлениеДеятельности = Т2.НаправлениеДеятельности
	|		И Т.Подразделение = Т2.Подразделение
	|		И Т.МестоХранения = Т2.МестоХранения
	|		И Т.РазделУчета = Т2.РазделУчета
	|		И Т.ПериодРаспределения > Т2.ПериодРаспределения
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ПериодРаспределения,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.НомерУзлаПостатейные,
	|	Т.КоличествоНачальныйОстаток,
	|	Т.КоличествоКонечныйОстаток,
	|	Т.КоличествоПриход
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;
	|";
	#КонецОбласти
	
	#Область ВтУзлыКорректировкиТекущегоПериода
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	(ВЫБОР
	|		КОГДА Узлы.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Узлы.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ) КАК РазделУчета,
	|	Узлы.Организация КАК Организация,
	|	Узлы.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Узлы.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Узлы.ВидЗапасов КАК ВидЗапасов,
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Узлы.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ) КАК НаправлениеДеятельности,
	|	(ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Узлы.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Узлы.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Узлы.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Узлы.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Узлы.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Узлы.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ) КАК Подразделение,
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Узлы.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ) КАК МестоХранения,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	0 КАК НомерУзлаПостатейные,
	|	ЛОЖЬ КАК ЭтоНЗП,
	|	СУММА(Узлы.Количество) КАК Количество,
	|	СУММА(Узлы.Количество) КАК КоличествоСНДС,
	|	СУММА(Узлы.Количество) КАК КоличествоБезНДС,
	|	СУММА(Узлы.Количество) КАК КоличествоРегл,
	|	СУММА(Узлы.Количество) КАК КоличествоНУ,
	|	СУММА(Узлы.Количество) КАК КоличествоУпр
	|
	|ПОМЕСТИТЬ ВтУзлыКорректировкиТекущегоПериода
	|ИЗ
	|	ВтУзлыКорректировки КАК Узлы
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Узлы.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Узлы.Организация В (&ОрганизацииСреднескользящая)
	|	
	|СГРУППИРОВАТЬ ПО
	|	(ВЫБОР
	|		КОГДА Узлы.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			ТОГДА Узлы.РазделУчета 
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ), // РазделУчета
	|	Узлы.Организация,
	|	Узлы.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Узлы.АналитикаУчетаНоменклатуры.Характеристика,
	|	Узлы.ВидЗапасов,
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Узлы.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ), // НаправлениеДеятельности
	|	(ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Узлы.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ), // МестоХранения
	|	(ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Узлы.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Узлы.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Узлы.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Узлы.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Узлы.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Узлы.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ) // Подразделение
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	Узлы.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
	|	Узлы.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Узлы.Подразделение КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК МестоХранения,
	|	Узлы.СтатьяРасходов КАК СтатьяРасходов,
	|	Узлы.АналитикаРасходов КАК АналитикаРасходов,
	|	Узлы.НомерУзла КАК НомерУзлаПостатейные,
	|	(ВЫБОР
	|		КОГДА Узлы.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ) КАК ЭтоНЗП,
	|	0 КАК Количество,
	|	СУММА(Узлы.ВесПостатейные) КАК КоличествоСНДС,
	|	СУММА(Узлы.ВесПостатейныеБезНДС) КАК КоличествоБезНДС,
	|	СУММА(Узлы.ВесПостатейныеРегл) КАК КоличествоРегл,
	|	СУММА(Узлы.ВесПостатейныеНУ) КАК КоличествоНУ,
	|	СУММА(Узлы.ВесПостатейныеУпр) КАК КоличествоУпр
	|ИЗ
	|	ВтУзлыКорректировкиПостатейныеРасходыНЗП КАК Узлы
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Узлы.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Узлы.Организация В (&ОрганизацииСреднескользящая)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Узлы.Организация,
	|	Узлы.НаправлениеДеятельности,
	|	Узлы.Подразделение,
	|	Узлы.СтатьяРасходов,
	|	Узлы.АналитикаРасходов,
	|	Узлы.НомерУзла,
	|	(ВЫБОР
	|		КОГДА Узлы.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ КОНЕЦ) // ЭтоНЗП
	//-- НЕ УТ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	Узлы.Организация КАК Организация,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
	|	ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка) КАК ВидЗапасов,
	|	Узлы.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Узлы.Подразделение КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК МестоХранения,
	|	Узлы.СтатьяРасходов КАК СтатьяРасходов,
	|	Узлы.АналитикаРасходов КАК АналитикаРасходов,
	|	Узлы.НомерУзла КАК НомерУзлаПостатейные,
	|	ЛОЖЬ КАК ЭтоНЗП,
	|	0 КАК Количество,
	|	СУММА(Узлы.ВесСНДС) КАК КоличествоСНДС,
	|	СУММА(Узлы.ВесБезНДС) КАК КоличествоБезНДС,
	|	СУММА(Узлы.ВесРегл) КАК КоличествоРегл,
	|	СУММА(Узлы.ВесНУ) КАК КоличествоНУ,
	|	СУММА(Узлы.ВесУпр) КАК КоличествоУпр
	|ИЗ
	|	УзлыКорректировкиДополнительныхРасходов КАК Узлы
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Узлы.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Узлы.Организация В (&ОрганизацииСреднескользящая)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Узлы.Организация,
	|	Узлы.НаправлениеДеятельности,
	|	Узлы.Подразделение,
	|	Узлы.СтатьяРасходов,
	|	Узлы.АналитикаРасходов,
	|	Узлы.НомерУзла
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;";
	#КонецОбласти
	
	#Область ВтОстаткиОтклоненийНаНачалоПериодаВыборка
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ИСТИНА КАК ЭтоОстаткиНаНачалоПериода,
	|	Остатки.ПериодОтклонения КАК ПериодОтклонения,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	Остатки.Организация КАК Организация,
	|	Остатки.Номенклатура КАК Номенклатура,
	|	Остатки.Характеристика КАК Характеристика,
	|	Остатки.ВидЗапасов КАК ВидЗапасов,
	|	Остатки.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Остатки.Подразделение КАК Подразделение,
	|	Остатки.МестоХранения КАК МестоХранения,
	|	Остатки.ОтклоненияВСтоимостиСНДСОстаток КАК ОтклоненияВСтоимостиСНДС,
	|	Остатки.ОтклоненияВСтоимостиБезНДСОстаток КАК ОтклоненияВСтоимостиБезНДС,
	|	Остатки.ОтклоненияВСтоимостиРеглОстаток КАК ОтклоненияВСтоимостиРегл,
	|	Остатки.ОтклоненияВСтоимостиУпрОстаток КАК ОтклоненияВСтоимостиУпр,
	|	Остатки.ДопРасходыСНДСОстаток  КАК ДопРасходыСНДС,
	|	Остатки.ДопРасходыБезНДСОстаток КАК ДопРасходыБезНДС,
	|	Остатки.ДопРасходыРеглОстаток КАК ДопРасходыРегл,
	|	Остатки.ДопРасходыУпрОстаток КАК ДопРасходыУпр,
	|	Остатки.НДСРеглОстаток КАК НДСРегл,
	|	Остатки.НДСУпрОстаток КАК НДСУпр,
	|	Остатки.ПостояннаяРазницаОстаток КАК ПостояннаяРазница,
	|	Остатки.ВременнаяРазницаОстаток КАК ВременнаяРазница,
	|	Остатки.ОтклоненияВСтоимостиРеглОстаток
	|		+ Остатки.ДопРасходыРеглОстаток
	|		+ Остатки.НДСРеглОстаток
	|		- Остатки.ПостояннаяРазницаОстаток
	|		- Остатки.ВременнаяРазницаОстаток КАК СтоимостьНУ,
	|	Остатки.НДДОстаток КАК НДД
	|
	|ПОМЕСТИТЬ ВтОстаткиОтклоненийНаНачалоПериодаВыборка
	|ИЗ
	|	РегистрНакопления.ОтклоненияВСтоимостиТоваров.Остатки(&НачалоПериода, 
	|		(Организация,
	|		Номенклатура,
	|		Характеристика,
	|		ВидЗапасов,
	|		НаправлениеДеятельности, 
	|		Подразделение,
	|		МестоХранения) В (
	|		ВЫБРАТЬ
	|			Движения.Организация,
	|			Движения.Номенклатура,
	|			Движения.Характеристика,
	|			Движения.ВидЗапасов,
	|			Движения.НаправлениеДеятельности,
	|			Движения.Подразделение,
	|			Движения.МестоХранения
	|		ИЗ
	|			ВтЕстьДвиженияТоваровДетальные КАК Движения
	// Остатки отклонений прошлого периода нужно перенести в текущий период только если в текущм периоде есть
	// движений по данной аналитике.
	|		ГДЕ
	|			Движения.ПериодРаспределения >= &НачалоПериода
	|		)
	|	) КАК Остатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ЭтоОстаткиНаНачалоПериода,
	|	Остатки.ПериодОтклонения КАК ПериодОтклонения,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	Остатки.Организация КАК Организация,
	|	Остатки.Номенклатура КАК Номенклатура,
	|	Остатки.Характеристика КАК Характеристика,
	|	Остатки.ВидЗапасов КАК ВидЗапасов,
	|	Остатки.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Остатки.Подразделение КАК Подразделение,
	|	Остатки.МестоХранения КАК МестоХранения,
	|	Остатки.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|	Остатки.ОтклоненияВСтоимостиБезНДС КАК ОтклоненияВСтоимостиБезНДС,
	|	Остатки.ОтклоненияВСтоимостиРегл КАК ОтклоненияВСтоимостиРегл,
	|	Остатки.ОтклоненияВСтоимостиУпр КАК ОтклоненияВСтоимостиУпр,
	|	Остатки.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|	Остатки.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	Остатки.ДопРасходыРегл КАК ДопРасходыРегл,
	|	Остатки.ДопРасходыУпр КАК ДопРасходыУпр,
	|	Остатки.НДСРегл КАК НДСРегл,
	|	Остатки.НДСУпр КАК НДСУпр,
	|	Остатки.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Остатки.ВременнаяРазница КАК ВременнаяРазница,
	|	Остатки.СтоимостьНУ КАК СтоимостьНУ,
	|	Остатки.НДД КАК НДД
	|ИЗ
	|	ВтОтклоненияКРаспределению КАК Остатки
	|ГДЕ
	// Уменьшим остатки на начало периода на сторно отклонений прошлого периода.
	// Сторно отклонений прошлого периода добавляются к остаткам на начало периода.
	|	Остатки.Сторно
	|;";
	#КонецОбласти
	
	#Область ВтОстаткиОтклоненийНаНачалоПериодаДетальные
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Остатки.ПериодОтклонения КАК ПериодОтклонения,
	|	Остатки.РазделУчета КАК РазделУчета,
	|	Остатки.Организация КАК Организация,
	|	Остатки.Номенклатура КАК Номенклатура,
	|	Остатки.Характеристика КАК Характеристика,
	|	Остатки.ВидЗапасов КАК ВидЗапасов,
	|	Остатки.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Остатки.Подразделение КАК Подразделение,
	|	Остатки.МестоХранения КАК МестоХранения,
	|	СУММА(Остатки.ОтклоненияВСтоимостиСНДС) КАК ОтклоненияВСтоимостиСНДС,
	|	СУММА(Остатки.ОтклоненияВСтоимостиБезНДС) КАК ОтклоненияВСтоимостиБезНДС,
	|	СУММА(Остатки.ОтклоненияВСтоимостиРегл) КАК ОтклоненияВСтоимостиРегл,
	|	СУММА(Остатки.ОтклоненияВСтоимостиУпр) КАК ОтклоненияВСтоимостиУпр,
	|	СУММА(Остатки.ДопРасходыСНДС) КАК ДопРасходыСНДС,
	|	СУММА(Остатки.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(Остатки.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Остатки.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Остатки.НДСРегл) КАК НДСРегл,
	|	СУММА(Остатки.НДСУпр) КАК НДСУпр,
	|	СУММА(Остатки.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Остатки.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(Остатки.СтоимостьНУ) КАК СтоимостьНУ,
	|	СУММА(Остатки.НДД) КАК НДД
	|
	|ПОМЕСТИТЬ ВтОстаткиОтклоненийНаНачалоПериодаДетальные
	|ИЗ
	|	ВтОстаткиОтклоненийНаНачалоПериодаВыборка КАК Остатки
	|
	|СГРУППИРОВАТЬ ПО
	|	Остатки.ПериодОтклонения,
	|	Остатки.РазделУчета,
	|	Остатки.Организация,
	|	Остатки.Номенклатура,
	|	Остатки.Характеристика,
	|	Остатки.ВидЗапасов,
	|	Остатки.НаправлениеДеятельности,
	|	Остатки.Подразделение,
	|	Остатки.МестоХранения
	|;";
	#КонецОбласти
	
	#Область ВтОстаткиОтклоненийНаНачалоПериода
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Остатки.РазделУчета КАК РазделУчета,
	|	Остатки.Организация КАК Организация,
	|	Остатки.Номенклатура КАК Номенклатура,
	|	Остатки.Характеристика КАК Характеристика,
	|	Остатки.ВидЗапасов КАК ВидЗапасов,
	|	Остатки.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Остатки.Подразделение КАК Подразделение,
	|	Остатки.МестоХранения КАК МестоХранения,
	|	СУММА(Остатки.ОтклоненияВСтоимостиСНДС) КАК ОтклоненияВСтоимостиСНДС,
	|	СУММА(Остатки.ОтклоненияВСтоимостиБезНДС) КАК ОтклоненияВСтоимостиБезНДС,
	|	СУММА(Остатки.ОтклоненияВСтоимостиРегл) КАК ОтклоненияВСтоимостиРегл,
	|	СУММА(Остатки.ОтклоненияВСтоимостиУпр) КАК ОтклоненияВСтоимостиУпр,
	|	СУММА(Остатки.ДопРасходыСНДС)  КАК ДопРасходыСНДС,
	|	СУММА(Остатки.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(Остатки.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Остатки.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Остатки.НДСРегл) КАК НДСРегл,
	|	СУММА(Остатки.НДСУпр) КАК НДСУпр,
	|	СУММА(Остатки.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Остатки.СтоимостьНУ) КАК СтоимостьНУ,
	|	СУММА(Остатки.НДД) КАК НДД
	|
	|ПОМЕСТИТЬ ВтОстаткиОтклоненийНаНачалоПериода
	|ИЗ
	|	ВтОстаткиОтклоненийНаНачалоПериодаДетальные КАК Остатки
	|
	|СГРУППИРОВАТЬ ПО
	|	Остатки.РазделУчета,
	|	Остатки.Организация,
	|	Остатки.Номенклатура,
	|	Остатки.Характеристика,
	|	Остатки.ВидЗапасов,
	|	Остатки.НаправлениеДеятельности,
	|	Остатки.Подразделение,
	|	Остатки.МестоХранения
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;";
	#КонецОбласти
	
	#Область ВТУзлыОтклоненийПредварительная
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	""1"" КАК ЗапросИсточник,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ПериодОтклонения, &НачалоПериода) КАК ПериодОтклонения,
	|	&НачалоПериода КАК ПериодРаспределения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.НомерУзлаПостатейные КАК НомерУзлаПостатейные,
	|	Т.ЭтоНЗП КАК ЭтоНЗП,
	|
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ОтклоненияВСтоимостиСНДС, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ОтклоненияВСтоимостиСНДС, 0) КАК ОтклоненияВСтоимостиСНДС,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ОтклоненияВСтоимостиБезНДС, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ОтклоненияВСтоимостиБезНДС, 0) КАК ОтклоненияВСтоимостиБезНДС,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ОтклоненияВСтоимостиРегл, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ОтклоненияВСтоимостиРегл, 0) КАК ОтклоненияВСтоимостиРегл,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ОтклоненияВСтоимостиУпр, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ОтклоненияВСтоимостиУпр, 0) КАК ОтклоненияВСтоимостиУпр,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ДопРасходыСНДС, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ДопРасходыСНДС, 0) КАК ДопРасходыСНДС,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ДопРасходыБезНДС, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ДопРасходыБезНДС, 0) КАК ДопРасходыБезНДС,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ДопРасходыРегл, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ДопРасходыРегл, 0) КАК ДопРасходыРегл,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ДопРасходыУпр, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ДопРасходыУпр, 0) КАК ДопРасходыУпр,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.НДСРегл, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.НДСРегл, 0) КАК НДСРегл,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.НДСУпр, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.НДСУпр, 0) КАК НДСУпр,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ПостояннаяРазница, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.ПостояннаяРазница, 0) КАК ПостояннаяРазница,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.СтоимостьНУ, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.СтоимостьНУ, 0) КАК СтоимостьНУ,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.НДД, 0)
	|		+ ЕСТЬNULL(ОстаткиОтклонений.НДД, 0) КАК НДД,
	|
	|	Т.Количество КАК Количество,
	|	Т.КоличествоСНДС КАК КоличествоСНДС,
	|	Т.КоличествоБезНДС КАК КоличествоБезНДС,
	|	Т.КоличествоРегл КАК КоличествоРегл,
	|	Т.КоличествоНУ КАК КоличествоНУ,
	|	Т.КоличествоУпр КАК КоличествоУпр
	|
	|ПОМЕСТИТЬ ВТУзлыОтклоненийПредварительная
	|ИЗ
	|	ВтУзлыКорректировкиТекущегоПериода КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтЕстьДвиженияТоваров КАК ЕстьДвиженияТоваров
	|		ПО &НачалоПериода = ЕстьДвиженияТоваров.ПериодРаспределения
	|		И Т.Организация = ЕстьДвиженияТоваров.Организация
	|		И Т.Номенклатура = ЕстьДвиженияТоваров.Номенклатура
	|		И Т.Характеристика = ЕстьДвиженияТоваров.Характеристика
	|		И Т.ВидЗапасов = ЕстьДвиженияТоваров.ВидЗапасов
	|		И Т.НаправлениеДеятельности = ЕстьДвиженияТоваров.НаправлениеДеятельности
	|		И Т.Подразделение = ЕстьДвиженияТоваров.Подразделение
	|		И Т.МестоХранения = ЕстьДвиженияТоваров.МестоХранения
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтОтклоненияКРаспределению КАК ОтклоненияКРаспределению
	|		ПО &НачалоПериода = ОтклоненияКРаспределению.ПериодОтклонения
	|		И Т.Организация = ОтклоненияКРаспределению.Организация
	|		И Т.Номенклатура = ОтклоненияКРаспределению.Номенклатура
	|		И Т.Характеристика = ОтклоненияКРаспределению.Характеристика
	|		И Т.ВидЗапасов = ОтклоненияКРаспределению.ВидЗапасов
	|		И Т.НаправлениеДеятельности = ОтклоненияКРаспределению.НаправлениеДеятельности
	|		И Т.Подразделение = ОтклоненияКРаспределению.Подразделение
	|		И Т.МестоХранения = ОтклоненияКРаспределению.МестоХранения
	|		И Т.РазделУчета = НЕОПРЕДЕЛЕНО
	// Сторно отклонений прошлого периода относится к остаткам на начало периода. Добавляются в таблицу ВтОстаткиОтклоненийНаНачалоПериода 
	|		И НЕ ОтклоненияКРаспределению.Сторно
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтОстаткиОтклоненийНаНачалоПериода КАК ОстаткиОтклонений
	|		ПО Т.Организация = ОстаткиОтклонений.Организация
	|		И Т.Номенклатура = ОстаткиОтклонений.Номенклатура
	|		И Т.Характеристика = ОстаткиОтклонений.Характеристика
	|		И Т.ВидЗапасов = ОстаткиОтклонений.ВидЗапасов
	|		И Т.НаправлениеДеятельности = ОстаткиОтклонений.НаправлениеДеятельности
	|		И Т.Подразделение = ОстаткиОтклонений.Подразделение
	|		И Т.МестоХранения = ОстаткиОтклонений.МестоХранения
	|		И Т.РазделУчета = ОстаткиОтклонений.РазделУчета
	|ГДЕ
	|	Т.НомерУзлаПостатейные = 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Узлы доп расходов и постатейных производственных расходов текущего периода. 
	|ВЫБРАТЬ
	|	""2"" КАК ЗапросИсточник,
	|	&НачалоПериода КАК ПериодОтклонения,
	|	&НачалоПериода КАК ПериодРаспределения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.НомерУзлаПостатейные КАК НомерУзлаПостатейные,
	|	Т.ЭтоНЗП КАК ЭтоНЗП,
	|
	|	0 КАК ОтклоненияВСтоимостиСНДС,
	|	0 КАК ОтклоненияВСтоимостиБезНДС,
	|	0 КАК ОтклоненияВСтоимостиРегл,
	|	0 КАК ОтклоненияВСтоимостиУпр,
	|	0 КАК ДопРасходыСНДС,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК СтоимостьНУ,
	|	0 КАК НДД,
	|
	|	0 КАК Количество,
	|	Т.КоличествоСНДС КАК КоличествоСНДС,
	|	Т.КоличествоБезНДС КАК КоличествоБезНДС,
	|	Т.КоличествоРегл КАК КоличествоРегл,
	|	Т.КоличествоНУ КАК КоличествоНУ,
	|	Т.КоличествоУпр КАК КоличествоУпр
	|ИЗ
	|	ВтУзлыКорректировкиТекущегоПериода КАК Т
	|ГДЕ
	|	Т.НомерУзлаПостатейные > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""3"" КАК ЗапросИсточник,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ПериодОтклонения, Т.ПериодРаспределения) КАК ПериодОтклонения,
	|	Т.ПериодРаспределения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.НомерУзлаПостатейные КАК НомерУзлаПостатейные,
	|	ЛОЖЬ КАК ЭтоНЗП,
	|
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ОтклоненияВСтоимостиСНДС, 0) КАК ОтклоненияВСтоимостиСНДС,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ОтклоненияВСтоимостиБезНДС, 0) КАК ОтклоненияВСтоимостиБезНДС,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ОтклоненияВСтоимостиРегл, 0) КАК ОтклоненияВСтоимостиРегл,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ОтклоненияВСтоимостиУпр, 0) КАК ОтклоненияВСтоимостиУпр,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ДопРасходыСНДС, 0) КАК ДопРасходыСНДС,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ДопРасходыБезНДС, 0) КАК ДопРасходыБезНДС,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ДопРасходыРегл, 0) КАК ДопРасходыРегл,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ДопРасходыУпр, 0) КАК ДопРасходыУпр,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.НДСРегл, 0) КАК НДСРегл,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.НДСУпр, 0) КАК НДСУпр,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.ПостояннаяРазница, 0) КАК ПостояннаяРазница,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.СтоимостьНУ, 0) КАК СтоимостьНУ,
	|	ЕСТЬNULL(ОтклоненияКРаспределению.НДД, 0) КАК НДД,
	|
	|	Т.КоличествоНачальныйОстаток + Т.КоличествоПриход КАК Количество,
	|	Т.КоличествоНачальныйОстаток + Т.КоличествоПриход КАК КоличествоСНДС,
	|	Т.КоличествоНачальныйОстаток + Т.КоличествоПриход КАК КоличествоБезНДС,
	|	Т.КоличествоНачальныйОстаток + Т.КоличествоПриход КАК КоличествоРегл,
	|	Т.КоличествоНачальныйОстаток + Т.КоличествоПриход КАК КоличествоНУ,
	|	Т.КоличествоНачальныйОстаток + Т.КоличествоПриход КАК КоличествоУпр
	|
	|ИЗ
	|	ВтУзлыКорректировкиПрошлыхПериодов КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтЕстьДвиженияТоваров КАК ЕстьДвиженияТоваров
	|		ПО &НачалоПериода = ЕстьДвиженияТоваров.ПериодРаспределения
	|		И &НачалоПериода = Т.ПериодРаспределения
	|		И Т.Организация = ЕстьДвиженияТоваров.Организация
	|		И Т.Номенклатура = ЕстьДвиженияТоваров.Номенклатура
	|		И Т.Характеристика = ЕстьДвиженияТоваров.Характеристика
	|		И Т.ВидЗапасов = ЕстьДвиженияТоваров.ВидЗапасов
	|		И Т.НаправлениеДеятельности = ЕстьДвиженияТоваров.НаправлениеДеятельности
	|		И Т.Подразделение = ЕстьДвиженияТоваров.Подразделение
	|		И Т.МестоХранения = ЕстьДвиженияТоваров.МестоХранения
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтОтклоненияКРаспределению КАК ОтклоненияКРаспределению
	|		ПО Т.ПериодРаспределения = ОтклоненияКРаспределению.ПериодОтклонения
	|		И Т.Организация = ОтклоненияКРаспределению.Организация
	|		И Т.Номенклатура = ОтклоненияКРаспределению.Номенклатура
	|		И Т.Характеристика = ОтклоненияКРаспределению.Характеристика
	|		И Т.ВидЗапасов = ОтклоненияКРаспределению.ВидЗапасов
	|		И Т.НаправлениеДеятельности = ОтклоненияКРаспределению.НаправлениеДеятельности
	|		И Т.Подразделение = ОтклоненияКРаспределению.Подразделение
	|		И Т.МестоХранения = ОтклоненияКРаспределению.МестоХранения
	|		И Т.РазделУчета = НЕОПРЕДЕЛЕНО
	// Сторно отклонений прошлого периода относится к остаткам на начало периода. Добавляются в таблицу ВтОстаткиОтклоненийНаНачалоПериода 
	|		И НЕ ОтклоненияКРаспределению.Сторно
	|ГДЕ
	|	ЕстьДвиженияТоваров.Организация ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Номенклатура
	|;
	|";
	#КонецОбласти
	
	#Область ВТУзлыОтклонений
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ ПЕРВЫЕ 9999999999999
	|	АВТОНОМЕРЗАПИСИ() КАК НомерУзла,
	|	Т.ПериодОтклонения КАК ПериодОтклонения,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.НомерУзлаПостатейные КАК НомерУзлаПостатейные,
	|	Т.ЭтоНЗП КАК ЭтоНЗП,
	|
	|	Т.ОтклоненияВСтоимостиСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл,
	|	Т.ОтклоненияВСтоимостиУпр,
	|	Т.ДопРасходыСНДС,
	|	Т.ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл,
	|	Т.ДопРасходыУпр,
	|	Т.НДСРегл,
	|	Т.НДСУпр,
	|	Т.ПостояннаяРазница,
	|	Т.СтоимостьНУ,
	|	Т.НДД,
	|	Т.Количество КАК Количество,
	|	Т.КоличествоСНДС КАК КоличествоСНДС,
	|	Т.КоличествоБезНДС КАК КоличествоБезНДС,
	|	Т.КоличествоРегл КАК КоличествоРегл,
	|	Т.КоличествоНУ КАК КоличествоНУ,
	|	Т.КоличествоУпр КАК КоличествоУпр
	|
	|ПОМЕСТИТЬ ВТУзлыОтклоненийПронумерованная
	|ИЗ
	|	ВТУзлыОтклоненийПредварительная КАК Т
	|
	|УПОРЯДОЧИТЬ ПО
	|	Т.НомерУзлаПостатейные ВОЗР,
	|	Т.ПериодРаспределения,
	|	Т.РазделУчета,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов
	|;
	|
	|ВЫБРАТЬ ПЕРВЫЕ 9999999999999
	|	(ВЫБОР
	|		КОГДА Т.НомерУзлаПостатейные > 0 ТОГДА Т.НомерУзлаПостатейные
	|		ИНАЧЕ &ПоследнийНомерУзла + Т.НомерУзла КОНЕЦ) КАК НомерУзла,
	|	Т.ПериодОтклонения КАК ПериодОтклонения,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.Организация КАК Организация,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.НомерУзлаПостатейные КАК НомерУзлаПостатейные,
	|	Т.ЭтоНЗП КАК ЭтоНЗП,
	|
	|	Т.ОтклоненияВСтоимостиСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл,
	|	Т.ОтклоненияВСтоимостиУпр,
	|	Т.ДопРасходыСНДС,
	|	Т.ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл,
	|	Т.ДопРасходыУпр,
	|	Т.НДСРегл,
	|	Т.НДСУпр,
	|	Т.ПостояннаяРазница,
	|	Т.СтоимостьНУ,
	|	Т.НДД,
	|	Т.Количество КАК Количество,
	|	Т.КоличествоСНДС КАК КоличествоСНДС,
	|	Т.КоличествоБезНДС КАК КоличествоБезНДС,
	|	Т.КоличествоРегл КАК КоличествоРегл,
	|	Т.КоличествоНУ КАК КоличествоНУ,
	|	Т.КоличествоУпр КАК КоличествоУпр
	|
	|ПОМЕСТИТЬ ВТУзлыОтклонений
	|ИЗ
	|	ВТУзлыОтклоненийПронумерованная КАК Т
	|
	|УПОРЯДОЧИТЬ ПО
	|	Т.НомерУзлаПостатейные ВОЗР,
	|	Т.НомерУзла ВОЗР
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Подразделение
	|;
	|";
	#КонецОбласти
	
	#Область ВтСвязиРаспределениеДопРасходов
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Связи.Регистратор КАК Регистратор,
	|	Связи.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	&НачалоПериода КАК ПериодОтклонения,
	|	УзлыПриемники.Организация КАК КорОрганизация,
	|	УзлыПриемники.АналитикаУчетаНоменклатуры.Номенклатура КАК КорНоменклатура,
	|	УзлыПриемники.АналитикаУчетаНоменклатуры.Характеристика КАК КорХарактеристика,
	|	УзлыПриемники.ВидЗапасов КАК КорВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(УзлыПриемники.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК КорПодразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорМестоХранения,
	|	УзлыИсточники.Подразделение КАК Подразделение,
	|	УзлыИсточники.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	УзлыИсточники.СтатьяРасходов,
	|	УзлыИсточники.АналитикаРасходов,
	|	МАКСИМУМ(Связи.НеРаспределяетсяВБухУчете) КАК НеРаспределяетсяВБухУчете,
	|	МАКСИМУМ(Связи.НеРаспределяетсяВНалУчете) КАК НеРаспределяетсяВНалУчете,
	|	МАКСИМУМ(Связи.ПринимаемыеВНУ) КАК ПринимаемыеВНУ,
	|	СУММА(Связи.ВесДугиСНДС) КАК ВесДугиСНДС,
	|	СУММА(Связи.ВесДугиБезНДС) КАК ВесДугиБезНДС,
	|	СУММА(Связи.ВесДугиРегл) КАК ВесДугиРегл,
	|	СУММА(Связи.ВесДугиНУ) КАК ВесДугиНУ,
	|	СУММА(Связи.ВесДугиУпр) КАК ВесДугиУпр,
	|	СУММА(Связи.ВесДугиНДД) КАК ВесДугиНДД
	|
	|ПОМЕСТИТЬ ВтСвязиРаспределениеДопРасходов
	|ИЗ
	|	СвязиУзловДополнительныхРасходовСРегистратором КАК Связи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ УзлыКорректировкиДополнительныхРасходов КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзла = Связи.НомерУзлаИсточник
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтУзлыКорректировки КАК УзлыПриемники
	|		ПО УзлыПриемники.НомерУзла = Связи.НомерУзлаПриемник
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО УзлыПриемники.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|
	|СГРУППИРОВАТЬ ПО
	|	Связи.Регистратор,
	|	Связи.НомерУзлаИсточник,
	|	УзлыПриемники.Организация,
	|	УзлыПриемники.АналитикаУчетаНоменклатуры.Номенклатура,
	|	УзлыПриемники.АналитикаУчетаНоменклатуры.Характеристика,
	|	УзлыПриемники.ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(УзлыПриемники.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // КорНаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // КорПодразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // КорМестоХранения
	|	УзлыИсточники.Подразделение,
	|	УзлыИсточники.НаправлениеДеятельности,
	|	УзлыИсточники.СтатьяРасходов,
	|	УзлыИсточники.АналитикаРасходов
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаИсточник
	|;
	|";
	#КонецОбласти
	
	//++ НЕ УТ
	#Область ВтСвязиРаспределениеПостатейныхНаВыпуск
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Связи.НомерУзлаИсточник,
	|	&НачалоПериода КАК ПериодОтклонения,
	|	УзлыПриемники.Организация КАК КорОрганизация,
	|	УзлыПриемники.АналитикаУчетаНоменклатуры.Номенклатура КАК КорНоменклатура,
	|	УзлыПриемники.АналитикаУчетаНоменклатуры.Характеристика КАК КорХарактеристика,
	|	УзлыПриемники.ВидЗапасов КАК КорВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(УзлыПриемники.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК КорНаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК КорПодразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК КорМестоХранения,
	|	УзлыИсточники.Подразделение,
	|	УзлыИсточники.НаправлениеДеятельности,
	|	УзлыИсточники.СтатьяРасходов,
	|	УзлыИсточники.АналитикаРасходов,
	|	СУММА(Связи.ВесДугиПостатейныеРасходыСНДС) КАК ВесДугиСНДС,
	|	СУММА(Связи.ВесДугиПостатейныеРасходыБезНДС) КАК ВесДугиБезНДС,
	|	СУММА(Связи.ВесДугиПостатейныеРасходыРегл) КАК ВесДугиРегл,
	|	СУММА(Связи.ВесДугиПостатейныеРасходыНУ) КАК ВесДугиНУ,
	|	СУММА(Связи.ВесДугиПостатейныеРасходыУпр) КАК ВесДугиУпр,
	|	СУММА(Связи.ВесДугиНДД) КАК ВесДугиНДД
	|
	|ПОМЕСТИТЬ ВтСвязиРаспределениеПостатейныхНаВыпуск
	|ИЗ
	|	ВтТаблицаСвязейПостатейныеРасходы КАК Связи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиПостатейныеРасходыНЗП КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзла = Связи.НомерУзлаИсточник
	|		И УзлыИсточники.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтУзлыКорректировки КАК УзлыПриемники
	|		ПО УзлыПриемники.НомерУзла = Связи.НомерУзлаПриемник
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО УзлыПриемники.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|
	|СГРУППИРОВАТЬ ПО
	|	Связи.НомерУзлаИсточник,
	|	УзлыПриемники.Организация,
	|	УзлыПриемники.АналитикаУчетаНоменклатуры.Номенклатура,
	|	УзлыПриемники.АналитикаУчетаНоменклатуры.Характеристика,
	|	УзлыПриемники.ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(УзлыПриемники.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // КорНаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // КорПодразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА УзлыПриемники.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ, // КорМестоХранения
	|	УзлыИсточники.Подразделение,
	|	УзлыИсточники.НаправлениеДеятельности,
	|	УзлыИсточники.СтатьяРасходов,
	|	УзлыИсточники.АналитикаРасходов
	|;
	|";
	#КонецОбласти
	//-- НЕ УТ
	
	#Область ВТСвязиОтклоненийПредварительная
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ ПЕРВЫЕ 9999999999999
	|	""1"" КАК ЗапросИсточник,
	|	ВЫРАЗИТЬ(УзлыИсточники.НомерУзла КАК ЧИСЛО(31,0)) КАК НомерУзлаИсточник,
	|	(ВЫБОР
	|		КОГДА НЕ УзлыПриемникиФилиалы.НомерУзла ЕСТЬ NULL
	|			ТОГДА УзлыПриемникиФилиалы.НомерУзла
	|		ИНАЧЕ УзлыПриемники.НомерУзла КОНЕЦ) КАК НомерУзлаПриемник,
	|	Т.Номенклатура,
	|	Т.МестоХранения,
	|	Т.КорНоменклатура,
	|	Т.КорМестоХранения,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
	|	УзлыИсточники.ПериодРаспределения КАК ПериодРаспределенияИсточника,
	|	(ВЫБОР
	|		КОГДА НЕ УзлыПриемникиФилиалы.ПериодРаспределения ЕСТЬ NULL
	|			ТОГДА УзлыПриемникиФилиалы.ПериодРаспределения
	|		ИНАЧЕ УзлыПриемники.ПериодРаспределения КОНЕЦ) КАК ПериодРаспределенияПриемника,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	СУММА(Т.Количество) КАК Количество,
	|	СУММА(Т.Количество) КАК КоличествоСНДС,
	|	СУММА(Т.Количество) КАК КоличествоБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ Т.Количество КОНЕЦ) КАК КоличествоРегл,
	|	СУММА(Т.Количество) КАК КоличествоНУ,
	|	СУММА(ВЫБОР
	|		КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ Т.Количество КОНЕЦ) КАК КоличествоУпр
	|
	|ПОМЕСТИТЬ ВТСвязиОтклоненийПредварительная
	|ИЗ
	|	ВтДвиженияСебестоимостиТоваровПоПериодам КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыИсточники
	|		ПО УзлыИсточники.Организация = Т.Организация
	|		И УзлыИсточники.Номенклатура = Т.Номенклатура
	|		И УзлыИсточники.Характеристика = Т.Характеристика
	|		И УзлыИсточники.ВидЗапасов = Т.ВидЗапасов
	|		И УзлыИсточники.НаправлениеДеятельности = Т.НаправлениеДеятельности	
	|		И УзлыИсточники.Подразделение = Т.Подразделение
	|		И УзлыИсточники.МестоХранения = Т.МестоХранения
	|		И УзлыИсточники.РазделУчета = Т.РазделУчета
	|		И УзлыИсточники.ПериодРаспределения = Т.ПериодРаспределения
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемники
	|		ПО УзлыПриемники.Организация = Т.Организация
	|		И УзлыПриемники.Номенклатура = Т.КорНоменклатура
	|		И УзлыПриемники.Характеристика = Т.КорХарактеристика
	|		И УзлыПриемники.ВидЗапасов = Т.КорВидЗапасов
	|		И УзлыПриемники.НаправлениеДеятельности = Т.КорНаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Т.КорПодразделение
	|		И УзлыПриемники.МестоХранения = Т.КорМестоХранения
	|		И УзлыПриемники.РазделУчета = Т.КорРазделУчета
	|		И УзлыПриемники.ПериодРаспределения = Т.ПериодРаспределения
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемникиФилиалы
	|		ПО УзлыПриемникиФилиалы.Организация = Т.КорОрганизация
	|		И УзлыПриемникиФилиалы.Номенклатура = Т.КорНоменклатура
	|		И УзлыПриемникиФилиалы.Характеристика = Т.КорХарактеристика
	|		И УзлыПриемникиФилиалы.ВидЗапасов = Т.КорВидЗапасов
	|		И УзлыПриемникиФилиалы.НаправлениеДеятельности = Т.КорНаправлениеДеятельности	
	|		И УзлыПриемникиФилиалы.Подразделение = Т.КорПодразделение
	|		И УзлыПриемникиФилиалы.МестоХранения = Т.КорМестоХранения
	|		И УзлыПриемникиФилиалы.РазделУчета = Т.КорРазделУчета
	|		И УзлыПриемникиФилиалы.ПериодРаспределения = Т.ПериодРаспределения
	|		И Т.КорОрганизация <> Т.Организация
	|		И Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|ГДЕ
	|	Т.ЕстьКорЧасть
	|
	|СГРУППИРОВАТЬ ПО
	|	УзлыИсточники.НомерУзла,
	|	(ВЫБОР
	|		КОГДА НЕ УзлыПриемникиФилиалы.НомерУзла ЕСТЬ NULL
	|			ТОГДА УзлыПриемникиФилиалы.НомерУзла
	|		ИНАЧЕ УзлыПриемники.НомерУзла КОНЕЦ), // НомерУзлаПриемник
	|	Т.Номенклатура,
	|	Т.МестоХранения,
	|	Т.КорНоменклатура,
	|	Т.КорМестоХранения,
	|	УзлыИсточники.ПериодРаспределения,
	|	(ВЫБОР
	|		КОГДА НЕ УзлыПриемникиФилиалы.ПериодРаспределения ЕСТЬ NULL
	|			ТОГДА УзлыПриемникиФилиалы.ПериодРаспределения
	|		ИНАЧЕ УзлыПриемники.ПериодРаспределения КОНЕЦ) // ПериодРаспределенияПриемника
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Списание номенклатуры на постатейные расходы.
	// Условия заполнения показателей Количество должны соответствовать функциям ТекстСвязиУзловДополнительныхРасходов() и
	// ТекстВтТаблицаСвязейПостатейныеРасходы() #Область ТекстЗапросаСписаниеМатериаловНаСтатьи.
	|ВЫБРАТЬ
	|	""2"" КАК ЗапросИсточник,
	|	ВЫРАЗИТЬ(УзлыИсточники.НомерУзла КАК ЧИСЛО(31,0)) КАК НомерУзлаИсточник,
	|	УзлыПриемники.НомерУзла КАК НомерУзлаПриемник,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.МестоХранения КАК МестоХранения,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК КорНоменклатура,
	|	НЕОПРЕДЕЛЕНО КАК КорМестоХранения,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	УзлыИсточники.ПериодРаспределения КАК ПериодРаспределенияИсточника,
	|	&НачалоПериода КАК ПериодРаспределенияПриемника,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	СУММА(Т.Количество) КАК Количество,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ СтатьиРасходовСписания.ВариантРаспределенияРасходовУпр В (
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров),
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаОбъектыВозникновенияЗатрат)
	|				)
	|			ТОГДА 0
	|		ИНАЧЕ Т.Количество КОНЕЦ) КАК КоличествоСНДС,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ СтатьиРасходовСписания.ВариантРаспределенияРасходовУпр В (
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров),
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаОбъектыВозникновенияЗатрат)
	|				)
	|			ТОГДА 0
	|		ИНАЧЕ Т.Количество КОНЕЦ) КАК КоличествоБезНДС,
	|	СУММА(ВЫБОР
	// При выпуске продукции по плановой стоимости со списанием отклонений на себестоимость продаж 
	// постатейные расходы регл не учитываются в стоимости прочих расходов.
	|			КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|			 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|				ТОГДА 0
	|		КОГДА НЕ СтатьиРасходовСписания.ВариантРаспределенияРасходовРегл В (
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров),
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаОбъектыВозникновенияЗатрат)
	|				)
	|			ТОГДА 0
	|		ИНАЧЕ Т.Количество КОНЕЦ) КАК КоличествоРегл,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ СтатьиРасходовСписания.ВариантРаспределенияРасходовНУ В (
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров),
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаОбъектыВозникновенияЗатрат)
	|				)
	|			ТОГДА 0
	|		ИНАЧЕ Т.Количество КОНЕЦ) КАК КоличествоНУ,
	|	СУММА(ВЫБОР
	// При выпуске продукции по плановой стоимости со списанием отклонений на себестоимость продаж 
	// постатейные расходы упр не учитываются в стоимости прочих расходов. 
	|			КОГДА Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|			 И ВТУчетныеПолитикиФинУчета.УчетГотовойПродукцииПоПлановойСтоимости
	|			 И ВТУчетныеПолитикиФинУчета.СписыватьОтклоненияВСтоимостиПродукцииНаСебестоимостьПродаж
	|				ТОГДА 0
	|		КОГДА НЕ СтатьиРасходовСписания.ВариантРаспределенияРасходовУпр В (
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров),
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства), 
	|				ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаОбъектыВозникновенияЗатрат)
	|				)
	|			ТОГДА 0
	|		ИНАЧЕ Т.Количество КОНЕЦ) КАК КоличествоУпр
	|ИЗ
	|	ВтДвиженияСебестоимостиТоваровПоПериодам КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыИсточники
	|		ПО УзлыИсточники.Организация = Т.Организация
	|		И УзлыИсточники.Номенклатура = Т.Номенклатура
	|		И УзлыИсточники.Характеристика = Т.Характеристика
	|		И УзлыИсточники.ВидЗапасов = Т.ВидЗапасов
	|		И УзлыИсточники.НаправлениеДеятельности = Т.НаправлениеДеятельности	
	|		И УзлыИсточники.Подразделение = Т.Подразделение
	|		И УзлыИсточники.МестоХранения = Т.МестоХранения
	|		И УзлыИсточники.РазделУчета = Т.РазделУчета
	|		И УзлыИсточники.ПериодРаспределения = Т.ПериодРаспределения
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемники
	|		ПО УзлыПриемники.Организация = Т.Организация
	|		И УзлыПриемники.НаправлениеДеятельности = Т.КорНаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Т.КорПодразделение
	|		И УзлыПриемники.СтатьяРасходов = Т.СтатьяРасходовСписания
	|		И УзлыПриемники.АналитикаРасходов = Т.АналитикаРасходов
	|		И УзлыПриемники.РазделУчета = НЕОПРЕДЕЛЕНО
	|		И НЕ УзлыПриемники.ЭтоНЗП
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходовСписания
	|		ПО СтатьиРасходовСписания.Ссылка = Т.СтатьяРасходовСписания
	|ГДЕ
	|	НЕ Т.ЕстьКорЧасть
	// Отклонения в стоимости товаров не распределяются между организациями в управленческом учете предприятия.
	|	И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВЫРАЗИТЬ(УзлыИсточники.НомерУзла КАК ЧИСЛО(31,0)),
	|	УзлыПриемники.НомерУзла,
	|	УзлыИсточники.ПериодРаспределения,
	|	Т.Номенклатура,
	|	Т.МестоХранения,
	|	Т.СтатьяРасходовСписания
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Распределение доп расходов на товары.
	|ВЫБРАТЬ
	|	""3"" КАК ЗапросИсточник,
	|	Связи.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	УзлыПриемники.НомерУзла КАК НомерУзлаПриемник,
	|	Связи.КорНоменклатура КАК Номенклатура,
	|	Связи.КорМестоХранения КАК МестоХранения,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК КорНоменклатура,
	|	НЕОПРЕДЕЛЕНО КАК КорМестоХранения,
	|	Связи.СтатьяРасходов КАК СтатьяРасходовСписания,
	|	&НачалоПериода КАК ПериодРаспределенияИсточника,
	|	&НачалоПериода КАК ПериодРаспределенияПриемника,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	0					КАК Количество,
	|	Связи.ВесДугиСНДС	КАК КоличествоСНДС,
	|	Связи.ВесДугиБезНДС КАК КоличествоБезНДС,
	|	Связи.ВесДугиРегл	КАК КоличествоРегл,
	|	(ВЫБОР
	|		КОГДА Связи.НеРаспределяетсяВНалУчете ИЛИ НЕ Связи.ПринимаемыеВНУ
	|			ТОГДА 0
	|		ИНАЧЕ Связи.ВесДугиНУ КОНЕЦ) КАК КоличествоНУ,
	|	Связи.ВесДугиУпр	КАК КоличествоУпр
	|ИЗ
	|	ВтСвязиРаспределениеДопРасходов КАК Связи
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемники
	|		ПО УзлыПриемники.Организация = Связи.КорОрганизация
	|		И УзлыПриемники.Номенклатура = Связи.КорНоменклатура
	|		И УзлыПриемники.Характеристика = Связи.КорХарактеристика
	|		И УзлыПриемники.ВидЗапасов = Связи.КорВидЗапасов
	|		И УзлыПриемники.НаправлениеДеятельности = Связи.КорНаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Связи.КорПодразделение
	|		И УзлыПриемники.МестоХранения = Связи.КорМестоХранения
	|		И УзлыПриемники.РазделУчета = НЕОПРЕДЕЛЕНО
	|		И УзлыПриемники.ПериодРаспределения = &НачалоПериода
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Распределение постатейных производственных расходов на партии производства.
	|ВЫБРАТЬ
	|	""4"" КАК ЗапросИсточник,
	|	УзлыИсточники.НомерУзла КАК НомерУзлаИсточник,
	|	Связи.НомерУзлаПриемник КАК НомерУзлаПриемник,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО КАК МестоХранения,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК КорНоменклатура,
	|	НЕОПРЕДЕЛЕНО КАК КорМестоХранения,
	|	УзлыПриемники.СтатьяРасходов КАК СтатьяРасходовСписания,
	|	&НачалоПериода КАК ПериодРаспределенияИсточника,
	|	&НачалоПериода КАК ПериодРаспределенияПриемника,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	0 КАК Количество,
	|	Связи.ВесДугиПостатейныеРасходыСНДС КАК КоличествоСНДС,
	|	Связи.ВесДугиПостатейныеРасходыБезНДС КАК КоличествоБезНДС,
	|	Связи.ВесДугиПостатейныеРасходыРегл КАК КоличествоРегл,
	|	(ВЫБОР
	|		КОГДА Связи.НеРаспределяетсяВНалУчете ИЛИ НЕ Связи.ПринимаемыеВНУ
	|			ТОГДА 0
	|		ИНАЧЕ Связи.ВесДугиПостатейныеРасходыНУ КОНЕЦ) КАК КоличествоНУ,
	|	Связи.ВесДугиПостатейныеРасходыУпр КАК КоличествоУпр
	|ИЗ
	|	ВтТаблицаСвязейПостатейныеРасходы КАК Связи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзлаПостатейные = Связи.НомерУзлаИсточник
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиПостатейныеРасходыНЗП КАК УзлыПриемники
	|		ПО УзлыПриемники.НомерУзла = Связи.НомерУзлаПриемник
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Распределение постатейных производственных расходов на выпущенную продукцию.
	|ВЫБРАТЬ
	|	""5"" КАК ЗапросИсточник,
	|	Связи.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	УзлыПриемники.НомерУзла КАК НомерУзлаПриемник,
	|	Связи.КорНоменклатура КАК Номенклатура,
	|	Связи.КорМестоХранения КАК МестоХранения,
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка) КАК КорНоменклатура,
	|	НЕОПРЕДЕЛЕНО КАК КорМестоХранения,
	|	Связи.СтатьяРасходов КАК СтатьяРасходовСписания,
	|	&НачалоПериода КАК ПериодРаспределенияИсточника,
	|	&НачалоПериода КАК ПериодРаспределенияПриемника,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	0					КАК Количество,
	|	Связи.ВесДугиСНДС	КАК КоличествоСНДС,
	|	Связи.ВесДугиБезНДС КАК КоличествоБезНДС,
	|	Связи.ВесДугиРегл	КАК КоличествоРегл,
	|	Связи.ВесДугиНУ		КАК КоличествоНУ,
	|	Связи.ВесДугиУпр	КАК КоличествоУпр
	|ИЗ
	|	ВтСвязиРаспределениеПостатейныхНаВыпуск КАК Связи
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемники
	|		ПО УзлыПриемники.Организация = Связи.КорОрганизация
	|		И УзлыПриемники.Номенклатура = Связи.КорНоменклатура
	|		И УзлыПриемники.Характеристика = Связи.КорХарактеристика
	|		И УзлыПриемники.ВидЗапасов = Связи.КорВидЗапасов
	|		И УзлыПриемники.НаправлениеДеятельности = Связи.КорНаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Связи.КорПодразделение
	|		И УзлыПриемники.МестоХранения = Связи.КорМестоХранения
	|		И УзлыПриемники.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		И УзлыПриемники.ПериодРаспределения = &НачалоПериода
	//-- НЕ УТ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""6"" КАК ЗапросИсточник,
	|	УзлыИсточники.НомерУзла КАК НомерУзлаИсточник,
	|	УзлыПриемники.НомерУзла КАК НомерУзлаПриемник,
	|	Т.Номенклатура,
	|	Т.МестоХранения,
	|	Т.Номенклатура КАК КорНоменклатура,
	|	Т.МестоХранения КАК КорМестоХранения,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
	|	УзлыИсточники.ПериодРаспределения КАК ПериодИсточника,
	|	УзлыПриемники.ПериодРаспределения КАК ПериодПриемника,
	|	ИСТИНА КАК ЭтоОстатки,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК Количество,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК КоличествоСНДС,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК КоличествоБезНДС,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК КоличествоРегл,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК КоличествоНУ,
	|	СУММА(Т.КоличествоНачальныйОстаток) КАК КоличествоУпр
	|ИЗ
	|	ВтУзлыКорректировкиПрошлыхПериодов КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыИсточники
	|		ПО УзлыИсточники.Организация = Т.Организация
	|		И УзлыИсточники.Номенклатура = Т.Номенклатура
	|		И УзлыИсточники.Характеристика = Т.Характеристика
	|		И УзлыИсточники.ВидЗапасов = Т.ВидЗапасов
	|		И УзлыИсточники.НаправлениеДеятельности = Т.НаправлениеДеятельности	
	|		И УзлыИсточники.Подразделение = Т.Подразделение
	|		И УзлыИсточники.МестоХранения = Т.МестоХранения
	|		И УзлыИсточники.РазделУчета = Т.РазделУчета
	|		И УзлыИсточники.ПериодРаспределения = Т.ПериодРаспределенияПредыдущий
	|		И Т.КоличествоНачальныйОстаток <> 0
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемники
	|		ПО УзлыПриемники.Организация = Т.Организация
	|		И УзлыПриемники.Номенклатура = Т.Номенклатура
	|		И УзлыПриемники.Характеристика = Т.Характеристика
	|		И УзлыПриемники.ВидЗапасов = Т.ВидЗапасов
	|		И УзлыПриемники.НаправлениеДеятельности = Т.НаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Т.Подразделение
	|		И УзлыПриемники.МестоХранения = Т.МестоХранения
	|		И УзлыИсточники.РазделУчета = Т.РазделУчета
	|		И УзлыПриемники.ПериодРаспределения = Т.ПериодРаспределения
	|
	|СГРУППИРОВАТЬ ПО
	|	УзлыИсточники.НомерУзла,
	|	УзлыПриемники.НомерУзла,
	|	Т.Номенклатура,
	|	Т.МестоХранения,
	|	УзлыИсточники.ПериодРаспределения,
	|	УзлыПриемники.ПериодРаспределения
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""7"" КАК ЗапросИсточник,
	|	УзлыИсточники.НомерУзла КАК НомерУзлаИсточник,
	|	УзлыПриемники.НомерУзла КАК НомерУзлаПриемник,
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.МестоХранения КАК МестоХранения,
	|	Т.КорНоменклатура КАК КорНоменклатура,
	|	Т.КорМестоХранения КАК КорМестоХранения,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
	|	УзлыИсточники.ПериодРаспределения КАК ПериодИсточника,
	|	УзлыПриемники.ПериодРаспределения КАК ПериодПриемника,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	СУММА(-Т.Количество) КАК Количество,
	|	СУММА(-Т.Количество) КАК КоличествоСНДС,
	|	СУММА(-Т.Количество) КАК КоличествоБезНДС,
	|	СУММА(-Т.Количество) КАК КоличествоРегл,
	|	СУММА(-Т.Количество) КАК КоличествоНУ,
	|	СУММА(-Т.Количество) КАК КоличествоУпр
	|ИЗ
	|	ВтСторноПеремещенийПрошлогоПериода КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыИсточники
	|		ПО УзлыИсточники.Организация = Т.Организация
	|		И УзлыИсточники.Номенклатура = Т.Номенклатура
	|		И УзлыИсточники.Характеристика = Т.Характеристика
	|		И УзлыИсточники.ВидЗапасов = Т.ВидЗапасов
	|		И УзлыИсточники.НаправлениеДеятельности = Т.НаправлениеДеятельности	
	|		И УзлыИсточники.Подразделение = Т.Подразделение
	|		И УзлыИсточники.МестоХранения = Т.МестоХранения
	|		И УзлыИсточники.РазделУчета = Т.РазделУчета
	|		И УзлыИсточники.ПериодРаспределения = Т.ПериодРаспределения
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемники
	|		ПО УзлыПриемники.Организация = Т.Организация
	|		И УзлыПриемники.Номенклатура = Т.КорНоменклатура
	|		И УзлыПриемники.Характеристика = Т.КорХарактеристика
	|		И УзлыПриемники.ВидЗапасов = Т.КорВидЗапасов
	|		И УзлыПриемники.НаправлениеДеятельности = Т.КорНаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Т.КорПодразделение
	|		И УзлыПриемники.МестоХранения = Т.КорМестоХранения
	|		И УзлыИсточники.РазделУчета = Т.КорРазделУчета
	|		И УзлыПриемники.ПериодРаспределения = Т.ПериодРаспределения
	|
	|СГРУППИРОВАТЬ ПО
	|	УзлыИсточники.НомерУзла,
	|	УзлыПриемники.НомерУзла,
	|	Т.Номенклатура,
	|	Т.МестоХранения,
	|	Т.КорНоменклатура,
	|	Т.КорМестоХранения,
	|	УзлыИсточники.ПериодРаспределения,
	|	УзлыПриемники.ПериодРаспределения
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерУзлаИсточник,
	|	НомерУзлаПриемник
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаИсточник
	|;
	|";
	#КонецОбласти
	
	#Область ВТСвязиОтклонений
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник,
	|	Т.Номенклатура,
	|	Т.МестоХранения,
	|	Т.КорНоменклатура,
	|	Т.КорМестоХранения,
	|	Т.СтатьяРасходовСписания,
	|	Т.ПериодРаспределенияИсточника,
	|	Т.ПериодРаспределенияПриемника,
	|	Т.ЭтоОстатки,
	|	СУММА(Т.Количество) КАК Количество,
	|	СУММА(Т.КоличествоСНДС) КАК КоличествоСНДС,
	|	СУММА(Т.КоличествоБезНДС) КАК КоличествоБезНДС,
	|	СУММА(Т.КоличествоРегл) КАК КоличествоРегл,
	|	СУММА(Т.КоличествоНУ) КАК КоличествоНУ,
	|	СУММА(Т.КоличествоУпр) КАК КоличествоУпр
	|
	|ПОМЕСТИТЬ ВТСвязиОтклонений
	|ИЗ
	|	ВТСвязиОтклоненийПредварительная КАК Т
	|ГДЕ
	|	Т.НомерУзлаИсточник <> Т.НомерУзлаПриемник
	|СГРУППИРОВАТЬ ПО
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник,
	|	Т.Номенклатура,
	|	Т.МестоХранения,
	|	Т.КорНоменклатура,
	|	Т.КорМестоХранения,
	|	Т.СтатьяРасходовСписания,
	|	Т.ПериодРаспределенияИсточника,
	|	Т.ПериодРаспределенияПриемника,
	|	Т.ЭтоОстатки
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаИсточник
	|;
	|";
	#КонецОбласти
	
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

Функция ТекстРаспределитьОтклоненияВСтоимостиТоваровФормированиеДвижений(ПараметрыРасчета)
	
	ТекстЗапроса = "";
	
	#Область НачальнаяСтоимостьПостояннаяРазница
	// Запрос используется для показа временной таблицы НачальнаяСтоимостьПостояннаяРазница во внешней обработке.
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	Т.НомерУзла,
	|	Т.ПостояннаяРазница
	|ПОМЕСТИТЬ НачальнаяСтоимостьПостояннаяРазницаРезультат
	|ИЗ
	|	НачальнаяСтоимостьПостояннаяРазница КАК Т
	|;";
	#КонецОбласти
	
	#Область ТаблицаРешенийДетально
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ВЫРАЗИТЬ(Узлы.НомерУзла КАК ЧИСЛО(31,0)) КАК НомерУзла,
	|	Регистраторы.Ссылка КАК Регистратор,
	|	Узлы.ПериодОтклонения,
	|	Узлы.ПериодРаспределения,
	|	Узлы.РазделУчета,
	|	Узлы.Организация,
	|	Узлы.Номенклатура,
	|	Узлы.Характеристика,
	|	Узлы.ВидЗапасов,
	|	Узлы.НаправлениеДеятельности,
	|	Узлы.Подразделение,
	|	Узлы.МестоХранения,
	|	ЕСТЬNULL(УпрСНДС.ОтклоненияВСтоимостиСНДС, 0) КАК ОтклоненияВСтоимостиСНДС,
	|	ЕСТЬNULL(УпрБезНДС.ОтклоненияВСтоимостиБезНДС, 0) КАК ОтклоненияВСтоимостиБезНДС,
	|	ЕСТЬNULL(Регл.ОтклоненияВСтоимостиРегл, 0) КАК ОтклоненияВСтоимостиРегл,
	|	ЕСТЬNULL(Упр.ОтклоненияВСтоимостиУпр, 0) КАК ОтклоненияВСтоимостиУпр,
	|	ЕСТЬNULL(УпрСНДС.ДопРасходыСНДС, 0) КАК ДопРасходыСНДС,
	|	ЕСТЬNULL(УпрБезНДС.ДопРасходыБезНДС, 0) КАК ДопРасходыБезНДС,
	|	ЕСТЬNULL(Регл.ДопРасходыРегл, 0) КАК ДопРасходыРегл,
	|	ЕСТЬNULL(Упр.ДопРасходыУпр, 0) КАК ДопРасходыУпр,
	|	ЕСТЬNULL(Регл.НДСРегл, 0) КАК НДСРегл,
	|	ЕСТЬNULL(Упр.НДСУпр, 0) КАК НДСУпр,
	|	ЕСТЬNULL(ПР.ПостояннаяРазница, 0) КАК ПостояннаяРазница,
	|	ЕСТЬNULL(Регл.ОтклоненияВСтоимостиРегл, 0)
	|		+ ЕСТЬNULL(Регл.ДопРасходыРегл, 0)
	|		+ ЕСТЬNULL(Регл.НДСРегл, 0)
	|		- ЕСТЬNULL(НУ.СтоимостьНУ, 0)
	|		- ЕСТЬNULL(ПР.ПостояннаяРазница, 0) КАК ВременнаяРазница,
	|	ЕСТЬNULL(НУ.СтоимостьНУ, 0) КАК СтоимостьНУ,
	|	ЕСТЬNULL(НУ.НДД, 0) КАК НДД,
	|	(ВЫБОР
	|		КОГДА Регл.НомерУзла ЕСТЬ NULL
	|		 И УпрСНДС.НомерУзла ЕСТЬ NULL
	|		 И УпрБезНДС.НомерУзла ЕСТЬ NULL
	|		 И Упр.НомерУзла ЕСТЬ NULL
	|		 И НУ.НомерУзла ЕСТЬ NULL
	|		 И ПР.НомерУзла ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА КОНЕЦ) КАК ЕстьСтоимость
	|
	|ПОМЕСТИТЬ ТаблицаРешенийДетально
	|ИЗ
	|	ВТУзлыОтклонений КАК Узлы
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийСНДС КАК УпрСНДС
	|		ПО УпрСНДС.НомерУзла = Узлы.НомерУзла
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийБезНДС КАК УпрБезНДС
	|		ПО УпрБезНДС.НомерУзла = Узлы.НомерУзла
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийУпр КАК Упр
	|		ПО Упр.НомерУзла = Узлы.НомерУзла
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийРегл КАК Регл
	|		ПО Регл.НомерУзла = Узлы.НомерУзла
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийНУ КАК НУ
	|		ПО НУ.НомерУзла = Узлы.НомерУзла
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийПР КАК ПР
	|		ПО ПР.НомерУзла = Узлы.НомерУзла
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК Регистраторы
	|		ПО Узлы.Организация = Регистраторы.Организация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзла
	|;";
	#КонецОбласти
	
	#Область ВтВыпуски
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	|	МИНИМУМ(Т.Период) КАК Период,
	|	МИНИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ ВтВыпуски
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Т.Организация В (&ОрганизацииСреднескользящая)
	|	И Т.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|	И Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииНаСклад),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииВПодразделение))
	|	И Т.СлужебноеВидДвиженияПриход
	|	И Т.Количество <> 0
	|	И &РежимЗакрытияМесяца <> ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика,
	|	Т.ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ, // НаправлениеДеятельности
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ, // Подразделение
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ // МестоХранения
	|;";
	#КонецОбласти
	
	#Область ТаблицаИдентификаторов
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	ТаблицаИдентификаторов.Идентификатор КАК Идентификатор,
	|	ТаблицаИдентификаторов.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	ТаблицаИдентификаторов.НомерУзлаПриемник КАК НомерУзлаПриемник
	|
	|ПОМЕСТИТЬ ТаблицаИдентификаторов
	|ИЗ
	|	&ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|
	|ИНДЕКСИРОВАТЬ ПО НАБОРАМ
	|(
	|	(НомерУзлаИсточник,	НомерУзлаПриемник),
	|	(НомерУзлаПриемник, НомерУзлаИсточник)
	|)
	|;";
	#КонецОбласти
	
	#Область ВтНеактуальныеДвиженияПредварительная
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ИСТИНА КАК ЕстьДвижения,
	|	Т.ЕстьКорЧасть,
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	Т.Период,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	ДАТАВРЕМЯ(1,1,1) КАК ПериодОтклонения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	// Поле НастройкаХозяйственнойОперации должно заполняться аналогично запросу #Область ВтВыбытияДляОтклонений
	// с ЗапросИсточник = ""1""
	|	(ВЫБОР
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаПрочиеЦели)
	|		 ИЛИ Т.СтатьяАктивовПассивов <> НЕОПРЕДЕЛЕНО
	|		 И Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаНаПрочиеЦелиОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
	|		 И Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаПродукцииИзПроизводстваОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтчетДавальцуМеждуОрганизациямиОтклонения)
	|		КОГДА НЕ Т.ЕстьКорЧасть
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|		 И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеНаРасходыОтклонения)
	|		ИНАЧЕ Т.НастройкаХозяйственнойОперации КОНЕЦ) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	// Ресурсы
	|	0 КАК Количество,
	|	0 КАК ОтклоненияВСтоимостиСНДС,
	|	0 КАК ОтклоненияВСтоимостиБезНДС,
	|	0 КАК ОтклоненияВСтоимостиРегл,
	|	0 КАК ОтклоненияВСтоимостиУпр,
	|	0 КАК ДопРасходыСНДС,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК НДД
	|
	|ПОМЕСТИТЬ ВтНеактуальныеДвиженияПредварительная
	|ИЗ
	|	ВтДвиженияСебестоимостиТоваровПоПериодамДетальные КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Сторно движения по регистру "Отклонения в стоимости товаров". Таких движений нет в таблице ВтДвиженияСебестоимостиТоваровПоПериодамДетальные
	|ВЫБРАТЬ
	|	ИСТИНА КАК ЕстьДвижения,
	|	Т.ЕстьКорЧасть,
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	Т.Период,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.ПериодОтклонения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	// Поле НастройкаХозяйственнойОперации должно заполняться аналогично запросу с ЗапросИсточник = ""1"".
	|	(ВЫБОР
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаПрочиеЦели)
	|		 ИЛИ Т.СтатьяАктивовПассивов <> НЕОПРЕДЕЛЕНО
	|		 И Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаНаПрочиеЦелиОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
	|		 И Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаПродукцииИзПроизводстваОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтчетДавальцуМеждуОрганизациямиОтклонения)
	|		КОГДА НЕ Т.ЕстьКорЧасть
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|		 И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеНаРасходыОтклонения)
	|		ИНАЧЕ Т.НастройкаХозяйственнойОперации КОНЕЦ) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	&НачалоПериода КАК ПериодРаспределения,
	// Ресурсы
	|	0 КАК Количество,
	|	0 КАК ОтклоненияВСтоимостиСНДС,
	|	0 КАК ОтклоненияВСтоимостиБезНДС,
	|	0 КАК ОтклоненияВСтоимостиРегл,
	|	0 КАК ОтклоненияВСтоимостиУпр,
	|	0 КАК ДопРасходыСНДС,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК НДСРегл,
	|	0 КАК НДСУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК НДД
	|ИЗ
	|	ВтСторноОтклоненийПрошлогоПериода КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЛОЖЬ КАК ЕстьДвижения,
	|	ВЫБОР
	|		КОГДА КорДвижения.Регистратор ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ 
	|		ИНАЧЕ ИСТИНА КОНЕЦ КАК ЕстьКорЧасть,
	|	Регистраторы.Ссылка КАК Регистратор,
	|	Т.Период,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	Т.ПериодОтклонения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	// Ресурсы
	|	-Т.Количество КАК Количество,
	|	-Т.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|	-Т.ОтклоненияВСтоимостиБезНДС КАК ОтклоненияВСтоимостиБезНДС,
	|	-Т.ОтклоненияВСтоимостиРегл КАК ОтклоненияВСтоимостиРегл,
	|	-Т.ОтклоненияВСтоимостиУпр КАК ОтклоненияВСтоимостиУпр,
	|	-Т.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|	-Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-Т.НДСРегл КАК НДСРегл,
	|	-Т.НДСУпр КАК НДСУпр,
	|	-Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-Т.ВременнаяРазница КАК ВременнаяРазница,
	|	-Т.НДД КАК НДД
	|ИЗ
	|	РегистрНакопления.ОтклоненияВСтоимостиТоваров КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК Регистраторы
	|		ПО Т.Организация = Регистраторы.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОтклоненияВСтоимостиТоваров КАК КорДвижения
	|		ПО КорДвижения.Регистратор = Т.Регистратор
	|		И КорДвижения.Период = Т.Период
	|		И КорДвижения.НастройкаХозяйственнойОперации = Т.НастройкаХозяйственнойОперации
	|		И КорДвижения.ИдентификаторФинЗаписи = Т.ИдентификаторФинЗаписи
	|		И КорДвижения.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		И КорДвижения.ОтклоненияВСтоимостиСНДС = Т.ОтклоненияВСтоимостиСНДС
	|		И КорДвижения.ОтклоненияВСтоимостиРегл = Т.ОтклоненияВСтоимостиРегл
	|		И КорДвижения.ДопРасходыСНДС = Т.ДопРасходыСНДС
	|		И КорДвижения.ДопРасходыРегл = Т.ДопРасходыРегл
	|		И КорДвижения.НДСРегл = Т.НДСРегл
	|		И КорДвижения.ПостояннаяРазница = Т.ПостояннаяРазница
	|		И КорДвижения.ВременнаяРазница = Т.ВременнаяРазница
	|ГДЕ
	|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Т.Организация В (&МассивОрганизаций)
	|	И Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И Т.Регистратор ССЫЛКА Документ.РегистраторРасчетаСебестоимости
	|	И НЕ Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносОтклоненийВСтоимостиТоваров),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж))
	// Сторно движения исключаются в запросе формирования временной таблицы ВтДвиженияСебестоимостиТоваровПоПериодамДетальные.
	|	И НЕ Т.Сторно
	|;
	|";
	#КонецОбласти
	
	#Область ВтНеактуальныеДвижения
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	МАКСИМУМ(Т.ЕстьДвижения) КАК ЕстьДвижения,
	|	МАКСИМУМ(Т.ЕстьКорЧасть) КАК ЕстьКорЧасть,
	|	МАКСИМУМ(Т.Регистратор) КАК Регистратор,
	|	Т.Период,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|	МАКСИМУМ(Т.ПериодОтклонения) КАК ПериодОтклонения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	МАКСИМУМ(Т.ИдентификаторФинЗаписи) КАК ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	// Ресурсы
	|	СУММА(Т.Количество) КАК Количество,
	|	СУММА(Т.ОтклоненияВСтоимостиСНДС) КАК ОтклоненияВСтоимостиСНДС,
	|	СУММА(Т.ОтклоненияВСтоимостиБезНДС) КАК ОтклоненияВСтоимостиБезНДС,
	|	СУММА(Т.ОтклоненияВСтоимостиРегл) КАК ОтклоненияВСтоимостиРегл,
	|	СУММА(Т.ОтклоненияВСтоимостиУпр) КАК ОтклоненияВСтоимостиУпр,
	|	СУММА(Т.ДопРасходыСНДС) КАК ДопРасходыСНДС,
	|	СУММА(Т.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(Т.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Т.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.НДСУпр) КАК НДСУпр,
	|	СУММА(Т.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(Т.НДД) КАК НДД
	|
	|ПОМЕСТИТЬ ВтНеактуальныеДвижения
	|ИЗ
	|	ВтНеактуальныеДвиженияПредварительная КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Период,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ПериодРаспределения
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(Т.ЕстьДвижения) = ЛОЖЬ
	|	И (СУММА(Т.ОтклоненияВСтоимостиСНДС) <> 0
	|		ИЛИ СУММА(Т.ОтклоненияВСтоимостиБезНДС) <> 0
	|		ИЛИ СУММА(Т.ОтклоненияВСтоимостиРегл) <> 0
	|		ИЛИ СУММА(Т.ОтклоненияВСтоимостиУпр) <> 0
	|		ИЛИ СУММА(Т.ДопРасходыСНДС) <> 0
	|		ИЛИ СУММА(Т.ДопРасходыБезНДС) <> 0
	|		ИЛИ СУММА(Т.ДопРасходыРегл) <> 0
	|		ИЛИ СУММА(Т.ДопРасходыУпр) <> 0
	|		ИЛИ СУММА(Т.НДСРегл) <> 0
	|		ИЛИ СУММА(Т.НДСУпр) <> 0
	|		ИЛИ СУММА(Т.ПостояннаяРазница) <> 0
	|		ИЛИ СУММА(Т.ВременнаяРазница) <> 0
	|		ИЛИ СУММА(Т.НДД) <> 0)
	|;
	|";
	#КонецОбласти
	
	#Область ВтВыбытияДляОтклонений
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	""1"" КАК ЗапросИсточник,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	Т.ЭтоТекущийПериод,
	|	Т.ЕстьКорЧасть,
	|	УзлыИсточники.НомерУзла КАК НомерУзлаИсточник,
	|	ЕСТЬNULL(УзлыПриемники.НомерУзла, -1) КАК НомерУзлаПриемник,
	|	УзлыИсточники.Регистратор,
	|	Т.Период,
	|	Т.РазделУчета,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	// Поле НастройкаХозяйственнойОперации должно заполняться аналогично запросу с ЗапросИсточник = ""7"".
	// и аналогично должно быть в запросе #Область ВтНеактуальныеДвиженияПредварительная.
	|	(ВЫБОР
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаПрочиеЦели)
	|		 ИЛИ Т.СтатьяАктивовПассивов <> НЕОПРЕДЕЛЕНО
	|		 И Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаНаПрочиеЦелиОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
	|		 И Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаПродукцииИзПроизводстваОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтчетДавальцуМеждуОрганизациямиОтклонения)
	|		КОГДА НЕ Т.ЕстьКорЧасть
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|		 И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеНаРасходыОтклонения)
	|		ИНАЧЕ Т.НастройкаХозяйственнойОперации КОНЕЦ) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	УзлыИсточники.ПериодОтклонения КАК ПериодОтклоненияИсточник,
	|	ЕСТЬNULL(УзлыПриемники.ПериодОтклонения, ДАТАВРЕМЯ(1,1,1)) КАК ПериодОтклоненияПриемник,
	|	ЛОЖЬ КАК Сторно,
	|	ЛОЖЬ КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	Т.Количество КАК Количество,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ОтклоненияВСтоимостиСНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиСНДС,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ОтклоненияВСтоимостиБезНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиБезНДС,
	|	ВЫРАЗИТЬ(Т.Количество *
	|		ВЫБОР КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ УзлыИсточники.ОтклоненияВСтоимостиРегл КОНЕЦ КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиРегл,
	|	ВЫРАЗИТЬ(Т.Количество *
	|		ВЫБОР КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ УзлыИсточники.ОтклоненияВСтоимостиУпр КОНЕЦ КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиУпр,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ДопРасходыСНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыСНДС,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ДопРасходыБезНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыБезНДС,
	|	ВЫРАЗИТЬ(Т.Количество *
	|		ВЫБОР КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ УзлыИсточники.ДопРасходыРегл КОНЕЦ КАК ЧИСЛО(31,2)) КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(Т.Количество *
	|		ВЫБОР КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ УзлыИсточники.ДопРасходыУпр КОНЕЦ КАК ЧИСЛО(31,2)) КАК ДопРасходыУпр,
	|	ВЫРАЗИТЬ(Т.Количество *
	|		ВЫБОР КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ УзлыИсточники.НДСРегл КОНЕЦ КАК ЧИСЛО(31,2)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.Количество *
	|		ВЫБОР КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ УзлыИсточники.НДСУпр КОНЕЦ КАК ЧИСЛО(31,2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(Т.Количество *
	|		ВЫБОР КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж ТОГДА 0
	|		ИНАЧЕ УзлыИсточники.ПостояннаяРазница КОНЕЦ КАК ЧИСЛО(31,2)) КАК ПостояннаяРазница,
	|	ВЫРАЗИТЬ(Т.Количество *
	// Сумма регл. учета и постоянная разница списаны на себестоимость продаж, поэтому временную разницу уменьшим 
	// на сумму регл. учета и увеличиваем на сумму постоянной разницы
	|		(ВЫБОР КОГДА Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|			ТОГДА -(УзлыИсточники.ОтклоненияВСтоимостиРегл
	|				+ УзлыИсточники.ДопРасходыРегл
	|				+ УзлыИсточники.НДСРегл
	|				- УзлыИсточники.ПостояннаяРазница
	|				- УзлыИсточники.ВременнаяРазница)
	|		ИНАЧЕ УзлыИсточники.ВременнаяРазница КОНЕЦ) КАК ЧИСЛО(31,2)) КАК ВременнаяРазница,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.НДД КАК ЧИСЛО(31,2)) КАК НДД
	|
	|ПОМЕСТИТЬ ВтВыбытияДляОтклонений
	|ИЗ
	|	ВтДвиженияСебестоимостиТоваровПоПериодамДетальные КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРешенийДетально КАК УзлыИсточники
	|		ПО УзлыИсточники.Организация = Т.Организация
	|		И УзлыИсточники.Номенклатура = Т.Номенклатура
	|		И УзлыИсточники.Характеристика = Т.Характеристика
	|		И УзлыИсточники.ВидЗапасов = Т.ВидЗапасов
	|		И УзлыИсточники.НаправлениеДеятельности = Т.НаправлениеДеятельности	
	|		И УзлыИсточники.Подразделение = Т.Подразделение
	|		И УзлыИсточники.МестоХранения = Т.МестоХранения
	|		И УзлыИсточники.РазделУчета = Т.РазделУчета
	|		И УзлыИсточники.ПериодРаспределения = Т.ПериодРаспределения
	|		И УзлыИсточники.ПериодОтклонения <= Т.ПериодРаспределения
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаРешенийДетально КАК УзлыПриемники
	|		ПО УзлыПриемники.Номенклатура = Т.КорНоменклатура И Т.КорНоменклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|		И УзлыПриемники.Характеристика = Т.КорХарактеристика
	|		И УзлыПриемники.ВидЗапасов = Т.КорВидЗапасов
	|		И УзлыПриемники.НаправлениеДеятельности = Т.КорНаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Т.КорПодразделение
	|		И УзлыПриемники.МестоХранения = Т.КорМестоХранения
	|		И УзлыПриемники.РазделУчета = Т.КорРазделУчета
	|		И УзлыПриемники.ПериодРаспределения = Т.ПериодРаспределения
	|		И УзлыПриемники.ПериодОтклонения <= Т.ПериодРаспределения
	|		И (ВЫБОР КОГДА Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА Т.КорОрганизация ИНАЧЕ Т.Организация КОНЕЦ) = УзлыПриемники.Организация
	|ГДЕ
	|	(УзлыПриемники.Организация ЕСТЬ NULL
	|		ИЛИ УзлыИсточники.Организация <> УзлыПриемники.Организация
	|		ИЛИ УзлыИсточники.Номенклатура <> УзлыПриемники.Номенклатура
	|		ИЛИ УзлыИсточники.Характеристика <> УзлыПриемники.Характеристика
	|		ИЛИ УзлыИсточники.ВидЗапасов <> УзлыПриемники.ВидЗапасов
	|		ИЛИ УзлыИсточники.НаправлениеДеятельности <> УзлыПриемники.НаправлениеДеятельности
	|		ИЛИ УзлыИсточники.Подразделение <> УзлыПриемники.Подразделение
	|		ИЛИ УзлыИсточники.МестоХранения <> УзлыПриемники.МестоХранения
	|		ИЛИ НЕ Т.ЕстьКорЧасть
	// При возврате от клиента в движении Расход заполнена кор аналитика учета номенклатуры.
	|		ИЛИ Т.ХозяйственнаяОперация В (
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализации),
	|			ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями))
	|		)
	|	И УзлыИсточники.ЕстьСтоимость
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Списание отклонений на себестоимость продаж.
	|ВЫБРАТЬ
	|	""2"" КАК ЗапросИсточник,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	Т.ЭтоТекущийПериод,
	|	ЛОЖЬ КАК ЕстьКорЧасть,
	|	УзлыИсточники.НомерУзла КАК НомерУзлаИсточник,
	|	-1 КАК НомерУзлаПриемник,
	|	УзлыИсточники.Регистратор,
	|	Т.Период,
	|	Т.РазделУчета,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка) КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОтклоненийНаСебестоимостьПродажОтклонения) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	УзлыИсточники.ПериодОтклонения КАК ПериодОтклоненияИсточник,
	|	ДАТАВРЕМЯ(1,1,1) КАК ПериодОтклоненияПриемник,
	|	ЛОЖЬ КАК Сторно,
	|	Т.СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	Т.Количество КАК Количество,
	|	0 КАК ОтклоненияВСтоимостиСНДС,
	|	0 КАК ОтклоненияВСтоимостиБезНДС,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ОтклоненияВСтоимостиРегл КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиРегл,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ОтклоненияВСтоимостиУпр КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиУпр,
	|	0 КАК ДопРасходыСНДС,
	|	0 КАК ДопРасходыБезНДС,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ДопРасходыРегл КАК ЧИСЛО(31,2)) КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ДопРасходыУпр КАК ЧИСЛО(31,2)) КАК ДопРасходыУпр,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.НДСРегл КАК ЧИСЛО(31,2)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.НДСУпр КАК ЧИСЛО(31,2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ПостояннаяРазница КАК ЧИСЛО(31,2)) КАК ПостояннаяРазница,
	// При выпуске продукции со списанием отклонений на себестоимость продаж стоимость по налоговому учету будет нулевая,
	// поэтому сумма временной разницы по отклонениям в стоимости должна быть отражена на полную сумму регл учета
	// за минусовм постоянной разницы.
	|	ВЫРАЗИТЬ(Т.Количество *
	|		(УзлыИсточники.ОтклоненияВСтоимостиРегл
	|		+ УзлыИсточники.ДопРасходыРегл
	|		+ УзлыИсточники.НДСРегл
	|		- УзлыИсточники.ПостояннаяРазница) КАК ЧИСЛО(31,2)) КАК ВременнаяРазница,
	|	0 КАК НДД
	|ИЗ
	|	ВтДвиженияСебестоимостиТоваровПоПериодамДетальные КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРешенийДетально КАК УзлыИсточники
	|		ПО УзлыИсточники.Организация = Т.Организация
	|		И УзлыИсточники.Номенклатура = Т.Номенклатура
	|		И УзлыИсточники.Характеристика = Т.Характеристика
	|		И УзлыИсточники.ВидЗапасов = Т.ВидЗапасов
	|		И УзлыИсточники.НаправлениеДеятельности = Т.НаправлениеДеятельности	
	|		И УзлыИсточники.Подразделение = Т.Подразделение
	|		И УзлыИсточники.МестоХранения = Т.МестоХранения
	|		И УзлыИсточники.РазделУчета = Т.РазделУчета
	|		И УзлыИсточники.ПериодРаспределения = Т.ПериодРаспределения
	|		И УзлыИсточники.ПериодОтклонения <= Т.ПериодРаспределения
	|
	|ГДЕ
	|	Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|	И УзлыИсточники.ЕстьСтоимость
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""3"" КАК ЗапросИсточник,
	|	ИСТИНА КАК ЭтоОстатки,
	|	ЛОЖЬ КАК ЭтоТекущийПериод,
	|	ИСТИНА ЕстьКорЧасть,
	|	Т.НомерУзлаИсточник,
	|   Т.НомерУзлаПриемник,
	|	УзлыИсточники.Регистратор,
	|	&НачалоПериода КАК Период,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	|	УзлыИсточники.Организация,
	|	УзлыИсточники.Номенклатура,
	|	УзлыИсточники.Характеристика,
	|	УзлыИсточники.ВидЗапасов,
	|	УзлыИсточники.НаправлениеДеятельности,
	|	УзлыИсточники.Подразделение,
	|	УзлыИсточники.МестоХранения,
	// Кор реквизиты
	|	УзлыПриемники.Организация КАК КорОрганизация,
	|	УзлыПриемники.Номенклатура КАК КорНоменклатура,
	|	УзлыПриемники.Характеристика КАК КорХарактеристика,
	|	УзлыПриемники.ВидЗапасов КАК КорВидЗапасов,
	|	УзлыПриемники.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	УзлыПриемники.Подразделение КАК КорПодразделение,
	|	УзлыПриемники.МестоХранения КАК КорМестоХранения,
	// Прочие поля
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносОтклоненийВСтоимостиТоваров) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
	|	&ИдентификаторНеиспользуемойФинЗаписи КАК ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределенияПриемника КАК ПериодРаспределения,
	|	УзлыИсточники.ПериодОтклонения КАК ПериодОтклоненияИсточник,
	|	УзлыПриемники.ПериодОтклонения КАК ПериодОтклоненияПриемник,
	|	ЛОЖЬ КАК Сторно,
	|	ЛОЖЬ КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	Т.Количество КАК Количество,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ОтклоненияВСтоимостиСНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиСНДС,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ОтклоненияВСтоимостиБезНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиБезНДС,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ОтклоненияВСтоимостиРегл КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиРегл,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ОтклоненияВСтоимостиУпр КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиУпр,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ДопРасходыСНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыСНДС,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ДопРасходыБезНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыБезНДС,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ДопРасходыРегл КАК ЧИСЛО(31,2)) КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ДопРасходыУпр КАК ЧИСЛО(31,2)) КАК ДопРасходыУпр,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.НДСРегл КАК ЧИСЛО(31,2)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.НДСУпр КАК ЧИСЛО(31,2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ПостояннаяРазница КАК ЧИСЛО(31,2)) КАК ПостояннаяРазница,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.ВременнаяРазница КАК ЧИСЛО(31,2)) КАК ВременнаяРазница,
	|	ВЫРАЗИТЬ(Т.Количество * УзлыИсточники.НДД КАК ЧИСЛО(31,2)) КАК НДД
	|
	|ИЗ
	|	ВТСвязиОтклонений КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРешенийДетально КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзла = Т.НомерУзлаИсточник
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРешенийДетально КАК УзлыПриемники
	|		ПО УзлыПриемники.НомерУзла = Т.НомерУзлаПриемник
	|ГДЕ
	|	Т.ЭтоОстатки
	|	И УзлыИсточники.ЕстьСтоимость
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Формирование движений по распределению постатейных расходов на партии производства.
	|ВЫБРАТЬ
	|	""4"" КАК ЗапросИсточник,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	ИСТИНА КАК ЭтоТекущийПериод,
	|	ИСТИНА ЕстьКорЧасть,
	|	Т.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	УзлыПриемники.НомерУзла КАК НомерУзлаПриемник,
	|	(ВЫБОР
	|		КОГДА Т.Регистратор <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.Регистратор
	|		ИНАЧЕ УзлыИсточники.Регистратор КОНЕЦ) КАК Регистратор,
	|	&КонецПериода КАК Период,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	// Измерения
	|	УзлыИсточники.Организация КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО КАК Характеристика,
	|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
	|	УзлыИсточники.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	УзлыИсточники.Подразделение КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК МестоХранения,
	// Кор реквизиты
	|	УзлыПриемники.Организация КАК КорОрганизация,
	|	НЕОПРЕДЕЛЕНО КАК КорНоменклатура,
	|	НЕОПРЕДЕЛЕНО КАК КорХарактеристика,
	|	НЕОПРЕДЕЛЕНО КАК КорВидЗапасов,
	|	УзлыПриемники.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	УзлыПриемники.Подразделение КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО КАК КорМестоХранения,
	// Прочие поля
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
	|	УзлыПриемники.СтатьяРасходов КАК СтатьяРасходовСписания,
	|	УзлыПриемники.АналитикаРасходов КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукции) КАК НастройкаХозяйственнойОперации,
	|	ТаблицаИдентификаторов.Идентификатор КАК ИдентификаторФинЗаписи,
	|	&НачалоПериода КАК ПериодРаспределения,
	|	&НачалоПериода КАК ПериодОтклоненияИсточник,
	|	&НачалоПериода КАК ПериодОтклоненияПриемник,
	|	ЛОЖЬ КАК Сторно,
	|	ЛОЖЬ КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	0 КАК Количество,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыСНДС * УзлыИсточники.ОтклоненияВСтоимостиСНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиСНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыБезНДС * УзлыИсточники.ОтклоненияВСтоимостиБезНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиБезНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыРегл * УзлыИсточники.ОтклоненияВСтоимостиРегл КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыУпр * УзлыИсточники.ОтклоненияВСтоимостиУпр КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыСНДС * УзлыИсточники.ДопРасходыСНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыСНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыБезНДС * УзлыИсточники.ДопРасходыБезНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыБезНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыРегл * УзлыИсточники.ДопРасходыРегл КАК ЧИСЛО(31,2)) КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыУпр * УзлыИсточники.ДопРасходыУпр КАК ЧИСЛО(31,2)) КАК ДопРасходыУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыРегл * УзлыИсточники.НДСРегл КАК ЧИСЛО(31,2)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыУпр * УзлыИсточники.НДСУпр КАК ЧИСЛО(31,2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыРегл * УзлыИсточники.ПостояннаяРазница КАК ЧИСЛО(31,2)) КАК ПостояннаяРазница,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыНУ * УзлыИсточники.ВременнаяРазница КАК ЧИСЛО(31,2)) КАК ВременнаяРазница,
	|	ВЫРАЗИТЬ(Т.ВесДугиПостатейныеРасходыНУ * УзлыИсточники.НДД КАК ЧИСЛО(31,2)) КАК НДД
	|ИЗ
	|	ВтТаблицаСвязейПостатейныеРасходыСРегистратором КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРешенийДетально КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзла = Т.НомерУзлаИсточник
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиПостатейныеРасходыНЗП КАК УзлыПриемники
	|		ПО УзлыПриемники.НомерУзла = Т.НомерУзлаПриемник
	|		И УзлыПриемники.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|		ПО ТаблицаИдентификаторов.НомерУзлаИсточник = Т.НомерУзлаИсточник
	|		И ТаблицаИдентификаторов.НомерУзлаПриемник = Т.НомерУзлаПриемник
	//-- НЕ УТ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Формирование движений по распределению доп расходов по товарам.
	|ВЫБРАТЬ
	|	""5"" КАК ЗапросИсточник,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	ИСТИНА КАК ЭтоТекущийПериод,
	|	ИСТИНА ЕстьКорЧасть,
	|	Т.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	УзлыПриемники.НомерУзла КАК НомерУзлаПриемник,
	|	(ВЫБОР
	|		КОГДА Т.Регистратор <> НЕОПРЕДЕЛЕНО
	|			ТОГДА Т.Регистратор
	|		ИНАЧЕ УзлыИсточники.Регистратор КОНЕЦ) КАК Регистратор,
	|	&КонецПериода КАК Период,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	// Измерения
	|	Т.КорОрганизация КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО КАК Характеристика,
	|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация КАК КорОрганизация,
	|	Т.КорНоменклатура КАК КорНоменклатура,
	|	Т.КорХарактеристика КАК КорХарактеристика,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Т.КорПодразделение КАК КорПодразделение,
	|	Т.КорМестоХранения КАК КорМестоХранения,
	// Прочие поля
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходов КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.РаспределениеРасходовНаСебестоимость) КАК НастройкаХозяйственнойОперации,
	|	ТаблицаИдентификаторов.Идентификатор КАК ИдентификаторФинЗаписи,
	|	&НачалоПериода КАК ПериодРаспределения,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияИсточник,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияПриемник,
	|	ЛОЖЬ КАК Сторно,
	|	ЛОЖЬ КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	0 КАК Количество,
	|	ВЫРАЗИТЬ(Т.ВесДугиСНДС * УзлыИсточники.ОтклоненияВСтоимостиСНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиСНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиБезНДС * УзлыИсточники.ОтклоненияВСтоимостиБезНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиБезНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * УзлыИсточники.ОтклоненияВСтоимостиРегл КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиУпр * УзлыИсточники.ОтклоненияВСтоимостиУпр КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиСНДС * УзлыИсточники.ДопРасходыСНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыСНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиБезНДС * УзлыИсточники.ДопРасходыБезНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыБезНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * УзлыИсточники.ДопРасходыРегл КАК ЧИСЛО(31,2)) КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиУпр * УзлыИсточники.ДопРасходыУпр КАК ЧИСЛО(31,2)) КАК ДопРасходыУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * УзлыИсточники.НДСРегл КАК ЧИСЛО(31,2)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиУпр * УзлыИсточники.НДСУпр КАК ЧИСЛО(31,2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * УзлыИсточники.ПостояннаяРазница КАК ЧИСЛО(31,2)) КАК ПостояннаяРазница,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * ВЫБОР
	// Если расходы распределяются в бух учета на себестоимость товаров и не распределяются в нал. учете, то
	// в узле приемнике должна быть сформирована временная разница на сумму регл за минусом постоянной разницы.
	|		КОГДА НЕ Т.НеРаспределяетсяВБухУчете И Т.НеРаспределяетсяВНалУчете
	|			ТОГДА УзлыИсточники.ОтклоненияВСтоимостиРегл + УзлыИсточники.ДопРасходыРегл + УзлыИсточники.НДСРегл
	|				- УзлыИсточники.ПостояннаяРазница
	|			ИНАЧЕ УзлыИсточники.ВременнаяРазница КОНЕЦ
	|		КАК ЧИСЛО(31,2)) КАК ВременнаяРазница,
	|	ВЫРАЗИТЬ(Т.ВесДугиНУ * УзлыИсточники.НДД КАК ЧИСЛО(31,2)) КАК НДД
	|ИЗ
	|	ВтСвязиРаспределениеДопРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРешенийДетально КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзла = Т.НомерУзлаИсточник
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемники
	|		ПО УзлыПриемники.Организация = Т.КорОрганизация
	|		И УзлыПриемники.Номенклатура = Т.КорНоменклатура
	|		И УзлыПриемники.Характеристика = Т.КорХарактеристика
	|		И УзлыПриемники.ВидЗапасов = Т.КорВидЗапасов
	|		И УзлыПриемники.НаправлениеДеятельности = Т.КорНаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Т.КорПодразделение
	|		И УзлыПриемники.МестоХранения = Т.КорМестоХранения
	|		И УзлыПриемники.РазделУчета = НЕОПРЕДЕЛЕНО
	|		И УзлыПриемники.ПериодРаспределения = &НачалоПериода
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ТаблицаИдентификаторов КАК ТаблицаИдентификаторов
	|		ПО ТаблицаИдентификаторов.НомерУзлаИсточник = Т.НомерУзлаИсточник
	|		И ТаблицаИдентификаторов.НомерУзлаПриемник = УзлыПриемники.НомерУзла
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Формирование движений по распределению постатейных расходов на выпуск продукции.
	|ВЫБРАТЬ
	|	""6"" КАК ЗапросИсточник,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	ИСТИНА КАК ЭтоТекущийПериод,
	|	ИСТИНА ЕстьКорЧасть,
	|	Т.НомерУзлаИсточник КАК НомерУзлаИсточник,
	|	УзлыПриемники.НомерУзла КАК НомерУзлаПриемник,
	|	УзлыИсточники.Регистратор,
	|	Выпуски.Период КАК Период,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	// Измерения
	|	Т.КорОрганизация КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК Номенклатура,
	|	НЕОПРЕДЕЛЕНО КАК Характеристика,
	|	НЕОПРЕДЕЛЕНО КАК ВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Подразделение КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация КАК КорОрганизация,
	|	Т.КорНоменклатура КАК КорНоменклатура,
	|	Т.КорХарактеристика КАК КорХарактеристика,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Т.КорПодразделение КАК КорПодразделение,
	|	Т.КорМестоХранения КАК КорМестоХранения,
	// Прочие поля
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходов КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукцииПостатейные) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииПостатейные) КАК НастройкаХозяйственнойОперации,
	|	Выпуски.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	&НачалоПериода КАК ПериодРаспределения,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияИсточник,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияПриемник,
	|	ЛОЖЬ КАК Сторно,
	|	ЛОЖЬ КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	0 КАК Количество,
	|	ВЫРАЗИТЬ(Т.ВесДугиСНДС * УзлыИсточники.ОтклоненияВСтоимостиСНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиСНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиБезНДС * УзлыИсточники.ОтклоненияВСтоимостиБезНДС КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиБезНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * УзлыИсточники.ОтклоненияВСтоимостиРегл КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиУпр * УзлыИсточники.ОтклоненияВСтоимостиУпр КАК ЧИСЛО(31,2)) КАК ОтклоненияВСтоимостиУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиСНДС * УзлыИсточники.ДопРасходыСНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыСНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиБезНДС * УзлыИсточники.ДопРасходыБезНДС КАК ЧИСЛО(31,2)) КАК ДопРасходыБезНДС,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * УзлыИсточники.ДопРасходыРегл КАК ЧИСЛО(31,2)) КАК ДопРасходыРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиУпр * УзлыИсточники.ДопРасходыУпр КАК ЧИСЛО(31,2)) КАК ДопРасходыУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * УзлыИсточники.НДСРегл КАК ЧИСЛО(31,2)) КАК НДСРегл,
	|	ВЫРАЗИТЬ(Т.ВесДугиУпр * УзлыИсточники.НДСУпр КАК ЧИСЛО(31,2)) КАК НДСУпр,
	|	ВЫРАЗИТЬ(Т.ВесДугиРегл * УзлыИсточники.ПостояннаяРазница КАК ЧИСЛО(31,2)) КАК ПостояннаяРазница,
	|	ВЫРАЗИТЬ(Т.ВесДугиНУ * УзлыИсточники.ВременнаяРазница КАК ЧИСЛО(31,2)) КАК ВременнаяРазница,
	|	ВЫРАЗИТЬ(Т.ВесДугиНУ * УзлыИсточники.НДД КАК ЧИСЛО(31,2)) КАК НДД
	|ИЗ
	|	ВтСвязиРаспределениеПостатейныхНаВыпуск КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ТаблицаРешенийДетально КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзла = Т.НомерУзлаИсточник
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУзлыОтклонений КАК УзлыПриемники
	|		ПО УзлыПриемники.Организация = Т.КорОрганизация
	|		И УзлыПриемники.Номенклатура = Т.КорНоменклатура
	|		И УзлыПриемники.Характеристика = Т.КорХарактеристика
	|		И УзлыПриемники.ВидЗапасов = Т.КорВидЗапасов
	|		И УзлыПриемники.НаправлениеДеятельности = Т.КорНаправлениеДеятельности	
	|		И УзлыПриемники.Подразделение = Т.КорПодразделение
	|		И УзлыПриемники.МестоХранения = Т.КорМестоХранения
	|		И УзлыПриемники.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)
	|		И УзлыПриемники.ПериодРаспределения = &НачалоПериода
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтВыпуски КАК Выпуски
	|		ПО Выпуски.Организация = Т.КорОрганизация
	|		И Выпуски.Номенклатура = Т.КорНоменклатура
	|		И Выпуски.Характеристика = Т.КорХарактеристика
	|		И Выпуски.ВидЗапасов = Т.КорВидЗапасов
	|		И Выпуски.НаправлениеДеятельности = Т.КорНаправлениеДеятельности	
	|		И Выпуски.Подразделение = Т.КорПодразделение
	|		И Выпуски.МестоХранения = Т.КорМестоХранения
	//-- НЕ УТ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Формирование сторно движений по исправлениям прошлого периода.
	|ВЫБРАТЬ
	|	""7"" КАК ЗапросИсточник,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	ИСТИНА КАК ЭтоТекущийПериод,
	|	Т.ЕстьКорЧасть,
	|	-1 КАК НомерУзлаИсточник,
	|	(ВЫБОР КОГДА Т.ЕстьКорЧасть ТОГДА 0 ИНАЧЕ -1 КОНЕЦ) КАК НомерУзлаПриемник,
	|	Т.Регистратор,
	|	Т.Период,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	// Поле НастройкаХозяйственнойОперации должно заполняться аналогично запросу с ЗапросИсточник = ""1"".
	|	(ВЫБОР
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаНаПрочиеЦели)
	|		 ИЛИ Т.СтатьяАктивовПассивов <> НЕОПРЕДЕЛЕНО
	|		 И Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаНаПрочиеЦелиОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства)
	|		 И Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПередачаПродукцииИзПроизводстваОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииОтклонения)
	|		КОГДА Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтчетДавальцуМеждуОрганизациямиОтклонения)
	|		КОГДА НЕ Т.ЕстьКорЧасть
	|		 И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО
	|		 И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|		 И Т.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеНаРасходыОтклонения)
	|		ИНАЧЕ Т.НастройкаХозяйственнойОперации КОНЕЦ) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	&НачалоПериода КАК ПериодРаспределения,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияИсточник,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияПриемник,
	|	Т.Сторно КАК Сторно,
	|	ЛОЖЬ КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	Т.Знак * Т.Количество КАК Количество,
	|	Т.Знак * Т.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|	Т.Знак * Т.ОтклоненияВСтоимостиБезНДС КАК ОтклоненияВСтоимостиБезНДС,
	|	Т.Знак * Т.ОтклоненияВСтоимостиРегл КАК ОтклоненияВСтоимостиРегл,
	|	Т.Знак * Т.ОтклоненияВСтоимостиУпр КАК ОтклоненияВСтоимостиУпр,
	|	Т.Знак * Т.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|	Т.Знак * Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	Т.Знак * Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|	Т.Знак * Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|	Т.Знак * Т.НДСРегл КАК НДСРегл,
	|	Т.Знак * Т.НДСУпр КАК НДСУпр,
	|	Т.Знак * Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.Знак * Т.ВременнаяРазница КАК ВременнаяРазница,
	|	Т.Знак * Т.НДД КАК НДД
	|ИЗ
	|	ВтСторноОтклоненийПрошлогоПериода КАК Т
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Перенос остатков отклонений на начало периода на текущий период.
	|ВЫБРАТЬ
	|	""8"" КАК ЗапросИсточник,
	|	ИСТИНА КАК ЭтоОстатки,
	|	ИСТИНА КАК ЭтоТекущийПериод,
	|	ИСТИНА КАК ЕстьКорЧасть,
	|	-1 КАК НомерУзлаИсточник,
	|	0 КАК НомерУзлаПриемник,
	|	Регистраторы.Ссылка КАК Регистратор,
	|	&НачалоПериода КАК Период,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	// Кор реквизиты
	|	Т.Организация КАК КорОрганизация,
	|	Т.Номенклатура КАК КорНоменклатура,
	|	Т.Характеристика КАК КорХарактеристика,
	|	Т.ВидЗапасов КАК КорВидЗапасов,
	|	Т.НаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Т.Подразделение КАК КорПодразделение,
	|	Т.МестоХранения КАК КорМестоХранения,
	// Прочие поля
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КАК АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПереносОтклоненийВСтоимостиТоваров) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПустаяСсылка) КАК НастройкаХозяйственнойОперации,
	|	&ИдентификаторНеиспользуемойФинЗаписи КАК ИдентификаторФинЗаписи,
	|	&НачалоПериода КАК ПериодРаспределения,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияИсточник,
	|	&НачалоПериода КАК ПериодОтклоненияПриемник,
	|	ЛОЖЬ КАК Сторно,
	|	ЛОЖЬ КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	0 КАК Количество,
	|	Т.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС КАК ОтклоненияВСтоимостиБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл КАК ОтклоненияВСтоимостиРегл,
	|	Т.ОтклоненияВСтоимостиУпр КАК ОтклоненияВСтоимостиУпр,
	|	Т.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|	Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|	Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|	Т.НДСРегл КАК НДСРегл,
	|	Т.НДСУпр КАК НДСУпр,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	|	Т.НДД КАК НДД
	|ИЗ
	|	ВтОстаткиОтклоненийНаНачалоПериодаДетальные КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК Регистраторы
	|		ПО Т.Организация = Регистраторы.Организация
	|ГДЕ
	|	Т.ПериодОтклонения <> &НачалоПериода
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Формирование корректировочных движений по отклонениям, не соответствующим движениям себестоимости товаров.
	|ВЫБРАТЬ
	|	""9"" КАК ЗапросИсточник,
	|	ЛОЖЬ КАК ЭтоОстатки,
	|	ИСТИНА КАК ЭтоТекущийПериод,
	|	Т.ЕстьКорЧасть,
	|	-1 КАК НомерУзлаИсточник,
	|	(ВЫБОР КОГДА Т.ЕстьКорЧасть ТОГДА 0 ИНАЧЕ -1 КОНЕЦ) КАК НомерУзлаПриемник,
	|	Т.Регистратор,
	|	Т.Период,
	|	НЕОПРЕДЕЛЕНО КАК РазделУчета,
	// Измерения
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	// Кор реквизиты
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	// Прочие поля
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	Т.АналитикаУчетаПоПартнерам КАК АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов КАК СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределения КАК ПериодРаспределения,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияИсточник,
	|	Т.ПериодОтклонения КАК ПериодОтклоненияПриемник,
	|	ЛОЖЬ КАК Сторно,
	|	ЛОЖЬ КАК СписыватьОтклоненияНаСебестоимостьПродаж,
	// Ресурсы
	|	Т.Количество КАК Количество,
	|	Т.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС КАК ОтклоненияВСтоимостиБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл КАК ОтклоненияВСтоимостиРегл,
	|	Т.ОтклоненияВСтоимостиУпр КАК ОтклоненияВСтоимостиУпр,
	|	Т.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|	Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|	Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|	Т.НДСРегл КАК НДСРегл,
	|	Т.НДСУпр КАК НДСУпр,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	|	Т.НДД КАК НДД
	|ИЗ
	|	ВтНеактуальныеДвижения КАК Т
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомерУзлаИсточник
	|;";
	#КонецОбласти
	
	#Область ВтДвиженияОтклонения
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	(ВЫБОР
	|		КОГДА Т.ЭтоОстатки ТОГДА КОНЕЦПЕРИОДА(Т.Период, МЕСЯЦ)
	|		ИНАЧЕ Т.Период КОНЕЦ) КАК Период,
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник,
	|
	|	Т.ПериодОтклоненияИсточник КАК ПериодОтклонения,
	|	Т.Организация,
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.ВидЗапасов,
	|	Т.НаправлениеДеятельности,
	|	Т.Подразделение,
	|	Т.МестоХранения,
	|
	|	Т.КорОрганизация,
	|	Т.КорНоменклатура,
	|	Т.КорХарактеристика,
	|	Т.КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности,
	|	Т.КорПодразделение,
	|	Т.КорМестоХранения,
	|
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.СтатьяАктивовПассивов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределения,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл,
	|	Т.ОтклоненияВСтоимостиУпр,
	|	Т.ДопРасходыСНДС,
	|	Т.ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл,
	|	Т.ДопРасходыУпр,
	|	Т.НДСРегл,
	|	Т.НДСУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДД,
	|	Т.Количество
	|
	|ПОМЕСТИТЬ ВтДвиженияОтклонения
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|ГДЕ
	|	Т.Номенклатура <> НЕОПРЕДЕЛЕНО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Период,
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник,
	|
	|	Т.ПериодОтклоненияПриемник КАК ПериодОтклонения,
	|	(ВЫБОР КОГДА Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|		ТОГДА Т.КорОрганизация
	|		ИНАЧЕ Т.Организация КОНЕЦ) КАК Организация,
	|	Т.КорНоменклатура КАК Номенклатура,
	|	Т.КорХарактеристика КАК Характеристика,
	|	Т.КорВидЗапасов КАК ВидЗапасов,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорМестоХранения КАК МестоХранения,
	|
	|	ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка) КАК КорОрганизация,
	|	Т.Номенклатура КАК КорНоменклатура,
	|	Т.Характеристика КАК КорХарактеристика,
	|	Т.ВидЗапасов КАК КорВидЗапасов,
	|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка) КАК КорНаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК КорПодразделение,
	|	НЕОПРЕДЕЛЕНО КАК КорМестоХранения,
	|
	|	Т.АналитикаУчетаПоПартнерам,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходовСписания,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	|	НЕОПРЕДЕЛЕНО КАК НастройкаСчетовУчета,
	|	Т.ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.ПериодРаспределения,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл,
	|	Т.ОтклоненияВСтоимостиУпр,
	|	Т.ДопРасходыСНДС,
	|	Т.ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл,
	|	Т.ДопРасходыУпр,
	|	Т.НДСРегл,
	|	Т.НДСУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДД,
	|	0 КАК Количество
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Т.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Т.ЕстьКорЧасть
	|	И Т.НомерУзлаПриемник >= 0
	|	И Т.КорНоменклатура <> НЕОПРЕДЕЛЕНО
	|;
	|";
	#КонецОбласти

	#Область ВтДвиженияВыручка
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	""1"" КАК ЗапросИсточник,
	|	Т.Регистратор,
	|	Т.Регистратор КАК ДокументДвижения,
	|	Т.Период,
	|
	|	Движения.АналитикаУчетаНоменклатуры,
	|	Движения.ЗаказКлиента,
	|	Движения.АналитикаУчетаПоПартнерам,
	|	Движения.Подразделение,
	|	Движения.ТипЗапасов,
	|	Движения.ВидЗапасов,
	|	Движения.РазделУчета,
	|	Движения.Партия,
	|	Движения.АналитикаУчетаПартий,
	|	Движения.АналитикаФинансовогоУчета,
	|	Движения.ВидДеятельностиНДС,
	|	Движения.Менеджер,
	|	Движения.Склад,
	|	Движения.Соглашение,
	|	Движения.Договор,
	|	Движения.ХозяйственнаяОперация,
	|	Движения.АналитикаУчетаНаборов,
	|	Движения.НаправлениеДеятельностиКонтрагента,
	|	Движения.НаправлениеДеятельностиНоменклатуры,
	|
	|	Движения.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	|	Движения.НалогообложениеНДС,
	|	Движения.ИсточникГФУНоменклатуры,
	|	Движения.ИсточникГФУРасчетов,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК ДопРасходы,
	|	Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК ДопРасходыРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК ДопРасходыУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|
	|ПОМЕСТИТЬ ВтДвиженияВыручка
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшВыручкаИСебестоимостьПродаж КАК Движения
	|		ПО Движения.АналитикаУчетаПоПартнерам = Т.АналитикаУчетаПоПартнерам
	|		И Движения.ИдентификаторФинЗаписи = Т.ИдентификаторФинЗаписи
	|		И Движения.ХозяйственнаяОперация = Т.ХозяйственнаяОперация
	|		И Движения.Сторно = Т.Сторно
	|		И Т.ЭтоТекущийПериод
	|		И Движения.Количество <> 0
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И НЕ Т.ЕстьКорЧасть
	|	И НЕ Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|	И Движения.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	""2"" КАК ЗапросИсточник,
	|	Т.Регистратор,
	|	Т.Регистратор КАК ДокументДвижения,
	|	Т.Период,
	|
	|	Движения.АналитикаУчетаНоменклатуры,
	|	Движения.ЗаказКлиента,
	|	Движения.АналитикаУчетаПоПартнерам,
	|	Движения.Подразделение,
	|	Движения.ТипЗапасов,
	|	Движения.ВидЗапасов,
	|	Движения.РазделУчета,
	|	Движения.Партия,
	|	Движения.АналитикаУчетаПартий,
	|	Движения.АналитикаФинансовогоУчета,
	|	Движения.ВидДеятельностиНДС,
	|	Движения.Менеджер,
	|	Движения.Склад,
	|	Движения.Соглашение,
	|	Движения.Договор,
	|	Движения.ХозяйственнаяОперация,
	|	Движения.АналитикаУчетаНаборов,
	|	Движения.НаправлениеДеятельностиКонтрагента,
	|	Движения.НаправлениеДеятельностиНоменклатуры,
	|
	|	Движения.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	|	Движения.НалогообложениеНДС,
	|	Движения.ИсточникГФУНоменклатуры,
	|	Движения.ИсточникГФУРасчетов,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК ДопРасходы,
	|	Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК ДопРасходыРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК ДопРасходыУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ВыручкаИСебестоимостьПродаж КАК Движения
	|		ПО Движения.АналитикаУчетаПоПартнерам = Т.АналитикаУчетаПоПартнерам
	|		И Движения.ИдентификаторФинЗаписи = Т.ИдентификаторФинЗаписи
	|		И Движения.ХозяйственнаяОперация = Т.ХозяйственнаяОперация
	|		И Движения.Сторно = Т.Сторно
	|		И НЕ Т.ЭтоТекущийПериод
	|		И Движения.Количество <> 0
	|		И НАЧАЛОПЕРИОДА(Движения.Период, МЕСЯЦ) = Т.ПериодРаспределения
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И НЕ Т.ЕстьКорЧасть
	|	И НЕ Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|	И Движения.Период МЕЖДУ &МинимальныйПрошлыйПериод И &КонецПредыдущегоПериода
	|	И Движения.РазделУчета <> ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НеотфактурованныеПоставки)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Списание отклонений по выпущенной продукции на себестоимость продаж.
	|ВЫБРАТЬ
	|	""3"" КАК ЗапросИсточник,
	|	Т.Регистратор,
	|	Т.Регистратор КАК ДокументДвижения,
	|	Т.Период,
	|
	|	Т.АналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	АналитикаПартнера.КлючАналитики КАК АналитикаУчетаПоПартнерам,
	|	Т.Подразделение,
	|	ЕСТЬNULL(Т.ВидЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)) КАК ТипЗапасов,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	НЕОПРЕДЕЛЕНО КАК Партия,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПартий.ПустаяСсылка) КАК АналитикаУчетаПартий,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаФинансовогоУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК ВидДеятельностиНДС,
	|	ЗНАЧЕНИЕ(Справочник.Пользователи.ПустаяСсылка) КАК Менеджер,
	|	Т.МестоХранения КАК Склад,
	|	ЗНАЧЕНИЕ(Справочник.СоглашенияСКлиентами.ПустаяСсылка) КАК Соглашение,
	|	НЕОПРЕДЕЛЕНО КАК Договор,
	|	Т.ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНаборов.ПустаяСсылка) КАК АналитикаУчетаНаборов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельностиКонтрагента,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельностиНоменклатуры,
	|
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КАК НалогообложениеНДС,
	|	НЕОПРЕДЕЛЕНО КАК ИсточникГФУНоменклатуры,
	|	ЗНАЧЕНИЕ(Справочник.ОбъектыРасчетов.ПустаяСсылка) КАК ИсточникГФУРасчетов,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК ДопРасходыРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК ДопРасходыУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПартнера
	|	ПО (АналитикаПартнера.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|		И (АналитикаПартнера.Организация = Т.Организация)
	|		И (АналитикаПартнера.Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|		И (АналитикаПартнера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка))
	|		И (АналитикаПартнера.НаправлениеДеятельности = Т.НаправлениеДеятельности)
	|ГДЕ
	|	Т.СписыватьОтклоненияНаСебестоимостьПродаж
	|	И (Т.ОтклоненияВСтоимостиРегл <> 0 ИЛИ Т.ДопРасходыРегл <> 0 ИЛИ Т.НДСРегл <> 0
	|		ИЛИ Т.ОтклоненияВСтоимостиУпр <> 0 ИЛИ Т.ДопРасходыУпр <> 0 ИЛИ Т.НДСУпр <> 0)
	|;
	|";
	
	#КонецОбласти
	
	#Область ВтДвиженияПрочиеРасходы
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Регистратор КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Период,
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник,
	|
	|	(ВЫБОР
	|		КОГДА Т.КорОрганизация <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|			ТОГДА Т.КорОрганизация
	|		ИНАЧЕ Т.Организация КОНЕЦ) КАК Организация,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	Т.ХозяйственнаяОперация,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК Сумма,
	|	Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС КАК СуммаБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК СуммаРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК СуммаУпр,
	|	(ВЫБОР 
	|		КОГДА НЕ Т.СтатьяРасходовСписания.ПринятиеКНалоговомуУчету
	|			ТОГДА Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл - Т.ВременнаяРазница
	|		ИНАЧЕ Т.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	|	Т.НДД КАК СуммаНДД
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходы
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И НЕ Т.ЕстьКорЧасть
	|	И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО 
	|	И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	// Распределение отклонений между организациями в управленческом учета не поддерживается.
	|	И (Т.КорОрганизация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|		ИЛИ Т.КорОрганизация = Т.Организация)
	|
	//++ НЕ УТ
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Регистратор КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	Т.Период,
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник,
	|
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	Т.ХозяйственнаяОперация,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК Сумма,
	|	Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС КАК СуммаБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК СуммаРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК СуммаУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДД КАК СуммаНДД
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиПостатейныеРасходыНЗП КАК УзлыИсточникиНЗП
	|		ПО УзлыИсточникиНЗП.НомерУзла = Т.НомерУзлаИсточник
	|		И УзлыИсточникиНЗП.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО 
	|	И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И Т.Номенклатура = НЕОПРЕДЕЛЕНО
	|	И УзлыИсточникиНЗП.НомерУзла ЕСТЬ NULL
	//-- НЕ УТ
	|;
	|";
	
	#КонецОбласти
	
	//++ НЕ УТ
	
	#Область ВтДвиженияПрочиеРасходыНезавершенногоПроизводства
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Регистратор КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Период,
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник,
	|
	|	Т.Организация КАК Организация,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	Т.ХозяйственнаяОперация,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК Стоимость,
	|	Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС КАК СтоимостьБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК СтоимостьРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК СтоимостьУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДД
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходыНезавершенногоПроизводства
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО 
	|	И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И Т.Номенклатура = НЕОПРЕДЕЛЕНО
	|	И Т.КорНоменклатура = НЕОПРЕДЕЛЕНО
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Регистратор КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	Т.Период,
	|	Т.НомерУзлаИсточник,
	|	Т.НомерУзлаПриемник,
	|
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходовСписания КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|
	|	Т.ХозяйственнаяОперация,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК Стоимость,
	|	Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС КАК СтоимостьБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК СтоимостьРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК СтоимостьУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДД
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтУзлыКорректировкиПостатейныеРасходыНЗП КАК УзлыИсточники
	|		ПО УзлыИсточники.НомерУзла = Т.НомерУзлаИсточник
	|		И УзлыИсточники.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И Т.ЕстьКорЧасть
	|	И Т.СтатьяРасходовСписания <> НЕОПРЕДЕЛЕНО 
	|	И Т.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И Т.Номенклатура = НЕОПРЕДЕЛЕНО
	|	И Т.КорНоменклатура <> ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка)
	|	И Т.КорНоменклатура <> НЕОПРЕДЕЛЕНО
	|;
	|";
	#КонецОбласти
	
	//-- НЕ УТ
	
	#Область ВтДвиженияПрочиеАктивыПассивы
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|
	|	Т.Организация КАК Организация,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяАктивовПассивов КАК Статья,
	|	Т.АналитикаАктивовПассивов КАК Аналитика,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Дебет) КАК ДебетКредит,
	|
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС < 0 И Т.Сторно
	|			ТОГДА Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК Сумма,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС < 0 И Т.Сторно
	|			ТОГДА Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаСНДС,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС < 0 И Т.Сторно
	|			ТОГДА Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл < 0 И Т.Сторно
	|			ТОГДА Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр < 0 И Т.Сторно
	|			ТОГДА Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл < 0 И Т.Сторно
	|			ТОГДА Т.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл > 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл < 0 И Т.Сторно
	|			ТОГДА Т.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеАктивыПассивы
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И НЕ Т.ЕстьКорЧасть
	|	И Т.СтатьяАктивовПассивов <> НЕОПРЕДЕЛЕНО 
	|	И Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И (
	|		(Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС > 0
	|		ИЛИ Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС > 0
	|		ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл > 0
	|		ИЛИ Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр > 0)
	|		И НЕ Т.Сторно
	|		ИЛИ (Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС < 0
	|		ИЛИ Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС < 0
	|		ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл < 0
	|		ИЛИ Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр < 0)
	|		И Т.Сторно)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|
	|	Т.Организация КАК Организация,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяАктивовПассивов КАК Статья,
	|	Т.АналитикаАктивовПассивов КАК Аналитика,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Кредит) КАК ДебетКредит,
	|
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС > 0 И Т.Сторно
	|			ТОГДА -(Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС)
	|		ИНАЧЕ 0 КОНЕЦ) КАК Сумма,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС > 0 И Т.Сторно
	|			ТОГДА -(Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС)
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаСНДС,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС > 0 И Т.Сторно 
	|			ТОГДА -(Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС)
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл > 0 И Т.Сторно 
	|			ТОГДА -(Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл)
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр > 0 И Т.Сторно 
	|			ТОГДА -(Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр)
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл > 0 И Т.Сторно 
	|			ТОГДА -Т.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл < 0 И НЕ Т.Сторно
	|		 ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл > 0 И Т.Сторно 
	|			ТОГДА -Т.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И НЕ Т.ЕстьКорЧасть
	|	И Т.СтатьяАктивовПассивов <> НЕОПРЕДЕЛЕНО 
	|	И Т.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И (
	|		(Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС < 0
	|		ИЛИ Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС < 0
	|		ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл < 0
	|		ИЛИ Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр < 0)
	|		И НЕ Т.Сторно
	|		ИЛИ (Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС > 0
	|		ИЛИ Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС > 0
	|		ИЛИ Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл > 0
	|		ИЛИ Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр > 0)
	|		И Т.Сторно)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Передача в филиал (на стороне отправителя)
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|
	|	Т.Организация КАК Организация,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.РасчетыСФилиалами) КАК Статья,
	|	Т.КорОрганизация КАК Аналитика,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Дебет) КАК ДебетКредит,
	|
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК Сумма,
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК СуммаСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС КАК СуммаБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК СуммаРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК СуммаУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеПолуфабрикатовМеждуФилиалами),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами))
	|
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Передача в филиал (на стороне получателя)
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|
	|	Т.КорОрганизация КАК Организация,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.РасчетыСФилиалами) КАК Статья,
	|	Т.Организация КАК Аналитика,
	|	Т.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Кредит) КАК ДебетКредит,
	|
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации,
	// Признак Сторно не заполняется, т.к. это расчетные движения, а не сторнированные движения исходного документа.
	|	ЛОЖЬ КАК Сторно,
	|
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК Сумма,
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС КАК СуммаСНДС,
	|	Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС КАК СуммаБезНДС,
	|	Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл + Т.НДСРегл КАК СуммаРегл,
	|	Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр  + Т.НДСУпр КАК СуммаУпр,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница
	|ИЗ
	|	ВтВыбытияДляОтклонений КАК Т
	|ГДЕ
	|	НЕ Т.ЭтоОстатки
	|	И Т.ХозяйственнаяОперация В (
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеПолуфабрикатовМеждуФилиалами),
	|		ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами))
	|";
	
	#КонецОбласти
	
	Возврат ТекстЗапроса;
	
КонецФункции

Процедура РасчетРазницыСПредыдущимиРасчетами(ПараметрыРасчета)
	
	Если ПараметрыРасчета.УчетныеПолитики.Среднескользящая.ИспользуютВТекущемПериоде.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РасчетРазницыСПредыдущимиРасчетами");

	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	Для Каждого КлючИЗначение Из ПараметрыРасчета.Движения Цикл
		
		ИмяРегистра = КлючИЗначение.Ключ;
		ОписаниеПриемника = КлючИЗначение.Значение;
		
		Если НЕ Метаданные.Документы.РегистраторРасчетаСебестоимости.Движения.Содержит(ОписаниеПриемника.МетаданныеРегистра)
		 ИЛИ РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, ОписаниеПриемника.ИмяТаблицыКэшаРегистра) = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		ИмяТаблицыИсточника = "ВтИсточник" + ИмяРегистра;
		ИмяТаблицыПриемника = "ВТПриемник" + ИмяРегистра;
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	ИСТИНА КАК НовыеДвижения,
		|	Т.Регистратор,
		|	&ПолеСлужебноеВидДвижения КАК ВидДвижения,
		|	&ПоляКешаРегистра,
		|	&НулевыеРесурсыРегистра
		|ПОМЕСТИТЬ ТаблицаДвиженийПредварительная
		|ИЗ
		|	ИмяТаблицыКэшаРегистра КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РегистраторРасчетаСебестоимости КАК Отбор
		|		ПО Т.Регистратор = Отбор.Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ЛОЖЬ КАК НовыеДвижения,
		|	ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка) КАК Регистратор,
		|	&ПолеВидДвижения КАК ВидДвижения,
		|	&ПоляОсновнойТаблицыРегистра,
		|	&ОтрицательныеРесурсыРегистра
		|ИЗ
		|	ИмяТаблицыРегистра  КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РегистраторРасчетаСебестоимости КАК Отбор
		|		ПО Т.Регистратор = Отбор.Ссылка
		|ГДЕ
		|	Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|
		// Ниже поля индексирования заменяются на индексы регистра
		|ИНДЕКСИРОВАТЬ ПО НовыеДвижения
		|;
		|
		|ВЫБРАТЬ
		|	МАКСИМУМ(Т.НовыеДвижения) КАК НовыеДвижения,
		|	МАКСИМУМ(Т.Регистратор) КАК Регистратор,
		|	Т.ВидДвижения,
		|	&ВыборкаПоляРегистра,
		|	&СуммаРесурсовРегистра
		|ПОМЕСТИТЬ ИмяТаблицыИсточника
		|ИЗ
		|	ТаблицаДвиженийПредварительная КАК Т
		|СГРУППИРОВАТЬ ПО
		|	Т.ВидДвижения,
		|	&ГруппировкаПолей
		|ИМЕЮЩИЕ
		|	МАКСИМУМ(Т.НовыеДвижения) = ИСТИНА
		|	И (&ОтборНепустыхРесурсов)
		|";
		
		// Шаблоны для замены в тексте запроса
		ТекстОтборНепустыхРесурсов 		  = "";
		ТекстГруппировкаПолей 	   		  = "";
		ТекстПоляКешаРегистра			  = "";
		ТекстПоляОсновнойТаблицыРегистра  = "";
		ТекстВыборкаПоляРегистра	  	  = "";
		
		ТекстНулевыеРесурсыРегистра		  = "";
		ТекстОтрицательныеРесурсыРегистра = "";
		ТекстСуммаРесурсовРегистра		  = "";
		
		ТекстПолеВидДвижения			  = "НЕОПРЕДЕЛЕНО";
		ТекстСлужебноеВидДвижения	  	  = "НЕОПРЕДЕЛЕНО";
		
		МассивПолей = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(
			СтрЗаменить(ОписаниеПриемника.ПоляКэшаРегистра, "%1", "Т."),
			",",
			Истина,
			Истина);
		МассивРесурсов = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(
			СтрЗаменить(ОписаниеПриемника.ПоляОтбораНепустыхДвижений, "%1", "Т."),
			",",
			Истина,
			Истина);
		СлужебныеПоля = Новый Структура("Регистратор");
		ПоляИдентификаторов = Новый Структура("ИдентификаторФинЗаписи, ДокументРасчета, ДокументДвижения");
		
		Для Каждого ТекущееПоле Из МассивПолей Цикл
			
			ТекущееПолеКратко = СтрЗаменить(ТекущееПоле, "Т.", "");
			
			Если СлужебныеПоля.Свойство(ТекущееПолеКратко) Тогда
				Продолжить;
			КонецЕсли;
			
			ЭтоРесурсРегистра = (МассивРесурсов.Найти(ТекущееПоле) <> Неопределено);
			
			Если ЭтоРесурсРегистра Тогда
				
				// Ресурс
				ТекстОтборНепустыхРесурсов = ТекстОтборНепустыхРесурсов 
					+ ?(ТекстОтборНепустыхРесурсов = "", "", "
					|	ИЛИ ") + "СУММА(" + ТекущееПоле + ") <> 0";
				ТекстНулевыеРесурсыРегистра = ТекстНулевыеРесурсыРегистра 
					+ ?(ТекстНулевыеРесурсыРегистра = "", "", ",
					|	") + "0 КАК " + ТекущееПолеКратко;
				ТекстОтрицательныеРесурсыРегистра = ТекстОтрицательныеРесурсыРегистра 
					+ ?(ТекстОтрицательныеРесурсыРегистра = "", "", ",
					|	") + "-" + ТекущееПоле + " КАК " + ТекущееПолеКратко;
				ТекстСуммаРесурсовРегистра = ТекстСуммаРесурсовРегистра 
					+ ?(ТекстСуммаРесурсовРегистра = "", "", ",
					|	") + "СУММА(" + ТекущееПоле + ") КАК " + ТекущееПолеКратко;
				
			ИначеЕсли ТекущееПолеКратко = "ВидДвижения" ИЛИ ТекущееПолеКратко = "СлужебноеВидДвиженияПриход" Тогда
					
				ТекстПолеВидДвижения	  = "Т.ВидДвижения";
				ТекстСлужебноеВидДвижения =
					"ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
					|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
					|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
					|	КОНЕЦ";
				
			ИначеЕсли ПоляИдентификаторов.Свойство(ТекущееПолеКратко) Тогда

				ТекстПоляКешаРегистра = ТекстПоляКешаРегистра 
					+ ?(ТекстПоляКешаРегистра = "", "", ",
					|	") + ТекущееПоле + " КАК " + ТекущееПолеКратко;
				
				Если ТекущееПолеКратко = "ДокументРасчета" Тогда
					ТекстПоляОсновнойТаблицыРегистра = ТекстПоляОсновнойТаблицыРегистра 
						+ ?(ТекстПоляОсновнойТаблицыРегистра = "", "", ",
						|	") + "ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка) КАК " + ТекущееПолеКратко;
				Иначе
					ТекстПоляОсновнойТаблицыРегистра = ТекстПоляОсновнойТаблицыРегистра 
						+ ?(ТекстПоляОсновнойТаблицыРегистра = "", "", ",
						|	") + """"" КАК " + ТекущееПолеКратко;
				КонецЕсли;
				
				ТекстВыборкаПоляРегистра = ТекстВыборкаПоляРегистра 
					+ ?(ТекстВыборкаПоляРегистра = "", "", ",
					|	") + "МАКСИМУМ(" + ТекущееПоле + ") КАК " + ТекущееПолеКратко;
				
			Иначе
				
				// Измерение или реквизит
				ТекстГруппировкаПолей = ТекстГруппировкаПолей 
					+ ?(ТекстГруппировкаПолей = "", "", ",
					|	") + ТекущееПоле;
				ТекстПоляКешаРегистра = ТекстПоляКешаРегистра 
					+ ?(ТекстПоляКешаРегистра = "", "", ",
					|	") + ТекущееПоле + " КАК " + ТекущееПолеКратко;
				ТекстПоляОсновнойТаблицыРегистра = ТекстПоляОсновнойТаблицыРегистра 
					+ ?(ТекстПоляОсновнойТаблицыРегистра = "", "", ",
					|	") + ТекущееПоле + " КАК " + ТекущееПолеКратко;
				ТекстВыборкаПоляРегистра = ТекстВыборкаПоляРегистра 
					+ ?(ТекстВыборкаПоляРегистра = "", "", ",
					|	") + ТекущееПоле;
				
			КонецЕсли;
				
		КонецЦикла;
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляКешаРегистра", ТекстПоляКешаРегистра);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПоляОсновнойТаблицыРегистра", ТекстПоляОсновнойТаблицыРегистра);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ВыборкаПоляРегистра", ТекстВыборкаПоляРегистра);
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&СуммаРесурсовРегистра", ТекстСуммаРесурсовРегистра);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&НулевыеРесурсыРегистра", ТекстНулевыеРесурсыРегистра);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтрицательныеРесурсыРегистра", ТекстОтрицательныеРесурсыРегистра);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ГруппировкаПолей", ТекстГруппировкаПолей);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ОтборНепустыхРесурсов", ТекстОтборНепустыхРесурсов);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеВидДвижения", ТекстПолеВидДвижения);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&ПолеСлужебноеВидДвижения", ТекстСлужебноеВидДвижения);
		Если ПустаяСтрока(ОписаниеПриемника.ИндексыРегистра) Тогда
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИНДЕКСИРОВАТЬ ПО НовыеДвижения", "ИНДЕКСИРОВАТЬ ПО" + " " + СтрЗаменить(ОписаниеПриемника.ИзмеренияРегистра, "%1", "Т."));
		Иначе
			Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИНДЕКСИРОВАТЬ ПО НовыеДвижения", "ИНДЕКСИРОВАТЬ ПО" + " " + СтрЗаменить(ОписаниеПриемника.ИндексыРегистра, "%1", "Т."));
		КонецЕсли;
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыИсточника", ИмяТаблицыИсточника);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыКэшаРегистра", ОписаниеПриемника.ИмяТаблицыКэшаРегистра);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ИмяТаблицыРегистра", ОписаниеПриемника.ПолноеИмяРегистра);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
		
		КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьИменаКолонокСтрокой(
			РасчетСебестоимостиПрикладныеАлгоритмы.ВыгрузитьВременнуюТаблицу(ПараметрыРасчета, ИмяТаблицыИсточника, 0));
		
		КопируемыеПоля = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(КопируемыеПоля, "");
		
		ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
		РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(
			ПараметрыРасчета,
			ТаблицаОписанияПолей,
			ИмяРегистра,
			ИмяТаблицыИсточника,
			ИмяТаблицыПриемника,,,,
			Ложь);
		
		СоответствиеВременныхТаблицДвижений.Вставить(ИмяТаблицыПриемника, ИмяРегистра);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, "ТаблицаДвиженийПредварительная," + ИмяТаблицыИсточника);
		
	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);	
		
КонецПроцедуры

Процедура СписатьОтклоненияВСтоимостиТоваров(ПараметрыРасчета)
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СписатьОтклоненияВСтоимостиТоваров_ПодготовкаДанных");
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ВтДанныеТаблицаКорректировки, ВтДанныеТаблицаКорректировки_ОтклоненияВСтоимостиТоваров,
		|СписаниеОтклоненийПрочиеДоходыРасходы");
	
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстСписатьОтклоненияВСтоимостиТоваровПодготовкаДанных(ПараметрыРасчета));
	
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СписатьОтклоненияВСтоимостиТоваров_ФормированиеДвижений");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Формируются движения по регистрам:
	// - СебестоимостьТоваров
	// - ПрочиеРасходы
	// - ПрочиеДоходы
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
	#Область СебестоимостьТоваров
	
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицы = "ВтСписаниеОтклоненийСебестоимостьТоваров";
	ИмяВременнойТаблицыИсточник = "ВтДанныеТаблицаКорректировки";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(ПараметрыРасчета, ОписаниеПриемника, ИмяВременнойТаблицыИсточник);
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);

	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"ХозяйственнаяОперация",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтклонениеВСтоимостиТоваровРасходы)
		|	   КОГДА ЭтоДоходы
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтклонениеВСтоимостиТоваровДоходы)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВосстановлениеРезервовПодОбесценениеЗапасов)
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"НастройкаХозяйственнойОперации",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровРасходы)
		|	   КОГДА ЭтоДоходы
		|		ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровДоходы)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВосстановлениеРезервовПодОбесценениеЗапасов)
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"ТипЗаписи",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
		|	   КОГДА ЭтоДоходы
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ОтклонениеВСтоимостиНаПрочиеДоходы)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ПустаяСсылка)
		|	КОНЕЦ");

	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"СтатьяРасходовСписания",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА СтатьяРасходов
		|		ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"АналитикаРасходов",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА Номенклатура
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"СтатьяДоходов",
		"ВЫБОР КОГДА ЭтоДоходы
		|		ТОГДА СтатьяДоходов
		|		ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"АналитикаДоходов",
		"ВЫБОР КОГДА ЭтоДоходы
		|		ТОГДА Номенклатура
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

	#КонецОбласти

	#Область ОтклоненияВСтоимостиТоваров
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ОтклоненияВСтоимостиТоваров.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицы = "ВтСписаниеОтклоненийОтклоненияВСтоимостиТоваров";
	ИмяВременнойТаблицыИсточник = "ВтДанныеТаблицаКорректировки_ОтклоненияВСтоимостиТоваров";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(ПараметрыРасчета, ОписаниеПриемника, ИмяВременнойТаблицыИсточник);
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);

	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"ХозяйственнаяОперация",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтклонениеВСтоимостиТоваровРасходы)
		|	   КОГДА ЭтоДоходы
		|		ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтклонениеВСтоимостиТоваровДоходы)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВосстановлениеРезервовПодОбесценениеЗапасов)
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"НастройкаХозяйственнойОперации",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровРасходы)
		|	   КОГДА ЭтоДоходы
		|		ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровДоходы)
		|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВосстановлениеРезервовПодОбесценениеЗапасов)
		|	КОНЕЦ");

	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"СтатьяРасходовСписания",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА СтатьяРасходов
		|		ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"АналитикаРасходов",
		"ВЫБОР КОГДА ЭтоРасходы
		|		ТОГДА Номенклатура
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"СтатьяДоходов",
		"ВЫБОР КОГДА ЭтоДоходы
		|		ТОГДА СтатьяДоходов
		|		ИНАЧЕ ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
		|	КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"АналитикаДоходов",
		"ВЫБОР КОГДА ЭтоДоходы
		|		ТОГДА Номенклатура
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

	#КонецОбласти

	#Область СписаниеОтклоненийПрочиеДоходыРасходы
	
	Запрос.Текст = "
	// На прочие доходы будут отнесены отрицательные суммы отклонения в стоимости
	|ВЫБРАТЬ
	|	ИСТИНА КАК ЭтоДоходы,
	|	ЛОЖЬ   КАК ЭтоРасходы,
	|
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ИСТИНА 											   КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)             КАК ВидДвижения,
	|	ТаблицаКорректировки.Регистратор              	   КАК ДокументДвижения,
	|	ТаблицаКорректировки.Регистратор               	   КАК ДокументРасчета,
	|	ТаблицаКорректировки.Регистратор               	   КАК Регистратор,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтклонениеВСтоимостиТоваровДоходы) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровДоходы) КАК НастройкаХозяйственнойОперации,
	|
	|	ТаблицаКорректировки.СтатьяРасходов                КАК СтатьяРасходов,
	|	ТаблицаКорректировки.Номенклатура 				   КАК АналитикаРасходов,
	|	ТаблицаКорректировки.СтатьяДоходов 				   КАК СтатьяДоходов,
	|	ТаблицаКорректировки.Номенклатура 				   КАК АналитикаДоходов,
	|	ТаблицаКорректировки.ИдентификаторФинЗаписи 	   КАК ИдентификаторФинЗаписи,
	|
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС < 0
	|			ТОГДА -(ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС)
	|		ИНАЧЕ 0 КОНЕЦ) КАК Сумма,
	|	0 КАК СуммаБезНДС,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл < 0
	|			ТОГДА -(ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл)
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр < 0
	|			ТОГДА -(ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр)
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СуммаНДД
	|ПОМЕСТИТЬ СписаниеОтклоненийПрочиеДоходыРасходы
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаКорректировки
	|ГДЕ
	|	 ТаблицаКорректировки.РазделУчета В (&БалансовыеРазделыУчета)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// На прочие расходы будут отнесены положительные суммы отклонения в стоимости
	|ВЫБРАТЬ
	|	ЛОЖЬ   КАК ЭтоДоходы,
	|	ИСТИНА КАК ЭтоРасходы,
	|
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ИСТИНА 											   КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)             КАК ВидДвижения,
	|	ТаблицаКорректировки.Регистратор              	   КАК ДокументДвижения,
	|	ТаблицаКорректировки.Регистратор               	   КАК ДокументРасчета,
	|	ТаблицаКорректировки.Регистратор               	   КАК Регистратор,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтклонениеВСтоимостиТоваровРасходы) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровРасходы) КАК НастройкаХозяйственнойОперации,
	|
	|	ТаблицаКорректировки.СтатьяРасходов                КАК СтатьяРасходов,
	|	ТаблицаКорректировки.Номенклатура 				   КАК АналитикаРасходов,
	|	ТаблицаКорректировки.СтатьяДоходов 				   КАК СтатьяДоходов,
	|	ТаблицаКорректировки.Номенклатура 				   КАК АналитикаДоходов,
	|	ТаблицаКорректировки.ИдентификаторФинЗаписи 	   КАК ИдентификаторФинЗаписи,
	|
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС > 0
	|			ТОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК Сумма,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|			ТОГДА ТаблицаКорректировки.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|			ТОГДА ТаблицаКорректировки.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.СтоимостьНДД > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаНДД
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК ТаблицаКорректировки
	|ГДЕ
	|	 ТаблицаКорректировки.РазделУчета В (&БалансовыеРазделыУчета)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// На прочие доходы будут отнесены отрицательные суммы отклонения в стоимости (из регистра "Отклонения в стоимости товаров")
	|ВЫБРАТЬ
	|	ИСТИНА КАК ЭтоДоходы,
	|	ЛОЖЬ   КАК ЭтоРасходы,
	|
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ИСТИНА 											   КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)             КАК ВидДвижения,
	|	ТаблицаКорректировки.Регистратор              	   КАК ДокументДвижения,
	|	ТаблицаКорректировки.Регистратор               	   КАК ДокументРасчета,
	|	ТаблицаКорректировки.Регистратор               	   КАК Регистратор,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтклонениеВСтоимостиТоваровДоходы) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровДоходы) КАК НастройкаХозяйственнойОперации,
	|
	|	ТаблицаКорректировки.СтатьяРасходов                КАК СтатьяРасходов,
	|	ТаблицаКорректировки.Номенклатура 				   КАК АналитикаРасходов,
	|	ТаблицаКорректировки.СтатьяДоходов 				   КАК СтатьяДоходов,
	|	ТаблицаКорректировки.Номенклатура 				   КАК АналитикаДоходов,
	|	ТаблицаКорректировки.ИдентификаторФинЗаписи 	   КАК ИдентификаторФинЗаписи,
	|
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС < 0
	|			ТОГДА -(ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС)
	|		ИНАЧЕ 0 КОНЕЦ) КАК Сумма,
	|	0 КАК СуммаБезНДС,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл < 0
	|			ТОГДА -(ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл)
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр < 0
	|			ТОГДА -(ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр)
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СуммаНДД
	|ИЗ
	|	ВтДанныеТаблицаКорректировки_ОтклоненияВСтоимостиТоваров КАК ТаблицаКорректировки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// На прочие расходы будут отнесены положительные суммы отклонения в стоимости (из регистра "Отклонения в стоимости товаров")
	|ВЫБРАТЬ
	|	ЛОЖЬ   КАК ЭтоДоходы,
	|	ИСТИНА КАК ЭтоРасходы,
	|
	|	ТаблицаКорректировки.Период                        КАК Период,
	|	ИСТИНА 											   КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)             КАК ВидДвижения,
	|	ТаблицаКорректировки.Регистратор              	   КАК ДокументДвижения,
	|	ТаблицаКорректировки.Регистратор               	   КАК ДокументРасчета,
	|	ТаблицаКорректировки.Регистратор               	   КАК Регистратор,
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.НаправлениеДеятельности       КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка) КАК АналитикаУчетаНоменклатуры,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтклонениеВСтоимостиТоваровРасходы) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ОтклонениеВСтоимостиТоваровРасходы) КАК НастройкаХозяйственнойОперации,
	|
	|	ТаблицаКорректировки.СтатьяРасходов                КАК СтатьяРасходов,
	|	ТаблицаКорректировки.Номенклатура 				   КАК АналитикаРасходов,
	|	ТаблицаКорректировки.СтатьяДоходов 				   КАК СтатьяДоходов,
	|	ТаблицаКорректировки.Номенклатура 				   КАК АналитикаДоходов,
	|	ТаблицаКорректировки.ИдентификаторФинЗаписи 	   КАК ИдентификаторФинЗаписи,
	|
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС > 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК Сумма,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаБезНДС,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл > 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаРегл,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр > 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаУпр,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл > 0
	|			ТОГДА ТаблицаКорректировки.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл
	|		 - ТаблицаКорректировки.ПостояннаяРазница - ТаблицаКорректировки.ВременнаяРазница > 0
	|			ТОГДА ТаблицаКорректировки.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	(ВЫБОР 
	|		КОГДА ТаблицаКорректировки.НДД > 0
	|			ТОГДА ТаблицаКорректировки.НДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СуммаНДД
	|ИЗ
	|	ВтДанныеТаблицаКорректировки_ОтклоненияВСтоимостиТоваров КАК ТаблицаКорректировки
	|;
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	#КонецОбласти

	#Область ПрочиеДоходы
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеДоходы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицы = "ВтСписаниеОтклоненийПрочиеДоходы";
	ИмяВременнойТаблицыИсточник = "СписаниеОтклоненийПрочиеДоходыРасходы";
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);

	УсловиеГДЕ = "ЭтоДоходы";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы, УсловиеГДЕ);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

	#КонецОбласти
	
	#Область ПрочиеРасходы
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицы = "ВтСписаниеОтклоненийПрочиеРасходы";
	ИмяВременнойТаблицыИсточник = "СписаниеОтклоненийПрочиеДоходыРасходы";
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);

	УсловиеГДЕ = "ЭтоРасходы";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы, УсловиеГДЕ);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

	#КонецОбласти

	#Область Выручка

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор КАК Регистратор,
	// Измерения
	|	Т.АналитикаУчетаНоменклатуры,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказКлиента,
	|	АналитикаПартнера.КлючАналитики КАК АналитикаУчетаПоПартнерам,
	|	ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка) КАК Подразделение,
	|	(ВЫБОР
	|		КОГДА Т.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|		 И НЕ Т.АналитикаУчетаНоменклатуры.Номенклатура.ПрослеживаемыйТовар
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
	|		ИНАЧЕ Т.ВидЗапасов.ТипЗапасов КОНЕЦ) КАК ТипЗапасов,
	|	Т.ВидЗапасов,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория КАК Склад,
	// Ресурсы
	|	Т.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	|	Т.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	// Реквизиты
	|	Т.Регистратор КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВосстановлениеРезервовПодОбесценениеЗапасов) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВосстановлениеРезервовПодОбесценениеЗапасов) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ СписаниеОтклоненийВыручкаИСебестоимостьРезервы
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПартнера
	|	ПО (АналитикаПартнера.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|		И (АналитикаПартнера.Организация = Т.Организация)
	|		И (АналитикаПартнера.Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка))
	|		И (АналитикаПартнера.Договор = ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка))
	|		И (АналитикаПартнера.НаправлениеДеятельности = Т.НаправлениеДеятельности)
	|ГДЕ
	|	Т.РезервПодОбесценениеУпр <> 0 ИЛИ Т.РезервПодОбесценениеРегл <> 0
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтСписаниеОтклоненийВыручка";
	ОписаниеВТ.ИмяВТИсточника = "СписаниеОтклоненийВыручкаИСебестоимостьРезервы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ПартииСКорректировкамиИИсправлениями, ВтДанныеТаблицаКорректировки,
		|СписаниеОтклоненийПрочиеДоходыРасходы, СписаниеОтклоненийВыручкаИСебестоимостьРезервы,
		|ВтСписаниеОтклоненийПрочиеДоходы, ВтСписаниеОтклоненийПрочиеРасходы, ВтСписаниеОтклоненийВыручка");
	
КонецПроцедуры

Функция ТекстСписатьОтклоненияВСтоимостиТоваровПодготовкаДанных(ПараметрыРасчета)
	
	ТекстЗапроса = "";
	
	#Область ПартииСКорректировкамиИИсправлениями
	
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.Организация КАК Организация
	|ПОМЕСТИТЬ ПартииСКорректировкамиИИсправлениями
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.ТипЗаписи В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.КорректировкаПриобретения),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеТекущегоПериода),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ИсправлениеПеремещенияПрошлогоПериода),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.ДополнениеПрошлыйПериод))
	|	И НЕ Т.Организация В (&ОрганизацииСреднескользящая)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// При среднескользящей могут возникнуть суммовые остатки из-за нарушения хронологиии ввода документов.
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.Партия КАК Партия,
	|	Т.Организация КАК Организация
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|ГДЕ
	|	НЕ Т.СлужебноеВидДвиженияПриход
	|	И Т.Организация В (&ОрганизацииСреднескользящая)
	|
	// Индексы должны соответствовать индексам таблицы ВТКэшРасчетныеОстаткиСебестоимостьТоваров, описанным
	// в функции РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеРегистра() #Область ИндексыРегистра
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаНоменклатуры,
	|	Организация,
	|	Партия
	|;";
	
	#КонецОбласти
	
	#Область НенулевыеОстаткиСебестоимости
	
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация КАК Организация,
	|	Аналитика.Номенклатура КАК Номенклатура,
	|	Аналитика.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Аналитика.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Аналитика.МестоХранения
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Аналитика.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения
	|
	|ПОМЕСТИТЬ НенулевыеОстаткиСебестоимости
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ВТУчетныеПолитикиФинУчета.Организация = Т.Организация
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО Аналитика.Ссылка = Т.АналитикаУчетаНоменклатуры
	|ГДЕ
	|	Т.Количество <> 0
	|
	// Индексы должны соответствовать индексам таблицы ВТКэшРасчетныеОстаткиОтклоненияВСтоимостиТоваров, описанным
	// в функции РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеРегистра() #Область ИндексыРегистра
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Организация
	|;";
	
	#КонецОбласти
	
	#Область ВтДанныеТаблицаКорректировки
	
	ТекстЗапроса = ТекстЗапроса + " 
	|ВЫБРАТЬ
	|	&КонецПериода                        			   КАК Период,
	|	ЛОЖЬ 											   КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)             КАК ВидДвижения,
	|	ДокументыРасчетаСебестоимости.Ссылка 			   КАК Регистратор,
	|
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаКорректировки.РазделУчета 				   КАК РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаКорректировки.Партия                        КАК Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ЕСТЬNULL(ТаблицаКорректировки.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
    |
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяССылка) 				КАК СтатьяРасходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ОтклонениеВСтоимостиТоваров) 	КАК СтатьяДоходов,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры.Номенклатура 				КАК Номенклатура,
	|	"""" КАК ИдентификаторФинЗаписи,
	|
	|	ЛОЖЬ КАК ЭтоРасходы,
	|	ИСТИНА КАК ЭтоДоходы,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС < 0
	|			ТОГДА ТаблицаКорректировки.Стоимость
	|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьЗабалансовая < 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьЗабалансовая
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансовая,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС < 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходы
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходы,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС < 0
	|			ТОГДА ТаблицаКорректировки.Трудозатраты
	|		ИНАЧЕ 0 КОНЕЦ) КАК Трудозатраты,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС < 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл < 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьЗабалансоваяРегл < 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьЗабалансоваяРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл < 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл < 0
	|			ТОГДА ТаблицаКорректировки.ТрудозатратыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл < 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл < 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ПостояннаяРазница > 0
	|			ТОГДА ТаблицаКорректировки.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ВременнаяРазница > 0 // НУ = БУ - ПР - ВР, сумма НУ будет < 0
	|			ТОГДА ТаблицаКорректировки.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьНДД < 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьНДД,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр < 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр < 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр < 0
	|			ТОГДА ТаблицаКорректировки.ТрудозатратыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр < 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПостоянныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр < 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	// Восстановление резервов под обесценение запасов должно отражаться отдельным движениям.
	|	0 КАК РезервПодОбесценениеРегл,
	|	0 КАК РезервПодОбесценениеУпр
	|
	|ПОМЕСТИТЬ ВтДанныеТаблицаКорректировки
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК ТаблицаКорректировки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииСКорректировкамиИИсправлениями КАК Отбор
	|		ПО ТаблицаКорректировки.АналитикаУчетаНоменклатуры = Отбор.АналитикаУчетаНоменклатуры
	|		И ТаблицаКорректировки.ВидЗапасов = Отбор.ВидЗапасов
	|		И ТаблицаКорректировки.Организация = Отбор.Организация
	|		И ТаблицаКорректировки.Партия = Отбор.Партия
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО ДокументыРасчетаСебестоимости.Организация = ТаблицаКорректировки.Организация
	|ГДЕ
	|	ТаблицаКорректировки.Количество = 0
	|	И (ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС < 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС < 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл < 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр < 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьЗабалансовая < 0
	|		ИЛИ ТаблицаКорректировки.ВременнаяРазница > 0 // НУ = БУ - ПР - ВР, сумма НУ будет < 0
	|		ИЛИ ТаблицаКорректировки.ПостояннаяРазница > 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьНДД < 0)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&КонецПериода                        			   КАК Период,
	|	ЛОЖЬ 											   КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)             КАК ВидДвижения,
	|	ДокументыРасчетаСебестоимости.Ссылка 			   КАК Регистратор,
	|
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаКорректировки.РазделУчета 				   КАК РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаКорректировки.Партия                        КАК Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ЕСТЬNULL(ТаблицаКорректировки.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
    |
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ОтклонениеВСтоимостиТоваров) КАК СтатьяРасходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)				 	КАК СтатьяДоходов,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры.Номенклатура 				КАК Номенклатура,
	|	"""" КАК ИдентификаторФинЗаписи,
	|
	|	ИСТИНА КАК ЭтоРасходы,
	|	ЛОЖЬ КАК ЭтоДоходы,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС > 0
	|			ТОГДА ТаблицаКорректировки.Стоимость
	|		ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьЗабалансовая > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьЗабалансовая
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансовая,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС > 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходы
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходы,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС > 0
	|			ТОГДА ТаблицаКорректировки.Трудозатраты
	|		ИНАЧЕ 0 КОНЕЦ) КАК Трудозатраты,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеСНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеСНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьЗабалансоваяРегл > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьЗабалансоваяРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|			ТОГДА ТаблицаКорректировки.ТрудозатратыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПостоянныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ПостояннаяРазница < 0
	|			ТОГДА ТаблицаКорректировки.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ВременнаяРазница < 0 // НУ = БУ - ПР - ВР, сумма НУ будет > 0
	|			ТОГДА ТаблицаКорректировки.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьНДД > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьНДД,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр > 0
	|			ТОГДА ТаблицаКорректировки.СтоимостьУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр > 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр > 0
	|			ТОГДА ТаблицаКорректировки.ТрудозатратыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ТрудозатратыУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр > 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПостоянныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПостоянныеУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр
	|		 + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр > 0
	|			ТОГДА ТаблицаКорректировки.ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостатейныеПеременныеУпр,
	// Восстановление резервов под обесценение запасов должно отражаться отдельным движениям.
	|	0 КАК РезервПодОбесценениеРегл,
	|	0 КАК РезервПодОбесценениеУпр
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК ТаблицаКорректировки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииСКорректировкамиИИсправлениями КАК Отбор
	|		ПО ТаблицаКорректировки.АналитикаУчетаНоменклатуры = Отбор.АналитикаУчетаНоменклатуры
	|		И ТаблицаКорректировки.ВидЗапасов = Отбор.ВидЗапасов
	|		И ТаблицаКорректировки.Организация = Отбор.Организация
	|		И ТаблицаКорректировки.Партия = Отбор.Партия
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО ДокументыРасчетаСебестоимости.Организация = ТаблицаКорректировки.Организация
	|ГДЕ
	|	ТаблицаКорректировки.Количество = 0
	|	И (ТаблицаКорректировки.Стоимость + ТаблицаКорректировки.ДопРасходы + ТаблицаКорректировки.Трудозатраты + ТаблицаКорректировки.ПостатейныеПостоянныеСНДС + ТаблицаКорректировки.ПостатейныеПеременныеСНДС > 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС + ТаблицаКорректировки.Трудозатраты + ТаблицаКорректировки.ПостатейныеПостоянныеБезНДС + ТаблицаКорректировки.ПостатейныеПеременныеБезНДС > 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.ТрудозатратыРегл + ТаблицаКорректировки.ПостатейныеПостоянныеРегл + ТаблицаКорректировки.ПостатейныеПеременныеРегл > 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.ТрудозатратыУпр + ТаблицаКорректировки.ПостатейныеПостоянныеУпр + ТаблицаКорректировки.ПостатейныеПеременныеУпр > 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьЗабалансовая > 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьЗабалансоваяРегл > 0
	|		ИЛИ ТаблицаКорректировки.ВременнаяРазница < 0 // НУ = БУ - ПР - ВР, сумма НУ будет > 0
	|		ИЛИ ТаблицаКорректировки.ПостояннаяРазница < 0
	|		ИЛИ ТаблицаКорректировки.СтоимостьНДД > 0)
	|";
	
	#КонецОбласти
	
	#Область ВтДанныеТаблицаКорректировки_ВосстановлениеРезервов
	
	// Восстановление резервов под обесценение запасов должно отражаться отдельным движениям.
	ТекстЗапроса = ТекстЗапроса + "
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&КонецПериода                        			   КАК Период,
	|	ЛОЖЬ 											   КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)             КАК ВидДвижения,
	|	ДокументыРасчетаСебестоимости.Ссылка 			   КАК Регистратор,
	|
	|	ТаблицаКорректировки.Организация                   КАК Организация,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|	ТаблицаКорректировки.РазделУчета 				   КАК РазделУчета,
	|	ТаблицаКорректировки.ВидЗапасов                    КАК ВидЗапасов,
	|	ТаблицаКорректировки.Партия                        КАК Партия,
	|	ТаблицаКорректировки.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	ТаблицаКорректировки.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	ТаблицаКорректировки.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ЕСТЬNULL(ТаблицаКорректировки.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)) КАК НаправлениеДеятельности,
    |
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяДоходов,
	|	ТаблицаКорректировки.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	"""" КАК ИдентификаторФинЗаписи,
	|
	|	ЛОЖЬ КАК ЭтоРасходы,
	|	ЛОЖЬ КАК ЭтоДоходы,
	|
	|	0 КАК Стоимость,
	|	0 КАК СтоимостьБезНДС,
	|	0 КАК СтоимостьЗабалансовая,
	|	0 КАК ДопРасходы,
	|	0 КАК ДопРасходыБезНДС,
	|	0 КАК Трудозатраты,
	|	0 КАК ПостатейныеПостоянныеСНДС,
	|	0 КАК ПостатейныеПеременныеСНДС,
	|	0 КАК ПостатейныеПостоянныеБезНДС,
	|	0 КАК ПостатейныеПеременныеБезНДС,
	|	0 КАК СтоимостьРегл,
	|	0 КАК СтоимостьЗабалансоваяРегл,
	|	0 КАК ДопРасходыРегл,
	|	0 КАК ТрудозатратыРегл,
	|	0 КАК ПостатейныеПостоянныеРегл,
	|	0 КАК ПостатейныеПеременныеРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	0 КАК СтоимостьНДД,
	|	0 КАК СтоимостьУпр,
	|	0 КАК ДопРасходыУпр,
	|	0 КАК ТрудозатратыУпр,
	|	0 КАК ПостатейныеПостоянныеУпр,
	|	0 КАК ПостатейныеПеременныеУпр,
	|	ТаблицаКорректировки.РезервПодОбесценениеРегл,
	|	ТаблицаКорректировки.РезервПодОбесценениеУпр
	|
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК ТаблицаКорректировки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПартииСКорректировкамиИИсправлениями КАК Отбор
	|		ПО ТаблицаКорректировки.АналитикаУчетаНоменклатуры = Отбор.АналитикаУчетаНоменклатуры
	|		И ТаблицаКорректировки.Организация = Отбор.Организация
	|		И ТаблицаКорректировки.Партия = Отбор.Партия
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО ДокументыРасчетаСебестоимости.Организация = ТаблицаКорректировки.Организация
	|ГДЕ
	|	ТаблицаКорректировки.Количество = 0
	|	И (ТаблицаКорректировки.РезервПодОбесценениеРегл <> 0
	|		ИЛИ ТаблицаКорректировки.РезервПодОбесценениеУпр <> 0)
	|;
	|";
	
	#КонецОбласти
	
	#Область ВтДанныеТаблицаКорректировки_ОтклоненияВСтоимостиТоваров
	
	ТекстЗапроса = ТекстЗапроса + " 
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""1"" КАК ЗапросИсточник,
	|	Остатки.Организация КАК Организация,
	|	Аналитика.Номенклатура КАК Номенклатура,
	|	Аналитика.Характеристика КАК Характеристика,
	|	Остатки.ВидЗапасов КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Аналитика.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Аналитика.МестоХранения
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Аналитика.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения
	|
	|ПОМЕСТИТЬ НулевыеОстаткиСКорректировкамиИИсправлениями
	|ИЗ
	|	ВтДанныеТаблицаКорректировки КАК Остатки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Остатки.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО Аналитика.Ссылка = Остатки.АналитикаУчетаНоменклатуры
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Добавим аналитики, по которым нет остатков в себестоимости товаров.
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	""2"" КАК ЗапросИсточник,
	|	Корректировки.Организация КАК Организация,
	|	Аналитика.Номенклатура КАК Номенклатура,
	|	Аналитика.Характеристика КАК Характеристика,
	|	Корректировки.ВидЗапасов КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Аналитика.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Аналитика.МестоХранения
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Аналитика.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Аналитика.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения
	|
	|ИЗ
	|	ПартииСКорректировкамиИИсправлениями КАК Корректировки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Корректировки.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО Аналитика.Ссылка = Корректировки.АналитикаУчетаНоменклатуры
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтДанныеТаблицаКорректировки КАК СуммовыеОстатки
	|		ПО СуммовыеОстатки.АналитикаУчетаНоменклатуры = Корректировки.АналитикаУчетаНоменклатуры
	|		И СуммовыеОстатки.ВидЗапасов = Корректировки.ВидЗапасов
	|		И СуммовыеОстатки.Организация = Корректировки.Организация
	|		И СуммовыеОстатки.Партия = Корректировки.Партия
	|ГДЕ
	|	СуммовыеОстатки.Организация ЕСТЬ NULL
	|
	// Индексы должны соответствовать индексам таблицы ВТКэшРасчетныеОстаткиОтклоненияВСтоимостиТоваров, описанным
	// в функции РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеРегистра() #Область ИндексыРегистра
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Организация
	|;
	|ВЫБРАТЬ
	|	&КонецПериода									КАК Период,
	|	ЛОЖЬ											КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)			КАК ВидДвижения,
	|	ДокументыРасчетаСебестоимости.Ссылка 			КАК Регистратор,
	|
	|	ТаблицаКорректировки.Организация				КАК Организация,
	|	ТаблицаКорректировки.Номенклатура				КАК Номенклатура,
	|	ТаблицаКорректировки.Характеристика				КАК Характеристика,
	|	ТаблицаКорректировки.ВидЗапасов					КАК ВидЗапасов,
	|	ТаблицаКорректировки.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.Подразделение				КАК Подразделение,
	|	ТаблицаКорректировки.МестоХранения				КАК МестоХранения,
	|	ТаблицаКорректировки.ПериодОтклонения			КАК ПериодОтклонения,
	|
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 				КАК СтатьяРасходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ОтклонениеВСтоимостиТоваров) 	КАК СтатьяДоходов,
	|	"""" КАК ИдентификаторФинЗаписи,
	|
	|	ЛОЖЬ КАК ЭтоРасходы,
	|	ИСТИНА КАК ЭтоДоходы,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС < 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ОтклоненияВСтоимостиСНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС < 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ОтклоненияВСтоимостиБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС < 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыСНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС < 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл < 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ОтклоненияВСтоимостиРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл < 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл < 0
	|			ТОГДА ТаблицаКорректировки.НДСРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК НДСРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ПостояннаяРазница > 0
	|			ТОГДА ТаблицаКорректировки.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ВременнаяРазница > 0 // НУ = БУ - ПР - ВР, сумма НУ будет < 0
	|			ТОГДА ТаблицаКорректировки.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.НДД < 0
	|			ТОГДА ТаблицаКорректировки.НДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК НДД,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр < 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ОтклоненияВСтоимостиУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр < 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр < 0
	|			ТОГДА ТаблицаКорректировки.НДСУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр
	|
	|ПОМЕСТИТЬ ВтДанныеТаблицаКорректировки_ОтклоненияВСтоимостиТоваров
	|ИЗ
	|	ВТКэшРасчетныеОстаткиОтклоненияВСтоимостиТоваров КАК ТаблицаКорректировки
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ НулевыеОстаткиСКорректировкамиИИсправлениями КАК Отбор
	|		ПО ТаблицаКорректировки.Номенклатура = Отбор.Номенклатура
	|		И ТаблицаКорректировки.Характеристика = Отбор.Характеристика
	|		И ТаблицаКорректировки.ВидЗапасов = Отбор.ВидЗапасов
	|		И ТаблицаКорректировки.Организация = Отбор.Организация
	|		И ТаблицаКорректировки.НаправлениеДеятельности = Отбор.НаправлениеДеятельности
	|		И ТаблицаКорректировки.Подразделение = Отбор.Подразделение
	|		И ТаблицаКорректировки.МестоХранения = Отбор.МестоХранения
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ НенулевыеОстаткиСебестоимости КАК НенулевыеОстатки
	|		ПО ТаблицаКорректировки.Номенклатура = НенулевыеОстатки.Номенклатура
	|		И ТаблицаКорректировки.Характеристика = НенулевыеОстатки.Характеристика
	|		И ТаблицаКорректировки.ВидЗапасов = НенулевыеОстатки.ВидЗапасов
	|		И ТаблицаКорректировки.Организация = НенулевыеОстатки.Организация
	|		И ТаблицаКорректировки.НаправлениеДеятельности = НенулевыеОстатки.НаправлениеДеятельности
	|		И ТаблицаКорректировки.Подразделение = НенулевыеОстатки.Подразделение
	|		И ТаблицаКорректировки.МестоХранения = НенулевыеОстатки.МестоХранения
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО ДокументыРасчетаСебестоимости.Организация = ТаблицаКорректировки.Организация
	|ГДЕ
	|	(ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС < 0
	|		ИЛИ ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС < 0
	|		ИЛИ ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл < 0
	|		ИЛИ ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр < 0
	|		ИЛИ ТаблицаКорректировки.ВременнаяРазница > 0 // НУ = БУ - ПР - ВР, сумма НУ будет < 0
	|		ИЛИ ТаблицаКорректировки.ПостояннаяРазница > 0
	|		ИЛИ ТаблицаКорректировки.НДД < 0)
	|	И НенулевыеОстатки.Организация ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&КонецПериода									КАК Период,
	|	ЛОЖЬ											КАК СлужебноеВидДвиженияПриход,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)			КАК ВидДвижения,
	|	ДокументыРасчетаСебестоимости.Ссылка 			КАК Регистратор,
	|
	|	ТаблицаКорректировки.Организация				КАК Организация,
	|	ТаблицаКорректировки.Номенклатура				КАК Номенклатура,
	|	ТаблицаКорректировки.Характеристика				КАК Характеристика,
	|	ТаблицаКорректировки.ВидЗапасов					КАК ВидЗапасов,
	|	ТаблицаКорректировки.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ТаблицаКорректировки.Подразделение				КАК Подразделение,
	|	ТаблицаКорректировки.МестоХранения				КАК МестоХранения,
	|	ТаблицаКорректировки.ПериодОтклонения			КАК ПериодОтклонения,
	|
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ОтклонениеВСтоимостиТоваров) КАК СтатьяРасходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)				 	КАК СтатьяДоходов,
	|	"""" КАК ИдентификаторФинЗаписи,
	|
	|	ИСТИНА КАК ЭтоРасходы,
	|	ЛОЖЬ КАК ЭтоДоходы,
	|
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС > 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ОтклоненияВСтоимостиСНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ОтклоненияВСтоимостиБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС > 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыСНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыСНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС > 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыБезНДС,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл > 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ОтклоненияВСтоимостиРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл > 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл > 0
	|			ТОГДА ТаблицаКорректировки.НДСРегл
	|		ИНАЧЕ 0 КОНЕЦ) КАК НДСРегл,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ПостояннаяРазница < 0
	|			ТОГДА ТаблицаКорректировки.ПостояннаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ПостояннаяРазница,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ВременнаяРазница < 0 // НУ = БУ - ПР - ВР, сумма НУ будет > 0
	|			ТОГДА ТаблицаКорректировки.ВременнаяРазница
	|		ИНАЧЕ 0 КОНЕЦ) КАК ВременнаяРазница,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.НДД > 0
	|			ТОГДА ТаблицаКорректировки.НДД
	|		ИНАЧЕ 0 КОНЕЦ) КАК НДД,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр > 0
	|			ТОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ОтклоненияВСтоимостиУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр > 0
	|			ТОГДА ТаблицаКорректировки.ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК ДопРасходыУпр,
	|	(ВЫБОР
	|		КОГДА ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр > 0
	|			ТОГДА ТаблицаКорректировки.НДСУпр
	|		ИНАЧЕ 0 КОНЕЦ) КАК НДСУпр
	|
	|ИЗ
	|	ВТКэшРасчетныеОстаткиОтклоненияВСтоимостиТоваров КАК ТаблицаКорректировки
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ НулевыеОстаткиСКорректировкамиИИсправлениями КАК Отбор
	|		ПО ТаблицаКорректировки.Номенклатура = Отбор.Номенклатура
	|		И ТаблицаКорректировки.Характеристика = Отбор.Характеристика
	|		И ТаблицаКорректировки.ВидЗапасов = Отбор.ВидЗапасов
	|		И ТаблицаКорректировки.Организация = Отбор.Организация
	|		И ТаблицаКорректировки.НаправлениеДеятельности = Отбор.НаправлениеДеятельности
	|		И ТаблицаКорректировки.Подразделение = Отбор.Подразделение
	|		И ТаблицаКорректировки.МестоХранения = Отбор.МестоХранения
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ НенулевыеОстаткиСебестоимости КАК НенулевыеОстатки
	|		ПО ТаблицаКорректировки.Номенклатура = НенулевыеОстатки.Номенклатура
	|		И ТаблицаКорректировки.Характеристика = НенулевыеОстатки.Характеристика
	|		И ТаблицаКорректировки.ВидЗапасов = НенулевыеОстатки.ВидЗапасов
	|		И ТаблицаКорректировки.Организация = НенулевыеОстатки.Организация
	|		И ТаблицаКорректировки.НаправлениеДеятельности = НенулевыеОстатки.НаправлениеДеятельности
	|		И ТаблицаКорректировки.Подразделение = НенулевыеОстатки.Подразделение
	|		И ТаблицаКорректировки.МестоХранения = НенулевыеОстатки.МестоХранения
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО ДокументыРасчетаСебестоимости.Организация = ТаблицаКорректировки.Организация
	|ГДЕ
	|	(ТаблицаКорректировки.ОтклоненияВСтоимостиСНДС + ТаблицаКорректировки.ДопРасходыСНДС > 0
	|		ИЛИ ТаблицаКорректировки.ОтклоненияВСтоимостиБезНДС + ТаблицаКорректировки.ДопРасходыБезНДС > 0
	|		ИЛИ ТаблицаКорректировки.ОтклоненияВСтоимостиРегл + ТаблицаКорректировки.ДопРасходыРегл + ТаблицаКорректировки.НДСРегл > 0
	|		ИЛИ ТаблицаКорректировки.ОтклоненияВСтоимостиУпр + ТаблицаКорректировки.ДопРасходыУпр + ТаблицаКорректировки.НДСУпр > 0
	|		ИЛИ ТаблицаКорректировки.ВременнаяРазница < 0 // НУ = БУ - ПР - ВР, сумма НУ будет > 0
	|		ИЛИ ТаблицаКорректировки.ПостояннаяРазница < 0
	|		ИЛИ ТаблицаКорректировки.НДД > 0)
	|	И НенулевыеОстатки.Организация ЕСТЬ NULL
	|;
	|";
	
	#КонецОбласти
	
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

Процедура СформироватьДвиженияПрочиеРасходыДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, РасходныеДвижения = Истина)

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	
	КопируемыеПоля = "
	|Период, ВидДвижения, Регистратор, НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи";

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СтруктураПараметров = Новый Структура();
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	УсловиеГде = "";
	// Заполним дополнительные свойства движения
	Если РасходныеДвижения Тогда
		
		ИмяВременнойТаблицы = "втПрочиеРасходыДополнительныеРасходыРасходныеДвижения";
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"СлужебноеВидДвиженияПриход", "ЛОЖЬ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"Организация", "Организация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"Подразделение", "Подразделение");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"НаправлениеДеятельности", "НаправлениеДеятельности");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"СтатьяРасходов", "СтатьяРасходов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"АналитикаРасходов", "АналитикаРасходов");
		// Для НДС налогового агента используется корреспондеция "ПрочиеРасходы-ПрочиеРасходы", поэтому для таких
		//	случаев необходимо заполнять кор. часть регистра, в остальных случаях (например для корреспонденции
		//	СебестоимостьТоваров - ПрочиеРасходы) кор. часть не заполняется, так как движение должно быть только 1.
		ШаблонЗаполненияКорПоля = "ВЫБОР
		|		КОГДА АналитикаУчетаНоменклатуры = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаНоменклатуры.ПустаяСсылка)
		|		  ИЛИ АналитикаУчетаНоменклатуры = НЕОПРЕДЕЛЕНО
		|		ТОГДА %1
		|		ИНАЧЕ НЕОПРЕДЕЛЕНО
		|	КОНЕЦ";
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"КорСтатьяРасходов", СтрШаблон(ШаблонЗаполненияКорПоля, "КорСтатьяРасходов"));
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"КорАналитикаРасходов", СтрШаблон(ШаблонЗаполненияКорПоля, "КорАналитикаРасходов"));
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"КорПодразделение", СтрШаблон(ШаблонЗаполненияКорПоля, "КорПодразделение"));
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"КорНаправлениеДеятельности", СтрШаблон(ШаблонЗаполненияКорПоля, "КорНаправлениеДеятельности"));
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"ХозяйственнаяОперация", "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"НастройкаХозяйственнойОперации", "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.РаспределениеРасходовНаСебестоимость)");
		// В расходном движении по сумме без НДС дополнительных условий (как в расходе) не требуюется.
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"СуммаБезНДС", "ПостатейныеПеременныеБезНДС + ПостатейныеПостоянныеБезНДС + ДопРасходыБезНДС");

	Иначе
		
		ИмяВременнойТаблицы = "втПрочиеРасходыДополнительныеРасходыПриходныеДвижения";
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"СлужебноеВидДвиженияПриход", "Истина");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"Организация", "КорОрганизация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"Подразделение", "КорПодразделение");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"НаправлениеДеятельности", "КорНаправлениеДеятельности");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"СтатьяРасходов", "КорСтатьяРасходов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"АналитикаРасходов", "КорАналитикаРасходов");
			
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации",
			"ВЫБОР КОГДА АналитикаУчетаНоменклатуры = НЕОПРЕДЕЛЕНО
			|	ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.РаспределениеРасходовНаСебестоимость)
			|	ИНАЧЕ НастройкаХозяйственнойОперации КОНЕЦ");
			
		// Условия по сумме без НДС в приходном движении должны совпадать с условиями в:
		// - см. СкорректироватьСтоимостьСписанияЗапасов и вызываемых методах.
		// - см. СкорректироватьСтоимостьВозвратовПрошлыхПериодов.
		// - см. РегистрыНакопления.ПрочиеРасходы.ТекстЗапросаТаблицаВтПрочиеРасходы.
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС", "
		|ВЫБОР
		|	КОГДА КорСтатьяРасходов.ВариантРаспределенияРасходовУпр В (
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы),
		|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПрочиеАктивы)) ТОГДА
		|		0
		|	ИНАЧЕ
		|		ПостатейныеПеременныеБезНДС + ПостатейныеПостоянныеБезНДС + ДопРасходыБезНДС
		|КОНЕЦ");
		
		УсловиеГде =
			"ТИПЗНАЧЕНИЯ(КорСтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
			|	И НЕ КорСтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)";
		
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Сумма", "ПостатейныеПеременныеСНДС + ПостатейныеПостоянныеСНДС + ДопРасходы");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "
	|ВЫБОР
	|	КОГДА НЕ &УправленческийУчетОрганизаций ТОГДА
	|		0
	|	ИНАЧЕ
	|		ПостатейныеПеременныеУпр + ПостатейныеПостоянныеУпр + ДопРасходыУпр
	|КОНЕЦ");
	
	СтруктураПараметров.Вставить("УправленческийУчетОрганизаций", ПараметрыРасчета.УправленческийУчетОрганизаций);
	СтруктураПараметров.Вставить("ИспользоватьУчетПрочихДоходовРасходовРегл", ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл);
	
	// СуммаРегл
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", "
	|ВЫБОР
	|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл ТОГДА
	|		0
	|	ИНАЧЕ
	|		ПостатейныеПеременныеРегл + ПостатейныеПостоянныеРегл + ДопРасходыРегл
	|КОНЕЦ");
	
	// ПостояннаяРазница
	Если РасходныеДвижения Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "
		|ВЫБОР
		|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл ТОГДА
		|		0
		|	ИНАЧЕ
		|		ПостояннаяРазница
		|КОНЕЦ");
	Иначе 
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "
		|ВЫБОР
		|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл ТОГДА
		|		0
		|	КОГДА НЕ КорСтатьяРасходов.ПринятиеКНалоговомуУчету ТОГДА
		|		ПостояннаяРазница + ПостатейныеПеременныеРегл + ПостатейныеПостоянныеРегл + ДопРасходыРегл
		|	ИНАЧЕ
		|		ПостояннаяРазница
		|КОНЕЦ");
	КонецЕсли;
	
	// ВременнаяРазница
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", "
	|ВЫБОР
	|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл ТОГДА
	|		0
	|	ИНАЧЕ
	|		ВременнаяРазница
	|КОНЕЦ");
	
	// НДД
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаНДД", "
	|ВЫБОР
	|	КОГДА НЕ &ИспользоватьУчетПрочихДоходовРасходовРегл ТОГДА
	|		0
	|	ИНАЧЕ
	|		СтоимостьНДД
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГде, СтруктураПараметров);
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияПрочиеАктивыПассивыДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, РасходныеДвижения = Истина)

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя;
	
	КопируемыеПоля = "
	|Период, Регистратор";

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СтруктураПараметров = Новый Структура();
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
	ИмяВременнойТаблицы = "втПрочиеАктивыПассивы";
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Организация", "КорОрганизация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Подразделение", "КорПодразделение");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"НаправлениеДеятельности", "КорНаправлениеДеятельности");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Статья", "КорСтатьяАктивовПассивов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Аналитика", "КорАналитикаАктивовПассивов");
	
	УсловиеГде =
		"ТИПЗНАЧЕНИЯ(КорСтатьяАктивовПассивов) = ТИП(ПланВидовХарактеристик.СтатьиАктивовПассивов)
		|	И НЕ КорСтатьяАктивовПассивов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Сумма", "ПостатейныеПеременныеСНДС + ПостатейныеПостоянныеСНДС + ДопРасходы");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГде, СтруктураПараметров);
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияПоПрочимАктивамПассивамДопРасходыЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений)
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор,
	// Измерения
	|	Т.КорОрганизация КАК Организация,
	|	Т.КорПодразделение КАК Подразделение,
	|	Т.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.КорСтатьяАктивовПассивов КАК Статья,
	|	Т.КорАналитикаАктивовПассивов КАК Аналитика,
	//++ НЕ УТ
	|	Т.КорНастройкаСчетовУчета КАК НастройкаСчетовУчета,
	//-- НЕ УТ
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Дебет) КАК ДебетКредит,
	// Ресурсы
	|	Т.ДопРасходы + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС КАК СуммаСНДС,
	|	Т.ДопРасходыБезНДС + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС КАК СуммаБезНДС,
	|	Т.СтоимостьРегл + Т.ДопРасходыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл КАК СуммаРегл,
	|	Т.СтоимостьУпр + Т.ДопРасходыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр КАК СуммаУпр,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	// Реквизиты
	|	Т.Регистратор КАК ДокументДвижения,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ ВтТаблицаДвиженияПоПрочимАктивамПассивам
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.КорСтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И Т.КорСтатьяАктивовПассивов ССЫЛКА ПланВидовХарактеристик.СтатьиАктивовПассивов
	|
	// Передача в филиал (на стороне отправителя)
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор КАК Регистратор,
	// Измерения
	|	Т.Организация,
	|	ВЫБОР
	|		КОГДА НЕ Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение ЕСТЬ NULL
	|		ТОГДА Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение
	|		ИНАЧЕ Т.АналитикаУчетаНоменклатуры.Подразделение
	|	КОНЕЦ КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.РасчетыСФилиалами) КАК Статья,
	|	Т.КорОрганизация КАК Аналитика,
	//++ НЕ УТ
	|	ЗНАЧЕНИЕ(Справочник.НастройкиСчетовУчетаПрочихОпераций.ПустаяСсылка) КАК НастройкаСчетовУчета,
	//-- НЕ УТ
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Дебет) КАК ДебетКредит,
	// Ресурсы
	|	Т.ДопРасходы + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС КАК СуммаСНДС,
	|	Т.ДопРасходыБезНДС + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС КАК СуммаБезНДС,
	|	Т.ДопРасходыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл КАК СуммаРегл,
	|	Т.ДопРасходыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр КАК СуммаУпр,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	// Реквизиты
	|	Т.ДокументДвижения,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПеремещениеТоваровМеждуФилиалами) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.ПередачаМеждуОрганизациями
	|
	// Передача в филиал (на стороне получателя)
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор КАК Регистратор,
	// Измерения
	|	Т.КорОрганизация КАК Организация,
	|	ВЫБОР
	|		КОГДА НЕ Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение ЕСТЬ NULL
	|		ТОГДА Т.АналитикаУчетаНоменклатуры.СкладскаяТерритория.Подразделение
	|		ИНАЧЕ Т.АналитикаУчетаНоменклатуры.Подразделение
	|	КОНЕЦ КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.РасчетыСФилиалами) КАК Статья,
	|	Т.Организация КАК Аналитика,
	//++ НЕ УТ
	|	ЗНАЧЕНИЕ(Справочник.НастройкиСчетовУчетаПрочихОпераций.ПустаяСсылка) КАК НастройкаСчетовУчета,
	//-- НЕ УТ
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Кредит) КАК ДебетКредит,
	// Ресурсы
	|	Т.ДопРасходы + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС КАК СуммаСНДС,
	|	Т.ДопРасходыБезНДС + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС КАК СуммаБезНДС,
	|	Т.ДопРасходыРегл + Т.ПостатейныеПостоянныеРегл + Т.ПостатейныеПеременныеРегл КАК СуммаРегл,
	|	Т.ДопРасходыУпр + Т.ПостатейныеПостоянныеУпр + Т.ПостатейныеПеременныеУпр КАК СуммаУпр,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	// Реквизиты
	|	Т.ДокументДвижения,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПеремещениеТоваровМеждуФилиалами) КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|ГДЕ
	|	Т.ПередачаМеждуОрганизациями
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ДвиженияПоПрочимАктивамПассивам.Имя);
	ОписаниеВТ.ИмяВТИсточника = "ВтТаблицаДвиженияПоПрочимАктивамПассивам";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
КонецПроцедуры

Процедура СформироватьДвиженияСебестоимостьТоваровДополнительныхРасходовЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений, РасходныеДвижения = Ложь)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	Если РасходныеДвижения Тогда
		ИмяВременнойТаблицы = "ВтСебестоимостьТоваров_ДополнительныеРасходыРасход";
		ИмяКорВременнойТаблицы = "ВтСебестоимостьТоваров_ДополнительныеРасходыКорРасход";
	Иначе
		ИмяВременнойТаблицы = "ВтСебестоимостьТоваров_ДополнительныеРасходыПриход";
		ИмяКорВременнойТаблицы = "ВтСебестоимостьТоваров_ДополнительныеРасходыКорПриход";
	КонецЕсли;
	
	// Кор. стоимость не включается в список полей.
	КопируемыеПоля = "
	|Период, Регистратор, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, Организация, ХозяйственнаяОперация,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи, Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета,
	|ВидДеятельностиНДС, ТипЗаписи, ДокументДвижения,
	|СтоимостьРегл, СтоимостьУпр,
	|ПостояннаяРазница, ВременнаяРазница, ДопРасходы, ДопРасходыБезНДС, ДопРасходыРегл, ДопРасходыУпр,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеРегл, ПостатейныеПеременныеУпр,
	|ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПостоянныеРегл, ПостатейныеПостоянныеУпр,
	|СтоимостьНДД";
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);

	ТаблицаОписанияКорПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияКорПолей, КопируемыеПоля);
	
	Если РасходныеДвижения Тогда
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ЛОЖЬ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", "КорОрганизация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходовСписания", "КорСтатьяРасходов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов", "КорАналитикаРасходов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Подразделение", "КорПодразделение");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяАктивовПассивов", "КорСтатьяАктивовПассивов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаАктивовПассивов", "КорАналитикаАктивовПассивов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаСчетовУчета", "КорНастройкаСчетовУчета");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорНаправлениеДеятельности", "КорНаправлениеДеятельности");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаПоПартнерам", "АналитикаУчетаПоПартнерам");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ЗаказКлиента", "ЗаказКлиента");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"ТипЗаписи", "ВЫБОР КОГДА ПередачаМеждуОрганизациями ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам) ИНАЧЕ ТипЗаписи КОНЕЦ");
		
		// ПеремещениеТоваровМеждуФилиалами, приход
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "Организация", "КорОрганизация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "СтатьяРасходовСписания", "НЕОПРЕДЕЛЕНО");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "АналитикаРасходов", "НЕОПРЕДЕЛЕНО");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "СтатьяАктивовПассивов", "ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.РасчетыСФилиалами)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "АналитикаАктивовПассивов", "Организация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "НастройкаСчетовУчета", "НЕОПРЕДЕЛЕНО");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "КорНаправлениеДеятельности", "НЕОПРЕДЕЛЕНО");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей,
			"ТипЗаписи", "ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей,
			"ХозяйственнаяОперация", "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей,
			"НастройкаХозяйственнойОперации", "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПеремещениеТоваровМеждуФилиалами)");
		
	Иначе
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Организация", "Организация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяРасходовСписания", "СтатьяРасходов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов", "АналитикаРасходов");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Подразделение", "Подразделение");
		// Поля АналитикаУчетаПоПартнерам и ЗаказКлиента в движении Приход заполняются только при методе оценки "Средняя за месяц".
		// Эти поля используются в функции ТекстРаспределениеДопРасходов() общего модуля РасчетСебестоимостиНДС
		// в запросе формирования временной таблицы ВТБазаРаспределенияДопРасходовБезПартий.  
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаПоПартнерам",
			"ВЫБОР КОГДА Организация В (&ОрганизацииСУчетомПоСредней) ТОГДА АналитикаУчетаПоПартнерам
			|	ИНАЧЕ ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка) КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ЗаказКлиента",
			"ВЫБОР КОГДА Организация В (&ОрганизацииСУчетомПоСредней) ТОГДА ЗаказКлиента
			|	ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"ТипЗаписи", "ВЫБОР КОГДА ПередачаМеждуОрганизациями ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам) ИНАЧЕ ТипЗаписи КОНЕЦ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"ХозяйственнаяОперация", "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
			"НастройкаХозяйственнойОперации", "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.РаспределениеРасходовНаСебестоимость)");
		
		// ПеремещениеТоваровМеждуФилиалами, расход
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "СлужебноеВидДвиженияПриход", "ЛОЖЬ");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "Организация", "Организация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "КорОрганизация", "КорОрганизация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "СтатьяРасходовСписания", "НЕОПРЕДЕЛЕНО");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "АналитикаРасходов", "НЕОПРЕДЕЛЕНО");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "СтатьяАктивовПассивов", "ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.РасчетыСФилиалами)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей, "АналитикаАктивовПассивов", "КорОрганизация");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей,
			"ТипЗаписи", "ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.РаспределениеПоВыбывшимТоварам)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей,
			"ХозяйственнаяОперация", "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами)");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияКорПолей,
			"НастройкаХозяйственнойОперации", "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ПеремещениеТоваровМеждуФилиалами)");
		
	КонецЕсли;
	
	УсловиеГДЕ = "НЕ АналитикаУчетаНоменклатуры = НЕОПРЕДЕЛЕНО
		// При методах оценки стоимости ФИФО и Средняя за месяц вид деятельности НДС заполнен, при Среднескользящей - пустой.
		|	И ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)";
	
	Если РасходныеДвижения Тогда
		// Заполнение полей для отбора см. в РасчетСебестоимостиПостатейныеЗатраты.ПоказателиБазыРаспределенияПриемниковПрошлыхПериодов()
		УсловиеГДЕ = УсловиеГДЕ + 
			" И (НЕ (КорСтатьяРасходов В (НЕОПРЕДЕЛЕНО, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка))
			|		И КорСтатьяАктивовПассивов В (НЕОПРЕДЕЛЕНО, ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка))))
			|	ИЛИ (НЕ АналитикаУчетаПоПартнерам ЕСТЬ NULL
			|		И ТИПЗНАЧЕНИЯ(АналитикаУчетаПоПартнерам) = ТИП(Справочник.КлючиАналитикиУчетаПоПартнерам)
			|		И АналитикаУчетаПоПартнерам <> ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка))";
	КонецЕсли;

	КорУсловиеГДЕ = "НЕ АналитикаУчетаНоменклатуры = НЕОПРЕДЕЛЕНО И ПередачаМеждуОрганизациями
		// При методах оценки стоимости ФИФО и Средняя за месяц вид деятельности НДС заполнен, при Среднескользящей - пустой.
		|	И ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияКорПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяКорВременнойТаблицы, КорУсловиеГДЕ);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяКорВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияНоменклатураДоходыДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)

	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя;
	
	КопируемыеПоля = "
	|Период, Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, ТипЗапасов,
	|ИсточникГФУНоменклатуры, ДопРасходы, ДопРасходыБезНДС, ДопРасходыУпр, ДопРасходыРегл,
	|ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПостоянныеУпр, ПостатейныеПостоянныеРегл,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеУпр, ПостатейныеПеременныеРегл,
	|ПостояннаяРазница, ВременнаяРазница";

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СтруктураПараметров = Новый Структура();
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
		
	ИмяВременнойТаблицы = "втДвиженияНоменклатураДоходыРасходы";
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Организация", "КорОрганизация");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Подразделение",
	"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(КорСтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	| И НЕ КорСтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	ТОГДА КорПодразделение
	|	ИНАЧЕ Подразделение КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"НаправлениеДеятельностиНоменклатуры", 
			"ЕСТЬNULL(АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
			|	ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Склад", "АналитикаУчетаНоменклатуры.МестоХранения");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтатьяДоходовРасходов",
	"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(КорСтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	| И НЕ КорСтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	ТОГДА КорСтатьяРасходов
	|	ИНАЧЕ СтатьяРасходов КОНЕЦ");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаРасходов",
	"ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(КорСтатьяРасходов) = ТИП(ПланВидовХарактеристик.СтатьиРасходов)
	| И НЕ КорСтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	ТОГДА КорАналитикаРасходов
	|	ИНАЧЕ АналитикаРасходов КОНЕЦ");
		
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"ДокументДвижения", "Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"ХозяйственнаяОперация", "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимость)");
		
	УсловиеГде =
		"ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.НачислениеНДСНалоговымАгентом)
		|И ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)
		|И ХозяйственнаяОперация <> НЕОПРЕДЕЛЕНО
		|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГде, СтруктураПараметров);
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияВыручкаИСебестоимостьДопРасходыЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)

	ИмяРегистра = Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя;
	
	КопируемыеПоля = "
	|Период, Регистратор, ХозяйственнаяОперация, АналитикаУчетаНоменклатуры, РазделУчета, ВидЗапасов, Партия,
	|АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС, АналитикаУчетаПоПартнерам, ЗаказКлиента,
	|Менеджер, Склад, Соглашение, Договор, ТипЗапасов, ИсточникГФУРасчетов, ИсточникГФУНоменклатуры,
	|НаправлениеДеятельностиКонтрагента,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи,
	|СтоимостьРегл, СтоимостьУпр,
	|ДопРасходы, ДопРасходыБезНДС, ДопРасходыУпр, ДопРасходыРегл,
	|ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПостоянныеУпр, ПостатейныеПостоянныеРегл,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеУпр, ПостатейныеПеременныеРегл,
	|ПостояннаяРазница, ВременнаяРазница";

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	СтруктураПараметров = Новый Структура();
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
		
	ИмяВременнойТаблицы = "втДвиженияВыручкаИСебестоимость";
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"Подразделение", "КорПодразделение");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"ДокументДвижения", "Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей,
		"НалогообложениеНДС", "ВидДеятельностиНДСВыбытия");
		
	УсловиеГде =
		"ТИПЗНАЧЕНИЯ(АналитикаУчетаПоПартнерам) = ТИП(Справочник.КлючиАналитикиУчетаПоПартнерам)
		|	И НЕ АналитикаУчетаПоПартнерам = ЗНАЧЕНИЕ(Справочник.КлючиАналитикиУчетаПоПартнерам.ПустаяСсылка)";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГде, СтруктураПараметров);
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

Процедура СформироватьДвиженияОтклоненияВСтоимостиТоваровДополнительныеРасходыЗапросом(ПараметрыРасчета, Запрос, СоответствиеВременныхТаблицДвижений)

	ИмяРегистра = Метаданные.РегистрыНакопления.ОтклоненияВСтоимостиТоваров.Имя;
	ИмяВременнойТаблицы = "втДвиженияОтклоненияВСтоимостиТоваров";
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Измерения
	|	Т.Организация КАК Организация,
	|	Т.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Т.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|		ТОГДА Т.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ФинУчет.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Т.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Т.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР КОГДА ФинУчет.ДетализироватьОтклоненияПоСкладам
	|		ТОГДА Т.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения,
	|	НАЧАЛОПЕРИОДА(Т.ПериодПоступления, Месяц) КАК ПериодОтклонения,
	// Ресурсы
	|	Т.ДопРасходы КАК ДопРасходыСНДС,
	|	Т.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	Т.ДопРасходыРегл КАК ДопРасходыРегл,
	|	Т.ДопРасходыУпр КАК ДопРасходыУпр,
	|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) И Т.ДопРасходы <> 0
	|		ТОГДА ВЫРАЗИТЬ(Т.ДопРасходыРегл - Т.ДопРасходыРегл * (Т.ДопРасходыБезНДС / Т.ДопРасходы) КАК ЧИСЛО(31,2))
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НДСРегл,
	|	ВЫБОР КОГДА Т.ВидДеятельностиНДС В (&ТипыНалогообложенияНДСУчитываетсяВСтоимости) И Т.ДопРасходы <> 0
	|		ТОГДА ВЫРАЗИТЬ(Т.ДопРасходыУпр - (Т.ДопРасходыУпр * (Т.ДопРасходыБезНДС / Т.ДопРасходы)) КАК ЧИСЛО(31,2))
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НДСУпр,
	|	Т.ПостояннаяРазница КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница КАК ВременнаяРазница,
	|	Т.СтоимостьНДД КАК НДД,
	// Реквизиты
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	Т.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ втДвиженияОтклоненияВСтоимостиТоваровПредварительная
	|ИЗ
	|	ДвиженияТаблицаКорректировки КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ФинУчет
	|		ПО Т.Организация = ФинУчет.Организация
	// При методе оценки стоимости Среднескользящая вид деятельности НДС пустой.
	|ГДЕ
	|	Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|;
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "втДвиженияОтклоненияВСтоимостиТоваровПредварительная");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "втДвиженияОтклоненияВСтоимостиТоваровПредварительная", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры


#Область Описание_СформироватьДвиженияПоОтклонениямВСтоимостиТоваров

// Процедура СформироватьДвиженияПоОтклонениямВСтоимостиТоваров() формирует движения по регистрам "Прочие доходы" и
// "Прочие расходы" на сумму отклонений в стоимости товаров, работ и услуг.
// 
// Отклонения в стоимости образуются при фактуровке поставок в этапе "ФактуровкаПоставок".
// Исходные данные по отклонениям в стоимости формируются в процедуре ЗаполнитьРасчетнуюПартиюФактуровкиПоставок() 
// #Область ОтклоненияВСтоимости.
// Отклонения в стоимости товаров могут иметь следующие типы записей:
// - ОтклонениеВСтоимостиНаПрочиеДоходы - если сумма фактуровки меньше суммы неотфактурованной поставки.
//		Такие отклонения отражаются в регистре "Прочие доходы".
// - ОтклонениеВСтоимостиНаПрочиеРасходы - если сумма фактуровки больше суммы неотфактурованной поставки.
//		Такие отклонения отражаются в регистре "Прочие расходы".
// Отклонения в фактуровке работ и услуг, списанных на расходы, всегда отражается в регистре "Прочие расходы".
//
// Для целей раздельного учета по видам деятельности НДС отклонения в стоимости учитываются в следующих процедурах:
// - для расходов, распределяемых на себестоимость товаров - в процедуре ТекстРаспределениеДопРасходов()
// - для расходов, распределяемых на себестоимость производства - в процедуре ТекстИнициализацияРаспределениеПартийНДСФИФОСкользящая()
//	временная таблица ВТПартииПрочихДляРаспределения2_4

#КонецОбласти

Процедура СформироватьДвиженияПоОтклонениямВСтоимостиТоваров(ПараметрыРасчета)
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СформироватьДвиженияПоОтклонениямВСтоимостиТоваров");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;

	#Область ОтклоненияВСтоимостиПрочиеДоходы
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.СтатьяДоходов,
	|	ДД.АналитикаДоходов,
	// Ресурсы
	|	-(ДД.Стоимость
	|		+ ДД.ДопРасходы
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеСНДС
	|		+ ДД.ПостатейныеПеременныеСНДС) КАК Сумма,
	|	-(ДД.СтоимостьРегл
	|		+ ДД.ДопРасходыРегл
	|		+ ДД.ТрудозатратыРегл
	|		+ ДД.ПостатейныеПостоянныеРегл
	|		+ ДД.ПостатейныеПеременныеРегл
	|		+ ДД.РезервПодОбесценениеРегл) КАК СуммаРегл,
	|	-(ДД.СтоимостьУпр
	|		+ ДД.ДопРасходыУпр
	|		+ ДД.ТрудозатратыУпр
	|		+ ДД.ПостатейныеПостоянныеУпр
	|		+ ДД.ПостатейныеПеременныеУпр
	|		+ ДД.РезервПодОбесценениеУпр) КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.ИдентификаторСтроки,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка,
	|		ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка)) КАК ДокументРасчета,
	|	&РежимЗакрытияМесяца КАК РежимЗакрытияМесяца
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеДоходы
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = ДД.Организация
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеДоходы)
	|	И ДД.СтатьяДоходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
	|	И ДД.РасчетПартий
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеДоходы.Имя, "ОтклоненияВСтоимости");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеДоходы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	#КонецОбласти
	
	#Область ОтклоненияВСтоимостиПрочиеРасходы
	
	Запрос.Текст = "
	// Формирование движений по прочим расходам должно соответствовать запросу формирования временной таблицы СуммыРасходов
	// в функции ТекстСуммыПрочихРасходов().
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.СтатьяРасходовСписания КАК СтатьяРасходов,
	|	ДД.АналитикаРасходов,
	// Ресурсы
	|	(ДД.Стоимость
	|		+ ДД.ДопРасходы
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеСНДС
	|		+ ДД.ПостатейныеПеременныеСНДС) КАК Сумма,
	|	(ДД.СтоимостьБезНДС
	|		+ ДД.ДопРасходыБезНДС
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеБезНДС
	|		+ ДД.ПостатейныеПеременныеБезНДС) КАК СуммаБезНДС,
	|	(ДД.СтоимостьРегл
	|		+ ДД.ДопРасходыРегл
	|		+ ДД.ТрудозатратыРегл
	|		+ ДД.ПостатейныеПостоянныеРегл
	|		+ ДД.ПостатейныеПеременныеРегл
	|		+ ДД.РезервПодОбесценениеРегл) КАК СуммаРегл,
	|	(ВЫБОР
	|		КОГДА НЕ ЕСТЬNULL(ВЫРАЗИТЬ(ДД.СтатьяРасходовСписания КАК ПланВидовХарактеристик.СтатьиРасходов).ПринятиеКНалоговомуУчету, ИСТИНА)
	|			ТОГДА ДД.СтоимостьРегл
	|				+ ДД.ДопРасходыРегл
	|				+ ДД.ТрудозатратыРегл
	|				+ ДД.ПостатейныеПостоянныеРегл
	|				+ ДД.ПостатейныеПеременныеРегл
	|				+ ДД.РезервПодОбесценениеРегл
	|		ИНАЧЕ ДД.ПостояннаяРазница КОНЕЦ) КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	ДД.СтоимостьНДД КАК СуммаНДД,
	|	(ДД.СтоимостьУпр
	|		+ ДД.ДопРасходыУпр
	|		+ ДД.ТрудозатратыУпр
	|		+ ДД.ПостатейныеПостоянныеУпр
	|		+ ДД.ПостатейныеПеременныеУпр
	|		+ ДД.РезервПодОбесценениеУпр) КАК СуммаУпр,
	// Реквизиты
	|	ДД.ХозяйственнаяОперация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ДокументДвижения,
	|	ДД.ИдентификаторСтроки,
	|	ДД.НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи,
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка,
	|		ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка)) КАК ДокументРасчета,
	|	&РежимЗакрытияМесяца КАК РежимЗакрытияМесяца
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеРасходы
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = ДД.Организация
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
	|	И ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И ДД.РасчетПартий
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя, "ОтклоненияВСтоимости");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеРасходы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	#КонецОбласти
	
	#Область ОтклоненияВСтоимостиНоменклатураДоходыРасходы

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.ХозяйственнаяОперация,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельностиНоменклатуры,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
	|	ДД.ВидЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельностиСтатьи,
	|	ДД.СтатьяДоходов КАК СтатьяДоходовРасходов,
	|	ДД.АналитикаДоходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	// Ресурсы
	|	-ДД.Стоимость КАК Стоимость,
	|	-ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	-ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	-ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	-ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	-ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	-ДД.ДопРасходы КАК ДопРасходы,
	|	-ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	-ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	-ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	-ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	-ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	-ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	-ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	-ДД.Трудозатраты КАК Трудозатраты,
	|	-ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	-ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	-ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	-ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	-ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	-ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	-ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	-ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	-ДД.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	-ДД.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	(ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА ДД.ВидЗапасов
	|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры.Номенклатура КОНЕЦ) КАК ИсточникГФУНоменклатуры
	|
	|ПОМЕСТИТЬ ВтДвиженияНоменклатураДоходыРасходы
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеДоходы)
	|	И ДД.СтатьяДоходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
	|	И ДД.РасчетПартий
	|	И НЕ ДД.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.ХозяйственнаяОперация,
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельностиНоменклатуры,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.АналитикаУчетаНоменклатуры.МестоХранения КАК Склад,
	|	ДД.ВидЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	ДД.ВидЗапасов,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельностиСтатьи,
	|	ДД.СтатьяРасходовСписания КАК СтатьяДоходовРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаДоходов,
	|	ДД.АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаАктивовПассивов,
	// Ресурсы
	|	ДД.Стоимость КАК Стоимость,
	|	ДД.СтоимостьБезНДС КАК СтоимостьБезНДС,
	|	ДД.СтоимостьУпр КАК СтоимостьУпр,
	|	ДД.СтоимостьРегл КАК СтоимостьРегл,
	|	ДД.СтоимостьЗабалансовая КАК СтоимостьЗабалансовая,
	|	ДД.СтоимостьЗабалансоваяРегл КАК СтоимостьЗабалансоваяРегл,
	|	ДД.ДопРасходы КАК ДопРасходы,
	|	ДД.ДопРасходыБезНДС КАК ДопРасходыБезНДС,
	|	ДД.ДопРасходыУпр КАК ДопРасходыУпр,
	|	ДД.ДопРасходыРегл КАК ДопРасходыРегл,
	|	ДД.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	ДД.ПостатейныеПостоянныеБезНДС КАК ПостатейныеПостоянныеБезНДС,
	|	ДД.ПостатейныеПостоянныеУпр КАК ПостатейныеПостоянныеУпр,
	|	ДД.ПостатейныеПостоянныеРегл КАК ПостатейныеПостоянныеРегл,
	|	ДД.Трудозатраты КАК Трудозатраты,
	|	ДД.ТрудозатратыУпр КАК ТрудозатратыУпр,
	|	ДД.ТрудозатратыРегл КАК ТрудозатратыРегл,
	|	ДД.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	ДД.ПостатейныеПеременныеБезНДС КАК ПостатейныеПеременныеБезНДС,
	|	ДД.ПостатейныеПеременныеУпр КАК ПостатейныеПеременныеУпр,
	|	ДД.ПостатейныеПеременныеРегл КАК ПостатейныеПеременныеРегл,
	|	ДД.ПостояннаяРазница КАК ПостояннаяРазница,
	|	ДД.ВременнаяРазница КАК ВременнаяРазница,
	|	ДД.РезервПодОбесценениеРегл КАК РезервПодОбесценениеРегл,
	|	ДД.РезервПодОбесценениеУпр КАК РезервПодОбесценениеУпр,
	// Реквизиты
	|	(ВЫБОР
	|		КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|			ТОГДА ДД.ВидЗапасов
	|		ИНАЧЕ ДД.АналитикаУчетаНоменклатуры.Номенклатура КОНЕЦ) КАК ИсточникГФУНоменклатуры
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
	|	И ДД.СтатьяРасходовСписания <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И ДД.РасчетПартий
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя, "ОтклоненияВСтоимости");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияНоменклатураДоходыРасходы";

	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	#КонецОбласти
	
	#Область ОтклоненияВСтоимостиПрочиеАктивыПассивы
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.СтатьяАктивовПассивов КАК Статья,
	|	ДД.АналитикаАктивовПассивов КАК Аналитика,
	// Ресурсы
	|	(ДД.Стоимость
	|		+ ДД.ДопРасходы
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеСНДС
	|		+ ДД.ПостатейныеПеременныеСНДС) КАК Сумма
	// Реквизиты
	|
	|ПОМЕСТИТЬ ВтДвиженияПрочиеАктивыПассивы
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
	|	И ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И ДД.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И ДД.РасчетПартий
	|	И НЕ ДД.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.СтатьяАктивовПассивов КАК Статья,
	|	ДД.АналитикаАктивовПассивов КАК Аналитика,
	// Ресурсы
	|	-(ДД.Стоимость
	|		+ ДД.ДопРасходы
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеСНДС
	|		+ ДД.ПостатейныеПеременныеСНДС) КАК Сумма
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеДоходы)
	|	И ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И ДД.СтатьяДоходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
	|	И ДД.РасчетПартий
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтАктивыПассивыОтклоненияВСтоимости";
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПрочиеАктивыПассивы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	#КонецОбласти
	
	#Область ОтклоненияВСтоимостиДвиженияПоПрочимАктивамПассивам
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.СтатьяАктивовПассивов КАК Статья,
	|	ДД.АналитикаАктивовПассивов КАК Аналитика,
	|	ДД.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Дебет) КАК ДебетКредит,
	// Ресурсы
	|	(ДД.Стоимость
	|		+ ДД.ДопРасходы
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеСНДС
	|		+ ДД.ПостатейныеПеременныеСНДС) КАК СуммаСНДС,
	|	(ДД.СтоимостьБезНДС
	|		+ ДД.ДопРасходыБезНДС
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеБезНДС
	|		+ ДД.ПостатейныеПеременныеБезНДС) КАК СуммаБезНДС,
	|	(ДД.СтоимостьРегл
	|		+ ДД.ДопРасходыРегл
	|		+ ДД.ТрудозатратыРегл
	|		+ ДД.ПостатейныеПостоянныеРегл
	|		+ ДД.ПостатейныеПеременныеРегл
	|		+ ДД.РезервПодОбесценениеРегл) КАК СуммаРегл,
	|	(ДД.СтоимостьУпр
	|		+ ДД.ДопРасходыУпр
	|		+ ДД.ТрудозатратыУпр
	|		+ ДД.ПостатейныеПостоянныеУпр
	|		+ ДД.ПостатейныеПеременныеУпр
	|		+ ДД.РезервПодОбесценениеУпр) КАК СуммаУпр,
	// Реквизиты
	|	ДД.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи
	|
	|ПОМЕСТИТЬ ВтДвиженияПоПрочимАктивамПассивам
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеРасходы)
	|	И ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И ДД.СтатьяРасходовСписания = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И ДД.РасчетПартий
	|	И НЕ ДД.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДД.Период КАК Период,
	|	ДД.Регистратор КАК Регистратор,
	// Измерения
	|	ДД.Организация,
	|	ДД.Подразделение,
	|	ДД.КорНаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ДД.СтатьяАктивовПассивов КАК Статья,
	|	ДД.АналитикаАктивовПассивов КАК Аналитика,
	|	ДД.НастройкаСчетовУчета КАК НастройкаСчетовУчета,
	|	ЗНАЧЕНИЕ(Перечисление.ВидыДвиженийПрочихАктивовПассивов.Кредит) КАК ДебетКредит,
	// Ресурсы
	|	-(ДД.Стоимость
	|		+ ДД.ДопРасходы
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеСНДС
	|		+ ДД.ПостатейныеПеременныеСНДС) КАК СуммаСНДС,
	|	-(ДД.СтоимостьБезНДС
	|		+ ДД.ДопРасходыБезНДС
	|		+ ДД.Трудозатраты
	|		+ ДД.ПостатейныеПостоянныеБезНДС
	|		+ ДД.ПостатейныеПеременныеБезНДС) КАК СуммаБезНДС,
	|	-(ДД.СтоимостьРегл
	|		+ ДД.ДопРасходыРегл
	|		+ ДД.ТрудозатратыРегл
	|		+ ДД.ПостатейныеПостоянныеРегл
	|		+ ДД.ПостатейныеПеременныеРегл
	|		+ ДД.РезервПодОбесценениеРегл) КАК СуммаРегл,
	|	-(ДД.СтоимостьУпр
	|		+ ДД.ДопРасходыУпр
	|		+ ДД.ТрудозатратыУпр
	|		+ ДД.ПостатейныеПостоянныеУпр
	|		+ ДД.ПостатейныеПеременныеУпр
	|		+ ДД.РезервПодОбесценениеУпр) КАК СуммаУпр,
	// Реквизиты
	|	ДД.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	ДД.ИдентификаторФинЗаписи КАК ИдентификаторФинЗаписи
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.ТипЗаписи = ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейпартий.ОтклонениеВСтоимостиНаПрочиеДоходы)
	|	И ДД.СтатьяАктивовПассивов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПустаяСсылка)
	|	И ДД.СтатьяДоходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ПустаяСсылка)
	|	И ДД.РасчетПартий
	|	И НЕ ДД.Сторно
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ДвиженияПоПрочимАктивамПассивам.Имя, "ОтклоненияВСтоимости");
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияПоПрочимАктивамПассивам";

	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);	
	
КонецПроцедуры

// Этап 3.17
Процедура СкорректироватьСтоимостьПродаж(ПараметрыРасчета) Экспорт

	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
#Область ВыборкаДанных
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьПродаж_ПодготовкаДанных");
	
	Если СтрНайти(СуществующиеВТ, "ИсправленныеДокументы") = 0 Тогда 
		// вт ИсправленныеДокументы
		Запрос.Текст = РасчетСебестоимостиЗаполнениеПартий.ТекстИсправленныеДокументы() + ";";
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	КонецЕсли;
	
	// 1. Инициализация структуры данных этапа подготовки данных.
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьПодготовкуДанныхДляСледующихЭтапов(
		ПараметрыРасчета,
		"ВтПродажи, ВтСебестоимость");
	
	// 2. Формирование временных таблиц.
	РасчетСебестоимостиПрикладныеАлгоритмы.ПодготовитьДанныеДляСледующихЭтапов(
		ПараметрыРасчета,
		ТекстСкорректироватьСтоимостьПродажПодготовкаДанных(ПараметрыРасчета));
	
	// 3. Завершаем этап подготовки данных. 
	РасчетСебестоимостиПрикладныеАлгоритмы.ЗавершитьПодготовкуДанныхДляСледующихЭтапов(ПараметрыРасчета);
	
#КонецОбласти
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СкорректироватьСтоимостьПродаж_ФормированиеДвижений");
	
#Область РаспределениеДанных
	
	// Инициализируем распределение
	ПоляСвязи = "Период, Регистратор, АналитикаУчетаНоменклатуры, ВидЗапасов, Организация, РазделУчета, Партия, АналитикаУчетаПартий,
		|АналитикаФинансовогоУчета, ВидДеятельностиНДС, ЗаказКлиента, АналитикаУчетаПоПартнерам, ИдентификаторФинЗаписи, Знак, Сторно";
	ПараметрыРаспределения = РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПараметрыРаспределенияМетодомУменьшаемогоОстатка(
		"ВтСебестоимость",
		"ВтПродажи",
		ПоляСвязи);
	
	ОписаниеРегистра = ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя]; // описание регистра
	
	РаспределяемыеРесурсы = РасчетСебестоимостиУниверсальныеАлгоритмы.УдалитьЭлементыИзСтрокиШаблона(
		ОписаниеРегистра.РесурсыРегистра,
		"%1Количество, %1СтоимостьНДД");
	
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьЧисловыеПоляРаспределенияМетодомУменьшаемогоОстатка(
		ПараметрыРаспределения,
		СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(РаспределяемыеРесурсы, ""));
		
	ПрочиеПоляБазы = "Партнер, Контрагент, Подразделение, ТипЗапасов, Менеджер, Склад, Соглашение, Договор, ХозяйственнаяОперация,
		|НалогообложениеНДС, ВалютаВзаиморасчетов, ВалютаДокумента, ИсточникГФУНоменклатуры, ИсточникГФУРасчетов,
		|АналитикаУчетаНаборов, НаправлениеДеятельностиКонтрагента, НаправлениеДеятельностиНоменклатуры,
		|НастройкаХозяйственнойОперации, ДокументРасчета, МетодОценкиСтоимостиТоваров,
		// Исходные расчетные суммы с прошлого расчета.
		|ИсходнаяСтоимость, ИсходнаяСтоимостьБезНДС, ИсходнаяДопРасходы, ИсходнаяДопРасходыБезНДС, ИсходнаяТрудозатраты,
		|ИсходнаяСтоимостьРегл, ИсходнаяДопРасходыРегл, ИсходнаяТрудозатратыРегл,
		|ИсходнаяПостатейныеПостоянныеСНДС, ИсходнаяПостатейныеПостоянныеБезНДС, ИсходнаяПостатейныеПостоянныеРегл,
		|ИсходнаяПостатейныеПеременныеСНДС, ИсходнаяПостатейныеПеременныеБезНДС, ИсходнаяПостатейныеПеременныеРегл,
		|ИсходнаяПостояннаяРазница, ИсходнаяВременнаяРазница,
		|ИсходнаяСтоимостьЗабалансовая, ИсходнаяСтоимостьЗабалансоваяРегл, ИсходнаяРезервПодОбесценениеРегл, ИсходнаяРезервПодОбесценениеУпр,
		|ИсходнаяСтоимостьУпр, ИсходнаяДопРасходыУпр, ИсходнаяТрудозатратыУпр, ИсходнаяПостатейныеПостоянныеУпр, ИсходнаяПостатейныеПеременныеУпр";
	
	РасчетСебестоимостиУниверсальныеАлгоритмы.ИнициализироватьПрочиеПоляРаспределенияМетодомУменьшаемогоОстатка(
		ПараметрыРаспределения,
		,
		ПрочиеПоляБазы);
		
	// Распределяем
	РасчетСебестоимостиУниверсальныеАлгоритмы.РаспределитьМетодомУменьшаемогоОстатка(Запрос.МенеджерВременныхТаблиц, ПараметрыРаспределения);
	
	// Скорректируем стоимости с учетом исходных расчетных движений.
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.КлючТИ,
	|	Т.КлючТБ,
	|	Т.Период,
	|	Т.Регистратор,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидЗапасов,
	|	Т.Организация,
	|	Т.РазделУчета,
	|	Т.Партия,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаФинансовогоУчета,
	|	Т.ВидДеятельностиНДС,
	|	Т.ЗаказКлиента,
	|	Т.АналитикаУчетаПоПартнерам,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.Знак,
	|	Т.Сторно,
	|	Т.Партнер,
	|	Т.Контрагент,
	|	Т.Подразделение,
	|	Т.ТипЗапасов,
	|	Т.Менеджер,
	|	Т.Склад,
	|	Т.Соглашение,
	|	Т.Договор,
	|	Т.ХозяйственнаяОперация,
	|	Т.НалогообложениеНДС,
	|	Т.ВалютаВзаиморасчетов,
	|	Т.ВалютаДокумента,
	|	Т.ИсточникГФУНоменклатуры,
	|	Т.ИсточникГФУРасчетов,
	|	Т.АналитикаУчетаНаборов,
	|	Т.НаправлениеДеятельностиКонтрагента,
	|	Т.НаправлениеДеятельностиНоменклатуры,
	|	Т.НастройкаХозяйственнойОперации,
	|	Т.ДокументРасчета,
	|	Т.МетодОценкиСтоимостиТоваров,
	|	Т.Количество,
	|	Т.Стоимость - Т.ИсходнаяСтоимость										КАК Стоимость,
	|	Т.СтоимостьБезНДС - Т.ИсходнаяСтоимостьБезНДС							КАК СтоимостьБезНДС,
	|	Т.СтоимостьЗабалансовая - Т.ИсходнаяСтоимостьЗабалансовая				КАК СтоимостьЗабалансовая,
	|	Т.ДопРасходы - Т.ИсходнаяДопРасходы										КАК ДопРасходы,
	|	Т.ДопРасходыБезНДС - Т.ИсходнаяДопРасходыБезНДС							КАК ДопРасходыБезНДС,
	|	Т.Трудозатраты - Т.ИсходнаяТрудозатраты									КАК Трудозатраты,
	|	Т.ПостатейныеПостоянныеСНДС - Т.ИсходнаяПостатейныеПостоянныеСНДС		КАК ПостатейныеПостоянныеСНДС,
	|	Т.ПостатейныеПеременныеСНДС - Т.ИсходнаяПостатейныеПеременныеСНДС		КАК ПостатейныеПеременныеСНДС,
	|	Т.ПостатейныеПостоянныеБезНДС - Т.ИсходнаяПостатейныеПостоянныеБезНДС	КАК ПостатейныеПостоянныеБезНДС,
	|	Т.ПостатейныеПеременныеБезНДС - Т.ИсходнаяПостатейныеПеременныеБезНДС	КАК ПостатейныеПеременныеБезНДС,
	|	Т.СтоимостьРегл - Т.ИсходнаяСтоимостьРегл								КАК СтоимостьРегл,
	|	Т.СтоимостьЗабалансоваяРегл - Т.ИсходнаяСтоимостьЗабалансоваяРегл		КАК СтоимостьЗабалансоваяРегл,
	|	Т.ДопРасходыРегл - Т.ИсходнаяДопРасходыРегл								КАК ДопРасходыРегл,
	|	Т.ТрудозатратыРегл - Т.ИсходнаяТрудозатратыРегл							КАК ТрудозатратыРегл,
	|	Т.ПостатейныеПостоянныеРегл - Т.ИсходнаяПостатейныеПостоянныеРегл		КАК ПостатейныеПостоянныеРегл,
	|	Т.ПостатейныеПеременныеРегл - Т.ИсходнаяПостатейныеПеременныеРегл		КАК ПостатейныеПеременныеРегл,
	|	Т.ПостояннаяРазница - Т.ИсходнаяПостояннаяРазница						КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница - Т.ИсходнаяВременнаяРазница							КАК ВременнаяРазница,
	|	Т.СтоимостьУпр - Т.ИсходнаяСтоимостьУпр									КАК СтоимостьУпр,
	|	Т.ДопРасходыУпр - Т.ИсходнаяДопРасходыУпр								КАК ДопРасходыУпр,
	|	Т.ТрудозатратыУпр - Т.ИсходнаяТрудозатратыУпр							КАК ТрудозатратыУпр,
	|	Т.ПостатейныеПостоянныеУпр - Т.ИсходнаяПостатейныеПостоянныеУпр			КАК ПостатейныеПостоянныеУпр,
	|	Т.ПостатейныеПеременныеУпр - Т.ИсходнаяПостатейныеПеременныеУпр			КАК ПостатейныеПеременныеУпр,
	|	Т.РезервПодОбесценениеРегл - Т.ИсходнаяРезервПодОбесценениеРегл			КАК РезервПодОбесценениеРегл,
	|	Т.РезервПодОбесценениеУпр - Т.ИсходнаяРезервПодОбесценениеУпр			КАК РезервПодОбесценениеУпр
	|ПОМЕСТИТЬ ВТРезультатРаспределенияОкончательная
	|ИЗ ВТРезультатРаспределения КАК Т
	|;";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
#КонецОбласти
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
#Область ВыручкаИСебестоимостьПродаж
	
	ИмяВременнойТаблицы = "ВтДвиженияВыручкаИСебестоимостьПродаж";
	ИмяРегистра = Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВТРезультатРаспределенияОкончательная");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Количество", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДокументДвижения", "Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", "ВременнаяРазница + РезервПодОбесценениеРегл");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеРегл", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РезервПодОбесценениеУпр", 0);
	
	ПоляРегистра = СтрРазделить(СтрЗаменить(ВРег(ОписаниеРегистра.РесурсыРегистра), "%1", ""), ", ", Ложь);
	Для каждого ОписаниеПоляРегистра Из ТаблицаОписанияПолей Цикл
		
		Если ПоляРегистра.Найти(ОписаниеПоляРегистра.Представление) = Неопределено Тогда
			Продолжить; // Это не поле ресурса - пропускаем
		КонецЕсли;
		
		Если ОписаниеПоляРегистра.Поле = "0" Тогда
			Продолжить; // Поле ресурса не заполняется из данного запроса - пропускаем
		КонецЕсли;
		
		ОписаниеПоляРегистра.Поле = "ВЫБОР
		|	КОГДА НастройкаХозяйственнойОперации = ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СторноРеализацииВозвратНаДругойСклад)
		|	ТОГДА -1 ИНАЧЕ 1 КОНЕЦ * (" + ОписаниеПоляРегистра.Поле + ")";
		
	КонецЦикла;
	
	УсловиеГДЕ = "МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
		|ИЛИ РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ВыпускПродукции)";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВТРезультатРаспределенияОкончательная", ИмяВременнойТаблицы, УсловиеГДЕ);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти

#Область ВыручкаИСебестоимостьПродаж_СписаниеРезервовПодОбесценениеЗапасов
	
	ИмяВременнойТаблицы = "ВтДвиженияВыручкаИСебестоимостьПродаж_СписаниеРезервов";
	ИмяРегистра = Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, "ВТРезультатРаспределенияОкончательная");
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Количество", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДокументДвижения", "Регистратор");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "РежимЗакрытияМесяца", "&РежимЗакрытияМесяца");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", 
		"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРезервовПодОбесценениеЗапасов)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации", 
		"ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеРезервовПодОбесценениеЗапасов)");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Стоимость", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДС", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходы", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыБезНДС", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьУпр", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьРегл", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьЗабалансовая", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьЗабалансоваяРегл", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыУпр", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДопРасходыРегл", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеСНДС", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеБезНДС", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеУпр", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПостоянныеРегл", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Трудозатраты", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТрудозатратыУпр", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ТрудозатратыРегл", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеСНДС", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеБезНДС", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеУпр", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостатейныеПеременныеРегл", 0);
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", 0);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, "ВТРезультатРаспределенияОкончательная", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
#КонецОбласти

#Область Закупки

	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Период,
	|	Т.Регистратор,
	// Измерения
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакупкаУДругойОрганизации) КАК ХозяйственнаяОперация,
	|	Т.Контрагент КАК Организация,
	|	Т.Подразделение,
	|	Т.Менеджер,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.Склад,
	|	Т.ТипЗапасов,
	|	Т.ВидЗапасов,
	|	Т.Партнер,
	|	Т.Организация КАК Контрагент,
	|	Т.Соглашение,
	|	Т.Договор,
	// Ресурсы
	|	Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС КАК Стоимость,
	|	Т.СтоимостьБезНДС + Т.ДопРасходыБезНДС + Т.Трудозатраты + Т.ПостатейныеПостоянныеБезНДС + Т.ПостатейныеПеременныеБезНДС КАК СтоимостьБезНДС,
	// Реквизиты
	|	Т.ВалютаДокумента,
	|	Т.ВалютаВзаиморасчетов,
	|	Т.Регистратор КАК ДокументДвижения,
	|	Т.ИсточникГФУНоменклатуры,
	|	Т.ИсточникГФУРасчетов,
	|	Т.Сторно
	|ПОМЕСТИТЬ ВтДвиженияТаблицаЗакупки
	|ИЗ
	|	ВТРезультатРаспределенияОкончательная КАК Т
	|ГДЕ
	|	Т.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию)
	|	И Т.МетодОценкиСтоимостиТоваров <> ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|";
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);

	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.Закупки.Имя);
	ОписаниеВТ.ИмяВТИсточника = "ВтДвиженияТаблицаЗакупки";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Уничтожим ненужные временные таблицы.
	СуществующиеВТ = РасчетСебестоимостиУниверсальныеАлгоритмы.СоединитьСтроки(СуществующиеВТ, "ИсправленныеДокументы");
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

Функция ТекстСкорректироватьСтоимостьПродажПодготовкаДанных(ПараметрыРасчета) Экспорт
	
	ТекстЗапроса = "";
	
	#Область ВтТаблицаКорректировки
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Продажи.Период                     КАК Период,
	|	Продажи.Регистратор                КАК Регистратор,
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка,
	|		ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка)) КАК ДокументРасчета,
	|	АналитикаПартнеров.Организация     КАК Организация,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Продажи.ЗаказКлиента               КАК ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
	|	АналитикаПартнеров.Партнер         КАК Партнер,
	|	АналитикаПартнеров.Контрагент      КАК Контрагент,
	|	Продажи.Подразделение              КАК Подразделение,
	|	Продажи.ТипЗапасов                 КАК ТипЗапасов,
	|	Продажи.ВидЗапасов                 КАК ВидЗапасов,
	|	Продажи.Менеджер                   КАК Менеджер,
	|	Продажи.Склад                      КАК Склад,
	|	Продажи.Соглашение                 КАК Соглашение,
	|	Продажи.Договор                    КАК Договор,
	|	Продажи.ХозяйственнаяОперация      КАК ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС         КАК НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов       КАК ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента            КАК ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры    КАК ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов        КАК ИсточникГФУРасчетов,
	|	Продажи.АналитикаУчетаНаборов      КАК АналитикаУчетаНаборов,
	|	Продажи.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	ВЫБОР КОГДА &ПартионныйУчетВерсии22 ТОГДА
	|		Продажи.РазделУчета
	|	КОГДА Продажи.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности) 
	|		И Продажи.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути)
	|	КОГДА Продажи.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности) 
	|		И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути)
	|	КОГДА Продажи.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	КОГДА Продажи.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
	|	КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|	КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Организация) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|	КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|	КОГДА Продажи.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	ИНАЧЕ
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|	КОНЕЦ КАК РазделУчета,
	|	Продажи.Партия 					   КАК Партия,
	|	Продажи.АналитикаУчетаПартий 	   КАК АналитикаУчетаПартий,
	|	(ВЫБОР
	|		КОГДА АналитикаПартнеров.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Продажи.АналитикаФинансовогоУчета КОНЕЦ) КАК АналитикаФинансовогоУчета,
	|	(ВЫБОР
	|		КОГДА &ПартионныйУчетВерсии22 И НЕ АналитикаПартнеров.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА Продажи.ВидДеятельностиНДС
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	КОНЕЦ) КАК ВидДеятельностиНДС,
	|	Продажи.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА &ПартионныйУчетВерсии22 ТОГДА Продажи.ИдентификаторФинЗаписи
	|		ИНАЧЕ """" КОНЕЦ) КАК ИдентификаторФинЗаписи,
	// Для организаций на среднескользящей признак Сторно не заполняется, т.к. движения формируются под служебным
	// документом "Регистратор расчета себестоимости" и это расчетные движения, а не сторно движения исправленного документа.
	|	(ВЫБОР
	|		КОГДА АналитикаПартнеров.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ Продажи.Сторно КОНЕЦ) КАК Сторно,
	|	ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров КАК МетодОценкиСтоимостиТоваров,
	|	(ВЫБОР
	|		КОГДА Продажи.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализации))
	|		 ИЛИ СУММА(Продажи.Количество) < 0
	|			ТОГДА -1
	|		ИНАЧЕ 1 КОНЕЦ) КАК Знак,
	|	Продажи.РасчетСебестоимости КАК РасчетСебестоимости,
	|	СУММА(Продажи.Количество)          КАК Количество,
	// Исходные расчетные стоимости.
	|	СУММА(Продажи.Стоимость)					КАК Стоимость,
	|	СУММА(Продажи.СтоимостьБезНДС)				КАК СтоимостьБезНДС,
	|	СУММА(Продажи.СтоимостьРегл)				КАК СтоимостьРегл,
	|	СУММА(Продажи.ДопРасходы)					КАК ДопРасходы,
	|	СУММА(Продажи.ДопРасходыБезНДС)				КАК ДопРасходыБезНДС,
	|	СУММА(Продажи.ДопРасходыРегл)				КАК ДопРасходыРегл,
	|	СУММА(Продажи.Трудозатраты)					КАК Трудозатраты,
	|	СУММА(Продажи.ТрудозатратыРегл)				КАК ТрудозатратыРегл,
	|	СУММА(Продажи.ПостатейныеПостоянныеСНДС)	КАК ПостатейныеПостоянныеСНДС,
	|	СУММА(Продажи.ПостатейныеПостоянныеБезНДС)	КАК ПостатейныеПостоянныеБезНДС,
	|	СУММА(Продажи.ПостатейныеПостоянныеРегл)	КАК ПостатейныеПостоянныеРегл,
	|	СУММА(Продажи.ПостатейныеПеременныеСНДС)	КАК ПостатейныеПеременныеСНДС,
	|	СУММА(Продажи.ПостатейныеПеременныеБезНДС)	КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(Продажи.ПостатейныеПеременныеРегл)	КАК ПостатейныеПеременныеРегл,
	|	СУММА(Продажи.ПостояннаяРазница)			КАК ПостояннаяРазница,
	|	СУММА(Продажи.ВременнаяРазница)				КАК ВременнаяРазница,
	|	СУММА(Продажи.СтоимостьЗабалансовая)		КАК СтоимостьЗабалансовая,
	|	СУММА(Продажи.СтоимостьЗабалансоваяРегл)	КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Продажи.РезервПодОбесценениеРегл)		КАК РезервПодОбесценениеРегл,
	|	СУММА(Продажи.РезервПодОбесценениеУпр)		КАК РезервПодОбесценениеУпр,
	|	СУММА(Продажи.СтоимостьУпр)					КАК СтоимостьУпр,
	|	СУММА(Продажи.ДопРасходыУпр)				КАК ДопРасходыУпр,
	|	СУММА(Продажи.ТрудозатратыУпр)				КАК ТрудозатратыУпр,
	|	СУММА(Продажи.ПостатейныеПостоянныеУпр)		КАК ПостатейныеПостоянныеУпр,
	|	СУММА(Продажи.ПостатейныеПеременныеУпр)		КАК ПостатейныеПеременныеУпр
	|ПОМЕСТИТЬ ВтТаблицаКорректировки
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК Продажи
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПартнеров
	|		ПО Продажи.АналитикаУчетаПоПартнерам = АналитикаПартнеров.КлючАналитики
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО АналитикаПартнеров.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|		ПО Аналитика.Ссылка = Продажи.АналитикаУчетаНоменклатуры
	|	ЛЕВОЕ СОЕДИНЕНИЕ РассчитанныеДокументы КАК РассчитанныеДокументы
	|		ПО РассчитанныеДокументы.Период = Продажи.Период
	|		И РассчитанныеДокументы.Регистратор = Продажи.Регистратор
	|		И &РежимЗакрытияМесяца = ЗНАЧЕНИЕ(Перечисление.РежимыЗакрытияМесяца.ПредварительноеЗакрытие)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = АналитикаПартнеров.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = Продажи.Регистратор
	|ГДЕ
	|	Продажи.ХозяйственнаяОперация В (&МассивОперацийРеализации)
	// При предварительном расчете исключаем документы, для которых сохранены ранее рассчитанные движения
	|	И РассчитанныеДокументы.Регистратор ЕСТЬ NULL
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеСебестоимостьТоваров
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаСторнируемогоДокумента ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|		И Продажи.Сторно)
	|	
	|СГРУППИРОВАТЬ ПО
	|	Продажи.Период,
	|	Продажи.Регистратор,
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка,
	|		ЗНАЧЕНИЕ(Документ.РегистраторРасчетаСебестоимости.ПустаяСсылка)), // ДокументРасчета
	|	Продажи.АналитикаУчетаНоменклатуры,
	|	Продажи.ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам,
	|	АналитикаПартнеров.Партнер,
	|	АналитикаПартнеров.Контрагент,
	|	Продажи.Подразделение,
	|	Продажи.ТипЗапасов,
	|	Продажи.ВидЗапасов,
	|	Продажи.Менеджер,
	|	Продажи.Склад,
	|	Продажи.Соглашение,
	|	Продажи.Договор,
	|	Продажи.ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов,
	|	Продажи.АналитикаУчетаНаборов,
	|	Продажи.НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры,
	|	АналитикаПартнеров.Организация,
	|	ВЫБОР КОГДА &ПартионныйУчетВерсии22 ТОГДА
	|		Продажи.РазделУчета
	|	КОГДА Продажи.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности) 
	|		И Продажи.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути)
	|	КОГДА Продажи.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности) 
	|		И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути)
	|	КОГДА Продажи.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссию)
	|	КОГДА Продажи.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
	|	КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Партнер) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|	КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Организация) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|	КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссию)
	|	КОГДА Продажи.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга) ТОГДА
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ПроизводственныеЗатраты)
	|	ИНАЧЕ
	|		ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.ТоварыНаСкладах)
	|	КОНЕЦ,
	|	Продажи.Партия,
	|	Продажи.АналитикаУчетаПартий,
	|	(ВЫБОР
	|		КОГДА АналитикаПартнеров.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА НЕОПРЕДЕЛЕНО
	|		ИНАЧЕ Продажи.АналитикаФинансовогоУчета КОНЕЦ), // АналитикаФинансовогоУчета
	|	(ВЫБОР
	|		КОГДА &ПартионныйУчетВерсии22 И НЕ АналитикаПартнеров.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА Продажи.ВидДеятельностиНДС
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка) КОНЕЦ), // ВидДеятельностиНДС
	|	(ВЫБОР
	|		КОГДА Продажи.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализации))
	|			ТОГДА -1
	|		ИНАЧЕ 1 КОНЕЦ), // Знак
	|	Продажи.НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА &ПартионныйУчетВерсии22 ТОГДА Продажи.ИдентификаторФинЗаписи
	|		ИНАЧЕ """" КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА АналитикаПартнеров.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ Продажи.Сторно КОНЕЦ),
	|	ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров,
	|	Продажи.РасчетСебестоимости
	|
	|ИМЕЮЩИЕ
	|	СУММА(Продажи.Количество) <> 0
	|;";
	#КонецОбласти
	
	#Область ВтРегистраторыПродаж
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТаблицаКорректировки.Период,
	|	ТаблицаКорректировки.Регистратор КАК Регистратор,
	|	ТаблицаКорректировки.ДокументРасчета
	|
	|ПОМЕСТИТЬ ВтРегистраторыПродаж
	|ИЗ
	|	ВтТаблицаКорректировки КАК ТаблицаКорректировки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТаблицаКорректировки.Период,
	|	РегистраторыРасчета.Ссылка КАК Регистратор,
	|	ТаблицаКорректировки.ДокументРасчета
	|ИЗ
	|	ВтТаблицаКорректировки КАК ТаблицаКорректировки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = ТаблицаКорректировки.Организация
	|ГДЕ
	|	ТаблицаКорректировки.Организация В (&ОрганизацииСреднескользящая)
	|;";
	#КонецОбласти
	
	#Область ВтПродажи
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Продажи.Период                     КАК Период,
	|	(ВЫБОР
	|		КОГДА Продажи.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА РегистраторыРасчета.Ссылка
	|		ИНАЧЕ Продажи.Регистратор КОНЕЦ) КАК Регистратор,
	|	Продажи.ДокументРасчета            КАК ДокументРасчета,
	|	Продажи.Организация                КАК Организация,
	|	Продажи.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Продажи.ЗаказКлиента               КАК ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам  КАК АналитикаУчетаПоПартнерам,
	|	Продажи.Партнер                    КАК Партнер,
	|	Продажи.Контрагент                 КАК Контрагент,
	|	Продажи.Подразделение              КАК Подразделение,
	|	Продажи.ТипЗапасов                 КАК ТипЗапасов,
	|	Продажи.ВидЗапасов                 КАК ВидЗапасов,
	|	Продажи.Менеджер                   КАК Менеджер,
	|	Продажи.Склад                      КАК Склад,
	|	Продажи.Соглашение                 КАК Соглашение,
	|	Продажи.Договор                    КАК Договор,
	|	Продажи.ХозяйственнаяОперация      КАК ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС         КАК НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов       КАК ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента            КАК ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры    КАК ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов        КАК ИсточникГФУРасчетов,
	|	Продажи.АналитикаУчетаНаборов      КАК АналитикаУчетаНаборов,
	|	Продажи.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельностиНоменклатуры,
	|	Продажи.РазделУчета				   КАК РазделУчета,
	|	Продажи.Партия 					   КАК Партия,
	|	Продажи.АналитикаУчетаПартий 	   КАК АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета  КАК АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС         КАК ВидДеятельностиНДС,
	|	Продажи.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|	Продажи.ИдентификаторФинЗаписи     КАК ИдентификаторФинЗаписи,
	|	Продажи.Сторно                     КАК Сторно,
	|	Продажи.МетодОценкиСтоимостиТоваров КАК МетодОценкиСтоимостиТоваров,
	|	Продажи.Знак                       КАК Знак,
	|	СУММА(Продажи.Количество)          КАК Количество,
	// Исходные расчетные стоимости.
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.Стоимость
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяСтоимость,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.СтоимостьБезНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяСтоимостьБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.СтоимостьРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяСтоимостьРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ДопРасходы
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяДопРасходы,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ДопРасходыБезНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяДопРасходыБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ДопРасходыРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяДопРасходыРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.Трудозатраты
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяТрудозатраты,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ТрудозатратыРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяТрудозатратыРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостатейныеПостоянныеСНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостатейныеПостоянныеБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостатейныеПостоянныеРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостатейныеПостоянныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостатейныеПеременныеСНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостатейныеПеременныеБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостатейныеПеременныеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостояннаяРазница,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ВременнаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяВременнаяРазница,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.СтоимостьЗабалансовая
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяСтоимостьЗабалансовая,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.СтоимостьЗабалансоваяРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяСтоимостьЗабалансоваяРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.РезервПодОбесценениеРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяРезервПодОбесценениеРегл,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.РезервПодОбесценениеУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяРезервПодОбесценениеУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.СтоимостьУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяСтоимостьУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ДопРасходыУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяДопРасходыУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ТрудозатратыУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяТрудозатратыУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостатейныеПостоянныеУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостатейныеПостоянныеУпр,
	|	СУММА(ВЫБОР
	|		КОГДА Продажи.РасчетСебестоимости
	|		 И Продажи.ТипЗапасов <> ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА Продажи.ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ) КАК ИсходнаяПостатейныеПеременныеУпр
	|ПОМЕСТИТЬ ВтПродажи
	|ИЗ
	|	ВтТаблицаКорректировки КАК Продажи
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = Продажи.Организация
	|СГРУППИРОВАТЬ ПО
	|	Продажи.Период,
	|	(ВЫБОР
	|		КОГДА Продажи.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА РегистраторыРасчета.Ссылка
	|		ИНАЧЕ Продажи.Регистратор КОНЕЦ),
	|	Продажи.ДокументРасчета,
	|	Продажи.Организация,
	|	Продажи.АналитикаУчетаНоменклатуры,
	|	Продажи.ЗаказКлиента,
	|	Продажи.АналитикаУчетаПоПартнерам,
	|	Продажи.Партнер,
	|	Продажи.Контрагент,
	|	Продажи.Подразделение,
	|	Продажи.ТипЗапасов,
	|	Продажи.ВидЗапасов,
	|	Продажи.Менеджер,
	|	Продажи.Склад,
	|	Продажи.Соглашение,
	|	Продажи.Договор,
	|	Продажи.ХозяйственнаяОперация,
	|	Продажи.НалогообложениеНДС,
	|	Продажи.ВалютаВзаиморасчетов,
	|	Продажи.ВалютаДокумента,
	|	Продажи.ИсточникГФУНоменклатуры,
	|	Продажи.ИсточникГФУРасчетов,
	|	Продажи.АналитикаУчетаНаборов,
	|	Продажи.НаправлениеДеятельностиКонтрагента,
	|	Продажи.НаправлениеДеятельностиНоменклатуры,
	|	Продажи.РазделУчета,
	|	Продажи.Партия,
	|	Продажи.АналитикаУчетаПартий,
	|	Продажи.АналитикаФинансовогоУчета,
	|	Продажи.ВидДеятельностиНДС,
	|	Продажи.НастройкаХозяйственнойОперации,
	|	Продажи.ИдентификаторФинЗаписи,
	|	Продажи.Сторно,
	|	Продажи.МетодОценкиСтоимостиТоваров,
	|	Продажи.Знак
	|;";
	#КонецОбласти
	
	#Область ВтСебестоимость
	ТекстЗапроса = ТекстЗапроса + "
	|ВЫБРАТЬ
	|	Себестоимость.Период,
	|	(ВЫБОР
	|		КОГДА Себестоимость.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА РегистраторыРасчета.Ссылка
	|		ИНАЧЕ Себестоимость.Регистратор КОНЕЦ) КАК Регистратор,
	|	ВЫБОР
	|		КОГДА Себестоимость.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализацииВозвратНаДругойСклад),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад))
	|		ТОГДА Себестоимость.КорАналитикаУчетаНоменклатуры
	|		ИНАЧЕ Себестоимость.АналитикаУчетаНоменклатуры
	|	КОНЕЦ КАК АналитикаУчетаНоменклатуры,
	|	Себестоимость.РазделУчета,
	|	Себестоимость.Партия,
	|	Себестоимость.АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС,
	// Условие для поля ВидЗапасов должно быть идентично с РасчетСебестоимостиЗаполнениеПартий.ТекстПартииДляВыручки
	|	(ВЫБОР
	|		КОГДА ЕСТЬNULL(Себестоимость.ВидЗапасов.ТипЗапасов, НЕОПРЕДЕЛЕНО) = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		ИНАЧЕ Себестоимость.ВидЗапасов КОНЕЦ) КАК ВидЗапасов,
	|	Себестоимость.Организация,
	|	Себестоимость.ЗаказКлиента,
	|	Себестоимость.АналитикаУчетаПоПартнерам,
	|	(ВЫБОР
	|		КОГДА &ПартионныйУчетВерсии22 ТОГДА Себестоимость.ИдентификаторФинЗаписи
	|		ИНАЧЕ """" КОНЕЦ) КАК ИдентификаторФинЗаписи,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализацииВозвратНаДругойСклад),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализации))
	|		ИЛИ СУММА(Себестоимость.Количество) < 0
	|			ТОГДА -1
	|		ИНАЧЕ 1 КОНЕЦ) КАК Знак,
	// Для организаций на среднескользящей признак Сторно не заполняется, т.к. движения формируются под служебным
	// документом "Регистратор расчета себестоимости" и это расчетные движения, а не сторно движения исправленного документа.
	|	(ВЫБОР
	|		КОГДА Себестоимость.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ Себестоимость.Сторно КОНЕЦ) КАК Сторно,
	|	СУММА(Себестоимость.Количество) КАК Количество,
	// Для полей стоимости учитываем признак "Расчет себестоимости", что бы исключить плановую стоимость, отраженную
	// при проведении документа.  
	|	СУММА(ВЫБОР КОГДА Себестоимость.РасчетСебестоимости ТОГДА Себестоимость.Стоимость ИНАЧЕ 0 КОНЕЦ) КАК Стоимость,
	|	СУММА(ВЫБОР КОГДА Себестоимость.РасчетСебестоимости ТОГДА Себестоимость.СтоимостьБезНДС ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьБезНДС,
	|	СУММА(Себестоимость.ДопРасходы) КАК ДопРасходы,
	|	СУММА(Себестоимость.ДопРасходыБезНДС) КАК ДопРасходыБезНДС,
	|	СУММА(ВЫБОР КОГДА Себестоимость.РасчетСебестоимости ТОГДА Себестоимость.СтоимостьРегл ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьРегл,
	|	СУММА(Себестоимость.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Себестоимость.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(ВЫБОР
	|		КОГДА Себестоимость.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
	|			ТОГДА 0
	|		ИНАЧЕ Себестоимость.СтоимостьЗабалансовая КОНЕЦ) КАК СтоимостьЗабалансовая,
	|	СУММА(Себестоимость.Трудозатраты) КАК Трудозатраты,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеСНДС) КАК ПостатейныеПостоянныеСНДС,
	|	СУММА(Себестоимость.ПостатейныеПеременныеСНДС) КАК ПостатейныеПеременныеСНДС,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеБезНДС) КАК ПостатейныеПостоянныеБезНДС,
	|	СУММА(Себестоимость.ПостатейныеПеременныеБезНДС) КАК ПостатейныеПеременныеБезНДС,
	|	СУММА(ВЫБОР
	|		КОГДА Себестоимость.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцу2_5)
	|			ТОГДА 0
	|		ИНАЧЕ Себестоимость.СтоимостьЗабалансоваяРегл КОНЕЦ) КАК СтоимостьЗабалансоваяРегл,
	|	СУММА(Себестоимость.ДопРасходыРегл) КАК ДопРасходыРегл,
	|	СУММА(Себестоимость.ТрудозатратыРегл) КАК ТрудозатратыРегл,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеРегл) КАК ПостатейныеПостоянныеРегл,
	|	СУММА(Себестоимость.ПостатейныеПеременныеРегл) КАК ПостатейныеПеременныеРегл,
	|	СУММА(Себестоимость.РезервПодОбесценениеРегл) КАК РезервПодОбесценениеРегл,
	|	СУММА(Себестоимость.РезервПодОбесценениеУпр) КАК РезервПодОбесценениеУпр,
	|	СУММА(ВЫБОР КОГДА Себестоимость.РасчетСебестоимости ТОГДА Себестоимость.СтоимостьУпр ИНАЧЕ 0 КОНЕЦ) КАК СтоимостьУпр,
	|	СУММА(Себестоимость.ДопРасходыУпр) КАК ДопРасходыУпр,
	|	СУММА(Себестоимость.ТрудозатратыУпр) КАК ТрудозатратыУпр,
	|	СУММА(Себестоимость.ПостатейныеПостоянныеУпр) КАК ПостатейныеПостоянныеУпр,
	|	СУММА(Себестоимость.ПостатейныеПеременныеУпр) КАК ПостатейныеПеременныеУпр
	|ПОМЕСТИТЬ ВтСебестоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Себестоимость
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтРегистраторыПродаж КАК РегистраторыПродаж
	|		ПО РегистраторыПродаж.Период = Себестоимость.Период
	|		И РегистраторыПродаж.Регистратор = Себестоимость.Регистратор
	|		И (РегистраторыПродаж.ДокументРасчета = Себестоимость.ДокументРасчета
	|			ИЛИ НЕ Себестоимость.РасчетСебестоимости) 
	|		И (НЕ Себестоимость.СлужебноеВидДвиженияПриход
	|			И Себестоимость.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы)
	|			И Себестоимость.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеТоваровПоТребованию)
	|				ИЛИ Себестоимость.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализацииВозвратНаДругойСклад)
	|				ИЛИ Себестоимость.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад))
	|		И Себестоимость.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОтклоненийНаСебестоимостьПродаж)
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = Себестоимость.Организация
	|
	|СГРУППИРОВАТЬ ПО
	|	Себестоимость.Период,
	|	(ВЫБОР
	|		КОГДА Себестоимость.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА РегистраторыРасчета.Ссылка
	|		ИНАЧЕ Себестоимость.Регистратор КОНЕЦ),
	|	ВЫБОР
	|		КОГДА Себестоимость.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализацииВозвратНаДругойСклад),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад))
	|		ТОГДА Себестоимость.КорАналитикаУчетаНоменклатуры
	|		ИНАЧЕ Себестоимость.АналитикаУчетаНоменклатуры
	|	КОНЕЦ,
	|	Себестоимость.РазделУчета,
	|	Себестоимость.Партия,
	|	Себестоимость.АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС,
	|	(ВЫБОР
	|		КОГДА ЕСТЬNULL(Себестоимость.ВидЗапасов.ТипЗапасов, НЕОПРЕДЕЛЕНО) = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца)
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыЗапасов.ПустаяСсылка)
	|		ИНАЧЕ Себестоимость.ВидЗапасов КОНЕЦ), // ВидЗапасов
	|	Себестоимость.Организация,
	|	Себестоимость.ЗаказКлиента,
	|	Себестоимость.АналитикаУчетаПоПартнерам,
	|	(ВЫБОР
	|		КОГДА &ПартионныйУчетВерсии22 ТОГДА Себестоимость.ИдентификаторФинЗаписи
	|		ИНАЧЕ """" КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА Себестоимость.Организация В (&ОрганизацииСреднескользящая)
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ Себестоимость.Сторно КОНЕЦ),
	|	Себестоимость.ХозяйственнаяОперация,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ХозяйственнаяОперация В (
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализацииВозвратНаДругойСклад),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад),
	|				ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СторноРеализации))
	|			ТОГДА -1
	|		ИНАЧЕ 1 КОНЕЦ) // Знак
	|;";
	#КонецОбласти
	
	Возврат СокрЛП(ТекстЗапроса);
	
КонецФункции

// Этап 3.18
//
// Параметры:
//	ПараметрыРасчета - Структура - параметры расчета себестоимости
//
Процедура СформироватьДвиженияРасходыНаПродажу(ПараметрыРасчета) Экспорт

	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СформироватьДвиженияРасходыНаПродажу");
	
	Если ПараметрыРасчета.РежимЗакрытияМесяца = Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие
	 И НЕ ПараметрыРасчета.РаспределениеПостатейныхРасходовНаПродажу Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка, ВтРаспределениеРасходовНаПродажи.Регистратор) КАК Регистратор,
	|	ВтРаспределениеРасходовНаПродажи.Организация,
	|	ВтРаспределениеРасходовНаПродажи.ПодразделениеРасходов КАК Подразделение,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельности,
	|	ВтРаспределениеРасходовНаПродажи.СтатьяРасходов,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаРасходов,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНоменклатуры,
	|	МИНИМУМ(ВтРаспределениеРасходовНаПродажи.Период) КАК Период,
	|	ВтРаспределениеРасходовНаПродажи.Сторно,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимостьПродаж) КАК ХозяйственнаяОперация,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.Сумма) КАК Сумма,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.СуммаУпр) КАК СуммаУпр,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.СуммаРегл) КАК СуммаРегл,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.ВременнаяРазница) КАК ВременнаяРазница
	|
	|ПОМЕСТИТЬ ВтРаспределениеРасходовНаПродажи_ПрочиеРасходы
	|ИЗ
	|	ВтРаспределениеРасходовНаПродажи КАК ВтРаспределениеРасходовНаПродажи
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО ВтРаспределениеРасходовНаПродажи.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|		ПО РегистраторыРасчета.Организация = ВтРаспределениеРасходовНаПродажи.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка, ВтРаспределениеРасходовНаПродажи.Регистратор),
	|	ВтРаспределениеРасходовНаПродажи.Организация,
	|	ВтРаспределениеРасходовНаПродажи.ПодразделениеРасходов,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельности,
	|	ВтРаспределениеРасходовНаПродажи.СтатьяРасходов,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаРасходов,
	|	ВтРаспределениеРасходовНаПродажи.Сторно,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНоменклатуры
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Период,
	|	СтатьяРасходов,
	|	АналитикаРасходов
	|;
	|
	|ВЫБРАТЬ
	|	МИНИМУМ(ВтРаспределениеРасходовНаПродажи.Период) КАК Период,
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка, ВтРаспределениеРасходовНаПродажи.Регистратор) КАК Регистратор,
	|	ВтРаспределениеРасходовНаПродажи.Организация,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.ЗаказКлиента,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаПоПартнерам,
	|	ВтРаспределениеРасходовНаПродажи.ПодразделениеВыручки КАК Подразделение,
	|	ВтРаспределениеРасходовНаПродажи.ТипЗапасов,
	|	ВтРаспределениеРасходовНаПродажи.ВидЗапасов,
	|	ВтРаспределениеРасходовНаПродажи.РазделУчета,
	|	ВтРаспределениеРасходовНаПродажи.Партия,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаПартий,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаФинансовогоУчета,
	|	ВтРаспределениеРасходовНаПродажи.ВидДеятельностиНДС,
	|	ВтРаспределениеРасходовНаПродажи.Менеджер,
	|	ВтРаспределениеРасходовНаПродажи.Склад,
	|	ВтРаспределениеРасходовНаПродажи.Соглашение,
	|	ВтРаспределениеРасходовНаПродажи.Договор,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНаборов,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельностиКонтрагента,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельностиНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.НалогообложениеНДС,
	|	ВтРаспределениеРасходовНаПродажи.ВалютаВзаиморасчетов,
	|	ВтРаспределениеРасходовНаПродажи.ВалютаДокумента,
	|	ВтРаспределениеРасходовНаПродажи.ИсточникГФУНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.Сторно,
	|	ВтРаспределениеРасходовНаПродажи.ПодразделениеРасходов,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельности,
	|	ВтРаспределениеРасходовНаПродажи.СтатьяРасходов,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаРасходов,
	|	ИСТИНА КАК РасчетСебестоимости,
	|	ЛОЖЬ КАК РасчетПартий,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.Сумма) КАК РасходыНаПродажуСНДС,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.СуммаБезНДС) КАК РасходыНаПродажуБезНДС,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.СуммаУпр) КАК РасходыНаПродажуУпр,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.СуммаРегл) КАК РасходыНаПродажуРегл,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(ВтРаспределениеРасходовНаПродажи.ВременнаяРазница) КАК ВременнаяРазница
	|
	|ПОМЕСТИТЬ ВтРаспределениеРасходовНаПродажи_ВыручкаИСебестоимостьПродаж
	|ИЗ
	|	ВтРаспределениеРасходовНаПродажи КАК ВтРаспределениеРасходовНаПродажи
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|	ПО ВтРаспределениеРасходовНаПродажи.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРегистраторыРасчетаСебестоимости КАК РегистраторыРасчета
	|	ПО РегистраторыРасчета.Организация = ВтРаспределениеРасходовНаПродажи.Организация
	|		И ВТУчетныеПолитикиФинУчета.МетодОценкиСтоимостиТоваров = ЗНАЧЕНИЕ(Перечисление.МетодыОценкиСтоимостиТоваров.Среднескользящая)
	|
	|СГРУППИРОВАТЬ ПО
	|	ЕСТЬNULL(РегистраторыРасчета.Ссылка, ВтРаспределениеРасходовНаПродажи.Регистратор),
	|	ВтРаспределениеРасходовНаПродажи.Организация,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.ЗаказКлиента,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаПоПартнерам,
	|	ВтРаспределениеРасходовНаПродажи.ПодразделениеВыручки,
	|	ВтРаспределениеРасходовНаПродажи.ТипЗапасов,
	|	ВтРаспределениеРасходовНаПродажи.ВидЗапасов,
	|	ВтРаспределениеРасходовНаПродажи.РазделУчета,
	|	ВтРаспределениеРасходовНаПродажи.Партия,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаПартий,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаФинансовогоУчета,
	|	ВтРаспределениеРасходовНаПродажи.ВидДеятельностиНДС,
	|	ВтРаспределениеРасходовНаПродажи.Менеджер,
	|	ВтРаспределениеРасходовНаПродажи.Склад,
	|	ВтРаспределениеРасходовНаПродажи.Соглашение,
	|	ВтРаспределениеРасходовНаПродажи.Договор,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНаборов,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельностиКонтрагента,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельностиНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.НалогообложениеНДС,
	|	ВтРаспределениеРасходовНаПродажи.ВалютаВзаиморасчетов,
	|	ВтРаспределениеРасходовНаПродажи.ВалютаДокумента,
	|	ВтРаспределениеРасходовНаПродажи.ИсточникГФУНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.Сторно,
	|	ВтРаспределениеРасходовНаПродажи.ПодразделениеРасходов,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельности,
	|	ВтРаспределениеРасходовНаПродажи.СтатьяРасходов,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаРасходов
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор,
	|	Период,
	|	СтатьяРасходов,
	|	АналитикаРасходов
	|;
	|	
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ВтРаспределениеРасходовНаПродажи.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ВтРегистраторыПрошлыхПериодов
	|ИЗ
	|	ВтРаспределениеРасходовНаПродажи КАК ВтРаспределениеРасходовНаПродажи
	|ГДЕ
	|	ВтРаспределениеРасходовНаПродажи.Период < &НачалоПериода;
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос);

	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(
		ПараметрыРасчета,
		ПараметрыРасчета.Движения[Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя],
		"ВтРаспределениеРасходовНаПродажи_ПрочиеРасходы");
	
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ВтРаспределениеРасходовНаПродажи.Организация,
	|	ВтРаспределениеРасходовНаПродажи.Подразделение,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельности,
	|	ВтРаспределениеРасходовНаПродажи.СтатьяРасходов,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаРасходов,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.Период,
	|	ВтРаспределениеРасходовНаПродажи.Регистратор КАК ДокументДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимостьПродаж) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.РаспределениеРасходовНаСебестоимостьПродаж) КАК НастройкаХозяйственнойОперации,
	|	ВтРаспределениеРасходовНаПродажи.ИдентификаторФинЗаписи,
	|	ВтРаспределениеРасходовНаПродажи.Сторно,
	|	ИСТИНА КАК РасчетСебестоимости,
	|	ВтРаспределениеРасходовНаПродажи.Сумма,
	|	ВтРаспределениеРасходовНаПродажи.СуммаБезНДС,
	|	ВтРаспределениеРасходовНаПродажи.СуммаУпр,
	|	ВтРаспределениеРасходовНаПродажи.СуммаРегл,
	|	ВтРаспределениеРасходовНаПродажи.ПостояннаяРазница,
	|	ВтРаспределениеРасходовНаПродажи.ВременнаяРазница
	|ИЗ
	|	ВтРаспределениеРасходовНаПродажи_ПрочиеРасходы КАК ВтРаспределениеРасходовНаПродажи
	|;
	|
	|ВЫБРАТЬ
	|	ВтРаспределениеРасходовНаПродажи.Период КАК Период,
	|	ВтРаспределениеРасходовНаПродажи.Регистратор КАК ДокументДвижения,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.ЗаказКлиента,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаПоПартнерам,
	|	ВтРаспределениеРасходовНаПродажи.Подразделение,
	|	ВтРаспределениеРасходовНаПродажи.ТипЗапасов,
	|	ВтРаспределениеРасходовНаПродажи.ВидЗапасов,
	|	ВтРаспределениеРасходовНаПродажи.РазделУчета,
	|	ВтРаспределениеРасходовНаПродажи.Партия,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаПартий,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаФинансовогоУчета,
	|	ВтРаспределениеРасходовНаПродажи.ВидДеятельностиНДС,
	|	ВтРаспределениеРасходовНаПродажи.Менеджер,
	|	ВтРаспределениеРасходовНаПродажи.Склад,
	|	ВтРаспределениеРасходовНаПродажи.Соглашение,
	|	ВтРаспределениеРасходовНаПродажи.Договор,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.РаспределениеРасходовНаСебестоимостьПродаж) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.РаспределениеРасходовНаСебестоимостьПродаж) КАК НастройкаХозяйственнойОперации,
	|	ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНаборов,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельностиКонтрагента,
	|	ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельностиНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.НалогообложениеНДС,
	|	ВтРаспределениеРасходовНаПродажи.ВалютаВзаиморасчетов,
	|	ВтРаспределениеРасходовНаПродажи.ВалютаДокумента,
	|	ВтРаспределениеРасходовНаПродажи.ИсточникГФУНоменклатуры,
	|	ВтРаспределениеРасходовНаПродажи.Сторно,
	|	ИСТИНА КАК РасчетСебестоимости,
	|	ЛОЖЬ КАК РасчетПартий,
	|	ВтРаспределениеРасходовНаПродажи.РасходыНаПродажуСНДС,
	|	ВтРаспределениеРасходовНаПродажи.РасходыНаПродажуБезНДС,
	|	ВтРаспределениеРасходовНаПродажи.РасходыНаПродажуУпр,
	|	ВтРаспределениеРасходовНаПродажи.РасходыНаПродажуРегл,
	|	ВтРаспределениеРасходовНаПродажи.ПостояннаяРазница,
	|	ВтРаспределениеРасходовНаПродажи.ВременнаяРазница,
	|	Идентификаторы.ИдентификаторФинЗаписи
	|ИЗ
	|	ВтРаспределениеРасходовНаПродажи_ВыручкаИСебестоимостьПродаж КАК ВтРаспределениеРасходовНаПродажи
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВтРаспределениеРасходовНаПродажи_ПрочиеРасходы КАК Идентификаторы
	|	ПО ВтРаспределениеРасходовНаПродажи.Регистратор = Идентификаторы.Регистратор
	|		И ВтРаспределениеРасходовНаПродажи.Период = Идентификаторы.Период
	|		И ВтРаспределениеРасходовНаПродажи.Организация = Идентификаторы.Организация
	|		И ВтРаспределениеРасходовНаПродажи.ПодразделениеРасходов = Идентификаторы.Подразделение
	|		И ВтРаспределениеРасходовНаПродажи.НаправлениеДеятельности = Идентификаторы.НаправлениеДеятельности
	|		И ВтРаспределениеРасходовНаПродажи.СтатьяРасходов = Идентификаторы.СтатьяРасходов
	|		И ВтРаспределениеРасходовНаПродажи.АналитикаРасходов = Идентификаторы.АналитикаРасходов
	|		И ВтРаспределениеРасходовНаПродажи.АналитикаУчетаНоменклатуры = Идентификаторы.АналитикаУчетаНоменклатуры
	|;
	|";
	
	Выборки = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос,
		Истина);
	
	ВыборкаПрочиеРасходы = Выборки[0];
	ВыборкаВыручка = Выборки[1];

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ОбщиеКолонкиИсточникаИПриемникаДанных(
		ПараметрыРасчета,
		ВыборкаПрочиеРасходы,
		ИмяРегистра);
	
	Пока ВыборкаПрочиеРасходы.Следующий() Цикл
		Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ВыборкаПрочиеРасходы, КопируемыеПоля);
		Запись.ВидДвижения = ВидДвиженияНакопления.Расход;
	КонецЦикла;
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя;
	
	КопируемыеПоля = РасчетСебестоимостиПрикладныеАлгоритмы.ОбщиеКолонкиИсточникаИПриемникаДанных(
		ПараметрыРасчета,
		ВыборкаВыручка,
		ИмяРегистра);
	
	Пока ВыборкаВыручка.Следующий() Цикл
		Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ВыборкаВыручка, КопируемыеПоля);
	КонецЦикла;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 3.19
Процедура СписатьОшибкиОкругленияРасчетаСебестоимости(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "СписатьОшибкиОкругленияРасчетаСебестоимости");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	// Списываем только те остатки, в которых все "суммовые" ресурсы имеют значения, укладывающиеся в пределы погрешности. 
	// Если хоть один "суммовой" ресурс превышает величину погрешности, то такой остаток ошибкой округления не считаем.
	// Для регистра ПрочиеРасходы подход отличается: для него проверка ведется остатка для каждого ресурса по-отдельности.
	// Если какой-то ресурс укладывается в пределы погрешности, то списываем только его.
	
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	//++ НЕ УТ
	Запрос.Текст = РасчетСебестоимостиПрикладныеАлгоритмы.ТекстЗапросаЗавершенныеПартии();
	Запрос.Выполнить();
	//-- НЕ УТ
	
	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
#Область СебестоимостьТоваров

	// Списание ошибок округления в регистре СебестоимостьТоваров
	// Также создадим пустую временную таблицу ВТОкруглениеПрочиеРасходы для УТ - там не будет ошибок округления в регистре ПрочиеРасходы.
	Запрос.Текст = "
	//++ НЕ УТ
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДД.Организация,
	|	ДД.АналитикаУчетаНоменклатуры,
	|	ДД.ВидЗапасов,
	|	ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство) КАК РазделУчета
	|ПОМЕСТИТЬ ЭтоВозвратныеОтходыНЗП
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК ДД
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|	И ДД.РазделУчета = ЗНАЧЕНИЕ(Перечисление.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство)
	|	И ДД.Количество < 0
	|	И ТИПЗНАЧЕНИЯ(ДД.Регистратор) В (
	|		ТИП(Документ.РаспределениеВозвратныхОтходов),
	|		ТИП(Документ.ПроизводствоБезЗаказа)
	//++ НЕ УТКА
	|		,ТИП(Документ.ЭтапПроизводства2_2)
	//-- НЕ УТКА
	|		)
	|	И ДД.Организация В (&МассивОрганизаций)
	|	И ДД.Активность
	|;
	|////////////////////////////////////////////////////////////////////////////////

	//-- НЕ УТ
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|
	|	Себестоимость.Организация 					КАК Организация,
	|	Себестоимость.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	Себестоимость.РазделУчета 					КАК РазделУчета,
	|	Себестоимость.ВидЗапасов 					КАК ВидЗапасов,
	|	Себестоимость.Партия                        КАК Партия,
	|	Себестоимость.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ВЫБОР
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Аналитика.Подразделение
	|		ИНАЧЕ Аналитика.СкладскаяТерритория.Подразделение
	|	КОНЕЦ 										КАК Подразделение,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости)	КАК СтатьяРасходовСписания,
	|	Аналитика.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	(ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА НЕОПРЕДЕЛЕНО // Для удобства расстановки тегов

	//++ НЕ УТ
	|		КОГДА НЕ ЭтоВозвратныеОтходыНЗП.Организация ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОшибокОкругленияВозвратныеОтходы)
	//-- НЕ УТ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОшибокОкругления) КОНЕЦ) КАК ХозяйственнаяОперация,
	|	(ВЫБОР
	|		КОГДА ЛОЖЬ ТОГДА НЕОПРЕДЕЛЕНО // Для удобства расстановки тегов

	//++ НЕ УТ
	|		КОГДА НЕ ЭтоВозвратныеОтходыНЗП.Организация ЕСТЬ NULL
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругленияВозвратныеОтходы)
	//-- НЕ УТ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КОНЕЦ) КАК НастройкаХозяйственнойОперации,
	|	Себестоимость.Стоимость 					КАК Стоимость,
	|	Себестоимость.СтоимостьБезНДС 				КАК СтоимостьБезНДС,
	|	Себестоимость.ДопРасходы 					КАК ДопРасходы,
	|	Себестоимость.ДопРасходыБезНДС 				КАК ДопРасходыБезНДС,
	|	Себестоимость.СтоимостьРегл 				КАК СтоимостьРегл,
	|	Себестоимость.ПостояннаяРазница 			КАК ПостояннаяРазница,
	|	Себестоимость.ВременнаяРазница 				КАК ВременнаяРазница,
	|	Себестоимость.СтоимостьНДД					КАК СтоимостьНДД,
	|	Себестоимость.СтоимостьЗабалансовая         КАК СтоимостьЗабалансовая,
	|	Себестоимость.Трудозатраты       		    КАК Трудозатраты,
	|	Себестоимость.ПостатейныеПостоянныеСНДС     КАК ПостатейныеПостоянныеСНДС,
	|	Себестоимость.ПостатейныеПостоянныеБезНДС   КАК ПостатейныеПостоянныеБезНДС,
	|	Себестоимость.ПостатейныеПеременныеСНДС     КАК ПостатейныеПеременныеСНДС,
	|	Себестоимость.ПостатейныеПеременныеБезНДС   КАК ПостатейныеПеременныеБезНДС,
	|	Себестоимость.СтоимостьЗабалансоваяРегл     КАК СтоимостьЗабалансоваяРегл,
	|	Себестоимость.ДопРасходыРегл                КАК ДопРасходыРегл,
	|	Себестоимость.ТрудозатратыРегл              КАК ТрудозатратыРегл,
	|	Себестоимость.ПостатейныеПостоянныеРегл     КАК ПостатейныеПостоянныеРегл,
	|	Себестоимость.ПостатейныеПеременныеРегл     КАК ПостатейныеПеременныеРегл,
	|	Себестоимость.СтоимостьУпр     				КАК СтоимостьУпр,
	|	Себестоимость.ДопРасходыУпр     			КАК ДопРасходыУпр,
	|	Себестоимость.ТрудозатратыУпр     			КАК ТрудозатратыУпр,
	|	Себестоимость.ПостатейныеПостоянныеУпр     	КАК ПостатейныеПостоянныеУпр,
	|	Себестоимость.ПостатейныеПеременныеУпр     	КАК ПостатейныеПеременныеУпр,
	|	Себестоимость.РезервПодОбесценениеРегл      КАК РезервПодОбесценениеРегл,
	|	Себестоимость.РезервПодОбесценениеУпр       КАК РезервПодОбесценениеУпр
	|
	|ПОМЕСТИТЬ ВТОкруглениеСебестоимостьТоваров
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК Себестоимость
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|			ПО Себестоимость.Организация = ДокументыРасчетаСебестоимости.Организация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|			ПО Аналитика.Ссылка = Себестоимость.АналитикаУчетаНоменклатуры
	//++ НЕ УТ
	|		ЛЕВОЕ СОЕДИНЕНИЕ ЭтоВозвратныеОтходыНЗП КАК ЭтоВозвратныеОтходыНЗП
	|		ПО ЭтоВозвратныеОтходыНЗП.Организация = Себестоимость.Организация
	|			И ЭтоВозвратныеОтходыНЗП.АналитикаУчетаНоменклатуры = Себестоимость.АналитикаУчетаНоменклатуры
	|			И ЭтоВозвратныеОтходыНЗП.ВидЗапасов = Себестоимость.ВидЗапасов
	|			И ЭтоВозвратныеОтходыНЗП.РазделУчета = Себестоимость.РазделУчета
	//-- НЕ УТ
	
	//При изменении условий, также изменить обратное условие в см. СписатьОстаткиМалоценныхМЦ в ВТОстаткиПредварительная.
	|ГДЕ
	|	Себестоимость.Количество = 0
	|	И (Себестоимость.Стоимость МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.СтоимостьБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ДопРасходы МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ДопРасходыБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.СтоимостьРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.СтоимостьУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	//++ НЕ УТ
	|		И Себестоимость.ПостояннаяРазница МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ВременнаяРазница МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	//-- НЕ УТ
	|		И Себестоимость.СтоимостьНДД МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.СтоимостьЗабалансовая МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.Трудозатраты МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПостоянныеСНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПостоянныеБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПеременныеСНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПеременныеБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.СтоимостьЗабалансоваяРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ДопРасходыРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ТрудозатратыРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ПостатейныеПостоянныеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.ПостатейныеПеременныеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Себестоимость.СтоимостьУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ДопРасходыУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ТрудозатратыУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПостоянныеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.ПостатейныеПеременныеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.РезервПодОбесценениеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Себестоимость.РезервПодОбесценениеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|	)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК ДокументДвижения,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|
	|	Себестоимость.Организация 					КАК Организация,
	|	Себестоимость.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	Себестоимость.РазделУчета 					КАК РазделУчета,
	|	Себестоимость.ВидЗапасов 					КАК ВидЗапасов,
	|	Себестоимость.Партия                        КАК Партия,
	|	Себестоимость.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|	Себестоимость.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|	Себестоимость.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|	ВЫБОР
	|		КОГДА Аналитика.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Аналитика.Подразделение
	|		ИНАЧЕ Аналитика.СкладскаяТерритория.Подразделение
	|	КОНЕЦ 										КАК Подразделение,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости)	КАК СтатьяРасходовСписания,
	|	Аналитика.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОшибокОкругления) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КАК НастройкаХозяйственнойОперации,
	|	(ВЫБОР
	|		КОГДА Себестоимость.Стоимость МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.Стоимость
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК Стоимость,
	|	(ВЫБОР
	|		КОГДА Себестоимость.СтоимостьБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.СтоимостьБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК СтоимостьБезНДС,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ДопРасходы МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ДопРасходы
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ДопРасходы,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ДопРасходыБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ДопРасходыБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ДопРасходыБезНДС,
	|	(ВЫБОР
	|		КОГДА Себестоимость.СтоимостьРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.СтоимостьРегл
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК СтоимостьРегл,
	|	0 КАК ПостояннаяРазница,
	|	0 КАК ВременнаяРазница,
	|	(ВЫБОР
	|		КОГДА Себестоимость.СтоимостьНДД МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.СтоимостьНДД
	|		ИНАЧЕ 0 КОНЕЦ)							КАК СтоимостьНДД,
	|	(ВЫБОР
	|		КОГДА Себестоимость.СтоимостьЗабалансовая МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.СтоимостьЗабалансовая
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК СтоимостьЗабалансовая,
	|	(ВЫБОР
	|		КОГДА Себестоимость.Трудозатраты МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.Трудозатраты
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК Трудозатраты,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ПостатейныеПостоянныеСНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ПостатейныеПостоянныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ПостатейныеПостоянныеСНДС,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ПостатейныеПостоянныеБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ПостатейныеПостоянныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ПостатейныеПостоянныеБезНДС,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ПостатейныеПеременныеСНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ПостатейныеПеременныеСНДС
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ПостатейныеПеременныеСНДС,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ПостатейныеПеременныеБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ПостатейныеПеременныеБезНДС
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ПостатейныеПеременныеБезНДС,
	|	(ВЫБОР
	|		КОГДА Себестоимость.СтоимостьЗабалансоваяРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.СтоимостьЗабалансоваяРегл
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК СтоимостьЗабалансоваяРегл,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ДопРасходыРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ДопРасходыРегл
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ДопРасходыРегл,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ТрудозатратыРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ТрудозатратыРегл
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ТрудозатратыРегл,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ПостатейныеПостоянныеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ПостатейныеПостоянныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ПостатейныеПостоянныеРегл,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ПостатейныеПеременныеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ПостатейныеПеременныеРегл
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ПостатейныеПеременныеРегл,
	|	(ВЫБОР
	|		КОГДА Себестоимость.СтоимостьУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.СтоимостьУпр
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК СтоимостьУпр,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ДопРасходыУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ДопРасходыУпр
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ДопРасходыУпр,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ТрудозатратыУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ТрудозатратыУпр
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ТрудозатратыУпр,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ПостатейныеПостоянныеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ПостатейныеПостоянныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ПостатейныеПостоянныеУпр,
	|	(ВЫБОР
	|		КОГДА Себестоимость.ПостатейныеПеременныеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.ПостатейныеПеременныеУпр
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК ПостатейныеПеременныеУпр,
	|	(ВЫБОР
	|		КОГДА Себестоимость.РезервПодОбесценениеРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.РезервПодОбесценениеРегл
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК РезервПодОбесценениеРегл,
	|	(ВЫБОР
	|		КОГДА Себестоимость.РезервПодОбесценениеУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И 0 ТОГДА Себестоимость.РезервПодОбесценениеУпр
	|		ИНАЧЕ 0 КОНЕЦ) 							КАК РезервПодОбесценениеУпр
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК Себестоимость
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|			ПО Себестоимость.Организация = ДокументыРасчетаСебестоимости.Организация
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Аналитика
	|			ПО Аналитика.Ссылка = Себестоимость.АналитикаУчетаНоменклатуры
	|
	|ГДЕ
	|	Себестоимость.Количество > 0
	|	И (
	|		(Себестоимость.Стоимость
	|		+ Себестоимость.ДопРасходы
	|		+ Себестоимость.Трудозатраты
	|		+ Себестоимость.ПостатейныеПостоянныеСНДС
	|		+ Себестоимость.ПостатейныеПеременныеСНДС) < 0
	|	ИЛИ (Себестоимость.СтоимостьБезНДС
	|		+ Себестоимость.ДопРасходыБезНДС
	|		+ Себестоимость.Трудозатраты
	|		+ Себестоимость.ПостатейныеПостоянныеБезНДС
	|		+ Себестоимость.ПостатейныеПеременныеБезНДС) < 0 
	|	ИЛИ (Себестоимость.СтоимостьРегл
	|		+ Себестоимость.ДопРасходыРегл
	|		+ Себестоимость.ТрудозатратыРегл
	|		+ Себестоимость.ПостатейныеПостоянныеРегл
	|		+ Себестоимость.ПостатейныеПеременныеРегл
	|		+ Себестоимость.РезервПодОбесценениеРегл) < 0
	|	ИЛИ (Себестоимость.СтоимостьУпр
	|		+ Себестоимость.ДопРасходыУпр
	|		+ Себестоимость.ТрудозатратыУпр
	|		+ Себестоимость.ПостатейныеПостоянныеУпр
	|		+ Себестоимость.ПостатейныеПеременныеУпр
	|		+ Себестоимость.РезервПодОбесценениеУпр) < 0
	|	ИЛИ Себестоимость.СтоимостьНДД < 0
	|	)
	//++ НЕ УТ
	|	И НЕ Себестоимость.Партия В (
	|			ВЫБРАТЬ
	|				ЗавершенныеПартии.Партия КАК Партия
	|			ИЗ
	|				ЗавершенныеПартии КАК ЗавершенныеПартии)
	//-- НЕ УТ
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО КАК Период,
	|	ЛОЖЬ		 КАК ВидДвижения,
	|	НЕОПРЕДЕЛЕНО КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КАК НастройкаХозяйственнойОперации,
	|	0 			 КАК Сумма,
	|	0 			 КАК СуммаБезНДС,
	|	0 			 КАК СуммаРегл,
	|	0 			 КАК СуммаУпр,
	|	0 			 КАК ПостояннаяРазница,
	|	0 			 КАК ВременнаяРазница,
	|	0 			 КАК СуммаНДД,
	|	""""         КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВТОкруглениеПрочиеРасходы
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО КАК Период,
	|	ЛОЖЬ         КАК ВидДвижения,
	|	НЕОПРЕДЕЛЕНО КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ПартияПроизводства,
	|	НЕОПРЕДЕЛЕНО КАК ЗаказНаПроизводство,
	|	НЕОПРЕДЕЛЕНО КАК КодСтрокиПродукция,
	|	НЕОПРЕДЕЛЕНО КАК Этап,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяКалькуляции,
	|	НЕОПРЕДЕЛЕНО КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО КАК АналитикаРасходов,
	|	НЕОПРЕДЕЛЕНО КАК ГруппаПродукции,
	|	НЕОПРЕДЕЛЕНО КАК ПравилоОтнесенияНаВыпуск,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КАК НастройкаХозяйственнойОперации,
	|	0            КАК Стоимость,
	|	0            КАК СтоимостьБезНДС,
	|	0            КАК СтоимостьРегл,
	|	0            КАК СтоимостьУпр,
	|	0            КАК ПостояннаяРазница,
	|	0            КАК ВременнаяРазница,
	|	0            КАК СтоимостьНДД,
	|	0            КАК ДоляСтоимости,
	|	""""         КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВТОкруглениеПрочиеРасходыНЗП
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	НЕОПРЕДЕЛЕНО КАК Регистратор,
	|	НЕОПРЕДЕЛЕНО КАК Период,
	|	ЛОЖЬ         КАК ВидДвижения,
	|	НЕОПРЕДЕЛЕНО КАК Организация,
	|	НЕОПРЕДЕЛЕНО КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО КАК ВидРезервов,
	|	НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО КАК ОбъектУчетаРезервов,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КАК НастройкаХозяйственнойОперации,
	|	0            КАК СуммаУпр,
	|	0            КАК СуммаРегл,
	|	0            КАК СуммаНУ,
	|	""""         КАК ИдентификаторФинЗаписи
	|ПОМЕСТИТЬ ВТОкруглениеРезервыПредстоящихРасходов
	|;
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя,, Истина);
	ОписаниеВТ.ИмяВТРезультата = "ВтПогрешностьСебестоимостьТоваров";
	ОписаниеВТ.ИмяВТИсточника = "ВТОкруглениеСебестоимостьТоваров";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

#КонецОбласти

#Область ОтклоненияВСтоимостиТоваров

	// Списание ошибок округления в регистре ОтклоненияВСтоимостиТоваров.
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Остатки.Организация КАК Организация,
	|	Остатки.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Остатки.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Остатки.ВидЗапасов КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоНаправлениямДеятельности
	|			ТОГДА ЕСТЬNULL(Остатки.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|				ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка))
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|	КОНЕЦ КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА НЕ ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоПодразделениям
	|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|		КОГДА Остатки.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА Остатки.АналитикаУчетаНоменклатуры.МестоХранения
	|		КОГДА Остатки.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Склад)
	|			ТОГДА ВЫРАЗИТЬ(Остатки.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.Склады).Подразделение
	|		КОГДА Остатки.АналитикаУчетаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.ДоговорКонтрагента)
	|			ТОГДА ВЫРАЗИТЬ(Остатки.АналитикаУчетаНоменклатуры.МестоХранения КАК Справочник.ДоговорыКонтрагентов).Подразделение
	|		ИНАЧЕ ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
	|	КОНЕЦ КАК Подразделение,
	|	ВЫБОР
	|		КОГДА ВТУчетныеПолитикиФинУчета.ДетализироватьОтклоненияПоСкладам
	|			ТОГДА Остатки.АналитикаУчетаНоменклатуры.МестоХранения
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК МестоХранения
	|
	|ПОМЕСТИТЬ ВТОстаткиДляОтклонений
	|ИЗ
	|	ВТКэшРасчетныеОстаткиСебестоимостьТоваров КАК Остатки
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТУчетныеПолитикиФинУчета КАК ВТУчетныеПолитикиФинУчета
	|		ПО Остатки.Организация = ВТУчетныеПолитикиФинУчета.Организация
	|ГДЕ
	|	Остатки.Количество <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Организация
	|;
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|
	|	Отклонения.Организация 						КАК Организация,
	|	Отклонения.Номенклатура						КАК Номенклатура,
	|	Отклонения.Характеристика					КАК Характеристика,
	|	Отклонения.ВидЗапасов 						КАК ВидЗапасов,
	|	Отклонения.НаправлениеДеятельности			КАК НаправлениеДеятельности,
	|	Отклонения.Подразделение					КАК Подразделение,
	|	Отклонения.МестоХранения					КАК МестоХранения,
	|	Отклонения.ПериодОтклонения					КАК ПериодОтклонения,
	|
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОшибокОкругления) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КАК НастройкаХозяйственнойОперации,
	|
	|	Отклонения.ОтклоненияВСтоимостиСНДС			КАК ОтклоненияВСтоимостиСНДС,
	|	Отклонения.ОтклоненияВСтоимостиБезНДС		КАК ОтклоненияВСтоимостиБезНДС,
	|	Отклонения.ОтклоненияВСтоимостиРегл			КАК ОтклоненияВСтоимостиРегл,
	|	Отклонения.ОтклоненияВСтоимостиУпр			КАК ОтклоненияВСтоимостиУпр,
	|	Отклонения.ДопРасходыСНДС					КАК ДопРасходыСНДС,
	|	Отклонения.ДопРасходыБезНДС					КАК ДопРасходыБезНДС,
	|	Отклонения.ДопРасходыРегл					КАК ДопРасходыРегл,
	|	Отклонения.ДопРасходыУпр					КАК ДопРасходыУпр,
	|	Отклонения.НДСРегл							КАК НДСРегл,
	|	Отклонения.НДСУпр							КАК НДСУпр,
	|	Отклонения.ПостояннаяРазница				КАК ПостояннаяРазница,
	|	Отклонения.ВременнаяРазница					КАК ВременнаяРазница,
	|	Отклонения.НДД КАК							НДД
	|
	|ПОМЕСТИТЬ ВТОкруглениеОтклоненияВСтоимостиТоваров
	|ИЗ
	|	ВТКэшРасчетныеОстаткиОтклоненияВСтоимостиТоваров КАК Отклонения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО Отклонения.Организация = ДокументыРасчетаСебестоимости.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиДляОтклонений КАК Остатки
	|		ПО Отклонения.Организация = Остатки.Организация
	|		И Отклонения.Номенклатура = Остатки.Номенклатура
	|		И Отклонения.Характеристика = Остатки.Характеристика
	|		И Отклонения.ВидЗапасов = Остатки.ВидЗапасов
	|		И Отклонения.НаправлениеДеятельности = Остатки.НаправлениеДеятельности
	|		И Отклонения.Подразделение = Остатки.Подразделение
	|		И Отклонения.МестоХранения = Остатки.МестоХранения
	|ГДЕ
	|	Остатки.Организация ЕСТЬ NULL
	|	И (Отклонения.ОтклоненияВСтоимостиСНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Отклонения.ОтклоненияВСтоимостиБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Отклонения.ОтклоненияВСтоимостиРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Отклонения.ОтклоненияВСтоимостиУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Отклонения.ДопРасходыСНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Отклонения.ДопРасходыБезНДС МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	|		И Отклонения.ДопРасходыРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Отклонения.ДопРасходыУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьУпр И &ЗначениеПогрешностиСебестоимостьУпр
	//++ НЕ УТ
	|		И Отклонения.ПостояннаяРазница МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Отклонения.ВременнаяРазница МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	//-- НЕ УТ
	|		И Отклонения.НДСРегл МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Отклонения.НДСУпр МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|		И Отклонения.НДД МЕЖДУ -&ЗначениеПогрешностиСебестоимостьРегл И &ЗначениеПогрешностиСебестоимостьРегл
	|	)
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ОтклоненияВСтоимостиТоваров.Имя;
	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	ИмяВременнойТаблицы = "ВтПогрешностьОтклоненияВСтоимостиТоваров";
	ИмяВременнойТаблицыИсточник = "ВТОкруглениеОтклоненияВСтоимостиТоваров";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(ПараметрыРасчета, ОписаниеПриемника, ИмяВременнойТаблицыИсточник);
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ИмяВременнойТаблицыИсточник);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ИмяРегистра, ИмяВременнойТаблицыИсточник, ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

#КонецОбласти

#Область ПрочиеРасходы

	// Списание ошибок округления в регистре ПрочиеРасходы
	ТекстЗапросаАналитикиДвиженийПрочихРасходов =
	"УНИЧТОЖИТЬ ВТОкруглениеПрочиеРасходы
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РеквизитыРаспределения.Организация 					КАК Организация,
	|	РеквизитыРаспределения.Подразделение 				КАК Подразделение,
	|	РеквизитыРаспределения.СтатьяРасходов 				КАК СтатьяРасходов,
	|	РеквизитыРаспределения.АналитикаРасходов 			КАК АналитикаРасходов,
	|	РеквизитыРаспределения.НаправлениеДеятельности 		КАК НаправлениеДеятельности,
	|	РеквизитыРаспределения.РегламентированныйУчет
	//++ НЕ УТ
	|		И НЕ РеквизитыРаспределения.ОставитьВНЗП
	//-- НЕ УТ
	|														КАК СписыватьОстатокРегл,
	|	РеквизитыРаспределения.НалоговыйУчет
	//++ НЕ УТ
	|		И НЕ РеквизитыРаспределения.ОставитьВНЗП
	//-- НЕ УТ
	|														КАК СписыватьОстатокНУ,
	|	РеквизитыРаспределения.УправленческийУчет
	//++ НЕ УТ
	|		И НЕ РеквизитыРаспределения.ОставитьВНЗП
	//-- НЕ УТ
	|														КАК СписыватьОстатокУпр,
	|	РеквизитыРаспределения.НДД
	//++ НЕ УТ
	|		И НЕ РеквизитыРаспределения.ОставитьВНЗП
	//-- НЕ УТ
	|														КАК СписыватьОстатокНДД
	|
	|ПОМЕСТИТЬ АналитикиДвиженийПрочихРасходовВрем
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК РеквизитыРаспределения
	|ГДЕ
	|	РеквизитыРаспределения.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И РеквизитыРаспределения.Проведен
	|	И РеквизитыРаспределения.СтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И РеквизитыРаспределения.НазначениеНастройкиРаспределения <> 
	|		ЗНАЧЕНИЕ(Перечисление.НазначениеПравилРаспределенияРасходов.РаспределениеРасходовНаФинансовыйРезультат)
	//++ НЕ УТ
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РеквизитыРаспределения.Организация 					КАК Организация,
	|	РеквизитыРаспределения.Подразделение 				КАК Подразделение,
	|	Остатки.СтатьяРасходов 								КАК СтатьяРасходов,
	|	РеквизитыРаспределения.АналитикаРасходов 			КАК АналитикаРасходов,
	|	Остатки.НаправлениеДеятельности 					КАК НаправлениеДеятельности,
	|	РеквизитыРаспределения.РегламентированныйУчет
	|		И НЕ РеквизитыРаспределения.ОставитьВНЗП		КАК СписыватьОстатокРегл,
	|	РеквизитыРаспределения.НалоговыйУчет
	|		И НЕ РеквизитыРаспределения.ОставитьВНЗП		КАК СписыватьОстатокНУ,
	|	РеквизитыРаспределения.УправленческийУчет
	|		И НЕ РеквизитыРаспределения.ОставитьВНЗП		КАК СписыватьОстатокУпр,
	|	РеквизитыРаспределения.НДД
	|		И НЕ РеквизитыРаспределения.ОставитьВНЗП		КАК СписыватьОстатокНДД
	|ИЗ
	|	Документ.РаспределениеПрочихЗатрат КАК РеквизитыРаспределения
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКэшРасчетныеОстаткиПрочиеРасходы КАК Остатки
	|		ПО	РеквизитыРаспределения.АналитикаРасходов = Остатки.АналитикаРасходов
	|		И	РеквизитыРаспределения.Подразделение = Остатки.Подразделение
	|		И	РеквизитыРаспределения.Организация = Остатки.Организация
	|ГДЕ
	|	РеквизитыРаспределения.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|	И РеквизитыРаспределения.Проведен
	|	И РеквизитыРаспределения.СтатьяРасходов = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|	И РеквизитыРаспределения.НазначениеНастройкиРаспределения <> 
	|		ЗНАЧЕНИЕ(Перечисление.НазначениеПравилРаспределенияРасходов.РаспределениеРасходовНаФинансовыйРезультат)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Обороты.Организация 				КАК Организация,
	|	Обороты.Подразделение 				КАК Подразделение,
	|	Обороты.СтатьяРасходов 				КАК СтатьяРасходов,
	|	Обороты.АналитикаРасходов 			КАК АналитикаРасходов,
	|	Обороты.НаправлениеДеятельности 	КАК НаправлениеДеятельности,
	|	ИСТИНА 								КАК СписыватьОстатокРегл,
	|	ИСТИНА 								КАК СписыватьОстатокНУ,
	|	ИСТИНА 								КАК СписыватьОстатокУпр,
	|	ЛОЖЬ 								КАК СписыватьОстатокНДД
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеРасходы КАК Обороты
	|ГДЕ
	|	Обороты.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Обороты.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовЗаСчетРезервов)
	//-- НЕ УТ
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Остатки.Организация 				КАК Организация,
	|	Остатки.Подразделение 				КАК Подразделение,
	|	Остатки.СтатьяРасходов 				КАК СтатьяРасходов,
	|	Остатки.АналитикаРасходов 			КАК АналитикаРасходов,
	|	Остатки.НаправлениеДеятельности 	КАК НаправлениеДеятельности,
	|	Остатки.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПродаж),
	|	Остатки.СтатьяРасходов.ВариантРаспределенияРасходовНУ = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПродаж),
	|	Остатки.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПродаж),
	// В НДД не может быть варианта распределения на себестоимость продаж
	|	ЛОЖЬ
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПрочиеРасходы КАК Остатки
	|ГДЕ
	|	Остатки.СтатьяРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПродаж)
	|	ИЛИ Остатки.СтатьяРасходов.ВариантРаспределенияРасходовНУ = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПродаж)
	|	ИЛИ Остатки.СтатьяРасходов.ВариантРаспределенияРасходовУпр = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПродаж)
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Аналитики.Организация 					КАК Организация,
	|	Аналитики.Подразделение 				КАК Подразделение,
	|	Аналитики.СтатьяРасходов 				КАК СтатьяРасходов,
	|	Аналитики.АналитикаРасходов 			КАК АналитикаРасходов,
	|	Аналитики.НаправлениеДеятельности 		КАК НаправлениеДеятельности,
	|	МАКСИМУМ(Аналитики.СписыватьОстатокРегл) КАК СписыватьОстатокРегл,
	|	МАКСИМУМ(Аналитики.СписыватьОстатокНУ)	КАК СписыватьОстатокНУ,
	|	МАКСИМУМ(Аналитики.СписыватьОстатокУпр)	КАК СписыватьОстатокУпр,
	|	МАКСИМУМ(Аналитики.СписыватьОстатокНДД)	КАК СписыватьОстатокНДД
	|ПОМЕСТИТЬ АналитикиДвиженийПрочихРасходов
	|ИЗ
	|	АналитикиДвиженийПрочихРасходовВрем КАК Аналитики
	|
	|СГРУППИРОВАТЬ ПО
	|	Аналитики.Организация,
	|	Аналитики.Подразделение,
	|	Аналитики.СтатьяРасходов,
	|	Аналитики.АналитикаРасходов,
	|	Аналитики.НаправлениеДеятельности
	|ИНДЕКСИРОВАТЬ ПО
	|	Аналитики.СтатьяРасходов,
	|	Аналитики.АналитикаРасходов,
	|	Аналитики.Подразделение,
	|	Аналитики.НаправлениеДеятельности,
	|	Аналитики.Организация
	|";
	
	
	// Добавим таблицу вариантов распределения статей расходов для учета НДД
	ТекстЗапросаНДД = РасчетСебестоимостиЛокализация.ТекстЗапросаНастроекНДД("АналитикиДвиженийПрочихРасходов", 
																	"РасчетСебестоимостиКорректировкаСтоимости_СписатьОшибкиОкругленияРасчетаСебестоимости",
																	ПараметрыРасчета);
	
	ТекстЗапросаВТОкруглениеПрочиеРасходы = "
	|ВЫБРАТЬ
	|	ПрочиеРасходы.Организация 					КАК Организация,
	|	ПрочиеРасходы.Подразделение 				КАК Подразделение,
	|	ПрочиеРасходы.СтатьяРасходов 				КАК СтатьяРасходов,
	|	ПрочиеРасходы.АналитикаРасходов 			КАК АналитикаРасходов,
	|	ПрочиеРасходы.НаправлениеДеятельности 		КАК НаправлениеДеятельности,
	|
	|	ВЫБОР
	|		КОГДА ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		 И ЕСТЬNULL(Аналитики.СписыватьОстатокУпр, ЛОЖЬ)
	|			ТОГДА ПрочиеРасходы.Сумма
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Сумма,
	|	ВЫБОР
	|		КОГДА ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		 И ЕСТЬNULL(Аналитики.СписыватьОстатокУпр, ЛОЖЬ)
	|			ТОГДА ПрочиеРасходы.СуммаБезНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаБезНДС,
	|	ВЫБОР 
	|		КОГДА ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		 И ЕСТЬNULL(Аналитики.СписыватьОстатокРегл, ЛОЖЬ)
	|			ТОГДА ПрочиеРасходы.СуммаРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаРегл,
	
	|	ВЫБОР
	|		КОГДА ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		 И ЕСТЬNULL(Аналитики.СписыватьОстатокУпр, ЛОЖЬ)
	|			ТОГДА ПрочиеРасходы.СуммаУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаУпр,
	//++ Локализация
	|	ВЫБОР
	|		КОГДА ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		 И ЕСТЬNULL(Аналитики.СписыватьОстатокРегл, ЛОЖЬ)
	|			ТОГДА ПрочиеРасходы.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ +
	//-- Локализация
	
	|	0 КАК ПостояннаяРазница,
	
	//++ Локализация
	|	ВЫБОР
	|		КОГДА ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		 И ЕСТЬNULL(Аналитики.СписыватьОстатокРегл, ЛОЖЬ)
	|			ТОГДА ПрочиеРасходы.СуммаРегл - ПрочиеРасходы.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ
	|	+ ВЫБОР
	|		КОГДА ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовНУ В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		 И ЕСТЬNULL(Аналитики.СписыватьОстатокНУ, ЛОЖЬ)
	|			ТОГДА ПрочиеРасходы.ПостояннаяРазница + ПрочиеРасходы.ВременнаяРазница - ПрочиеРасходы.СуммаРегл 
	|		ИНАЧЕ 0
	|	КОНЕЦ +
	//-- Локализация
	
	|	0 КАК ВременнаяРазница,
	|
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(НастройкиРаспределенияСтатейНДД.ВариантРаспределенияРасходовНДД, 
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.ПустаяСсылка)) В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		 И ЕСТЬNULL(Аналитики.СписыватьОстатокНДД, ЛОЖЬ)
	|			ТОГДА ПрочиеРасходы.СуммаНДД
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СуммаНДД
	|
	|ПОМЕСТИТЬ ВТОкруглениеПрочиеРасходыВрем
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПрочиеРасходы КАК ПрочиеРасходы
	|		ЛЕВОЕ СОЕДИНЕНИЕ АналитикиДвиженийПрочихРасходов КАК Аналитики
	|		ПО ПрочиеРасходы.Организация = Аналитики.Организация
	|			И ПрочиеРасходы.Подразделение = Аналитики.Подразделение
	|			И ПрочиеРасходы.СтатьяРасходов = Аналитики.СтатьяРасходов
	|			И ПрочиеРасходы.АналитикаРасходов = Аналитики.АналитикаРасходов
	|			И ПрочиеРасходы.НаправлениеДеятельности = Аналитики.НаправлениеДеятельности
	|		ЛЕВОЕ СОЕДИНЕНИЕ НастройкиРаспределенияСтатейНДД КАК НастройкиРаспределенияСтатейНДД
	|		ПО ПрочиеРасходы.СтатьяРасходов = НастройкиРаспределенияСтатейНДД.СтатьяРасходов
	|			И &ПрочиеРасходы_ОбъектРаздельногоУчетаНДД = НастройкиРаспределенияСтатейНДД.ОбъектРаздельногоУчетаНДД
	|			И ПрочиеРасходы.Организация = НастройкиРаспределенияСтатейНДД.Организация
	|ГДЕ
	|	ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовУпр
	|		В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		И ЕСТЬNULL(Аналитики.СписыватьОстатокУпр, ЛОЖЬ)
	|	ИЛИ ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовРегл
	|		В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		И ЕСТЬNULL(Аналитики.СписыватьОстатокРегл, ЛОЖЬ)
	|	ИЛИ ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовНУ
	|		В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		И ЕСТЬNULL(Аналитики.СписыватьОстатокНУ, ЛОЖЬ)
	|	ИЛИ ЕСТЬNULL(НастройкиРаспределенияСтатейНДД.ВариантРаспределенияРасходовНДД, ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.ПустаяСсылка))
	|		В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		И ЕСТЬNULL(Аналитики.СписыватьОстатокНДД, ЛОЖЬ)
	|
	//++ Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПрочиеРасходы.Организация 				КАК Организация,
	|	ПрочиеРасходы.Подразделение 			КАК Подразделение,
	|	ПрочиеРасходы.СтатьяРасходов 			КАК СтатьяРасходов,
	|	ПрочиеРасходы.АналитикаРасходов 		КАК АналитикаРасходов,
	|	ПрочиеРасходы.НаправлениеДеятельности 	КАК НаправлениеДеятельности,
	|	0										КАК Сумма,
	|	0										КАК СуммаБезНДС,
	|	0										КАК СуммаРегл,
	|	0										КАК СуммаУпр,
	|	0										КАК ПостояннаяРазница,
	|	ПрочиеРасходы.СуммаРегл 
	|		- ПрочиеРасходы.ПостояннаяРазница 
	|		- ПрочиеРасходы.ВременнаяРазница
	|											КАК ВременнаяРазница,
	|	0										КАК СуммаНДД
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеРасходы КАК ПрочиеРасходы
	|		ЛЕВОЕ СОЕДИНЕНИЕ АналитикиДвиженийПрочихРасходов КАК Аналитики
	|		ПО ПрочиеРасходы.Организация = Аналитики.Организация
	|			И ПрочиеРасходы.Подразделение = Аналитики.Подразделение
	|			И ПрочиеРасходы.СтатьяРасходов = Аналитики.СтатьяРасходов
	|			И ПрочиеРасходы.АналитикаРасходов = Аналитики.АналитикаРасходов
	|			И ПрочиеРасходы.НаправлениеДеятельности = Аналитики.НаправлениеДеятельности
	|ГДЕ
	|	НЕ ПрочиеРасходы.СлужебноеВидДвиженияПриход
	|	И ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовРегл
	|		В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|		И ЕСТЬNULL(Аналитики.СписыватьОстатокРегл, ЛОЖЬ)
	|	И НЕ ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовНУ
	|		В (&ВариантыРаспределенияДляСписанияОшибокОкругления)
	|	И ПрочиеРасходы.СуммаРегл - ПрочиеРасходы.ПостояннаяРазница - ПрочиеРасходы.ВременнаяРазница <> 0
	|	И (ПрочиеРасходы.РасчетСебестоимости ИЛИ ПрочиеРасходы.РасчетПартий)
	|	И ПрочиеРасходы.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеРасходовЗаСчетРезервов)
	//-- Локализация
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|
	|	ПрочиеРасходы.Организация 					КАК Организация,
	|	ПрочиеРасходы.Подразделение 				КАК Подразделение,
	|	ПрочиеРасходы.СтатьяРасходов 				КАК СтатьяРасходов,
	|	ПрочиеРасходы.АналитикаРасходов 			КАК АналитикаРасходов,
	|	ПрочиеРасходы.НаправлениеДеятельности 		КАК НаправлениеДеятельности,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОшибокОкругления) КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КАК НастройкаХозяйственнойОперации,
	|
	|	СУММА(ПрочиеРасходы.Сумма)					КАК Сумма,
	|	СУММА(ПрочиеРасходы.СуммаБезНДС)			КАК СуммаБезНДС,
	|	СУММА(ПрочиеРасходы.СуммаРегл)				КАК СуммаРегл,
	|	СУММА(ПрочиеРасходы.СуммаУпр)				КАК СуммаУпр,
	|	СУММА(ПрочиеРасходы.ПостояннаяРазница)		КАК ПостояннаяРазница,
	|	СУММА(ПрочиеРасходы.ВременнаяРазница)		КАК ВременнаяРазница,
	|	СУММА(ПрочиеРасходы.СуммаНДД)				КАК СуммаНДД
	|ПОМЕСТИТЬ ВТОкруглениеПрочиеРасходы
	|ИЗ
	|	ВТОкруглениеПрочиеРасходыВрем КАК ПрочиеРасходы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|			ПО ПрочиеРасходы.Организация = ДокументыРасчетаСебестоимости.Организация
	|СГРУППИРОВАТЬ ПО
	|	ДокументыРасчетаСебестоимости.Ссылка,
	|	ПрочиеРасходы.Организация,
	|	ПрочиеРасходы.Подразделение,
	|	ПрочиеРасходы.НаправлениеДеятельности,
	|	ПрочиеРасходы.СтатьяРасходов,
	|	ПрочиеРасходы.АналитикаРасходов
	|
	|ИМЕЮЩИЕ
	|	СУММА(ПрочиеРасходы.Сумма) МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
	|	И СУММА(ПрочиеРасходы.СуммаБезНДС) МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
	|	И СУММА(ПрочиеРасходы.СуммаУпр) МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
	|	И СУММА(ПрочиеРасходы.СуммаРегл) МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	//++ НЕ УТ
	|	И СУММА(ПрочиеРасходы.ПостояннаяРазница) МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|	И СУММА(ПрочиеРасходы.ВременнаяРазница) МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	//-- НЕ УТ
	|	И СУММА(ПрочиеРасходы.СуммаНДД) МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|";
	
	ТекстыЗапроса = Новый Массив;
	ТекстыЗапроса.Добавить(ТекстЗапросаАналитикиДвиженийПрочихРасходов);
	ТекстыЗапроса.Добавить(ТекстЗапросаНДД);
	ТекстыЗапроса.Добавить(ТекстЗапросаВТОкруглениеПрочиеРасходы);
	
	Запрос.Текст = СтрСоединить(ТекстыЗапроса, ОбщегоНазначенияУТ.РазделительЗапросовВПакете());
	
	РасчетСебестоимостиЛокализация.ПодставитьВЗапросеТипОбъектаРаздельногоУчетаНДД(Запрос.Текст, "ПрочиеРасходы_ОбъектРаздельногоУчетаНДД");
	
	ВариантыРаспределенияДляСписанияОшибокОкругления = Новый Массив();
	ВариантыРаспределенияДляСписанияОшибокОкругления.Добавить(Перечисления.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров);
	ВариантыРаспределенияДляСписанияОшибокОкругления.Добавить(Перечисления.ВариантыРаспределенияРасходов.НаСебестоимостьПродаж);
	//++ НЕ УТ
	ВариантыРаспределенияДляСписанияОшибокОкругления.Добавить(Перечисления.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты);
	ВариантыРаспределенияДляСписанияОшибокОкругления.Добавить(Перечисления.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства);
	ВариантыРаспределенияДляСписанияОшибокОкругления.Добавить(Перечисления.ВариантыРаспределенияРасходов.НаОбъектыВозникновенияЗатрат);
	//-- НЕ УТ
	
	Запрос.Параметры.Вставить("ВариантыРаспределенияДляСписанияОшибокОкругления", ВариантыРаспределенияДляСписанияОшибокОкругления);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, 
		"АналитикиДвиженийПрочихРасходовВрем, АналитикиДвиженийПрочихРасходов,
		|НастройкиРаспределенияСтатейНДД
		|");
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя,, Истина);
	ОписаниеВТ.ИмяВТРезультата = "ВтПогрешностьПрочиеРасходы";
	ОписаниеВТ.ИмяВТИсточника = "ВТОкруглениеПрочиеРасходы";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

//++ НЕ УТ
#Область ПрочиеРасходыНезавершенногоПроизводства

	Если ПараметрыРасчета.РежимЗакрытияМесяца <> Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие Тогда

		// Списание ошибок округления в регистре ПрочиеРасходыНезавершенногоПроизводства
		Запрос.Текст =
		"УНИЧТОЖИТЬ ВТОкруглениеПрочиеРасходыНЗП
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДокументыРасчетаСебестоимости.Ссылка	КАК Регистратор,
		|	&КонецПериода							КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)	КАК ВидДвижения,
		|	ПрочиеРасходыНЗП.Организация			КАК Организация,
		|	ПрочиеРасходыНЗП.Подразделение			КАК Подразделение,
		|	ПрочиеРасходыНЗП.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	ПрочиеРасходыНЗП.ПартияПроизводства		КАК ПартияПроизводства,
		|	ПрочиеРасходыНЗП.ЗаказНаПроизводство	КАК ЗаказНаПроизводство,
		|	ПрочиеРасходыНЗП.КодСтрокиПродукция		КАК КодСтрокиПродукция,
		|	ПрочиеРасходыНЗП.Этап					КАК Этап,
		|	ПрочиеРасходыНЗП.СтатьяКалькуляции		КАК СтатьяКалькуляции,
		|	ПрочиеРасходыНЗП.СтатьяРасходов			КАК СтатьяРасходов,
		|	ПрочиеРасходыНЗП.АналитикаРасходов		КАК АналитикаРасходов,
		|	ПрочиеРасходыНЗП.ГруппаПродукции		КАК ГруппаПродукции,
		|	ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск КАК ПравилоОтнесенияНаВыпуск,
		|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КАК НастройкаХозяйственнойОперации,
		|	ПрочиеРасходыНЗП.Стоимость				КАК Стоимость,
		|	ПрочиеРасходыНЗП.СтоимостьБезНДС		КАК СтоимостьБезНДС,
		|	ПрочиеРасходыНЗП.СтоимостьРегл			КАК СтоимостьРегл,
		|	ПрочиеРасходыНЗП.СтоимостьУпр			КАК СтоимостьУпр,
		|	ПрочиеРасходыНЗП.ПостояннаяРазница		КАК ПостояннаяРазница,
		|	ПрочиеРасходыНЗП.ВременнаяРазница		КАК ВременнаяРазница,
		|	ПрочиеРасходыНЗП.СтоимостьНДД			КАК СтоимостьНДД,
		|	ПрочиеРасходыНЗП.ДоляСтоимости			КАК ДоляСтоимости
		|ПОМЕСТИТЬ ВТОкруглениеПрочиеРасходыНЗП
		|ИЗ
		|	ВТКэшРасчетныеОстаткиПрочиеРасходыНезавершенногоПроизводства КАК ПрочиеРасходыНЗП
		|		ЛЕВОЕ СОЕДИНЕНИЕ АналитикиРасходныхДвиженийПостатейныхРасходов КАК ОборотыРасходов
		|		ПО ПрочиеРасходыНЗП.Организация = ОборотыРасходов.Организация
		|			И ПрочиеРасходыНЗП.Подразделение = ОборотыРасходов.Подразделение
		|			И ПрочиеРасходыНЗП.СтатьяРасходов = ОборотыРасходов.СтатьяРасходов
		|			И ПрочиеРасходыНЗП.АналитикаРасходов = ОборотыРасходов.АналитикаРасходов
		|			И ПрочиеРасходыНЗП.НаправлениеДеятельности = ОборотыРасходов.НаправлениеДеятельности
		|			И ПрочиеРасходыНЗП.ПартияПроизводства = ОборотыРасходов.ПартияПроизводства
		|			И ПрочиеРасходыНЗП.ЗаказНаПроизводство = ОборотыРасходов.ЗаказНаПроизводство
		|			И ПрочиеРасходыНЗП.КодСтрокиПродукция = ОборотыРасходов.КодСтрокиПродукция
		|			И ПрочиеРасходыНЗП.Этап = ОборотыРасходов.Этап
		|			И ПрочиеРасходыНЗП.СтатьяКалькуляции = ОборотыРасходов.СтатьяКалькуляции
		|			И ПрочиеРасходыНЗП.ГруппаПродукции = ОборотыРасходов.ГруппаПродукции
		|			И ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск = ОборотыРасходов.ПравилоОтнесенияНаВыпуск
		|
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
		|			ПО ПрочиеРасходыНЗП.Организация = ДокументыРасчетаСебестоимости.Организация
		|		
		|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиБазРаспределения КАК Материальные
		|		ПО ПрочиеРасходыНЗП.Организация = Материальные.Организация
		|			И ПрочиеРасходыНЗП.Подразделение = Материальные.Подразделение
		|			И ПрочиеРасходыНЗП.ПартияПроизводства = Материальные.ПартияПроизводства
		|			И ПрочиеРасходыНЗП.ЗаказНаПроизводство = Материальные.ЗаказНаПроизводство
		|			И ПрочиеРасходыНЗП.КодСтрокиПродукция = Материальные.КодСтрокиПродукция
		|			И (ВЫБОР
		|				КОГДА ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымЗатратам)
		|						ИЛИ ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымИТрудозатратам)
		|					ТОГДА Материальные.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымЗатратам)
		|				ИНАЧЕ ЛОЖЬ
		|			КОНЕЦ)
		|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиБазРаспределения КАК Трудозатраты
		|		ПО ПрочиеРасходыНЗП.Организация = Трудозатраты.Организация
		|			И ПрочиеРасходыНЗП.Подразделение = Трудозатраты.Подразделение
		|			И ПрочиеРасходыНЗП.ПартияПроизводства = Трудозатраты.ПартияПроизводства
		|			И ПрочиеРасходыНЗП.ЗаказНаПроизводство = Трудозатраты.ЗаказНаПроизводство
		|			И ПрочиеРасходыНЗП.КодСтрокиПродукция = Трудозатраты.КодСтрокиПродукция
		|			И (ВЫБОР
		|				КОГДА ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоТрудозатратам)
		|						ИЛИ ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоМатериальнымИТрудозатратам)
		|					ТОГДА Трудозатраты.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоТрудозатратам)
		|				ИНАЧЕ ЛОЖЬ
		|			КОНЕЦ)	
		|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиБазРаспределения КАК Продукция
		|		ПО ПрочиеРасходыНЗП.Организация = Продукция.Организация
		|			И Продукция.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
		|			И ПрочиеРасходыНЗП.ПартияПроизводства = Продукция.ПартияПроизводства
		|			И ПрочиеРасходыНЗП.ЗаказНаПроизводство = Продукция.ЗаказНаПроизводство
		|			И ПрочиеРасходыНЗП.КодСтрокиПродукция = Продукция.КодСтрокиПродукция
		|			И (ВЫБОР
		|					КОГДА ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПоПродукцииСУчетомБудущихВыпусков)
		|						ТОГДА Продукция.ПравилоОтнесенияНаВыпуск = ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ)
		|		ЛЕВОЕ СОЕДИНЕНИЕ ОстаткиБазРаспределения КАК Продукция21
		|		ПО ПрочиеРасходыНЗП.Организация = Продукция21.Организация
		|			И Продукция21.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка)
		|			И ПрочиеРасходыНЗП.ПартияПроизводства = Продукция21.ПартияПроизводства
		|			И ПрочиеРасходыНЗП.ЗаказНаПроизводство = Продукция21.ЗаказНаПроизводство
		|			И ПрочиеРасходыНЗП.КодСтрокиПродукция = Продукция21.КодСтрокиПродукция
		|			И (ВЫБОР
		|					КОГДА ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск = ЗНАЧЕНИЕ(Перечисление.ПравилаОтнесенияНаВыпуск.ПустаяСсылка)
		|						ТОГДА Продукция21.ПравилоОтнесенияНаВыпуск = ПрочиеРасходыНЗП.ПравилоОтнесенияНаВыпуск
		|					ИНАЧЕ ЛОЖЬ
		|				КОНЕЦ)
		|		ЛЕВОЕ СОЕДИНЕНИЕ ЗавершенныеПартии КАК ЗавершенныеПартии
		|		ПО ПрочиеРасходыНЗП.ПартияПроизводства = ЗавершенныеПартии.Партия
		|
		|ГДЕ
		|	ПрочиеРасходыНЗП.Стоимость МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
		|	И ПрочиеРасходыНЗП.СтоимостьБезНДС МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
		|	И ПрочиеРасходыНЗП.СтоимостьУпр МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
		|	И ПрочиеРасходыНЗП.СтоимостьРегл МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
		|	И ПрочиеРасходыНЗП.ПостояннаяРазница МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
		|	И ПрочиеРасходыНЗП.ВременнаяРазница МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
		|	И ПрочиеРасходыНЗП.СтоимостьНДД МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
		|	И ПрочиеРасходыНЗП.ДоляСтоимости МЕЖДУ -&ЗначениеПогрешностиКоличество И &ЗначениеПогрешностиКоличество
		|	И (НЕ ОборотыРасходов.Организация ЕСТЬ NULL ИЛИ НЕ ЗавершенныеПартии.Партия ЕСТЬ NULL ИЛИ НЕ &ПартионныйУчетВерсии22)
		|	И ((НЕ &ПартионныйУчетВерсии22) 
		|		ИЛИ (ЕСТЬNULL(Материальные.Остаток, 0) + ЕСТЬNULL(Материальные.ОстатокБезНДС, 0) + ЕСТЬNULL(Материальные.ОстатокРегл, 0) + ЕСТЬNULL(Материальные.ОстатокУпр, 0)
		|			+ ЕСТЬNULL(Трудозатраты.Остаток, 0) + ЕСТЬNULL(Трудозатраты.ОстатокБезНДС, 0) + ЕСТЬNULL(Трудозатраты.ОстатокРегл, 0) + ЕСТЬNULL(Трудозатраты.ОстатокУпр, 0) 
		|			+ ЕСТЬNULL(Продукция.Остаток, 0) + ЕСТЬNULL(Продукция21.Остаток, 0)) = 0)
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|УНИЧТОЖИТЬ АналитикиРасходныхДвиженийПостатейныхРасходов
		|;
		|";
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
		
		ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя,, Истина);
		ОписаниеВТ.ИмяВТРезультата = "ВтПогрешностьПрочиеРасходыНЗП";
		ОписаниеВТ.ИмяВТИсточника = "ВТОкруглениеПрочиеРасходыНЗП";
		
		СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	КонецЕсли;
	
#КонецОбласти

#Область РезервыПредстоящихРасходов

	Если ПараметрыРасчета.РежимЗакрытияМесяца <> Перечисления.РежимыЗакрытияМесяца.ПредварительноеЗакрытие Тогда

		// Списание ошибок округления в регистре РезервыПредстоящихРасходов
		Запрос.Текст =
		"УНИЧТОЖИТЬ ВТОкруглениеРезервыПредстоящихРасходов
		|;
		|////////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ
		|	ДокументыРасчетаСебестоимости.Ссылка		КАК Регистратор,
		|	&КонецПериода								КАК Период,
		|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)		КАК ВидДвижения,
		|
		|	Резервы.Организация							КАК Организация,
		|	Резервы.ВидРезервов							КАК ВидРезервов,
		|	Резервы.НаправлениеДеятельности				КАК НаправлениеДеятельности,
		|	Резервы.ОбъектУчетаРезервов					КАК ОбъектУчетаРезервов,
		|	Резервы.ОбъектУчетаРезервов.ПодразделениеСписания КАК Подразделение,
		|
		|	ВЫБОР КОГДА Резервы.СуммаУпр МЕЖДУ 0 И &ЗначениеПогрешностиРасходыУпр
		|		ТОГДА - Резервы.СуммаУпр
		|		ИНАЧЕ 0
		|	КОНЕЦ										КАК СуммаУпр,
		|	ВЫБОР КОГДА Резервы.СуммаРегл МЕЖДУ 0 И &ЗначениеПогрешностиРасходыРегл
		|		ТОГДА - Резервы.СуммаРегл
		|		ИНАЧЕ 0
		|	КОНЕЦ										КАК СуммаРегл,
		|	ВЫБОР КОГДА Резервы.СуммаНУ МЕЖДУ 0 И &ЗначениеПогрешностиРасходыРегл
		|		ТОГДА - Резервы.СуммаНУ
		|		ИНАЧЕ 0
		|	КОНЕЦ										КАК СуммаНУ
		|ПОМЕСТИТЬ ВТОкруглениеРезервыПредстоящихРасходов
		|ИЗ
		|	ВТКэшРасчетныеОстаткиРезервыПредстоящихРасходов КАК Резервы
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
		|			ПО Резервы.Организация = ДокументыРасчетаСебестоимости.Организация
		|
		|ГДЕ
		|	(Резервы.СуммаУпр МЕЖДУ 0 И &ЗначениеПогрешностиРасходыУпр
		|		ИЛИ Резервы.СуммаРегл МЕЖДУ 0 И &ЗначениеПогрешностиРасходыРегл
		|		ИЛИ Резервы.СуммаНУ МЕЖДУ 0 И &ЗначениеПогрешностиРасходыРегл)
		|ИНДЕКСИРОВАТЬ ПО
		|	Регистратор
		|";
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
		
		ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.РезервыПредстоящихРасходов.Имя,, Истина);
		ОписаниеВТ.ИмяВТРезультата = "ВтПогрешностьРезервыПредстоящихРасходов";
		ОписаниеВТ.ИмяВТИсточника = "ВТОкруглениеРезервыПредстоящихРасходов";
		
		СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	КонецЕсли;
	
#КонецОбласти
//-- НЕ УТ

#Область ПрочиеРасходы_КорДвижения

	// Формирование кор. движений в регистре ПрочиеРасходы
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Т.Регистратор 																	КАК Регистратор,
	|	&КонецПериода 																	КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 											КАК ВидДвижения,
	|	Т.Организация 																	КАК Организация,
	|	Т.Подразделение																	КАК Подразделение,
	|	Т.НаправлениеДеятельности														КАК НаправлениеДеятельности,
	|	СтатьяПогрешности.Ссылка														КАК СтатьяРасходов,
	|	Т.ИдентификаторФинЗаписи														КАК ИдентификаторФинЗаписи,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеОшибокОкругления)			КАК ХозяйственнаяОперация,
	|	Т.НастройкаХозяйственнойОперации												КАК НастройкаХозяйственнойОперации,
	|	СУММА(Т.Сумма) 																	КАК Сумма,
	|	СУММА(Т.СуммаРегл) 																КАК СуммаРегл,
	|	СУММА(ВЫБОР
	|		КОГДА НЕ &ПогрешностьПринимаетсяВНУ
	|			ТОГДА Т.СуммаРегл - Т.ВременнаяРазница
	|		ИНАЧЕ Т.ПостояннаяРазница КОНЕЦ)											КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница)														КАК ВременнаяРазница,
	|	СУММА(Т.СуммаНДД) 																КАК СуммаНДД,
	|	СУММА(Т.СуммаУпр) 																КАК СуммаУпр
	|ПОМЕСТИТЬ ВТКорДвиженияПрочиеРасходы
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Регистратор 				 	 КАК Регистратор,
	|		Т.Организация 					 КАК Организация,
	|		Т.Подразделение 				 КАК Подразделение,
	|		Т.НаправлениеДеятельности 		 КАК НаправлениеДеятельности,
	|		Т.ИдентификаторФинЗаписи		 КАК ИдентификаторФинЗаписи,
	|		Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|		Т.Стоимость
	|			+ Т.ДопРасходы
	|			+ Т.Трудозатраты
	|			+ Т.ПостатейныеПостоянныеСНДС
	|			+ Т.ПостатейныеПеременныеСНДС КАК Сумма,
	|		Т.СтоимостьРегл
	|			+ Т.ДопРасходыРегл
	|			+ Т.ТрудозатратыРегл
	|			+ Т.ПостатейныеПостоянныеРегл
	|			+ Т.ПостатейныеПеременныеРегл КАК СуммаРегл,
	|		Т.ПостояннаяРазница,
	|		Т.ВременнаяРазница,
	|		Т.СтоимостьНДД КАК СуммаНДД,
	|		Т.СтоимостьУпр
	|			+ Т.ДопРасходыУпр
	|			+ Т.ТрудозатратыУпр
	|			+ Т.ПостатейныеПостоянныеУпр
	|			+ Т.ПостатейныеПеременныеУпр КАК СуммаУпр
	|	ИЗ
	|		ВТОкруглениеСебестоимостьТоваров КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Регистратор 				 	 КАК Регистратор,
	|		Т.Организация 					 КАК Организация,
	|		Т.Подразделение 				 КАК Подразделение,
	|		Т.НаправлениеДеятельности 		 КАК НаправлениеДеятельности,
	|		Т.ИдентификаторФинЗаписи		 КАК ИдентификаторФинЗаписи,
	|		Т.НастройкаХозяйственнойОперации КАК НастройкаХозяйственнойОперации,
	|		Т.ОтклоненияВСтоимостиСНДС
	|			+ Т.ДопРасходыСНДС КАК Сумма,
	|		Т.ОтклоненияВСтоимостиРегл
	|			+ Т.ДопРасходыРегл
	|			+ Т.НДСРегл КАК СуммаРегл,
	|		Т.ПостояннаяРазница,
	|		Т.ВременнаяРазница,
	|		Т.НДД КАК СуммаНДД,
	|		Т.ОтклоненияВСтоимостиУпр
	|			+ Т.ДопРасходыУпр
	|			+ Т.НДСУпр КАК СуммаУпр
	|	ИЗ
	|		ВТОкруглениеОтклоненияВСтоимостиТоваров КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор,
	|		Т.Организация,
	|		Т.Подразделение,
	|		Т.НаправлениеДеятельности,
	|		Т.ИдентификаторФинЗаписи,
	|		Т.НастройкаХозяйственнойОперации,
	|		Т.Сумма,
	|		Т.СуммаРегл,
	|		ВЫБОР
	|			КОГДА &ПогрешностьПринимаетсяВНУ ТОГДА Т.ПостояннаяРазница
	|			ИНАЧЕ Т.СуммаРегл - Т.ВременнаяРазница КОНЕЦ КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница,
	|		Т.СуммаНДД,
	|		Т.СуммаУпр
	|	ИЗ
	|		ВТОкруглениеПрочиеРасходы КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор,
	|		Т.Организация,
	|		Т.Подразделение,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка),
	|		Т.ИдентификаторФинЗаписи,
	|		Т.НастройкаХозяйственнойОперации,
	|		Т.Стоимость,
	|		Т.СтоимостьРегл,
	|		ВЫБОР
	|			КОГДА &ПогрешностьПринимаетсяВНУ ТОГДА Т.ПостояннаяРазница
	|			ИНАЧЕ Т.СтоимостьРегл - Т.ВременнаяРазница КОНЕЦ КАК ПостояннаяРазница,
	|		Т.ВременнаяРазница КАК ВременнаяРазница,
	|		Т.СтоимостьНДД КАК СуммаНДД,
	|		Т.СтоимостьУпр
	|	ИЗ
	|		ВТОкруглениеПрочиеРасходыНЗП КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор,
	|		Т.Организация,
	|		Т.Подразделение,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка),
	|		Т.ИдентификаторФинЗаписи,
	|		ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеОшибокОкругления) КАК НастройкаХозяйственнойОперации,
	|		Т.СуммаУпр,
	|		Т.СуммаРегл,
	|		ВЫБОР КОГДА &ПогрешностьПринимаетсяВНУ ТОГДА 0 ИНАЧЕ Т.СуммаРегл КОНЕЦ,
	|		ВЫБОР КОГДА &ПогрешностьПринимаетсяВНУ ТОГДА Т.СуммаРегл - Т.СуммаНУ ИНАЧЕ 0 КОНЕЦ,
	|		0 КАК СуммаНДД,
	|		Т.СуммаУпр
	|	ИЗ
	|		ВТОкруглениеРезервыПредстоящихРасходов КАК Т) КАК Т
	|
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьяПогрешности
	|		ПО СтатьяПогрешности.Ссылка = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости)
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Регистратор,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	СтатьяПогрешности.Ссылка,
	|	Т.ИдентификаторФинЗаписи,
	|	Т.НастройкаХозяйственнойОперации
	|
	|ИМЕЮЩИЕ
	|	СУММА(Т.Сумма) <> 0
	|	ИЛИ СУММА(Т.СуммаРегл) <> 0
	|	ИЛИ СУММА(Т.ПостояннаяРазница) <> 0
	|	ИЛИ СУММА(Т.ВременнаяРазница) <> 0
	|	ИЛИ СУММА(Т.СуммаНДД) <> 0
	|	ИЛИ СУММА(Т.СуммаУпр) <> 0
	|";
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя);
	ОписаниеВТ.ИмяВТРезультата = "ВтПогрешностьКорПрочиеРасходы";
	ОписаниеВТ.ИмяВТИсточника = "ВТКорДвиженияПрочиеРасходы";
		
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
#Область ПартииПрочихРасходовСменаУчетнойПолитики

	// Списание остатков производственных статей при смене учетной политики с ФИФО на среднюю.
	// При учете по средней такие статьи не поддерживаются.
	Запрос.Текст = "
	|ВЫБРАТЬ ПЕРВЫЕ 0
	|	Т.Ссылка,
	|	0 КАК КоэффициентУпр,
	|	0 КАК КоэффициентРегл
	|ПОМЕСТИТЬ ВТСтатьиПроизводственныхЗатратСменаПолитики
	|ИЗ
	|	ПланВидовХарактеристик.СтатьиРасходов КАК Т
	//++ Локализация
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Т.Ссылка,
	|	ВЫБОР КОГДА Т.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства))
	|		ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК КоэффициентУпр,
	|	ВЫБОР КОГДА Т.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства))
	|		ТОГДА 1
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК КоэффициентРегл
	|ИЗ
	|	ПланВидовХарактеристик.СтатьиРасходов КАК Т
	|ГДЕ
	|	(Т.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства))
	|		ИЛИ Т.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьПроизводства))
	|	)
	|	И Т.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	//-- Локализация
	|ИНДЕКСИРОВАТЬ ПО
	|	Ссылка
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.НаправлениеДеятельности,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.Стоимость * Отбор.КоэффициентУпр КАК Стоимость,
	|	Т.СтоимостьБезНДС * Отбор.КоэффициентУпр КАК СтоимостьБезНДС,
	|	Т.СтоимостьРегл * Отбор.КоэффициентРегл КАК СтоимостьРегл,
	|	Т.НДСРегл * Отбор.КоэффициентРегл КАК НДСРегл,
	|	Т.ПостояннаяРазница * Отбор.КоэффициентРегл КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница * Отбор.КоэффициентРегл КАК ВременнаяРазница,
	|	Т.НДСУпр * Отбор.КоэффициентУпр КАК НДСУпр
	|ПОМЕСТИТЬ ВТОстаткиПартииПрочихРасходовСменаПолитики
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПартииПрочихРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО Т.Организация = ДокументыРасчетаСебестоимости.Организация
	|   ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиПроизводственныхЗатратСменаПолитики КАК Отбор
	|       ПО Т.СтатьяРасходов = Отбор.Ссылка
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|   И Т.Организация В (&ОрганизацииСФИФОСкользящаяВПрошломПериоде)
	|   И НЕ Т.Организация В (&ОрганизацииСФИФОСкользящая)
	|
	|ОБЪЕДИНИТЬ
	|
	// При учете по среднескользящей пока не поддерживаются статьи, распределяемые на себестоимость и на производство, в партиях прочих расходов.
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.НаправлениеДеятельности,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.Стоимость * Отбор.КоэффициентУпр КАК Стоимость,
	|	Т.СтоимостьБезНДС * Отбор.КоэффициентУпр КАК СтоимостьБезНДС,
	|	Т.СтоимостьРегл * Отбор.КоэффициентРегл КАК СтоимостьРегл,
	|	Т.НДСРегл * Отбор.КоэффициентРегл КАК НДСРегл,
	|	Т.ПостояннаяРазница * Отбор.КоэффициентРегл КАК ПостояннаяРазница,
	|	Т.ВременнаяРазница * Отбор.КоэффициентРегл КАК ВременнаяРазница,
	|	Т.НДСУпр * Отбор.КоэффициентУпр КАК НДСУпр
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПартииПрочихРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО Т.Организация = ДокументыРасчетаСебестоимости.Организация
	|   ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТСтатьиЗатратДляПартийПрочих КАК Отбор
	|       ПО Т.СтатьяРасходов = Отбор.Ссылка
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|   И НЕ Т.Организация В (&ОрганизацииСреднескользящаяВПрошломПериоде)
	|   И Т.Организация В (&ОрганизацииСреднескользящая)
	|";

	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя,, Истина);
	ОписаниеВТ.ИмяВТРезультата = "ВтПартииПрочихРасходовСменаПолитики";
	ОписаниеВТ.ИмяВТИсточника = "ВТОстаткиПартииПрочихРасходовСменаПолитики";
		
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

	СоответствиеВременныхТаблицДвижений = Новый Соответствие;

#Область ПартииПрочихРасходовРазвернутоеСальдо

	// Списание развернутого сальдо в регистре ПартииПрочихРасходов
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	ВЫРАЗИТЬ(Т.АналитикаУчетаПартий КАК Справочник.КлючиАналитикиУчетаПартий) КАК АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.НДСРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ВТОстаткиПартииПрочихРасходовПолные
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПартииПрочихРасходов КАК Т
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И (Т.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|		ИЛИ Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение))
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	НаправлениеДеятельности
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	СУММА(Т.Стоимость) КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьРегл) КАК СтоимостьРегл,
	|	СУММА(Т.НДСРегл) КАК НДСРегл,
	|	СУММА(Т.ПостояннаяРазница) КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазница) КАК ВременнаяРазница,
	|	СУММА(Т.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВТОстаткиПартииПрочихРасходовСвернутые
	|ИЗ
	|	ВТОстаткиПартииПрочихРасходовПолные КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов
	|ИМЕЮЩИЕ
	|	(СУММА(Т.Стоимость) <> 0 И Т.СтатьяРасходов <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.НДСНалоговогоАгента))
	|	ИЛИ СУММА(Т.СтоимостьБезНДС) <> 0
	|	ИЛИ СУММА(Т.СтоимостьРегл) <> 0
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	НаправлениеДеятельности
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	СУММА(Т.СтоимостьОстаток) КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДСОстаток) КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьРеглОстаток) КАК СтоимостьРегл,
	|	СУММА(Т.НДСРеглОстаток) КАК НДСРегл,
	|	СУММА(Т.ПостояннаяРазницаОстаток) КАК ПостояннаяРазница,
	|	СУММА(Т.ВременнаяРазницаОстаток) КАК ВременнаяРазница,
	|	СУММА(Т.НДСУпрОстаток) КАК НДСУпр
	|ПОМЕСТИТЬ ВТНачальныеОстаткиПартииПрочихРасходов
	|ИЗ
	|	РегистрНакопления.ПартииПрочихРасходов.Остатки(&ГраницаКонецПредыдущегоПериода,
	|		(Организация, Подразделение, НаправлениеДеятельности, СтатьяРасходов, АналитикаРасходов)
	|			В (ВЫБРАТЬ Организация, Подразделение, НаправлениеДеятельности, СтатьяРасходов, АналитикаРасходов ИЗ ВТОстаткиПартииПрочихРасходовСвернутые)) КАК Т
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	НаправлениеДеятельности
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов
	|ПОМЕСТИТЬ ВТОборотыПоДокументам
	|ИЗ
	|	ВТКэшРасчетныеОборотыПартииПрочихРасходов КАК Т
	|ГДЕ
	|	НЕ ТИПЗНАЧЕНИЯ(Т.Регистратор) В
	|		(ТИП(Документ.РасчетСебестоимостиТоваров),
	|		 ТИП(Документ.КорректировкаРегистров),
	|		 ТИП(Документ.ПрочиеДоходыРасходы))
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов
	|ПОМЕСТИТЬ ВТОстаткиПрочиеРасходыПолные
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПрочиеРасходы КАК Т
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И (Т.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|		 И (Т.Сумма <> 0 ИЛИ Т.СуммаБезНДС <> 0)
	|		ИЛИ Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|		 И (Т.СуммаРегл <> 0))
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СтатьяРасходов,
	|	АналитикаРасходов,
	|	Подразделение,
	|	НаправлениеДеятельности
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.ВидДеятельностиНДС КАК НалогообложениеНДС,
	// Для исключения движений из механизмов НДС и проводок
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное) КАК ТипЗаписи,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.НДСРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ВТСписаниеРазвернутогоСальдоПартийПрочихРасходов
	|ИЗ
	|	ВТОстаткиПартииПрочихРасходовПолные КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО Т.Организация = ДокументыРасчетаСебестоимости.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииПрочихРасходовСвернутые КАК Отбор1
	|		ПО Т.СтатьяРасходов = Отбор1.СтатьяРасходов
	|		 И  Т.АналитикаРасходов = Отбор1.АналитикаРасходов
	|		 И  Т.Подразделение = Отбор1.Подразделение
	|		 И  Т.Организация = Отбор1.Организация
	|		 И  Т.НаправлениеДеятельности = Отбор1.НаправлениеДеятельности
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПрочиеРасходыПолные КАК Отбор2
	|		ПО Т.СтатьяРасходов = Отбор2.СтатьяРасходов
	|		 И  Т.АналитикаРасходов = Отбор2.АналитикаРасходов
	|		 И  Т.Подразделение = Отбор2.Подразделение
	|		 И  Т.Организация = Отбор2.Организация
	|		 И  Т.НаправлениеДеятельности = Отбор2.НаправлениеДеятельности
	|ГДЕ
	|	(Отбор1.СтатьяРасходов ЕСТЬ NULL
	|	 ИЛИ (Отбор1.Стоимость МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
	|	 	  И Отбор1.СтоимостьБезНДС МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
	|	 	  И Отбор1.СтоимостьРегл МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|	 	  И Отбор1.НДСРегл МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|	 	  И Отбор1.ПостояннаяРазница МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|	 	  И Отбор1.ВременнаяРазница МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|	 	  И Отбор1.НДСУпр МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр)
	|	 ИЛИ (Отбор1.СтоимостьРегл = -Отбор1.НДСРегл
	|		  И Отбор1.Стоимость = 0
	|		  И Отбор1.СтоимостьБезНДС = 0))
	|	И Отбор2.СтатьяРасходов ЕСТЬ NULL
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	// Списываем остатки по партиям прочих расходов в следующем случае:
	//	- есть остатки по партиям прочих расходов
	//  - есть "свернутые" остатки по партиям прочих расходов (т.е. проблема не в различиях движений по документу поступления)
	//  - нет остатков прочих расходов
	//  - нет начальных остатков в партиях прочих расходов
	//	- движения в текущем периоде по партиям прочих расходов есть только у служебных документов
	//  Т.е. если остатки партий прочих расходов возникли в текущем периоде из-за движений служебных документов,
	//  при том, что регистр прочих расходов закрыт, то такие остатки можно списать.
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС,
	|	Т.ВидДеятельностиНДС КАК НалогообложениеНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное) КАК ТипЗаписи,
	|	Т.Стоимость,
	|	Т.СтоимостьБезНДС,
	|	Т.СтоимостьРегл,
	|	Т.НДСРегл,
	|	Т.ПостояннаяРазница,
	|	Т.ВременнаяРазница,
	|	Т.НДСУпр
	|ПОМЕСТИТЬ ВТСписаниеОстатковПоСлужебнымДокументам
	|ИЗ
	|	ВТОстаткиПартииПрочихРасходовПолные КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО Т.Организация = ДокументыРасчетаСебестоимости.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПартииПрочихРасходовСвернутые КАК Отбор1
	|		ПО Т.СтатьяРасходов = Отбор1.СтатьяРасходов
	|		 И  Т.АналитикаРасходов = Отбор1.АналитикаРасходов
	|		 И  Т.Подразделение = Отбор1.Подразделение
	|		 И  Т.Организация = Отбор1.Организация
	|		 И  Т.НаправлениеДеятельности = Отбор1.НаправлениеДеятельности
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПрочиеРасходыПолные КАК Отбор2
	|		ПО Т.СтатьяРасходов = Отбор2.СтатьяРасходов
	|		 И  Т.АналитикаРасходов = Отбор2.АналитикаРасходов
	|		 И  Т.Подразделение = Отбор2.Подразделение
	|		 И  Т.Организация = Отбор2.Организация
	|		 И  Т.НаправлениеДеятельности = Отбор2.НаправлениеДеятельности
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТНачальныеОстаткиПартииПрочихРасходов КАК Отбор3
	|		ПО Т.СтатьяРасходов = Отбор3.СтатьяРасходов
	|		 И  Т.АналитикаРасходов = Отбор3.АналитикаРасходов
	|		 И  Т.Подразделение = Отбор3.Подразделение
	|		 И  Т.Организация = Отбор3.Организация
	|		 И  Т.НаправлениеДеятельности = Отбор3.НаправлениеДеятельности
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОборотыПоДокументам КАК Отбор4
	|		ПО Т.СтатьяРасходов = Отбор4.СтатьяРасходов
	|		 И  Т.АналитикаРасходов = Отбор4.АналитикаРасходов
	|		 И  Т.Подразделение = Отбор4.Подразделение
	|		 И  Т.Организация = Отбор4.Организация
	|		 И  Т.НаправлениеДеятельности = Отбор4.НаправлениеДеятельности
	|ГДЕ
	|	НЕ Отбор1.СтатьяРасходов ЕСТЬ NULL
	|	И Отбор2.СтатьяРасходов ЕСТЬ NULL
	|	И Отбор3.СтатьяРасходов ЕСТЬ NULL
	|	И Отбор4.СтатьяРасходов ЕСТЬ NULL
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Регистратор,
	|	Т.Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) КАК ВидДвижения,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.АналитикаУчетаПартий.Контрагент КАК Поставщик,
	|	ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Т.ДокументПоступленияРасходов) В (&ТипыДокументовПартии)
	|		ТОГДА Т.ДокументПоступленияРасходов
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ДокументПоступленияРасходов,
	|	Т.ВидДеятельностиНДС,
	|	Т.АналитикаУчетаПартий.ВидЦенности КАК ВидЦенности,
	|	Т.АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
	|	Т.СтоимостьРегл КАК СтоимостьРегл,
	|	Т.НДСРегл КАК НДСРегл,
	|	Т.НДСУпр КАК НДСУпр
	|ПОМЕСТИТЬ ВТОкруглениеПартииНДСКРаспределению
	|ИЗ
	|	ВТСписаниеРазвернутогоСальдоПартийПрочихРасходов КАК Т
	|ГДЕ
	|	Т.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	// Партии прочих расходов, развернутое сальдо
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя,, Истина);
	ОписаниеВТ.ИмяВТРезультата = "ВТРазвернутоеСальдоПартийПрочихРасходов";
	ОписаниеВТ.ИмяВТИсточника = "ВТСписаниеРазвернутогоСальдоПартийПрочихРасходов";
		
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	// Партии прочих расходов, остатки по служебным документам
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя,, Истина);
	ОписаниеВТ.ИмяВТРезультата = "ВТСлужебныеОстаткиПартийПрочихРасходов";
	ОписаниеВТ.ИмяВТИсточника = "ВТСписаниеОстатковПоСлужебнымДокументам";
		
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
	//++ Локализация

	// Партии НДС к распределению

	Если ПараметрыРасчета.ПартионныйУчетВерсии22 Тогда
		
		ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПартииНДСКРаспределению.Имя,, Истина);
		ОписаниеВТ.ИмяВТРезультата = "ВтПогрешностьПартииНДСКРаспределению";
		ОписаниеВТ.ИмяВТИсточника = "ВТОкруглениеПартииНДСКРаспределению";
		
		СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
		
	Иначе
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	*,
		|	ИСТИНА КАК РасчетПартий
		|ИЗ
		|	ВТОкруглениеПартииНДСКРаспределению КАК Т";
		
		РасчетныеПартииНДСКРаспределению = Запрос.Выполнить().Выгрузить();
		ПартионныйУчет.ЗаписатьРасчетныеПартии(РегистрыНакопления.ПартииНДСКРаспределению, РасчетныеПартииНДСКРаспределению, Неопределено);
		
	КонецЕсли;

	//-- Локализация
	
#КонецОбласти

	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

	СоответствиеВременныхТаблицДвижений = Новый Соответствие;
	
#Область ПартииПрочихРасходов

	// Списание ошибок округления в регистре ПартииПрочихРасходов
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов КАК ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|
	|	ВЫБОР КОГДА Т.Стоимость МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
	|		И Т.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		ТОГДА Т.Стоимость
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Стоимость,
	|	ВЫБОР КОГДА Т.СтоимостьБезНДС МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
	|		И Т.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		ТОГДА Т.СтоимостьБезНДС
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА Т.СтоимостьРегл МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|		И Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		ТОГДА Т.СтоимостьРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК СтоимостьРегл,
	|	ВЫБОР КОГДА Т.НДСРегл МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|		И Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		ТОГДА Т.НДСРегл
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НДСРегл,
	|	ВЫБОР КОГДА Т.ПостояннаяРазница МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|		И Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		ТОГДА Т.ПостояннаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ПостояннаяРазница,
	|	ВЫБОР КОГДА Т.ВременнаяРазница МЕЖДУ -&ЗначениеПогрешностиРасходыРегл И &ЗначениеПогрешностиРасходыРегл
	|		И Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		ТОГДА Т.ВременнаяРазница
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК ВременнаяРазница,
	|	ВЫБОР КОГДА Т.НДСУпр МЕЖДУ -&ЗначениеПогрешностиРасходыУпр И &ЗначениеПогрешностиРасходыУпр
	|		И Т.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		ТОГДА Т.НДСУпр
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК НДСУпр
	|ПОМЕСТИТЬ ВТОстаткиПартииПрочихРасходов
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПартииПрочихРасходов КАК Т
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|	И (Т.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|		ИЛИ Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение))
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов,
	|	Подразделение,
	|	Организация
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА Т.СтатьяРасходов.ВариантРаспределенияРасходовУпр В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 	  И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|				ТОГДА ВЫБОР КОГДА Т.Сумма <> 0 ИЛИ Т.СуммаБезНДС <> 0 ИЛИ Т.СуммаУпр <> 0 ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ
	|				ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ) КАК СписыватьУпр,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 	  И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|				ТОГДА ВЫБОР КОГДА Т.СуммаРегл <> 0 ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ
	|				ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ) КАК СписыватьРегл,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 	  И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|				ТОГДА ВЫБОР КОГДА Т.ПостояннаяРазница <> 0 ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ
	|				ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ) КАК СписыватьПР,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА Т.СтатьяРасходов.ВариантРаспределенияРасходовРегл В (
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|			ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаСебестоимостьТоваров))
	|		 	  И Т.СтатьяРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|				ТОГДА ВЫБОР КОГДА Т.ВременнаяРазница <> 0 ТОГДА ЛОЖЬ ИНАЧЕ ИСТИНА КОНЕЦ
	|				ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ) КАК СписыватьВР
	|ПОМЕСТИТЬ ВТОстаткиПрочиеРасходы
	|ИЗ
	|	ВТКэшРасчетныеОстаткиПрочиеРасходы КАК Т
	|ГДЕ
	|	&ПартионныйУчетВерсии22
	|СГРУППИРОВАТЬ ПО
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.СтатьяРасходов,
	|	Т.АналитикаРасходов
	|ИНДЕКСИРОВАТЬ ПО
	|	СтатьяРасходов,
	|	Подразделение,
	|	Организация
	|;
	|//////////////////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 		КАК Регистратор,
	|	&КонецПериода								КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)		КАК ВидДвижения,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.АналитикаАктивовПассивов КАК АналитикаАктивовПассивов,
	|	Т.ДокументПоступленияРасходов КАК ДокументПоступленияРасходов,
	|	Т.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	Т.ВидДеятельностиНДС КАК НалогообложениеНДС,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыЗаписейПартий.Расчетное) КАК ТипЗаписи,
	|	ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьУпр, ИСТИНА) ТОГДА Т.Стоимость ИНАЧЕ 0 КОНЕЦ КАК Стоимость,
	|	ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьУпр, ИСТИНА) ТОГДА Т.СтоимостьБезНДС ИНАЧЕ 0 КОНЕЦ КАК СтоимостьБезНДС,
	|	ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьУпр, ИСТИНА) ТОГДА Т.НДСУпр ИНАЧЕ 0 КОНЕЦ КАК НДСУпр,
	|	ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьРегл, ИСТИНА) ТОГДА Т.СтоимостьРегл ИНАЧЕ 0 КОНЕЦ КАК СтоимостьРегл,
	|	ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьРегл, ИСТИНА) ТОГДА Т.НДСРегл ИНАЧЕ 0 КОНЕЦ КАК НДСРегл,
	|	ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьПР, ИСТИНА) ТОГДА Т.ПостояннаяРазница ИНАЧЕ 0 КОНЕЦ КАК ПостояннаяРазница,
	|	ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьВР, ИСТИНА) ТОГДА Т.ВременнаяРазница ИНАЧЕ 0 КОНЕЦ КАК ВременнаяРазница
	|ПОМЕСТИТЬ ВТОкруглениеПартииПрочихРасходов
	|ИЗ
	|	ВТОстаткиПартииПрочихРасходов КАК Т
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО Т.Организация = ДокументыРасчетаСебестоимости.Организация
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОстаткиПрочиеРасходы КАК Отбор
	|		ПО Т.СтатьяРасходов = Отбор.СтатьяРасходов
	|		И Т.Подразделение = Отбор.Подразделение
	|		И Т.Организация = Отбор.Организация
	|		И Т.АналитикаРасходов = Отбор.АналитикаРасходов
	|		И Т.НаправлениеДеятельности = Отбор.НаправлениеДеятельности
	|ГДЕ
	|	ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьУпр, ИСТИНА) ТОГДА Т.Стоимость ИНАЧЕ 0 КОНЕЦ <> 0
	|		ИЛИ ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьУпр, ИСТИНА) ТОГДА Т.СтоимостьБезНДС ИНАЧЕ 0 КОНЕЦ <> 0
	|		ИЛИ ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьУпр, ИСТИНА) ТОГДА Т.НДСУпр ИНАЧЕ 0 КОНЕЦ <> 0
	|		ИЛИ ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьРегл, ИСТИНА) ТОГДА Т.СтоимостьРегл ИНАЧЕ 0 КОНЕЦ <> 0
	|		ИЛИ ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьРегл, ИСТИНА) ТОГДА Т.НДСРегл ИНАЧЕ 0 КОНЕЦ <> 0
	|		ИЛИ ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьПР, ИСТИНА) ТОГДА Т.ПостояннаяРазница ИНАЧЕ 0 КОНЕЦ <> 0
	|		ИЛИ ВЫБОР КОГДА ЕСТЬNULL(Отбор.СписыватьВР, ИСТИНА) ТОГДА Т.ВременнаяРазница ИНАЧЕ 0 КОНЕЦ <> 0
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	
	ОписаниеВТ = ОписаниеФормированияВременнойТаблицы(Метаданные.РегистрыНакопления.ПартииПрочихРасходов.Имя,, Истина);
	ОписаниеВТ.ИмяВТРезультата = "ВтПогрешностьПартииПрочихРасходов";
	ОписаниеВТ.ИмяВТИсточника = "ВТОкруглениеПартииПрочихРасходов";
	
	СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);
	
#КонецОбласти

	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвиженияИзВременныхТаблиц(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений);

#Область ОборотныеРегистрыУпрУчета
 
	// Корректировка движений по оборотным регистрам управленческого учета.
	Запрос.Текст =
	"ВЫБРАТЬ
	|	&КонецПериода 					КАК Период,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ЗакрытиеМесяца) КАК ХозяйственнаяОперация,
	|	Т.ДокументДвижения 				КАК ДокументДвижения,
	|	Т.Организация 					КАК Организация,
	|	Т.Подразделение 				КАК Подразделение,
	|	Т.АналитикаУчетаНоменклатуры 	КАК АналитикаУчетаНоменклатуры,
	|	Т.НаправлениеДеятельности		КАК НаправлениеДеятельности,
	|	Т.НаправлениеДеятельности		КАК КорНаправлениеДеятельности,
	|	Т.Склад 						КАК Склад,
	|	Т.ТипЗапасов 					КАК ТипЗапасов,
	|	Т.ВидЗапасов 					КАК ВидЗапасов,
	|	Т.СтатьяРасходовСписания 		КАК СтатьяРасходовСписания,
	|	Т.АналитикаРасходов 			КАК АналитикаРасходов,
	|	Т.ИсточникГФУНоменклатуры		КАК ИсточникГФУНоменклатуры,
	|	СУММА(Т.Стоимость) 				КАК Стоимость,
	|	СУММА(Т.СтоимостьБезНДС) 		КАК СтоимостьБезНДС,
	|	СУММА(Т.СтоимостьРегл) 			КАК СтоимостьРегл,
	|	СУММА(Т.СтоимостьУпр) 			КАК СтоимостьУпр
	|ИЗ
	|	(ВЫБРАТЬ
	|		Т.Регистратор	 											КАК ДокументДвижения,
	|		Т.Организация 												КАК Организация,
	|		НЕОПРЕДЕЛЕНО 												КАК Подразделение,
	|		Т.НаправлениеДеятельности									КАК НаправлениеДеятельности,
	|		Т.АналитикаУчетаНоменклатуры 								КАК АналитикаУчетаНоменклатуры,
	|		АналитикаНоменклатуры.МестоХранения							КАК Склад,
	|		Т.ВидЗапасов.ТипЗапасов 									КАК ТипЗапасов,
	|		Т.ВидЗапасов 												КАК ВидЗапасов,
	|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости) КАК СтатьяРасходовСписания,
	|		НЕОПРЕДЕЛЕНО 												КАК АналитикаРасходов,
	|		ВЫБОР
	|			КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|				ТОГДА Т.ВидЗапасов
	|			ИНАЧЕ АналитикаНоменклатуры.Номенклатура
	|		КОНЕЦ 														КАК ИсточникГФУНоменклатуры,
	|		-(Т.Стоимость + Т.ДопРасходы)								КАК Стоимость,
	|		-(Т.СтоимостьБезНДС + Т.ДопРасходыБезНДС)					КАК СтоимостьБезНДС,
	|		-Т.СтоимостьРегл 											КАК СтоимостьРегл,
	|		-Т.СтоимостьУпр 											КАК СтоимостьУпр
	|	ИЗ
	|		ВТОкруглениеСебестоимостьТоваров КАК Т
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО Т.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.Регистратор	 											КАК ДокументДвижения,
	|		Т.Организация 												КАК Организация,
	|		Т.Подразделение 											КАК Подразделение,
	|		Т.НаправлениеДеятельности									КАК НаправлениеДеятельности,
	|		НЕОПРЕДЕЛЕНО				 								КАК АналитикаУчетаНоменклатуры,
	|		Т.МестоХранения												КАК Склад,
	|		Т.ВидЗапасов.ТипЗапасов 									КАК ТипЗапасов,
	|		Т.ВидЗапасов 												КАК ВидЗапасов,
	|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости) КАК СтатьяРасходовСписания,
	|		НЕОПРЕДЕЛЕНО 												КАК АналитикаРасходов,
	|		ВЫБОР
	|			КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|				ТОГДА Т.ВидЗапасов
	|			ИНАЧЕ Т.Номенклатура
	|		КОНЕЦ 														КАК ИсточникГФУНоменклатуры,
	|		-(Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС)			КАК Стоимость,
	|		-(Т.ОтклоненияВСтоимостиБезНДС + Т.ДопРасходыБезНДС)		КАК СтоимостьБезНДС,
	|		-(Т.ОтклоненияВСтоимостиРегл + Т.ДопРасходыРегл)			КАК СтоимостьРегл,
	|		-(Т.ОтклоненияВСтоимостиУпр + Т.ДопРасходыУпр)				КАК СтоимостьУпр
	|	ИЗ
	|		ВТОкруглениеОтклоненияВСтоимостиТоваров КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор	 											КАК ДокументДвижения,
	|		Т.Организация 												КАК Организация,
	|		Т.Подразделение 											КАК Подразделение,
	|		Т.НаправлениеДеятельности									КАК НаправлениеДеятельности,
	|		НЕОПРЕДЕЛЕНО 												КАК АналитикаУчетаНоменклатуры,
	|		НЕОПРЕДЕЛЕНО 												КАК Склад,
	|		НЕОПРЕДЕЛЕНО 												КАК ТипЗапасов,
	|		НЕОПРЕДЕЛЕНО 												КАК ВидЗапасов,
	|		Т.СтатьяРасходов 											КАК СтатьяДоходовРасходов,
	|		Т.АналитикаРасходов 										КАК АналитикаРасходов,
	|		НЕОПРЕДЕЛЕНО 												КАК ИсточникГФУНоменклатуры,
	|		-Т.Сумма 													КАК Стоимость,
	|		-Т.СуммаБезНДС 												КАК СтоимостьБезНДС,
	|		-Т.СуммаРегл 												КАК СтоимостьРегл,
	|		-Т.СуммаУпр 												КАК СтоимостьУпр
	|	ИЗ
	|		ВТОкруглениеПрочиеРасходы КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор	 											КАК ДокументДвижения,
	|		Т.Организация 												КАК Организация,
	|		Т.Подразделение 											КАК Подразделение,
	|		ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)	КАК НаправлениеДеятельности,
	|		НЕОПРЕДЕЛЕНО 												КАК АналитикаУчетаНоменклатуры,
	|		НЕОПРЕДЕЛЕНО 												КАК Склад,
	|		НЕОПРЕДЕЛЕНО 												КАК ТипЗапасов,
	|		НЕОПРЕДЕЛЕНО 												КАК ВидЗапасов,
	|		Т.СтатьяРасходов 											КАК СтатьяДоходовРасходов,
	|		Т.АналитикаРасходов 										КАК АналитикаРасходов,
	|		НЕОПРЕДЕЛЕНО 												КАК ИсточникГФУНоменклатуры,
	|		-Т.Стоимость												КАК Стоимость,
	|		-Т.СтоимостьБезНДС											КАК СтоимостьБезНДС,
	|		-Т.СтоимостьРегл											КАК СтоимостьРегл,
	|		-Т.СтоимостьУпр												КАК СтоимостьУпр
	|	ИЗ
	|		ВТОкруглениеПрочиеРасходыНЗП КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Т.Регистратор	 											КАК ДокументДвижения,
	|		Т.Организация 												КАК Организация,
	|		НЕОПРЕДЕЛЕНО 												КАК Подразделение,
	|		Т.НаправлениеДеятельности									КАК НаправлениеДеятельности,
	|		НЕОПРЕДЕЛЕНО 												КАК АналитикаУчетаНоменклатуры,
	|		НЕОПРЕДЕЛЕНО 												КАК Склад,
	|		НЕОПРЕДЕЛЕНО 												КАК ТипЗапасов,
	|		НЕОПРЕДЕЛЕНО 												КАК ВидЗапасов,
	|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости) КАК СтатьяДоходовРасходов,
	|		НЕОПРЕДЕЛЕНО 												КАК АналитикаРасходов,
	|		НЕОПРЕДЕЛЕНО 												КАК ИсточникГФУНоменклатуры,
	|		Т.Сумма 													КАК Стоимость,
	|		0 															КАК СтоимостьБезНДС,
	|		0 															КАК СтоимостьРегл,
	|		0 															КАК СтоимостьУпр
	|	ИЗ
	|		ВТКорДвиженияПрочиеРасходы КАК Т) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.ДокументДвижения,
	|	Т.Организация,
	|	Т.Подразделение,
	|	Т.НаправлениеДеятельности,
	|	Т.АналитикаУчетаНоменклатуры,
	|	Т.Склад,
	|	Т.ТипЗапасов,
	|	Т.ВидЗапасов,
	|	Т.СтатьяРасходовСписания,
	|	Т.АналитикаРасходов,
	|	Т.ИсточникГФУНоменклатуры
	|
	|ИМЕЮЩИЕ
	|	(СУММА(Т.Стоимость) <> 0
	|		ИЛИ СУММА(Т.СтоимостьБезНДС) <> 0
	|		ИЛИ СУММА(Т.СтоимостьРегл) <> 0
	|		ИЛИ СУММА(Т.СтоимостьУпр) <> 0)";
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,, НСтр("ru = 'Регистры упр. учета';
																																	|en = 'Manag. accounting ledgers'", ОбщегоНазначения.КодОсновногоЯзыка()));
	
	Пока Выборка.Следующий() Цикл
		СформироватьДвиженияПоОборотнымРегистрамУпрУчета(ПараметрыРасчета, Выборка);
	КонецЦикла;

#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
КонецПроцедуры

// Этап 4.1
// Процедура выполняет распределение выручки и себестоимости продаж по направлениям деятельности.
//
// Параметры:
// ПараметрыРасчета - см. РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьОбщиеПараметрыРасчета
//
Процедура РаспределитьВыручкуПоНаправлениямДеятельности(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "РаспределитьВыручкуПоНаправлениямДеятельности");
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ВыручкаИСебестоимость.Подразделение             		 КАК Подразделение,
	|	АналитикаПоПартнерам.Организация                		 КАК Организация,
	|	АналитикаПоПартнерам.Партнер                    		 КАК Партнер,
	|	ВыручкаИСебестоимость.НаправлениеДеятельностиКонтрагента КАК НаправлениеДеятельности,
	|	АналитикаНоменклатуры.Номенклатура              		 КАК Номенклатура,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиДоходов.ВыручкаОтПродаж) КАК СтатьяДоходов,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.СебестоимостьПродаж) КАК СтатьяРасходов,
	|	СУММА(ВыручкаИСебестоимость.СуммаВыручки)				 КАК СуммаВыручки,
	|	СУММА(ВыручкаИСебестоимость.Стоимость
	|		+ ВыручкаИСебестоимость.ДопРасходы
	|		+ ВыручкаИСебестоимость.ПостатейныеПостоянныеСНДС
	|		+ ВыручкаИСебестоимость.ПостатейныеПеременныеСНДС
	|		+ ВыручкаИСебестоимость.Трудозатраты
	|		+ ВыручкаИСебестоимость.РасходыНаПродажуСНДС) КАК Себестоимость
	|ПОМЕСТИТЬ ВТТаблицаВыручки
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК ВыручкаИСебестоимость
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПоПартнерам
	|			ПО ВыручкаИСебестоимость.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ПО ВыручкаИСебестоимость.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|ГДЕ
	|	ВыручкаИСебестоимость.ТипЗапасов В
	|		(ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар),
	//++ НЕ УТ
	|		 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияПереработчика),
	//-- НЕ УТ
	|		 ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга))
	|
	|СГРУППИРОВАТЬ ПО
	|	ВыручкаИСебестоимость.Подразделение,
	|	АналитикаПоПартнерам.Организация,
	|	АналитикаПоПартнерам.Партнер,
	|	ВыручкаИСебестоимость.НаправлениеДеятельностиКонтрагента,
	|	АналитикаНоменклатуры.Номенклатура
	|
	|ИМЕЮЩИЕ
	|	СУММА(ВыручкаИСебестоимость.СуммаВыручки) <> 0
	|	ИЛИ СУММА(ВыручкаИСебестоимость.Стоимость
	|		+ ВыручкаИСебестоимость.ДопРасходы
	|		+ ВыручкаИСебестоимость.ПостатейныеПостоянныеСНДС
	|		+ ВыручкаИСебестоимость.ПостатейныеПеременныеСНДС
	|		+ ВыручкаИСебестоимость.Трудозатраты
	|		+ ВыручкаИСебестоимость.РасходыНаПродажуСНДС) <> 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ПрочаяВыручка.Подразделение                                  КАК Подразделение,
	|	ПрочаяВыручка.Организация                                    КАК Организация,
	|	ПрочаяВыручка.Партнер                                        КАК Партнер,
	|	ПрочаяВыручка.НаправлениеДеятельности                        КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                 КАК Номенклатура,
	|	ПрочаяВыручка.СтатьяДоходов                                  КАК СтатьяДоходов,
	|	НЕОПРЕДЕЛЕНО                                                 КАК СтатьяРасходов,
	|	СУММА(ПрочаяВыручка.ВыручкаБезНДСУпр + ПрочаяВыручка.НДСУпр) КАК СуммаВыручки,
	|	0                                                            КАК Себестоимость
	|ИЗ
	|	РегистрНакопления.ПрочаяВыручка КАК ПрочаяВыручка
	|ГДЕ
	|	ПрочаяВыручка.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ПрочаяВыручка.Организация В (&МассивОрганизаций)
	|	И ПрочаяВыручка.Активность
	|СГРУППИРОВАТЬ ПО
	|	ПрочаяВыручка.Подразделение,
	|	ПрочаяВыручка.Организация,
	|	ПрочаяВыручка.Партнер,
	|	ПрочаяВыручка.НаправлениеДеятельности,
	|	ПрочаяВыручка.СтатьяДоходов
	|
	|ИМЕЮЩИЕ
	|	СУММА(ПрочаяВыручка.ВыручкаБезНДСУпр + ПрочаяВыручка.НДСУпр) <> 0
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ТаблицаВыручки.Подразделение               КАК Подразделение,
	|	ТаблицаВыручки.Организация                 КАК Организация,
	|	ТаблицаВыручки.Номенклатура                КАК Номенклатура,
	|	ТаблицаВыручки.Партнер                     КАК Партнер,
	|	ТаблицаВыручки.НаправлениеДеятельности     КАК НаправлениеДеятельности,
	|	ТаблицаВыручки.СтатьяДоходов               КАК СтатьяДоходов,
	|	ТаблицаВыручки.СтатьяРасходов              КАК СтатьяРасходов,
	|	ТаблицаВыручки.СуммаВыручки                КАК СуммаВыручки,
	|	ТаблицаВыручки.Себестоимость               КАК Себестоимость,
	|	НастройкаРаспределения.СпособРаспределения КАК СпособРаспределения,
	|	ВЫБОР
	|		КОГДА ТаблицаВыручки.Партнер = НастройкаРаспределения.Партнер ТОГДА
	|			1000
	|		ИНАЧЕ 0
	|	КОНЕЦ + ВЫБОР
	|		КОГДА ТаблицаВыручки.Подразделение = НастройкаРаспределения.Подразделение ТОГДА
	|			100
	|		ИНАЧЕ
	|			0
	|	КОНЕЦ + ВЫБОР
	|		КОГДА ТаблицаВыручки.Номенклатура = НастройкаРаспределения.Номенклатура ТОГДА
	|			10
	|		ИНАЧЕ
	|			0
	|	КОНЕЦ + ВЫБОР
	|		КОГДА ТаблицаВыручки.Организация = НастройкаРаспределения.Организация ТОГДА
	|			1
	|		ИНАЧЕ
	|			0
	|	КОНЕЦ                                      КАК Приоритет
	|ПОМЕСТИТЬ ВтТаблицаРаспределения
	|
	|ИЗ
	|	ВТТаблицаВыручки КАК ТаблицаВыручки
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрСведений.НастройкаРаспределенияПоНаправлениямДеятельности.СрезПоследних(
	|			&КонецПериода,
	|		) КАК НастройкаРаспределения
	|		ПО
	|			НастройкаРаспределения.Используется
	|			И ТаблицаВыручки.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|			И (ТаблицаВыручки.Организация              = НастройкаРаспределения.Организация
	|				ИЛИ НастройкаРаспределения.Организация = ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка))
	|
	|			И (ТаблицаВыручки.Партнер              = НастройкаРаспределения.Партнер
	|				ИЛИ НастройкаРаспределения.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка))
	|
	|			И (ТаблицаВыручки.Подразделение              = НастройкаРаспределения.Подразделение
	|				ИЛИ НастройкаРаспределения.Подразделение = ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|
	|			И (ТаблицаВыручки.Номенклатура              = НастройкаРаспределения.Номенклатура
	|				ИЛИ НастройкаРаспределения.Номенклатура = ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	Партнер,
	|	Подразделение,
	|	Номенклатура
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ДокументыРасчетаСебестоимости.Ссылка 								 КАК ДокументДвижения,
	|	&КонецПериода                                                        КАК Период,
	|	ТаблицаФинансовыхРезультатов.Организация                             КАК Организация,
	|	ТаблицаФинансовыхРезультатов.Подразделение                           КАК Подразделение,
	|	ТаблицаФинансовыхРезультатов.СтатьяДоходов                           КАК СтатьяДоходов,
	|	ТаблицаФинансовыхРезультатов.СтатьяРасходов                          КАК СтатьяРасходов,
	|	ТаблицаФинансовыхРезультатов.СпособРаспределения                     КАК СпособРаспределения,
	|	СУММА(ТаблицаФинансовыхРезультатов.СуммаВыручки)                     КАК СуммаВыручки,
	|	СУММА(ТаблицаФинансовыхРезультатов.Себестоимость)                    КАК Себестоимость,
	|	ВЫБОР
	|		КОГДА ТаблицаФинансовыхРезультатов.СпособРаспределения ССЫЛКА Справочник.НаправленияДеятельности ТОГДА
	|			ТаблицаФинансовыхРезультатов.СпособРаспределения
	|		ИНАЧЕ
	|			СпособыРаспределения.НаправлениеДеятельности
	|	КОНЕЦ                                                                КАК НаправлениеДеятельности,
	|	ВЫБОР
	|		КОГДА ТаблицаФинансовыхРезультатов.СпособРаспределения ССЫЛКА Справочник.НаправленияДеятельности ТОГДА
	|			1
	|		ИНАЧЕ
	|			ЕСТЬNULL(СпособыРаспределения.Коэффициент, 1)
	|	КОНЕЦ                                                                КАК КоэффициентРаспределения
	|
	|ИЗ (
	|	ВЫБРАТЬ
	|		ТаблицаРаспределения.Организация                   КАК Организация,
	|		ТаблицаРаспределения.Подразделение                 КАК Подразделение,
	|		ТаблицаРаспределения.СтатьяДоходов                 КАК СтатьяДоходов,
	|		ТаблицаРаспределения.СтатьяРасходов                КАК СтатьяРасходов,
	|		СУММА(ТаблицаРаспределения.СуммаВыручки)           КАК СуммаВыручки,
	|		СУММА(ТаблицаРаспределения.Себестоимость)          КАК Себестоимость,
	|		ЕСТЬNULL(ТаблицаРаспределения.СпособРаспределения, НЕОПРЕДЕЛЕНО) КАК СпособРаспределения
	|	ИЗ
	|		ВтТаблицаРаспределения КАК ТаблицаРаспределения
	|
	|	ГДЕ
	|		ТаблицаРаспределения.НаправлениеДеятельности = ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|		И ТаблицаРаспределения.Приоритет В
	|				(ВЫБРАТЬ
	|					МАКСИМУМ(Таб.Приоритет) КАК Приоритет
	|				ИЗ
	|					ВтТаблицаРаспределения КАК Таб
	|				ГДЕ
	|					Таб.Организация        = ТаблицаРаспределения.Организация
	|					И Таб.Партнер            = ТаблицаРаспределения.Партнер
	|					И Таб.Подразделение      = ТаблицаРаспределения.Подразделение
	|					И Таб.Номенклатура         = ТаблицаРаспределения.Номенклатура)
	|	
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаРаспределения.Организация,
	|		ТаблицаРаспределения.Подразделение,
	|		ТаблицаРаспределения.СтатьяДоходов,
	|		ТаблицаРаспределения.СтатьяРасходов,
	|		ЕСТЬNULL(ТаблицаРаспределения.СпособРаспределения, НЕОПРЕДЕЛЕНО)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		ТаблицаРаспределения.Организация                   КАК Организация,
	|		ТаблицаРаспределения.Подразделение                 КАК Подразделение,
	|		ТаблицаРаспределения.СтатьяДоходов                 КАК СтатьяДоходов,
	|		ТаблицаРаспределения.СтатьяРасходов                КАК СтатьяРасходов,
	|		СУММА(ТаблицаРаспределения.СуммаВыручки)           КАК СуммаВыручки,
	|		СУММА(ТаблицаРаспределения.Себестоимость)          КАК Себестоимость,
	|		ТаблицаРаспределения.НаправлениеДеятельности       КАК СпособРаспределения
	|	ИЗ
	|		ВтТаблицаРаспределения КАК ТаблицаРаспределения
	|
	|	ГДЕ
	|		ТаблицаРаспределения.НаправлениеДеятельности <> ЗНАЧЕНИЕ(Справочник.НаправленияДеятельности.ПустаяСсылка)
	|
	|	СГРУППИРОВАТЬ ПО
	|		ТаблицаРаспределения.Организация,
	|		ТаблицаРаспределения.Подразделение,
	|		ТаблицаРаспределения.СтатьяДоходов,
	|		ТаблицаРаспределения.СтатьяРасходов,
	|		ТаблицаРаспределения.НаправлениеДеятельности
	|
	|	) КАК ТаблицаФинансовыхРезультатов
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		Справочник.СпособыРаспределенияПоНаправлениямДеятельности.НаправленияДеятельности КАК СпособыРаспределения
	|		ПО ТаблицаФинансовыхРезультатов.СпособРаспределения = СпособыРаспределения.Ссылка
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТДокументыРасчетаСебестоимости КАК ДокументыРасчетаСебестоимости
	|		ПО ТаблицаФинансовыхРезультатов.Организация = ДокументыРасчетаСебестоимости.Организация
	|	
	|СГРУППИРОВАТЬ ПО
	|	ДокументыРасчетаСебестоимости.Ссылка,
	|	ТаблицаФинансовыхРезультатов.Организация,
	|	ТаблицаФинансовыхРезультатов.Подразделение,
	|	ТаблицаФинансовыхРезультатов.СтатьяДоходов,
	|	ТаблицаФинансовыхРезультатов.СтатьяРасходов,
	|	ТаблицаФинансовыхРезультатов.СпособРаспределения,
	|	ВЫБОР
	|		КОГДА ТаблицаФинансовыхРезультатов.СпособРаспределения ССЫЛКА Справочник.НаправленияДеятельности ТОГДА
	|			ТаблицаФинансовыхРезультатов.СпособРаспределения
	|		ИНАЧЕ
	|			СпособыРаспределения.НаправлениеДеятельности
	|	КОНЕЦ,
	|	ВЫБОР
	|		КОГДА ТаблицаФинансовыхРезультатов.СпособРаспределения ССЫЛКА Справочник.НаправленияДеятельности ТОГДА
	|			1
	|		ИНАЧЕ
	|			ЕСТЬNULL(СпособыРаспределения.Коэффициент, 1)
	|	КОНЕЦ
	|
	|ИТОГИ
	|	МАКСИМУМ(СуммаВыручки),
	|	МАКСИМУМ(Себестоимость),
	|	СУММА(КоэффициентРаспределения)
	|
	|ПО
	|	Организация,
	|	Подразделение,
	|	СтатьяДоходов,
	|	СпособРаспределения
	|";
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ФинансовыеРезультаты.Имя;
	
	РезультатЗапроса = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос,,, Истина);
	ВыборкаОрганизация = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Организация");
	
	Пока ВыборкаОрганизация.Следующий() Цикл
		
		ВыборкаПодразделение = ВыборкаОрганизация.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Подразделение");
		
		Пока ВыборкаПодразделение.Следующий() Цикл
			
			ВыборкаСтатье = ВыборкаПодразделение.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "СтатьяДоходов");
			Пока ВыборкаСтатье.Следующий() Цикл
			
				ВыборкаСпособыРаспределения = ВыборкаСтатье.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "СпособРаспределения");
				Пока ВыборкаСпособыРаспределения.Следующий() Цикл
					
					ВсегоДолей            = ВыборкаСпособыРаспределения.КоэффициентРаспределения;
					РасходыКРаспределению = ВыборкаСпособыРаспределения.Себестоимость;
					ДоходыКРаспределению  = ВыборкаСпособыРаспределения.СуммаВыручки;
					
					ВыборкаДетали = ВыборкаСпособыРаспределения.Выбрать(ОбходРезультатаЗапроса.Прямой);
					
					РасчетСебестоимостиПротоколРасчета.УвеличитьКоличествоОбработанныхДанныхДляЗамера(
						ПараметрыРасчета,
						ВыборкаДетали.Количество());
					
					КопируемыеПоля = "Период, Организация, Подразделение, НаправлениеДеятельности, СпособРаспределения";
					
					Пока ВыборкаДетали.Следующий() Цикл
	
						Если ВсегоДолей <> 0 Тогда
							Расходы = Окр(РасходыКРаспределению * ВыборкаДетали.КоэффициентРаспределения / ВсегоДолей,
											2, РежимОкругления.Окр15как20);
						Иначе
							Расходы = 0;
						КонецЕсли;
	
						Если ВсегоДолей <> 0 Тогда
							Доходы = Окр(ДоходыКРаспределению * ВыборкаДетали.КоэффициентРаспределения / ВсегоДолей,
											2, РежимОкругления.Окр15как20);
						Иначе
							Доходы = 0;
						КонецЕсли;
	
						РасходыКРаспределению = РасходыКРаспределению - Расходы;
						ДоходыКРаспределению  = ДоходыКРаспределению  - Доходы;
						ВсегоДолей            = ВсегоДолей            - ВыборкаДетали.КоэффициентРаспределения;
	
						// Формирование движений по финансовому результату.
						ДанныеДвижения = Новый Структура(КопируемыеПоля + ", ДокументДвижения");
						ТекущиеПоля    = КопируемыеПоля;
						
						ЗаполнитьЗначенияСвойств(ДанныеДвижения, ВыборкаДетали);
						
						Если Доходы <> 0 Тогда
							ДанныеДвижения.Вставить("Доходы", 		 Доходы);
							ДанныеДвижения.Вставить("СтатьяДоходов", ВыборкаДетали.СтатьяДоходов);
							ТекущиеПоля = ТекущиеПоля + ", Доходы, СтатьяДоходов";
						КонецЕсли;
	
						Если Расходы <> 0 Тогда
							ДанныеДвижения.Вставить("Расходы", 		  Расходы);
							ДанныеДвижения.Вставить("СтатьяРасходов", ВыборкаДетали.СтатьяРасходов);
							ТекущиеПоля = ТекущиеПоля + ", Расходы, СтатьяРасходов";
						КонецЕсли;
						
						ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, ТекущиеПоля);
						
					КонецЦикла;
					
				КонецЦикла;
				
			КонецЦикла;
			
		КонецЦикла;
		
	КонецЦикла;

	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТТаблицаВыручки, ВтТаблицаРаспределения");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);

КонецПроцедуры

// Этап 4.3
Процедура ОтразитьПрибылиИУбытки(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ОтразитьПрибылиИУбытки");
	
	МенеджерВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьМенеджерВТИзКонтейнера(ПараметрыРасчета);
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Если МенеджерВТ.Таблицы.Найти("ИсправленныеДокументы") = Неопределено Тогда 
		Запрос.Текст = РасчетСебестоимостиЗаполнениеПартий.ТекстИсправленныеДокументы() + "; ";
	КонецЕсли;
	
	Запрос.Текст = Запрос.Текст + " 
	|ВЫБРАТЬ
	|	ВыручкаИСебестоимость.Регистратор 							КАК Регистратор,
	|	ВыручкаИСебестоимость.Период 								КАК Период,
	|	ВыручкаИСебестоимость.АналитикаУчетаПоПартнерам				КАК АналитикаУчетаПоПартнерам,
	|	ВыручкаИСебестоимость.АналитикаУчетаНоменклатуры			КАК АналитикаУчетаНоменклатуры,
	|	ВыручкаИСебестоимость.НаправлениеДеятельностиКонтрагента	КАК НаправлениеДеятельностиКонтрагента,
	|	ВыручкаИСебестоимость.НаправлениеДеятельностиНоменклатуры	КАК НаправлениеДеятельностиНоменклатуры,
	|	ВыручкаИСебестоимость.Подразделение	КАК Подразделение,
	|	ВыручкаИСебестоимость.Сторно		КАК Сторно,
	|	ВыручкаИСебестоимость.ТипЗапасов	КАК ТипЗапасов,
	|	ВыручкаИСебестоимость.СуммаВыручки	КАК СуммаВыручки,
	|	ВыручкаИСебестоимость.Стоимость		КАК Стоимость,
	|	ВыручкаИСебестоимость.ДопРасходы	КАК ДопРасходы,
	|	ВыручкаИСебестоимость.Трудозатраты	КАК Трудозатраты,
	|	ВыручкаИСебестоимость.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	ВыручкаИСебестоимость.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	ВыручкаИСебестоимость.РасходыНаПродажуСНДС КАК РасходыНаПродажуСНДС,
	|	ВыручкаИСебестоимость.СуммаАкцизаУпр КАК СуммаАкцизаУпр,
	|	ВыручкаИСебестоимость.РасчетПартий КАК РасчетПартий,
	|	ВыручкаИСебестоимость.ХозяйственнаяОперация КАК ХозяйственнаяОперация
	|
	|ПОМЕСТИТЬ ВТПредварительнаяОборотыВыручкаИСебестоимостьПродаж
	|ИЗ
	|	ВТКэшРасчетныеОборотыВыручкаИСебестоимостьПродаж КАК ВыручкаИСебестоимость
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|			ПО ИсправленныеДокументы.Регистратор = ВыручкаИСебестоимость.Регистратор
	|ГДЕ
	|	ТИПЗНАЧЕНИЯ(ВыручкаИСебестоимость.Регистратор) <> ТИП(Документ.ВводОстатковОПродажахЗаПрошлыеПериоды)
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеСебестоимостьТоваров
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаСторнируемогоДокумента ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|		И ВыручкаИСебестоимость.Сторно)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	АналитикаУчетаПоПартнерам
	|;
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) 			КАК ВидДвижения,
	|	ВыручкаИСебестоимость.ДокументДвижения			КАК ДокументДвижения,
	|	ВыручкаИСебестоимость.Период					КАК Период,
	|	ВыручкаИСебестоимость.Организация				КАК Организация,
	|	ВыручкаИСебестоимость.Подразделение				КАК Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности 	КАК НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно					КАК Сторно,
	|	СУММА(ВыручкаИСебестоимость.Сумма)				КАК Сумма
	|ПОМЕСТИТЬ ВТПромежуточнаяТаблица1
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВыручкаИСебестоимость.Регистратор 							КАК ДокументДвижения,
	|		ВыручкаИСебестоимость.Период 								КАК Период,
	|		АналитикаПоПартнерам.Организация                			КАК Организация,
	|		ВыручкаИСебестоимость.НаправлениеДеятельностиКонтрагента 	КАК НаправлениеДеятельности,
	|		ВыручкаИСебестоимость.Подразделение							КАК Подразделение,
	|		ВыручкаИСебестоимость.Сторно								КАК Сторно,
	|		ВЫБОР КОГДА ВыручкаИСебестоимость.ТипЗапасов В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияПереработчика),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга))
	|		ТОГДА
	|			ВыручкаИСебестоимость.СуммаВыручки
	|		ИНАЧЕ
	|			0
	|		КОНЕЦ 														КАК Сумма
	|	ИЗ
	|		ВТПредварительнаяОборотыВыручкаИСебестоимостьПродаж КАК ВыручкаИСебестоимость
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПоПартнерам
	|				ПО ВыручкаИСебестоимость.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
	|	) КАК ВыручкаИСебестоимость
	|
	|СГРУППИРОВАТЬ ПО
	|	ВыручкаИСебестоимость.ДокументДвижения,
	|	ВыручкаИСебестоимость.Период,
	|	ВыручкаИСебестоимость.Организация,
	|	ВыручкаИСебестоимость.Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 			КАК ВидДвижения,
	|	ВыручкаИСебестоимость.ДокументДвижения			КАК ДокументДвижения,
	|	ВыручкаИСебестоимость.Период					КАК Период,
	|	ВыручкаИСебестоимость.Организация				КАК Организация,
	|	ВыручкаИСебестоимость.Подразделение				КАК Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности 	КАК НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно					КАК Сторно,
	|	СУММА(ВыручкаИСебестоимость.Сумма)				КАК Сумма
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВыручкаИСебестоимость.Регистратор 						  КАК ДокументДвижения,
	|		ВыручкаИСебестоимость.Период 							  КАК Период,
	|		АналитикаПоПартнерам.Организация 						  КАК Организация,
	|		ВыручкаИСебестоимость.Подразделение						  КАК Подразделение,
	|		ВыручкаИСебестоимость.НаправлениеДеятельностиНоменклатуры КАК НаправлениеДеятельности,
	|		ВыручкаИСебестоимость.Сторно							  КАК Сторно,
	|		ВЫБОР КОГДА ВыручкаИСебестоимость.ТипЗапасов В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияПереработчика),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга))
	|		ТОГДА
	|			ВыручкаИСебестоимость.Стоимость
	|			+ ВыручкаИСебестоимость.ДопРасходы
	|			+ ВыручкаИСебестоимость.Трудозатраты
	|			+ ВыручкаИСебестоимость.ПостатейныеПостоянныеСНДС
	|			+ ВыручкаИСебестоимость.ПостатейныеПеременныеСНДС
	|			+ ВыручкаИСебестоимость.РасходыНаПродажуСНДС
	|			+ ВыручкаИСебестоимость.СуммаАкцизаУпр
	|		ИНАЧЕ
	|			ВыручкаИСебестоимость.ДопРасходы
	|			+ ВыручкаИСебестоимость.РасходыНаПродажуСНДС
	|		КОНЕЦ 													  КАК Сумма
	|	ИЗ
	|		ВТПредварительнаяОборотыВыручкаИСебестоимостьПродаж КАК ВыручкаИСебестоимость
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТОтборАналитикаПоПартнерам КАК АналитикаПоПартнерам
	|				ПО ВыручкаИСебестоимость.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
	|	) КАК ВыручкаИСебестоимость
	|
	|СГРУППИРОВАТЬ ПО
	|	ВыручкаИСебестоимость.ДокументДвижения,
	|	ВыручкаИСебестоимость.Период,
	|	ВыручкаИСебестоимость.Организация,
	|	ВыручкаИСебестоимость.Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 			КАК ВидДвижения,
	|	ВыручкаИСебестоимость.ДокументДвижения			КАК ДокументДвижения,
	|	ВыручкаИСебестоимость.Период					КАК Период,
	|	ВыручкаИСебестоимость.Контрагент				КАК Организация,
	|	ВыручкаИСебестоимость.Подразделение				КАК Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно					КАК Сторно,
	|	СУММА(ВыручкаИСебестоимость.Сумма)				КАК Сумма
	|ПОМЕСТИТЬ ВТПромежуточнаяТаблица2
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВыручкаИСебестоимость.Регистратор 							КАК ДокументДвижения,
	|		ВыручкаИСебестоимость.Период					  			КАК Период,
	|		АналитикаПоПартнерам.Контрагент                				КАК Контрагент,
	|		ВыручкаИСебестоимость.Подразделение							КАК Подразделение,
	|		ВыручкаИСебестоимость.НаправлениеДеятельностиКонтрагента 	КАК НаправлениеДеятельности,
	|		ВыручкаИСебестоимость.Сторно								КАК Сторно,
	|		ВыручкаИСебестоимость.СуммаВыручки							КАК Сумма
	|	ИЗ
	|		ВТПредварительнаяОборотыВыручкаИСебестоимостьПродаж КАК ВыручкаИСебестоимость
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПоПартнерам
	|			ПО
	|				ВыручкаИСебестоимость.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
	|				И АналитикаПоПартнерам.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)
	|				И АналитикаПоПартнерам.Контрагент ССЫЛКА Справочник.Организации
	|				И АналитикаПоПартнерам.Контрагент <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|
	|	ГДЕ
	|		ВыручкаИСебестоимость.ТипЗапасов В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияПереработчика),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|		И ВЫРАЗИТЬ(ВыручкаИСебестоимость.АналитикаУчетаНоменклатуры КАК Справочник.КлючиАналитикиУчетаНоменклатуры).Номенклатура.ТипНоменклатуры
	|			<> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|		И АналитикаПоПартнерам.Контрагент В (&МассивОрганизаций)
	|		И НЕ ВыручкаИСебестоимость.РасчетПартий
	|		И ВыручкаИСебестоимость.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|		И ТИПЗНАЧЕНИЯ(ВыручкаИСебестоимость.Регистратор) <> ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	// Для организаций на среднескользящей передача товаров между организациями отражается по стоимости из документа,
	// поэтому прибылей и убыткой у получателя не возникает.
	|		И НЕ АналитикаПоПартнерам.Контрагент В (&ОрганизацииСреднескользящая)
	|   ) КАК ВыручкаИСебестоимость
	|
	|СГРУППИРОВАТЬ ПО
	|	ВыручкаИСебестоимость.ДокументДвижения,
	|	ВыручкаИСебестоимость.Период,
	|	ВыручкаИСебестоимость.Контрагент,
	|	ВыручкаИСебестоимость.Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) 			КАК ВидДвижения,
	|	ВыручкаИСебестоимость.ДокументДвижения			КАК ДокументДвижения,
	|	ВыручкаИСебестоимость.Период					КАК Период,
	|	ВыручкаИСебестоимость.Контрагент				КАК Организация,
	|	ВыручкаИСебестоимость.Подразделение				КАК Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно					КАК Сторно,
	|	СУММА(ВыручкаИСебестоимость.Сумма)				КАК Сумма
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВыручкаИСебестоимость.Регистратор 							КАК ДокументДвижения,
	|		ВыручкаИСебестоимость.Период					  			КАК Период,
	|		АналитикаПоПартнерам.Контрагент                				КАК Контрагент,
	|		ВыручкаИСебестоимость.Подразделение							КАК Подразделение,
	|		ВыручкаИСебестоимость.НаправлениеДеятельностиНоменклатуры 	КАК НаправлениеДеятельности,
	|		ВыручкаИСебестоимость.Сторно								КАК Сторно,
	|		ВыручкаИСебестоимость.Стоимость
	|			+ ВыручкаИСебестоимость.ДопРасходы 
	|			+ ВыручкаИСебестоимость.Трудозатраты
	|			+ ВыручкаИСебестоимость.ПостатейныеПостоянныеСНДС
	|			+ ВыручкаИСебестоимость.ПостатейныеПеременныеСНДС
	|			+ ВыручкаИСебестоимость.РасходыНаПродажуСНДС
	|			+ ВыручкаИСебестоимость.СуммаАкцизаУпр КАК Сумма
	|	ИЗ
	|		ВТПредварительнаяОборотыВыручкаИСебестоимостьПродаж КАК ВыручкаИСебестоимость
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПоПартнерам
	|			ПО
	|				ВыручкаИСебестоимость.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
	|				И АналитикаПоПартнерам.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)
	|				И АналитикаПоПартнерам.Контрагент ССЫЛКА Справочник.Организации
	|				И АналитикаПоПартнерам.Контрагент <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|
	|	ГДЕ
	|		ВыручкаИСебестоимость.ТипЗапасов В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияПереработчика),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|		И АналитикаПоПартнерам.Контрагент В (&МассивОрганизаций)
	|		И НЕ ВыручкаИСебестоимость.РасчетПартий
	|		И ВыручкаИСебестоимость.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|		И ТИПЗНАЧЕНИЯ(ВыручкаИСебестоимость.Регистратор) <> ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	// Для организаций на среднескользящей передача товаров между организациями отражается по стоимости из документа,
	// поэтому прибылей и убыткой у получателя не возникает.
	|		И НЕ АналитикаПоПартнерам.Контрагент В (&ОрганизацииСреднескользящая)
	|	) КАК ВыручкаИСебестоимость
	|
	|СГРУППИРОВАТЬ ПО
	|	ВыручкаИСебестоимость.ДокументДвижения,
	|	ВыручкаИСебестоимость.Период,
	|	ВыручкаИСебестоимость.Контрагент,
	|	ВыручкаИСебестоимость.Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 			КАК ВидДвижения,
	|	ВыручкаИСебестоимость.ДокументДвижения			КАК ДокументДвижения,
	|	ВыручкаИСебестоимость.Период					КАК Период,
	|	ВыручкаИСебестоимость.Контрагент				КАК Организация,
	|	ВыручкаИСебестоимость.Подразделение				КАК Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно					КАК Сторно,
	|	СУММА(ВыручкаИСебестоимость.Сумма)				КАК Сумма
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВыручкаИСебестоимость.Регистратор 							КАК ДокументДвижения,
	|		ВыручкаИСебестоимость.Период					  			КАК Период,
	|		АналитикаПоПартнерам.Контрагент                				КАК Контрагент,
	|		ВыручкаИСебестоимость.Подразделение							КАК Подразделение,
	|		ВыручкаИСебестоимость.НаправлениеДеятельностиКонтрагента 	КАК НаправлениеДеятельности,
	|		ВыручкаИСебестоимость.Сторно								КАК Сторно,
	|		ВыручкаИСебестоимость.СуммаВыручки							КАК Сумма
	|	ИЗ
	|		РегистрНакопления.ВыручкаИСебестоимостьПродаж КАК ВыручкаИСебестоимость
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПоПартнерам
	|			ПО
	|				ВыручкаИСебестоимость.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
	|				И АналитикаПоПартнерам.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)
	|				И АналитикаПоПартнерам.Контрагент ССЫЛКА Справочник.Организации
	|				И АналитикаПоПартнерам.Контрагент <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|
	|	ГДЕ
	|		ВыручкаИСебестоимость.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ВыручкаИСебестоимость.Активность
	|		И ВыручкаИСебестоимость.ТипЗапасов В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияПереработчика),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|		И ВыручкаИСебестоимость.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры
	|			<> ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|		И АналитикаПоПартнерам.Контрагент В (&МассивОрганизаций)
	|		И НЕ АналитикаПоПартнерам.Организация В (&МассивОрганизаций)
	|		И НЕ ВыручкаИСебестоимость.РасчетПартий
	|		И ВыручкаИСебестоимость.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|		И ТИПЗНАЧЕНИЯ(ВыручкаИСебестоимость.Регистратор) <> ТИП(Документ.ВводОстатковОПродажахЗаПрошлыеПериоды)
	|		И ТИПЗНАЧЕНИЯ(ВыручкаИСебестоимость.Регистратор) <> ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	// Для организаций на среднескользящей передача товаров между организациями отражается по стоимости из документа,
	// поэтому прибылей и убыткой у получателя не возникает.
	|		И НЕ АналитикаПоПартнерам.Контрагент В (&ОрганизацииСреднескользящая)
	|   ) КАК ВыручкаИСебестоимость
	|
	|СГРУППИРОВАТЬ ПО
	|	ВыручкаИСебестоимость.ДокументДвижения,
	|	ВыручкаИСебестоимость.Период,
	|	ВыручкаИСебестоимость.Контрагент,
	|	ВыручкаИСебестоимость.Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) 			КАК ВидДвижения,
	|	ВыручкаИСебестоимость.ДокументДвижения			КАК ДокументДвижения,
	|	ВыручкаИСебестоимость.Период					КАК Период,
	|	ВыручкаИСебестоимость.Контрагент				КАК Организация,
	|	ВыручкаИСебестоимость.Подразделение				КАК Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности	КАК НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно					КАК Сторно,
	|	СУММА(ВыручкаИСебестоимость.Сумма)				КАК Сумма
	|ИЗ
	|	(ВЫБРАТЬ
	|		ВыручкаИСебестоимость.Регистратор 							КАК ДокументДвижения,
	|		ВыручкаИСебестоимость.Период					  			КАК Период,
	|		АналитикаПоПартнерам.Контрагент                				КАК Контрагент,
	|		ВыручкаИСебестоимость.Подразделение							КАК Подразделение,
	|		ВыручкаИСебестоимость.НаправлениеДеятельностиНоменклатуры 	КАК НаправлениеДеятельности,
	|		ВыручкаИСебестоимость.Сторно								КАК Сторно,
	|		ВыручкаИСебестоимость.Стоимость
	|			+ ВыручкаИСебестоимость.ДопРасходы
	|			+ ВыручкаИСебестоимость.Трудозатраты
	|			+ ВыручкаИСебестоимость.ПостатейныеПостоянныеСНДС
	|			+ ВыручкаИСебестоимость.ПостатейныеПеременныеСНДС
	|			+ ВыручкаИСебестоимость.РасходыНаПродажуСНДС КАК Сумма
	|	ИЗ
	|		РегистрНакопления.ВыручкаИСебестоимостьПродаж КАК ВыручкаИСебестоимость
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.АналитикаУчетаПоПартнерам КАК АналитикаПоПартнерам
	|			ПО
	|				ВыручкаИСебестоимость.АналитикаУчетаПоПартнерам = АналитикаПоПартнерам.КлючАналитики
	|				И АналитикаПоПартнерам.Партнер = ЗНАЧЕНИЕ(Справочник.Партнеры.НашеПредприятие)
	|				И АналитикаПоПартнерам.Контрагент ССЫЛКА Справочник.Организации
	|				И АналитикаПоПартнерам.Контрагент <> ЗНАЧЕНИЕ(Справочник.Организации.ПустаяСсылка)
	|
	|	ГДЕ
	|		ВыручкаИСебестоимость.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ВыручкаИСебестоимость.Активность
	|		И ВыручкаИСебестоимость.ТипЗапасов В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПродукцияПереработчика),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.ПолуфабрикатДавальца),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|		И АналитикаПоПартнерам.Контрагент В (&МассивОрганизаций)
	|		И НЕ АналитикаПоПартнерам.Организация В (&МассивОрганизаций)
	|		И НЕ ВыручкаИСебестоимость.РасчетПартий
	|		И ВыручкаИСебестоимость.ХозяйственнаяОперация <> ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ОтчетКомиссионера)
	|		И ТИПЗНАЧЕНИЯ(ВыручкаИСебестоимость.Регистратор) <> ТИП(Документ.ВводОстатковОПродажахЗаПрошлыеПериоды)
	|		И ТИПЗНАЧЕНИЯ(ВыручкаИСебестоимость.Регистратор) <> ТИП(Документ.ВозвратТоваровМеждуОрганизациями)
	// Для организаций на среднескользящей передача товаров между организациями отражается по стоимости из документа,
	// поэтому прибылей и убыткой у получателя не возникает.
	|		И НЕ АналитикаПоПартнерам.Контрагент В (&ОрганизацииСреднескользящая)
	|   ) КАК ВыручкаИСебестоимость
	|
	|СГРУППИРОВАТЬ ПО
	|	ВыручкаИСебестоимость.ДокументДвижения,
	|	ВыручкаИСебестоимость.Период,
	|	ВыручкаИСебестоимость.Контрагент,
	|	ВыручкаИСебестоимость.Подразделение,
	|	ВыручкаИСебестоимость.НаправлениеДеятельности,
	|	ВыручкаИСебестоимость.Сторно
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)	 КАК ВидДвижения,
	|	ПрочиеДоходы.Регистратор				 КАК ДокументДвижения,
	|	ПрочиеДоходы.Период						 КАК Период,
	|	ПрочиеДоходы.Организация				 КАК Организация,
	|	ПрочиеДоходы.Подразделение				 КАК Подразделение,
	|	ПрочиеДоходы.НаправлениеДеятельности	 КАК НаправлениеДеятельности,
	|	ПрочиеДоходы.Сторно						 КАК Сторно,
	|	СУММА(ПрочиеДоходы.Сумма)				 КАК Сумма
	|ПОМЕСТИТЬ ВТПромежуточнаяТаблица3
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеДоходы КАК ПрочиеДоходы
	|ГДЕ
	|	НЕ &ФормироватьФинансовыйРезультат
	|	И ПрочиеДоходы.РасчетСебестоимости
	|	И НЕ ПрочиеДоходы.СлужебноеВидДвиженияПриход
	|
	|СГРУППИРОВАТЬ ПО
	|	ПрочиеДоходы.Регистратор,
	|	ПрочиеДоходы.Период,
	|	ПрочиеДоходы.Организация,
	|	ПрочиеДоходы.Подразделение,
	|	ПрочиеДоходы.НаправлениеДеятельности,
	|	ПрочиеДоходы.Сторно
	|
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)	  КАК ВидДвижения,
	|	ПрочиеРасходы.Регистратор				  КАК ДокументДвижения,
	|	ПрочиеРасходы.Период					  КАК Период,
	|	ПрочиеРасходы.Организация				  КАК Организация,
	|	ПрочиеРасходы.Подразделение				  КАК Подразделение,
	|	ПрочиеРасходы.НаправлениеДеятельности	  КАК НаправлениеДеятельности,
	|	ПрочиеРасходы.Сторно					  КАК Сторно,
	|	СУММА(ПрочиеРасходы.Сумма) 			      КАК Сумма
	|ПОМЕСТИТЬ ВТПромежуточнаяТаблица4
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеРасходы КАК ПрочиеРасходы
	|ГДЕ
	|	НЕ &ФормироватьФинансовыйРезультат
	|	И ПрочиеРасходы.РасчетСебестоимости
	|	И НЕ ПрочиеРасходы.СлужебноеВидДвиженияПриход
	|	И ПрочиеРасходы.СтатьяРасходов.ВариантРаспределенияРасходовУпр
	|		= ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности)
	|
	|СГРУППИРОВАТЬ ПО
	|	ПрочиеРасходы.Регистратор,
	|	ПрочиеРасходы.Период,
	|	ПрочиеРасходы.Организация,
	|	ПрочиеРасходы.Подразделение,
	|	ПрочиеРасходы.НаправлениеДеятельности,
	|	ПрочиеРасходы.Сторно
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)	  КАК ВидДвижения,
	|	ПрочаяВыручка.Регистратор				  КАК ДокументДвижения,
	|	ПрочаяВыручка.Период					  КАК Период,
	|	ПрочаяВыручка.Организация				  КАК Организация,
	|	ПрочаяВыручка.Подразделение				  КАК Подразделение,
	|	ПрочаяВыручка.НаправлениеДеятельности	  КАК НаправлениеДеятельности,
	|	ПрочаяВыручка.Сторно					  КАК Сторно,
	|	СУММА(ПрочаяВыручка.ВыручкаБезНДСУпр + ПрочаяВыручка.НДСУпр) КАК Сумма
	|ПОМЕСТИТЬ ВТПромежуточнаяТаблица5
	|ИЗ
	|	РегистрНакопления.ПрочаяВыручка КАК ПрочаяВыручка
	|ГДЕ
	|	ПрочаяВыручка.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ПрочаяВыручка.Активность
	|	И ПрочаяВыручка.Организация В (&МассивОрганизаций)
	|
	|СГРУППИРОВАТЬ ПО
	|	ПрочаяВыручка.Регистратор,
	|	ПрочаяВыручка.Период,
	|	ПрочаяВыручка.Организация,
	|	ПрочаяВыручка.Подразделение,
	|	ПрочаяВыручка.НаправлениеДеятельности,
	|	ПрочаяВыручка.Сторно
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ДанныеДвижений.ДокументДвижения 	 								  КАК ДокументДвижения,
	|	ДанныеДвижений.Период				 								  КАК Период,
	|	ДанныеДвижений.Организация			 								  КАК Организация,
	|	ДанныеДвижений.Подразделение			 							  КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО			 											  КАК Аналитика,
	|	ДанныеДвижений.НаправлениеДеятельности			 					  КАК НаправлениеДеятельности,
	|	ДанныеДвижений.ВидДвижения			 								  КАК ВидДвижения,
	|	ДанныеДвижений.Сторно												  КАК Сторно,
	|	ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиАктивовПассивов.ПрибылиИУбытки) КАК Статья,
	|	СУММА(ДанныеДвижений.Сумма)			 								  КАК Сумма
	|ПОМЕСТИТЬ ВТДанныеДляФормированияДвижений
	|ИЗ
	|
	|	(ВЫБРАТЬ
	|		Т.ДокументДвижения						КАК ДокументДвижения,
	|		Т.Период								КАК Период,
	|		Т.ВидДвижения 							КАК ВидДвижения,
	|		Т.Организация							КАК Организация,
	|		Т.Подразделение							КАК Подразделение,
	|		Т.НаправлениеДеятельности				КАК НаправлениеДеятельности,
	|		Т.Сторно								КАК Сторно,
	|		Т.Сумма									КАК Сумма
	|	ИЗ
	|		ВТПромежуточнаяТаблица1 КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.ДокументДвижения						КАК ДокументДвижения,
	|		Т.Период								КАК Период,
	|		Т.ВидДвижения 							КАК ВидДвижения,
	|		Т.Организация							КАК Организация,
	|		Т.Подразделение							КАК Подразделение,
	|		Т.НаправлениеДеятельности				КАК НаправлениеДеятельности,
	|		Т.Сторно								КАК Сторно,
	|		Т.Сумма									КАК Сумма
	|	ИЗ
	|		ВТПромежуточнаяТаблица2 КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.ДокументДвижения						КАК ДокументДвижения,
	|		Т.Период								КАК Период,
	|		Т.ВидДвижения 							КАК ВидДвижения,
	|		Т.Организация							КАК Организация,
	|		Т.Подразделение							КАК Подразделение,
	|		Т.НаправлениеДеятельности				КАК НаправлениеДеятельности,
	|		Т.Сторно								КАК Сторно,
	|		Т.Сумма									КАК Сумма
	|	ИЗ
	|		ВТПромежуточнаяТаблица3 КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.ДокументДвижения						КАК ДокументДвижения,
	|		Т.Период								КАК Период,
	|		Т.ВидДвижения 							КАК ВидДвижения,
	|		Т.Организация							КАК Организация,
	|		Т.Подразделение							КАК Подразделение,
	|		Т.НаправлениеДеятельности				КАК НаправлениеДеятельности,
	|		Т.Сторно								КАК Сторно,
	|		Т.Сумма									КАК Сумма
	|	ИЗ
	|		ВТПромежуточнаяТаблица4 КАК Т
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Т.ДокументДвижения						КАК ДокументДвижения,
	|		Т.Период								КАК Период,
	|		Т.ВидДвижения 							КАК ВидДвижения,
	|		Т.Организация							КАК Организация,
	|		Т.Подразделение							КАК Подразделение,
	|		Т.НаправлениеДеятельности				КАК НаправлениеДеятельности,
	|		Т.Сторно								КАК Сторно,
	|		Т.Сумма									КАК Сумма
	|	ИЗ
	|		ВТПромежуточнаяТаблица5 КАК Т
	|
	|	) КАК ДанныеДвижений
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеДвижений.ДокументДвижения,
	|	ДанныеДвижений.Период,
	|	ДанныеДвижений.Организация,
	|	ДанныеДвижений.Подразделение,
	|	ДанныеДвижений.НаправлениеДеятельности,
	|	ДанныеДвижений.ВидДвижения,
	|	ДанныеДвижений.Сторно
	|
	|ИМЕЮЩИЕ
	|	СУММА(ДанныеДвижений.Сумма) <> 0
	|";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина, "ВТДанныеДляФормированияДвижений");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьДвиженияПоРегиструПоДаннымВременнойТаблицы(
		ПараметрыРасчета,
		Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя,
		"ВТДанныеДляФормированияДвижений",
		Истина);
		
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
		"ВТПромежуточнаяТаблица1, ВТПромежуточнаяТаблица2, ВТПромежуточнаяТаблица3, ВТПромежуточнаяТаблица4,
		| ВТПромежуточнаяТаблица5, ВТПредварительнаяОборотыВыручкаИСебестоимостьПродаж");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

// Этап 4.4
Процедура ОтразитьВУправленческомБалансе(ПараметрыРасчета) Экспорт
	
	РасчетСебестоимостиПротоколРасчета.НачалоЭтапаРасчета(ПараметрыРасчета, "ОтразитьВУправленческомБалансе");
	
	// Дополним перечень измененных документов документами внеоборотных активов.
	// Для полученного перечня документов установим признак необходимости повторного отражения в учете.
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	СуществующиеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета);
	
	#Область ИсправленныеДокументы
	Запрос.Текст = РасчетСебестоимостиЗаполнениеПартий.ТекстИсправленныеДокументы(); // вт ИсправленныеДокументы
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина);
	#КонецОбласти
	
	#Область ТекстЗапросаУправленческогоБаланса
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТоварыОрганизаций.АналитикаРасходов КАК Объект
	|ПОМЕСТИТЬ ВТВнеоборотныеАктивы
	|ИЗ
	|	РегистрНакопления.ТоварыОрганизаций КАК ТоварыОрганизаций
	|ГДЕ
	|	ТоварыОрганизаций.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И ТоварыОрганизаций.Активность
	|	И ТоварыОрганизаций.СтатьяРасходов.ВариантРаспределенияРасходовУпр
	|		= ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|	И ТоварыОрганизаций.Организация В(&МассивОрганизаций)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СебестоимостьТоваров.АналитикаРасходов
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК СебестоимостьТоваров
	|ГДЕ
	|	СебестоимостьТоваров.СтатьяРасходовСписания.ВариантРаспределенияРасходовУпр
	|		= ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.РазделУчета КАК РазделУчета,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Т.АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
	|	Т.Стоимость КАК Стоимость,
	|	Т.ДопРасходы КАК ДопРасходы,
	|	Т.Трудозатраты КАК Трудозатраты,
	|	Т.ПостатейныеПостоянныеСНДС КАК ПостатейныеПостоянныеСНДС,
	|	Т.ПостатейныеПеременныеСНДС КАК ПостатейныеПеременныеСНДС,
	|	Т.РасчетСебестоимости КАК РасчетСебестоимости,
	|	Т.РасчетПартий КАК РасчетПартий,
	|	Т.Сторно КАК Сторно
	|ПОМЕСТИТЬ ВТСебестоимость
	|ИЗ
	|	ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = Т.Регистратор
	|ГДЕ
	|	Т.Стоимость + Т.ДопРасходы + Т.Трудозатраты + Т.ПостатейныеПостоянныеСНДС + Т.ПостатейныеПеременныеСНДС <> 0
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеПрочиеАктивыПассивы
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаСторнируемогоДокумента ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|		И Т.Сторно)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ВидЗапасов,
	|	АналитикаУчетаНоменклатуры
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.КорПодразделение КАК КорПодразделение,
	|	Т.ВидЗапасов КАК ВидЗапасов,
	|	Т.КорВидЗапасов КАК КорВидЗапасов,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.КорНаправлениеДеятельности КАК КорНаправлениеДеятельности,
	|	Т.ОтклоненияВСтоимостиСНДС КАК ОтклоненияВСтоимостиСНДС,
	|	Т.ДопРасходыСНДС КАК ДопРасходыСНДС,
	|	Т.РасчетСебестоимости КАК РасчетСебестоимости,
	|	Т.РасчетПартий КАК РасчетПартий,
	|	Т.Сторно КАК Сторно
	|ПОМЕСТИТЬ ВТОтклоненияВСтоимостиТоваров
	|ИЗ
	|	ВТКэшРасчетныеОборотыОтклоненияВСтоимостиТоваров КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = Т.Регистратор
	|ГДЕ
	|	Т.ОтклоненияВСтоимостиСНДС + Т.ДопРасходыСНДС <> 0
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в функции ТекстРаспределитьОтклоненияВСтоимостиТоваровВозвратыИСторноДвижения().
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаСторнируемогоДокумента ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|		И Т.Сторно)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.РасчетСебестоимости КАК РасчетСебестоимости,
	|	Т.Сторно КАК Сторно,
	|	Т.Сумма КАК Сумма
	|ПОМЕСТИТЬ ВТПрочиеДоходы
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеДоходы КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = Т.Регистратор
	|ГДЕ
	|	Т.Сумма <> 0
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеПрочиеАктивыПассивы
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаСторнируемогоДокумента ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|		И Т.Сторно)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.СтатьяРасходов КАК СтатьяРасходов,
	|	Т.АналитикаРасходов КАК АналитикаРасходов,
	|	Т.РасчетСебестоимости КАК РасчетСебестоимости,
	|	Т.РасчетПартий КАК РасчетПартий,
	|	Т.Сторно КАК Сторно,
	|	Т.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	Т.Сумма КАК Сумма,
	|	Т.СуммаУпр КАК СуммаУпр
	|ПОМЕСТИТЬ ВТПрочиеРасходы
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеРасходы КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = Т.Регистратор
	|ГДЕ
	|	Т.Сумма <> 0
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеПрочиеАктивыПассивы
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаСторнируемогоДокумента ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|		И Т.Сторно)
	|;
	//++ НЕ УТ
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Т.ПартияПроизводства КАК ПартияПроизводства,
	|	Т.РасчетПартий КАК РасчетПартий,
	|	Т.Сторно КАК Сторно,
	|	Т.Стоимость КАК Стоимость
	|ПОМЕСТИТЬ ВТТрудозатратыНЗП
	|ИЗ
	|	ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК Т
	|ГДЕ
	|	Т.Стоимость <> 0
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.ЗаказНаПроизводство КАК ЗаказНаПроизводство,
	|	Т.ПартияПроизводства КАК ПартияПроизводства,
	|	Т.АналитикаПартииВыпуска КАК АналитикаПартииВыпуска,
	|	Т.РасчетСебестоимости КАК РасчетСебестоимости,
	|	Т.РасчетПартий КАК РасчетПартий,
	|	Т.Сторно КАК Сторно,
	|	Т.Стоимость КАК Стоимость
	|ПОМЕСТИТЬ ВТПрочиеРасходыНЗП
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеРасходыНезавершенногоПроизводства КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправленныеДокументы КАК ИсправленныеДокументы
	|		ПО ИсправленныеДокументы.Регистратор = Т.Регистратор
	|ГДЕ
	|	Т.Стоимость <> 0
	// Исключаем сторно движения исправлений и корректировок прошлого периода.
	// Такие движения уже сформированы в процедуре СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов() Область ИсправлениеПрочиеАктивыПассивы
	|	И НЕ (НЕ ИсправленныеДокументы.ДатаСторнируемогоДокумента ЕСТЬ NULL
	|		И ИсправленныеДокументы.ДатаСторнируемогоДокумента < &НачалоПериода
	|		И Т.Сторно)
	|;
	//-- НЕ УТ
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
	|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	КОНЕЦ КАК ВидДвижения,
	|	Т.Регистратор КАК Регистратор,
	|	Т.Период КАК Период,
	|	Т.Организация КАК Организация,
	|	Т.Подразделение КАК Подразделение,
	|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	Т.Статья КАК Статья,
	|	Т.Аналитика КАК Аналитика,
	|	Т.Сумма КАК Сумма,
	|	Т.ВидИсточника КАК ВидИсточника,
	|	Т.Источник КАК Источник,
	|	Т.РасчетСебестоимости КАК РасчетСебестоимости,
	|	Т.РасчетПартий КАК РасчетПартий,
	|	Т.Сторно КАК Сторно
	|ПОМЕСТИТЬ ВТАктивыПассивы
	|ИЗ
	|	ВТКэшРасчетныеОборотыПрочиеАктивыПассивы КАК Т
	|ГДЕ
	|	Т.Сумма <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДокументыКОтражению.Ссылка КАК Регистратор
	|ПОМЕСТИТЬ ДокументыКОтражению
	|ИЗ
	|	(
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		СебестоимостьТоваров.Регистратор КАК Ссылка
	|	ИЗ
	|		ВТКэшРасчетныеОборотыСебестоимостьТоваров КАК СебестоимостьТоваров
	|	ГДЕ
	|		НЕ(СебестоимостьТоваров.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ОтклоненияВСтоимостиТоваров.Регистратор КАК Ссылка
	|	ИЗ
	|		ВТКэшРасчетныеОборотыОтклоненияВСтоимостиТоваров КАК ОтклоненияВСтоимостиТоваров
	|	ГДЕ
	|		НЕ (ОтклоненияВСтоимостиТоваров.Регистратор ССЫЛКА Документ.РасчетСебестоимостиТоваров)
	//++ НЕ УТ

	//++ Локализация
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ДанныеДокумента.Ссылка КАК Ссылка
	|	ИЗ
	|		ВТВнеоборотныеАктивы КАК ВнеоборотныеАктивы
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПринятиеКУчетуОС.ОС КАК ДанныеДокумента
	|			ПО ВнеоборотныеАктивы.Объект = ДанныеДокумента.ОсновноеСредство
	|	ГДЕ
	|		ДанныеДокумента.Ссылка.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ДанныеДокумента.Ссылка.Проведен
	|		И ДанныеДокумента.Ссылка.Организация В(&МассивОрганизаций)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ДанныеДокумента.Ссылка
	|	ИЗ
	|		ВТВнеоборотныеАктивы КАК ВнеоборотныеАктивы
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.МодернизацияОС.ОС КАК ДанныеДокумента
	|			ПО ВнеоборотныеАктивы.Объект = ДанныеДокумента.ОсновноеСредство
	|	ГДЕ
	|		ДанныеДокумента.Ссылка.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ДанныеДокумента.Ссылка.Проведен
	|		И ДанныеДокумента.Ссылка.Организация В(&МассивОрганизаций)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ДанныеДокумента.Ссылка
	|	ИЗ
	|		ВТВнеоборотныеАктивы КАК ВнеоборотныеАктивы
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ПринятиеКУчетуНМА КАК ДанныеДокумента
	|			ПО ВнеоборотныеАктивы.Объект = ДанныеДокумента.НематериальныйАктив
	|	ГДЕ
	|		ДанныеДокумента.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ДанныеДокумента.Ссылка.Проведен
	|		И ДанныеДокумента.Ссылка.Организация В(&МассивОрганизаций)
	//-- Локализация
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ТрудозатратыНЗП.Регистратор
	|	ИЗ
	|		ВТКэшРасчетныеОборотыТрудозатратыНезавершенногоПроизводства КАК ТрудозатратыНЗП
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ПрочиеРасходыНЗП.Регистратор
	|	ИЗ
	|		ВТКэшРасчетныеОборотыПрочиеРасходыНезавершенногоПроизводства КАК ПрочиеРасходыНЗП
	//-- НЕ УТ
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ПрочиеАктивыПассивы.Регистратор
	|	ИЗ
	|		ВТКэшПрочиеАктивыПассивы КАК ПрочиеАктивыПассивы
	|	ГДЕ
	|		ПрочиеАктивыПассивы.Организация В(&МассивОрганизаций)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ПрочиеДоходы.Регистратор
	|	ИЗ
	|		ВТКэшПрочиеДоходы КАК ПрочиеДоходы
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		ПрочиеРасходы.Регистратор
	|	ИЗ
	|		ВТКэшПрочиеРасходы КАК ПрочиеРасходы
	|
	|) КАК ДокументыКОтражению
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|";
	#КонецОбласти
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина, "ДокументыКОтражению");
	
	Если РасчетСебестоимостиПрикладныеАлгоритмы.РазмерВременнойТаблицы(ПараметрыРасчета, "ДокументыКОтражению") > 0 Тогда
		
		// Передадим временную таблицу ДокументыКОтражению
		ПараметрыДвижений = Новый Структура;
		ПараметрыДвижений.Вставить("ВидОтложенногоРасчета", Перечисления.ВидыИсточниковДвижений.РасчетСебестоимости);
		ПараметрыДвижений.Вставить("ДокументыКОтражению",   ПараметрыРасчета.МенеджерВременныхТаблиц);
		ПараметрыДвижений.Вставить("Период", ПараметрыРасчета.РасчетныйПериод.НачалоПериода);
		ПараметрыДвижений.Вставить("ИмяВременнойТаблицыРезультата", "ВТДвиженияАктивыПассивы");
		
		ЗапросДвижений = УправленческийУчетПроведениеСервер.ЗапросДвиженийАктивовПассивов(ПараметрыДвижений);
		
		#Область ВычтемОнлайновыеДвижения
		ТекстВычитания = 
		"ВЫБРАТЬ
		|	Т.ВидДвижения КАК ВидДвижения,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Период КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	Т.Статья КАК Статья,
		|	Т.Аналитика КАК Аналитика,
		|	Т.Сумма КАК Сумма,
		|	Т.ВидИсточника КАК ВидИсточника,
		|	Т.Источник КАК Источник,
		|	Т.Сторно КАК Сторно,
		|	Т.РасчетСебестоимости КАК РасчетСебестоимости
		|ПОМЕСТИТЬ ВТГруппировкаАктивыПассивы
		|ИЗ
		|	ВТДвиженияАктивыПассивы КАК Т
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВЫБОР КОГДА Т.СлужебноеВидДвиженияПриход
		|		ТОГДА ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
		|		ИНАЧЕ ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
		|	КОНЕЦ КАК ВидДвижения,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Период КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	Т.Статья КАК Статья,
		|	Т.Аналитика КАК Аналитика,
		|	-Т.Сумма КАК Сумма,
		|	Т.ВидИсточника КАК ВидИсточника,
		|	Т.Источник КАК Источник,
		|	Т.Сторно КАК Сторно,
		|	Т.РасчетСебестоимости КАК РасчетСебестоимости
		|ИЗ
		|	ВТКэшРасчетныеОборотыПрочиеАктивыПассивы КАК Т
		|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыКОтражению КАК ДокументыКОтражению
		|	ПО Т.Регистратор = ДокументыКОтражению.Регистратор
		|ГДЕ
		|	Т.Сумма <> 0
		|	И НЕ Т.РасчетПартий
		|	И НЕ Т.РасчетСебестоимости
		|	И Т.ВидИсточника = ЗНАЧЕНИЕ(Перечисление.ВидыИсточниковДвижений.РасчетСебестоимости)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Т.ВидДвижения КАК ВидДвижения,
		|	Т.Регистратор КАК Регистратор,
		|	Т.Период КАК Период,
		|	Т.Организация КАК Организация,
		|	Т.Подразделение КАК Подразделение,
		|	Т.НаправлениеДеятельности КАК НаправлениеДеятельности,
		|	Т.Статья КАК Статья,
		|	Т.Аналитика КАК Аналитика,
		|	СУММА(Т.Сумма) КАК Сумма,
		|	Т.ВидИсточника КАК ВидИсточника,
		|	Т.Источник КАК Источник,
		|	Т.Сторно КАК Сторно,
		|	МИНИМУМ(Т.РасчетСебестоимости) КАК РасчетСебестоимости,
		|	Т.Регистратор КАК ДокументДвижения
		|ПОМЕСТИТЬ ВТДанныеДляФормированияДвижений
		|ИЗ
		|	ВТГруппировкаАктивыПассивы КАК Т
		|
		|СГРУППИРОВАТЬ ПО
		|	Т.ВидДвижения,
		|	Т.Регистратор,
		|	Т.Период,
		|	Т.Организация,
		|	Т.Подразделение,
		|	Т.НаправлениеДеятельности,
		|	Т.Статья,
		|	Т.Аналитика,
		|	Т.ВидИсточника,
		|	Т.Источник,
		|	Т.Сторно
		|
		|ИМЕЮЩИЕ
		|	СУММА(Т.Сумма) <> 0";
		ЗапросДвижений.Текст = ЗапросДвижений.Текст + ТекстВычитания;
		#КонецОбласти
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, ЗапросДвижений, Истина, "ВТДанныеДляФормированияДвижений");
		
		РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьДвиженияПоРегиструПоДаннымВременнойТаблицы(
			ПараметрыРасчета,
			Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя,
			"ВТДанныеДляФормированияДвижений",
			Истина);
		
		РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета,
			ЗапросДвижений.Параметры.ИменаВременныхТаблиц);
		
	КонецЕсли;
	
	// Уничтожим ненужные временные таблицы.
	НовыеВТ = РасчетСебестоимостиПрикладныеАлгоритмы.ПолучитьПереченьСуществующихВременныхТаблиц(ПараметрыРасчета, СуществующиеВТ);
	РасчетСебестоимостиПрикладныеАлгоритмы.УничтожитьВременныеТаблицы(ПараметрыРасчета, НовыеВТ);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.КэшироватьСформированныеДвижения(ПараметрыРасчета);
	
КонецПроцедуры

#КонецОбласти

#Область ТекстыЗапросов

Функция УстановитьРазрядностьЧиселВТекстеЗапроса(ПараметрыРасчета, ТекстЗапроса) Экспорт
	
	// В запросах, выполняющих расчеты во временных таблицах, установим максимально возможную разрядность.
	
	СтараяРазрядность 			  = 28;
	СтараяРазрядностьДробнойЧасти = 10;
	НоваяРазрядность 			  = ПараметрыРасчета.РешениеСЛУ.РазрядностьДляРасчетов;
	НоваяРазрядностьДробнойЧасти  = СтараяРазрядностьДробнойЧасти;
	ОписаниеДенежногоПоля 		  = ОбщегоНазначенияУТ.РазрядностьДенежногоПоля();
	
	Если ОписаниеДенежногоПоля.Разрядность - ОписаниеДенежногоПоля.РазрядностьДробнойЧасти > 13 Тогда
		
		// Уменьшим разрядность дробной части при расчете.
		// Общую разрядность, установленную в настройках, изменять не будем - чтобы не вызвать ошибку переполнения поля.
		ИзмерениеРазрядности = ОписаниеДенежногоПоля.Разрядность - ОписаниеДенежногоПоля.РазрядностьДробнойЧасти - 13;
		НоваяРазрядностьДробнойЧасти = Макс(НоваяРазрядностьДробнойЧасти - ИзмерениеРазрядности, 0);
		
	КонецЕсли;
	
	Если СтараяРазрядность <> НоваяРазрядность ИЛИ СтараяРазрядностьДробнойЧасти <> НоваяРазрядностьДробнойЧасти Тогда
		
		ТекстРазрядность = "(" + СокрЛП(НоваяРазрядность) + "," + СокрЛП(НоваяРазрядностьДробнойЧасти) + ")";
		
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "(28,10)", ТекстРазрядность);
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "(28, 10)", ТекстРазрядность); // с пробелом
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "(28,	10)", ТекстРазрядность); // с табуляцией
		
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти

#Область ФормированиеДвижений

#Область ДвиженияНоменклатура

// Служебная, этап 2.1, 3.3, 3.14, 3.19
Процедура СформироватьДвиженияПоОборотнымРегистрамУпрУчета(ПараметрыРасчета, ДанныеДвижения) Экспорт
	
	ДанныеСумм = ПолучитьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеДвижения);
	
	Если ДанныеСумм.ЕстьНенулеваяПолнаяСумма Тогда
		
		// Формирование движений Номенклатура - Доходы\Расходы.
		Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваров
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
			//++ НЕ УТ
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВСоставОС
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВСоставНМА
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровУПереработчика
			//-- НЕ УТ
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаПрочиеЦели
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОтчетКомиссионераОСписании
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакрытиеМесяца
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеНедостачЗаСчетПоклажедателя
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОприходованиеИзлишковТоваровВПользуКомитента
			Или ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ОприходованиеИзлишковТоваровВПользуПоклажедателя Тогда
			
			СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения, ДанныеСумм);
			
		КонецЕсли;
		
		Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы Тогда
			
			Если ПараметрыРасчета.Свойство("МетодОценки")
			 И ПараметрыРасчета.МетодОценки = Перечисления.МетодыОценкиСтоимостиТоваров.ФИФОСкользящаяОценка Тогда
				
				СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения, ДанныеСумм);
				
			Иначе
				
				СкорректированныеСуммы = СкорректироватьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеСумм, -1, -1, -1, -1, 0);
				
				СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения, СкорректированныеСуммы);
				
			КонецЕсли;
			
		КонецЕсли;
		
		// Формирование движений Номенклатура - Номенклатура.
		Если ((ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами
				ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеПолуфабрикатовМеждуФилиалами
				ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами)
				И ДанныеДвижения.ВидДвижения = ВидДвиженияНакопления.Расход)
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратИзПроизводства
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратМатериаловИзПроизводства
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратМатериаловИзКладовой
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратОтКомиссионера
			//++ Устарело_Переработка24
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратОтПереработчика
			//-- Устарело_Переработка24
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратОтПереработчика2_5
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратПоКомиссииМеждуОрганизациями
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВыпускПродукции
			//++ Устарело_Переработка24
			ИЛИ (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПоступлениеОтПереработчика
				И ДанныеДвижения.ВидДвижения = ВидДвиженияНакопления.Расход)
			//-- Устарело_Переработка24
			ИЛИ (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПоступлениеОтПереработчика2_5
				И ДанныеДвижения.ВидДвижения = ВидДвиженияНакопления.Расход)
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаПродукцииИзПроизводства
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаПродукцииИзКладовой
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.КорректировкаОбособленногоУчета
			ИЛИ ((ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеТоваров
				ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеПолуфабрикатов
				ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПриемПередачаРаботМеждуПодразделениями)
				И ДанныеДвижения.ВидДвижения = ВидДвиженияНакопления.Расход)
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВПроизводство
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаМатериаловВПроизводство
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаМатериаловВКладовую
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссию
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию
			//++ Устарело_Переработка24
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаПереработчику
			//-- Устарело_Переработка24
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаПереработчику2_5
			ИЛИ (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаТоваров
				И ДанныеДвижения.ВидДвижения = ВидДвиженияНакопления.Расход)
			ИЛИ (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПорчаТоваров
				И ДанныеДвижения.ВидДвижения = ВидДвиженияНакопления.Расход)
			ИЛИ (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности
				И ДанныеДвижения.РазделУчета <> Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыВПути)
			ИЛИ (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности
				И ДанныеДвижения.РазделУчета <> Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПереданныеНаКомиссиюВПути)
			ИЛИ (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности
				И ДанныеДвижения.РазделУчета <> Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаКомиссиюВПути)
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СборкаТоваров
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РазборкаТоваров
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСНеотфактурованнаяПоставка
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСПоступлениеИзТоваровВПути
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаПоИмпортуПоступлениеИзТоваровВПути
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаНеотфактурованнаяПоставка
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаПоступлениеИзТоваровВПути
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаХранениеСПравомПродажи
			ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратОтХранителя Тогда
			
			СформироватьДвиженияНоменклатураНоменклатура(ПараметрыРасчета, ДанныеДвижения, ДанныеСумм,
				?(ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности
				ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности,
					Перечисления.ХозяйственныеОперации.ОтгрузкаБезПереходаПраваСобственности,
					Неопределено));
			
			Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеТоваровМеждуФилиалами
				ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеПолуфабрикатовМеждуФилиалами Тогда
				СформироватьДвиженияНоменклатураНоменклатура(ПараметрыРасчета, ДанныеДвижения, ДанныеСумм,
					Перечисления.ХозяйственныеОперации.ВнутреннееПоступлениеТоваров);
			ИначеЕсли ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПриемПередачаРаботМеждуФилиалами Тогда
				СформироватьДвиженияНоменклатураНоменклатура(ПараметрыРасчета, ДанныеДвижения, ДанныеСумм,
					Перечисления.ХозяйственныеОперации.ВнутреннееПоступлениеРабот);
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Формирование прочих доходов\расходов при пересортице.
	Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой Тогда

		Если ДанныеСумм.ПолнаяСуммаПереоценки > 0 Тогда 
			
			СкорректированныеСуммы = СкорректироватьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеСумм, 1, 1, 1, 1, 1);
			
			СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения,
				СкорректированныеСуммы,
				Ложь,
				Перечисления.ХозяйственныеОперации.РасходыОтПереоценкиТоваров);
			
		ИначеЕсли ДанныеСумм.ПолнаяСуммаПереоценки < 0 Тогда
			
			СкорректированныеСуммы = СкорректироватьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеСумм, -1, 1, -1, -1, 1);
			
			СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения,
				СкорректированныеСуммы,
				Истина,
				Перечисления.ХозяйственныеОперации.ДоходыОтПереоценкиТоваров);
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Формирование прочих расходов при порче.
	Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПорчаТоваровСПереоценкой Тогда
		
		Если ДанныеСумм.ПолнаяСуммаПереоценки <> 0 Тогда
			
			СкорректированныеСуммы = СкорректироватьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеСумм, 1, 1, 1, 1, 1);
			
			СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения,
				СкорректированныеСуммы,
				Ложь,
				Перечисления.ХозяйственныеОперации.РасходыОтПереоценкиТоваров);
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Формирование прочих доходов/расходов возникших от переоценки товаров.
	Если (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику
			И ДанныеДвижения.КорСтоимость <> 0)
		ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияПереданнойВозвратнойТары
		ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями
		ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноПереданнойТарыВозвратНаДругойСклад
		ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноПереданнойТары Тогда
		
		Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями Тогда
			СкорректированныеСуммы = СкорректироватьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеСумм, 0, 0, 1, 1, 0);
		Иначе
			СкорректированныеСуммы = СкорректироватьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеСумм, 1, 1, 1, 1, 0);
		КонецЕсли;
		
		Если СкорректированныеСуммы.ПолнаяСуммаСНДС > 0
		 ИЛИ СкорректированныеСуммы.ПолнаяСуммаРегл > 0
		 ИЛИ СкорректированныеСуммы.ПолнаяСуммаУпр > 0 Тогда 

			СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения,
				СкорректированныеСуммы,
				Ложь,
				Перечисления.ХозяйственныеОперации.РасходыОтПереоценкиТоваров);
			
		ИначеЕсли СкорректированныеСуммы.ПолнаяСуммаСНДС < 0
		 ИЛИ СкорректированныеСуммы.ПолнаяСуммаРегл < 0
		 ИЛИ СкорректированныеСуммы.ПолнаяСуммаУпр < 0 Тогда 
			
			СкорректированныеСуммы = СкорректироватьСуммовыеПоказателиДвиженияНоменклатуры(СкорректированныеСуммы, -1, -1, -1, -1, 0);
			
			СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения,
				СкорректированныеСуммы,
				Истина,
				Перечисления.ХозяйственныеОперации.ДоходыОтПереоценкиТоваров);
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Служебная, этап 2.1, 3.3, 3.14 (СформироватьДвиженияПоОборотнымРегистрамУпрУчета)
Процедура СформироватьДвиженияНоменклатураДоходыРасходы(ПараметрыРасчета, ДанныеДвижения, ДанныеСумм,
			ЭтоДоход = Ложь, ХозяйственнаяОперация = Неопределено)

	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя;
	
	КопируемыеПоля =
	"Период, ХозяйственнаяОперация, Организация, Подразделение,
	|АналитикаУчетаНоменклатуры,Склад,ТипЗапасов,ВидЗапасов,
	|ИсточникГФУНоменклатуры, ДокументДвижения";
	
	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения.
	ЗаполнитьЗначенияСвойств(Запись, ДанныеСумм);
	
	Если ХозяйственнаяОперация <> Неопределено Тогда
		Запись.ХозяйственнаяОперация = ХозяйственнаяОперация;
	КонецЕсли;
	
	Если ЭтоДоход Тогда
		Запись.СтатьяДоходовРасходов = ДанныеДвижения.СтатьяДоходов;
		Запись.АналитикаДоходов 	 = ДанныеДвижения.АналитикаДоходов;
		Запись.НаправлениеДеятельностиНоменклатуры = ДанныеДвижения.НаправлениеДеятельности;
		Запись.НаправлениеДеятельностиСтатьи = ДанныеДвижения.КорНаправлениеДеятельности;
	Иначе
		Запись.СтатьяДоходовРасходов = ДанныеДвижения.СтатьяРасходовСписания;
		Запись.АналитикаРасходов 	 = ДанныеДвижения.АналитикаРасходов;
		Запись.НаправлениеДеятельностиНоменклатуры = ДанныеДвижения.НаправлениеДеятельности;
		Запись.НаправлениеДеятельностиСтатьи = ДанныеДвижения.КорНаправлениеДеятельности;
		Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
			И ДанныеДвижения.КорТипЗапасов = Перечисления.ТипыЗапасов.КомиссионныйТовар Тогда
			Запись.НаправлениеДеятельностиНоменклатуры = ДанныеДвижения.КорНаправлениеДеятельности;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Служебная, этап 2.1, 3.3, 3.14 (СформироватьДвиженияПоОборотнымРегистрамУпрУчета)
Процедура СформироватьДвиженияНоменклатураНоменклатура(ПараметрыРасчета, ДанныеДвижения, ДанныеСумм, ХозяйственнаяОперация)
	
	Если НЕ ЗначениеЗаполнено(ДанныеДвижения.КорАналитикаУчетаНоменклатуры)
	 И (ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СборкаТоваров
		ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РазборкаТоваров
	 	ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности
	 	ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности) Тогда
		Возврат;
	КонецЕсли;
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураНоменклатура.Имя;
	
	КопируемыеПоля =
	"Период, ХозяйственнаяОперация, Организация, Подразделение,
	|АналитикаУчетаНоменклатуры,Склад,ТипЗапасов,ВидЗапасов,НаправлениеДеятельности,
	|КорАналитикаУчетаНоменклатуры,КорСклад,КорТипЗапасов,КорВидЗапасов,КорНаправлениеДеятельности,
	|ИсточникГФУНоменклатуры, КорИсточникГФУНоменклатуры, ДокументДвижения, КорОрганизация";

	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения.
	ЗаполнитьЗначенияСвойств(Запись, ДанныеСумм);
	
	Если ХозяйственнаяОперация <> Неопределено Тогда
		Запись.ХозяйственнаяОперация = ХозяйственнаяОперация;
		Если Запись.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВнутреннееПоступлениеТоваров
			ИЛИ Запись.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВнутреннееПоступлениеРабот Тогда
			Запись.Организация    = ДанныеДвижения.КорОрганизация;
			Запись.КорОрганизация = ДанныеДвижения.Организация;
		КонецЕсли;
	КонецЕсли;
	
	Если ТипЗнч(ДанныеДвижения.Склад) = Тип("СправочникСсылка.Партнеры") Тогда
		Запись.Количество = ДанныеДвижения.Количество;
	КонецЕсли;
	
	Если Запись.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссию Тогда
		Запись.КорНаправлениеДеятельности = ДанныеДвижения.НаправлениеДеятельности;
	КонецЕсли;
	
КонецПроцедуры

// Служебная, этап 2.1, 3.18
Процедура СформироватьДвиженияНоменклатураДоходыРасходыСписаниеНДС(ПараметрыРасчета) Экспорт
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы.Имя;
	
	КопируемыеПоля = "Период, ХозяйственнаяОперация, Организация,
	|НаправлениеДеятельностиНоменклатуры, НаправлениеДеятельностиСтатьи, АналитикаУчетаНоменклатуры,
	|Склад, Подразделение, СтатьяДоходовРасходов, АналитикаРасходов, ВидЗапасов, ТипЗапасов,
	|ИсточникГФУНоменклатуры, ДокументДвижения, СтоимостьРегл, СтоимостьУпр";
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Партии.Период 														КАК Период,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНДСПоПриобретеннымЦенностям) 	КАК ХозяйственнаяОперация,
	|	Партии.Организация 													КАК Организация,
	|	СпрНазначения.НаправлениеДеятельности 								КАК НаправлениеДеятельностиНоменклатуры,
	|	СпрНазначения.НаправлениеДеятельности 								КАК НаправлениеДеятельностиСтатьи,
	|	Партии.АналитикаУчетаНоменклатуры 									КАК АналитикаУчетаНоменклатуры,
	|	АналитикаНоменклатуры.МестоХранения									КАК Склад,
	|	ВЫБОР
	|		КОГДА АналитикаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА АналитикаНоменклатуры.Подразделение
	|		ИНАЧЕ ЕСТЬNULL(СпрСклады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	КОНЕЦ 																КАК Подразделение,
	|	Партии.СтатьяСписанияНДС 											КАК СтатьяДоходовРасходов,
	|	Партии.АналитикаСписанияНДС 										КАК АналитикаРасходов,
	|	Партии.ВидЗапасов													КАК ВидЗапасов,
	|	ВЫБОР
	|		КОГДА СпрНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|		 И НЕ СпрНоменклатура.ПрослеживаемыйТовар
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
	|		ИНАЧЕ ЕСТЬNULL(СпрВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|	КОНЕЦ 																КАК ТипЗапасов,
	|	ВЫБОР КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|		ТОГДА Партии.ВидЗапасов
	|		ИНАЧЕ АналитикаНоменклатуры.Номенклатура
	|	КОНЕЦ 																КАК ИсточникГФУНоменклатуры,
	|	Партии.Регистратор 													КАК ДокументДвижения,
	|	СУММА(Партии.СписаниеНДС) 											КАК СтоимостьРегл,
	|	СУММА(Партии.СписаниеНДСУпр) 										КАК СтоимостьУпр
	|ИЗ
	|	ВтПартии КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЗапасов КАК СпрВидыЗапасов
	|		ПО Партии.ВидЗапасов = СпрВидыЗапасов.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Склады КАК СпрСклады
	|			ПО АналитикаНоменклатуры.СкладскаяТерритория = СпрСклады.Ссылка
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Номенклатура КАК СпрНоменклатура
	|			ПО АналитикаНоменклатуры.Номенклатура = СпрНоменклатура.Ссылка
	|		ПО Партии.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК СпрНазначения
	|		ПО СпрНазначения.Ссылка = АналитикаНоменклатуры.Назначение
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	АналитикаНоменклатуры.МестоХранения,
	|	ВЫБОР
	|		КОГДА АналитикаНоменклатуры.ТипМестаХранения = ЗНАЧЕНИЕ(Перечисление.ТипыМестХранения.Подразделение)
	|			ТОГДА АналитикаНоменклатуры.Подразделение
	|		ИНАЧЕ ЕСТЬNULL(СпрСклады.Подразделение, ЗНАЧЕНИЕ(Справочник.СтруктураПредприятия.ПустаяСсылка))
	|	КОНЕЦ,
	|	СпрНазначения.НаправлениеДеятельности,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.ВидЗапасов,
	|	ВЫБОР
	|		КОГДА СпрНоменклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|		 И НЕ СпрНоменклатура.ПрослеживаемыйТовар
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Услуга)
	|	ИНАЧЕ
	|		ЕСТЬNULL(СпрВидыЗапасов.ТипЗапасов, ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар))
	|	КОНЕЦ, // ТипЗапасов
	|	Партии.Регистратор,
	|	ВЫБОР КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета
	|		ТОГДА Партии.ВидЗапасов
	|		ИНАЧЕ АналитикаНоменклатуры.Номенклатура
	|	КОНЕЦ
	|
	|ИМЕЮЩИЕ
	|	СУММА(Партии.СписаниеНДС) <> 0
	|	ИЛИ СУММА(Партии.СписаниеНДСУпр) <> 0
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор";
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,, ИмяРегистра);
	
	Пока Выборка.Следующий() Цикл
		// Добавим движение и заполним его свойства.
		ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, Выборка, КопируемыеПоля);
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеЗаполнения)
	
	ДанныеСумм = Новый Структура;
	ДанныеСумм.Вставить("Стоимость", 			  		0);
	ДанныеСумм.Вставить("СтоимостьБезНДС", 		  		0);
	ДанныеСумм.Вставить("ДопРасходы", 	  		  		0);
	ДанныеСумм.Вставить("ДопРасходыБезНДС", 	  		0);
	ДанныеСумм.Вставить("Трудозатраты", 		  		0);
	ДанныеСумм.Вставить("ПостатейныеПостоянныеСНДС", 	0);
	ДанныеСумм.Вставить("ПостатейныеПостоянныеБезНДС", 	0);
	ДанныеСумм.Вставить("ПостатейныеПеременныеСНДС", 	0);
	ДанныеСумм.Вставить("ПостатейныеПеременныеБезНДС", 	0);
	ДанныеСумм.Вставить("СтоимостьРегл", 		  		0);
	ДанныеСумм.Вставить("ДопРасходыРегл", 		  		0);
	ДанныеСумм.Вставить("ТрудозатратыРегл", 	  		0);
	ДанныеСумм.Вставить("ПостатейныеПостоянныеРегл", 	0);
	ДанныеСумм.Вставить("ПостатейныеПеременныеРегл", 	0);
	ДанныеСумм.Вставить("СтоимостьУпр", 		  		0);
	ДанныеСумм.Вставить("ДопРасходыУпр", 		  		0);
	ДанныеСумм.Вставить("ТрудозатратыУпр", 		  		0);
	ДанныеСумм.Вставить("ПостатейныеПостоянныеУпр", 	0);
	ДанныеСумм.Вставить("ПостатейныеПеременныеУпр", 	0);
	ДанныеСумм.Вставить("СтоимостьЗабалансовая", 		0);
	ДанныеСумм.Вставить("СтоимостьЗабалансоваяРегл", 	0);
	ДанныеСумм.Вставить("ПостояннаяРазница", 			0);
	ДанныеСумм.Вставить("ВременнаяРазница", 			0);
	ДанныеСумм.Вставить("НДСРегл", 			    		0);
	ДанныеСумм.Вставить("НДСУпр",	 			    	0);
	ДанныеСумм.Вставить("КорСтоимость", 			    0);
	
	ЗаполнитьЗначенияСвойств(ДанныеСумм, ДанныеЗаполнения);
	
	ЗаполнитьИтоговыеСуммовыеПоказателиДвижения(ДанныеСумм);
	
	ДанныеСумм.Вставить("ПолнаяСуммаПереоценки", ДанныеСумм.ПолнаяСуммаСНДС - ДанныеСумм.КорСтоимость);
		
	Возврат ДанныеСумм;
	
КонецФункции

Функция СкорректироватьСуммовыеПоказателиДвиженияНоменклатуры(ДанныеСумм,
			КоэффициентСуммыСНДС, КоэффициентСуммыБезНДС, КоэффициентСуммыРегл, КоэффициентСуммыУпр, КоэффициентКорСуммы)
	
	ИменаПолейСНДС   = Новый Структура("Стоимость, ДопРасходы, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС");
	ИменаПолейБезНДС = Новый Структура("СтоимостьБезНДС, ДопРасходыБезНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС");
	ИменаПолейРегл   = Новый Структура("СтоимостьРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл");
	ИменаПолейУпр 	 = Новый Структура("СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр");
	
	ИменаПолейУменьшаемойСтоимости = Новый Структура("Стоимость, СтоимостьБезНДС");
	
	СкорректированныеСуммы = Новый Структура;
	
	Для Каждого КлючИЗначение Из ДанныеСумм Цикл
		
		Если ИменаПолейСНДС.Свойство(КлючИЗначение.Ключ) Тогда
			
			Если ИменаПолейУменьшаемойСтоимости.Свойство(КлючИЗначение.Ключ) Тогда
				СкорректированныеСуммы.Вставить(КлючИЗначение.Ключ,
					(КлючИЗначение.Значение - ДанныеСумм.КорСтоимость * КоэффициентКорСуммы) * КоэффициентСуммыСНДС);
			Иначе
				СкорректированныеСуммы.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение * КоэффициентСуммыСНДС);
			КонецЕсли;
			
		ИначеЕсли ИменаПолейБезНДС.Свойство(КлючИЗначение.Ключ) Тогда
			
			Если ИменаПолейУменьшаемойСтоимости.Свойство(КлючИЗначение.Ключ) Тогда
				СкорректированныеСуммы.Вставить(КлючИЗначение.Ключ,
					(КлючИЗначение.Значение - ДанныеСумм.КорСтоимость * КоэффициентКорСуммы) * КоэффициентСуммыБезНДС);
			Иначе
				СкорректированныеСуммы.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение * КоэффициентСуммыБезНДС);
			КонецЕсли;
		
		ИначеЕсли ИменаПолейРегл.Свойство(КлючИЗначение.Ключ) Тогда
			
			СкорректированныеСуммы.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение * КоэффициентСуммыРегл);
		
		ИначеЕсли ИменаПолейУпр.Свойство(КлючИЗначение.Ключ) Тогда
			
			СкорректированныеСуммы.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение * КоэффициентСуммыУпр);
			
		Иначе
			
			СкорректированныеСуммы.Вставить(КлючИЗначение.Ключ, КлючИЗначение.Значение);
			
		КонецЕсли;
		
	КонецЦикла;
	
	ЗаполнитьИтоговыеСуммовыеПоказателиДвижения(СкорректированныеСуммы);
	
	Возврат СкорректированныеСуммы;
	
КонецФункции

Процедура ЗаполнитьИтоговыеСуммовыеПоказателиДвижения(ДанныеСумм)
	
	ДанныеСумм.Вставить("ПолнаяСуммаСНДС",
		ДанныеСумм.Стоимость + ДанныеСумм.ДопРасходы + ДанныеСумм.Трудозатраты
		+ ДанныеСумм.ПостатейныеПостоянныеСНДС + ДанныеСумм.ПостатейныеПеременныеСНДС);
	ДанныеСумм.Вставить("ПолнаяСуммаБезНДС",
		ДанныеСумм.СтоимостьБезНДС + ДанныеСумм.ДопРасходыБезНДС + ДанныеСумм.Трудозатраты
		+ ДанныеСумм.ПостатейныеПостоянныеБезНДС + ДанныеСумм.ПостатейныеПеременныеБезНДС);
	ДанныеСумм.Вставить("ПолнаяСуммаРегл",
		ДанныеСумм.СтоимостьРегл + ДанныеСумм.ДопРасходыРегл + ДанныеСумм.ТрудозатратыРегл
		+ ДанныеСумм.ПостатейныеПостоянныеРегл + ДанныеСумм.ПостатейныеПеременныеРегл);
	ДанныеСумм.Вставить("ПолнаяСуммаУпр",
		ДанныеСумм.СтоимостьУпр + ДанныеСумм.ДопРасходыУпр + ДанныеСумм.ТрудозатратыУпр
		+ ДанныеСумм.ПостатейныеПостоянныеУпр + ДанныеСумм.ПостатейныеПеременныеУпр);
	
	ДанныеСумм.Вставить("ЕстьНенулеваяПолнаяСумма",
		ДанныеСумм.ПолнаяСуммаСНДС <> 0
		ИЛИ ДанныеСумм.ПолнаяСуммаБезНДС <> 0
		ИЛИ ДанныеСумм.ПолнаяСуммаРегл <> 0
		ИЛИ ДанныеСумм.ПолнаяСуммаУпр <> 0);
	
КонецПроцедуры

#КонецОбласти

#Область ДвиженияСебестоимостьТоваров

// Служебная, этап 2.1, 3.1, 3.14
Процедура СформироватьКорДвиженияСебестоимостьТоваров(ПараметрыРасчета, ДанныеДвижения, ПромежуточнаяСебестоимость = Ложь) Экспорт
	
	Если ПромежуточнаяСебестоимость Тогда
		ТаблицаПриемник = "ВТПромежуточнаяСебестоимостьТоваров";
	Иначе
		ТаблицаПриемник = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	КонецЕсли;
	
	КопируемыеПоля = "
	|Период, ХозяйственнаяОперация, ДокументДвижения, ИдентификаторСтроки,
	|Подразделение, ГруппаПродукции,
	|Стоимость, СтоимостьЗабалансовая, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС,
	|СтоимостьРегл, СтоимостьЗабалансоваяРегл, ПостояннаяРазница, ВременнаяРазница, СтоимостьНДД,
	|СтатьяКалькуляции, ТипЗаписи, ДокументИсточник, ИдентификаторФинЗаписи, Сторно,
	|Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС,
	|ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл,
	|ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр, НДСУпр";
	
	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ТаблицаПриемник, ДанныеДвижения, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
	Запись.ВидДвижения                = ВидДвиженияНакопления.Приход;
	Запись.АналитикаУчетаНоменклатуры = ДанныеДвижения.КорАналитикаУчетаНоменклатуры;
	Запись.РазделУчета                = ДанныеДвижения.КорРазделУчета;
	Запись.ВидЗапасов                 = ДанныеДвижения.КорВидЗапасов;
	Запись.Организация                = ?(ЗначениеЗаполнено(ДанныеДвижения.КорОрганизация), ДанныеДвижения.КорОрганизация, ДанныеДвижения.Организация);
	Запись.Количество 				  = 0;
	
	Запись.Партия                 	  = ДанныеДвижения.КорПартия;
	Если ЗначениеЗаполнено(ДанныеДвижения.КорПартия) Тогда
		Запись.АналитикаУчетаПартий   = ДанныеДвижения.КорАналитикаУчетаПартий;
	КонецЕсли;
	
	Если ПараметрыРасчета.ПартионныйУчетВерсии22 Тогда
		Запись.АналитикаФинансовогоУчета = ДанныеДвижения.КорАналитикаФинансовогоУчета;
		Запись.ВидДеятельностиНДС   	 = ДанныеДвижения.КорВидДеятельностиНДС;
		Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВыпускПродукции Тогда
			Если ТипЗнч(ДанныеДвижения.АналитикаФинансовогоУчета) = Тип("СправочникСсылка.ГруппыАналитическогоУчетаНоменклатуры") Тогда
				Запись.КорАналитикаФинансовогоУчета = ДанныеДвижения.АналитикаФинансовогоУчета;
			Иначе
				Запись.КорАналитикаФинансовогоУчета = Справочники.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка();
			КонецЕсли;
			Запись.ГруппаПродукции = ДанныеДвижения.АналитикаФинансовогоУчета;
		КонецЕсли;
		//++ НЕ УТ
		Если ТипЗнч(ДанныеДвижения.ДокументДвижения) = Тип("ДокументСсылка.РаспределениеВозвратныхОтходов")
			И Запись.ВидДвижения = ВидДвиженияНакопления.Приход
			И Запись.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.НезавершенноеПроизводство Тогда
			Запись.КорАналитикаУчетаНоменклатуры	= ДанныеДвижения.АналитикаУчетаНоменклатурыВО;
			Запись.КорАналитикаФинансовогоУчета		= ДанныеДвижения.АналитикаФинансовогоУчетаВО;
		КонецЕсли;
		//-- НЕ УТ
	КонецЕсли;
	Если Запись.РазделУчета = Перечисления.РазделыУчетаСебестоимостиТоваров.ТоварыПринятыеНаОтветхранение Тогда
		Запись.КорВидЗапасов             = ДанныеДвижения.КорВидЗапасов;
	КонецЕсли;

	Если ДанныеДвижения.ЭтоПередачаМеждуОрганизациями Тогда
		
		Запись.СтоимостьРегл = 0;
		Запись.СтоимостьЗабалансоваяРегл = 0;
		Запись.ПостояннаяРазница = 0;
		Запись.ВременнаяРазница = 0;
		Запись.СтоимостьНДД = 0;
		
		Запись.ДопРасходыРегл = 0;
		Запись.ТрудозатратыРегл = 0;
		Запись.ПостатейныеПостоянныеРегл = 0;
		Запись.ПостатейныеПеременныеРегл = 0;
		
		Запись.СтоимостьУпр = 0;
		Запись.ДопРасходыУпр = 0;
		Запись.ТрудозатратыУпр = 0;
		Запись.ПостатейныеПостоянныеУпр = 0;
		Запись.ПостатейныеПеременныеУпр = 0;
		
	ИначеЕсли ДанныеДвижения.НДСРегл <> 0 ИЛИ ДанныеДвижения.НДСУпр <> 0 Тогда // это не передача
		
		КопируемыеПоля = " Период, ХозяйственнаяОперация, ДокументДвижения, ИдентификаторСтроки, Подразделение, Организация,
			|СтатьяКалькуляции, ТипЗаписи, ДокументИсточник";
		
		// Добавим движение и заполним его основные свойства
		Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ТаблицаПриемник, ДанныеДвижения, КопируемыеПоля);
		
		// Заполним дополнительные свойства движения
		Запись.ВидДвижения 				  	 = ВидДвиженияНакопления.Приход;
		Запись.АналитикаУчетаНоменклатуры 	 = ДанныеДвижения.КорАналитикаУчетаНоменклатуры;
		Запись.РазделУчета 				  	 = ДанныеДвижения.КорРазделУчета;
		Запись.ВидЗапасов 				  	 = ДанныеДвижения.КорВидЗапасов;
		Запись.Организация                	 = ?(ЗначениеЗаполнено(ДанныеДвижения.КорОрганизация), ДанныеДвижения.КорОрганизация, ДанныеДвижения.Организация);
		
		Запись.Партия                 	     = ДанныеДвижения.КорПартия;
		Запись.АналитикаУчетаПартий   	     = ДанныеДвижения.КорАналитикаУчетаПартий;
		
		Если ПараметрыРасчета.ПартионныйУчетВерсии22 Тогда
			Запись.АналитикаФинансовогоУчета = ДанныеДвижения.КорАналитикаФинансовогоУчета;
			Запись.ВидДеятельностиНДС   	 = ДанныеДвижения.КорВидДеятельностиНДС;
			Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВыпускПродукции Тогда
				Если ТипЗнч(ДанныеДвижения.АналитикаФинансовогоУчета) = Тип("СправочникСсылка.ГруппыАналитическогоУчетаНоменклатуры") Тогда
					Запись.КорАналитикаФинансовогоУчета = ДанныеДвижения.АналитикаФинансовогоУчета;
				Иначе
					Запись.КорАналитикаФинансовогоУчета = Справочники.ГруппыАналитическогоУчетаНоменклатуры.ПустаяСсылка();
				КонецЕсли;
				Запись.ГруппаПродукции = ДанныеДвижения.АналитикаФинансовогоУчета;
			КонецЕсли;
		КонецЕсли;
		
		Запись.СтоимостьРегл 			  	 = ДанныеДвижения.НДСРегл;
		Запись.СтоимостьУпр 			  	 = ДанныеДвижения.НДСУпр;
		Запись.СтоимостьНДД 			  	 = ДанныеДвижения.НДСРегл;
		
	КонецЕсли;

КонецПроцедуры

//++ НЕ УТ

// Служебная, этап 2.3, 3.15
Процедура СформироватьДвиженияСебестоимостьТоваровСписаниеНЗПЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)

	ИмяРегистра = Метаданные.РегистрыНакопления.СебестоимостьТоваров.Имя;
	ИмяВременнойТаблицы = "ВтСебестоимостьТоваровСписаниеНЗПДвижения";
	
	КопируемыеПоля = "
	|Период, Организация, РазделУчета, ВидЗапасов, Подразделение, ГруппаПродукции, ДокументДвижения, СтатьяКалькуляции";
	
	КопируемыеПоля = КопируемыеПоля + ",
	|Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС, ИдентификаторФинЗаписи
	|";
	
	СуммовыеПоля = "
	|Стоимость, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС, СтоимостьРегл, СтоимостьНДД,
	|ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ТрудозатратыБезНДС, ПостатейныеСНДС, ПостатейныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеРегл, РезервРегл,
	|ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, 
	|ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, РезервУпр, ДоляСтоимости";
	
	КопируемыеПоля = КопируемыеПоля + ", " + СуммовыеПоля;

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаНоменклатуры", "АналитикаУчетаПродукцииСебестоимость");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации", "ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукцииПостатейные)");
	
	УсловиеГДЕ = "ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ ЭтоКорректировка";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);

КонецПроцедуры

Процедура СформироватьДвиженияНоменклатураНоменклатураСписаниеНЗПЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияНоменклатураНоменклатура.Имя;
	ИмяВременнойТаблицы = "ВтДвиженияНоменклатураНоменклатураСписаниеНЗП";
	
	КопируемыеПоля =
	"Период, ХозяйственнаяОперация, Организация, Подразделение, НаправлениеДеятельности, КорНаправлениеДеятельности,
	|ТипЗапасов, ВидЗапасов, ИсточникГФУНоменклатуры, ДокументДвижения";

	СуммовыеПоля = "
	|Стоимость, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, 
	|СтоимостьРегл, СтоимостьНДД, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр,
	|ПостояннаяРазница, ВременнаяРазница";
	
	КопируемыеПоля = КопируемыеПоля + ", " + СуммовыеПоля;

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", "ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "АналитикаУчетаНоменклатуры", "АналитикаУчетаПродукцииСебестоимость");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорАналитикаУчетаНоменклатуры", "АналитикаУчетаПродукцииСебестоимость");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Склад", "АналитикаУчетаПродукцииСебестоимость.МестоХранения");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорСклад", "АналитикаУчетаПродукцииСебестоимость.МестоХранения");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорТипЗапасов", "ТипЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорВидЗапасов", "ВидЗапасов");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "КорИсточникГФУНоменклатуры", "ИсточникГФУНоменклатуры");
	
	УсловиеГДЕ = "ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И НЕ ЭтоКорректировка";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

//-- НЕ УТ
#КонецОбласти

#Область ДвиженияПрочиеРасходы

// Служебная, этап 2.1, 3.18
Процедура СформироватьДвиженияПрочиеРасходыСписаниеНДС(ПараметрыРасчета) Экспорт
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	
	КопируемыеПоля =
		"Период, ВидДвижения, ХозяйственнаяОперация, Организация, АналитикаУчетаНоменклатуры, НаправлениеДеятельности, НастройкаХозяйственнойОперации,
		|Подразделение, СтатьяРасходов, АналитикаРасходов, ДокументДвижения, ИдентификаторФинЗаписи, ПостояннаяРазница, СуммаРегл, СуммаУпр";
	
	Запрос = Новый Запрос;
	РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьСвойстваЗапроса(Запрос, ПараметрыРасчета);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Партии.Период 														КАК Период,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) 								КАК ВидДвижения,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.СписаниеНДСПоПриобретеннымЦенностям)	КАК ХозяйственнаяОперация,
	|	ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.СписаниеНДСПоПриобретеннымЦенностям)	КАК НастройкаХозяйственнойОперации,
	|	Партии.Организация 													КАК Организация,
	|	Партии.АналитикаУчетаНоменклатуры 									КАК АналитикаУчетаНоменклатуры,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)) 					КАК НаправлениеДеятельности,
	// Подразделение должно заполняться аналогично УчетНДСРФ.ПолучитьПартии
	|	Партии.ПодразделениеСписанияНДС										КАК Подразделение,
	|	Партии.СтатьяСписанияНДС 											КАК СтатьяРасходов,
	|	Партии.АналитикаСписанияНДС 										КАК АналитикаРасходов,
	|	Партии.Регистратор 													КАК ДокументДвижения,
	|	&ИдентификаторНеиспользуемойФинЗаписи								КАК ИдентификаторФинЗаписи,
	|	СУММА(ВЫБОР КОГДА ЕСТЬNULL(СтатьиРасходов.ПринятиеКНалоговомуУчету, ИСТИНА)
	|			ТОГДА 0
	|			ИНАЧЕ Партии.СписаниеНДС
	|		КОНЕЦ)															КАК ПостояннаяРазница,
	|	СУММА(Партии.СписаниеНДС) 											КАК СуммаРегл,
	|	СУММА(Партии.СписаниеНДСУпр) 										КАК СуммаУпр
	|ИЗ
	|	ВтПартии КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО Партии.АналитикаУчетаНоменклатуры = АналитикаНоменклатуры.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК СпрНазначения
	|		ПО СпрНазначения.Ссылка = АналитикаНоменклатуры.Назначение
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО Партии.СтатьяСписанияНДС = СтатьиРасходов.Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.Период,
	|	Партии.Организация,
	|	Партии.АналитикаУчетаНоменклатуры,
	|	Партии.ПодразделениеСписанияНДС,
	|	ЕСТЬNULL(СпрНазначения.НаправлениеДеятельности,
	|		ЗНАЧЕНИЕ(Справочник.Назначения.ПустаяСсылка)),
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.Регистратор
	|
	|ИМЕЮЩИЕ
	|	СУММА(Партии.СписаниеНДС) <> 0
	|	ИЛИ СУММА(Партии.СписаниеНДСУпр) <> 0
	|";
	
	Выборка = РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросСЗамеромДляПротокола(ПараметрыРасчета, Запрос, Истина,,, ИмяРегистра);
	
	Пока Выборка.Следующий() Цикл
		// Добавим движение и заполним его свойства.
		ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, Выборка, КопируемыеПоля);
	КонецЦикла;
	
КонецПроцедуры

// Служебная, этап 2.1, 3.1, 3.3, 3.14
Процедура СформироватьДвиженияПрочиеРасходы(ПараметрыРасчета, ДанныеДвижения, СуммовыеПоказатели) Экспорт

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, АналитикаРасходов, ХозяйственнаяОперация,
	|АналитикаУчетаНоменклатуры, ГруппаПродукции, ДокументДвижения, ИдентификаторФинЗаписи";
	
	Сумма = СуммовыеПоказатели.СуммаСНДС;
	СуммаБезНДС = СуммовыеПоказатели.СуммаБезНДС;
	СуммаРегл = СуммовыеПоказатели.СуммаРегл;
	СуммаУпр = СуммовыеПоказатели.СуммаУпр;
	ПостояннаяРазница = СуммовыеПоказатели.ПостояннаяРазница;
	ВременнаяРазница = СуммовыеПоказатели.ВременнаяРазница;
	СуммаНДД = СуммовыеПоказатели.СуммаНДД;

	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
	
	Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы
	 И НачалоМесяца(ДанныеДвижения.ПериодПродажи) < НачалоМесяца(ДанныеДвижения.Период) Тогда
		Знак = -1;
	Иначе
		Знак = 1;
	КонецЕсли;
	
	// Заполним дополнительные свойства движения
	Запись.ВидДвижения       = ВидДвиженияНакопления.Приход;
	Запись.Сумма             = Знак * Сумма;
	Запись.СтатьяРасходов    = ДанныеДвижения.СтатьяРасходовСписания;
	Запись.НаправлениеДеятельности = ДанныеДвижения.КорНаправлениеДеятельности;
	Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию Тогда
		Запись.Организация = ДанныеДвижения.КорОрганизация;
	КонецЕсли;
	Если ДанныеДвижения.ВариантРаспределенияРасходовУпр = Перечисления.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты Тогда
		Запись.СуммаБезНДС = Знак * СуммаБезНДС;
	КонецЕсли;
	
	Если НЕ ДанныеДвижения.ВариантРаспределенияРасходовУпр = Перечисления.ВариантыРаспределенияРасходов.НаПрочиеАктивы Тогда
		Если НЕ ПараметрыРасчета.УправленческийУчетОрганизаций
		 ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию Тогда
			Запись.СуммаУпр = 0;
		ИначеЕсли ДанныеДвижения.ВариантРаспределенияРасходовУпр = Перечисления.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы
		 И НЕ ПараметрыРасчета.ИспользуетсяУправлениеВНА_2_4 Тогда
			Запись.СуммаУпр = 0;
		Иначе
			Запись.СуммаУпр = Знак * СуммаУпр;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл
	 ИЛИ ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию
	 ИЛИ ДанныеДвижения.ВариантРаспределенияРасходовРегл = Перечисления.ВариантыРаспределенияРасходов.НаПрочиеАктивы
	 ИЛИ (ДанныеДвижения.ВариантРаспределенияРасходовРегл = Перечисления.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы
	 	И НЕ ПараметрыРасчета.ИспользуетсяУправлениеВНА_2_4) Тогда
		Запись.СуммаРегл = 0;
		Запись.ПостояннаяРазница = 0;
		Запись.ВременнаяРазница = 0;
		Запись.СуммаНДД = 0;
	Иначе
		Если ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию Тогда
			Запись.СуммаРегл = 0;
			//++ Локализация
			Запись.ПостояннаяРазница = ?(ДанныеДвижения.СписаниеПриПередачеНУ,
				?(НЕ ДанныеДвижения.ПринятиеКНалоговомуУчету, СуммаРегл - ВременнаяРазница - ПостояннаяРазница, 0), 0);
			Запись.ВременнаяРазница = ?(ДанныеДвижения.СписаниеПриПередачеНУ,
				?(НЕ ДанныеДвижения.ПринятиеКНалоговомуУчету, -(СуммаРегл - ВременнаяРазница - ПостояннаяРазница),
					-(СуммаРегл - ВременнаяРазница - ПостояннаяРазница)), 0);
			//-- Локализация
			Запись.СуммаНДД = 0;
		ИначеЕсли ДанныеДвижения.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатациюБУНУ Тогда
			Запись.СуммаРегл = 0;
			Запись.ПостояннаяРазница = 0;
			Запись.ВременнаяРазница = 0;
			Запись.СуммаНДД = 0;
		Иначе
			Запись.СуммаРегл = Знак * СуммаРегл;
			Запись.ПостояннаяРазница = ?(НЕ ДанныеДвижения.ПринятиеКНалоговомуУчету, Знак * СуммаРегл - Знак * ВременнаяРазница, Знак * ПостояннаяРазница);
			Запись.ВременнаяРазница  = Знак * ВременнаяРазница;
			Запись.СуммаНДД  = Знак * СуммаНДД;
		КонецЕсли;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ДанныеДвижения.КорОрганизация)
	 И ДанныеДвижения.КорОрганизация <> ДанныеДвижения.Организация
	 И ДанныеДвижения.ХозяйственнаяОперация <> Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию Тогда
	 
		ЗаписьУпр = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
		ЗаписьУпр.СтатьяРасходов = ДанныеДвижения.СтатьяРасходовСписания;
		ЗаписьУпр.Сумма = -Запись.Сумма;
		ЗаписьУпр.СуммаУпр = -Запись.СуммаУпр;
		ЗаписьУпр.СуммаРегл = 0;
		ЗаписьУпр.ПостояннаяРазница = 0;
		ЗаписьУпр.ВременнаяРазница  = 0;
		ЗаписьУпр.СуммаНДД  = 0;
		ЗаписьУпр.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СторнированиеРасходовУУ;
		
		ЗаписьУпр = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
		ЗаписьУпр.Организация = ДанныеДвижения.КорОрганизация;
		ЗаписьУпр.СтатьяРасходов = ДанныеДвижения.СтатьяРасходовСписания;
		ЗаписьУпр.Сумма = Запись.Сумма;
		ЗаписьУпр.СуммаУпр = Запись.СуммаУпр;
		ЗаписьУпр.СуммаРегл = 0;
		ЗаписьУпр.ПостояннаяРазница = 0;
		ЗаписьУпр.ВременнаяРазница  = 0;
		ЗаписьУпр.СуммаНДД  = 0;
		ЗаписьУпр.ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РегистрацияРасходовУУ;
		
		// Добавим движения по регистру "Активы и пассивы".
		ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя;
	
		КопируемыеПоля = "
		|Период, Организация, Подразделение, НаправлениеДеятельности";
		
		// Добавим движение и заполним его основные свойства
		Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
		
		// Заполним дополнительные свойства движения
		Запись.ВидДвижения = ВидДвиженияНакопления.Приход;
		Запись.Статья      = ПланыВидовХарактеристик.СтатьиАктивовПассивов.ПрибылиИУбытки;
		Запись.Аналитика   = ДанныеДвижения.Организация;
		Запись.Сумма 	   = Знак * Сумма;
		
		// Добавим движение и заполним его основные свойства
		Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
		
		// Заполним дополнительные свойства движения
		Запись.ВидДвижения = ВидДвиженияНакопления.Расход;
		Запись.Организация = ДанныеДвижения.КорОрганизация;
		Запись.Статья      = ПланыВидовХарактеристик.СтатьиАктивовПассивов.ПрибылиИУбытки;
		Запись.Аналитика   = ДанныеДвижения.КорОрганизация;
		Запись.Сумма 	   = Знак * Сумма;
	 
	КонецЕсли;
	
КонецПроцедуры

//++ НЕ УТ

Процедура СформироватьДвиженияПрочиеРасходыСписаниеНЗПЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	ИмяВременнойТаблицы = "ВтПрочиеРасходыСписаниеНЗПДвижения";
	
	КопируемыеПоля = "
	|Период, Организация, СтатьяРасходов, АналитикаРасходов, НаправлениеДеятельности, ДокументДвижения, КорПодразделение, КорНаправлениеДеятельности,
	|ИдентификаторФинЗаписи, БазаРаспределения";
	
	СуммовыеПоля = "
	|Стоимость, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС, СтоимостьРегл, СтоимостьНДД,
	|СтоимостьЗабалансовая, Трудозатраты, ТрудозатратыБезНДС, ПостатейныеСНДС, ПостатейныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеРегл,
	|ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, 
	|ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ДоляСтоимости";
	
	КопируемыеПоля = КопируемыеПоля + ", " + СуммовыеПоля;

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра);
	
	// Заполним дополнительные свойства движения
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ЛОЖЬ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", 
		"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВыпускПродукции)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации", 
		"ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВыпускПродукции)");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Подразделение", "ИсходноеПодразделение");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "СуммаСНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС", "СуммаБезНДС");
			
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", "СуммаРегл");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "ПостояннаяРазница");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", "ВременнаяРазница");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаНДД", "СуммаНДД");

	КонецЕсли;
	
	Если ПараметрыРасчета.УправленческийУчетОрганизаций Тогда
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "ДопРасходыУпр + ТрудозатратыУпр + ПостатейныеПостоянныеУпр + ПостатейныеПеременныеУпр");
		
	КонецЕсли;
	
	УсловиеГДЕ = "ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И НЕ ЭтоКорректировка";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
	// Отражение временной разницы при включении/исключении НДС в стоимости.
	ИмяВременнойТаблицы = "ВтПрочиеРасходыВключениеИсключениеНДС";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВидДвижения", "ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СлужебноеВидДвиженияПриход", "ИСТИНА");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ХозяйственнаяОперация", 
		"ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ВключениеИсключениеНДСВСтоимости)");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НастройкаХозяйственнойОперации", 
		"ЗНАЧЕНИЕ(Справочник.НастройкиХозяйственныхОпераций.ВключениеИсключениеНДСВСтоимости)");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Сумма", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаБезНДС", "0");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаУпр", "0");
	
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
		
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СуммаРегл", "0");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ПостояннаяРазница", "-ПостояннаяРазница");
		РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ВременнаяРазница", "-ВременнаяРазница");
		
	КонецЕсли;
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ИдентификаторФинЗаписи", "&ИдентификаторНеиспользуемойФинЗаписи");
	
	УсловиеГДЕ = "ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|И ЭтоКорректировка
	|И ЕСТЬNULL(СтатьяРасходов.ПринятиеКНалоговомуУчету, ЛОЖЬ)
	|И (ПостояннаяРазница <> 0 ИЛИ ВременнаяРазница <> 0)";
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы, УсловиеГДЕ);
		
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

// Служебная, этап 2.4, 3.16
Процедура СформироватьДвиженияПрочиеРасходыПрочееСписаниеНЗП(ПараметрыРасчета, ДанныеДвижения) Экспорт

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, СтатьяРасходов, АналитикаРасходов, НаправлениеДеятельности, 
	|БазаРаспределения,
	|ХозяйственнаяОперация, ДокументДвижения, ИдентификаторСтроки, НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи";
	
	// Расход по исходной статье
	
	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
	Запись.ВидДвижения = ВидДвиженияНакопления.Расход;
	Запись.КорСтатьяРасходов = ДанныеДвижения.СтатьяРасходовПолучатель;
	Запись.КорПодразделение = ДанныеДвижения.КорПодразделение;
	Запись.КорАналитикаРасходов = ДанныеДвижения.АналитикаРасходовПолучатель;
	Запись.КорНаправлениеДеятельности 	 = ДанныеДвижения.КорНаправлениеДеятельности;
	
	Запись.Сумма 			 = ДанныеДвижения.Стоимость + ДанныеДвижения.ДопРасходы;
	Запись.СуммаБезНДС 		 = ДанныеДвижения.СтоимостьБезНДС + ДанныеДвижения.ДопРасходыБезНДС;
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
		Запись.СуммаРегл 		 = ДанныеДвижения.СтоимостьРегл;
		Запись.ПостояннаяРазница = ДанныеДвижения.ПостояннаяРазница;
		Запись.ВременнаяРазница  = ДанныеДвижения.ВременнаяРазница;
		Запись.СуммаНДД 		 = ДанныеДвижения.СтоимостьНДД;
	КонецЕсли;
	Если ПараметрыРасчета.УправленческийУчетОрганизаций Тогда
		Запись.СуммаУпр = ДанныеДвижения.СтоимостьУпр;
	КонецЕсли;
	
	// Приход по новой статье.
	Если ЗначениеЗаполнено(ДанныеДвижения.СтатьяРасходовПолучатель) Тогда
	
		// Добавим движение и заполним его основные свойства
		Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
		
		// Заполним дополнительные свойства движения
		Запись.ВидДвижения 		 = ВидДвиженияНакопления.Приход;
		Запись.Подразделение	= ДанныеДвижения.КорПодразделение;
		Запись.НаправлениеДеятельности 	 = ДанныеДвижения.КорНаправлениеДеятельности;
		Запись.СтатьяРасходов 	 = ДанныеДвижения.СтатьяРасходовПолучатель;
		Запись.АналитикаРасходов = ДанныеДвижения.АналитикаРасходовПолучатель;
		Запись.КорСтатьяРасходов = ДанныеДвижения.СтатьяРасходов;
		Запись.КорПодразделение = ДанныеДвижения.Подразделение;
		Запись.КорАналитикаРасходов = ДанныеДвижения.АналитикаРасходов;
		Запись.КорНаправлениеДеятельности 	 = ДанныеДвижения.НаправлениеДеятельности;
		
		Запись.Сумма 			 = ДанныеДвижения.Стоимость + ДанныеДвижения.ДопРасходы;
		Запись.СуммаБезНДС 		 = ?(ДанныеДвижения.ИсключитьСтоимостьБезНДС, 0, 
			ДанныеДвижения.СтоимостьБезНДС + ДанныеДвижения.ДопРасходыБезНДС);
		Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
			Запись.СуммаРегл 		 = ДанныеДвижения.СтоимостьРегл;
			Запись.ПостояннаяРазница = ?(ДанныеДвижения.ПринятиеКНУПриСписании,
										ДанныеДвижения.ПостояннаяРазница,
										ДанныеДвижения.СтоимостьРегл);
			Запись.ВременнаяРазница  = ?(ДанныеДвижения.ПринятиеКНУПриСписании,
										ДанныеДвижения.ВременнаяРазница,
										0);
			Запись.СуммаНДД 	 = ДанныеДвижения.СтоимостьНДД;
		КонецЕсли;
		Если ПараметрыРасчета.УправленческийУчетОрганизаций Тогда
			Запись.СуммаУпр = ДанныеДвижения.СтоимостьУпр;
		КонецЕсли;
	ИначеЕсли ЗначениеЗаполнено(ДанныеДвижения.СтатьяАктивовПассивов) Тогда
		СформироватьДвиженияПрочиеАктивыПассивы(ПараметрыРасчета, ДанныеДвижения, ДанныеДвижения.Стоимость + ДанныеДвижения.ДопРасходы);
	КонецЕсли;
	
КонецПроцедуры

Процедура СформироватьДвиженияДоходыРасходыПрочиеАктивыПассивыПрочееСписаниеНЗП(ПараметрыРасчета, ДанныеДвижения)

	ИмяРегистра = Метаданные.РегистрыНакопления.ДвиженияДоходыРасходыПрочиеАктивыПассивы.Имя;
	
	КопируемыеПоля = "
	|Период, ХозяйственнаяОперация, Организация, Подразделение, НаправлениеДеятельности, АналитикаРасходов,
	|КорПодразделение, КорНаправлениеДеятельности, ДокументДвижения";
	
	// Расход по исходной статье
	
	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
	Запись.Статья = ДанныеДвижения.СтатьяРасходов;
	Если ЗначениеЗаполнено(ДанныеДвижения.СтатьяАктивовПассивов) Тогда
		Запись.КорСтатья = ДанныеДвижения.СтатьяАктивовПассивов;
	Иначе
		Запись.КорСтатья = ДанныеДвижения.СтатьяРасходовПолучатель;
	КонецЕсли;
	Запись.КорАналитикаРасходов = ДанныеДвижения.АналитикаРасходовПолучатель;
	Запись.КорАналитикаАктивовПассивов = ДанныеДвижения.АналитикаАктивовПассивов;
	
	Запись.Сумма = ДанныеДвижения.Стоимость + ДанныеДвижения.ДопРасходы;
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
		Запись.СуммаРегл = ДанныеДвижения.СтоимостьРегл;
	КонецЕсли;
	Если ПараметрыРасчета.УправленческийУчетОрганизаций Тогда
		Запись.СуммаУпр = ДанныеДвижения.СтоимостьУпр;
	КонецЕсли;
	
КонецПроцедуры

//-- НЕ УТ
#КонецОбласти

#Область ДвиженияПрочиеДоходы

// Служебная, этап 2.1, 3.3, 3.14
Процедура СформироватьДвиженияПрочиеДоходы(ПараметрыРасчета, ДанныеДвижения,
			Сумма, СуммаРегл, СуммаУпр) Экспорт
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеДоходы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация, Подразделение, СтатьяДоходов, АналитикаДоходов, ХозяйственнаяОперация";

	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
	Запись.ВидДвижения = ВидДвиженияНакопления.Приход;
	Запись.НаправлениеДеятельности = ДанныеДвижения.КорНаправлениеДеятельности;
	Запись.Сумма	   = Сумма;
	Запись.СуммаУпр	   = СуммаУпр;
	Если ПараметрыРасчета.ФО.ИспользоватьУчетПрочихДоходовРасходовРегл Тогда
		Запись.СуммаРегл = СуммаРегл;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ДвиженияВыручкаИСебестоимостьПродаж

// Служебная, этап 2.2, 3.17, 3.18
Процедура СформироватьДвиженияВыручкаИСебестоимостьПродаж(ПараметрыРасчета, ДанныеДвижения) Экспорт
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж.Имя;
	
	КопируемыеПоля = "
	|Период, Подразделение, АналитикаУчетаНоменклатуры, Менеджер, РазделУчета,
	|АналитикаУчетаПоПартнерам, ТипЗапасов, ВидЗапасов, ЗаказКлиента, ХозяйственнаяОперация,
	|Склад, Соглашение, Договор, ВалютаВзаиморасчетов, ВалютаДокумента,
	|ИсточникГФУНоменклатуры, ИсточникГФУРасчетов, НаправлениеДеятельностиНоменклатуры,
	|НаправлениеДеятельностиКонтрагента, 
	|НалогообложениеНДС, ДокументДвижения, ИдентификаторФинЗаписи,
	|Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС";
	
	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
	ПоляРесурсов = "
		|Стоимость, СтоимостьБезНДС, ПостояннаяРазница, ВременнаяРазница,
		|СтоимостьРегл, ДопРасходы, ДопРасходыБезНДС,
		|СтоимостьЗабалансовая, Трудозатраты, ПостатейныеПостоянныеСНДС, ПостатейныеПеременныеСНДС,
		|ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеБезНДС,
		|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл,
		|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр";
	
	ЗаполнитьЗначенияСвойств(Запись, ДанныеДвижения, ПоляРесурсов);
	
	Если ДанныеДвижения.НДСРегл <> 0 Тогда
		
		// Добавим движение и заполним его основные свойства
		Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
		
		// Заполним дополнительные свойства движения
		Запись.СтоимостьРегл = ДанныеДвижения.НДСРегл;
		
	КонецЕсли;
	
	Если ДанныеДвижения.НДСУпр <> 0 Тогда
		
		// Добавим движение и заполним его основные свойства
		Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
		
		// Заполним дополнительные свойства движения
		Запись.СтоимостьУпр = ДанныеДвижения.НДСУпр;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

//++ НЕ УТ
#Область ДвиженияПрочиеРасходыНезавершенногоПроизводства

Процедура СформироватьДвиженияПрочиеРасходыНезавершенногоПроизводстваЗапросом(ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)
	
	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства.Имя;
	ИмяВременнойТаблицы = "ВтПрочиеРасходыНезавершенногоПроизводстваДвижения";
	
	КопируемыеПоля = "
	|Период, ВидДвижения, Организация, Подразделение, ЗаказНаПроизводство, КодСтрокиПродукция, Этап,
	|СтатьяКалькуляции, СтатьяРасходов, АналитикаРасходов, ГруппаПродукции,
	|Продукция, ХарактеристикаПродукции, АналитикаУчетаПродукции, КорАналитикаУчетаПартий,
	|РазделУчета, ВидЗапасов, ДокументДвижения, ДокументВыпуска,
	|НастройкаХозяйственнойОперации, ИдентификаторФинЗаписи,
	|АналитикаПартииВыпуска, ПравилоОтнесенияНаВыпуск";
	
	КопируемыеПоля = КопируемыеПоля
		+ ", ПартияПроизводства";
	
	СуммовыеПоля = "
	|Стоимость, СтоимостьБезНДС, ДопРасходы, ДопРасходыБезНДС, СтоимостьРегл, СтоимостьНДД,
	|ПостояннаяРазница, ВременнаяРазница,
	|СтоимостьЗабалансовая, Трудозатраты, ТрудозатратыБезНДС, ПостатейныеСНДС, ПостатейныеБезНДС,
	|СтоимостьЗабалансоваяРегл, ДопРасходыРегл, ТрудозатратыРегл, ПостатейныеРегл,
	|ПостатейныеПостоянныеСНДС, ПостатейныеПостоянныеБезНДС, ПостатейныеПеременныеСНДС, ПостатейныеПеременныеБезНДС, 
	|ПостатейныеПостоянныеРегл, ПостатейныеПеременныеРегл, ПостатейныеПостоянныеУпр, ПостатейныеПеременныеУпр,
	|СтоимостьУпр, ДопРасходыУпр, ТрудозатратыУпр, ДоляСтоимости";
	
	КопируемыеПоля = КопируемыеПоля + ", " + СуммовыеПоля;

	ОписаниеПриемника = ПараметрыРасчета.Движения[ИмяРегистра];
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ИмяРегистра, Истина);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ДокументВыпуска", "
	|ВЫБОР
	|	КОГДА ТИПЗНАЧЕНИЯ(ДокументВыпуска) В (" + РасчетСебестоимостиПрикладныеАлгоритмы.ДоступныеТипыДокумента(ИмяРегистра, "ДокументВыпуска") + ") ТОГДА
	|		ДокументВыпуска
	|	ИНАЧЕ
	|		Неопределено
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "НаправлениеДеятельности", "КорНаправлениеДеятельности");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "Стоимость", "СуммаСНДС");
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьБезНДС", "СуммаБезНДС");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьРегл", "СуммаРегл");
			
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьУпр", "СуммаУпр");
			
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "СтоимостьНДД", "СуммаНДД");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьПолеВОписанииПолейЗапроса(ТаблицаОписанияПолей, "ИдентификаторФинЗаписи", "
	|ВЫБОР
	|	КОГДА НЕ ЭтоКорректировка
	|		ТОГДА ИдентификаторФинЗаписи
	|		ИНАЧЕ &ИдентификаторНеиспользуемойФинЗаписи
	|КОНЕЦ");
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, ИмяРегистра,
		"ДвиженияТаблицаКорректировки", ИмяВременнойТаблицы);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ИмяВременнойТаблицы, ИмяРегистра);
	
КонецПроцедуры

#КонецОбласти
//-- НЕ УТ

#Область ДвиженияПрочиеАктивыПассивы

// Служебная, этап 2.1
Процедура СформироватьДвиженияПрочиеАктивыПассивы(ПараметрыРасчета, ДанныеДвижения, Сумма) Экспорт

	ИмяРегистра = Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы.Имя;
	
	КопируемыеПоля = "
	|Период, Организация";
	
	// Добавим движение и заполним его основные свойства
	Запись = ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ИмяРегистра, ДанныеДвижения, КопируемыеПоля);
	
	// Заполним дополнительные свойства движения
	Запись.ВидДвижения = ВидДвиженияНакопления.Приход;
	Запись.Сумма 	   = Сумма;
	Запись.Статья 	   = ДанныеДвижения.СтатьяАктивовПассивов;
	Запись.Аналитика   = ДанныеДвижения.АналитикаАктивовПассивов;
	Запись.НаправлениеДеятельности = ДанныеДвижения.КорНаправлениеДеятельности;

КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область РаспределениеСтоимости

// Служебная, этап 2.1, 2.2, 3.1, 3.18
Процедура РаспределитьСтоимость(ЗаписьРаспределения, СтрокаОстатка, Выборка, Знач КоличествоКРаспределению) Экспорт
	
	СуммыОстатка 	= ПолучитьСуммовыеПоказателиРаспределения(СтрокаОстатка);
	СуммыКСписанию 	= ПолучитьСуммовыеПоказателиРаспределения();
	
	Если КоличествоКРаспределению >= СтрокаОстатка.Количество Тогда
		
		ЗаполнитьЗначенияСвойств(СуммыКСписанию, СуммыОстатка);
		
		КоличествоКРаспределению = КоличествоКРаспределению - СтрокаОстатка.Количество;
		КоличествоКСписанию	     = СтрокаОстатка.Количество;
		
		//++ НЕ УТ

		//++ Устарело_Производство21
		Если НЕ (ТипЗнч(Выборка.Регистратор) = Тип("ДокументСсылка.ВыпускПродукции")
		 И Выборка.ВидДвижения = ВидДвиженияНакопления.Приход) Тогда
			СтрокаОстатка.Количество = 0;
		КонецЕсли;
		//-- Устарело_Производство21

		//-- НЕ УТ

	ИначеЕсли КоличествоКРаспределению < СтрокаОстатка.Количество Тогда
		
		Для Каждого КлючИЗначение Из СуммыОстатка Цикл
			
			СуммыКСписанию[КлючИЗначение.Ключ] =
				Окр((КоличествоКРаспределению * СуммыОстатка[КлючИЗначение.Ключ] / СтрокаОстатка.Количество), 2);
				
			СуммыОстатка[КлючИЗначение.Ключ] = СуммыОстатка[КлючИЗначение.Ключ] - СуммыКСписанию[КлючИЗначение.Ключ];
				
		КонецЦикла;
		
		КоличествоКСписанию		 = КоличествоКРаспределению;
		КоличествоКРаспределению = 0;
		СтрокаОстатка.Количество = СтрокаОстатка.Количество - КоличествоКСписанию;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, Выборка);
	
	Если Выборка.ИсходноеКоличество < 0 Тогда
		
		Для Каждого КлючИЗначение Из СуммыКСписанию Цикл
			
			СуммыКСписанию[КлючИЗначение.Ключ] = -СуммыКСписанию[КлючИЗначение.Ключ];
				
		КонецЦикла;
		
		ЗаписьРаспределения.Количество = -КоличествоКСписанию;
		
	Иначе
		
		СуммыВыборки = ПолучитьСуммовыеПоказателиРаспределения(Выборка);
		
		Для Каждого КлючИЗначение Из СуммыКСписанию Цикл
			
			СуммыКСписанию[КлючИЗначение.Ключ] = СуммыКСписанию[КлючИЗначение.Ключ] - СуммыВыборки[КлючИЗначение.Ключ];
				
		КонецЦикла;
		
		ЗаписьРаспределения.Количество = КоличествоКСписанию;
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, СуммыКСписанию);
	ЗаполнитьЗначенияСвойств(СтрокаОстатка, СуммыОстатка);
	
КонецПроцедуры

// Служебная, этап 2.1, 3.1
Процедура ДополнитьСуммыРаспределения(ЗаписьРаспределения, СуммыРаспределения) Экспорт
	
	СуммыЗаписи 	= ПолучитьСуммовыеПоказателиРаспределения(ЗаписьРаспределения);
	СуммыДополнения = ПолучитьСуммовыеПоказателиРаспределения(СуммыРаспределения);
	
	Для Каждого КлючИЗначение Из СуммыЗаписи Цикл
		Если СуммыЗаписи[КлючИЗначение.Ключ] <> Неопределено Тогда
			СуммыЗаписи[КлючИЗначение.Ключ] =
				СуммыЗаписи[КлючИЗначение.Ключ] + СуммыДополнения[КлючИЗначение.Ключ];
		КонецЕсли;
	КонецЦикла;
	
	ЗаполнитьЗначенияСвойств(ЗаписьРаспределения, СуммыЗаписи);
	
КонецПроцедуры

Функция ПолучитьСуммовыеПоказателиРаспределения(ДанныеЗаполнения = Неопределено)
	
	ДанныеСумм = Новый Структура;
	ДанныеСумм.Вставить("Стоимость", 			  	0);
	ДанныеСумм.Вставить("СтоимостьБезНДС", 		  	0);
	ДанныеСумм.Вставить("СтоимостьЗабалансовая", 	0);
	ДанныеСумм.Вставить("ДопРасходы", 	  		  	0);
	ДанныеСумм.Вставить("ДопРасходыБезНДС", 	  	0);
	ДанныеСумм.Вставить("СтоимостьРегл", 		  	0);
	ДанныеСумм.Вставить("ДопРасходыРегл", 		  	0);
	ДанныеСумм.Вставить("СтоимостьЗабалансоваяРегл",0);
	ДанныеСумм.Вставить("НДСРегл", 			    	0);
	ДанныеСумм.Вставить("ПостояннаяРазница", 		0);
	ДанныеСумм.Вставить("ВременнаяРазница", 		0);
	ДанныеСумм.Вставить("СтоимостьНДД", 			0);
	ДанныеСумм.Вставить("СтоимостьУпр", 		  	0);
	ДанныеСумм.Вставить("ДопРасходыУпр",  		  	0);
	ДанныеСумм.Вставить("НДСУпр",	 			    0);
	ДанныеСумм.Вставить("ПостатейныеПостоянныеРегл",0);
	ДанныеСумм.Вставить("ПостатейныеПеременныеРегл",0);
	ДанныеСумм.Вставить("ПостатейныеПостоянныеУпр", 0);
	ДанныеСумм.Вставить("ПостатейныеПеременныеУпр",	0);
	
	Если ДанныеЗаполнения <> Неопределено Тогда
		ЗаполнитьЗначенияСвойств(ДанныеСумм, ДанныеЗаполнения);
	КонецЕсли;
	
	Возврат ДанныеСумм;
	
КонецФункции

#КонецОбласти

#Область УниверсальныеПроцедурыРаботыСЗапросами

// Дополняет свойства запроса данными характерными для корректировки стоимости.
//
// Параметры:
//	Запрос - Запрос - Запрос для которого устанавливаются параметры
//	ПараметрыРасчета - см. РасчетСебестоимостиПрикладныеАлгоритмы.ИнициализироватьОбщиеПараметрыРасчета
//
Процедура ДополнитьСвойстваЗапроса(Запрос, ПараметрыРасчета) Экспорт
	
	// Параметр "СредняяЗаМесяц" используется в предыдущей версии расчета СЛУ в функциях формирования узлов корректировки. 
	МетодОценки = Неопределено;
	ПараметрыРасчета.Свойство("МетодОценки", МетодОценки);
	Запрос.УстановитьПараметр("СредняяЗаМесяц", МетодОценки = Перечисления.МетодыОценкиСтоимостиТоваров.СредняяЗаМесяц);
	
	// Параметры, относящиеся только к расчету себестоимости.
	Запрос.УстановитьПараметр("ЗначениеПогрешностиСебестоимостьРегл", ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиСебестоимостьРегл);
	Запрос.УстановитьПараметр("ЗначениеПогрешностиСебестоимостьУпр", ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиСебестоимостьУпр);
	Запрос.УстановитьПараметр("ЗначениеПогрешностиРасходыРегл", ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиРасходыРегл);
	Запрос.УстановитьПараметр("ЗначениеПогрешностиРасходыУпр", ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиРасходыУпр);
	Запрос.УстановитьПараметр("ЗначениеПогрешностиКоличество", ПараметрыРасчета.ПогрешностиРешенияСЛУ.ЗначениеПогрешностиКоличество);
	
	Запрос.УстановитьПараметр("ЗащитаОтПереполненияПоля", Pow(10, ПараметрыРасчета.РешениеСЛУ.ЗащитаОтПереполненияПоля) - 1);
	
	// Отборы по хозяйственным операциям.
	Запрос.УстановитьПараметр("МассивОперацийРеализации", МассивОперацийРеализации());
	Запрос.УстановитьПараметр("МассивОперацийВозвратыПрошлыхПериодов", МассивОперацийВозвратыПрошлыхПериодов());
	Запрос.УстановитьПараметр("МассивОперацийПередачи", МассивОперацийПередачиТоваров());
	Запрос.УстановитьПараметр("МассивОперацийПоступление", МассивОперацийВнешнееПоступление());
	Запрос.УстановитьПараметр("МассивОперацийПоступлениеВнешнее", МассивОперацийДляОценкиОстаткаТоваровПоФИФО());
	//++ НЕ УТ
	Запрос.УстановитьПараметр("ВидыРасходовНормируемые", Перечисления.ВидыРасходовНУ.НормируемыеРасходы());
	//-- НЕ УТ
	
	// Определяет какого типа должна формироваться разница по статье погрешности расчета себестоимости
	ПогрешностьРасчетаСебестоимости = ПланыВидовХарактеристик.СтатьиРасходов.ПогрешностьРасчетаСебестоимости;
	ПогрешностьПринимаетсяВНУ = Истина;
	//++ НЕ УТ
	ПогрешностьПринимаетсяВНУ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ПогрешностьРасчетаСебестоимости, "ПринятиеКНалоговомуУчету");
	//-- НЕ УТ
	Запрос.УстановитьПараметр("ПогрешностьПринимаетсяВНУ", ПогрешностьПринимаетсяВНУ);
	
КонецПроцедуры

#Область ОтборыПоХозяйственнымОперациям

Функция МассивОперацийРеализации()
	
	МассивОпераций = Новый Массив;
	
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.РеализацияКлиенту);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.РеализацияКомиссионногоТовара);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.РеализацияВРозницу);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.СторноРеализации);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ОтчетКомиссионера);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ОтчетПоКомиссииМеждуОрганизациями);;
	//++ Устарело_Переработка24
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ОтчетДавальцу);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВозвратДавальцу);
	//-- Устарело_Переработка24
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВыкупТоваровПереработчиком);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВыкупТоваровХранителем);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВозвратОтРозничногоПокупателя);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионера);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.РеализацияЧерезКомиссионераБезПереходаПраваСобственности);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ПереходПраваСобственности);
	//++ НЕ УТКА
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ОтчетДавальцу2_5);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ОтчетДавальцуСписаниеНаРасходы);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВозвратДавальцу2_5);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВыкупТоваровДавальца);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями);
	//-- НЕ УТКА
	
	Возврат МассивОпераций;
	
КонецФункции

Функция МассивОперацийПередачиТоваров()

	Массив = Новый Массив;
	
	Массив.Добавить(Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию);
	Массив.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТоваровМеждуОрганизациями);
	
	Возврат Массив;
	
КонецФункции

Функция МассивОперацийВозвратыПрошлыхПериодов()

	МассивОпераций = Новый Массив;
	
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ОтчетКомиссионера);
	МассивОпераций.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТоваровЧерезКомиссионераПрошлыхПериодов);
	
	Возврат МассивОпераций;
	
КонецФункции

Функция МассивОперацийВнешнееПоступление()

	// Формируется список всех хоз. операций, которые являются внешним поступлением (известна их стоимость).
	ХозОперации = Новый Массив;
	
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаЧерезПодотчетноеЛицо);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаПоИмпорту);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаТоварыВПути);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСНеотфактурованнаяПоставка);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСФактуровкаПоставки);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаНеотфактурованнаяПоставка);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаФактуровкаПоставки);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОприходованиеТоваров);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОприходованиеПоВозврату);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОтчетКомитентуОСписании);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПорчаТоваровСПереоценкой);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет); // сторнирование реализации регл. учета по управленческой организации
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПередачаПродукцииИзПроизводстваФиксированнаяСтоимость);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.СписаниеРасходовНаПартииПроизводства);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОприходованиеИзлишковОтгруженныхТоваров);
	
	//++ Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПоступлениеОтПереработчикаФиксированнаяСтоимость);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОтчетДавальцу);
	//-- Устарело_Переработка24
	
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОтчетДавальцуМеждуОрганизациями);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПередачаВПроизводство);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы);
	//++ Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПроизводствоУПереработчика);
	//-- Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПроизводствоУПереработчика2_5);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПроизводствоУПереработчикаВСтранахЕАЭС2_5);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВводОстатковЗатратПартийПроизводства);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.КорректировкаСтоимостиТМЦОприходованныхПриВыбытииОС);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.КорректировкаДоВводаОстатков);
	
	// Таможенная декларация (старые и новые хоз. операции).
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОформлениеГТДБрокером);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОформлениеГТДСамостоятельно);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ДополнительныеРасходыБезПартии);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ДополнительныеРасходыСПартией);
	
	// Возврат прошлого периода используется только для операций расчета по среднему,
	// т.к. оценивать остатки для ФИФО не корректно.
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТоваровОтКлиентаПрошлыхПериодов);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТарыОтКлиентаПрошлыхПериодов);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.КорректировкаПриобретенияПрошлогоПериода);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВозвратТоваровЧерезКомиссионераПрошлыхПериодов);
	
	// Операции по комиссионным и давальческим товарам.
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПриемНаКомиссию);
	//++ Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПоступлениеОтДавальца);
	//-- Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПоступлениеОтДавальца2_5);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию);
	
	// Операции по товарам на ответственном хранении.
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПриемНаХранениеСПравомПродажи);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВыкупПринятыхНаХранениеТоваров);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОприходованиеИзлишковТоваровВПользуПоклажедателя);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОприходованиеИзлишковТоваровВПользуКомитента);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВыкупТоваровДавальца);
	
	// Операции по агентской закупке товаров и услуг.
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПриемкаПодПринципала);
	
	// Пересортица партий.
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПересортицаПартийТоваров);
	
	// Ввод остатков при переходе на НДД.
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВводОстатковПриПереходеНаНДД);
	
	Возврат ХозОперации;

КонецФункции

Функция МассивОперацийДляОценкиОстаткаТоваровПоФИФО()

	ХозОперации = Новый Массив;
	
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаЧерезПодотчетноеЛицо);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаПоИмпорту);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОприходованиеТоваров);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОприходованиеПоВозврату);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОтчетКомитентуОСписании);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПересортицаТоваровСПереоценкой);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПорчаТоваровСПереоценкой);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет); // сторнирование реализации регл. учета по управленческой организации
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВыпускПродукцииФиксированнаяСтоимость);
	//++ Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПоступлениеОтПереработчикаФиксированнаяСтоимость);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОтчетДавальцу);
	//-- Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПередачаВПроизводство);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.СторноСписанияНаРасходы);
	//++ Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПроизводствоУПереработчика);
	//-- Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПроизводствоУПереработчика2_5);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПроизводствоУПереработчикаВСтранахЕАЭС2_5);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.КорректировкаДоВводаОстатков);
	
	// Таможенная декларация (старые и новые хоз. операции).
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОформлениеГТДБрокером);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ОформлениеГТДСамостоятельно);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ДополнительныеРасходыБезПартии);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ДополнительныеРасходыСПартией);
	
	// Операции по комиссионным и давальческим товарам.
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПриемНаКомиссию);
	//++ Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПоступлениеОтДавальца);
	//-- Устарело_Переработка24
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПередачаНаКомиссиюВДругуюОрганизацию);
	
	// Операции по товарам на ответственном хранении.
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ПриемНаХранениеСПравомПродажи);
	ХозОперации.Добавить(Перечисления.ХозяйственныеОперации.ВыкупПринятыхНаХранениеТоваров);
	
	Возврат ХозОперации;

КонецФункции

#КонецОбласти

Процедура СформироватьВТНаОснованииИсточника(ОписаниеВТ, ПараметрыРасчета, СоответствиеВременныхТаблицДвижений)
	
	ОписаниеПриемника = ПараметрыРасчета.Движения[ОписаниеВТ.Имя];
	
	Если ОписаниеВТ.ДобавлятьИдентификаторы Тогда
		РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьИдентификаторыВоВременнуюТаблицу(ПараметрыРасчета, ОписаниеПриемника, ОписаниеВТ.ИмяВТИсточника);
	КонецЕсли;
	
	КопируемыеПоля = РасчетСебестоимостиУниверсальныеАлгоритмы.ПолучитьИменаКолонокВременнойТаблицыСтрокой(ПараметрыРасчета, ОписаниеВТ.ИмяВТИсточника);
	
	ТаблицаОписанияПолей = РасчетСебестоимостиПрикладныеАлгоритмы.СформироватьОписаниеПолейЗапроса(ОписаниеПриемника.Таблица);
	РасчетСебестоимостиПрикладныеАлгоритмы.КопироватьПоляЗапроса(ТаблицаОписанияПолей, КопируемыеПоля);
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ВыполнитьЗапросПоОписаниюПолей(ПараметрыРасчета, ТаблицаОписанияПолей, 
		ОписаниеВТ.Имя, ОписаниеВТ.ИмяВТИсточника, ОписаниеВТ.ИмяВТРезультата);
	
	СоответствиеВременныхТаблицДвижений.Вставить(ОписаниеВТ.ИмяВТРезультата, ОписаниеВТ.Имя);
	
КонецПроцедуры

#КонецОбласти

#Область УниверсальныеПроцедурыРаботыСДвижениями

// Добавляет новую строку в таблицу движений указанного регистра и заполняет служебные поля.
// Сделана экспортной для вызова из модуля универсальных механизмов расчетов.
//
// Возвращаемое значение:
//	СтрокаТаблицыЗначений - добавленная строка в таблицу движений
//
Функция ДобавитьЗаписьВТаблицуДвижений(ПараметрыРасчета, ТаблицаПриемник, ДанныеДвижения,
			КопируемыеПоля = Неопределено, СлужебныеПоля = Неопределено) Экспорт
			
	Если ПараметрыРасчета.Движения.Свойство(ТаблицаПриемник) Тогда
		ОписаниеПриемника = ПараметрыРасчета.Движения[ТаблицаПриемник];
	Иначе
		ОписаниеПриемника = ПараметрыРасчета.ВспомогательныеВременныеТаблицы[ТаблицаПриемник];
	КонецЕсли;
	
	// Добавим запись универсальной процедурой, а потом дозаполним поля, относящиеся только к расчету себестоимости
	Запись = РасчетСебестоимостиПрикладныеАлгоритмы.ДобавитьЗаписьВТаблицуДвижений(
		ПараметрыРасчета,
		ОписаниеПриемника,
		ДанныеДвижения,
		КопируемыеПоля);
	
	// Заполним поле Регистратор из обязательного свойства ДокументДвижения источника ДанныеДвижения.
	Запись.Регистратор = ДанныеДвижения.ДокументДвижения;
	
	// Заполним пустой регистратор соответствующим документом расчета себестоимости
	Если ОписаниеПриемника.ЭтоОписаниеРегистра
	 И ПараметрыРасчета.Отладка.ИсправлятьПустойРегистратор И НЕ ЗначениеЗаполнено(Запись.Регистратор) Тогда
		
		ДокументыРасчетаПоОрганизациям  = ПараметрыРасчета.ДокументыРасчетаПоОрганизациям; // Соответствие
		ОрганизацияПоАналитикеПартнеров = ПараметрыРасчета.ОрганизацияПоАналитикеПартнеров; // Соответствие

		Если ОписаниеПриемника.ЕстьОрганизация Тогда
			Запись.Регистратор = ДокументыРасчетаПоОрганизациям.Получить(ДанныеДвижения.Организация);
		ИначеЕсли ОписаниеПриемника.ЕстьАналитикаПартнеров Тогда
			Запись.Регистратор = ДокументыРасчетаПоОрганизациям.Получить(
				ОрганизацияПоАналитикеПартнеров.Получить(ДанныеДвижения.АналитикаУчетаПоПартнерам));
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Запись.Регистратор) Тогда
			ТекстОшибки = НСтр("ru = 'Документ %1 установлен регистратором движения регистра %2 вместо %3,
				|который не может иметь движений по данному регистру.';
				|en = 'Document %1 is assigned as recorder for register %2 instead of %3
				|which cannot have records in this register.'", ОбщегоНазначения.КодОсновногоЯзыка());
			ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(ТекстОшибки,
				Запись.Регистратор,
				ТаблицаПриемник,
				ДанныеДвижения.ДокументДвижения);
			ЗаписьЖурналаРегистрации(
				РасчетСебестоимостиПрикладныеАлгоритмы.ИмяСобытияОшибкиДляЖурналаРегистрации(ПараметрыРасчета),
				УровеньЖурналаРегистрации.Предупреждение,
				,
				,
				ТекстОшибки);
		КонецЕсли;
		
	КонецЕсли;
	
	// Если регистратор не заполнен, то запомним информацию об ошибке
	Если ОписаниеПриемника.ЭтоОписаниеРегистра И НЕ ЗначениеЗаполнено(Запись.Регистратор) Тогда
		
		Если НЕ ЗначениеЗаполнено(ДанныеДвижения.ДокументДвижения) Тогда
			// Ошибка в запросах - не заполнено обязательное поле ДокументДвижения.
			ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Не заполнено свойство %1 для движения по регистру ""%2""';
					|en = '%1 property for ""%2"" register record is not filled in'", ОбщегоНазначения.КодОсновногоЯзыка()),
				"ДокументДвижения",
				ТаблицаПриемник);
		Иначе
			// Ошибка в метаданных - документ не является регистратором для данного регистра.
			ТекстДляПротокола = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru = 'Документ ""%1"" не может иметь движений по регистру ""%2""';
					|en = 'The ""%1"" document cannot have records in the ""%2"" register'", ОбщегоНазначения.КодОсновногоЯзыка()),
				СокрЛП(ДанныеДвижения.ДокументДвижения),
				ТаблицаПриемник);
		КонецЕсли;
		
		РасчетСебестоимостиПротоколРасчета.ЗафиксироватьОшибкуРасчета(
			ПараметрыРасчета,
			Перечисления.ТипыОшибокПартионногоУчетаИСебестоимости.ОшибкаФормированияДвиженийПоРегистрам,
			ТекстДляПротокола);
		
		Если ОписаниеПриемника.ЕстьОрганизация Тогда
			ОрганизацияСПроблемой = ДанныеДвижения.Организация;
		ИначеЕсли ОписаниеПриемника.ЕстьАналитикаПартнеров Тогда
			ОрганизацияПоАналитикеПартнеров = ПараметрыРасчета.ОрганизацияПоАналитикеПартнеров; // Соответствие
			ОрганизацияСПроблемой = ОрганизацияПоАналитикеПартнеров.Получить(ДанныеДвижения.АналитикаУчетаПоПартнерам);
		Иначе
			ОрганизацияСПроблемой = Неопределено;
		КонецЕсли;
			
		РасчетСебестоимостиПрикладныеАлгоритмы.ЗарегистрироватьПроблемуВыполненияРасчета(
			ПараметрыРасчета,
			ОрганизацияСПроблемой,
			НСтр("ru = 'При формировании движений диагностированы ошибки';
				|en = 'Errors were found when generating the movements'", ОбщегоНазначения.КодОсновногоЯзыка()),
			ТекстДляПротокола,
			ДанныеДвижения.ДокументДвижения);
		
		Для Каждого КлючИЗначение Из ПараметрыРасчета.ДокументыРасчетаПоОрганизациям Цикл
			// Заполним регистратор произвольным "первым" документом расчета себестоимости - чтобы движения можно было записать.
			// Расчет все равно в итоге будет завершен с ошибкой, но т.о. можно получить информацию о всех ошибочных регистраторах.
			Запись.Регистратор = КлючИЗначение.Ключ;
			Прервать;
		КонецЦикла;

	КонецЕсли;
	
	Возврат Запись;
	
КонецФункции

Процедура ДополнитьОписаниеПолейДляФормированияДвижений(ПараметрыРасчета, ТаблицаОписанияПолей, ОписаниеПриемника, КопируемыеПоля) Экспорт
	
	РасчетСебестоимостиПрикладныеАлгоритмы.ИзменитьРегистраторИДокументДвиженияВОписанииПолейЗапроса(ТаблицаОписанияПолей, ОписаниеПриемника.ИмяРегистра);
	
КонецПроцедуры

#КонецОбласти

#Область УниверсальныеПроцедурыОписанияДанныхМеханизма

// Возвращает перечень объектов метаданных, на основании данных которых выполняется расчет себестоимости.
// В перечень не включаются объекты, которые являются одновременно и исходящими данными механизмов расчета партий и себестоимости.
//
// Параметры:
//	ВходящиеДанные - Соответствие - уже инициализированное хранилище для описания входящих данных
//	ТолькоТребующиеПерерасчета - Булево - если установлен, то будет возвращен перечень только тех данных,
//		изменение которых влечет за собой необходимость перерасчета партий и себестоимости
//		При изменении этих данных должна создаваться запись в регистре сведений ЗаданияКРасчетуСебестоимости.
//
// Возвращаемое значение:
//	Соответствие - Ключ - ОбъектМетаданных
//
Функция ВходящиеДанныеМеханизма(ВходящиеДанные = Неопределено, ТолькоТребующиеПерерасчета = Ложь) Экспорт
	
	Если ВходящиеДанные = Неопределено Тогда
		ВходящиеДанные = Новый Соответствие;
	КонецЕсли;
	
	Если ТолькоТребующиеПерерасчета Тогда
		Значение = Истина; // чтобы можно было проверить вхождение объекта метаданных в это соответствие
	Иначе
		Значение = Неопределено;
	КонецЕсли;
	
	Если НЕ ТолькоТребующиеПерерасчета Тогда 
		
		ВходящиеДанные.Вставить(Метаданные.Документы.ВнутреннееПотребление, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ВозвратТоваровОтКлиента, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.КорректировкаРеализации, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ОтчетОРозничныхПродажах, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ОтчетПоКомиссииМеждуОрганизациями, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПередачаТоваровМеждуОрганизациями, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПеремещениеТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.ПриобретениеТоваровУслуг, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.РасчетСебестоимостиТоваров, Значение);
		ВходящиеДанные.Вставить(Метаданные.Документы.РеализацияТоваровУслуг, Значение);
		
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.АналитикаУчетаНоменклатуры, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.АналитикаУчетаПоПартнерам, Значение);
		ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.НастройкаРаспределенияПоНаправлениямДеятельности, Значение);
		
		ВходящиеДанные.Вставить(Метаданные.Справочники.КлючиАналитикиУчетаНоменклатуры, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.Назначения, Значение);
		ВходящиеДанные.Вставить(Метаданные.Справочники.СпособыРаспределенияПоНаправлениямДеятельности, Значение);
		
		ВходящиеДанные.Вставить(Метаданные.ПланыВидовХарактеристик.СтатьиРасходов, Значение);
		
	КонецЕсли;

	//++ НЕ УТ
	ВходящиеДанные.Вставить(Метаданные.Документы.РаспределениеПрочихЗатрат, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ВыпускПродукции, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства, Значение);
	//-- НЕ УТ
	
	ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.СтоимостьТоваров, Значение);
	//++ НЕ УТ
	ВходящиеДанные.Вставить(Метаданные.РегистрыСведений.СтоимостьТМЦВЭксплуатации, Значение);
	//-- НЕ УТ
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПрочихРасходов, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеДоходы, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходы, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.СебестоимостьТоваров, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ОтклоненияВСтоимостиТоваров, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыОрганизаций, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТоварыОрганизацийКПередаче, Значение);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.РезервыТоваровОрганизаций, Значение);
	
	РасчетСебестоимостиЛокализация.ВходящиеДанныеМеханизма(ВходящиеДанные, ТолькоТребующиеПерерасчета);
	
	Возврат ВходящиеДанные;
	
КонецФункции

// Возвращает перечень регистров, обслуживаемых механизмом расчета себестоимости.
//
// Возвращаемое значение:
//	Соответствие - Ключ - ОбъектМетаданных
//
Функция ИсходящиеДанныеМеханизма(ИсходящиеДанные = Неопределено) Экспорт
	
	// Перечень метаданных регистров, по которым формируются движения при расчете себестоимости.
	Если ИсходящиеДанные = Неопределено Тогда
		ИсходящиеДанные = Новый Соответствие;
	КонецЕсли;
	
	ИсходящиеДанные.Вставить(Метаданные.РегистрыСведений.СтоимостьТоваров, 							Истина);
	//++ НЕ УТ
	ИсходящиеДанные.Вставить(Метаданные.РегистрыСведений.СтоимостьТМЦВЭксплуатации, 				Истина);
	//-- НЕ УТ
	
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ВыручкаИСебестоимостьПродаж, 			Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.СебестоимостьТоваров, 					Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.Закупки, 								Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДвиженияДоходыРасходыПрочиеАктивыПассивы, Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДвиженияНоменклатураДоходыРасходы, 		Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДвиженияНоменклатураНоменклатура, 		Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеДоходы, 							Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходы, 							Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ОтклоненияВСтоимостиТоваров,				Истина);
	//++ НЕ УТ
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеРасходыНезавершенногоПроизводства, Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.РезервыПредстоящихРасходов, 				Истина);
	//-- НЕ УТ
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПрочиеАктивыПассивы, 					Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ДвиженияПоПрочимАктивамПассивам, 		Истина);
	ИсходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ФинансовыеРезультаты, 					Истина);
	
	РасчетСебестоимостиЛокализация.ИсходящиеДанныеМеханизмаНДД(ИсходящиеДанные);
	
	Возврат ИсходящиеДанные;
	
КонецФункции

// Возвращает перечень регистров, рассчитываемых механизмом партионного учета версии 2.2, и используемых при расчете себестоимости.
//
// Возвращаемое значение:
//	Соответствие - имена регистров, рассчитываемых механизмом партионного учета версии 2.2, и используемых при расчете себестоимости.
// 
Функция ИспользуемыеКэшиРегистровПартионногоУчета() Экспорт
	
	// Здесь перечислены регистры, которые (по И)
	// - рассчитываются механизмом партионного учета версии 2.2
	// - не рассчитываются механизмом расчета себестоимости
	// - являются входящими данными для механизма расчета себестоимости (используются кэши данных регистров)
	//
	// В случае, если выполняется отдельный запуск расчета себестоимости (не из партионного учета версии 2.2),
	// эти регистры не будут инициализированы - к их кэшам обращаться нельзя.
	//
	// Для этого делается следующее:
	// - перед началом расчета себестоимости "принудительно" инициализируются эти регистры (для того, чтобы сформировались их расчетные кэши)
	// - перед записью движений эти регистры удаляются из параметров расчета (записывать их не надо - движения по ним не формировались)
	
	ВходящиеДанные = Новый Соответствие;
	//++ НЕ УТ
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ТрудозатратыНезавершенногоПроизводства, Истина);
	//-- НЕ УТ
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.ПартииПрочихРасходов, 			  	  Истина);
	
	РасчетСебестоимостиЛокализация.ИспользуемыеКэшиРегистровПартионногоУчета(ВходящиеДанные);
	
	Возврат ВходящиеДанные;
	
КонецФункции

// Возвращает название данного механизма и его номер версии.
//
// Возвращаемое значение:
//	Строка - версия механизма
//
Функция ТекущаяВерсияМеханизма() Экспорт
	Возврат НСтр("ru = 'Расчет себестоимости, версия 2.2';
				|en = 'Cost calculation, version 2.2'", ОбщегоНазначения.КодОсновногоЯзыка());
КонецФункции

Функция ОписаниеФормированияВременнойТаблицы(ИмяРегистра, ПостфиксРезультата = "", ДобавлятьИдентификаторы = Ложь)
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Имя", ИмяРегистра);
	СтруктураВозврата.Вставить("ИмяВТРезультата", "ВТ" + ИмяРегистра + ПостфиксРезультата);
	СтруктураВозврата.Вставить("ИмяВТИсточника", "ВТ" + ?(СтрНачинаетсяС(ИмяРегистра, "Движения"), "", "Движения") + ИмяРегистра);
	СтруктураВозврата.Вставить("ДобавлятьИдентификаторы", ДобавлятьИдентификаторы);
	
	Возврат СтруктураВозврата;
	
КонецФункции

#КонецОбласти

#Область Тестирование

// Дополняет список этапов расчета.
// 
// Параметры:
// 	СписокЭтапов - СписокЗначений из Строка- 
//
Процедура ДополнитьЭтапыСПодготовкойДанныхДляСледующихЭтапов(СписокЭтапов) Экспорт
	
	СписокЭтапов.Добавить("СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов");
	//++ Локализация
	СписокЭтапов.Добавить("СкорректироватьСтоимостьДополнительныхРасходовНДС");
	//-- Локализация
	СписокЭтапов.Добавить("СкорректироватьСтоимостьСписанияЗапасов_ПодготовкаДанных");
	СписокЭтапов.Добавить("СкорректироватьСтоимостьПродаж_ПодготовкаДанных");
	СписокЭтапов.Добавить("СписатьОтклоненияВСтоимостиТоваров_ПодготовкаДанных");
	СписокЭтапов.Добавить("РаспределитьОтклоненияВСтоимостиТоваров_СторноДвижения");
	СписокЭтапов.Добавить("РаспределитьОтклоненияВСтоимостиТоваров_ПодготовкаДанных");
	СписокЭтапов.Добавить("РаспределитьОтклоненияВСтоимостиТоваров_ФормированиеДвижений");
	
КонецПроцедуры

Процедура ТекстЗапросаДляРасчетаЭтапа(ИмяЭтапа, ПараметрыРасчета, ТекстЗапроса) Экспорт
	
	Если ИмяЭтапа = "СкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов" Тогда
		ТекстЗапроса = ТекстСкорректироватьСтоимостьСторноДвиженийИсправленныхДокументов(ПараметрыРасчета);
	//++ Локализация
	ИначеЕсли ИмяЭтапа = "СкорректироватьСтоимостьДополнительныхРасходовНДС" Тогда
		ТекстЗапроса = ТекстСкорректироватьСтоимостьДополнительныхРасходовНДС(ПараметрыРасчета);
	//-- Локализация
	ИначеЕсли ИмяЭтапа = "СкорректироватьСтоимостьСписанияЗапасов_ПодготовкаДанных" Тогда
		ТекстЗапроса = ТекстСкорректироватьСтоимостьСписанияЗапасовПодготовкаДанных(ПараметрыРасчета);
	ИначеЕсли ИмяЭтапа = "СкорректироватьСтоимостьПродаж_ПодготовкаДанных" Тогда
		ТекстЗапроса = ТекстСкорректироватьСтоимостьПродажПодготовкаДанных(ПараметрыРасчета);
	ИначеЕсли ИмяЭтапа = "СписатьОтклоненияВСтоимостиТоваров_ПодготовкаДанных" Тогда
		ТекстЗапроса = ТекстСписатьОтклоненияВСтоимостиТоваровПодготовкаДанных(ПараметрыРасчета);
	ИначеЕсли ИмяЭтапа = "РаспределитьОтклоненияВСтоимостиТоваров_СторноДвижения" Тогда
		ТекстЗапроса = ТекстРаспределитьОтклоненияВСтоимостиТоваровВозвратыИСторноДвижения(ПараметрыРасчета);
	ИначеЕсли ИмяЭтапа = "РаспределитьОтклоненияВСтоимостиТоваров_ПодготовкаДанных" Тогда
		ТекстЗапроса = ТекстРаспределитьОтклоненияВСтоимостиТоваровПодготовкаДанных(ПараметрыРасчета);
	ИначеЕсли ИмяЭтапа = "РаспределитьОтклоненияВСтоимостиТоваров_ФормированиеДвижений" Тогда
		ТекстЗапроса = ТекстРаспределитьОтклоненияВСтоимостиТоваровФормированиеДвижений(ПараметрыРасчета);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
