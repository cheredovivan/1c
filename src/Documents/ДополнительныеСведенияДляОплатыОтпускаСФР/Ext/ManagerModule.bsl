///////////////////////////////////////////////////////////////////////////////////////////////////////
// Copyright (c) 2022, ООО 1С-Софт
// Все права защищены. Эта программа и сопроводительные материалы предоставляются 
// в соответствии с условиями лицензии Attribution 4.0 International (CC BY 4.0)
// Текст лицензии доступен по ссылке:
// https://creativecommons.org/licenses/by/4.0/legalcode
///////////////////////////////////////////////////////////////////////////////////////////////////////

#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.Печать

// Заполняет список команд печати.
// 
// Параметры:
//  КомандыПечати - см. УправлениеПечатью.СоздатьКоллекциюКомандПечати
//
Процедура ДобавитьКомандыПечати(КомандыПечати) Экспорт
	
КонецПроцедуры

// Формирует печатные формы.
//
// Параметры:
//  МассивОбъектов  - Массив    - ссылки на объекты, которые нужно распечатать;
//  ПараметрыПечати - Структура - дополнительные настройки печати;
//  КоллекцияПечатныхФорм - ТаблицаЗначений - сформированные табличные документы (выходной параметр).
//  ОбъектыПечати         - СписокЗначений  - значение - ссылка на объект;
//                                            представление - имя области в которой был выведен объект (выходной
//                                                            параметр);
//  ПараметрыВывода       - Структура       - дополнительные параметры сформированных табличных документов (выходной
//                                            параметр).
//
Процедура Печать(МассивОбъектов, ПараметрыПечати, КоллекцияПечатныхФорм, ОбъектыПечати, ПараметрыВывода) Экспорт
	
КонецПроцедуры

// Конец СтандартныеПодсистемы.Печать

// СтандартныеПодсистемы.ПодключаемыеКоманды

// Для использования в процедуре ДобавитьКомандыСозданияНаОсновании других модулей менеджеров объектов.
//  Добавляет в список команд создания на основании этот объект.
//
// Параметры:
//  КомандыСозданияНаОсновании - см. СозданиеНаОснованииПереопределяемый.ПередДобавлениемКомандСозданияНаОсновании
// 
// Возвращаемое значение:
//  СтрокаТаблицыЗначений, Неопределено - описание добавленной команды.
//
Функция ДобавитьКомандуСоздатьНаОсновании(КомандыСозданияНаОсновании) Экспорт
	
	Возврат СозданиеНаОсновании.ДобавитьКомандуСозданияНаОсновании(КомандыСозданияНаОсновании, Метаданные());
	
КонецФункции

// Конец СтандартныеПодсистемы.ПодключаемыеКоманды

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт
	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(ФизическоеЛицо)
	|	И ЗначениеРазрешено(Организация)";
КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

#Область СЭДО

Функция ТекстXML(Документ) Экспорт

#Область ПримерТекстаXML
	//<tns:additionalVacationStatementDocs xmlns:tns="http://www.fss.ru/additionalVacationStatement" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	//xsi:schemaLocation="http://www.fss.ru/additionalVacationStatement additionalVacationStatement.xsd">
	//	<tns:addDocument>
	//		<tns:docNmber>И-3345</tns:docNmber>
	//		<tns:docDate>2022-08-01</tns:docDate>
	//		<tns:docComment/>
	//		<tns:attachment>
	//			<tns:content></tns:content>
	//			<tns:ext>PNG</tns:ext>
	//			<tns:mimeType>PNG</tns:mimeType>
	//			<tns:size>34334</tns:size>
	//			<tns:name>И-3345</tns:name>
	//		</tns:attachment>
	//	</tns:addDocument>
	//	<tns:statementUuid>c008440c-a87f-4bd1-96da-41f894470660</tns:statementUuid>
	//</tns:additionalVacationStatementDocs>
#КонецОбласти
	
	МенеджерXML = Обработки.ПостроительXML.Создать();
	МенеджерXML.ФорматДат = "ДФ=yyyy-MM-dd";
	
	КореньXML = МенеджерXML.ДобавитьУзел(МенеджерXML.ДеревоXML, "tns:additionalVacationStatementDocs");
	
	// Пространства имен.
	МенеджерXML.ДобавитьПространствоИмен(КореньXML, "tns", "http://www.fss.ru/additionalVacationStatement");
	МенеджерXML.ДобавитьПространствоИмен(КореньXML, "xsi", "http://www.w3.org/2001/XMLSchema-instance");
	МенеджерXML.ДобавитьАтрибут(КореньXML, "xsi:schemaLocation", "http://www.fss.ru/additionalVacationStatement additionalVacationStatement.xsd");
	
	ВыгрузитьВложения(Документ, МенеджерXML, КореньXML);
	МенеджерXML.ДобавитьУзел(КореньXML, "tns:statementUuid", Документ.ИдентификаторОснования);
	
	МенеджерXML.НачатьЗаписьВСтрокуXML(Истина);
	СтрокаXML = МенеджерXML.СтрокаXML();
	Возврат СтрокаXML;
КонецФункции

Процедура ВыгрузитьВложения(Документ, МенеджерXML, УзелДанных)
	ДанныеФайлов = ОбщегоНазначения.ЗначенияРеквизитовОбъектов(
		Документ.Вложения.Выгрузить().ВыгрузитьКолонку("Файл"), "Расширение,Размер,Наименование");
	Для Каждого Вложение Из Документ.Вложения Цикл
		УзелВложение = МенеджерXML.ДобавитьУзел(УзелДанных, "tns:addDocument");
		МенеджерXML.ДобавитьУзел(УзелВложение, "tns:docNmber",		Вложение.Номер, Истина);
		МенеджерXML.ДобавитьУзел(УзелВложение, "tns:docDate",		Вложение.Дата);
		МенеджерXML.ДобавитьУзел(УзелВложение, "tns:docComment",	Вложение.Комментарий, Истина);
		
		ДанныеФайла = ДанныеФайлов.Получить(Вложение.Файл);
		УзелФайл = МенеджерXML.ДобавитьУзел(УзелВложение, "tns:attachment");
		МенеджерXML.ДобавитьУзел(УзелФайл, "tns:content",	Строка(Вложение.Файл.УникальныйИдентификатор()));
		МенеджерXML.ДобавитьУзел(УзелФайл, "tns:ext",		ДанныеФайла.Расширение);
		МенеджерXML.ДобавитьУзел(УзелФайл, "tns:mimeType",	ДанныеФайла.Расширение);//MIMEТипПоСтроке(ДанныеФайла.Расширение)
		МенеджерXML.ДобавитьУзел(УзелФайл, "tns:size",		ДанныеФайла.Размер);
		МенеджерXML.ДобавитьУзел(УзелФайл, "tns:name",		ДанныеФайла.Наименование);
	КонецЦикла;
КонецПроцедуры

Функция Метаданные() Экспорт
	Возврат Метаданные.Документы.ДополнительныеСведенияДляОплатыОтпускаСФР;
КонецФункции

Функция ТипСообщения(Документ = Неопределено) Экспорт
	Возврат 96;
КонецФункции

Функция ЗаголовокФормыОтправкиСведенийВФСС() Экспорт
	Возврат СтрШаблон(НСтр("ru = 'Отправка %1';
							|en = 'Send %1'"), Метаданные().ПредставлениеСписка);
КонецФункции

Процедура ПриЗаполненииПараметровОтправки(МассивСсылок, ТаблицаОтправки) Экспорт
	Синоним = Метаданные().Синоним;
	
	ИменаРеквизитовСтроки = "Ссылка, Номер, Дата, ФизическоеЛицо, Организация";
	ИменаРеквизитов = "Ссылка, Номер, Дата, ДатаОтправки, ФизическоеЛицо, Организация, ХранилищеXML, ПометкаУдаления, Проведен";
	Соответствие = ОбщегоНазначения.ЗначенияРеквизитовОбъектов(МассивСсылок, ИменаРеквизитов);
	Для Каждого КлючИЗначение Из Соответствие Цикл
		Документ = КлючИЗначение.Значение;
		// Добавление строки отправки и заполнение представления.
		СтрокаОтправки = ТаблицаОтправки.Добавить();
		ЗаполнитьЗначенияСвойств(СтрокаОтправки, Документ, ИменаРеквизитовСтроки);
		СтрокаОтправки.ТипСообщения = ТипСообщения(Документ);
		СтрокаОтправки.ТекстXML     = Документ.ХранилищеXML.Получить();
		СтрокаОтправки.Отправить    = Ложь;
		СтрокаОтправки.ШаблонОшибки = СтрШаблон(
			НСтр("ru = 'Не удалось отправить %1 сотрудника %2:%3';
				|en = 'Cannot send %1 of the %2 employee:%3'"),
			Синоним,
			СтрокаОтправки.ФизическоеЛицо,
			"%1");
		// Проверки и обновление вторичных данных документа перед отправкой.
		Если Документ.ПометкаУдаления Тогда
			СтрокаОтправки.ИндексКартинки = СЭДОФССКлиентСервер.ИндексКартинкиУдален();
			СтрокаОтправки.Результат = НСтр("ru = 'Документ помечен на удаление';
											|en = 'The document is marked for deletion'");
			Продолжить;
		КонецЕсли;
		Если ЗначениеЗаполнено(Документ.ДатаОтправки) Тогда
			СтрокаОтправки.ИндексКартинки = СЭДОФССКлиентСервер.ИндексКартинкиОтправлен();
			Если НачалоДня(Документ.ДатаОтправки) <= ТекущаяДатаСеанса() Тогда
				Текст = НСтр("ru = 'Документ уже отправлен %1';
							|en = 'The document is already sent %1'");
				СтрокаОтправки.Результат = СтрШаблон(Текст, Формат(Документ.ДатаОтправки, "ДЛФ=D"));
			Иначе
				Текст = НСтр("ru = 'Документ уже отправлен в %1';
							|en = 'The document is already sent to %1'");
				СтрокаОтправки.Результат = СтрШаблон(Текст, Формат(Документ.ДатаОтправки, "ДФ=HH:mm"));
			КонецЕсли;
			Продолжить;
		КонецЕсли;
		ДокументОбъект = Документ.Ссылка.ПолучитьОбъект();
		Если Не ДокументОбъект.ПроверитьЗаполнение() Тогда
			СтрокаОтправки.ИндексКартинки = СЭДОФССКлиентСервер.ИндексКартинкиПредупреждение();
			ЗаполнитьТекстОшибкиПроверкиЗаполнения(СтрокаОтправки, "");
			Если Не ДокументОбъект.ОтключитьПроверкиПроведения Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		// Проведение документа если требуется.
		ЕстьИзменения = ДокументОбъект.ОбновитьВторичныеДанные();
		СтрокаОтправки.Отправить = Истина;
		Если ЕстьИзменения Или Не ДокументОбъект.Проведен Тогда
			Попытка
				СтрокаОтправки.ИндексКартинки = СЭДОФССКлиентСервер.ИндексКартинкиПроведен();
				ДокументОбъект.Записать(РежимЗаписиДокумента.Проведение);
				ЗаполнитьЗначенияСвойств(СтрокаОтправки, ДокументОбъект, ИменаРеквизитовСтроки);
				СтрокаОтправки.ТекстXML = ДокументОбъект.ХранилищеXML.Получить();
			Исключение
				СтрокаОтправки.Отправить = Ложь;
				СтрокаОтправки.ИндексКартинки = СЭДОФССКлиентСервер.ИндексКартинкиОстановлен();
				СтрокаОтправки.ЗначениеРасшифровки = Документ.Ссылка;
				ТекстИсключения = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				ЗаполнитьТекстОшибкиПроверкиЗаполнения(СтрокаОтправки, ТекстИсключения);
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПриПодготовкеВыбранныхДокументовКОтправке(МассивСсылок, ТаблицаОтправки) Экспорт
	// Заменим ГУИДы вложений на двоичные данные в тексте сообщения
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ДополнительныеСведенияДляОплатыОтпускаСФРВложения.Файл КАК Файл,
		|	ДополнительныеСведенияДляОплатыОтпускаСФРВложения.Ссылка КАК Документ
		|ИЗ
		|	Документ.ДополнительныеСведенияДляОплатыОтпускаСФР.Вложения КАК ДополнительныеСведенияДляОплатыОтпускаСФРВложения
		|ГДЕ
		|	ДополнительныеСведенияДляОплатыОтпускаСФРВложения.Ссылка В(&Документы)
		|ИТОГИ ПО
		|	Документ";
	Запрос.УстановитьПараметр("Документы", ТаблицаОтправки.ВыгрузитьКолонку("Ссылка"));
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	СоответствиеДокументов = Новый Соответствие;
	МассивВложений = Новый Массив;
	ВыборкаДокумент = Результат.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаДокумент.Следующий() Цикл
		МассивФайловДокумента = Новый Массив;
		Выборка = ВыборкаДокумент.Выбрать();
		Пока Выборка.Следующий() Цикл
			МассивФайловДокумента.Добавить(Выборка.Файл);
			МассивВложений.Добавить(Выборка.Файл);
		КонецЦикла;
		СоответствиеДокументов.Вставить(ВыборкаДокумент.Документ, МассивФайловДокумента);
	КонецЦикла;
	
	ДвоичныеДанныеФайлов = РаботаСФайлами.ДвоичныеДанныеФайлов(МассивВложений);
	Для Каждого СообщениеКОтправке Из ТаблицаОтправки Цикл
		ВложенияКОтправке = СоответствиеДокументов.Получить(СообщениеКОтправке.Ссылка);
		Для Каждого Вложение Из ВложенияКОтправке Цикл
			ГУИД = Строка(Вложение.УникальныйИдентификатор());
			ДвоичныеДанные = ДвоичныеДанныеФайлов.Получить(Вложение);
			Если ДвоичныеДанные <> Неопределено Тогда
				СообщениеКОтправке.ТекстXML = СтрЗаменить(СообщениеКОтправке.ТекстXML, ГУИД, Base64Строка(ДвоичныеДанные));
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
КонецПроцедуры

// См. СЭДОФСС.ЗарегистрироватьНепосредственныйРезультатОтправкиДокумента.
Процедура ЗарегистрироватьРезультатОтправки(РезультатОтправки) Экспорт
	// Сначала записывается отправленный документ, т.к. его данные используются при обновлении регистров (кэшей).
	ДокументОбъект = РезультатОтправки.Ссылка.ПолучитьОбъект();
	ДокументОбъект.ДатаОтправки           = РезультатОтправки.ДатаОтправки;
	ДокументОбъект.ИдентификаторСообщения = РезультатОтправки.ИдентификаторСообщения;
	ДокументОбъект.Страхователь           = РезультатОтправки.Страхователь;
	ДокументОбъект.ГоловнаяОрганизация    = РезультатОтправки.ГоловнаяОрганизация;
	СЭДОФСС.ЗаписатьДокумент(ДокументОбъект, Истина, Ложь, РежимЗаписиДокумента.Запись);
	
	// Затем записывается транспортный регистр,
	// который при записи запускает обновление остальных регистров, зависящих от состояния отправки.
	РегистрыСведений.РегистрацииСведенийДляОплатыОтпускаСФР.ЗаполнитьПоДокументу(ДокументОбъект, РезультатОтправки);
	РезультатОтправки.Измененные.Добавить(ДокументОбъект.Ссылка);
КонецПроцедуры

// См. СЭДОФСС.ЗагрузитьРезультатДоставкиСообщенияСЭДО.
Процедура ЗагрузитьРезультатДоставкиСообщения96(Страхователь, Сообщение, Результат) Экспорт
	Таблица = РегистрыСведений.РегистрацииСведенийДляОплатыОтпускаСФР.НайтиПоИдентификаторуСообщения(
		Страхователь,
		Сообщение.Идентификатор,
		Результат);
	Для Каждого СтрокаТаблицы Из Таблица Цикл
		// Сначала записывается отправленный документ, т.к. его данные используются при обновлении регистров (кэшей).
		Если Не Сообщение.ДоставленоФонду Тогда
			ДокументОбъект = СтрокаТаблицы.ИсходящийДокумент.ПолучитьОбъект();
			ДокументОбъект.ДатаОтправки           = '00010101';
			ДокументОбъект.ИдентификаторСообщения = "";
			СЭДОФСС.ЗаписатьДокумент(ДокументОбъект, Истина, Ложь, РежимЗаписиДокумента.Запись);
		КонецЕсли;
		
		// Затем записывается транспортный регистр,
		// который при записи запускает обновление остальных регистров, зависящих от состояния отправки.
		РегистрыСведений.РегистрацииСведенийДляОплатыОтпускаСФР.ЗаполнитьПоРезультатуДоставки(СтрокаТаблицы.ИсходящийДокумент, Сообщение);
		
		// Отметка для БРО и других потребителей что сообщение обработано.
		Результат.Обработано = Истина;
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

#Область СоставДокументов

// Возвращает описание состава документа
//
// Возвращаемое значение:
//  Структура - см. ЗарплатаКадрыСоставДокументов.НовоеОписаниеСоставаОбъекта.
//
Функция ОписаниеСоставаОбъекта() Экспорт
	Возврат ЗарплатаКадрыСоставДокументов.ОписаниеСоставаОбъектаФизическоеЛицоВШапке("ФизическоеЛицо", "Сотрудник");
КонецФункции

#КонецОбласти

#Область ФиксацияВторичныхДанныхВДокументах

Функция ПараметрыФиксацииВторичныхДанных(Документ = Неопределено) Экспорт
	Возврат ФиксацияВторичныхДанныхВДокументах.ПараметрыФиксации(ФиксируемыеРеквизиты(Документ));
КонецФункции

// Определяет по данным документа признак фиксации.
//
// Параметры:
//   Документ - ДокументОбъект.ОтветНаЗапросРеквизитовДляВыплатыПособия, ДанныеФормыСтруктура
//
// Возвращаемое значение:
//   Булево
//
Функция ОбъектЗафиксирован(Документ) Экспорт
	Возврат Не Документ.ПометкаУдаления И ЗначениеЗаполнено(Документ.ДатаОтправки);
КонецФункции

#КонецОбласти

#Область МногофункциональныеДокументы

// Возвращает метаданные разделов документа.
//
// Возвращаемое значение:
//   Соответствие, Неопределено - Описание разделов документа.
//
Функция ОписаниеРазделовДанных() Экспорт
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыРасширеннаяПодсистемы") Тогда
		Модуль = ОбщегоНазначения.ОбщийМодуль("МногофункциональныеДокументыБЗККлиентСервер");
		ВсеРазделы = Модуль.РазделыДанных();
		
		ОписаниеРазделовДанных = Новый Соответствие();
		
		ОписаниеРаздела = Модуль.НовыйОписаниеРазделаДанных();
		ОписаниеРазделовДанных.Вставить(ВсеРазделы.КадровыеДанные, ОписаниеРаздела);
		ОписаниеРаздела.РеквизитСостояние    = "Проведен";
		ОписаниеРаздела.РеквизитОтветсвенный = "Ответственный";
		
		ОписаниеРаздела = Модуль.НовыйОписаниеРазделаДанных();
		ОписаниеРазделовДанных.Вставить(ВсеРазделы.НачисленнаяЗарплата, ОписаниеРаздела);
		Возврат ОписаниеРазделовДанных;
	КонецЕсли;
	Возврат Неопределено;
КонецФункции

// Возвращает значения по которым будут проверяться права на документ.
//
// Параметры:
//   ДокументОбъект - ДокументОбъект, ДанныеФормыСтруктура
//
// Возвращаемое значение:
//   Структура - Значения доступа по которым будут проверяться права на документ
//
Функция ЗначенияДоступа(ДокументОбъект) Экспорт
	Если ОбщегоНазначения.ПодсистемаСуществует("ЗарплатаКадрыРасширеннаяПодсистемы") Тогда
		МодульМногофункциональныеДокументыБЗК = ОбщегоНазначения.ОбщийМодуль("МногофункциональныеДокументыБЗК");
		Возврат МодульМногофункциональныеДокументыБЗК.ЗначенияДоступаПоСоставуДокумента(
			ДокументОбъект,
			ДокументОбъект.Организация);
	КонецЕсли;
	Возврат Неопределено;
КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ФиксацияВторичныхДанныхВДокументах

Функция ФиксируемыеРеквизиты(Документ = Неопределено)
	ФиксируемыеРеквизиты = Новый Соответствие;
	
	РеквизитыРучногоЗаполнения = Новый Структура("Ответственный, Комментарий, ФизическоеЛицо, ГоловнаяОрганизация");
	Если Документ = Неопределено Тогда
		ЗаполненоОснование = Ложь;
	Иначе
		ЗаполненоОснование = ЗначениеЗаполнено(Документ.ДокументОснование);
	КонецЕсли;
	
	// Реквизиты документ основание.
	Группа = ФиксацияВторичныхДанныхВДокументах.ОписаниеФиксируемогоРеквизита();
	Группа.ОснованиеЗаполнения      = "ДокументОснование";
	Группа.ИмяГруппы                = "ДокументОснование";
	Группа.ОтображатьПредупреждение = ЗаполненоОснование;
	
	ДобавитьФиксируемыйРеквизит(ФиксируемыеРеквизиты, Группа, "ДокументОснование", ЗаполненоОснование);
	ДобавитьФиксируемыйРеквизит(ФиксируемыеРеквизиты, Группа, "Сотрудник", ЗаполненоОснование);
	ДобавитьФиксируемыйРеквизит(ФиксируемыеРеквизиты, Группа, "Организация", ЗаполненоОснование);
	ДобавитьФиксируемыйРеквизит(ФиксируемыеРеквизиты, Группа, "ИдентификаторОснования", ЗаполненоОснование);
	
	// Реквизиты организации.
	Группа = ФиксацияВторичныхДанныхВДокументах.ОписаниеФиксируемогоРеквизита();
	Группа.ОснованиеЗаполнения = "Организация";
	Группа.ИмяГруппы           = "Организация";
	ДобавитьФиксируемыйРеквизит(ФиксируемыеРеквизиты, Группа, "Страхователь", ЗаполненоОснование);
	
	// Добавление всех оставшихся реквизитов одной группой "по умолчанию".
	Группа = ФиксацияВторичныхДанныхВДокументах.ОписаниеФиксируемогоРеквизита();
	Группа.ИмяГруппы                = "СлужебныеРеквизиты";
	Группа.ОтображатьПредупреждение = Ложь;
	Для Каждого Реквизит Из Метаданные().Реквизиты Цикл
		Если Не РеквизитыРучногоЗаполнения.Свойство(Реквизит.Имя)
			И ФиксируемыеРеквизиты[Реквизит.Имя] = Неопределено Тогда
			ДобавитьФиксируемыйРеквизит(ФиксируемыеРеквизиты, Группа, Реквизит.Имя);
		КонецЕсли;
	КонецЦикла;
	
	Возврат Новый ФиксированноеСоответствие(ФиксируемыеРеквизиты);
КонецФункции

Процедура ДобавитьФиксируемыйРеквизит(ФиксируемыеРеквизиты, Группа, ИмяРеквизита, ОтображатьПредупреждение = Неопределено)
	ФиксацияВторичныхДанныхВДокументах.ДобавитьФиксируемыйРеквизит(
		ФиксируемыеРеквизиты,
		Группа,
		ИмяРеквизита,
		ОтображатьПредупреждение);
КонецПроцедуры

#КонецОбласти

#Область ПриЗаполненииПараметровОтправки

Функция ЗаполнитьТекстОшибкиПроверкиЗаполнения(СтрокаОтправки, ТекстИсключенияПриПроведении)
	СтрокаОтправки.Ошибки = ПолучитьСообщенияПользователю(Истина);
	
	Количество = СтрокаОтправки.Ошибки.Количество();
	Если Количество = 1 Тогда
		СтрокаОтправки.Результат = СтрокаОтправки.Ошибки[0].Текст;
	ИначеЕсли Количество > 1 Тогда
		СтрокаОтправки.Результат = СтроковыеФункцииКлиентСервер.СтрокаСЧисломДляЛюбогоЯзыка(
			НСтр("ru = ';%1 ошибка заполнения;;%1 ошибки заполнения;%1 ошибок заполнения;';
				|en = ';%1 filling error;;%1 filling errors;%1 filling errors;'"),
			Количество);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекстИсключенияПриПроведении) Тогда
		Если СтрокаОтправки.Результат = "" Тогда
			СтрокаОтправки.Результат = СтрШаблон(НСтр("ru = 'Ошибка проведения: %1';
														|en = 'Posting error: %1'"), ТекстИсключенияПриПроведении);
		Иначе
			СтрокаОтправки.Результат = СтрокаОтправки.Результат + ";" + Символы.ПС + СтрШаблон(НСтр("ru = 'И ошибка проведения: %1';
																									|en = 'And posting error: %1'"), ТекстИсключенияПриПроведении);
		КонецЕсли;
	КонецЕсли;
КонецФункции

#КонецОбласти

#Область Вложения

Функция MIMEТипПоСтроке(СтрТипСодержимогоИлиРасширение) Экспорт
	
	СтрокаТипаВНижнемРегистре = НРег(СтрТипСодержимогоИлиРасширение);
	Если СтрокаТипаВНижнемРегистре = "txt" ИЛИ СтрокаТипаВНижнемРегистре = "plain866"
		ИЛИ СтрокаТипаВНижнемРегистре = "текст1251" ИЛИ СтрокаТипаВНижнемРегистре = "plain1251" Тогда
		Возврат "text/plain";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "xml" Тогда
		Возврат "application/xml";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "htm" ИЛИ СтрокаТипаВНижнемРегистре = "html" Тогда
		Возврат "text/html";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "pdf" Тогда
		Возврат "application/pdf";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "rtf" Тогда
		Возврат "application/rtf";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "tif" ИЛИ СтрокаТипаВНижнемРегистре = "tiff" Тогда
		Возврат "image/tiff";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "jpg" ИЛИ СтрокаТипаВНижнемРегистре = "jpeg" Тогда
		Возврат "image/jpeg";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "png" Тогда
		Возврат "image/png";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "gif" Тогда
		Возврат "image/gif";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "bmp" Тогда
		Возврат "image/bmp";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "doc" Тогда
		Возврат "application/msword";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "xls" Тогда
		Возврат "application/vnd.ms-excel";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "odt" Тогда
		Возврат "application/vnd.oasis.opendocument.text";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "ods" Тогда
		Возврат "application/vnd.oasis.opendocument.spreadsheet";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "docx" Тогда
		Возврат "application/vnd.openxmlformats-officedocument.wordprocessingml.document";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "xlsx" Тогда
		Возврат "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
	ИначеЕсли СтрокаТипаВНижнемРегистре = "sgn" Тогда
		Возврат "application/x-pkcs7-signature";
	Иначе // "unknown"
		Возврат "application/octet-stream";
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#КонецЕсли