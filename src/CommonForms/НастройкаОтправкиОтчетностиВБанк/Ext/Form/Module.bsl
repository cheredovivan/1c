#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЗначениеВДанныеФормы(НастройкаОтправкиИСостояниеПоследнейОтправки(), Организации);
	
	Если ОбщегоНазначения.ПодсистемаСуществует("РегламентированнаяОтчетность.Интерфейс85") Тогда
		МодульРегламентированнаяОтчетностьИнтерфейс85 =
			ОбщегоНазначения.ОбщийМодуль("РегламентированнаяОтчетностьИнтерфейс85");
		МодульРегламентированнаяОтчетностьИнтерфейс85.УстановитьВидФлажкаВТаблице(Элементы.ОрганизацииТранзакции);
		МодульРегламентированнаяОтчетностьИнтерфейс85.УстановитьВидФлажкаВТаблице(Элементы.ОрганизацииОСВ);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ПодключитьОбработчикОжидания("ОбновитьСведенияНастроек", 300);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыОрганизации

&НаКлиенте
Процедура ОрганизацииТранзакцииПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Организации.ТекущиеДанные;
	
	ИзменитьНастройкуПоОрганизации(ТекущиеДанные.Организация, Отметки(ТекущиеДанные));
	ИзменитьСостояниеПоОрганизации(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацииОСВПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.Организации.ТекущиеДанные;
	
	ИзменитьНастройкуПоОрганизации(ТекущиеДанные.Организация, Отметки(ТекущиеДанные));
	ИзменитьСостояниеПоОрганизации(ТекущиеДанные);
	
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацииВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Отметки = Отметки(ТекущиеДанные);
	
	Если Поле.Имя = "ОрганизацииСостояние" Тогда
		Если ЗначениеЗаполнено(ТекущиеДанные.Состояние) Тогда
			ПараметрыОткрытия = Новый Структура;
			ПараметрыОткрытия.Вставить("ОтборОрганизация", ТекущиеДанные.Организация);
			
			ОткрытьФорму("РегистрСведений.ЖурналПередачиОтчетностиВБанк.ФормаСписка",
				ПараметрыОткрытия, , ТекущиеДанные.Организация);
			
		КонецЕсли;
		
	ИначеЕсли Поле.Имя = "ОрганизацииОСВПоСчетамГиперссылка" Тогда
		НастроитьСчетаПоОрганизации(ТекущиеДанные.Организация, Отметки);
		
	ИначеЕсли Поле.Имя = "ОрганизацииАнализыСчетовГиперссылка" Тогда
		НастроитьСчетаАнализовСчетовПоОрганизации(ТекущиеДанные.Организация, Отметки);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОтправитьСейчас(Команда)
	
	Отметки = Отметки(Элементы.Организации.ТекущиеДанные);
	Если НЕ ВыполнениеКомандыВозможно(Отметки) Тогда
		Возврат;
	КонецЕсли;
	
	ОповещениеОЗавершении = Новый ОписаниеОповещения("ОбработатьЗавершениеОтправкиВФоне", ЭтотОбъект);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ПараметрыОжидания.ТекстСообщения = НСтр("ru = 'Отправка сведений в Сбербанк';
											|en = 'Отправка сведений в Сбербанк'");
	
	Организация = Элементы.Организации.ТекущиеДанные.Организация;
	ДлительнаяОперация = ОтправитьОтчетностьВФоне(Организация);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация, ОповещениеОЗавершении, ПараметрыОжидания);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыгрузитьПакетНаДиск(Команда)
	
	Отметки = Отметки(Элементы.Организации.ТекущиеДанные);
	Отметки.Транзакции = Ложь;
	
	Если НЕ ВыполнениеКомандыВозможно(Отметки) Тогда
		Возврат;
	КонецЕсли;
	
	ОповещениеОЗавершении = Новый ОписаниеОповещения("ОбработатьЗавершениеВыгрузкиВФоне", ЭтотОбъект);
	
	ПараметрыОжидания = ДлительныеОперацииКлиент.ПараметрыОжидания(ЭтотОбъект);
	ПараметрыОжидания.ТекстСообщения = НСтр("ru = 'Выгрузка сведений для Сбербанка';
											|en = 'Выгрузка сведений для Сбербанка'");
	
	Организация = Элементы.Организации.ТекущиеДанные.Организация;
	ДлительнаяОперация = ВыгрузитьОтчетностьВФоне(Организация, Отметки);
	
	ДлительныеОперацииКлиент.ОжидатьЗавершение(ДлительнаяОперация, ОповещениеОЗавершении, ПараметрыОжидания);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ОбновитьСведенияНастроек()
	
	ОбновитьСведенияНастроекНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьСведенияНастроекНаСервере()
	
	Отправки = НастройкаОтправкиИСостояниеПоследнейОтправки();
	
	Для Каждого СтрокаПоОрганизации Из Организации Цикл
		СтрокаНастройки = Отправки.Найти(СтрокаПоОрганизации.Организация, "Организация");
		Если СтрокаНастройки <> Неопределено Тогда
			СтрокаПоОрганизации.Транзакции  = СтрокаНастройки.Транзакции;
			СтрокаПоОрганизации.ОСВ         = СтрокаНастройки.ОСВ;
			
			СтрокаПоОрганизации.ОСВПоСчетам = СтрокаНастройки.ОСВПоСчетам;
			СтрокаПоОрганизации.ОСВПоСчетамГиперссылка   = СтрокаНастройки.ОСВПоСчетамГиперссылка;
			
			СтрокаПоОрганизации.АнализыСчетов = СтрокаНастройки.АнализыСчетов;
			СтрокаПоОрганизации.АнализыСчетовГиперссылка = СтрокаНастройки.АнализыСчетовГиперссылка;
			
			СтрокаПоОрганизации.Отправлено  = СтрокаНастройки.Отправлено;
			СтрокаПоОрганизации.Состояние   = СтрокаНастройки.Состояние;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция НастройкаОтправкиИСостояниеПоследнейОтправки()
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ЖурналПередачиОтчетностиВБанк.Организация КАК Организация,
		|	МАКСИМУМ(ЖурналПередачиОтчетностиВБанк.ДатаОтправки) КАК ДатаОтправки
		|ПОМЕСТИТЬ ВТ_ПоследниеОтправки
		|ИЗ
		|	РегистрСведений.ЖурналПередачиОтчетностиВБанк КАК ЖурналПередачиОтчетностиВБанк
		|
		|СГРУППИРОВАТЬ ПО
		|	ЖурналПередачиОтчетностиВБанк.Организация
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ПоследниеОтправки.Организация КАК Организация,
		|	ВТ_ПоследниеОтправки.ДатаОтправки КАК ДатаОтправки,
		|	ЖурналПередачиОтчетностиВБанк.Состояние КАК Состояние
		|ПОМЕСТИТЬ ВТ_СостоянияПоследнихОтправок
		|ИЗ
		|	ВТ_ПоследниеОтправки КАК ВТ_ПоследниеОтправки
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЖурналПередачиОтчетностиВБанк КАК ЖурналПередачиОтчетностиВБанк
		|		ПО ВТ_ПоследниеОтправки.Организация = ЖурналПередачиОтчетностиВБанк.Организация
		|			И ВТ_ПоследниеОтправки.ДатаОтправки = ЖурналПередачиОтчетностиВБанк.ДатаОтправки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	Организации.Ссылка КАК Организация,
		|	ЕСТЬNULL(НастройкиОтправкиОтчетностиВБанк.ОтправлятьОтчеты, ЛОЖЬ) КАК Транзакции,
		|	ЕСТЬNULL(НастройкиОтправкиОтчетностиВБанк.ОтправлятьОСВ, ЛОЖЬ) КАК ОСВ,
		|	ЕСТЬNULL(НастройкиОтправкиОтчетностиВБанк.ОтправлятьОСВПоСчетам, ЛОЖЬ) КАК ОСВПоСчетам,
		|	ЕСТЬNULL(НастройкиОтправкиОтчетностиВБанк.ОтправлятьАнализыСчетов, ЛОЖЬ) КАК АнализыСчетов,
		|	НастройкиОтправкиОтчетностиВБанк.СчетаОСВПоСчетам КАК СчетаОСВПоСчетам,
		|	НастройкиОтправкиОтчетностиВБанк.СчетаАнализовСчетов КАК СчетаАнализовСчетов,
		|	ВТ_СостоянияПоследнихОтправок.ДатаОтправки КАК Отправлено,
		|	ВТ_СостоянияПоследнихОтправок.Состояние КАК Состояние,
		|	ВТ_СостоянияПоследнихОтправок.Состояние КАК СостояниеОтправки,
		|	""Карточки счетов 51 и 52"" КАК ТранзакцииЗаголовок,
		|	""ОСВ (сводная)"" КАК ОСВЗаголовок,
		|	""ОСВ по счетам"" КАК ОСВПоСчетамЗаголовок,
		|	""Анализы счетов"" КАК АнализыСчетовЗаголовок
		|ИЗ
		|	Справочник.Организации КАК Организации
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиОтправкиОтчетностиВБанк КАК НастройкиОтправкиОтчетностиВБанк
		|		ПО Организации.Ссылка = НастройкиОтправкиОтчетностиВБанк.Организация
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СостоянияПоследнихОтправок КАК ВТ_СостоянияПоследнихОтправок
		|		ПО Организации.Ссылка = ВТ_СостоянияПоследнихОтправок.Организация
		|
		|УПОРЯДОЧИТЬ ПО
		|	Организация
		|АВТОУПОРЯДОЧИВАНИЕ";
	
	НастройкиПоОрганизациям = Запрос.Выполнить().Выгрузить();
	НастройкиПоОрганизациям.Колонки.Добавить("ОсобоеСостояниеПредставление",
		Новый ОписаниеТипов("Строка", , , , Новый КвалификаторыСтроки(100)));
	
	УстановитьПривилегированныйРежим(Истина);
	
	Отбор = Новый Структура();
	Отбор.Вставить("Метаданные", "ОтправкаОтчетностиВБанк");
	Задания = РегламентныеЗаданияСервер.НайтиЗадания(Отбор);
	
	Для Каждого РегЗадание Из Задания Цикл
		Если РегЗадание.Параметры.Количество() > 0 Тогда
			Организация = РегЗадание.Параметры[0];
			СтрокаНастройки = НастройкиПоОрганизациям.Найти(Организация, "Организация");
			Если СтрокаНастройки <> Неопределено Тогда
				Если НЕ РегЗадание.Использование Тогда
					СтрокаНастройки.Состояние = НСтр("ru = 'Ошибка: отключено регламентное задание отправки';
													|en = 'Ошибка: отключено регламентное задание отправки'");
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Ложь);
	
	ЗаполнитьПолеСчетовВНастройках(НастройкиПоОрганизациям);
	
	Возврат НастройкиПоОрганизациям;
	
КонецФункции

&НаСервере
Процедура ЗаполнитьПолеСчетовВНастройках(НастройкиПоОрганизациям)
	
	НастройкиПоОрганизациям.Колонки.Добавить("ОСВПоСчетамГиперссылка", Новый ОписаниеТипов("Строка"));
	НастройкиПоОрганизациям.Колонки.Добавить("АнализыСчетовГиперссылка", Новый ОписаниеТипов("Строка"));
	
	Для Каждого СтрокаНастройки Из НастройкиПоОрганизациям Цикл
		СчетаОСВПоСчетам = Неопределено;
		Если СтрокаНастройки.ОСВПоСчетам Тогда
			СчетаОСВПоСчетам = СтрокаНастройки.СчетаОСВПоСчетам.Получить();
			Если СчетаОСВПоСчетам = Неопределено Тогда
				СчетаОСВПоСчетам = ОтчетностьВБанкиСлужебный.СчетаОСВПоСчетам();
			КонецЕсли;
		КонецЕсли;
		СтрокаНастройки.ОСВПоСчетамГиперссылка = ТекстГиперссылкиПоСчетам(
			СтрокаНастройки.ОСВПоСчетам, СчетаОСВПоСчетам);
			
		СчетаАнализовСчетов = Неопределено;
		Если СтрокаНастройки.АнализыСчетов Тогда
			СчетаАнализовСчетов = СтрокаНастройки.СчетаАнализовСчетов.Получить();
			Если СчетаАнализовСчетов = Неопределено Тогда
				СчетаАнализовСчетов = ОтчетностьВБанкиСлужебный.СчетаАнализовСчетов();
			КонецЕсли;
		КонецЕсли;
		СтрокаНастройки.АнализыСчетовГиперссылка = ТекстГиперссылкиПоСчетам(
			СтрокаНастройки.АнализыСчетов, СчетаАнализовСчетов);
		
	КонецЦикла;
	
КонецПроцедуры

// Возвращает отметки пользователя по полному набору возможных отправок.
//
// Параметры:
//   СтрокаНастроек - ДанныеФормыЭлементКоллекции - Строка настроек в таблице настроек по организациям
//
// Возвращаемое значение:
//   Структура - Отметки:
//     * Транзакции - Булево
//     * ОСВ - Булево
//     * ОСВПоСчетам - Булево
//     * АнализыСчетов - Булево
//  
&НаКлиенте
Функция Отметки(СтрокаНастроек)
	
	Отметки = Новый Структура;
	Отметки.Вставить("Транзакции",    Ложь);
	Отметки.Вставить("ОСВ",           Ложь);
	Отметки.Вставить("ОСВПоСчетам",   Ложь);
	Отметки.Вставить("АнализыСчетов", Ложь);
	
	Если СтрокаНастроек <> Неопределено Тогда
		Отметки.Транзакции = СтрокаНастроек.Транзакции;
		Отметки.ОСВ = СтрокаНастроек.ОСВ;
		Отметки.ОСВПоСчетам = СтрокаНастроек.ОСВПоСчетам;
		Отметки.АнализыСчетов = СтрокаНастроек.АнализыСчетов;
	КонецЕсли;
	
	Возврат Отметки;
	
КонецФункции

&НаСервере
Процедура ИзменитьНастройкуПоОрганизации(Организация, Отметки)
	
	ЗаписьНастройки = РегистрыСведений.НастройкиОтправкиОтчетностиВБанк.СоздатьМенеджерЗаписи();
	ЗаписьНастройки.Организация = Организация;
	ЗаписьНастройки.Прочитать();
	
	ЗаписьНастройки.Организация = Организация;
	ЗаписьНастройки.ОтправлятьОтчеты = Отметки.Транзакции;
	ЗаписьНастройки.ОтправлятьОСВ = Отметки.ОСВ;
	ЗаписьНастройки.ОтправлятьОСВПоСчетам = Отметки.ОСВПоСчетам;
	ЗаписьНастройки.ОтправлятьАнализыСчетов = Отметки.АнализыСчетов;
	
	ЗаписьНастройки.Записать();
	
	ОтправлятьОтчеты = Ложь;
	Для Каждого Отметка Из Отметки Цикл
		ОтправлятьОтчеты = ОтправлятьОтчеты ИЛИ Отметка.Значение;
	КонецЦикла;
	
	Если ОтправлятьОтчеты Тогда
		ВключитьЗадание(Организация);
	Иначе
		ВыключитьЗадание(Организация);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ИзменитьСостояниеПоОрганизации(СтрокаНастроек)
	
	Отметки = Отметки(СтрокаНастроек);
	
	ОтправлятьОтчеты = Ложь;
	Для Каждого Отметка Из Отметки Цикл
		ОтправлятьОтчеты = ОтправлятьОтчеты ИЛИ Отметка.Значение;
	КонецЦикла;
	
	Если НЕ ОтправлятьОтчеты Тогда
		СтрокаНастроек.Состояние = СтрокаНастроек.СостояниеОтправки;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВключитьЗадание(Организация)
	
	УстановитьПривилегированныйРежим(Истина);
	
	Отбор = Новый Структура();
	Отбор.Вставить("Метаданные", "ОтправкаОтчетностиВБанк");
	Задания = РегламентныеЗаданияСервер.НайтиЗадания(Отбор);
	
	ТребуетсяСоздатьЗадание = Истина;
	
	Если Задания.Количество() > 0 Тогда
		Для Каждого РегЗадание Из Задания Цикл
			Если РегЗадание.Параметры.Количество() > 0 И РегЗадание.Параметры[0] = Организация Тогда
				ТребуетсяСоздатьЗадание = Ложь;
				
				Если НЕ РегЗадание.Использование Тогда
					ПараметрыЗадания = Новый Структура();
					ПараметрыЗадания.Вставить("Использование", Истина);
					РегламентныеЗаданияСервер.ИзменитьЗадание(РегЗадание, ПараметрыЗадания);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	Если ТребуетсяСоздатьЗадание Тогда
		ПараметрыЗадания = Новый Структура;
		ПараметрыЗадания.Вставить("Метаданные", Метаданные.РегламентныеЗадания.ОтправкаОтчетностиВБанк);
		
		ПараметрыЗадания.Вставить("Параметры", ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Организация));
		ПараметрыЗадания.Вставить("Расписание", РасписаниеОтправки());
		НаименованиеЗадания = СтрШаблон(НСтр("ru = 'Отправка отчетности в Сбербанк от %1';
											|en = 'Отправка отчетности в Сбербанк от %1'"), Организация);
		ПараметрыЗадания.Вставить("Наименование", НаименованиеЗадания);
		
		ПараметрыЗадания.Вставить("ИнтервалПовтораПриАварийномЗавершении",    1200);
		ПараметрыЗадания.Вставить("КоличествоПовторовПриАварийномЗавершении", 3);
		ПараметрыЗадания.Вставить("Использование", Истина);
		
		РегламентныеЗаданияСервер.ДобавитьЗадание(ПараметрыЗадания);
		
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаСервере
Процедура ВыключитьЗадание(Организация)
	
	УстановитьПривилегированныйРежим(Истина);
	
	Отбор = Новый Структура();
	Отбор.Вставить("Метаданные", "ОтправкаОтчетностиВБанк");
	Задания = РегламентныеЗаданияСервер.НайтиЗадания(Отбор);
	
	Для Каждого РегЗадание Из Задания Цикл
		Если РегЗадание.Параметры.Количество() > 0 И РегЗадание.Параметры[0] = Организация Тогда
			РегламентныеЗаданияСервер.УдалитьЗадание(РегЗадание);
		КонецЕсли;
	КонецЦикла;
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

&НаСервере
Функция РасписаниеОтправки()
	
	ГСЧ = Новый ГенераторСлучайныхЧисел(ТекущаяУниверсальнаяДатаВМиллисекундах());
	
	Расписание = Новый РасписаниеРегламентногоЗадания;
	Расписание.ПериодПовтораДней = 1;
	Расписание.ПериодПовтораВТечениеДня = 0;
	Расписание.ВремяНачала = '00010101000000' + ГСЧ.СлучайноеЧисло(32400, 61200); // с 9:00 до 17:00
	
	Возврат Расписание;
	
КонецФункции

&НаСервере
Функция ОтправитьОтчетностьВФоне(Организация)
	
	НаименованиеЗадания = НСтр("ru = 'Отправка сведений в Сбербанк';
								|en = 'Отправка сведений в Сбербанк'");
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияПроцедуры();
	ПараметрыВыполнения.НаименованиеФоновогоЗадания = НаименованиеЗадания;
	ПараметрыВыполнения.ЗапуститьВФоне = Истина;
	
	РезультатЗапуска = ДлительныеОперации.ВыполнитьПроцедуру(ПараметрыВыполнения,
		"ОтчетностьВБанкиСлужебный.ОтправитьОтчетностьВБанкПринудительно",
		Организация);
	
	Возврат РезультатЗапуска;
	
КонецФункции

&НаКлиенте
Процедура ОбработатьЗавершениеОтправкиВФоне(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ОбновитьСведенияНастроекНаСервере();
	
	ТекстСообщения = СтрШаблон(НСтр("ru = 'Отчеты по организации %1 отправлены в Сбербанк';
									|en = 'Отчеты по организации %1 отправлены в Сбербанк'"),
		Элементы.Организации.ТекущиеДанные.Организация);
	
	ОбщегоНазначенияКлиент.СообщитьПользователю(ТекстСообщения);
	
КонецПроцедуры

&НаКлиенте
Процедура НастроитьСчетаПоОрганизации(Организация, Отметки)
	
	НастройкиСчетов = НастройкиСчетовПоОрганизации(Организация);
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("НастройкиСчетов", НастройкиСчетов);
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("Организация", Организация);
	ДополнительныеПараметры.Вставить("Отметки", Отметки);
	ОписаниеОповещения = Новый ОписаниеОповещения("ОбработатьНастройкуСчетовОСВ",
		ЭтотОбъект, ДополнительныеПараметры);
	
	ОткрытьФорму("РегистрСведений.НастройкиОтправкиОтчетностиВБанк.Форма.НастройкаСпискаСчетов",
		ПараметрыФормы, ЭтотОбъект, , , , ОписаниеОповещения, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция НастройкиСчетовПоОрганизации(Организация)
	
	СчетаПоОрганизации = РегистрыСведений.НастройкиОтправкиОтчетностиВБанк.НовыйСписокСчетовДляНастройки();
	ДоступныеСчета = ОтчетностьВБанкиСлужебный.СчетаОСВПоСчетам();
	
	Для Каждого Счет Из ДоступныеСчета Цикл
		СтрокаСчета = СчетаПоОрганизации.Добавить();
		СтрокаСчета.Включен = Ложь;
		СтрокаСчета.Счет = Счет;
		СтрокаСчета.Наименование = Счет.Код + " " + Счет.Наименование;
	КонецЦикла;
	
	ЗаписьНастройки = РегистрыСведений.НастройкиОтправкиОтчетностиВБанк.СоздатьМенеджерЗаписи();
	ЗаписьНастройки.Организация = Организация;
	ЗаписьНастройки.Прочитать();
	
	ОтправлятьОСВПоСчетам = ЗаписьНастройки.ОтправлятьОСВПоСчетам;
	ОтправляемыеСчета = ЗаписьНастройки.СчетаОСВПоСчетам.Получить();
	
	Если ОтправлятьОСВПоСчетам Тогда
		Если ОтправляемыеСчета = Неопределено ИЛИ ОтправляемыеСчета.Количество() = 0 Тогда
			Для Каждого Счет Из СчетаПоОрганизации Цикл
				Счет.Включен = Истина;
			КонецЦикла;
		Иначе
			Для Каждого Счет Из ОтправляемыеСчета Цикл
				СтрокаСчета = СчетаПоОрганизации.Найти(Счет, "Счет");
				Если СтрокаСчета <> Неопределено Тогда
					СтрокаСчета.Включен = Истина;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ОбщегоНазначения.ТаблицаЗначенийВМассив(СчетаПоОрганизации);
	
КонецФункции

&НаКлиенте
Процедура ОбработатьНастройкуСчетовОСВ(РезультатНастройки, ДополнительныеПараметры) Экспорт
	
	Если РезультатНастройки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Организация = ДополнительныеПараметры.Организация;
	Отметки = ДополнительныеПараметры.Отметки;
	
	ИзменитьНастройкуСчетовОСВ(РезультатНастройки, Организация, Отметки);
	ЗапланироватьОтправкиПредшествующихПериодовОСВПоСчету(Организация, Отметки);
	
	ТекущиеДанные = Элементы.Организации.ТекущиеДанные;
	ИзменитьСостояниеПоОрганизации(ТекущиеДанные);
	
КонецПроцедуры

&НаСервере
Процедура ИзменитьНастройкуСчетовОСВ(ВыбранныеСчета, Организация, Отметки)
	
	ОтправляемыеСчета = Новый Массив;
	Для Каждого ВыбранныйСчет Из ВыбранныеСчета Цикл
		Если ВыбранныйСчет.Включен Тогда
			ОтправляемыеСчета.Добавить(ВыбранныйСчет.Счет);
		КонецЕсли;
	КонецЦикла;
	ОтправлятьОтчет = ОтправляемыеСчета.Количество() <> 0;
	Отметки.ОСВПоСчетам = ОтправлятьОтчет;
	
	ЗаписьНастройки = РегистрыСведений.НастройкиОтправкиОтчетностиВБанк.СоздатьМенеджерЗаписи();
	ЗаписьНастройки.Организация = Организация;
	ЗаписьНастройки.Прочитать();
	
	ЗаписьНастройки.Организация = Организация;
	ЗаписьНастройки.ОтправлятьОСВПоСчетам = ОтправлятьОтчет;
	ЗаписьНастройки.СчетаОСВПоСчетам = Новый ХранилищеЗначения(ОтправляемыеСчета);
	
	ЗаписьНастройки.Записать();
	
	ОтправлятьОтчеты = Ложь;
	Для Каждого Отметка Из Отметки Цикл
		ОтправлятьОтчеты = ОтправлятьОтчеты ИЛИ Отметка.Значение;
	КонецЦикла;
	
	Если ОтправлятьОтчеты Тогда
		ВключитьЗадание(Организация);
	Иначе
		ВыключитьЗадание(Организация);
	КонецЕсли;
	
	ОбновитьСведенияНастроекНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура ЗапланироватьОтправкиПредшествующихПериодовОСВПоСчету(Организация, Отметки)
	
	Если НЕ Отметки.ОСВПоСчетам Тогда
		// Пользователь отключил отправку ОСВ по счетам.
		// Изменения в регистрах не требуются.
		Возврат;
	КонецЕсли;
	
	РетроспективныеОтправки = ОтчетностьВБанкиСлужебный.НоваяТаблицаРетроспективныхОтправок();
	ОтчетностьВБанкиСлужебный.ДобавитьОписаниеРетроспективныхОтправокОСВПоСчетам(Организация, РетроспективныеОтправки);
	ДобавитьЗапланированныеОтправки(Организация, РетроспективныеОтправки);
	
КонецПроцедуры

&НаКлиенте
Процедура НастроитьСчетаАнализовСчетовПоОрганизации(Организация, Отметки)
	
	НастройкиСчетов = НастройкиСчетовАнализовСчетовПоОрганизации(Организация);
	
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("НастройкиСчетов", НастройкиСчетов);
	
	ДополнительныеПараметры = Новый Структура;
	ДополнительныеПараметры.Вставить("Организация", Организация);
	ДополнительныеПараметры.Вставить("Отметки", Отметки);
	ОписаниеОповещения = Новый ОписаниеОповещения("ОбработатьНастройкуСчетовАнализовСчетов",
		ЭтотОбъект, ДополнительныеПараметры);
	
	ОткрытьФорму("РегистрСведений.НастройкиОтправкиОтчетностиВБанк.Форма.НастройкаСпискаСчетов",
		ПараметрыФормы, ЭтотОбъект, , , , ОписаниеОповещения, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция НастройкиСчетовАнализовСчетовПоОрганизации(Организация)
	
	СчетаПоОрганизации = РегистрыСведений.НастройкиОтправкиОтчетностиВБанк.НовыйСписокСчетовДляНастройки();
	ДоступныеСчета = ОтчетностьВБанкиСлужебный.СчетаАнализовСчетов();
	
	Для Каждого Счет Из ДоступныеСчета Цикл
		СтрокаСчета = СчетаПоОрганизации.Добавить();
		СтрокаСчета.Включен = Ложь;
		СтрокаСчета.Счет = Счет;
		СтрокаСчета.Наименование = Счет.Код + " " + Счет.Наименование;
	КонецЦикла;
	
	ЗаписьНастройки = РегистрыСведений.НастройкиОтправкиОтчетностиВБанк.СоздатьМенеджерЗаписи();
	ЗаписьНастройки.Организация = Организация;
	ЗаписьНастройки.Прочитать();
	
	ОтправлятьОтчет = ЗаписьНастройки.ОтправлятьАнализыСчетов;
	ОтправляемыеСчета = ЗаписьНастройки.СчетаАнализовСчетов.Получить();
	
	Если ОтправлятьОтчет Тогда
		Если ОтправляемыеСчета = Неопределено ИЛИ ОтправляемыеСчета.Количество() = 0 Тогда
			Для Каждого Счет Из СчетаПоОрганизации Цикл
				Счет.Включен = Истина;
			КонецЦикла;
		Иначе
			Для Каждого Счет Из ОтправляемыеСчета Цикл
				СтрокаСчета = СчетаПоОрганизации.Найти(Счет, "Счет");
				Если СтрокаСчета <> Неопределено Тогда
					СтрокаСчета.Включен = Истина;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ОбщегоНазначения.ТаблицаЗначенийВМассив(СчетаПоОрганизации);
	
КонецФункции

&НаКлиенте
Процедура ОбработатьНастройкуСчетовАнализовСчетов(РезультатНастройки, ДополнительныеПараметры) Экспорт
	
	Если РезультатНастройки = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Организация = ДополнительныеПараметры.Организация;
	Отметки = ДополнительныеПараметры.Отметки;
	
	ИзменитьНастройкуСчетовАнализовСчетов(РезультатНастройки, Организация, Отметки);
	ЗапланироватьОтправкиПредшествующихПериодовАнализовСчетов(Организация, Отметки);
	
	ТекущиеДанные = Элементы.Организации.ТекущиеДанные;
	ИзменитьСостояниеПоОрганизации(ТекущиеДанные);
	
КонецПроцедуры

&НаСервере
Процедура ЗапланироватьОтправкиПредшествующихПериодовАнализовСчетов(Организация, Отметки)
	
	Если НЕ Отметки.АнализыСчетов Тогда
		// Пользователь отключил отправку анализов счетов.
		// Изменения в регистрах не требуются.
		Возврат;
	КонецЕсли;
	
	РетроспективныеОтправки = ОтчетностьВБанкиСлужебный.НоваяТаблицаРетроспективныхОтправок();
	ОтчетностьВБанкиСлужебный.ДобавитьОписаниеРетроспективныхОтправокАнализСчетов(Организация, РетроспективныеОтправки);
	ДобавитьЗапланированныеОтправки(Организация, РетроспективныеОтправки);
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьЗапланированныеОтправки(Организация, РетроспективныеОтправки)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	Отправки.Организация КАК Организация,
		|	Отправки.ВидОтчета КАК ВидОтчета,
		|	Отправки.НачалоПериода КАК НачалоПериода,
		|	Отправки.КонецПериода КАК КонецПериода
		|ПОМЕСТИТЬ ВТ_Отправки
		|ИЗ
		|	&Отправки КАК Отправки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Отправки.Организация КАК Организация,
		|	ВТ_Отправки.ВидОтчета КАК ВидОтчета,
		|	ВТ_Отправки.НачалоПериода КАК НачалоПериода,
		|	ВТ_Отправки.КонецПериода КАК КонецПериода,
		|	НЕ ЖурналПереданнойОтчетностиВБанк.ИмяПакета ЕСТЬ NULL КАК Отправлен
		|ИЗ
		|	ВТ_Отправки КАК ВТ_Отправки
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЖурналПереданнойОтчетностиВБанк КАК ЖурналПереданнойОтчетностиВБанк
		|		ПО ВТ_Отправки.Организация = ЖурналПереданнойОтчетностиВБанк.Организация
		|			И ВТ_Отправки.ВидОтчета = ЖурналПереданнойОтчетностиВБанк.ВидОтчета
		|			И ВТ_Отправки.НачалоПериода = ЖурналПереданнойОтчетностиВБанк.НачалоПериода
		|			И ВТ_Отправки.КонецПериода = ЖурналПереданнойОтчетностиВБанк.КонецПериода";
	
	Запрос.УстановитьПараметр("Отправки", РетроспективныеОтправки.Скопировать( ,
		"Организация, ВидОтчета, НачалоПериода, КонецПериода"));
	
	ВыборкаОтправок = Запрос.Выполнить().Выбрать();
	
	Пока ВыборкаОтправок.Следующий() Цикл
		Если НЕ ВыборкаОтправок.Отправлен Тогда
			Отправка = РетроспективныеОтправки.Найти(ВыборкаОтправок.НачалоПериода, "НачалоПериода");
			Если Отправка = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			ПараметрыВыгрузки = ОтчетностьВБанкиСлужебный.ПараметрыЭлектронногоПредставления(
				Организация, Отправка.ПараметрыОтчетов, Отправка.МоментОтправки);
			
			ПараметрыОтправки = Новый Структура;
			ПараметрыОтправки.Вставить("Организация", Организация);
			ПараметрыОтправки.Вставить("ИмяПакета", ПараметрыВыгрузки.ИдФайл);
			ПараметрыОтправки.Вставить("ДатаОтправки", Отправка.МоментОтправки);
			ПараметрыОтправки.Вставить("ДатаНачала", ПараметрыВыгрузки.НачалоПериода);
			ПараметрыОтправки.Вставить("ДатаОкончания", ПараметрыВыгрузки.КонецПериода);
			
			ЗаписьЖурналаОтправки = РегистрыСведений.ЖурналПередачиОтчетностиВБанк.СоздатьМенеджерЗаписи();
			ЗаполнитьЗначенияСвойств(ЗаписьЖурналаОтправки, ПараметрыОтправки);
			ЗаписьЖурналаОтправки.Состояние = "Запланирована";
			ЗаписьЖурналаОтправки.Записать();
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура ИзменитьНастройкуСчетовАнализовСчетов(ВыбранныеСчета, Организация, Отметки)
	
	ОтправляемыеСчета = Новый Массив;
	Для Каждого ВыбранныйСчет Из ВыбранныеСчета Цикл
		Если ВыбранныйСчет.Включен Тогда
			ОтправляемыеСчета.Добавить(ВыбранныйСчет.Счет);
		КонецЕсли;
	КонецЦикла;
	ОтправлятьОтчет = ОтправляемыеСчета.Количество() <> 0;
	Отметки.АнализыСчетов = ОтправлятьОтчет;
	
	ЗаписьНастройки = РегистрыСведений.НастройкиОтправкиОтчетностиВБанк.СоздатьМенеджерЗаписи();
	ЗаписьНастройки.Организация = Организация;
	ЗаписьНастройки.Прочитать();
	
	ЗаписьНастройки.Организация = Организация;
	ЗаписьНастройки.ОтправлятьАнализыСчетов = ОтправлятьОтчет;
	ЗаписьНастройки.СчетаАнализовСчетов = Новый ХранилищеЗначения(ОтправляемыеСчета);
	
	ЗаписьНастройки.Записать();
	
	ОтправлятьОтчеты = Ложь;
	Для Каждого Отметка Из Отметки Цикл
		ОтправлятьОтчеты = ОтправлятьОтчеты ИЛИ Отметка.Значение;
	КонецЦикла;
	
	Если ОтправлятьОтчеты Тогда
		ВключитьЗадание(Организация);
	Иначе
		ВыключитьЗадание(Организация);
	КонецЕсли;
	
	ОбновитьСведенияНастроекНаСервере();
	
КонецПроцедуры

&НаСервере
Функция ТекстГиперссылкиПоСчетам(СчетаОтправляются, СчетаОтчета)
	
	Если СчетаОтправляются Тогда
		ТекстГиперссылки = "Все счета";
		
		КоличествоКодовСчетов = Мин(СчетаОтчета.Количество(), 3);
		
		ОсновныеСчета = "";
		Для Инд = 1 По КоличествоКодовСчетов Цикл
			ОсновныеСчета = ОсновныеСчета + ", " + СчетаОтчета[Инд - 1].Код;
		КонецЦикла;
		ОсновныеСчета = Сред(ОсновныеСчета, 2);
		
		НачалоНадписи = ?(КоличествоКодовСчетов = 1, НСтр("ru = 'Счет';
															|en = 'Счет'"), НСтр("ru = 'Счета';
																				|en = 'Счета'"));
		
		СвернутоСчетов = СчетаОтчета.Количество() - КоличествоКодовСчетов;
		
		СвернутыеСчета = "";
		Если СвернутоСчетов > 0 Тогда
			СвернутыеСчета = НСтр("ru = ' и еще %1 счетов';
									|en = ' и еще %1 счетов'");
			ПоследняяЦифра = СвернутоСчетов % 10;
			Если ПоследняяЦифра = 1 Тогда
				СвернутыеСчета = НСтр("ru = ' и еще %1 счет';
										|en = ' и еще %1 счет'");
			ИначеЕсли ПоследняяЦифра = 2 ИЛИ ПоследняяЦифра = 3 ИЛИ ПоследняяЦифра = 4 Тогда
				СвернутыеСчета = НСтр("ru = ' и еще %1 счета';
										|en = ' и еще %1 счета'");
			КонецЕсли;
			СвернутыеСчета = СтрШаблон(СвернутыеСчета, Формат(СвернутоСчетов, "ЧН=; ЧГ=0"));
		КонецЕсли;
		
		ТекстГиперссылки = СтрШаблон("%1 %2%3",
			НачалоНадписи, ОсновныеСчета, СвернутыеСчета);
		
	Иначе
		ТекстГиперссылки = НСтр("ru = 'Не отправляется';
								|en = 'Не отправляется'");
		
	КонецЕсли;
	
	Возврат ТекстГиперссылки;
	
КонецФункции

// Возвращает признак возможности выполнения команды. Проверяется наличие настроек отправки
// по текущей организации в списке.
// 
// Параметры:
//  Отметки - см. Отметки
// 
// Возвращаемое значение:
//  Булево - Выполнение команды возможно
&НаКлиенте
Функция ВыполнениеКомандыВозможно(Отметки)
	
	Если Элементы.Организации.ТекущиеДанные = Неопределено Тогда
		ТекстОповещения = НСтр("ru = 'Не выбрана организация для отправки отчетов в Сбербанк';
								|en = 'Не выбрана организация для отправки отчетов в Сбербанк'");
		ПоказатьПредупреждение( , ТекстОповещения);
		Возврат Ложь;
	КонецЕсли;
	
	Организация = Элементы.Организации.ТекущиеДанные.Организация;
	
	ЕстьОтчетыДляОправки = Ложь;
	Для Каждого Отметка Из Отметки Цикл
		ЕстьОтчетыДляОправки = ЕстьОтчетыДляОправки ИЛИ Отметка.Значение;
	КонецЦикла;
	
	Если НЕ ЕстьОтчетыДляОправки Тогда
		ТекстОповещения = СтрШаблон(НСтр("ru = 'Для организации %1 не выбраны отчеты для отправки в Сбербанк';
										|en = 'Для организации %1 не выбраны отчеты для отправки в Сбербанк'"),
			Организация);
		ПоказатьПредупреждение( , ТекстОповещения);
		Возврат Ложь;
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

&НаСервере
Функция ВыгрузитьОтчетностьВФоне(Организация, Отметки)
	
	НаименованиеЗадания = НСтр("ru = 'Выгрузка сведений для Сбербанка';
								|en = 'Выгрузка сведений для Сбербанка'");
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияФункции(УникальныйИдентификатор);
	ПараметрыВыполнения.НаименованиеФоновогоЗадания = НаименованиеЗадания;
	ПараметрыВыполнения.ЗапуститьВФоне = Истина;
	
	РезультатЗапуска = ДлительныеОперации.ВыполнитьФункцию(ПараметрыВыполнения,
		"ОтчетностьВБанкиСлужебный.СформироватьСодержимоеПакетаОтправки",
		Организация, Отметки);
	
	Возврат РезультатЗапуска;
	
КонецФункции

&НаКлиенте
Процедура ОбработатьЗавершениеВыгрузкиВФоне(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		Если Результат.Статус = "Выполнено" Тогда
			РезультатВыгрузки = ПолучитьИзВременногоХранилища(Результат.АдресРезультата);
			
			АдресДанныхДляСохранения = ПоместитьВоВременноеХранилище(РезультатВыгрузки.ДвоичныеДанныеПакета, УникальныйИдентификатор);
			ПараметрыСохранения = ФайловаяСистемаКлиент.ПараметрыСохраненияФайла();
			ПараметрыСохранения.Диалог.Фильтр = "ZIP-файл (*.zip)|*.zip";
			
			ОбработчикЗавершения = Новый ОписаниеОповещения("ЗавершитьСохранениеПакетаВыгрузки", ЭтотОбъект, АдресДанныхДляСохранения);
			
			ФайловаяСистемаКлиент.СохранитьФайл(ОбработчикЗавершения, АдресДанныхДляСохранения,
				РезультатВыгрузки.ИмяФайлаПакета, ПараметрыСохранения);
			
		ИначеЕсли Результат.Статус = "Ошибка" Тогда
			ВызватьИсключение Результат.ПодробноеПредставлениеОшибки;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьСохранениеПакетаВыгрузки(ПолученныеФайлы, ДополнительныеПараметры) Экспорт
	
	#Если ВебКлиент Тогда
	Возврат;
	#КонецЕсли
	
	УдалитьИзВременногоХранилища(ДополнительныеПараметры);
	
	ИмяКаталога = Неопределено;
	Если ЗначениеЗаполнено(ПолученныеФайлы) И ПолученныеФайлы.Количество() > 0 Тогда
		ПолноеИмяФайла = ПолученныеФайлы[0].ПолноеИмя;
		СоставляющиеИмениФайла = ОбщегоНазначенияКлиентСервер.РазложитьПолноеИмяФайла(ПолноеИмяФайла);
		ИмяКаталога = СоставляющиеИмениФайла.Путь;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ИмяКаталога) Тогда
		ПоказатьОповещениеПользователя(
			НСтр("ru = 'Пакет файлов выгрузки сохранен';
				|en = 'Пакет файлов выгрузки сохранен'"),
			"file:///" + ИмяКаталога,
			СтрШаблон(НСтр("ru = 'в папку %1';
							|en = 'в папку %1'"), ИмяКаталога),
			БиблиотекаКартинок.Информация32);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
