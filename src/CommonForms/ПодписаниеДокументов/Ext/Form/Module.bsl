#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Создание реквизитов для табличных документов.
	НовыеРеквизитыФормы = Новый Массив; // Массив из РеквизитФормы -
	Для НомерПечатнойФормы = 1 По Параметры.КоллекцияПечатныхФорм.Количество() Цикл
		ИмяРеквизита = "ПечатнаяФорма" + Формат(НомерПечатнойФормы,"ЧГ=0");
		РеквизитФормы = Новый РеквизитФормы(
			ИмяРеквизита,
			Новый ОписаниеТипов("ТабличныйДокумент")
			,
			,
			Параметры.КоллекцияПечатныхФорм[НомерПечатнойФормы - 1].СинонимМакета);
		НовыеРеквизитыФормы.Добавить(РеквизитФормы);
	КонецЦикла;
	ИзменитьРеквизиты(НовыеРеквизитыФормы);
	
	ОбъектыПечати = Параметры.ОбъектыПечати;
	Для Каждого ЭлементКоллекции Из Параметры.КоллекцияПечатныхФорм Цикл
		НоваяНастройка = НастройкиПечатныхФорм.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяНастройка, ЭлементКоллекции);
		НоваяНастройка.Печатать = Истина;
		НоваяНастройка.ИмяРеквизита = "ПечатнаяФорма" + Формат(НастройкиПечатныхФорм.Количество(),"ЧГ=0");
		ОбщегоНазначенияКлиентСервер.УстановитьРеквизитФормыПоПути(
			ЭтотОбъект,
			НоваяНастройка.ИмяРеквизита,
			ЭлементКоллекции.ТабличныйДокумент);
		Если ТекущаяПечатнаяФорма.ВысотаТаблицы = 0 Тогда
			ТекущаяПечатнаяФорма = ЭлементКоллекции.ТабличныйДокумент;
		Иначе
			ТекущаяПечатнаяФорма.ВывестиГоризонтальныйРазделительСтраниц();
			УправлениеПечатьюБЗК.ВывестиОбластьСФорматомСтрок(ТекущаяПечатнаяФорма, ЭлементКоллекции.ТабличныйДокумент)
		КонецЕсли;
	КонецЦикла;
		
	ПараметрыПечати = Параметры.ПараметрыПечати;
	Если Параметры.ПараметрыПечати = Неопределено Тогда
		ПараметрыПечати = Новый Структура;
	КонецЕсли;
	Если Не ПараметрыПечати.Свойство("ДополнительныеПараметры") Тогда
		Параметры.ПараметрыПечати = Новый Структура("ДополнительныеПараметры", ПараметрыПечати);
		Для Каждого ПараметрПечати Из ПараметрыПечати Цикл
			Параметры.ПараметрыПечати.Вставить(ПараметрПечати.Ключ, ПараметрПечати.Значение);
		КонецЦикла;
	КонецЕсли;
	
	ПараметрыВывода = Параметры.ПараметрыВывода;
	Если ПараметрыВывода = Неопределено Тогда
		ПараметрыВывода = УправлениеПечатью.ПодготовитьСтруктуруПараметровВывода();
	КонецЕсли;
	
	ДоступныеКоманды = ДоступныеКомандыФормыПечатьДокументов();
	
	ТолькоПодписание = Параметры.Свойство("ПодписаниеПечатныхФорм")
		Или ДоступныеКоманды.Подписать;
	
	Если ДоступныеКоманды.Ознакомиться Тогда
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ПодписатьПечатныеФормы",
			"Видимость",
			Ложь);
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ОтказатьВПодписанииПечатныхФорм",
			"Видимость",
			Ложь);
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ОзнакомленоСКомментариямиКПечатнойФорме",
			"КнопкаПоУмолчанию",
			Истина);
	ИначеЕсли ТолькоПодписание Тогда
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(
			Элементы,
			"ОзнакомленоСКомментариямиКПечатнойФорме",
			"Видимость",
			Ложь);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "ОбновленыДанныеДокументовЭДОБЗК"
		И Источник = ЭтотОбъект Тогда
		
		Если Открыта() Тогда
			Закрыть();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ПодписатьПечатныеФормы(Команда)
	
	ЭДОБЗККлиент.ПечатьДокументовВыполнитьКоманду(ЭтотОбъект, Команда, Ложь, Неопределено);
	
КонецПроцедуры

&НаКлиенте
Процедура ОтказатьВПодписанииПечатныхФорм(Команда)
	
	ЭДОБЗККлиент.ПечатьДокументовВыполнитьКоманду(ЭтотОбъект, Команда, Ложь, Неопределено);
	
КонецПроцедуры

&НаКлиенте
Процедура ОзнакомленоСКомментариямиКПечатнойФорме(Команда)
	
	ЭДОБЗККлиент.ПечатьДокументовВыполнитьКоманду(ЭтотОбъект, Команда, Ложь, Неопределено);
	
КонецПроцедуры

#КонецОбласти


#Область СлужебныеПроцедурыИФункции

&НаСервере
Функция ДоступныеКомандыФормыПечатьДокументов()
	
	ДоступныеКоманды = Новый Структура("Подписать,Ознакомиться", Ложь, Ложь);
	
	ОписанияФайлов = ЭДОБЗККлиентСервер.ОписанияФайловПечатныхФормИзПараметровФормы(Параметры);
	Если ОписанияФайлов <> Неопределено Тогда
		ФайлыПечатныхФорм = Новый Массив;
		Для Каждого ДанныеИдентификаторовПечатныхФорм Из ОписанияФайлов.ПечатныеФормыОбъектов Цикл
			Для Каждого ДанныеИдентификатораПечатнойФормы Из ДанныеИдентификаторовПечатныхФорм.Значение Цикл
				ОбщегоНазначенияКлиентСервер.ДополнитьМассив(ФайлыПечатныхФорм, ДанныеИдентификатораПечатнойФормы.Значение);
			КонецЦикла;
		КонецЦикла;
		Если ЗначениеЗаполнено(ФайлыПечатныхФорм) Тогда
			ФайлыНаПодписьПользователя = РегистрыСведений.ЗапланированныеДействияСФайламиДокументовЭДОБЗК.ФайлыНаПодписьПользователя(Истина, , Истина);
			Если ФайлыНаПодписьПользователя.Количество() >= ФайлыПечатныхФорм.Количество() Тогда
				ДоступныеКоманды.Подписать = Истина;
				Для Каждого ФайлПечатныхФорм Из ФайлыПечатныхФорм Цикл
					СтруктураПоиска = Новый Структура("ФайлОбъекта,Действие", ФайлПечатныхФорм, Перечисления.ДействияСФайламиДокументовЭДОБЗК.Подписать);
					Если ФайлыНаПодписьПользователя.НайтиСтроки(СтруктураПоиска).Количество() = 0 Тогда
						ДоступныеКоманды.Подписать = Ложь;
					КонецЕсли;
					СтруктураПоиска = Новый Структура("ФайлОбъекта,Действие", ФайлПечатныхФорм, Перечисления.ДействияСФайламиДокументовЭДОБЗК.Ознакомиться);
					Если ФайлыНаПодписьПользователя.НайтиСтроки(СтруктураПоиска).Количество() > 0 Тогда
						ДоступныеКоманды.Ознакомиться = Истина;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Возврат ДоступныеКоманды;
	
КонецФункции

#КонецОбласти
