#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
	
	ОбработатьПереданныеПараметры(Отказ);
	УправлениеЭлементамиФормы();
	СтандартныеПодсистемыСервер.СброситьРазмерыИПоложениеОкна(ЭтотОбъект);
	
	ОбщегоНазначенияСобытияФормИСПереопределяемый.ПриСозданииНаСервере(ЭтотОбъект, Отказ, СтандартнаяОбработка);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ИнформацияСостояниеЗагрузкиОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если НавигационнаяСсылкаФорматированнойСтроки = "ОткрытьИмпортируемуюПартию" Тогда
		ПоказатьЗначение(, ИмпортируемаяПартия);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОрганизацияОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если НавигационнаяСсылкаФорматированнойСтроки = "ОткрытьОрганизацию" Тогда
		ПоказатьЗначение(, ОрганизацияСАТУРН);
	ИначеЕсли НавигационнаяСсылкаФорматированнойСтроки = "ЗагрузитьОрганизацию" Тогда
		
		ОповещениеПослеВопроса = Новый ОписаниеОповещения("ПослеЗагрузкиОрганизации", ЭтотОбъект);
		ТекстВопроса = НСтр("ru = 'Загрузить владельца импортируемой партии?';
							|en = 'Загрузить владельца импортируемой партии?'");
		
		ПоказатьВопрос(ОповещениеПослеВопроса, ТекстВопроса, РежимДиалогаВопрос.ОКОтмена);
		
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОписаниеМестаХраненияОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если НавигационнаяСсылкаФорматированнойСтроки = "ОткрытьМестоХранения" Тогда
		ПоказатьЗначение(, МестоХранения);
	ИначеЕсли НавигационнаяСсылкаФорматированнойСтроки = "ЗагрузитьМестоХранения" Тогда
		
		ОповещениеПослеВопроса = Новый ОписаниеОповещения("ПослеЗагрузкиМестаХранения", ЭтотОбъект);
		ТекстВопроса = НСтр("ru = 'Загрузить место хранения импортируемой партии?';
							|en = 'Загрузить место хранения импортируемой партии?'");
		
		ПоказатьВопрос(ОповещениеПослеВопроса, ТекстВопроса, РежимДиалогаВопрос.ОКОтмена);
		
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОписаниеСтраныОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если НавигационнаяСсылкаФорматированнойСтроки = "ОткрытьСтрану" Тогда
		ПоказатьЗначение(, Страна);
	ИначеЕсли НавигационнаяСсылкаФорматированнойСтроки = "ЗагрузитьСтрану" Тогда
		
		ОповещениеПослеВопроса = Новый ОписаниеОповещения("ПослеЗагрузкиСтраны", ЭтотОбъект);
		ТекстВопроса = НСтр("ru = 'Загрузить страну-импортера импортируемой партии?';
							|en = 'Загрузить страну-импортера импортируемой партии?'");
		
		ПоказатьВопрос(ОповещениеПослеВопроса, ТекстВопроса, РежимДиалогаВопрос.ОКОтмена);
		
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОписаниеТаможенногоПунктаОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если НавигационнаяСсылкаФорматированнойСтроки = "ОткрытьТаможенныйПункт" Тогда
		ПоказатьЗначение(, ТаможенныйПункт);
	ИначеЕсли НавигационнаяСсылкаФорматированнойСтроки = "ЗагрузитьТаможенныйПункт" Тогда
		
		ОповещениеПослеВопроса = Новый ОписаниеОповещения("ПослеЗагрузкиТаможенногоПункта", ЭтотОбъект);
		ТекстВопроса = НСтр("ru = 'Загрузить пункт растаможивания импортируемой партии?';
							|en = 'Загрузить пункт растаможивания импортируемой партии?'");
		
		ПоказатьВопрос(ОповещениеПослеВопроса, ТекстВопроса, РежимДиалогаВопрос.ОКОтмена);
		
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОписаниеТерриториальногоУправленияОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если НавигационнаяСсылкаФорматированнойСтроки = "ОткрытьТерриториальноеУправление" Тогда
		ПоказатьЗначение(, ТерриториальноеУправление);
	ИначеЕсли НавигационнаяСсылкаФорматированнойСтроки = "ЗагрузитьТерриториальноеУправление" Тогда
		
		ОповещениеПослеВопроса = Новый ОписаниеОповещения("ПослеЗагрузкиТерриториальногоУправления", ЭтотОбъект);
		ТекстВопроса = НСтр("ru = 'Загрузить территориальное управление импортируемой партии?';
							|en = 'Загрузить территориальное управление импортируемой партии?'");
		
		ПоказатьВопрос(ОповещениеПослеВопроса, ТекстВопроса, РежимДиалогаВопрос.ОКОтмена);
		
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОписаниеТипаТранспортногоСредстваОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылкаФорматированнойСтроки, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если НавигационнаяСсылкаФорматированнойСтроки = "ОткрытьТранспортноеСредство" Тогда
		ПоказатьЗначение(, ТранспортноеСредство);
	ИначеЕсли НавигационнаяСсылкаФорматированнойСтроки = "ЗагрузитьТранспортноеСредство" Тогда
		
		ОповещениеПослеВопроса = Новый ОписаниеОповещения("ПослеЗагрузкиТранспортногоСредства", ЭтотОбъект);
		ТекстВопроса = НСтр("ru = 'Загрузить транспортное средство импортируемой партии?';
							|en = 'Загрузить транспортное средство импортируемой партии?'");
		
		ПоказатьВопрос(ОповещениеПослеВопроса, ТекстВопроса, РежимДиалогаВопрос.ОКОтмена);
		
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовТаблицыФормыТовары

&НаКлиенте
Процедура ТоварыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
	
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Не Поле.Имя = Элементы.ТоварыПредставлениеПАТ.Имя Тогда
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ТекущиеДанные.ПАТ) Тогда
		ПоказатьЗначение(, ТекущиеДанные.ПАТ);
	ИначеЕсли ЗначениеЗаполнено(ТекущиеДанные.ИдентификаторПА) Тогда
		
		ДополнительныеПараметры = Новый Структура("ИдентификаторПА, ИдентификаторСтроки",
			ТекущиеДанные.ИдентификаторПА, ТекущиеДанные.ПолучитьИдентификатор());
		
		ОповещениеПослеВопроса = Новый ОписаниеОповещения("ПослеЗагрузкиПАТ", ЭтотОбъект, ДополнительныеПараметры);
		ТекстВопроса = НСтр("ru = 'Загрузить ПАТ?';
							|en = 'Загрузить ПАТ?'");
		
		ПоказатьВопрос(ОповещениеПослеВопроса, ТекстВопроса, РежимДиалогаВопрос.ОКОтмена);
		
	Иначе
		Возврат;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Загрузить(Команда)
	
	ЗагрузитьИмпортируемуюПартию_ДлительнаяОперация();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ЗагрузитьИмпортируемуюПартию_ДлительнаяОперация()
	
	ПараметрыОбработкиДокументов = ИнтеграцияСАТУРНСлужебныйКлиентСервер.ПараметрыОбработкиДокументов();
	ПараметрыОбработкиДокументов.Ссылка             = ПредопределенноеЗначение("Справочник.ИмпортируемаяПартияСАТУРН.ПустаяСсылка");
	ПараметрыОбработкиДокументов.ДальнейшееДействие = ПредопределенноеЗначение("Перечисление.ДальнейшиеДействияПоВзаимодействиюСАТУРН.ЗагрузитеКлассификатор");
	
	ПараметрыОбработкиДокументов.ДополнительныеПараметры = Новый Структура();
	ПараметрыОбработкиДокументов.ДополнительныеПараметры.Вставить("Идентификатор", Идентификатор);
	
	ОписаниеПриЗавершении = Новый ОписаниеОповещения(
		"Подключаемый_ПриЗавершенииОперации", ЭтотОбъект, ПараметрыОбработкиДокументов);
	
	ИнтеграцияСАТУРНКлиент.ПодготовитьКПередаче(
		ЭтотОбъект,
		ПараметрыОбработкиДокументов,
		ОписаниеПриЗавершении);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПриЗавершенииОперации(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если Результат.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Для Каждого ЭлементДанных Из Результат Цикл
		
		Если ЗначениеЗаполнено(ЭлементДанных.ТекстОшибки) Тогда
			ОбщегоНазначенияКлиент.СообщитьПользователю(ЭлементДанных.ТекстОшибки);
			Возврат;
		КонецЕсли;
		
		Для Каждого ОбъектЗагрузки Из ЭлементДанных.Объект Цикл
			
			Если Не ТипЗнч(ОбъектЗагрузки) = Тип("СправочникСсылка.ИмпортируемаяПартияСАТУРН") Тогда
				Продолжить;
			КонецЕсли;
			
			ИмпортируемаяПартия = ОбъектЗагрузки;
			Прервать;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Если Не ЗначениеЗаполнено(ИмпортируемаяПартия) Тогда
		Возврат;
	КонецЕсли;
	
	ТекстЗаголовка = НСтр("ru = 'Загрузка из классификатора';
							|en = 'Загрузка из классификатора'");
	
	ТекстСообщения = СтрШаблон(НСтр("ru = 'Выполнена загрузка импортируемой партии %1.';
									|en = 'Выполнена загрузка импортируемой партии %1.'"), ИмпортируемаяПартия);
	ПоказатьОповещениеПользователя(ТекстЗаголовка,, ТекстСообщения, БиблиотекаКартинок.Информация32ГосИС);
	
	ОбщегоНазначенияКлиент.ОповеститьОбИзмененииОбъекта(ИмпортируемаяПартия);
	
	Закрыть(МестоХранения);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗагрузкиОрганизации(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	
	ЗагрузитьОрганизациюНаСервере();
	
	Если ЗначениеЗаполнено(ОрганизацияСАТУРН) Тогда
		
		ПараметрОповещения = ОрганизацияСАТУРН;
		ОбщегоНазначенияКлиент.ОповеститьОбИзмененииОбъекта(ОрганизацияСАТУРН, ПараметрОповещения);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьОрганизациюНаСервере()
	
	Если Не ЗначениеЗаполнено(ИдентификаторОрганизации) Тогда
		Возврат;
	КонецЕсли;
	
	РезультатВыполненияЗапроса = ИнтерфейсСАТУРНВызовСервера.ОрганизацияПоИдентификатору(ИдентификаторОрганизации);
	
	Если Не ПустаяСтрока(РезультатВыполненияЗапроса.ТекстОшибки) Тогда
		
		ОбщегоНазначения.СообщитьПользователю(РезультатВыполненияЗапроса.ТекстОшибки);
		
	Иначе
		
		ДанныеОрганизации = ИнтерфейсСАТУРН.ДанныеОрганизации(РезультатВыполненияЗапроса.Элемент);
		ОрганизацияСАТУРН = ИнтеграцияСАТУРН.ЗагрузитьОрганизацию(ДанныеОрганизации);
		
	КонецЕсли;
	
	УстановитьОтображениеОрганизации();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗагрузкиМестаХранения(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	
	ЗагрузитьМестоХраненияНаСервере();
	
	Если ЗначениеЗаполнено(МестоХранения) Тогда
		
		ПараметрОповещения = МестоХранения;
		ОбщегоНазначенияКлиент.ОповеститьОбИзмененииОбъекта(МестоХранения, ПараметрОповещения);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьМестоХраненияНаСервере()
	
	Если Не ЗначениеЗаполнено(ИдентификаторМестаХранения) Тогда
		Возврат;
	КонецЕсли;
	
	РезультатВыполненияЗапроса = ИнтерфейсСАТУРНВызовСервера.МестоХраненияПоИдентификатору(ИдентификаторМестаХранения);
	
	Если Не ПустаяСтрока(РезультатВыполненияЗапроса.ТекстОшибки) Тогда
		
		ОбщегоНазначения.СообщитьПользователю(РезультатВыполненияЗапроса.ТекстОшибки);
		
	Иначе
		
		ДанныеМестаХранения = ИнтерфейсСАТУРН.ДанныеМестаХранения(РезультатВыполненияЗапроса.Элемент);
		МестоХранения       = ИнтеграцияСАТУРН.ЗагрузитьМестоХранения(ДанныеМестаХранения);
		
	КонецЕсли;
	
	УстановитьОтображениеМестаХранения();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗагрузкиСтраны(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	
	ЗагрузитьСтрануНаСервере();
	
	Если ЗначениеЗаполнено(Страна) Тогда
		
		ПараметрОповещения = Страна;
		ОбщегоНазначенияКлиент.ОповеститьОбИзмененииОбъекта(Страна, ПараметрОповещения);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьСтрануНаСервере()
	
	Если Не ЗначениеЗаполнено(ИдентификаторСтраныЭкспортера) Тогда
		Возврат;
	КонецЕсли;
	
	Результат = ИнтерфейсСАТУРНВызовСервера.СписокКлассификаторовСтран();
	
	Если ЗначениеЗаполнено(Результат.ТекстОшибки) Тогда
		
		ОбщегоНазначения.СообщитьПользователю(Результат.ТекстОшибки);
		Возврат;
		
	КонецЕсли;
	
	ПараметрыОбмена = ИнтеграцияСАТУРН.ПараметрыОбмена();
	
	ИнтеграцияСАТУРН.ЗагрузитьДанныеКлассификатора(Результат.Список, Метаданные.Справочники.КлассификаторСтранСАТУРН);
	Страна = Справочники.КлассификаторСтранСАТУРН.КлассификаторСтраны(ИдентификаторСтраныЭкспортера, ПараметрыОбмена);
	
	УстановитьОтображениеСтраны();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗагрузкиТаможенногоПункта(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	
	ЗагрузитьТаможенныйПунктНаСервере();
	
	Если ЗначениеЗаполнено(ТаможенныйПункт) Тогда
		
		ПараметрОповещения = ТаможенныйПункт;
		ОбщегоНазначенияКлиент.ОповеститьОбИзмененииОбъекта(ТаможенныйПункт, ПараметрОповещения);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьТаможенныйПунктНаСервере()
	
	Если Не ЗначениеЗаполнено(ИдентификаторТаможенногоПункта) Тогда
		Возврат;
	КонецЕсли;
	
	Результат = ИнтерфейсСАТУРНВызовСервера.СписокКлассификаторовТаможенныхПунктов();
	
	Если ЗначениеЗаполнено(Результат.ТекстОшибки) Тогда
		
		ОбщегоНазначения.СообщитьПользователю(Результат.ТекстОшибки);
		Возврат;
		
	КонецЕсли;
	
	ПараметрыОбмена = ИнтеграцияСАТУРН.ПараметрыОбмена();
	
	ИнтеграцияСАТУРН.ЗагрузитьДанныеКлассификатора(Результат.Список, Метаданные.Справочники.КлассификаторТаможенныхПунктовСАТУРН);
	ТаможенныйПункт = Справочники.КлассификаторТаможенныхПунктовСАТУРН.КлассификаторТаможенногоПункта(ИдентификаторТерриториальногоУправления, ПараметрыОбмена);
	
	УстановитьОтображениеТаможенногоПункта();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗагрузкиТерриториальногоУправления(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	
	ЗагрузитьТерриториальноеУправлениеНаСервере();
	
	Если ЗначениеЗаполнено(ТерриториальноеУправление) Тогда
		
		ПараметрОповещения = ТерриториальноеУправление;
		ОбщегоНазначенияКлиент.ОповеститьОбИзмененииОбъекта(ТерриториальноеУправление, ПараметрОповещения);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьТерриториальноеУправлениеНаСервере()
	
	Если Не ЗначениеЗаполнено(ИдентификаторТерриториальногоУправления) Тогда
		Возврат;
	КонецЕсли;
	
	Результат = ИнтерфейсСАТУРНВызовСервера.СписокКлассификаторовТерриториальныхУправлений();
	
	Если ЗначениеЗаполнено(Результат.ТекстОшибки) Тогда
		
		ОбщегоНазначения.СообщитьПользователю(Результат.ТекстОшибки);
		Возврат;
		
	КонецЕсли;
	
	ПараметрыОбмена = ИнтеграцияСАТУРН.ПараметрыОбмена();
	
	ИнтеграцияСАТУРН.ЗагрузитьДанныеКлассификатора(Результат.Список, Метаданные.Справочники.КлассификаторТерриториальныхУправленийСАТУРН);
	ТерриториальноеУправление = Справочники.КлассификаторТерриториальныхУправленийСАТУРН.КлассификаторТУ(ИдентификаторТерриториальногоУправления, ПараметрыОбмена);
	
	УстановитьОтображениеТерриториальногоУправления();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗагрузкиТранспортногоСредства(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	
	ЗагрузитьТранспортноеСредствоНаСервере();
	
	Если ЗначениеЗаполнено(ТранспортноеСредство) Тогда
		
		ПараметрОповещения = ТранспортноеСредство;
		ОбщегоНазначенияКлиент.ОповеститьОбИзмененииОбъекта(ТранспортноеСредство, ПараметрОповещения);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьТранспортноеСредствоНаСервере()
	
	Если Не ЗначениеЗаполнено(ИдентификаторТипаТранспортногоСредстваПеревозчика) Тогда
		Возврат;
	КонецЕсли;
	
	Результат = ИнтерфейсСАТУРНВызовСервера.СписокКлассификаторовТранспортныхСредств();
	
	Если ЗначениеЗаполнено(Результат.ТекстОшибки) Тогда
		
		ОбщегоНазначения.СообщитьПользователю(Результат.ТекстОшибки);
		Возврат;
		
	КонецЕсли;
	
	ПараметрыОбмена = ИнтеграцияСАТУРН.ПараметрыОбмена();
	
	ИнтеграцияСАТУРН.ЗагрузитьДанныеКлассификатора(Результат.Список, Метаданные.Справочники.КлассификаторТранспортныхСредствСАТУРН);
	ТранспортноеСредство = Справочники.КлассификаторТранспортныхСредствСАТУРН.КлассификаторТС(ИдентификаторТипаТранспортногоСредстваПеревозчика, ПараметрыОбмена);
	
	УстановитьОтображениеТранспортногоСредства();
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗагрузкиПАТ(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = КодВозвратаДиалога.ОК Тогда
		Возврат;
	КонецЕсли;
	
	ПАТ = ЗагрузитьПАТНаСервере(ДополнительныеПараметры.ИдентификаторПА, ДополнительныеПараметры.ИдентификаторСтроки);
	
	Если ЗначениеЗаполнено(ПАТ) Тогда
		
		ПараметрОповещения = ПАТ;
		ОбщегоНазначенияКлиент.ОповеститьОбИзмененииОбъекта(ПАТ, ПараметрОповещения);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ЗагрузитьПАТНаСервере(ИдентификаторПАТ, ИдентификаторСтроки)
	
	Если Не ЗначениеЗаполнено(ИдентификаторПАТ) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	РезультатВыполненияЗапроса = ИнтерфейсСАТУРНВызовСервера.ПАТПоИдентификатору(ИдентификаторПАТ);
	
	Если Не ПустаяСтрока(РезультатВыполненияЗапроса.ТекстОшибки) Тогда
		
		ОбщегоНазначения.СообщитьПользователю(РезультатВыполненияЗапроса.ТекстОшибки);
		
	Иначе
		
		ДанныеПАТ = ИнтерфейсСАТУРН.ДанныеПАТ(РезультатВыполненияЗапроса.Элемент);
		ПАТ = ИнтеграцияСАТУРН.ЗагрузитьПАТ(ДанныеПАТ);
		
	КонецЕсли;
	
	СтрокаТоваров = Товары.НайтиПоИдентификатору(ИдентификаторСтроки);
	
	Если СтрокаТоваров <> Неопределено Тогда
		СтрокаТоваров.ПАТ = ПАТ;
	КонецЕсли;
	
	УстановитьОтображениеПАТ(ИдентификаторСтроки);
	
КонецФункции

&НаСервере
Процедура ОбработатьПереданныеПараметры(Отказ)

	Если Не ЗначениеЗаполнено(Параметры.Идентификатор) Тогда
		ВызватьИсключение НСтр("ru = 'Форма не предназначена для открытия без передачи в неё идентификатора импортируемой партии.';
								|en = 'Форма не предназначена для открытия без передачи в неё идентификатора импортируемой партии.'");
	Иначе
		
		Идентификатор = Параметры.Идентификатор;
		НеПоказыватьСостояниеЗагрузки = Параметры.НеПоказыватьСостояниеЗагрузки;
		Результат = ИнтерфейсСАТУРНВызовСервера.ИмпортируемаяПартияПоИдентификатору(Идентификатор);
		
		Если Не ПустаяСтрока(Результат.ТекстОшибки) Тогда
			
			ЕстьОшибка  = Истина;
			
			Строки = Новый Массив;
			Строки.Добавить(
				Новый ФорматированнаяСтрока(
				НСтр("ru = 'Ошибка:';
					|en = 'Ошибка:'")));
			Строки.Добавить(" ");
			Строки.Добавить(Новый ФорматированнаяСтрока(Результат.ТекстОшибки,, ЦветаСтиля.ЦветТекстаПроблемаГосИС));
			
			ТекстОшибки = Новый ФорматированнаяСтрока(Строки);
			Элементы.ФормаЗагрузить.Доступность = Ложь;
			
		Иначе
			
			ЕстьОшибка  = Ложь;
			ДанныеИмпортируемойПартии = ИнтерфейсСАТУРН.ДанныеИмпортируемойПартии(Результат.Элемент);
			АдресХраненияПараметрыОбмена = ПоместитьВоВременноеХранилище(Результат.ПараметрыОбмена, УникальныйИдентификатор);
			
			ЗаполнитьДанныеИмпортируемойПартии(ДанныеИмпортируемойПартии);
			Элементы.ФормаЗагрузить.Доступность = Истина;
			
			ОпределитьНаличиеВИБ();
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОпределитьНаличиеВИБ()
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ИмпортируемаяПартияСАТУРН.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ИмпортируемаяПартияСАТУРН КАК ИмпортируемаяПартияСАТУРН
	|ГДЕ
	|	ИмпортируемаяПартияСАТУРН.Идентификатор = &Идентификатор";
	
	Запрос.УстановитьПараметр("Идентификатор", Идентификатор);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		ИмпортируемаяПартия = Выборка.Ссылка;
		
		Строки = Новый Массив;
		Строки.Добавить(НСтр("ru = 'Импортируемая партия уже загружена';
							|en = 'Импортируемая партия уже загружена'"));
		Строки.Добавить(" (");
		Строки.Добавить(Новый ФорматированнаяСтрока(НСтр("ru = 'открыть';
														|en = 'открыть'"),, ЦветаСтиля.ЦветГиперссылкиГосИС,, "ОткрытьИмпортируемуюПартию"));
		Строки.Добавить(").");
		
		ИнформацияСостояниеЗагрузки = Новый ФорматированнаяСтрока(Строки);
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	КлассификаторОрганизацийСАТУРН.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.КлассификаторОрганизацийСАТУРН КАК КлассификаторОрганизацийСАТУРН
	|ГДЕ
	|	КлассификаторОрганизацийСАТУРН.Идентификатор = &Идентификатор";
	
	Запрос.УстановитьПараметр("Идентификатор", ИдентификаторОрганизации);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		ОрганизацияСАТУРН = Выборка.Ссылка;
		
	КонецЕсли;
	
	УстановитьОтображениеОрганизации();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	МестаХраненияСАТУРН.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.МестаХраненияСАТУРН КАК МестаХраненияСАТУРН
	|ГДЕ
	|	МестаХраненияСАТУРН.Идентификатор = &Идентификатор";
	
	Запрос.УстановитьПараметр("Идентификатор", ИдентификаторМестаХранения);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		МестоХранения = Выборка.Ссылка;
		
	КонецЕсли;
	
	УстановитьОтображениеМестаХранения();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	КлассификаторСтранСАТУРН.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.КлассификаторСтранСАТУРН КАК КлассификаторСтранСАТУРН
	|ГДЕ
	|	КлассификаторСтранСАТУРН.Идентификатор = &Идентификатор";
	
	Запрос.УстановитьПараметр("Идентификатор", ИдентификаторСтраныЭкспортера);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		Страна = Выборка.Ссылка;
		
	КонецЕсли;
	
	УстановитьОтображениеСтраны();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	КлассификаторТаможенныхПунктовСАТУРН.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.КлассификаторТаможенныхПунктовСАТУРН КАК КлассификаторТаможенныхПунктовСАТУРН
	|ГДЕ
	|	КлассификаторТаможенныхПунктовСАТУРН.Идентификатор = &Идентификатор";
	
	Запрос.УстановитьПараметр("Идентификатор", ИдентификаторТаможенногоПункта);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		ТаможенныйПункт = Выборка.Ссылка;
		
	КонецЕсли;
	
	УстановитьОтображениеТаможенногоПункта();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	КлассификаторТерриториальныхУправленийСАТУРН.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.КлассификаторТерриториальныхУправленийСАТУРН КАК КлассификаторТерриториальныхУправленийСАТУРН
	|ГДЕ
	|	КлассификаторТерриториальныхУправленийСАТУРН.Идентификатор = &Идентификатор";
	
	Запрос.УстановитьПараметр("Идентификатор", ИдентификаторТерриториальногоУправления);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		ТерриториальноеУправление = Выборка.Ссылка;
		
	КонецЕсли;
	
	УстановитьОтображениеТерриториальногоУправления();
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	КлассификаторТранспортныхСредствСАТУРН.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.КлассификаторТранспортныхСредствСАТУРН КАК КлассификаторТранспортныхСредствСАТУРН
	|ГДЕ
	|	КлассификаторТранспортныхСредствСАТУРН.Идентификатор = &Идентификатор";
	
	Запрос.УстановитьПараметр("Идентификатор", ИдентификаторТипаТранспортногоСредстваПеревозчика);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		
		ТранспортноеСредство = Выборка.Ссылка;
		
	КонецЕсли;
	
	УстановитьОтображениеТранспортногоСредства();
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	КлассификаторПАТСАТУРН.Ссылка        КАК Ссылка,
		|	КлассификаторПАТСАТУРН.Идентификатор КАК Идентификатор
		|ИЗ
		|	Справочник.КлассификаторПАТСАТУРН КАК КлассификаторПАТСАТУРН
		|ГДЕ
		|	КлассификаторПАТСАТУРН.Идентификатор В (&Идентификаторы)";
	
	Запрос.УстановитьПараметр("Идентификаторы", ОбщегоНазначения.ВыгрузитьКолонку(Товары, "ИдентификаторПА", Истина));
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		ПараметрыПоиска = Новый Структура("ИдентификаторПА", ВыборкаДетальныеЗаписи.Идентификатор);
		СтрокиТоваров = Товары.НайтиСтроки(ПараметрыПоиска);
		
		Для Каждого СтрокаТоваров Из СтрокиТоваров Цикл
			СтрокаТоваров.ПАТ = ВыборкаДетальныеЗаписи.Ссылка;
		КонецЦикла;
		
	КонецЦикла;
	
	УстановитьОтображениеПАТ();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДанныеИмпортируемойПартии(ДанныеИмпортируемойПартии)
	
	ЗаполнитьЗначенияСвойств(ЭтотОбъект, ДанныеИмпортируемойПартии,, "Товары");
	
	Товары.Очистить();
	
	Для Каждого СтрокаТоваров Из ДанныеИмпортируемойПартии.Товары Цикл
		
		НоваяСтрока = Товары.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаТоваров);
		
		Если Не НоваяСтрока.КоличествоВУпаковкеСАТУРН = 0 Тогда
			НоваяСтрока.КоличествоУпаковок = НоваяСтрока.Количество / НоваяСтрока.КоличествоВУпаковкеСАТУРН;
		КонецЕсли;
		
		НоваяСтрока.ПредставлениеУпаковочнойЕдиницы = СтрокаТоваров.Упаковка.НаименованиеУпаковки;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеОрганизации()
	
	Если ЗначениеЗаполнено(ОрганизацияСАТУРН) Тогда
		
		ОписаниеОрганизации = Новый ФорматированнаяСтрока(
			Строка(ОрганизацияСАТУРН),,,,
			"ОткрытьОрганизацию");
		
	ИначеЕсли ЗначениеЗаполнено(ИдентификаторОрганизации) Тогда
		
		ОписаниеОрганизации = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не загружено>';
				|en = '<не загружено>'"),,
			ЦветаСтиля.ЦветГиперссылкиГосИС,,
			"ЗагрузитьОрганизацию");
		
	Иначе
		
		ОписаниеОрганизации = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не указан>';
				|en = '<не указан>'"),,
			ЦветаСтиля.ЦветТекстаНеТребуетВниманияГосИС);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеМестаХранения()
	
	Если ЗначениеЗаполнено(МестоХранения) Тогда
		
		ОписаниеМестаХранения = Новый ФорматированнаяСтрока(
			Строка(МестоХранения),,,,
			"ОткрытьМестоХранения");
		
	ИначеЕсли ЗначениеЗаполнено(ИдентификаторМестаХранения) Тогда
		
		ОписаниеМестаХранения = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не загружено>';
				|en = '<не загружено>'"),,
			ЦветаСтиля.ЦветГиперссылкиГосИС,,
			"ЗагрузитьМестоХранения");
		
	Иначе
		
		ОписаниеМестаХранения = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не указан>';
				|en = '<не указан>'"),,
			ЦветаСтиля.ЦветТекстаНеТребуетВниманияГосИС);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеСтраны()
	
	Если ЗначениеЗаполнено(Страна) Тогда
		
		ОписаниеСтраны = Новый ФорматированнаяСтрока(
			Строка(Страна),,,,
			"ОткрытьСтрану");
		
	ИначеЕсли ЗначениеЗаполнено(ИдентификаторСтраныЭкспортера) Тогда
		
		ОписаниеСтраны = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не загружено>';
				|en = '<не загружено>'"),,
			ЦветаСтиля.ЦветГиперссылкиГосИС,,
			"ЗагрузитьСтрану");
		
	Иначе
		
		ОписаниеСтраны = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не указан>';
				|en = '<не указан>'"),,
			ЦветаСтиля.ЦветТекстаНеТребуетВниманияГосИС);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеТаможенногоПункта()
	
	Если ЗначениеЗаполнено(ТаможенныйПункт) Тогда
		
		ОписаниеТаможенногоПункта = Новый ФорматированнаяСтрока(
			Строка(ТаможенныйПункт),,,,
			"ОткрытьТаможенныйПункт");
		
	ИначеЕсли ЗначениеЗаполнено(ИдентификаторТаможенногоПункта) Тогда
		
		ОписаниеТаможенногоПункта = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не загружено>';
				|en = '<не загружено>'"),,
			ЦветаСтиля.ЦветГиперссылкиГосИС,,
			"ЗагрузитьТаможенныйПункт");
		
	Иначе
		
		ОписаниеТаможенногоПункта = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не указан>';
				|en = '<не указан>'"),,
			ЦветаСтиля.ЦветТекстаНеТребуетВниманияГосИС);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеТерриториальногоУправления()
	
	Если ЗначениеЗаполнено(ТерриториальноеУправление) Тогда
		
		ОписаниеТерриториальногоУправления = Новый ФорматированнаяСтрока(
			Строка(ТерриториальноеУправление),,,,
			"ОткрытьТерриториальноеУправление");
		
	ИначеЕсли ЗначениеЗаполнено(ИдентификаторТерриториальногоУправления) Тогда
		
		ОписаниеТерриториальногоУправления = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не загружено>';
				|en = '<не загружено>'"),,
			ЦветаСтиля.ЦветГиперссылкиГосИС,,
			"ЗагрузитьТерриториальноеУправление");
		
	Иначе
		
		ОписаниеТерриториальногоУправления = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не указан>';
				|en = '<не указан>'"),,
			ЦветаСтиля.ЦветТекстаНеТребуетВниманияГосИС);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеТранспортногоСредства()
	
	Если ЗначениеЗаполнено(ТранспортноеСредство) Тогда
		
		ОписаниеТипаТранспортногоСредства = Новый ФорматированнаяСтрока(
			Строка(ТранспортноеСредство),,,,
			"ОткрытьТранспортноеСредство");
		
	ИначеЕсли ЗначениеЗаполнено(ИдентификаторТипаТранспортногоСредстваПеревозчика) Тогда
		
		ОписаниеТипаТранспортногоСредства = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не загружено>';
				|en = '<не загружено>'"),,
			ЦветаСтиля.ЦветГиперссылкиГосИС,,
			"ЗагрузитьТранспортноеСредство");
		
	Иначе
		
		ОписаниеТипаТранспортногоСредства = Новый ФорматированнаяСтрока(
			НСтр("ru = '<не указан>';
				|en = '<не указан>'"),,
			ЦветаСтиля.ЦветТекстаНеТребуетВниманияГосИС);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УстановитьОтображениеПАТ(ИдентификаторСтроки = Неопределено)
	
	Если ИдентификаторСтроки = Неопределено Тогда
		МассивСтрок = Товары;
	Иначе
		СтрокаТоваров = Товары.НайтиПоИдентификатору(ИдентификаторСтроки);
		МассивСтрок = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(СтрокаТоваров);
	КонецЕсли;
	
	Для Каждого СтрокаТовары Из МассивСтрок Цикл
		
		Если ЗначениеЗаполнено(СтрокаТовары.ПАТ) Тогда
			
			СтрокаТовары.ПредставлениеПАТ = Строка(СтрокаТовары.ПАТ);
			
		ИначеЕсли ЗначениеЗаполнено(СтрокаТовары.ИдентификаторПА) Тогда
			
			СтрокаТовары.ПредставлениеПАТ = НСтр("ru = '<не загружено>';
												|en = '<не загружено>'");
			
		Иначе
			
			СтрокаТовары.ПредставлениеПАТ = НСтр("ru = '<не указан>';
												|en = '<не указан>'");
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Процедура УправлениеЭлементамиФормы()
	
	Если ЕстьОшибка Тогда
		
		Элементы.СтраницыФормы.ТекущаяСтраница = Элементы.СтраницаОшибка;
		Элементы.ФормаОтмена.Видимость         = Ложь;
		Элементы.ФормаЗакрыть.Видимость        = Истина;
		Элементы.ФормаЗагрузить.Видимость      = Истина;
		
	Иначе

		Элементы.СтраницыФормы.ТекущаяСтраница = Элементы.СтраницаДанныеКлассификатора;
		
		Если ЗначениеЗаполнено(ИмпортируемаяПартия) Тогда
			
			Если НеПоказыватьСостояниеЗагрузки Тогда
				Элементы.ИнформацияСостояниеЗагрузки.Видимость = Ложь;
			КонецЕсли;
			
			Элементы.ФормаОтмена.Видимость    = Ложь;
			Элементы.ФормаЗакрыть.Видимость   = Истина;
			Элементы.ФормаЗагрузить.Видимость = Ложь;
			
		Иначе
			
			Элементы.ИнформацияСостояниеЗагрузки.Видимость = Ложь;
			
			Элементы.ФормаОтмена.Видимость    = Истина;
			Элементы.ФормаЗакрыть.Видимость   = Ложь;
			Элементы.ФормаЗагрузить.Видимость = Истина;
			
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры

#КонецОбласти
