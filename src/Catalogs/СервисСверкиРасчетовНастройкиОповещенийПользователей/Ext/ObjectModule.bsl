
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

Процедура ПередЗаписью(Отказ)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	ДубльНастроек = ДубльНастроек();
	Если ЗначениеЗаполнено(ДубльНастроек) Тогда
		ЗаписьЖурналаРегистрации(СервисСверкиРасчетов.ИмяСервиса(),
			УровеньЖурналаРегистрации.Ошибка, Метаданные(), Ссылка,
			НСтр("ru = 'Для пользователя уже существует настройка оповещений';
				|en = 'A notification setting already exists for the user'"));
		ВызватьИсключение НСтр("ru = 'Для пользователя уже существует настройка оповещений';
								|en = 'A notification setting already exists for the user'");
	КонецЕсли;
	
	Если Организации.Количество() = 0 И ОтборОрганизаций <> 0 Тогда
		ОтборОрганизаций = 0;
	КонецЕсли;
	
	Если Пользователи.Количество() = 0 И ОтборПользователей <> 0 Тогда
		ОтборПользователей = 0;
	КонецЕсли;
	
	Если Контрагенты.Количество() = 0 И ОтборКонтрагентов <> 0 Тогда
		ОтборКонтрагентов = 0;
	КонецЕсли;
	
КонецПроцедуры

Функция ДубльНастроек()
	
	Запрос = Новый Запрос;
	Запрос.Параметры.Вставить("Настройка", Ссылка);
	Запрос.Параметры.Вставить("Пользователь", Пользователь);
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 1
	|	СервисСверкиРасчетовНастройкиОповещенийПользователей.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.СервисСверкиРасчетовНастройкиОповещенийПользователей КАК СервисСверкиРасчетовНастройкиОповещенийПользователей
	|ГДЕ
	|	СервисСверкиРасчетовНастройкиОповещенийПользователей.Пользователь = &Пользователь
	|	И СервисСверкиРасчетовНастройкиОповещенийПользователей.Ссылка <> &Настройка
	|	И СервисСверкиРасчетовНастройкиОповещенийПользователей.ПометкаУдаления = ЛОЖЬ";
	ДублиНастроек = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
	Возврат ДублиНастроек;
	
КонецФункции

#КонецЕсли
