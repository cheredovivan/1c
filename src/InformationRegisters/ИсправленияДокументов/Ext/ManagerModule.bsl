#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Возвращает исправляемый документ (первый документ цепочки) по исправлению
//
//	Параметры:
//		Исправление - ДокументСсылка - Исправление
//	
//	Возвращаемое значение:
//		ДокументСсылка -
//
Функция ИсправляемыйДокумент(Знач Исправление) Экспорт
	
	ИсправляемыйДокумент = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Исправление", Исправление);
	
	Запрос.Текст = 
	
	"ВЫБРАТЬ
	|	ИсправленияДокументов.ИсправляемыйДокумент
	|ИЗ
	|	РегистрСведений.ИсправленияДокументов КАК ИсправленияДокументов
	|ГДЕ
	|	ИсправленияДокументов.Регистратор = &Исправление";
	
	Результат = Запрос.Выполнить();
	
	Если НЕ Результат.Пустой() Тогда
	
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		ИсправляемыйДокумент = Выборка.ИсправляемыйДокумент;	
	КонецЕсли;
	
	Возврат ИсправляемыйДокумент;
	
КонецФункции

// Возвращает исправления документа
//
// Параметры:
//	ИсправляемыйДокумент - ДокументСсылка - Документ, для которого необходимо исправления
//
// Возвращаемое значение:
// 	Массив из ДокументСсылка - Массив исправлений документа.
//
Функция ИсправленияДокумента(Знач ИсправляемыйДокумент) Экспорт
	
	ИсправленияДокумента = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ИсправляемыйДокумент", ИсправляемыйДокумент);

	Запрос.Текст = 
	
	"ВЫБРАТЬ
	|	ИсправленияДокументов.Регистратор
	|ИЗ
	|	РегистрСведений.ИсправленияДокументов КАК ИсправленияДокументов
	|ГДЕ
	|	ИсправленияДокументов.ИсправляемыйДокумент = &ИсправляемыйДокумент
	|";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ИсправленияДокумента.Добавить(Выборка.Регистратор);	
	КонецЦикла;
	
	Возврат ИсправленияДокумента;
	
КонецФункции

// Возвращает исправления документов по типу документа исправления
//
// Параметры:
//	ИсправляемыеДокументы - Массив из ДокументСсылка - документы, для которых необходимы исправления
//	ТипИсправления - Строка - тип документа исправления
//
// Возвращаемое значение:
// 	Массив из ДокументСсылка - Массив исправлений документов.
//
Функция ИсправленияДокументовПоТипуИсправления(Знач ИсправляемыеДокументы, Знач ТипИсправления) Экспорт
	
	ИсправленияДокументов = Новый Массив;
	
	Запрос = Новый Запрос;
	
	Запрос.Текст = 
	
	"ВЫБРАТЬ
	|	ИсправленияДокументов.Регистратор
	|ИЗ
	|	РегистрСведений.ИсправленияДокументов КАК ИсправленияДокументов
	|ГДЕ
	|	ИсправленияДокументов.ИсправляемыйДокумент В (&ИсправляемыеДокументы)";	
	
	ШаблонОтбора = "И ИсправленияДокументов.Регистратор ССЫЛКА %1";
	ТекстОтбора = СтрШаблон(ШаблонОтбора, ТипИсправления);
	
	Запрос.Текст = Запрос.Текст + ТекстОтбора;
	
	Запрос.УстановитьПараметр("ИсправляемыеДокументы", ИсправляемыеДокументы);

	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		
		Пока Выборка.Следующий() Цикл
			ИсправленияДокументов.Добавить(Выборка.Регистратор);	
		КонецЦикла;
	
	КонецЕсли;
	
	Возврат ИсправленияДокументов;
	
КонецФункции

// Функция-конструктор параметров проверки по регистру ИсправленияДокументов.
// 
// Возвращаемое значение:
// 	Структура - Описание:
// * Ссылка - ДокументСсылка, Неопределено - Регистраторы регистра сведений ИсправленияДокументов
// * Дата - Дата
// * ИсправляемыйДокумент - ДокументСсылка, Неопределено - См. ОпределяемыйТип.ИсправляемыеДокументы
//
Функция ПараметрыПроверкиИсправленияДокументов() Экспорт
	
	Параметры = Новый Структура;
	Параметры.Вставить("Ссылка", Неопределено);
	Параметры.Вставить("Дата", Дата(1, 1, 1));
	Параметры.Вставить("ИсправляемыйДокумент", Неопределено);
	
	Возврат Параметры;
	
КонецФункции

// Проверяет изменились ли параметры регистратора относительно хранимых записей в регистре Исправление документов.
//
// Параметры:
//  ПараметрыПроверки - См. ПараметрыПроверкиИсправленияДокументов
// 
// Возвращаемое значение:
//  Булево - Истина - параметры изменильсь, Ложь - нет.
//
Функция ИзменилисьПараметрыИсправленияДокументов(ПараметрыПроверки) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ИсправленияДокументов.Период,
		|	ИсправленияДокументов.ИсправляемыйДокумент
		|ИЗ
		|	РегистрСведений.ИсправленияДокументов КАК ИсправленияДокументов
		|ГДЕ
		|	ИсправленияДокументов.Активность = ИСТИНА
		|	И ИсправленияДокументов.Регистратор = &Регистратор
		|	И ИсправленияДокументов.ИсправляемыйДокумент = &ИсправляемыйДокумент
		|	И ИсправленияДокументов.Период = &Период";
		
	Запрос.УстановитьПараметр("Регистратор", ПараметрыПроверки.Ссылка);
	Запрос.УстановитьПараметр("ИсправляемыйДокумент", ПараметрыПроверки.ИсправляемыйДокумент);
	Запрос.УстановитьПараметр("Период", ПараметрыПроверки.Дата);
	Результат = Запрос.Выполнить().Пустой();
	
	Возврат Результат;
	
КонецФункции

// Возвращает документ-исправление после даты проверяемого документа.
//
// Параметры:
//  ПараметрыПроверки - См. ПараметрыПроверкиИсправленияДокументов
// 
// Возвращаемое значение:
//  ДокументСсылка, Неопределено - Регистраторы регистра РегистрСведений.ИсправляемыеДокументы
//
Функция ИсправлениеПослеДатыДокумента(ПараметрыПроверки) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ИсправлениеПослеДатыДокумента = Неопределено;
	
	// Определим наличие исправлений больше даты документа
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ИсправленияДокументов.Регистратор
		|ИЗ
		|	РегистрСведений.ИсправленияДокументов КАК ИсправленияДокументов
		|ГДЕ
		|	ИсправленияДокументов.ИсправляемыйДокумент = &ИсправляемыйДокумент
		|	И НЕ ИсправленияДокументов.Регистратор = &Ссылка
		|	И ИсправленияДокументов.Период >= &Дата
		|
		|УПОРЯДОЧИТЬ ПО
		|	ИсправленияДокументов.Период УБЫВ";
	
	Запрос.УстановитьПараметр("Ссылка", ПараметрыПроверки.Ссылка);
	Дата = ?(
		Не ЗначениеЗаполнено(ПараметрыПроверки.Ссылка) И ПараметрыПроверки.Дата = НачалоДня(ТекущаяДатаСеанса()),
		ТекущаяДатаСеанса(),
		ПараметрыПроверки.Дата);
	Запрос.УстановитьПараметр("Дата", Дата);
	Запрос.УстановитьПараметр("ИсправляемыйДокумент", ПараметрыПроверки.ИсправляемыйДокумент);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		ИсправлениеПослеДатыДокумента = Выборка.Регистратор;
	КонецЕсли;
	
	Возврат ИсправлениеПослеДатыДокумента;
	
КонецФункции

// Возвращает признак наличия актуальных исправлений документа на дату 
//
// Параметры:
//	ИсправляемыйДокумент - ДокументСсылка - исправляемый документ
//	СторнируемыйДокумент - ДокументСсылка - сторнируемый документ
//	Дата - Дата - Дата проверки
//
// Возвращаемое значение:
// 	Булево - Если Истина - Есть актуальные исправления по сторнируемому документу
//
Функция НаличиеИсправленийНаДатуДокумента(ИсправляемыйДокумент, СторнируемыйДокумент, Дата) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ИсправленияДокументовСрезПоследних.ИсправляемыйДокумент КАК ИсправляемыйДокумент,
		|	ИсправленияДокументовСрезПоследних.ПоследнийДокументЦепочки КАК ПоследнийДокументЦепочки
		|ИЗ
		|	РегистрСведений.ИсправленияДокументов.СрезПоследних(
		|		&Период, ИсправляемыйДокумент = &ИсправляемыйДокумент) КАК ИсправленияДокументовСрезПоследних
		|ГДЕ
		|	НЕ ИсправленияДокументовСрезПоследних.ПоследнийДокументЦепочки = НЕОПРЕДЕЛЕНО
		|	И НЕ ИсправленияДокументовСрезПоследних.ПоследнийДокументЦепочки = &СторнируемыйДокумент
		|	И НЕ ИсправленияДокументовСрезПоследних.ПоследнийДокументЦепочки.Дата < &ДатаСторнируемогоДокумента";
	
	Запрос.УстановитьПараметр("Период", Дата);
	Запрос.УстановитьПараметр("ИсправляемыйДокумент", ИсправляемыйДокумент);
	Запрос.УстановитьПараметр("СторнируемыйДокумент", СторнируемыйДокумент);
	Запрос.УстановитьПараметр("ДатаСторнируемогоДокумента", ОбщегоНазначения.ЗначениеРеквизитаОбъекта(СторнируемыйДокумент, "Дата"));
	
	Возврат Не Запрос.Выполнить().Пустой();
	
КонецФункции

#КонецОбласти

#КонецЕсли