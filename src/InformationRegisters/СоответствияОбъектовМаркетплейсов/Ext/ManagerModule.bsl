
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// Позволяет указать объекты метаданных, для которых задана логика ограничения доступа к данным.
//
// Параметры:
//   Ограничение - см. УправлениеДоступомПереопределяемый.ПриЗаполненииОграниченияДоступа.Ограничение.
//
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт

	Ограничение.Текст =
		"РазрешитьЧтениеИзменение
		|ГДЕ
		|	ЗначениеРазрешено(УчетнаяЗаписьМаркетплейса.Организация, ПустаяСсылка КАК Истина)
		|	И ЗначениеРазрешено(УчетнаяЗаписьМаркетплейса.Партнер, ПустаяСсылка КАК Истина)";
	
КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Определяет объект соответствия.
//
// Параметры:
//   УчетнаяЗапись        - СправочникСсылка.УчетныеЗаписиМаркетплейсов - учетная запись подключения к сервису.
//   ВидОбъекта           - ПеречислениеСсылка.ВидыОбъектовМаркетплейсов - вид объекта маркетплейса.
//   ИдентификаторОбъекта - Строка - идентификатор объекта маркетплейса.
//   ТипОбъекта           - Тип, Неопределено - ограничения по типу объекта.
//
// Возвращаемое значение:
//   Произвольный - объект соответствия.
//
Функция ПолучитьОбъектСоответствия(УчетнаяЗапись, ВидОбъекта, ИдентификаторОбъекта, ТипОбъекта = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ ПЕРВЫЕ 2
		|	СоответствияОбъектовМаркетплейсов.Объект1С КАК Объект1С
		|ИЗ
		|	РегистрСведений.СоответствияОбъектовМаркетплейсов КАК СоответствияОбъектовМаркетплейсов
		|ГДЕ
		|	СоответствияОбъектовМаркетплейсов.УчетнаяЗаписьМаркетплейса = &УчетнаяЗапись
		|	И СоответствияОбъектовМаркетплейсов.ВидОбъектаМаркетплейса = &ВидОбъекта
		|	И СоответствияОбъектовМаркетплейсов.ИдентификаторОбъектаМаркетплейса = &ИдентификаторОбъекта";
	
	Запрос.УстановитьПараметр("УчетнаяЗапись",        УчетнаяЗапись);
	Запрос.УстановитьПараметр("ВидОбъекта",           ВидОбъекта);
	Запрос.УстановитьПараметр("ИдентификаторОбъекта", ИдентификаторОбъекта);
	
	УстановитьПривилегированныйРежим(Истина);
	ВыборкаДанных = Запрос.Выполнить().Выбрать();
	УстановитьПривилегированныйРежим(Ложь);
	
	Пока ВыборкаДанных.Следующий() Цикл
		Если ТипОбъекта = Неопределено Тогда
			Возврат ВыборкаДанных.Объект1С;
		ИначеЕсли ТипЗнч(ВыборкаДанных.Объект1С) = ТипОбъекта Тогда
			Возврат ВыборкаДанных.Объект1С;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

// Записывает объект соответствия.
//
// Параметры:
//   УчетнаяЗапись           - СправочникСсылка.УчетныеЗаписиМаркетплейсов - учетная запись подключения к сервису.
//   ВидОбъекта              - ПеречислениеСсылка.ВидыОбъектовМаркетплейсов - вид объекта маркетплейса.
//   ИдентификаторОбъекта    - Строка - идентификатор объекта маркетплейса.
//   Объект1С                - Произвольный - объект соответствия.
//   ДополнительныеПараметры - Неопределено -
//                           - Структура Из КлючИЗначение - значения прочих измерений и реквизитов регистра сведений 
//                               СоответствияОбъектовМаркетплейсов.
//
Процедура ЗаписатьОбъектСоответствия(УчетнаяЗапись, ВидОбъекта, ИдентификаторОбъекта, Объект1С, 
			ДополнительныеПараметры = Неопределено) Экспорт
	
	НачатьТранзакцию();
	
	Попытка
		Блокировка = Новый БлокировкаДанных();
		ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.СоответствияОбъектовМаркетплейсов");
		ЭлементБлокировки.УстановитьЗначение("УчетнаяЗаписьМаркетплейса",        УчетнаяЗапись);
		ЭлементБлокировки.УстановитьЗначение("ВидОбъектаМаркетплейса",           ВидОбъекта);
		ЭлементБлокировки.УстановитьЗначение("ИдентификаторОбъектаМаркетплейса", ИдентификаторОбъекта);
		Если ДополнительныеПараметры <> Неопределено
				И ДополнительныеПараметры.Свойство("ИдентификаторВладельцаОбъектаМаркетплейса") Тогда
			ЭлементБлокировки.УстановитьЗначение("ИдентификаторВладельцаОбъектаМаркетплейса", 
				ДополнительныеПараметры.ИдентификаторВладельцаОбъектаМаркетплейса);
		КонецЕсли;
		ЭлементБлокировки.УстановитьЗначение("Объект1С", Объект1С);
		Блокировка.Заблокировать();        
		
		НаборЗаписей = СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.УчетнаяЗаписьМаркетплейса.Установить(УчетнаяЗапись);
		НаборЗаписей.Отбор.ВидОбъектаМаркетплейса.Установить(ВидОбъекта);
		НаборЗаписей.Отбор.ИдентификаторОбъектаМаркетплейса.Установить(ИдентификаторОбъекта);
		Если ДополнительныеПараметры <> Неопределено
				И ДополнительныеПараметры.Свойство("ИдентификаторВладельцаОбъектаМаркетплейса") Тогда
			НаборЗаписей.Отбор.ИдентификаторВладельцаОбъектаМаркетплейса.Установить(
				ДополнительныеПараметры.ИдентификаторВладельцаОбъектаМаркетплейса);  
		КонецЕсли;
		НаборЗаписей.Отбор.Объект1С.Установить(Объект1С);
		НаборЗаписей.Прочитать();
		
		Если НаборЗаписей.Количество() = 0 Тогда
			Запись = НаборЗаписей.Добавить();
		Иначе
			Запись = НаборЗаписей[0];
		КонецЕсли;
		
		Если ДополнительныеПараметры <> Неопределено Тогда
			ЗаполнитьЗначенияСвойств(Запись, ДополнительныеПараметры);
		КонецЕсли;
		
		Запись.УчетнаяЗаписьМаркетплейса        = УчетнаяЗапись;
		Запись.ВидОбъектаМаркетплейса           = ВидОбъекта;
		Запись.ИдентификаторОбъектаМаркетплейса = ИдентификаторОбъекта;
		Запись.Объект1С                         = Объект1С;
		Если ДополнительныеПараметры = Неопределено Тогда
			Запись.ДатаАктуальности = ТекущаяДатаСеанса();
		КонецЕсли;
		
		НаборЗаписей.Записать(Истина);
		ЗафиксироватьТранзакцию();
		
	Исключение
		ОтменитьТранзакцию();
		
		ТекстОшибки = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
			НСтр("ru = 'При записи данных соответствия для объекта %1 возникла ошибка: %2';
				|en = 'An error occurred while saving the mapping data for the %1 object: %2'",
				ОбщегоНазначения.КодОсновногоЯзыка()),
			Объект1С,
			ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			
		ЗаписьЖурналаРегистрации(ИнтеграцияСМаркетплейсамиСервер.СобытиеЖурналаРегистрации(),
			УровеньЖурналаРегистрации.Ошибка,,,
			ТекстОшибки);
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
