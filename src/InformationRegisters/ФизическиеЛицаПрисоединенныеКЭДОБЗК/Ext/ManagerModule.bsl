#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область СлужебныйПрограммныйИнтерфейс

#Область ДляВызоваИзДругихПодсистем

// СтандартныеПодсистемы.УправлениеДоступом

// См. УправлениеДоступомПереопределяемый.ПриЗаполненииСписковСОграничениемДоступа.
Процедура ПриЗаполненииОграниченияДоступа(Ограничение) Экспорт
	Ограничение.Текст =
	"РазрешитьЧтениеИзменение
	|ГДЕ
	|	ЗначениеРазрешено(ФизическоеЛицо)";
КонецПроцедуры

// Конец СтандартныеПодсистемы.УправлениеДоступом

#КонецОбласти

// Вычисляет и устанавливает факт подключения сотрудника к ЭДО. Все согласия должны быть подписаны со статусом согласие.
//	Параметры:
//		ФизическиеЛица - Массив Из СправочникСсылка.ФизическиеЛица - сотрудники для которого требуется установить факт подключения к ЭДО.
Процедура УстановитьПодключенКЭДОБЗКДляФизическогоЛица(ФизическиеЛица) Экспорт
	
	Запрос = Новый Запрос();
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	СУММА(ВЫБОР
		|			КОГДА СостояниеСогласияНаПрисоединениеКЭДОБЗК.Состояние <> ЗНАЧЕНИЕ(Перечисление.СостоянияСогласийНаПрисоединениеКЭДОБЗК.Согласие)
		|					ИЛИ СостояниеСогласияНаПрисоединениеКЭДОБЗК.СостояниеПриема = ЗНАЧЕНИЕ(Перечисление.СостоянияПриемаСогласияНаПрисоединениеКЭДОБЗК.ПолученыСканкопии)
		|				ТОГДА 1
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК КоличествоНеподтвержденныхСогласий,
		|	СогласиеНаПрисоединениеКЭДОБЗК.ФизическоеЛицо КАК ФизическоеЛицо,
		|	СУММА(ВЫБОР
		|			КОГДА СостояниеСогласияНаПрисоединениеКЭДОБЗК.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияСогласийНаПрисоединениеКЭДОБЗК.Согласие)
		|					И (СостояниеСогласияНаПрисоединениеКЭДОБЗК.СостояниеПриема = ЗНАЧЕНИЕ(Перечисление.СостоянияПриемаСогласияНаПрисоединениеКЭДОБЗК.Подтверждено)
		|						ИЛИ СостояниеСогласияНаПрисоединениеКЭДОБЗК.СостояниеПриема = ЗНАЧЕНИЕ(Перечисление.СостоянияПриемаСогласияНаПрисоединениеКЭДОБЗК.ОжиданиеОригинала))
		|					И СостояниеСогласияНаПрисоединениеКЭДОБЗК.ДатаОкончания = ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
		|				ТОГДА 1
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК КоличествоПодтвержденныхСогласий
		|ПОМЕСТИТЬ ВТСогласия
		|ИЗ
		|	Документ.СогласиеНаПрисоединениеКЭДОБЗК КАК СогласиеНаПрисоединениеКЭДОБЗК
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостояниеСогласияНаПрисоединениеКЭДОБЗК КАК СостояниеСогласияНаПрисоединениеКЭДОБЗК
		|		ПО (СостояниеСогласияНаПрисоединениеКЭДОБЗК.Ссылка = СогласиеНаПрисоединениеКЭДОБЗК.Ссылка)
		|ГДЕ
		|	СогласиеНаПрисоединениеКЭДОБЗК.Проведен
		|	И СогласиеНаПрисоединениеКЭДОБЗК.ФизическоеЛицо В(&ФизическиеЛица)
		|
		|СГРУППИРОВАТЬ ПО
		|	СогласиеНаПрисоединениеКЭДОБЗК.ФизическоеЛицо
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ФизическиеЛица.Ссылка КАК ФизическоеЛицо,
		|	ЕСТЬNULL(Согласия.КоличествоНеподтвержденныхСогласий, 0) КАК КоличествоНеподтвержденныхСогласий,
		|	ЕСТЬNULL(Согласия.КоличествоПодтвержденныхСогласий, 0) КАК КоличествоПодтвержденныхСогласий
		|ИЗ
		|	Справочник.ФизическиеЛица КАК ФизическиеЛица
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСогласия КАК Согласия
		|		ПО (Согласия.ФизическоеЛицо = ФизическиеЛица.Ссылка)
		|ГДЕ
		|	ФизическиеЛица.Ссылка В(&ФизическиеЛица)";
	
	Запрос.УстановитьПараметр("ФизическиеЛица", ФизическиеЛица);
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	ФизическиеЛицаДляОбновления = Новый Массив;
	Пока Выборка.Следующий() Цикл
		
		МенеджерЗаписи = РегистрыСведений.ФизическиеЛицаПрисоединенныеКЭДОБЗК.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.ФизическоеЛицо = Выборка.ФизическоеЛицо;
		Если Выборка.КоличествоПодтвержденныхСогласий = 0 Тогда
			МенеджерЗаписи.Удалить();
			Продолжить;
		КонецЕсли;
		МенеджерЗаписи.Подключен = (Выборка.КоличествоПодтвержденныхСогласий > 0);
		МенеджерЗаписи.Записать(Истина);
		
		ФизическиеЛицаДляОбновления.Добавить(Выборка.ФизическоеЛицо);
		
	КонецЦикла; 
	
	ИнтеграцияУправлениеПерсоналомСобытия.ЗарегистрироватьОбновлениеДоступныхФункцийФизическогоЛица(ФизическиеЛицаДляОбновления);
	
	УстановитьПривилегированныйРежим(Ложь);
	
КонецПроцедуры

#Область КадровыеДанныеФизическихЛиц

Функция ДобавитьПолеСведенийОПодключенииКЭДОБЗК(ИмяПоля, ТекстыОписанияПолей, ИсточникиДанных) Экспорт
	
	ДобавленоПолеСведений = Ложь;
	Если НеобходимыДанныеОПодключенииКЭДОБЗК(ИмяПоля) Тогда
		
		ДобавленоПолеСведений = Истина;
		ИсточникиДанных.Вставить("ФизическиеЛицаПрисоединенныеКЭДОБЗК", Истина);
		
		ПутьКДанным = ПутьКДаннымСведенийОПодключенииКЭДОБЗК(ИмяПоля);
		ТекстыОписанияПолей.Добавить(ПутьКДанным + " КАК " + ИмяПоля);
		
	КонецЕсли;
	
	Возврат ДобавленоПолеСведений;
	
КонецФункции

Функция НеобходимыДанныеОПодключенииКЭДОБЗК(ИмяПоля) Экспорт
	
	ИмяПоля = ВРег(ИмяПоля);
	Возврат ИмяПоля = ВРег("ПодключенКЭДОБЗК");
	
КонецФункции

Функция ПутьКДаннымСведенийОПодключенииКЭДОБЗК(ИмяПоля)
	
	ИмяПоляВВерхнемРегистре = ВРег(ИмяПоля);
	ПутьКДанным = "";
	
	Если ИмяПоляВВерхнемРегистре = ВРег("ПодключенКЭДОБЗК") Тогда
		ПутьКДанным = "	ФизическиеЛицаПрисоединенныеКЭДОБЗК.Подключен";
	КонецЕсли;
	
	Возврат ПутьКДанным;
	
КонецФункции

Процедура ДобавитьТекстЗапросаВТСведенияОПодключенииКЭДОБЗК(Запрос, ТолькоРазрешенные, ОписательВременнойТаблицыОтборов, ИсточникиДанных) Экспорт
	
	Если ИсточникиДанных.Получить("ФизическиеЛицаПрисоединенныеКЭДОБЗК") = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ЧастиЗапроса = Новый Массив;
	ЧастиЗапроса.Добавить(Запрос.Текст);
	ЧастиЗапроса.Добавить(
		"	{ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФизическиеЛицаПрисоединенныеКЭДОБЗК КАК ФизическиеЛицаПрисоединенныеКЭДОБЗК
		|	ПО " + КадровыйУчет.ПутьКПолюФизическоеЛицо("ТаблицаОтборов", ОписательВременнойТаблицыОтборов.ИмяПоляФизическоеЛицо) + " = ФизическиеЛицаПрисоединенныеКЭДОБЗК.ФизическоеЛицо}");
	
	Запрос.Текст = СтрСоединить(ЧастиЗапроса, Символы.ПС);
	
КонецПроцедуры

#КонецОбласти

Процедура УстановитьПризнакПолученияСогласияЭДОБЗКРанее(ФизическиеЛица, Значение) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	НачатьТранзакцию();
	Для Каждого ФизическоеЛицо Из ФизическиеЛица Цикл
		
		НаборЗаписей = РегистрыСведений.ФизическиеЛицаПрисоединенныеКЭДОБЗК.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.ФизическоеЛицо.Установить(ФизическоеЛицо);
		
		Если Значение = Истина Тогда
			Запись = НаборЗаписей.Добавить();
			Запись.ФизическоеЛицо = ФизическоеЛицо;
			Запись.Подключен = Истина;
			Запись.СогласиеНаЭДОБЗКПолученоРанее = Истина;
		КонецЕсли;
		
		НаборЗаписей.Записать();
		
	КонецЦикла;
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
