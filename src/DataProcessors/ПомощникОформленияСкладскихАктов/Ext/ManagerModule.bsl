#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Получить список товаров к оформлению складских актов
//
// Параметры:
//  Склады				 - Массив Из СправочникСсылка.Склады	 - массив складов
//  ОтборНоменклатуры	 - КомпоновщикНастроекКомпоновкиДанных	 - настройки отбора номенклатуры
//  ДатаНачала			 - Дата									 - дата начала инвентаризации
//  ДатаОкончания		 - Дата									 - дата окончания инвентаризации.
// 
// Возвращаемое значение:
//  ТаблицаЗначений - таблица номенклатуры.
//
Функция ТоварыКОформлениюСкладскихАктов(Знач Склады, 
														Знач ОтборНоменклатуры = Неопределено, 
														Знач ДатаНачала = Неопределено, 
														Знач ДатаОкончания = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	СхемаКомпоновкиДанных = ПолучитьМакет("ОтборНоменклатурыОсновной");
	//++ НЕ УТКА
	ПереопределитьТекстЗапросаМакетаОтборНоменклатурыОсновной(СхемаКомпоновкиДанных);
	//-- НЕ УТКА
	
	Если ОтборНоменклатуры = Неопределено Тогда
		ОтборНоменклатуры = Новый КомпоновщикНастроекКомпоновкиДанных;
		URLСхемы = ПоместитьВоВременноеХранилище(СхемаКомпоновкиДанных, Новый УникальныйИдентификатор());
		ИсточникНастроек = Новый ИсточникДоступныхНастроекКомпоновкиДанных(URLСхемы);
		ОтборНоменклатуры.Инициализировать(ИсточникНастроек);
		ОтборНоменклатуры.ЗагрузитьНастройки(СхемаКомпоновкиДанных.НастройкиПоУмолчанию);
	КонецЕсли;
	УстановитьЗначениеПараметраНастроек(ОтборНоменклатуры.Настройки, "Склад", Склады);
	
	ДатыУказаны = Истина;
	Если ДатаНачала = Неопределено И ДатаОкончания = Неопределено Тогда
		ДатыУказаны = Ложь;	
	КонецЕсли;
	
	Если ДатаНачала = Неопределено Тогда
		ДатаНачала = Дата(1,1,1);
	КонецЕсли;
	
	Период = Дата(1,1,1);
	Если ДатаОкончания = Неопределено Тогда
		ДатаОкончания = Дата(1,1,1);
	Иначе
		Период = Новый Граница(КонецДня(ДатаОкончания));
	КонецЕсли;
	
	Если ДатаОкончания < ДатаНачала Тогда
		ВызватьИсключение НСтр("ru = 'Параметр ""Дата окончания"" меньше параметра ""Даты начала"".';
								|en = 'The ""End date"" parameter is less than the ""Start date"" parameter.'");
	КонецЕсли;
			
	УстановитьЗначениеПараметраНастроек(ОтборНоменклатуры.Настройки, "ДатаНачала", 		ДатаНачала);
	УстановитьЗначениеПараметраНастроек(ОтборНоменклатуры.Настройки, "ДатаОкончания", 	ДатаОкончания);
	УстановитьЗначениеПараметраНастроек(ОтборНоменклатуры.Настройки, "Период", 			Период);
	УстановитьЗначениеПараметраНастроек(ОтборНоменклатуры.Настройки, "ДатыУказаны", 	ДатыУказаны);
	
	СегментыСервер.ВключитьОтборПоСегментуНоменклатурыВСКД(ОтборНоменклатуры);
	
	КомпоновщикМакета = Новый КомпоновщикМакетаКомпоновкиДанных;
	МакетКомпоновки   = КомпоновщикМакета.Выполнить(СхемаКомпоновкиДанных, ОтборНоменклатуры.ПолучитьНастройки(), , ,
		Тип("ГенераторМакетаКомпоновкиДанныхДляКоллекцииЗначений"));
		
	ПроцессорКомпоновкиДанных = Новый ПроцессорКомпоновкиДанных;
	ПроцессорКомпоновкиДанных.Инициализировать(МакетКомпоновки,,, Истина);
	
	ПроцессорВывода = Новый ПроцессорВыводаРезультатаКомпоновкиДанныхВКоллекциюЗначений;
	
	ТаблицаНоменклатуры = ПроцессорВывода.Вывести(ПроцессорКомпоновкиДанных);
	
	УстановитьПривилегированныйРежим(Ложь);
	
	// Если ФО "ИспользоватьХарактеристикиНоменклатуры" или "ИспользоватьСерииНоменклатурыСклад" выключены, то в СКД
	// не будет поля Характеристика или Серия, поэтому в ТаблицаНоменклатуры может не быть этой колонки.
	Если ТаблицаНоменклатуры.Колонки.Найти("ХарактеристикаПриходуемая") = Неопределено Тогда
		ТаблицаНоменклатуры.Колонки.Добавить("ХарактеристикаПриходуемая", 
			Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры"));
	КонецЕсли;
	Если ТаблицаНоменклатуры.Колонки.Найти("ХарактеристикаСписываемая") = Неопределено Тогда
		ТаблицаНоменклатуры.Колонки.Добавить("ХарактеристикаСписываемая", 
			Новый ОписаниеТипов("СправочникСсылка.ХарактеристикиНоменклатуры"));
	КонецЕсли;
	Если ТаблицаНоменклатуры.Колонки.Найти("НазначениеПриходуемое") = Неопределено Тогда
		ТаблицаНоменклатуры.Колонки.Добавить("НазначениеПриходуемое", 
			Новый ОписаниеТипов("СправочникСсылка.Назначения"));
	КонецЕсли;
	Если ТаблицаНоменклатуры.Колонки.Найти("НазначениеСписываемое") = Неопределено Тогда
		ТаблицаНоменклатуры.Колонки.Добавить("НазначениеСписываемое", 
			Новый ОписаниеТипов("СправочникСсылка.Назначения"));
	КонецЕсли;
	Если ТаблицаНоменклатуры.Колонки.Найти("СерияПриходуемая") = Неопределено Тогда
		ТаблицаНоменклатуры.Колонки.Добавить("СерияПриходуемая", Новый ОписаниеТипов("СправочникСсылка.СерииНоменклатуры"));
	КонецЕсли;
	Если ТаблицаНоменклатуры.Колонки.Найти("СерияСписываемая") = Неопределено Тогда
		ТаблицаНоменклатуры.Колонки.Добавить("СерияСписываемая", Новый ОписаниеТипов("СправочникСсылка.СерииНоменклатуры"));
	КонецЕсли;
	
	Возврат ТаблицаНоменклатуры;
	
КонецФункции

// Добавляет команду создания объекта.
//
// Параметры:
//  КомандыСозданияНаОсновании - см. СозданиеНаОснованииПереопределяемый.ПередДобавлениемКомандСозданияНаОсновании.КомандыСозданияНаОсновании
//
// Возвращаемое значение:
//  Неопределено, СтрокаТаблицыЗначений - Добавить команду создать на основании помощник оформления складских актов
Функция ДобавитьКомандуСоздатьНаОснованииПомощникОформленияСкладскихАктов(КомандыСозданияНаОсновании) Экспорт
	Если ПравоДоступа("Просмотр", Метаданные.Обработки.ПомощникОформленияСкладскихАктов) Тогда
		КомандаСоздатьНаОсновании = КомандыСозданияНаОсновании.Добавить();
		КомандаСоздатьНаОсновании.Обработчик = "СозданиеНаОснованииУТКлиент.ПомощникОформленияСкладскихАктов";
		КомандаСоздатьНаОсновании.Идентификатор = "ПомощникОформленияСкладскихАктов";
		КомандаСоздатьНаОсновании.Представление = НСтр("ru = 'Помощник оформления складских актов';
														|en = 'Inventory adjustment wizard'");
		КомандаСоздатьНаОсновании.РежимЗаписи = "Проводить";
		КомандаСоздатьНаОсновании.ФункциональныеОпции = "ИспользоватьОрдернуюСхемуПриОтраженииИзлишковНедостач";
		
		Возврат КомандаСоздатьНаОсновании;
		
	КонецЕсли;
	
	Возврат Неопределено;
КонецФункции

// Устанавливает условное оформление для поля 'ОперацияТекст' табличной части.
//
// Параметры:
//	Форма			- ФормаКлиентскогоПриложения	- форма, содержащая элементы, для установки условного оформления.
//	ИмяПоля			- Строка						- наименование элемента формы табличной части, содержащая сведения об операции.
//														Значение по умолчанию "ТоварыОперацияТекст".
//	ПутьКПолюОтбора - Строка						- полный путь к реквизиту 'ОперацияТекст' табличной части формы.
//														Значение по умолчанию "Объект.Товары.ОперацияТекст".
//
Процедура УстановитьУсловноеОформлениеОперацияТекст(Форма,
													ИмяПоля = "ТоварыОперацияТекст",
													ПутьКПолюОтбора = "Объект.Товары.ОперацияТекст") Экспорт
	
	ЭлементыФормы		= Форма.Элементы;
	УсловноеОформление	= Форма.УсловноеОформление;
	
	ОписанияОпераций = Новый Структура;
	ОписанияОпераций.Вставить("Списание",		НСтр("ru = 'Списание';
														|en = 'Stock shortage'"));
	ОписанияОпераций.Вставить("Оприходование",	НСтр("ru = 'Оприходование';
														|en = 'Stock surplus'"));
	ОписанияОпераций.Вставить("Порча",			НСтр("ru = 'Порча';
														|en = 'Stock quality change'"));
	ОписанияОпераций.Вставить("Пересортица",	НСтр("ru = 'Пересортица';
													|en = 'Stock reclass'"));
	
	Для Каждого ОперацияТекст Из ОписанияОпераций Цикл
		Элемент = УсловноеОформление.Элементы.Добавить();
		
		ПолеЭлемента = Элемент.Поля.Элементы.Добавить();
		ПолеФормыТЧ = ЭлементыФормы[ИмяПоля]; // ПолеФормы
		ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ПолеФормыТЧ.Имя);
		
		ОтборЭлемента = Элемент.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных(ПутьКПолюОтбора);
		ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ОтборЭлемента.ПравоеЗначение = ОперацияТекст.Ключ;
		
		Элемент.Оформление.УстановитьЗначениеПараметра("Текст", ОперацияТекст.Значение);
	КонецЦикла;
	
КонецПроцедуры

//++ НЕ УТКА

// Переопределенный текст запроса набора данных СКД макета обработки.
//
//Параметры:
//	СхемаКомпоновкиДанных - СхемаКомпоновкиДанных - схема компановки данных макета обработки.
//
Процедура ПереопределитьТекстЗапросаМакетаОтборНоменклатурыОсновной(СхемаКомпоновкиДанных) Экспорт
	
	НаборДанных = СхемаКомпоновкиДанных.НаборыДанных.Найти("ЗаполнениеПоОтборам");
	НаборДанных.Запрос =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Сегменты.Номенклатура,
	|	Сегменты.Характеристика,
	|	ИСТИНА КАК ИспользуетсяОтборПоСегментуНоменклатуры
	|ПОМЕСТИТЬ ОтборПоСегментуНоменклатуры
	|ИЗ
	|	РегистрСведений.НоменклатураСегмента КАК Сегменты
	|{ГДЕ
	|	Сегменты.Сегмент.* КАК СегментНоменклатуры,
	|	Сегменты.Номенклатура.* КАК Номенклатура,
	|	Сегменты.Характеристика.* КАК Характеристика}
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	ИспользуетсяОтборПоСегментуНоменклатуры
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ТоварыКОформлениюИзлишковНедостач.Номенклатура,
	|	ТоварыКОформлениюИзлишковНедостач.Характеристика,
	|	ТоварыКОформлениюИзлишковНедостач.Серия,
	|	ТоварыКОформлениюИзлишковНедостач.Назначение
	|ПОМЕСТИТЬ ТоварыСОтклонениями
	|ИЗ
	|	РегистрНакопления.ТоварыКОформлениюИзлишковНедостач КАК ТоварыКОформлениюИзлишковНедостач
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Назначения КАК Назначения
	|		ПО ТоварыКОформлениюИзлишковНедостач.Назначение = Назначения.Ссылка
	|ГДЕ
	|	(ТоварыКОформлениюИзлишковНедостач.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
	|		ИЛИ НЕ &ДатыУказаны)
	|	И ТоварыКОформлениюИзлишковНедостач.Склад В(&Склад)
	|	И (Назначения.Ссылка ЕСТЬ NULL
	|		ИЛИ НЕ (ТИПЗНАЧЕНИЯ(Назначения.Заказ) В(
	//++ Устарело_Переработка24
	|				ТИП(Документ.ЗаказДавальца),
	//-- Устарело_Переработка24
	|				ТИП(Документ.ЗаказДавальца2_5))
	|			И Назначения.Партнер <> ЗНАЧЕНИЕ(Справочник.Партнеры.ПустаяСсылка)))
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Номенклатура КАК Номенклатура,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Номенклатура КАК НоменклатураСписываемая,
	|	NULL КАК НоменклатураПриходуемая,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Характеристика КАК Характеристика,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Характеристика КАК ХарактеристикаСписываемая,
	|	NULL КАК ХарактеристикаПриходуемая,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Назначение КАК Назначение,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Назначение КАК НазначениеСписываемое,
	|	NULL КАК НазначениеПриходуемое,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Серия КАК СерияСписываемая,
	|	NULL КАК СерияПриходуемая,
	|	-ТоварыКОформлениюИзлишковНедостачОстатки.КОформлениюАктовОстаток КАК Количество,
	|	-ТоварыКОформлениюИзлишковНедостачОстатки.КОформлениюАктовОстаток КАК КоличествоНеРаспределено,
	|	0 КАК КоличествоРаспределено,
	|	ИСТИНА КАК НеРаспределено,
	|	ЛОЖЬ КАК Распределено,
	|	""Списание"" КАК ОперацияТекст,
	|	ИСТИНА КАК ОперацияСписание,
	|	ЛОЖЬ КАК ОперацияОприходование,
	|	ЕСТЬNULL(СтавкиНДСНоменклатуры.СтавкаНДС, ЕСТЬNULL(ОсновныеСтавкиНДС.СтавкаНДС, ЗНАЧЕНИЕ(Справочник.СтавкиНДС.ПустаяСсылка))) КАК СтавкаНДС
	|ИЗ
	|	РегистрНакопления.ТоварыКОформлениюИзлишковНедостач.Остатки(
	|			&Период,
	|			Склад В (&Склад)
	|				И (Номенклатура, Характеристика, Серия, Назначение) В
	|					(ВЫБРАТЬ
	|						ТоварыСОтклонениями.Номенклатура,
	|						ТоварыСОтклонениями.Характеристика,
	|						ТоварыСОтклонениями.Серия,
	|						ТоварыСОтклонениями.Назначение
	|					ИЗ
	|						ТоварыСОтклонениями КАК ТоварыСОтклонениями) {((Номенклатура, Характеристика) В
	|				(ВЫБРАТЬ
	|					ОтборПоСегментуНоменклатуры.Номенклатура,
	|					ОтборПоСегментуНоменклатуры.Характеристика
	|				ИЗ
	|					ОтборПоСегментуНоменклатуры
	|				ГДЕ
	|					ОтборПоСегментуНоменклатуры.ИспользуетсяОтборПоСегментуНоменклатуры = &ИспользуетсяОтборПоСегментуНоменклатуры)), (Номенклатура).* КАК Номенклатура}) КАК ТоварыКОформлениюИзлишковНедостачОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиНДСНоменклатуры.СрезПоследних(&Период, Страна = &СтранаСтавокНДС) КАК СтавкиНДСНоменклатуры
	|		ПО ТоварыКОформлениюИзлишковНедостачОстатки.Номенклатура = СтавкиНДСНоменклатуры.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОсновныеСтавкиНДС.СрезПоследних(&Период, Страна = &СтранаСтавокНДС) КАК ОсновныеСтавкиНДС
	|		ПО ИСТИНА
	|
	|ГДЕ
	|	ТоварыКОформлениюИзлишковНедостачОстатки.КОформлениюАктовОстаток < 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Номенклатура,
	|	NULL,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Номенклатура,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Характеристика,
	|	NULL,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Характеристика,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Назначение,
	|	NULL,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Назначение,
	|	NULL,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.Серия,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.КОформлениюАктовОстаток,
	|	ТоварыКОформлениюИзлишковНедостачОстатки.КОформлениюАктовОстаток,
	|	0,
	|	ИСТИНА,
	|	ЛОЖЬ,
	|	""Оприходование"",
	|	ЛОЖЬ,
	|	ИСТИНА,
	|	ЕСТЬNULL(СтавкиНДСНоменклатуры.СтавкаНДС, ЕСТЬNULL(ОсновныеСтавкиНДС.СтавкаНДС, ЗНАЧЕНИЕ(Справочник.СтавкиНДС.ПустаяСсылка)))
	|ИЗ
	|	РегистрНакопления.ТоварыКОформлениюИзлишковНедостач.Остатки(
	|			&Период,
	|			Склад В (&Склад)
	|				И (Номенклатура, Характеристика, Серия, Назначение) В
	|					(ВЫБРАТЬ
	|						ТоварыСОтклонениями.Номенклатура,
	|						ТоварыСОтклонениями.Характеристика,
	|						ТоварыСОтклонениями.Серия,
	|						ТоварыСОтклонениями.Назначение
	|					ИЗ
	|						ТоварыСОтклонениями КАК ТоварыСОтклонениями) {((Номенклатура, Характеристика) В
	|				(ВЫБРАТЬ
	|					ОтборПоСегментуНоменклатуры.Номенклатура,
	|					ОтборПоСегментуНоменклатуры.Характеристика
	|				ИЗ
	|					ОтборПоСегментуНоменклатуры
	|				ГДЕ
	|					ОтборПоСегментуНоменклатуры.ИспользуетсяОтборПоСегментуНоменклатуры = &ИспользуетсяОтборПоСегментуНоменклатуры)), (Номенклатура).* КАК Номенклатура}) КАК ТоварыКОформлениюИзлишковНедостачОстатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиНДСНоменклатуры.СрезПоследних(&Период, Страна = &СтранаСтавокНДС) КАК СтавкиНДСНоменклатуры
	|		ПО ТоварыКОформлениюИзлишковНедостачОстатки.Номенклатура = СтавкиНДСНоменклатуры.Номенклатура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОсновныеСтавкиНДС.СрезПоследних(&Период, Страна = &СтранаСтавокНДС) КАК ОсновныеСтавкиНДС
	|		ПО ИСТИНА
	|		
	|ГДЕ
	|	ТоварыКОформлениюИзлишковНедостачОстатки.КОформлениюАктовОстаток > 0";
	
КонецПроцедуры

//-- НЕ УТКА

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура УстановитьЗначениеПараметраНастроек(Настройки, ИмяПараметра, Значение)
	
	Параметр = Настройки.ПараметрыДанных.Элементы.Найти(ИмяПараметра);
	
	Если Параметр <> Неопределено Тогда
		Параметр.Значение = Значение;
		Параметр.Использование = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
