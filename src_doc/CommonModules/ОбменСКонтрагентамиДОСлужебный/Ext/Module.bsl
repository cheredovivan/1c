
#Область ПрограммныйИнтерфейс


// Находит ссылку на справочник по переданному реквизиту.
//
// Параметры:
//  ИмяСправочника - Строка - Имя справочника, объект которого надо найти.
//  ИмяРеквизита - Строка - Имя реквизита, по которому будет проведен поиск.
//  ЗначРеквизита - Произвольный - значение реквизита, по которому будет проведен поиск.
//  Результат - СправочникСсылка - Ссылка на найденный объект.
//  Владелец - СправочникСсылка - Ссылка на владельца для поиска в иерархическом справочнике.
//  ТолькоНеПомеченные - Булево - Исключить из поиска помеченные на удаление.
//
Процедура НайтиСсылкуНаОбъектПоРеквизиту(
	ИмяСправочника, 
	ИмяРеквизита, 
	ЗначРеквизита, 
	Результат, 
	Владелец = Неопределено,
	ТолькоНеПомеченные = Ложь) Экспорт
	
	Результат = Неопределено;
	
	ОбъектМетаданных = Метаданные.Справочники[ИмяСправочника];
	Если НЕ ОбщегоНазначения.ЭтоСтандартныйРеквизит(ОбъектМетаданных.СтандартныеРеквизиты, ИмяРеквизита)
		И НЕ ОбъектМетаданных.Реквизиты.Найти(ИмяРеквизита) <> Неопределено Тогда
		
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ИскСправочник.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник." + ИмяСправочника + " КАК ИскСправочник
		|ГДЕ
		|	ИскСправочник." + ИмяРеквизита + " = &ЗначРеквизита";
	
	Если ЗначениеЗаполнено(Владелец) Тогда
		Запрос.Текст = Запрос.Текст + " И ИскСправочник.Владелец = &Владелец";
		Запрос.УстановитьПараметр("Владелец", Владелец);
	КонецЕсли;
	
	Если ТолькоНеПомеченные Тогда
		Запрос.Текст = Запрос.Текст + " И ИскСправочник.ПометкаУдаления = Ложь";
	КонецЕсли;
	
	Запрос.УстановитьПараметр("ЗначРеквизита", ЗначРеквизита);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Результат = Выборка.Ссылка;
	КонецЕсли;
	
КонецПроцедуры

// Выполняет поиск контактного лица контрагента по данным сертификата ЭП, при отсутствии добавляет новое.
//
Функция НайтиДобавитьКонтактноеЛицоИзСертификата(Контрагент, Сертификат) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	КонтактноеЛицо = Справочники.КонтактныеЛица.ПустаяСсылка();
	
	Если Не ЗначениеЗаполнено(Сертификат) Тогда
		Возврат КонтактноеЛицо;
	КонецЕсли;
	
	Если ТипЗнч(Сертификат) = Тип("ХранилищеЗначения") Тогда
		ДвоичныеДанныеСертификата = Сертификат.Получить();
	Иначе
		ДвоичныеДанныеСертификата = Сертификат;
	КонецЕсли;
	
	Субъект = ЭлектроннаяПодписьКлиентСервер.СвойстваСубъектаСертификата(
		Новый СертификатКриптографии(ДвоичныеДанныеСертификата));
		
	Если Не Субъект.Свойство("ОбщееИмя") Тогда
		Возврат КонтактноеЛицо;		
	КонецЕсли;
	
	ФИОКонтактногоЛица = Новый Массив;
	Если ЗначениеЗаполнено(Субъект.Фамилия) Тогда
		ФИОКонтактногоЛица.Добавить(Субъект.Фамилия);
	КонецЕсли;
	Если ЗначениеЗаполнено(Субъект.Имя) Тогда
		ФИОКонтактногоЛица.Добавить(Субъект.Имя);
		
		Если ЗначениеЗаполнено(Субъект.Отчество) Тогда
			ФИОКонтактногоЛица.Добавить(Субъект.Отчество);
		КонецЕсли;	
	КонецЕсли;
	Если Не ФИОКонтактногоЛица.Количество() Тогда
		ФИОКонтактногоЛица.Добавить(Субъект.ОбщееИмя);
	КонецЕсли;
	НаименованиеКонтактногоЛица = СтрСоединить(ФИОКонтактногоЛица, " ");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	КонтактныеЛица.Ссылка КАК КонтактноеЛицо
		|ИЗ
		|	Справочник.КонтактныеЛица КАК КонтактныеЛица
		|ГДЕ
		|	КонтактныеЛица.Владелец = &Владелец
		|	И НЕ КонтактныеЛица.ПометкаУдаления
		|	И КонтактныеЛица.Наименование = &Наименование";
		
	Запрос.УстановитьПараметр("Владелец", Контрагент);
	Запрос.УстановитьПараметр("Наименование", НаименованиеКонтактногоЛица);
		
	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		
		// Добавляем новое контактное лицо
		НачатьТранзакцию();
		Попытка
			КонтактноеЛицо = Справочники.КонтактныеЛица.СоздатьЭлемент();
			КонтактноеЛицо.Владелец = Контрагент;
			КонтактноеЛицо.Наименование = НаименованиеКонтактногоЛица;
			Если Субъект.Свойство("Должность") Тогда
				КонтактноеЛицо.Должность = Справочники.ДолжностиКонтактныхЛиц.НайтиСоздатьДолжность(Субъект.Должность);
			КонецЕсли;
			КонтактноеЛицо.Комментарий = НСтр("ru = 'Создан при загрузке ЭД.'");
			КонтактноеЛицо.ОбменДанными.Загрузка = Истина;
			КонтактноеЛицо.Записать();
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			ВызватьИсключение;
		КонецПопытки;
		КонтактноеЛицо = КонтактноеЛицо.Ссылка;
	Иначе
		
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		
		КонтактноеЛицо = Выборка.КонтактноеЛицо; 
		
	КонецЕсли;
			
	Возврат КонтактноеЛицо;
	
КонецФункции

// Выполняется при получении описания основания электронного документа,
// которое используется для представления данных прикладного объекта в подсистеме.
//
// Параметры:
//  ОснованиеОбъект - ОпределяемыйТип.ОснованияЭлектронныхДокументов - объект или ссылка на основание электронного документа.
//  Описание - Структура - данные, описывающие основание электронного документа:
//   * Вид - Строка - представление вида объекта. По умолчанию синоним объекта метаданных.
//   * Организация - ОпределяемыйТип.Организация - организация основания.
//   * Контрагент - ОпределяемыйТип.КонтрагентБЭД - контрагент основания.
//   * Дата - Дата - дата основания.
//   * Номер - Строка - номер основания.
//   * СуммаДокумента - Число - сумма основания.
//  СтандартнаяОбработка - Булево - признак формирования описания по умолчанию. 
//                                  Если Ложь, то используются данные из параметра Описание. По умолчанию Истина.
//
Процедура ПолучитьОписаниеОснованияЭлектронногоДокумента(Знач ОснованиеОбъект, Описание, СтандартнаяОбработка) Экспорт
	
	Если Не ДелопроизводствоКлиентСервер.ЭтоДокумент(ОснованиеОбъект) 
			И Не ТипЗнч(ОснованиеОбъект) = Тип("СправочникОбъект.ВерсииФайлов") Тогда
			
		Возврат;
	КонецЕсли;
	
	СтандартнаяОбработка = Ложь;
	
	Если ТипЗнч(ОснованиеОбъект) = Тип("СправочникОбъект.ВерсииФайлов") Тогда 
		ВладелецОбъекта =  ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ОснованиеОбъект.Владелец, "ВладелецФайла");
		ОснованиеОбъект = ВладелецОбъекта.ПолучитьОбъект();
	КонецЕсли;
	
	Описание.Вид = СтрШаблон(НСтр("ru = '%1'"), ОснованиеОбъект.ВидДокумента);
	Описание.Контрагент = ОснованиеОбъект.Контрагент;
	Описание.СуммаДокумента = ОснованиеОбъект.Сумма;
	Описание.Дата = 
		?(ЗначениеЗаполнено(ОснованиеОбъект.ДатаРегистрации), ОснованиеОбъект.ДатаРегистрации, ОснованиеОбъект.ДатаСоздания);
	Описание.Номер = 
		?(ЗначениеЗаполнено(ОснованиеОбъект.РегистрационныйНомер), ОснованиеОбъект.РегистрационныйНомер, ОснованиеОбъект.Код);
	
	Если ПолучитьФункциональнуюОпцию("ИспользоватьУчетПоОрганизациям") Тогда
		Описание.Организация = ОснованиеОбъект.Организация;
	Иначе
		Описание.Организация = Справочники.Организации.ОрганизацияПоУмолчанию();
	КонецЕсли;
	
КонецПроцедуры

// Возврат признака физического лица.
//
// Параметры:
//  ДанныеКонтрагента - СправочникСсылка - ссылка на элемент справочника.
//  ПризнакФизЛица - Булево - Истина если физическое лицо.
//
Процедура ЭтоФизЛицо(ДанныеКонтрагента, ПризнакФизЛица) Экспорт
		
	ЮрФизЛицо = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДанныеКонтрагента, "ЮрФизЛицо");
	Если ЮрФизЛицо = Перечисления.ЮрФизЛицо.ФизЛицо
		Или ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель Тогда
		
		ПризнакФизЛица = Истина;
	КонецЕсли;

КонецПроцедуры

// Возвращает, возможно ли корректировка данного вида ЭД непосредственно, т.е. без создания отдельного документа.
//
// Параметры:
//  ВидДокумента - СправочникСсылка.ВидыДокуметовЭДО - Вид документа, для которого необходимо выполнить проверку.
//
Функция ВидДокументаКорректируетсяНепосредственно(ВидДокумента) Экспорт
	
	МассивТиповДокументов = Новый Массив;
	
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ЗаказТовара);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.КаталогТоваров);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ОтветНаЗаказ);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ПрайсЛист);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.СчетНаОплату);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ОтчетОПродажахКомиссионногоТовара);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ОтчетОСписанииКомиссионногоТовара);
	
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.АктВзаимозачета);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.АктСверки);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.Ведомость);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ГарантийноеПисьмо);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.Договор);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ДополнительноеСоглашение);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.КС11);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.КС2);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.КС3);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.Отчет);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ПлатежноеПоручение);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.ПриложениеКАкту);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.СоглашениеОбЭДО);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.Спецификация);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.Уведомление);
	МассивТиповДокументов.Добавить(Перечисления.ТипыДокументовЭДО.Прочее);
	
	ТипДокументаВида = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ВидДокумента, "ТипДокумента");
	
	Возврат (МассивТиповДокументов.Найти(ТипДокументаВида) <> Неопределено);
	
КонецФункции

// Возвращает массив видов документов для которых доступна отправка по ЭДО
// 
// Возвращаемое значение:
//   Массив из Справочкик.ВидыДокументов - Массив видов документов,
//                                                   для которых доступна отправка по ЭДО
Функция ВидыДокументовДляОтправкиПоЭДО() Экспорт
	
	Запрос = Новый Запрос;
	
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ВидыДокументов.Ссылка КАК ВидДокумента
		|ИЗ
		|	Справочник.ВидыДокументов КАК ВидыДокументов
		|ГДЕ
		|	НЕ ВидыДокументов.ПометкаУдаления
		|	И ВидыДокументов.ВестиУчетСторон";
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("ВидДокумента");
	
КонецФункции

#Область ДанныеДокументовПоЭДО

// Возвращает состояние документа 1С:Документоборот в ЭДО.
//
// Параметры:
//  Документ - ОпределяемыйТип.ДокументДОДляЭДО - Документ, для которого необходимо получить сведения о состоянии.
//  Дата - Дата - Дата, на которую необходимо получить сведения.
//  Контрагент - СправочникСсылка.Контрагенты - Контрагент, для которого необходимо получить сведения.
// 
// Возвращаемое значение:
//  см. РегистрыСведений.СостояниеДокументовПоЭДО.ПолучитьСостояниеДокумента
//
Функция СостояниеДокумента(Документ, Дата = Неопределено, Контрагент = Неопределено) Экспорт

	Возврат РегистрыСведений.СостояниеДокументовПоЭДО.ПолучитьСостояниеДокумента(Документ, Дата, Контрагент);

КонецФункции 

// Новые данные состояния для установки.
// 
// Возвращаемое значение:
//  см. РегистрыСведений.СостояниеДокументовПоЭДО.НовыеДанныеСостоянияДляДобавления
Функция НовыеДанныеСостоянияДляУстановки() Экспорт
	
	Возврат РегистрыСведений.СостояниеДокументовПоЭДО.НовыеДанныеСостоянияДляДобавления();
	
КонецФункции

// Устанавливает состояние документа документооборота по ЭДО
// 
// Параметры:
//  Документ - ОпределяемыйТип.ДокументДОДляЭДО - Документ для которого необходимо установить состояние
//  Контрагент - СправочникСсылка.Контрагенты - Контрагент для которого необходимо установить состояние
//  ДанныеСостояния - см. НовыеДанныеСостоянияДляУстановки
Процедура УстановитьСостояниеДокументаЭДО(Документ, Контрагент, ДанныеСостояния) Экспорт
	
	РегистрыСведений.СостояниеДокументовПоЭДО.Добавить(Документ, Контрагент, ДанныеСостояния);
	
КонецПроцедуры

// Возвращает параметры документа по ЭДО
// 
// Параметры:
//   ДокументДО - ОпределяемыйТип.ДокументДОДляЭДО - Документ, для которого необходимо выяснить состояния по ЭДО
// 
// Возвращаемое значение:
//  Неопределено, Структура - Параметры документа по ЭДО, если документ не может учавствовать в обмене ЭДО,
//                            тогда Неопределено:
//    * ДоступнаКорректировкаЭД - Булево - Доступна ли для вида документа непосредственная корректировка
//    * СостояниеДО - ПеречислениеСсылка.СостоянияЭДОДокументооборот - Состояние документа ДО по ЭДО
//    * Подписан - Булево - Подписан ли документ
//    * ТребуетсяПодтверждение - Булево - Требуется ли ответная подпись по документу
//    * Состояние - ПеречислениеСсылка.СостоянияДокументовЭДО - Состояние электронного документа, если он есть
//    * ТипДокументаЭДО - ПеречислениеСсылка.ТипыДокументовЭДО - Тип документа ЭДО
//    * ВидДокументаЭДО - СправочникСсылка.ВидыДокументовЭДО - Вид документа ЭДО
//    * Направление - ПеречислениеСсылка.НаправленияЭДО - Направление обмена ЭДО
//    * ЭлектронныйДокумент - ДокументСсылка.ЭлектронныйДокументВходящийЭДО - Документ ЭДО входящий
//                          - ДокументСсылка.ЭлектронныйДокументИсходящийЭДО - Документ ЭДО исходящий
//    * ЕстьЭД - Булево - Есть ли с документом связанный документ ЭДО
//    * ДокументВПакетеЭДО - Булево - Состоит ли документ в пакете по ЭДО
//    * ПакетЭДО - УникальныйИдентификатор, Неопределено - УИД пакета ЭДО, если документ состоит в пакете,
//                                                         Неопределено, если документ в пакете не состоит
//    * ДоступноИзменениеПакетаЭДО - Булево - Доступно ли изменение состава пакета ЭДО.
//    * ПакетЭДОНеОтражен - Булево - Истина, если во входящем пакете не по всем документам ЭДО созданы документы ДО
//    * ДоступныДействияПоДокументу - Булево - Доступны ли действия по одиночному документу.
//                                             Для исходящих документов доступны одиночные действия только вне пакета.
//                                             Для входящих - зависит от оператора ЭДО контрагента.
//    * ПоддерживаетсяПакетнаОбработка - Булево - Поддерживается ли пакетная обработка по данному документу.
//    * УчетнаяЗаписьЭДО - Строка - Идентификатор учетной записи ЭДО
//
Функция ПараметрыДокументаПоЭДО(ДокументДО) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("ЕстьЭД", Ложь);
	СтруктураВозврата.Вставить("ЭлектронныйДокумент", Неопределено);
	СтруктураВозврата.Вставить("Направление", Перечисления.НаправленияЭДО.ПустаяСсылка());
	СтруктураВозврата.Вставить("ВидДокументаЭДО", Справочники.ВидыДокументовЭДО.ПустаяСсылка());
	СтруктураВозврата.Вставить("ТипДокументаЭДО", Перечисления.ТипыДокументовЭДО.ПустаяСсылка());
	СтруктураВозврата.Вставить("Состояние", Перечисления.СостоянияДокументовЭДО.ПустаяСсылка());
	СтруктураВозврата.Вставить("ТребуетсяПодтверждение", Истина);
	СтруктураВозврата.Вставить("Подписан", Ложь);
	СтруктураВозврата.Вставить("СостояниеДО", Перечисления.СостоянияЭДОДокументооборот.НеСформирован);
	СтруктураВозврата.Вставить("ДоступнаКорректировкаЭД", Ложь);
	СтруктураВозврата.Вставить("ДокументВПакетеЭДО", Ложь);
	СтруктураВозврата.Вставить("ПакетЭДО", Неопределено);
	СтруктураВозврата.Вставить("ДоступноИзменениеПакетаЭДО", Ложь);
	СтруктураВозврата.Вставить("ДоступныДействияПоДокументу", Истина);
	СтруктураВозврата.Вставить("ПакетЭДОНеОтражен", Ложь);
	СтруктураВозврата.Вставить("ПоддерживаетсяПакетнаОбработка", Истина);
	СтруктураВозврата.Вставить("УчетнаяЗаписьЭДО", "");
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	Файлы.Ссылка КАК Файл,
		|	Файлы.ТекущаяВерсия КАК ТекущаяВерсия
		|ПОМЕСТИТЬ ФайлыДокумента
		|ИЗ
		|	Справочник.Файлы КАК Файлы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СлужебныеФайлыДокументов КАК СлужебныеФайлыДокументов
		|		ПО (СлужебныеФайлыДокументов.Файл = Файлы.Ссылка)
		|ГДЕ
		|	Файлы.ВладелецФайла = &Документ
		|	И СлужебныеФайлыДокументов.Файл ЕСТЬ NULL
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ФайлыДокумента.Файл КАК Файл,
		|	ФайлыДокумента.ТекущаяВерсия КАК ТекущаяВерсия,
		|	ВидыДокументовЭДО.ТипДокумента КАК ТипДокумента,
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент.ВидДокумента КАК ВидЭлектронногоДокумента,
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент КАК ЭлектронныйДокумент,
		|	СостоянияДокументовЭДО.Состояние КАК Состояние,
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент.ТребуетсяПодтверждение КАК ТребуетсяПодтверждение,
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент.СпособОбмена КАК СпособОбмена,
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент.ИдентификаторОрганизации КАК УчетнаяЗаписьЭДО
		|ИЗ
		|	РегистрСведений.ОбъектыУчетаДокументовЭДО КАК ОбъектыУчетаДокументовЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ФайлыДокумента КАК ФайлыДокумента
		|		ПО ФайлыДокумента.ТекущаяВерсия = ОбъектыУчетаДокументовЭДО.ОбъектУчета
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыДокументовЭДО КАК ВидыДокументовЭДО
		|		ПО ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент.ВидДокумента = ВидыДокументовЭДО.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияДокументовЭДО КАК СостоянияДокументовЭДО
		|		ПО ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент = СостоянияДокументовЭДО.ЭлектронныйДокумент
		|ГДЕ
		|	ОбъектыУчетаДокументовЭДО.Актуальный
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СостояниеДокументовПоЭДОСрезПоследних.СостояниеВерсииДокументаПоЭДО КАК СостояниеДОПоЭДО
		|ИЗ
		|	РегистрСведений.СостояниеДокументовПоЭДО.СрезПоследних КАК СостояниеДокументовПоЭДОСрезПоследних
		|ГДЕ
		|	СостояниеДокументовПоЭДОСрезПоследних.ДокументДО = &Документ";
	Запрос.УстановитьПараметр("Документ", ДокументДО);
	
	МассивРезультатов = Запрос.ВыполнитьПакет();
	
	РезультатПоСвязаннымДокументамЭДО = МассивРезультатов[1];
	ВыборкаСостоянийДО = МассивРезультатов[2].Выбрать();
	
	Если Не РезультатПоСвязаннымДокументамЭДО.Пустой() Тогда
		Выборка = РезультатПоСвязаннымДокументамЭДО.Выбрать();
		Выборка.Следующий();
		
		СтруктураВозврата.ЕстьЭД = Истина;
		СтруктураВозврата.ЭлектронныйДокумент = Выборка.ЭлектронныйДокумент;
		СтруктураВозврата.Направление = 
			?(ТипЗнч(Выборка.ЭлектронныйДокумент) = Тип("ДокументСсылка.ЭлектронныйДокументВходящийЭДО"),
				Перечисления.НаправленияЭДО.Входящий,
				Перечисления.НаправленияЭДО.Исходящий);
		СтруктураВозврата.ВидДокументаЭДО = Выборка.ВидЭлектронногоДокумента;
		СтруктураВозврата.ТипДокументаЭДО = Выборка.ТипДокумента;
		СтруктураВозврата.Состояние = Выборка.Состояние;
		СтруктураВозврата.ТребуетсяПодтверждение = Выборка.ТребуетсяПодтверждение;
		СтруктураВозврата.ДоступнаКорректировкаЭД =
			ВидДокументаКорректируетсяНепосредственно(Выборка.ВидЭлектронногоДокумента);
		СтруктураВозврата.УчетнаяЗаписьЭДО = Выборка.УчетнаяЗаписьЭДО;
		
		Если ВыборкаСостоянийДО.Следующий() Тогда
			СостояниеДО = ВыборкаСостоянийДО.СостояниеДОПоЭДО;
			
			СтруктураВозврата.СостояниеДО = СостояниеДО;
			СтруктураВозврата.Подписан = Истина;
		КонецЕсли;
		
		ПакетЭДО = ПакетДокумента(ДокументДО);
		
		СтруктураВозврата.ПоддерживаетсяПакетнаОбработка =
			СпособОбменаПоддерживаетПакетнуюОбработку(Выборка.СпособОбмена);
		
		Если ПакетЭДО = Неопределено Тогда
			СтруктураВозврата.ДокументВПакетеЭДО = Ложь;
			СтруктураВозврата.ДоступныДействияПоДокументу = Истина;
		Иначе
			СтруктураВозврата.ДокументВПакетеЭДО = Истина;
			СтруктураВозврата.ПакетЭДО = ПакетЭДО;
			
			ДанныеПакетаЭДО = ДанныеПакетаДокументов(ПакетЭДО);
			
			СтруктураВозврата.ДоступноИзменениеПакетаЭДО = 
				Не ЗначениеЗаполнено(ДанныеПакетаЭДО.ИдентификаторПакетаБЭД)
				И ДанныеПакетаЭДО.Направление = Перечисления.НаправленияЭДО.Исходящий;
			
			Если ДанныеПакетаЭДО.Направление = Перечисления.НаправленияЭДО.Входящий Тогда
				СтруктураВозврата.ДоступныДействияПоДокументу = СинхронизацияЭДО.ТребуетсяОднородностьОтвета(
					ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
						СтруктураВозврата.ЭлектронныйДокумент, "ИдентификаторКонтрагента"));
			Иначе
				СтруктураВозврата.ДоступныДействияПоДокументу = Ложь;
			КонецЕсли;
			
			ЕстьНеотраженныеДокументы = (ДанныеНеотраженныхДокументовЭДОПакета(ПакетЭДО).Количество() > 0);
			СтруктураВозврата.ПакетЭДОНеОтражен = ЕстьНеотраженныеДокументы;
			
		КонецЕсли;
		
		Возврат СтруктураВозврата;
		
	КонецЕсли;
	
	РеквизитыДокумента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументДО,
		"Организация, Контрагент, ВидДокумента, ФормаДокумента");
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьУчетПоОрганизациям") Тогда
		РеквизитыДокумента.Организация = Справочники.Организации.ОрганизацияПоУмолчанию();
	КонецЕсли;
	
	НастройкиОтправки = РегистрыСведений.НастройкиОтправкиДокументовПоЭДО.НастройкиОтправкиВидаДокумента(
		РеквизитыДокумента.Организация,
		РеквизитыДокумента.Контрагент,
		РеквизитыДокумента.ВидДокумента);
	
	Если НастройкиОтправки <> Неопределено 
		И РеквизитыДокумента.ФормаДокумента <> Перечисления.ВариантыФормДокументов.Бумажная Тогда

		СтруктураВозврата.ЕстьЭД = Ложь;
		СтруктураВозврата.ЭлектронныйДокумент = Неопределено;
		СтруктураВозврата.Направление = Перечисления.НаправленияЭДО.Исходящий;
		СтруктураВозврата.ВидДокументаЭДО = НастройкиОтправки.ВидДокументаЭДО;
		СтруктураВозврата.ТипДокументаЭДО = НастройкиОтправки.ТипДокумента;
		СтруктураВозврата.Состояние = Перечисления.СостоянияДокументовЭДО.НеСформирован;
		СтруктураВозврата.ТребуетсяПодтверждение = НастройкиОтправки.ТребуетсяОтветнаяПодпись;
		СтруктураВозврата.ДоступнаКорректировкаЭД =
			ВидДокументаКорректируетсяНепосредственно(НастройкиОтправки.ВидДокументаЭДО);
		
		Если ВыборкаСостоянийДО.Следующий() Тогда
			
			СостояниеДО = ВыборкаСостоянийДО.СостояниеДОПоЭДО;
			
			СтруктураВозврата.СостояниеДО = СостояниеДО;
			СтруктураВозврата.Подписан =
				Не (СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.НеСформирован
					Или СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.ЗакрытПринудительно);
			
		Иначе
			
			СтруктураВозврата.СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.НеСформирован;
			СтруктураВозврата.Подписан = Ложь;
			
		КонецЕсли;
		
		СпособыОбмена = СпособыОбменаЭДОПоДокументамДО(
			ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ДокументДО));
		
		СтруктураВозврата.ПоддерживаетсяПакетнаОбработка =
			СпособОбменаПоддерживаетПакетнуюОбработку(СпособыОбмена[ДокументДО]);
		
		ПакетЭДО = ПакетДокумента(ДокументДО);
		
		Если ПакетЭДО = Неопределено Тогда
			СтруктураВозврата.ДокументВПакетеЭДО = Ложь;
			СтруктураВозврата.ДоступныДействияПоДокументу = Истина;
		Иначе
			СтруктураВозврата.ДокументВПакетеЭДО = Истина;
			СтруктураВозврата.ПакетЭДО = ПакетЭДО;
			
			ДанныеПакетаЭДО = ДанныеПакетаДокументов(ПакетЭДО);
			
			СтруктураВозврата.ДоступноИзменениеПакетаЭДО = 
				Не ЗначениеЗаполнено(ДанныеПакетаЭДО.ИдентификаторПакетаБЭД)
				И ДанныеПакетаЭДО.Направление = Перечисления.НаправленияЭДО.Исходящий;
			СтруктураВозврата.ДоступныДействияПоДокументу = Ложь;
		КонецЕсли;
		
		Возврат СтруктураВозврата;
		
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

#КонецОбласти

#Область СведенияОЭДИзФайла

// Сведения о формализованном электронном документе из файла
// 
// Параметры:
//  АдресВременногоХранилищаФайла - Строка - Адрес во временном хранилище на двоичные данные файла
// 
// Возвращаемое значение:
//  Структура, Неопределено - Неопределено, если файл не является формализованным. В ином случае:
// * ДатаДокумента - Дата - Дата документа
// * НомерДокумента - Строка - Номер документа
// * СуммаДокумента - Число - Сумма документа
// * ИмяСоздания - Строка - Имя для создания файла формата <Вид документа> №<Номер> от <Дата>
// * Валюта - СправочникСсылка.Валюты - Валюта документа
// * ТипДокументаЭДО - ПеречислениеСсылка.ТипыДокументовЭДО - Тип документа ЭДО
// * ВидДокументаЭДО - СправочникСсылка.ВидыДокументовЭДО - Вид документа ЭДО
Функция СведенияОЭДИзФайла(АдресВременногоХранилищаФайла) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("ДатаДокумента", Неопределено);
	СтруктураВозврата.Вставить("НомерДокумента", "");
	СтруктураВозврата.Вставить("СуммаДокумента", "");
	СтруктураВозврата.Вставить("ИмяСоздания", "");
	СтруктураВозврата.Вставить("Валюта", Справочники.Валюты.ПустаяСсылка());
	СтруктураВозврата.Вставить("ТипДокументаЭДО", Перечисления.ТипыДокументовЭДО.ПустаяСсылка());
	СтруктураВозврата.Вставить("ВидДокументаЭДО", Справочники.ВидыДокументовЭДО.ПустаяСсылка());
	СтруктураВозврата.Вставить("ИдентификаторДокумента", "");
	
	ОбщиеСведения = КонвертацияЭДО.ПараметрыФайлаПроизвольногоДокумента(
		ПолучитьИзВременногоХранилища(АдресВременногоХранилищаФайла));
	
	Если ОбщиеСведения = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(СтруктураВозврата, ОбщиеСведения);
	
	Попытка
		ДанныеЭДФайла = ОбменСКонтрагентами.ДанныеЭлектронногоДокументаПоФайлу(
			ПолучитьИзВременногоХранилища(АдресВременногоХранилищаФайла));
	Исключение
		Возврат Неопределено;
	КонецПопытки;
	
	Если ТипЗнч(ДанныеЭДФайла) <> Тип("Структура") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТипДокумента = ДанныеЭДФайла.НовыйЭД.ВидЭД;
	
	СтруктураВозврата.ТипДокументаЭДО = ТипДокумента;
	СтруктураВозврата.ВидДокументаЭДО = ЭлектронныеДокументыЭДО.ВидДокументаПоТипу(ТипДокумента);
	
	СтруктураВозврата.ИмяСоздания = СтрШаблон(НСтр("ru = '%1 №%2 от %3'"),
		ТипДокумента,
		ОбщиеСведения.НомерДокумента,
		Формат(ОбщиеСведения.ДатаДокумента, "ДФ=dd.MM.yyyy"));
	
	Форматы = ЭлектронныеДокументыЭДО.ПоддерживаемыеФорматы();
	
	Если ДанныеЭДФайла.НовыйЭД.ВерсияФормата = Форматы.CML208
		ИЛИ ДанныеЭДФайла.НовыйЭД.ВерсияФормата = Форматы.CML402 Тогда
		
		СведенияОЭД = СведенияОЭДФорматаCML(ДанныеЭДФайла);
		
	Иначе
		
		СведенияОЭД = СведенияОЭДФорматаФНС(ДанныеЭДФайла);
		
	КонецЕсли;
	
	ЗаполнитьЗначенияСвойств(СтруктураВозврата, СведенияОЭД);
	
	Возврат СтруктураВозврата;
	
КонецФункции

#КонецОбласти

#Область ФормированиеПредставленияДокумента

Функция ЗапуститьФормированиеПредставленияДанныхЭДО(ДанныеДляПредставления, ИдентификаторФормы) Экспорт
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияФункции(ИдентификаторФормы);
	
	Возврат ДлительныеОперации.ВыполнитьФункцию(ПараметрыВыполнения,
		"ОбменСКонтрагентамиДОСлужебный.ПредставлениеДанныхЭДО",
		ДанныеДляПредставления);
	
КонецФункции

Функция ПредставлениеДанныхЭДО(ДанныеДляПредставления) Экспорт
	
	Файл = Неопределено;
	ВерсияФайла = Неопределено;
	ПараметрыВизуализации = Неопределено;
	
	ДанныеДляПредставления.Свойство("Файл", Файл);
	ДанныеДляПредставления.Свойство("ВерсияФайла", ВерсияФайла);
	ДанныеДляПредставления.Свойство("ПараметрыВизуализации", ПараметрыВизуализации);
	
	Если ЗначениеЗаполнено(Файл) И ЗначениеЗаполнено(ВерсияФайла) Тогда
		
		Возврат ПредставлениеДанныхПоФайлу(Файл, ВерсияФайла, ПараметрыВизуализации);
		
	ИначеЕсли ЗначениеЗаполнено(Файл) Тогда
		
		ВерсияФайла = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Файл, "ТекущаяВерсия");
		
		Возврат ПредставлениеДанныхПоФайлу(Файл, ВерсияФайла, ПараметрыВизуализации);
		
	ИначеЕсли ЗначениеЗаполнено(ВерсияФайла) Тогда
		
		Файл = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ВерсияФайла, "Владелец");
		
		Возврат ПредставлениеДанныхПоФайлу(Файл, ВерсияФайла, ПараметрыВизуализации);
		
	КонецЕсли;
	
	Документ = Неопределено;
	
	ДанныеДляПредставления.Свойство("Документ", Документ);
	
	Если ЗначениеЗаполнено(Документ) Тогда
		
		Возврат ПредставлениеДанныхПоДокументу(Документ, ПараметрыВизуализации);
		
	КонецЕсли;
	
	ДокументЭДО = Неопределено;
	
	ДанныеДляПредставления.Свойство("ДокументЭДО", ДокументЭДО);
	
	Если ЗначениеЗаполнено(ДокументЭДО) Тогда
		
		Возврат ПредставлениеДанныхПоДокументуЭДО(ДокументЭДО, ПараметрыВизуализации);
		
	КонецЕсли;
	
	Результат = НовыйРезультатПредставленияЭДО();
	Результат.Успех = Ложь;
	Результат.ОписаниеОшибки =
		НСтр("ru = 'Не переданы параметры представления данных ЭДО.'");
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область ИнтерфейсЭДО

Функция ДоступныКомандыПоДокументуЭДОИзИнтерфейсаБЭД(ДокументЭДО) Экспорт
	
	Если ТипЗнч(ДокументЭДО) = Тип("ДокументСсылка.ЭлектронныйДокументВходящийЭДО") Тогда
		
		ДокументыДО = ДокументыДОЭлектронныхДокументов(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ДокументЭДО));
		
		ЕстьДокументДО = (ДокументыДО[ДокументЭДО] <> Неопределено);
		
		ДокументТребуетОтражения = РегистрыСведений.ДокументыЭДОКСозданиюВДО.ДокументЭДОТребуетОтраженияВДО(
			ДокументЭДО);
		
		Если ЕстьДокументДО Или ДокументТребуетОтражения Тогда
			Возврат Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Истина;
	
КонецФункции

#КонецОбласти

#Область СпискиДокументовЭДО

#Область ДокументыИсходящие

Функция ИсходящиеДокументыЭДО(Знач Отбор = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапросаИсходящихДокументовЭДО();
	
	УстановитьПараметрыЗапросаИсходящих(Запрос, Отбор);
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции

Функция ЗапуститьПолучениеДанныхИсходящих(ДанныеВыделенных, ИдентификаторФормы) Экспорт
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияФункции(ИдентификаторФормы);
	
	Возврат ДлительныеОперации.ВыполнитьФункцию(ПараметрыВыполнения,
		"ОбменСКонтрагентамиДОСлужебный.ДанныеВыделенныхИсходящихДокументов",
		ДанныеВыделенных);
	
КонецФункции

// Данные выделенных исходящих документов
// 
// Параметры:
//  ДанныеВыделенныхСтрок - Массив Из Структура:
//    * Документ - ОпределяемыйТип.ДокументДОДляЭДО
//    * ИдентификаторПакета - УникальныйИдентификатор
// 
// Возвращаемое значение:
//  Структура - Данные выделенных объектов:
//    * Пакеты - Массив Из УникальныйИдентификатор - Идентификаторы пакетов документов
//    * ОдиночныеДокументы - Массив Из ОпределяемыйТип.ДокументДОДляЭДО - Документы вне пакетов
//    * ДеревоФайлов - ДеревоЗначений - Дерево файлов выделенных объектов:
//      ** ИдентификаторПакета - УникальныйИдентификатор
//      ** Документ - ОпределяемыйТип.ДокументДОДляЭДО
//      ** Файл - Структура:
//        *** Файл - СправочникСсылка.Файлы
//        *** Расширение - Строка
//      ** ПодписанЭП - Булево
//      ** ИндексКартинкиЭП - Число
//      ** ПредставлениеЭлемента - Строка
//      ** ИндексКартинкиФайла - Число
//    * Организации - Массив Из СправочникСсылка.Организации
//    * Контрагенты - Массив Из СправочникСсылка.Контрагенты
//    * ДоступныеДействия - Соответствие Из КлючИЗначение:
//      ** Ключ - Строка - Действие, см. ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ДействияСпискаИсходящихДокументов
//      ** Значение - Булево - Истина, если 
//
Функция ДанныеВыделенныхИсходящихДокументов(ДанныеВыделенныхСтрок) Экспорт
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Пакеты", Новый Массив);
	СтруктураВозврата.Вставить("ОдиночныеДокументы", Новый Массив);
	СтруктураВозврата.Вставить("ДеревоФайлов", Новый ДеревоЗначений);
	СтруктураВозврата.Вставить("Организации", Новый Массив);
	СтруктураВозврата.Вставить("Контрагенты", Новый Массив);
	СтруктураВозврата.Вставить("ДоступныеДействия", Новый Соответствие);
	
	ДанныеОбъектов = ДанныеВыделенныхОбъектов(ДанныеВыделенныхСтрок);
	
	СтруктураВозврата.ДеревоФайлов = ДеревоФайловПоДаннымОбъектов(ДанныеОбъектов);
	
	Для Каждого Элемент Из ДанныеОбъектов.Пакеты Цикл
		СтруктураВозврата.Пакеты.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Для Каждого Элемент Из ДанныеОбъектов.Документы Цикл
		СтруктураВозврата.ОдиночныеДокументы.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	ОрганизацииИКонтрагенты = ОрганизацииИКонтрагентыВыбранныхДанныхОбъектов(ДанныеОбъектов);
	
	ЗаполнитьЗначенияСвойств(СтруктураВозврата, ОрганизацииИКонтрагенты);
	
	ДоступныеДействия = ДоступныеДействияПоВыделеннымИсходящимОбъектам(
		ДанныеОбъектов,
		ОрганизацииИКонтрагенты.Организации,
		ОрганизацииИКонтрагенты.Контрагенты);
	
	СтруктураВозврата.ДоступныеДействия = ДоступныеДействия;
	
	Возврат СтруктураВозврата;
	
КонецФункции

#КонецОбласти

#Область ДокументыВходящие

// Запускает получение данных выбранного входящего документа ЭДО в списке.
// 
// Параметры:
//  ДокументЭДО - ДокументСсылка.ЭлектронныйДокументВходящийЭДО - Документ ЭДО, по которому необходимо получить данные
//  ИдентификаторФормы - УникальныйИдентификатор - УИД формы из которой запущено получение данных
// 
// Возвращаемое значение:
//  см. ДлительныеОперации.ВыполнитьФункцию
Функция ЗапуститьПолучениеДанныхВыбранногоВходящего(ДокументЭДО, ИдентификаторФормы) Экспорт
	
	ПараметрыВыполнения = ДлительныеОперации.ПараметрыВыполненияФункции(ИдентификаторФормы);
	
	Возврат ДлительныеОперации.ВыполнитьФункцию(ПараметрыВыполнения,
		"ОбменСКонтрагентамиДОСлужебный.ДанныеВыбранногоВходящегоДокумента",
		ДокументЭДО);
	
КонецФункции

// Данные входящего документа ЭДО для формы списка.
// 
// Параметры:
//  ДокументЭДО - ДокументСсылка.ЭлектронныйДокументВходящийЭДО
// 
// Возвращаемое значение:
//  см. НовыеДанныеВыделенногоВходящегоЭДО
Функция ДанныеВыбранногоВходящегоДокумента(ДокументЭДО) Экспорт
	
	Возврат ДанныеВыделенногоВходящегоДокумента(ДокументЭДО);
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область ПакетыЭДО

// Возвращает пакеты документов Документооборота
// 
// Параметры:
//  ДокументыДО - Массив Из ОпределяемыйТип.ДокументДОДляЭДО
// 
// Возвращаемое значение:
//  Соответствие Из КлючИЗначение:
//    * Ключ - ОпределяемыйТип.ДокументДОДляЭДО
//    * Значение - УникальныйИдентификатор - Идентификатор пакета документа.
//                                           Если документ не состоит в пакете - вернет пустой уникальный идентификатор.
//
Функция ПакетыДокументов(ДокументыДО) Экспорт
	
	ПакетыДокументов = Новый Соответствие();
	Для Каждого Документ Из ДокументыДО Цикл
		ПакетыДокументов[Документ] = УникальныйИдентификаторПустой();
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	СоставПакетовЭДОДокументооборот.Документ КАК Документ,
		|	СоставПакетовЭДОДокументооборот.ИдентификаторПакета КАК ИдентификаторПакета
		|ИЗ
		|	РегистрСведений.СоставПакетовЭДОДокументооборот КАК СоставПакетовЭДОДокументооборот
		|ГДЕ
		|	СоставПакетовЭДОДокументооборот.Документ В (&Документы)";
	Запрос.УстановитьПараметр("Документы", ДокументыДО);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		ПакетыДокументов[Выборка.Документ] = Выборка.ИдентификаторПакета;
	КонецЦикла;
	
	Возврат ПакетыДокументов;
	
КонецФункции

// Устарела. Следует использовать ПакетыДокументов
//  Возвращает ИД пакета ЭДО к которому принадлежит документ ДО.
//  Если документ не состоит в пакете, то возвращается Неопределено
// 
// Параметры:
// 	Документ - ОпределяемыйТип.ДокументДОДляЭДО - Документ ДО
// Возвращаемое значение:
// 	УникальныйИдентификатор, Неопределено - УИД пакета, либо Неопределено, если документ не состоит в пакете ЭДО
Функция ПакетДокумента(Документ) Экспорт
	
	ДокументыДО = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Документ);
	ИдентификаторыПакетов = ПакетыДокументов(ДокументыДО);
	
	Если ЗначениеЗаполнено(ИдентификаторыПакетов[Документ]) Тогда
		Возврат ИдентификаторыПакетов[Документ];
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// Возвращает данные пакета ЭДО документов ДО
// 
// Параметры:
// 	ИдентификаторПакета - УникальныйИдентификатор - УИД пакета ЭДО
// Возвращаемое значение:
// 	Структура - Данные пакета:
// * ИдентификаторПакета - Неопределено, УникальныйИдентификатор - УИД пакета, если пакет существует,
//                                                                 Неопределено, если пакета ЭДО не существует
// * Организация - СправочникСсылка.Организации - Организация пакета
// * Контрагент - СправочникСсылка.Контрагенты - Контрагент пакета
// * Направление - ПеречислениеСсылка.НаправленияЭДО - Направление пакета
// * ИдентификаторПакетаБЭД - Неопределено, УникальныйИдентификатор -
//                                          Идентификартор пакета документо БЭД, если он существует
//                                          Неопределено, если пакет документов БЭД еще не создан
// * Документы - Массив из ОпределяемыйТип.ДокументДОДляЭДО - Массив документов, входящих в пакет
Функция ДанныеПакетаДокументов(ИдентификаторПакета) Экспорт
	
	СтруктураВозврата = Новый Структура;
	
	СтруктураВозврата.Вставить("ИдентификаторПакета", Неопределено);
	СтруктураВозврата.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	СтруктураВозврата.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
	СтруктураВозврата.Вставить("Направление", Перечисления.НаправленияЭДО.ПустаяСсылка());
	СтруктураВозврата.Вставить("ИдентификаторПакетаБЭД", Неопределено);
	СтруктураВозврата.Вставить("Документы", Новый Массив);
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ПакетыЭДОДокументооборот.ИдентификаторПакета,
		|	ПакетыЭДОДокументооборот.Организация,
		|	ПакетыЭДОДокументооборот.Контрагент,
		|	ПакетыЭДОДокументооборот.Направление,
		|	ПакетыЭДОДокументооборот.ИдентификаторПакетаБЭД,
		|	СоставПакетовЭДОДокументооборот.Документ
		|ИЗ
		|	РегистрСведений.ПакетыЭДОДокументооборот КАК ПакетыЭДОДокументооборот
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СоставПакетовЭДОДокументооборот КАК СоставПакетовЭДОДокументооборот
		|		ПО СоставПакетовЭДОДокументооборот.ИдентификаторПакета = ПакетыЭДОДокументооборот.ИдентификаторПакета
		|ГДЕ
		|	ПакетыЭДОДокументооборот.ИдентификаторПакета = &ИдентификаторПакета";
	Запрос.УстановитьПараметр("ИдентификаторПакета", ИдентификаторПакета);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Не Выборка.Следующий() Тогда
		Возврат СтруктураВозврата;
	КонецЕсли;
	
	СтруктураВозврата.ИдентификаторПакета = Выборка.ИдентификаторПакета;
	СтруктураВозврата.Организация = Выборка.Организация;
	СтруктураВозврата.Контрагент = Выборка.Контрагент;
	СтруктураВозврата.Направление = Выборка.Направление;
	СтруктураВозврата.ИдентификаторПакетаБЭД = Выборка.ИдентификаторПакетаБЭД;
	СтруктураВозврата.Документы.Добавить(Выборка.Документ);
	
	Пока Выборка.Следующий() Цикл
		СтруктураВозврата.Документы.Добавить(Выборка.Документ);
	КонецЦикла;
	
	Возврат СтруктураВозврата;
	
КонецФункции

// Данные документов для добавления их в пакет
// 
// Параметры:
// 	Документы - Массив из ОпределяемыйТип.ДокументДОДляЭДО
// Возвращаемое значение:
// 	Структура - Данные документов:
// * Организации - Массив из СправочникСсылка.Организации - Организации документов
// * Контрагенты - Массив из СправочникСсылка.Контрагенты - Контрагенты документов
// * Направления - Массив из ПеречислениеСсылка.НаправленияЭДО - Направления документов по ЭДО
// * Состояния - Массив из ПеречислениеСсылка.СостоянияЭДОДокументооборот - Состояния документов по ЭДО
// * ИдентификаторыПакетов - Массив из УникальныйИдентификатор - УИДы пакетов ЭДО в которых уже учавствуют документы
Функция ДанныеДокументовДляДобавленияВПакет(Документы) Экспорт
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Организации", Новый Массив);
	СтруктураВозврата.Вставить("Контрагенты", Новый Массив);
	СтруктураВозврата.Вставить("Направления", Новый Массив);
	СтруктураВозврата.Вставить("Состояния", Новый Массив);
	СтруктураВозврата.Вставить("ИдентификаторыПакетов", Новый Массив);
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	СостояниеДокументовПоЭДОСрезПоследних.ДокументДО КАК Документ,
		|	СостояниеДокументовПоЭДОСрезПоследних.СостояниеВерсииДокументаПоЭДО КАК Состояние,
		|	СостояниеДокументовПоЭДОСрезПоследних.НаправлениеЭД КАК Направление,
		|	ДокументыДО.Организация,
		|	ДокументыДО.Контрагент,
		|	ЕСТЬNULL(СоставПакетовЭДОДокументооборот.ИдентификаторПакета, НЕОПРЕДЕЛЕНО) КАК ИдентификаторПакета
		|ИЗ
		|	РегистрСведений.СостояниеДокументовПоЭДО.СрезПоследних(, ДокументДО В (&Документы)) КАК
		|		СостояниеДокументовПоЭДОСрезПоследних
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|		ПО СостояниеДокументовПоЭДОСрезПоследних.ДокументДО = ДокументыДО.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоставПакетовЭДОДокументооборот КАК СоставПакетовЭДОДокументооборот
		|		ПО СостояниеДокументовПоЭДОСрезПоследних.ДокументДО = СоставПакетовЭДОДокументооборот.Документ";
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"%ИмяСправочникаДокументаДО%",
		ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ИмяСправочникаДокументовДО());
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Документы", Документы);
	
	УникальныеОрганизации = Новый Соответствие;
	УникальныеКонтрагенты = Новый Соответствие;
	УникальныеНаправления = Новый Соответствие;
	УникальныеСостояния = Новый Соответствие;
	УникальныеУИДПакетов = Новый Соответствие;
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Если УникальныеОрганизации[Выборка.Организация] = Неопределено Тогда
			УникальныеОрганизации.Вставить(Выборка.Организация, Истина);
		КонецЕсли;
		
		Если УникальныеКонтрагенты[Выборка.Контрагент] = Неопределено Тогда
			УникальныеКонтрагенты.Вставить(Выборка.Контрагент, Истина);
		КонецЕсли;
		
		Если УникальныеНаправления[Выборка.Направление] = Неопределено Тогда
			УникальныеНаправления.Вставить(Выборка.Направление, Истина);
		КонецЕсли;
		
		Если УникальныеСостояния[Выборка.Состояние] = Неопределено Тогда
			УникальныеСостояния.Вставить(Выборка.Состояние, Истина);
		КонецЕсли;
		
		Если ЗначениеЗаполнено(Выборка.ИдентификаторПакета)
			И УникальныеУИДПакетов[Выборка.ИдентификаторПакета] = Неопределено Тогда
			
			УникальныеУИДПакетов.Вставить(Выборка.ИдентификаторПакета, Истина);
		КонецЕсли;
		
	КонецЦикла;
	
	Для Каждого Элемент Из УникальныеОрганизации Цикл
		СтруктураВозврата.Организации.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Для Каждого Элемент Из УникальныеКонтрагенты Цикл
		СтруктураВозврата.Контрагенты.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Для Каждого Элемент Из УникальныеНаправления Цикл
		СтруктураВозврата.Направления.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Для Каждого Элемент Из УникальныеСостояния Цикл
		СтруктураВозврата.Состояния.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Для Каждого Элемент Из УникальныеУИДПакетов Цикл
		СтруктураВозврата.ИдентификаторыПакетов.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Возврат СтруктураВозврата;
	
КонецФункции

// Определяет, поддерживает ли способ обмена ЭДО пакетную обработку документов
// 
// Параметры:
//  СпособОбмена - ПеречислениеСсылка.СпособыОбменаЭД - Способ обмена ЭДО
// 
// Возвращаемое значение:
//  Булево - Поддерживает ли способ обмена пакетную обработку документов.
Функция СпособОбменаПоддерживаетПакетнуюОбработку(СпособОбмена) Экспорт
	
	Возврат (СпособОбмена = Перечисления.СпособыОбменаЭД.ЧерезСервис1СЭДО);
	
КонецФункции

Функция ДанныеНеотраженныхДокументовЭДОПакета(ИдентификаторПакетаЭДО) Экспорт
	
	НеотраженныеДокументыЭДО = Новый Соответствие;
	
	Если Не ЗначениеЗаполнено(ИдентификаторПакетаЭДО) Тогда
		Возврат НеотраженныеДокументыЭДО;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	СоставПакетовДокументовЭДО.ЭлектронныйДокумент,
		|	ЭлектронныйДокументВходящийЭДО.ВидДокумента,
		|	ЭлектронныйДокументВходящийЭДО.ДатаДокумента КАК Дата,
		|	ЭлектронныйДокументВходящийЭДО.НомерДокумента КАК Номер
		|ИЗ
		|	РегистрСведений.СоставПакетовДокументовЭДО КАК СоставПакетовДокументовЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПакетыЭДОДокументооборот КАК ПакетыЭДОДокументооборот
		|		ПО СоставПакетовДокументовЭДО.ИдентификаторПакета = ПакетыЭДОДокументооборот.ИдентификаторПакетаБЭД
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОбъектыУчетаДокументовЭДО КАК ОбъектыУчетаДокументовЭДО
		|		ПО СоставПакетовДокументовЭДО.ЭлектронныйДокумент = ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент
		|		И ОбъектыУчетаДокументовЭДО.Актуальный
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументВходящийЭДО КАК ЭлектронныйДокументВходящийЭДО
		|		ПО СоставПакетовДокументовЭДО.ЭлектронныйДокумент = ЭлектронныйДокументВходящийЭДО.Ссылка
		|ГДЕ
		|	ПакетыЭДОДокументооборот.ИдентификаторПакета = &ИдентификаторПакета
		|	И ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент ЕСТЬ NULL";
	Запрос.УстановитьПараметр("ИдентификаторПакета", ИдентификаторПакетаЭДО);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ДанныеДокументаЭДО = Новый Структура;
		ДанныеДокументаЭДО.Вставить("ВидДокумента", Выборка.ВидДокумента);
		ДанныеДокументаЭДО.Вставить("Номер", Выборка.Номер);
		ДанныеДокументаЭДО.Вставить("Дата", Выборка.Дата);
		
		НеотраженныеДокументыЭДО.Вставить(Выборка.ЭлектронныйДокумент, ДанныеДокументаЭДО);
	КонецЦикла;
	
	Возврат НеотраженныеДокументыЭДО;
	
КонецФункции

// Состояния документов пакетов ЭДО.
// 
// Параметры:
//  ИдентификаторыПакетов - Массив Из УникальныйИдентификатор
// 
// Возвращаемое значение:
//  Соответствие Из КлючИЗначение:
//    * Ключ - УникальныйИдентификатор - Идентификатор пакета
//    * Значение - Соответствие из КлючИЗначение:
//      ** Ключ - ОпределяемыйТип.ДокументДОДляЭДО
//      ** Значение - ПеречислениеСсылка.СостоянияЭДОДокументооборот
//
Функция СостоянияДокументовПакетовЭДО(ИдентификаторыПакетов) Экспорт
	
	ДокументыПакетов = Новый Соответствие();
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	СоставПакетовЭДОДокументооборот.ИдентификаторПакета КАК ИдентификаторПакета,
		|	СоставПакетовЭДОДокументооборот.Документ КАК Документ,
		|	ЕСТЬNULL(СостояниеДокументовПоЭДОСрезПоследних.СостояниеВерсииДокументаПоЭДО,
		|		ЗНАЧЕНИЕ(Перечисление.СостоянияЭДОДокументооборот.ПустаяСсылка)) КАК Состояние
		|ИЗ
		|	РегистрСведений.СоставПакетовЭДОДокументооборот КАК СоставПакетовЭДОДокументооборот
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостояниеДокументовПоЭДО.СрезПоследних КАК СостояниеДокументовПоЭДОСрезПоследних
		|		ПО СостояниеДокументовПоЭДОСрезПоследних.ДокументДО = СоставПакетовЭДОДокументооборот.Документ
		|ГДЕ
		|	СоставПакетовЭДОДокументооборот.ИдентификаторПакета В (&ИдентификаторыПакетов)";
	Запрос.УстановитьПараметр("ИдентификаторыПакетов", ИдентификаторыПакетов);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		ДанныеПакета = ДокументыПакетов.Получить(Выборка.ИдентификаторПакета);
		Если ДанныеПакета = Неопределено Тогда
			ДанныеПакета = Новый Соответствие();
			ДокументыПакетов.Вставить(Выборка.ИдентификаторПакета, ДанныеПакета);
		КонецЕсли;
		
		ДанныеПакета.Вставить(Выборка.Документ, Выборка.Состояние);
		
	КонецЦикла;
	
	Возврат ДокументыПакетов;
	
КонецФункции

// Возвращает состав пакетов ЭДО документов Документооборота
// 
// Параметры:
//  ИдентификаторыПакетов - Массив Из УникальныйИдентификатор
// 
// Возвращаемое значение:
//  Соответствие Из КлючИЗначение:
//    * Ключ - УникальныйИдентификатор
//    * Значение - Массив Из ОпределяемыйТип.ДокументДОДляЭДО
//
Функция СоставПакетовЭДОДокументов(ИдентификаторыПакетов) Экспорт
	
	СоставПакетов = Новый Соответствие();
	Для Каждого ИдентификаторПакета Из ИдентификаторыПакетов Цикл
		СоставПакетов[ИдентификаторПакета] = Новый Массив();
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	СоставПакетовЭДОДокументооборот.Документ КАК Документ,
		|	СоставПакетовЭДОДокументооборот.ИдентификаторПакета КАК ИдентификаторПакета
		|ИЗ
		|	РегистрСведений.СоставПакетовЭДОДокументооборот КАК СоставПакетовЭДОДокументооборот
		|ГДЕ
		|	СоставПакетовЭДОДокументооборот.ИдентификаторПакета В (&ИдентификаторыПакетов)";
	Запрос.УстановитьПараметр("ИдентификаторыПакетов", ИдентификаторыПакетов);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		СоставПакета = СоставПакетов[Выборка.ИдентификаторПакета];
		СоставПакета.Добавить(Выборка.Документ);
	КонецЦикла;
	
	Возврат СоставПакетов;
	
КонецФункции

#КонецОбласти

#Область ОтражениеДокументовВДО

// Возвращает документы ДО для документов ЭДО
// 
// Параметры:
//  ЭлектронныеДокументы - Массив - Документы ЭДО для которых необходимо получить документы ДО
// 
// Возвращаемое значение:
//  Соответствие Из КлючИЗначение:
//    * Ключ - ДокументСсылка.ЭлектронныйДокументВходящийЭДО, ДокументСсылка.ЭлектронныйДокументИсходящийЭДО - Документы ЭДО
//    * Значение - ОпределяемыйТип.ДокументДОДляЭДО - Документ ДО для документа ЭДО из ключа
Функция ДокументыДОЭлектронныхДокументов(ЭлектронныеДокументы) Экспорт
	
	ДокументыДО = Новый Соответствие;
	Для Каждого ДокументЭДО Из ЭлектронныеДокументы Цикл
		ДокументыДО.Вставить(ДокументЭДО, Неопределено);
	КонецЦикла;
	
	Запрос = Новый Запрос(ИнтеграцияЭДО.ТекстЗапросаОбъектовУчетаЭлектронныхДокументов(Истина));
	Запрос.УстановитьПараметр("ЭлектронныйДокумент", ЭлектронныеДокументы);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если ЗначениеЗаполнено(Выборка.ОбъектУчета)
			И ТипЗнч(Выборка.ОбъектУчета) = ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ТипДокументаДО()
			И Выборка.Актуальный = Истина Тогда
			
			ДокументыДО[Выборка.ЭлектронныйДокумент] = Выборка.ОбъектУчета;
		КонецЕсли;
	КонецЦикла;
	
	Возврат ДокументыДО;
	
КонецФункции

// Виды документов доступные для отражения входящих ЭДО.
// 
// Возвращаемое значение:
//  Массив Из СправочникСсылка.ВидыДокументов - Виды документов доступные для отражения входящих ЭДО
Функция ВидыДокументовДоступныеДляОтраженияВходящихЭДО() Экспорт
	
	ВидыДокументов = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ВидыДокументов.Ссылка
		|ИЗ
		|	Справочник.ВидыДокументов КАК ВидыДокументов
		|ГДЕ
		|	ВидыДокументов.ВестиУчетСторон
		|	И ВидыДокументов.УчитыватьНедействующиеДокументы";
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		ВидыДокументов.Добавить(Выборка.Ссылка);
	КонецЦикла;
	
	Возврат ВидыДокументов;
	
КонецФункции

// Возвращает, доступен ли вид документа ДО для отражения входящего ЭДО
// 
// Параметры:
//  ВидДокумента - СправочникСсылка.ВидыДокументов - Вид документа
// 
// Возвращаемое значение:
//  Булево - Вид документа ДО доступен для отражения входящего ЭДО
Функция ВидДокументаДоступенДляОтраженияВходящегоЭДО(ВидДокумента) Экспорт
	
	РеквизитыВидаДокумента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ВидДокумента,
		"ВестиУчетСторон, УчитыватьНедействующиеДокументы");
	
	Возврат РеквизитыВидаДокумента.ВестиУчетСторон = Истина
		И РеквизитыВидаДокумента.УчитыватьнедействующиеДокументы = Истина;
	
КонецФункции

// Сообщает пользователю ошибки, возникшие при автоматическом отражении входящего документа ЭДО
// 
// Параметры:
//  КонтекстОтражения - Структура - см. ОбменСКонтрагентамиДОСлужебныйКлиентСервер.НовыйКонтекстОтраженияДокументовВДО()
Процедура СообщитьПользователюОшибкиОтраженияВходящегоЭДО(КонтекстОтражения) Экспорт
	
	Если КонтекстОтражения.АвтоматическоеВыполнение Тогда
		Возврат;
	КонецЕсли;
	
	ДокументЭДО = КонтекстОтражения.ДокументЭДО;
	
	Для Каждого Ошибка Из КонтекстОтражения.Ошибки Цикл
		
		ТекстСообщения = СтрШаблон(
			НСтр("ru = 'При создании документа 1С:Документооборот по входящему ЭДО %1 возникла проблема:'"),
			ДокументЭДО)
			+ Символы.ПС + Ошибка.Описание;
		
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения);
		
	КонецЦикла;
	
КонецПроцедуры

#Область ИнтерфейсДокументаДО

// Заполняет таблицу файлов в форме документа ДО при отражении входящего ЭДО
// 
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - Форма документа ДО
Процедура ЗаполнитьТаблицуФайловПриОтраженииВходящегоЭДО(Форма) Экспорт
	
	ФайлыДобавленные = Форма.ФайлыДобавленные;
	КонтекстОтражения = Форма.КонтекстОтраженияВходящегоЭДО;
	
	ФайлыКСозданию = КонтекстОтражения.ФайлыДляСоздания;
	
	ФайлыДобавленные.Очистить();
	
	Для Каждого Файл Из ФайлыКСозданию Цикл
		
		СведенияОФайле = Файл.СведенияОФайле;
		НоваяСтрока = ФайлыДобавленные.Добавить();
		
		НоваяСтрока.Наименование = СведенияОФайле.ИмяБезРасширения;
		НоваяСтрока.Расширение = СведенияОФайле.РасширениеБезТочки;
		НоваяСтрока.Адрес = СведенияОФайле.АдресВременногоХранилищаФайла;
		НоваяСтрока.Размер = СведенияОФайле.Размер;
		НоваяСтрока.ИндексКартинки =
			ФайловыеФункцииСлужебныйКлиентСервер.ПолучитьИндексПиктограммыФайла(СведенияОФайле.РасширениеБезТочки);
		НоваяСтрока.ДобавленИзШаблона = Ложь;
		НоваяСтрока.ФайлОтраженияЭДО = Истина;
		
	КонецЦикла;
	
	Элементы = Форма.Элементы;
	
	Элементы.ГруппаСпискиФайлов.ТекущаяСтраница = Элементы.ГруппаТаблица;
	
	КоличествоФайловТаблицы = ФайлыКСозданию.Количество();
	Форма.КоличествоФайлов = КоличествоФайловТаблицы;
	Элементы.НаименованиеФайла.Заголовок = ДелопроизводствоКлиентСервер.КоличествоФайловВЗаголовок(
		КоличествоФайловТаблицы);
	
КонецПроцедуры

// Удаляет файлы, касающиеся отражения ЭДО после записи в форме документа ДО
// 
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - Форма документа ДО
Процедура УдалитьФайлыЭДОПриОтражении(Форма) Экспорт
	
	ФайлыДобавленные = Форма.ФайлыДобавленные;
	
	КоличествоСтрок = ФайлыДобавленные.Количество();
	
	ИндексСтроки = 0;
	Для Итератор = 0 По КоличествоСтрок-1 Цикл
		Строка = ФайлыДобавленные[ИндексСтроки];
		Если Строка.ФайлОтраженияЭДО Тогда
			ФайлыДобавленные.Удалить(ИндексСтроки);
		Иначе
			ИндексСтроки = ИндексСтроки + 1;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Проверяет корректность заполнения документа ДО и соответствие реквизитов входящему ЭДО перед записью в базе
// 
// Параметры:
//  Форма - ФормаКлиентскогоПриложения - Форма документа ДО
//  Отказ - Булево - Отказать ли в записи
Процедура ПроверитьДокументДОПередОтражениемВходящегоЭДО(Форма, Отказ) Экспорт
	
	ДокументОбъект = Форма.Объект;
	ВидДокумента = ДокументОбъект.ВидДокумента;
	
	Если Не ВидДокументаДоступенДляОтраженияВходящегоЭДО(ВидДокумента) Тогда
		Отказ = Истина;
		ОбщегоНазначения.СообщитьПользователю(
			НСтр("ru = 'Вид документа не может быть выбран для отражения входящего документа по ЭДО.
				|В виде документа должен быть включен учет сторон и учет недействующих документов.'"), ,
			"ВидДокумента");
	КонецЕсли;
	
	КонтекстОтражения = Форма.КонтекстОтраженияВходящегоЭДО;
	
	ОснованиеЗаполнения = КонтекстОтражения.ОснованиеЗаполненияДокумента.ДанныеДляОтраженияПоЭДО;
	СтороныКЗаполнению = ОснованиеЗаполнения.Стороны;
	
	СтороныДокумента = ДокументОбъект.Стороны;
	
	Если СтороныДокумента.Количество() <> СтороныКЗаполнению.Количество() Тогда
		Отказ = Истина;
		ОбщегоНазначения.СообщитьПользователю(
			НСтр("ru = 'Количество сторон документа изменилось. У созданного по входящему ЭДО документа должно быть две стороны:
				|Первая сторона - наша организация, вторая сторона - контрагент, от которого поступил документ'"), ,
			"Стороны");
	КонецЕсли;
	
	Если Отказ = Истина Тогда
		Возврат;
	КонецЕсли;
	
	Для Итератор = 0 По СтороныКЗаполнению.ВГраница() Цикл
		
		СторонаКЗаполнению = СтороныКЗаполнению[Итератор];
		СторонаДокумента = СтороныДокумента[Итератор];
		
		Если СторонаКЗаполнению.Сторона <> СторонаДокумента.Сторона Тогда
			Отказ = Истина;
			ОбщегоНазначения.СообщитьПользователю(
				НСтр("ru = 'Сторона документа изменилась. У созданного по входящему ЭДО документа должно быть две стороны:
					|Первая сторона - наша организация, вторая сторона - контрагент, от которого поступил документ'"), ,
				"Объект.Строны["+Итератор+"]");
		КонецЕсли;
		
		Если НачалоДня(СторонаКЗаполнению.ДатаПодписи) <> СторонаДокумента.ДатаПодписи Тогда
			Отказ = Истина;
			ОбщегоНазначения.СообщитьПользователю(
				НСтр("ru = 'Дата подписания у стороны изменилась.'"), ,
				"Объект.Строны["+Итератор+"].ДатаПодписи");
		КонецЕсли;
		
		Если СторонаКЗаполнению.Подписан <> СторонаДокумента.Подписан Тогда
			Отказ = Истина;
			ОбщегоНазначения.СообщитьПользователю(
				НСтр("ru = 'Признак подписания у стороны изменился.'"), ,
				"Объект.Строны["+Итератор+"].Подписан");
		КонецЕсли;
		
		Если ТипЗнч(СторонаДокумента.Сторона) = Тип("СправочникСсылка.Организации") Тогда
			
			Продолжить;
			
		КонецЕсли;
		
		Если СторонаКЗаполнению.Подписал <> СторонаДокумента.Подписал Тогда
			Отказ = Истина;
			ОбщегоНазначения.СообщитьПользователю(
				НСтр("ru = 'Подписант у стороны изменился.'"), ,
				"Объект.Строны["+Итератор+"].Подписал");
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Данные по отражению входящего документа ЭДО.
// 
// Параметры:
//  ДокументЭДО - ДокументСсылка.ЭлектронныйДокументВходящийЭДО - Документ ЭДО
// 
// Возвращаемое значение:
//  Структура:
// * ТребуетОтражения - Булево - Стоит ли документ в списке к созданию документов ДО
// * ОжидаетАвтоматическогоОтражения - Булево - Должен ли документ обрабатываться регламентным заданием
// * ЕстьДокументДО - Булево - Создан ли документ ДО по входящему ЭДО
Функция ДанныеПоОтражениюДокументаЭДО(ДокументЭДО) Экспорт
	
	ДанныеПоОтражению = Новый Структура;
	ДанныеПоОтражению.Вставить("ТребуетОтражения", Ложь);
	ДанныеПоОтражению.Вставить("ОжидаетАвтоматическогоОтражения", Ложь);
	ДанныеПоОтражению.Вставить("ЕстьДокументДО", Ложь);
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ДокументыЭДОКСозданиюВДО.АвтоматическоеСоздание
		|ИЗ
		|	РегистрСведений.ДокументыЭДОКСозданиюВДО КАК ДокументыЭДОКСозданиюВДО
		|ГДЕ
		|	ДокументыЭДОКСозданиюВДО.ДокументЭДО = &ДокументЭДО
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ Первые 1
		|	ДокументыДО.Ссылка
		|ИЗ
		|	Справочник.Файлы КАК Файлы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОбъектыУчетаДокументовЭДО КАК ОбъектыУчетаДокументовЭДО
		|		ПО ОбъектыУчетаДокументовЭДО.ОбъектУчета = Файлы.ТекущаяВерсия
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|		ПО Файлы.ВладелецФайла = ДокументыДО.Ссылка
		|ГДЕ
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент = &ДокументЭДО
		|	И ОбъектыУчетаДокументовЭДО.Актуальный";
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"%ИмяСправочникаДокументаДО%",
		ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ИмяСправочникаДокументовДО());
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("ДокументЭДО", ДокументЭДО);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	КолвоРезультатов = РезультатыЗапроса.Количество();
	
	ВыборкаДокументовКСозданию = РезультатыЗапроса[КолвоРезультатов - 2].Выбрать();
	ВыборкаДокументовДО = РезультатыЗапроса[КолвоРезультатов - 1].Выбрать();
	
	Если ВыборкаДокументовКСозданию.Следующий() Тогда
		
		ДанныеПоОтражению.ТребуетОтражения = Истина;
		ДанныеПоОтражению.ОжидаетАвтоматическогоОтражения = ВыборкаДокументовКСозданию.АвтоматическоеСоздание;
		
	КонецЕсли;
	
	Если ВыборкаДокументовДО.Следующий() Тогда
		ДанныеПоОтражению.ЕстьДокументДО = Истина;
	КонецЕсли;
	
	Возврат ДанныеПоОтражению;
	
КонецФункции

#КонецОбласти

#Область ОперацииПослеСозданияДокументаДО

// Выполняет сопровождающие функции по отражению входящего ЭДО в ДО.
// 
// Параметры:
//  КонтекстОтражения - Структура - см. ОбменСКонтрагентамиДОСлужебныйКлиентСервер.НовыйКонтекстОтраженияДокументовВДО()
Процедура ВыполнитьОтражениеПриСозданииДокументаДО(КонтекстОтражения) Экспорт
	
	СоздатьФайлыОтраженияВходящегоЭДО(КонтекстОтражения);
	Если КонтекстОтражения.Отказ Тогда
		Возврат;
	КонецЕсли;
	
	ОтразитьСозданиеДокументаВоВходящемПакетеЭДО(КонтекстОтражения);
	Если КонтекстОтражения.Отказ Тогда
		Возврат;
	КонецЕсли;
	
	ОтметитьОтражениеВходящегоЭДОВДО(КонтекстОтражения);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область ПереопределениеБЭД

// Получает данные о юридическом (физическом) лице по ссылке.
//
// Параметры:
//  ЮрФизЛицо - СправочникСсылка - ссылка на элемент справочника, по которому получаются данные.
//  Сведения - см. ЭлектронноеВзаимодействие.СтруктураДанныхЮрФизЛица
//
Процедура ПолучитьДанныеЮрФизЛица(ЮрФизЛицо, Сведения) Экспорт
	
	Если ЗначениеЗаполнено(ЮрФизЛицо)
		И (ТипЗнч(ЮрФизЛицо) = Тип("СправочникСсылка.Организации")
		ИЛИ ТипЗнч(ЮрФизЛицо) = Тип("СправочникСсылка.Контрагенты")) Тогда
		
		ЭтоОрганизация = (ТипЗнч(ЮрФизЛицо) = Тип("СправочникСсылка.Организации"));
		
		ПолучаемыеРеквизиты = Новый Массив(); // Массив Из Строка
		ПолучаемыеРеквизиты.Добавить("ЮрФизЛицо");
		ПолучаемыеРеквизиты.Добавить("Наименование");
		ПолучаемыеРеквизиты.Добавить("НаименованиеПолное");
		ПолучаемыеРеквизиты.Добавить("ИНН");
		ПолучаемыеРеквизиты.Добавить("КПП");
		Если ЭтоОрганизация Тогда
			ПолучаемыеРеквизиты.Добавить("ОГРН");
		Иначе
			ПолучаемыеРеквизиты.Добавить("РегистрационныйНомер");
		КонецЕсли;
		
		РеквизитыЮрФизЛица = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ЮрФизЛицо,
			СтрСоединить(ПолучаемыеРеквизиты, ", "));
		
		Сведения.ЮрФизЛицо = РеквизитыЮрФизЛица.ЮрФизЛицо;
		Сведения.ПолноеНаименование = РеквизитыЮрФизЛица.НаименованиеПолное;
		Сведения.ОфициальноеНаименование = РеквизитыЮрФизЛица.Наименование;
		Сведения.Наименование = РеквизитыЮрФизЛица.Наименование;
		Сведения.ИНН = РеквизитыЮрФизЛица.ИНН;
		Сведения.КПП = РеквизитыЮрФизЛица.КПП;
		Если ЭтоОрганизация Тогда
			Сведения.ОГРН = РеквизитыЮрФизЛица.ОГРН;
		Иначе
			Сведения.ОГРН = РеквизитыЮрФизЛица.РегистрационныйНомер;
		КонецЕсли;
		Сведения.Телефоны = "";
		Сведения.КодПоОКПО = "";
		
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	БанковскиеСчета.НомерСчета,
		|	БанковскиеСчета.Банк.Наименование КАК Банк,
		|	БанковскиеСчета.Банк.Код КАК БИК
		|ИЗ
		|	Справочник.БанковскиеСчета КАК БанковскиеСчета
		|ГДЕ
		|	БанковскиеСчета.Владелец = &Владелец
		|	И НЕ БанковскиеСчета.ПометкаУдаления";
		Запрос.УстановитьПараметр("Владелец", ЮрФизЛицо);
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			ЗаполнитьЗначенияСвойств(Сведения, Выборка);
		КонецЕсли;
		
		Если РеквизитыЮрФизЛица.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель
			ИЛИ РеквизитыЮрФизЛица.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ФизЛицо Тогда
			
			ФИО = ФизическиеЛицаКлиентСервер.ЧастиИмени(РеквизитыЮрФизЛица.Наименование);
			Сведения.Фамилия = ФИО.Фамилия;
			Сведения.Имя = ФИО.Имя;
			Сведения.Отчество = ФИО.Отчество;
		КонецЕсли;
		
	КонецЕсли;
	
	ТаблицаКИ = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(ЮрФизЛицо,, ТекущаяДатаСеанса(), Ложь);
	
	Для Каждого СтрокаТаблицыКИ Из ТаблицаКИ Цикл
		
		Если СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации
			ИЛИ СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ЮридическийАдресКонтрагента Тогда
			
			Сведения.ЮридическийАдресXML = СтрокаТаблицыКИ.ЗначенияПолей;
			Сведения.ЮридическийАдрес = СтрокаТаблицыКИ.Представление;
			
		ИначеЕсли СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ФактАдресОрганизации
			ИЛИ СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ФактическийАдресКонтрагента Тогда
			
			Сведения.ФактическийАдресXML = СтрокаТаблицыКИ.ЗначенияПолей;
			Сведения.ФактическийАдрес = СтрокаТаблицыКИ.Представление;
			
		ИначеЕсли СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ПочтовыйАдресОрганизации
			ИЛИ СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ПочтовыйАдресКонтрагента Тогда
			
			Сведения.ПочтовыйАдресXML = СтрокаТаблицыКИ.ЗначенияПолей;
			Сведения.ПочтовыйАдрес = СтрокаТаблицыКИ.Представление;
			
		ИначеЕсли СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ТелефонОрганизации
			ИЛИ СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ТелефонКонтрагента Тогда
			
			Сведения.ТелефоныXML = СтрокаТаблицыКИ.ЗначенияПолей;
			Сведения.Телефоны = СтрокаТаблицыКИ.Представление;
			
		ИначеЕсли СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.EmailОрганизации
			ИЛИ СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.EmailКонтрагента Тогда
			
			Сведения.ЭлектроннаяПочта = СтрокаТаблицыКИ.Представление;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

// Получает данные о физическом лице по ссылке.
// Для использования в МЧД следует вызывать МашиночитаемыеДоверенностиПереопределяемый.ПриИзмененииДанныеФизЛица.
//
// Параметры:
//  ФизЛицо - СправочникСсылка.ФизическиеЛица - ссылка на элемент справочника, по которому получаются данные.
//  Сведения - см. ЭлектронноеВзаимодействие.СтруктураДанныхФизЛица
//
// См. ЭлектронноеВзаимодействиеПереопределяемый.ПолучитьДанныеФизЛица.
Процедура ПолучитьДанныеФизЛица(ФизЛицо, Сведения) Экспорт

	Если Не ЗначениеЗаполнено(ФизЛицо) Тогда
		Возврат
	КонецЕсли;
	
	Сведения.Ссылка = ФизЛицо;
	
	Реквизиты = "ДатаРождения, ИНН, СтраховойНомерПФР, Пол";
	
	СтруктураДанных = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ФизЛицо, Реквизиты);
	
	СтруктураДанных.Свойство("ДатаРождения", Сведения.ДатаРождения);
	СтруктураДанных.Свойство("ИНН", Сведения.ИНН);
	СтруктураДанных.Свойство("СтраховойНомерПФР", Сведения.СтраховойНомерПФР);	
	СтруктураДанных.Свойство("Гражданство", Неопределено);
	СтруктураДанных.Свойство("Пол", Сведения.Пол);
	СтруктураДанных.Свойство("МестоРождения", Неопределено);
	ФизическиеЛица.ФамилияИнициалыФизЛица(ФизЛицо, Сведения.Фамилия, Сведения.Имя, Сведения.Отчество);
	
	ТаблицаКИ = УправлениеКонтактнойИнформацией.КонтактнаяИнформацияОбъекта(ФизЛицо,,
		ТекущаяДатаСеанса(), Ложь);
	
	Для Каждого СтрокаТаблицыКИ Из ТаблицаКИ Цикл	
		Если СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ПочтовыйАдресАдресата Тогда		
			Сведения.АдресМестаПроживанияXML = СтрокаТаблицыКИ.ЗначенияПолей;
			Сведения.АдресМестаПроживания = СтрокаТаблицыКИ.Представление;		
		ИначеЕсли СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ДомашнийАдресФизическогоЛица Тогда		
			Сведения.АдресПоПропискеXML = СтрокаТаблицыКИ.ЗначенияПолей;
			Сведения.АдресПоПрописке = СтрокаТаблицыКИ.Представление;		
		ИначеЕсли СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.ДомашнийТелефонФизическогоЛица Тогда		
			Сведения.ТелефоныXML = СтрокаТаблицыКИ.ЗначенияПолей;
			Сведения.Телефоны = СтрокаТаблицыКИ.Представление;			
		ИначеЕсли СтрокаТаблицыКИ.Вид = Справочники.ВидыКонтактнойИнформации.EmailФизическогоЛица Тогда			
			Сведения.ЭлектроннаяПочта = СтрокаТаблицыКИ.Представление;			
		КонецЕсли;	
	КонецЦикла;

КонецПроцедуры

// Переопределение процедуры ОбменСКонтрагентамиПереопределяемый.ЗаполнитьРегистрационныеДанныеОрганизации
//
// Параметры:
//  Организация - ОпределяемыйТип.Организация - ссылка на элемент справочника Организации;
//  ДанныеОрганизации - см. ИнтеграцияЭДО.НоваяСтруктураДанныхОрганизации
//
Процедура ЗаполнитьРегистрационныеДанныеОрганизации(Организация, ДанныеОрганизации) Экспорт
	
	РеквизитыОрганизации = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(Организация,
		"Наименование, НаименованиеПолное, ИНН, КПП, ОГРН, ЮрФизЛицо");
	
	Если ЗначениеЗаполнено(РеквизитыОрганизации.НаименованиеПолное) Тогда
		ДанныеОрганизации.Наименование = РеквизитыОрганизации.НаименованиеПолное;
	Иначе
		ДанныеОрганизации.Наименование = РеквизитыОрганизации.Наименование;
	КонецЕсли;
	
	ДанныеОрганизации.ИНН = РеквизитыОрганизации.ИНН;
	ДанныеОрганизации.КПП = РеквизитыОрганизации.КПП;
	ДанныеОрганизации.ОГРН = РеквизитыОрганизации.ОГРН;
	
	ОрганизацияФизЛицо = (РеквизитыОрганизации.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель
		ИЛИ РеквизитыОрганизации.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ФизЛицо);
	
	Если ОрганизацияФизЛицо Тогда
		ДанныеОрганизации.ЮрФизЛицо = "ФизЛицо";
	Иначе
		ДанныеОрганизации.ЮрФизЛицо = "ЮрЛицо";
	КонецЕсли;
	
	ЗаполнитьДанныеРуководителя(Организация, ДанныеОрганизации);
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	КонтактнаяИнформация.Значение
		|ИЗ
		|	Справочник.Организации.КонтактнаяИнформация КАК КонтактнаяИнформация
		|ГДЕ
		|	КонтактнаяИнформация.Ссылка = &Ссылка
		|	И КонтактнаяИнформация.Вид = &Вид";
	Запрос.УстановитьПараметр("Ссылка", Организация);
	Запрос.УстановитьПараметр("Вид",    Справочники.ВидыКонтактнойИнформации.ЮрАдресОрганизации);
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		
		АдресСтруктурой = РаботаСАдресами.СведенияОбАдресе(Выборка.Значение);
		Если АдресСтруктурой.Свойство("Индекс") Тогда
			ДанныеОрганизации.Индекс = АдресСтруктурой.Индекс;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Регион") Тогда
			ДанныеОрганизации.Регион = АдресСтруктурой.Регион;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("КодРегиона") Тогда
			ДанныеОрганизации.КодРегиона = АдресСтруктурой.КодРегиона;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Район") Тогда
			ДанныеОрганизации.Район = АдресСтруктурой.Район;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Город") Тогда
			ДанныеОрганизации.Город = АдресСтруктурой.Город;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("НаселенныйПункт") Тогда
			ДанныеОрганизации.НаселенныйПункт = АдресСтруктурой.НаселенныйПункт;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Улица") Тогда
			ДанныеОрганизации.Улица = АдресСтруктурой.Улица;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Здание") И ЗначениеЗаполнено(АдресСтруктурой.Здание) Тогда
			ДанныеОрганизации.Дом = АдресСтруктурой.Здание.Номер;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Корпуса") И ЗначениеЗаполнено(АдресСтруктурой.Корпуса) Тогда
			ДанныеОрганизации.Корпус = АдресСтруктурой.Корпуса[0].Номер;
		КонецЕсли;
		Если АдресСтруктурой.Свойство("Помещения") И ЗначениеЗаполнено(АдресСтруктурой.Помещения) Тогда
			ДанныеОрганизации.Квартира = АдресСтруктурой.Помещения[0].Номер;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Создает контрагента в информационной базе по реквизитам.
//
// Параметры:
//   РеквизитыКонтрагента - Структура:
//    * ИНН - Строка
//    * КПП - Строка
//    * Наименование - Строка
//   Контрагент - ОпределяемыйТип.КонтрагентБЭД
//   Отказ - Булево
//
Процедура СоздатьКонтрагентаПоРеквизитам(Знач РеквизитыКонтрагента, Контрагент, Отказ = Ложь) Экспорт
	
	Если Не ПравоДоступа("Добавление", Метаданные.Справочники.Контрагенты) Тогда
		Отказ = Истина;
		ТекстСообщения = НСтр("ru = 'Недостаточно прав для создания контрагента.'");
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,, Отказ);
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Создание контрагента'", ОбщегоНазначения.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка, Метаданные.Справочники.Контрагенты,,
			ТекстСообщения);
		Возврат;
	КонецЕсли;
	
	Попытка
		
		Объект = Справочники.Контрагенты.СоздатьЭлемент();
		Объект.ИНН = РеквизитыКонтрагента.ИНН;
		Объект.КПП = РеквизитыКонтрагента.КПП;
		Объект.НаименованиеПолное = РеквизитыКонтрагента.Наименование;
		Объект.Наименование = РеквизитыКонтрагента.Наименование;
		
		Если СтрДлина(РеквизитыКонтрагента.ИНН) = 10 Тогда
			Объект.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо;
		ИначеЕсли СтрДлина(РеквизитыКонтрагента.ИНН) = 12 Тогда
			Объект.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ИндивидуальныйПредприниматель;
		КонецЕсли;
	
		Объект.Записать();
		Контрагент = Объект.Ссылка;
	Исключение
		ТекстСообщения = НСтр("ru = 'Ошибка при записи нового элемента справочника Контрагенты.'")
			+ Символы.ПС + НСтр("ru ='Подробности см. в журнале регистрации.'",
			ОбщегоНазначения.КодОсновногоЯзыка());
		ОбщегоНазначения.СообщитьПользователю(ТекстСообщения,,,, Отказ);
		ЗаписьЖурналаРегистрации(НСтр("ru = 'Создание контрагента'", ОбщегоНазначения.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка, Метаданные.Справочники.Контрагенты,,
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти

#Область УстаревшиеПроцедурыИФункции

// Устарела. Следует использовать ОбменЭДОДокументооборот.ДокументыЭДОДокументовДО
// Возвращает электронный документ, связанный с документом 1С:Документооборот
// 
// Параметры:
//  ДокументДО - ОпределяемыйТип.ДокументДОДляЭДО - Документ ДО для которого необходимо получить документ ЭДО
// 
// Возвращаемое значение:
//  ДокументСсылка.ЭлектронныйДокументВходящийЭДО, ДокументСсылка.ЭлектронныйДокументИсходящийЭДО, Неопределено -
//              Документ ЭДО с которым связан документ ДО, неопределено, если документа ЭДО не найдено.
Функция ЭлектронныйДокументДокументаДО(ДокументДО) Экспорт
	
	ДокументыДО = ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ДокументДО);
	ДокументыЭДОПоДокументамДО = ОбменЭДОДокументооборот.ДокументыЭДОДокументовДО(ДокументыДО);
	
	ДокументыЭДО = ДокументыЭДОПоДокументамДО[ДокументДО];
	
	Если ДокументыЭДО.Количество() > 0 Тогда
		Возврат ДокументыЭДО[0];
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция РольФайловДляОтправкиПоЭДО(ВидДокумента) Экспорт
	
	ТаблицаРолей = Делопроизводство.РолиФайловДляВидаДокументов(ВидДокумента);
	
	Для Каждого СтрРоли Из ТаблицаРолей Цикл
		Если СтрРоли.ФайлЭлектронногоДокумента Тогда
			Возврат СтрРоли.Роль;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Справочники.РолиФайлов.ПустаяСсылка();
	
КонецФункции

#Область СвойстваЭДИзФайла

Функция СведенияОЭДФорматаФНС(ДанныеЭДФайла)
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Валюта", Справочники.Валюты.ПустаяСсылка());
	
	ДеревоДанных = ДанныеЭДФайла.НовыйЭД.ЗначениеРеквизита;
	
	Если ДанныеЭДФайла.НовыйЭД.ВидЭД = Перечисления.ТипыДокументовЭДО.ДокументПредприятия Тогда
		Если ДеревоДанных.ИнформацияДокумента[0].Валюта <> Неопределено Тогда
			КодВалюты = ДеревоДанных.Валюта[0].Код;
		КонецЕсли;	
	Иначе	
		КодВалюты = ДеревоЭлектронногоДокументаБЭД.ЗначениеРеквизитаВДереве(ДеревоДанных, "ВалютаКод", Ложь);
	КонецЕсли;
	
	Если КодВалюты <> Неопределено Тогда
		
		Валюта = Справочники.Валюты.НайтиПоКоду(КодВалюты);
		
		Если ЗначениеЗаполнено(Валюта) Тогда
			СтруктураВозврата.Валюта = Валюта;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат СтруктураВозврата;
	
КонецФункции

Функция СведенияОЭДФорматаCML(ДанныеЭДФайла)
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Валюта", Справочники.Валюты.ПустаяСсылка());
	
	ДанныеДереваРазбора = ОбменСКонтрагентамиДО.ДанныеДереваРазбораCML(ДанныеЭДФайла.ДеревоРазбора);
	
	Если ДанныеДереваРазбора = Неопределено Тогда
		Возврат СтруктураВозврата;
	КонецЕсли;
	
	ДанныеДокумента = ДанныеДереваРазбора.Документы.Получить(ДанныеЭДФайла.НовыйЭД.ИД);
	
	Если ДанныеДокумента.Свойство("Валюта") Тогда
		
		ДанныеВалюты = ОбменСКонтрагентамиДО.ДанныеВалютыПоДаннымCML(ДанныеДереваРазбора, ДанныеДокумента.Валюта);
		
		Если ДанныеВалюты <> Неопределено Тогда
			Если ЗначениеЗаполнено(ДанныеВалюты.Ссылка) Тогда
				СтруктураВозврата.Валюта = ДанныеВалюты.Ссылка;
			ИначеЕсли ЗначениеЗаполнено(ДанныеВалюты.Код) Тогда
				Валюта = Справочники.Валюты.НайтиПоКоду(ДанныеВалюты.Код);
				
				Если ЗначениеЗаполнено(Валюта) Тогда
					СтруктураВозврата.Валюта = Валюта;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат СтруктураВозврата;
	
КонецФункции

#КонецОбласти

#Область ФормированиеПредставленияДокумента

Функция ПредставлениеДанныхПоФайлу(Файл, Версия, ПараметрыВизуализации) Экспорт
	
	Результат = НовыйРезультатПредставленияЭДО();
	
	Результат.Файл = Файл;
	Результат.Версия = Версия;
	
	Результат.Документ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Файл, "ВладелецФайла");
	Результат.ДокументЭДО = ЭлектронныйДокументДокументаДО(Результат.Документ);
	
	ДанныеФайлаИДвоичныеДанные = РаботаСФайламиВызовСервера.ДанныеФайлаИДвоичныеДанные(Файл, Версия);
	
	Расширение = ДанныеФайлаИДвоичныеДанные.ДанныеФайла.Расширение;
	
	Результат.ИмяФайла = ОбщегоНазначенияКлиентСервер.ПолучитьИмяСРасширением(
		ДанныеФайлаИДвоичныеДанные.ДанныеФайла.ПолноеНаименованиеВерсии, Расширение);
	
	Результат.ИндексКартинкиФайла = ФайловыеФункцииКлиентСервер.ПолучитьИндексПиктограммыФайла(Расширение);
	
	// Если это не xml файл, то он не формализованный и выводим результат просто так.
	Если ВРег(Расширение) <> "XML" Тогда
		Результат.Успех = Истина;
		Возврат Результат;
	КонецЕсли;
	
	СведенияОФайле = СведенияОЭДИзФайла(ПоместитьВоВременноеХранилище(ДанныеФайлаИДвоичныеДанные.ДвоичныеДанные));
	
	// Если не смогли прочитать -- это не является неуспехом. Просто он не формализованный. Выводим как файл.
	Если ТипЗнч(СведенияОФайле) <> Тип("Структура") Тогда
		Результат.Успех = Истина;
		Возврат Результат;
	КонецЕсли;
	
	
	ВидДокумента = СведенияОФайле.ВидДокументаЭДО;
	ДвоичныеДанныеФайла = ДанныеФайлаИДвоичныеДанные.ДвоичныеДанные;
	
	ДвоичныеДанныеФайлаОтвета = ДвоичныеДанныеФайлаОтвета(Версия);
	
	РезультатПредставленияТабличногоДокумента =
		ЭлектронныеДокументыЭДО.ПредставлениеДанныхСообщения(
			ВидДокумента, ДвоичныеДанныеФайла, ДвоичныеДанныеФайлаОтвета, ПараметрыВизуализации);
	
	Если ТипЗнч(РезультатПредставленияТабличногоДокумента) <> Тип("Структура")
		Или Не РезультатПредставленияТабличногоДокумента.Успех Тогда
		
		Возврат Результат;
	КонецЕсли;
	
	ТабличныйДокумент = РезультатПредставленияТабличногоДокумента.ПредставлениеДокумента;
	
	ДополнитьВизуализациюШтампамиПодписей(ТабличныйДокумент, Файл, Версия);
	
	Результат.Успех = Истина;
	Результат.ТабличныйДокумент = ТабличныйДокумент;
	
	Возврат Результат;
	
КонецФункции

Функция ПредставлениеДанныхПоДокументу(Документ, ПараметрыВизуализации)
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	Файлы.ВладелецФайла КАК Документ,
		|	ДокументыДО.ВидДокумента,
		|	Файлы.Ссылка КАК Файл,
		|	ЕСТЬNULL(РолиФайловДокументов.Роль, ЗНАЧЕНИЕ(Справочник.РолиФайлов.ПустаяСсылка)) КАК РольФайла,
		|	Файлы.ТекущаяВерсия КАК Версия
		|ПОМЕСТИТЬ ФайлыДокумента
		|ИЗ
		|	Справочник.Файлы КАК Файлы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СлужебныеФайлыДокументов КАК СлужебныеФайлыДокументов
		|		ПО СлужебныеФайлыДокументов.Файл = Файлы.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РолиФайловДокументов КАК РолиФайловДокументов
		|		ПО Файлы.Ссылка = РолиФайловДокументов.Файл
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|		ПО Файлы.ВладелецФайла = ДокументыДО.Ссылка
		|ГДЕ
		|	Файлы.ВладелецФайла = &Документ
		|	И СлужебныеФайлыДокументов.Файл ЕСТЬ NULL
		|	И НЕ Файлы.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ФайлыДокумента.Документ,
		|	ФайлыДокумента.Файл,
		|	ФайлыДокумента.Версия,
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент
		|ИЗ
		|	ФайлыДокумента КАК ФайлыДокумента
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОбъектыУчетаДокументовЭДО КАК ОбъектыУчетаДокументовЭДО
		|		ПО (ОбъектыУчетаДокументовЭДО.ОбъектУчета = ФайлыДокумента.Версия
		|		И ОбъектыУчетаДокументовЭДО.Актуальный)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ФайлыДокумента.Документ,
		|	ФайлыДокумента.Файл,
		|	ФайлыДокумента.Версия
		|ИЗ
		|	ФайлыДокумента КАК ФайлыДокумента
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыДокументов.РолиФайлов КАК ВидыДокументовРолиФайлов
		|		ПО ФайлыДокумента.РольФайла = ВидыДокументовРолиФайлов.Роль
		|		И ФайлыДокумента.ВидДокумента = ВидыДокументовРолиФайлов.Ссылка
		|ГДЕ
		|	ВидыДокументовРолиФайлов.ФайлЭлектронногоДокумента
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ФайлыДокумента.Документ,
		|	ФайлыДокумента.Файл,
		|	ФайлыДокумента.Версия
		|ИЗ
		|	ФайлыДокумента КАК ФайлыДокумента
		|ГДЕ
		|	ФайлыДокумента.РольФайла = ЗНАЧЕНИЕ(Справочник.РолиФайлов.ПустаяСсылка)";
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"%ИмяСправочникаДокументаДО%",
		ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ИмяСправочникаДокументовДО());
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Документ", Документ);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	КолвоРезультатов =  РезультатыЗапроса.Количество();
	
	ВыборкаПоСвязаннымДокументамЭДО = РезультатыЗапроса[КолвоРезультатов - 2].Выбрать();
	ВыборкаПоФайламКОтправке = РезультатыЗапроса[КолвоРезультатов - 1].Выбрать();
	
	КоличествоСвязанныхДокументовЭДО = ВыборкаПоСвязаннымДокументамЭДО.Количество();
	Если КоличествоСвязанныхДокументовЭДО > 0 Тогда
		
		Если КоличествоСвязанныхДокументовЭДО > 1 Тогда
			
			Результат = НовыйРезультатПредставленияЭДО();
			Результат.Документ = Документ;
			Результат.Успех = Ложь;
			Результат.ОписаниеОшибки = СтрШаблон(
				НСтр("ru = 'С документом %1 по ЭДО.
					|В обмене по ЭДО может учавствовать документ только с одним файлом.'"),
				СтроковыеФункцииКлиентСервер.СтрокаСЧисломДляЛюбогоЯзыка(
					НСтр("ru = ';связан %1 файл;;связано %1 файла;связано %1 файлов;связано %1 файлов'"),
					КоличествоСвязанныхДокументовЭДО));
			
			Возврат Результат;
			
		КонецЕсли;
		
		ВыборкаПоСвязаннымДокументамЭДО.Следующий();
		
		Возврат ПредставлениеДанныхПоФайлу(
			ВыборкаПоСвязаннымДокументамЭДО.Файл,
			ВыборкаПоСвязаннымДокументамЭДО.Версия,
			ПараметрыВизуализации);
		
	КонецЕсли;
	
	КоличествоФайловДляОтправки = ВыборкаПоФайламКОтправке.Количество();
	
	Если КоличествоФайловДляОтправки > 1 Тогда
		
		Результат = НовыйРезультатПредставленияЭДО();
		Результат.Документ = Документ;
		Результат.Успех = Ложь;
		Результат.ОписаниеОшибки = СтрШаблон(
			НСтр("ru = 'К документу %1 для отправки по ЭДО.
				|В обмене по ЭДО может учавствовать документ только с одним файлом.'"),
			СтроковыеФункцииКлиентСервер.СтрокаСЧисломДляЛюбогоЯзыка(
				НСтр("ru = ';прикреплен %1 файл;;прикреплено %1 файла;прикреплено %1 файлов;прикреплено %1 файлов'"),
				КоличествоФайловДляОтправки));
		
		Возврат Результат;
		
	ИначеЕсли КоличествоФайловДляОтправки <=0 Тогда
		
		Результат = НовыйРезультатПредставленияЭДО();
		Результат.Документ = Документ;
		Результат.Успех = Ложь;
		Результат.ОписаниеОшибки = 
			НСтр("ru = 'К документу не прикреплено файлов доступных к отправке по ЭДО.
				|Для обмена по ЭДО к документу должен быть прикреплен файл.'");
		
		Возврат Результат;
		
	КонецЕсли;
	
	ВыборкаПоФайламКОтправке.Следующий();
	
	Возврат ПредставлениеДанныхПоФайлу(
		ВыборкаПоФайламКОтправке.Файл,
		ВыборкаПоФайламКОтправке.Версия,
		ПараметрыВизуализации);
	
КонецФункции

Функция ПредставлениеДанныхПоДокументуЭДО(ДокументЭДО, ПараметрыВизуализации)
	
	Результат = НовыйРезультатПредставленияЭДО();
	
	Результат.ДокументЭДО = ДокументЭДО;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	СообщениеЭДО.Ссылка КАК СообщениеЭДО,
		|	СообщениеЭДОПрисоединенныеФайлы.Ссылка КАК ФайлЭДО,
		|	СообщениеЭДОПрисоединенныеФайлы.Расширение,
		|	СообщениеЭДОПрисоединенныеФайлы.ПолноеИмяФайла
		|ИЗ
		|	Документ.СообщениеЭДО КАК СообщениеЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СообщениеЭДОПрисоединенныеФайлы КАК СообщениеЭДОПрисоединенныеФайлы
		|		ПО СообщениеЭДО.ОсновнойФайл = СообщениеЭДОПрисоединенныеФайлы.Ссылка
		|ГДЕ
		|	СообщениеЭДО.ЭлектронныйДокумент = &ДокументЭДО
		|	И СообщениеЭДО.ТипЭлементаРегламента В (&ТипыЭлементовРегламента)";
	Запрос.УстановитьПараметр("ДокументЭДО", ДокументЭДО);
	
	ТипыЭлементовРегламента = Новый Массив;
	ТипыЭлементовРегламента.Добавить(Перечисления.ТипыЭлементовРегламентаЭДО.ИнформацияОтправителя);
	
	Запрос.УстановитьПараметр("ТипыЭлементовРегламента", ТипыЭлементовРегламента);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Не Выборка.Следующий() Тогда
		Результат.ОписаниеОшибки = НСтр("ru = 'Не удалось получить файл ЭДО для визуализации.'");
		Возврат Результат;
	КонецЕсли;
	
	Расширение = Выборка.Расширение;
	СообщениеЭДО = Выборка.СообщениеЭДО;
	ФайлЭДО = Выборка.ФайлЭДО;
	
	Результат.Успех = Истина;
	Результат.ЭтоВизуализацияФайлаЭДО = Истина;
	Результат.ФайлЭДО = ФайлЭДО;
	Результат.ИмяФайла = Выборка.ПолноеИмяФайла;
	Результат.ИндексКартинкиФайла = ФайловыеФункцииКлиентСервер.ПолучитьИндексПиктограммыФайла(Расширение);
	
	Если ВРег(Расширение) <> "XML" Тогда
		Возврат Результат;
	КонецЕсли;
	
	РезультатВизуализацииЭДО =
		ЭлектронныеДокументыЭДО.ПредставлениеДанныхСообщенияПоСсылке(СообщениеЭДО, , ПараметрыВизуализации);
	
	Если ТипЗнч(РезультатВизуализацииЭДО) <> Тип("Структура")
		Или Не РезультатВизуализацииЭДО.Успех Тогда
		
		Возврат Результат;
	КонецЕсли;
	
	Результат.ТабличныйДокумент = РезультатВизуализацииЭДО.ПредставлениеДокумента;
	Возврат Результат;
	
КонецФункции

Функция НовыйРезультатПредставленияЭДО()
	
	РезультатПредставления = Новый Структура;
	РезультатПредставления.Вставить("Успех", Ложь);
	РезультатПредставления.Вставить("ОписаниеОшибки", "");
	РезультатПредставления.Вставить("Документ", ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ПустойДокументДО());
	РезультатПредставления.Вставить("Файл", Справочники.Файлы.ПустаяСсылка());
	РезультатПредставления.Вставить("Версия", Справочники.ВерсииФайлов.ПустаяСсылка());
	РезультатПредставления.Вставить("ДокументЭДО", Неопределено);
	РезультатПредставления.Вставить("ФайлЭДО", Неопределено);
	РезультатПредставления.Вставить("ТабличныйДокумент", Неопределено);
	РезультатПредставления.Вставить("ИндексКартинкиФайла", 0);
	РезультатПредставления.Вставить("ИмяФайла", "");
	РезультатПредставления.Вставить("ЭтоВизуализацияФайлаЭДО", Ложь);
	
	Возврат РезультатПредставления;
	
КонецФункции

Функция ДанныеОтветногоТитула(ВерсияФайлаДО)
	
	ДанныеОтвета = Новый Структура;
	ДанныеОтвета.Вставить("Сообщение", Документы.СообщениеЭДО.ПустаяСсылка());
	ДанныеОтвета.Вставить("Файл", Справочники.СообщениеЭДОПрисоединенныеФайлы.ПустаяСсылка());
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент,
		|	СообщениеЭДО.Ссылка КАК СообщениеОтветногоТитула,
		|	СообщениеЭДО.ОсновнойФайл КАК ФайлОтветногоТитула
		|ИЗ
		|	РегистрСведений.ОбъектыУчетаДокументовЭДО КАК ОбъектыУчетаДокументовЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СообщениеЭДО КАК СообщениеЭДО
		|		ПО СообщениеЭДО.ЭлектронныйДокумент = ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент
		|ГДЕ
		|	ОбъектыУчетаДокументовЭДО.ОбъектУчета = &ОбъектУчета
		|	И ОбъектыУчетаДокументовЭДО.Актуальный
		|	И СообщениеЭДО.ТипЭлементаРегламента = &ТипЭлементаРегламента";
	Запрос.УстановитьПараметр("ОбъектУчета", ВерсияФайлаДО);
	Запрос.УстановитьПараметр("ТипЭлементаРегламента", Перечисления.ТипыЭлементовРегламентаЭДО.ИнформацияПолучателя);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ДанныеОтвета.Сообщение = Выборка.СообщениеОтветногоТитула;
		ДанныеОтвета.Файл = Выборка.ФайлОтветногоТитула;
	КонецЕсли;
	
	Возврат ДанныеОтвета;
	
КонецФункции

Функция ДвоичныеДанныеФайлаОтвета(ВерсияФайлаДО)
	
	ДанныеОтвета = ДанныеОтветногоТитула(ВерсияФайлаДО);
	ФайлОтвета = ДанныеОтвета.Файл;
	
	Если Не ЗначениеЗаполнено(ФайлОтвета) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ДвоичныеДанныеФайлаОтвета = РаботаСФайлами.ДвоичныеДанныеФайла(ФайлОтвета);
	
	Возврат ДвоичныеДанныеФайлаОтвета;
	
КонецФункции

Процедура ДополнитьВизуализациюШтампамиПодписей(ТабличныйДокумент, ФайлДО ,ВерсияФайлаДО)
	
	ДанныеДляШтампа = ДанныеДляШтампаЭП(ФайлДО, ВерсияФайлаДО);
	
	Если ДанныеДляШтампа = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ДанныеДляШтампа.ПодписиОтправителя.Количество() = 0
		И ДанныеДляШтампа.ПодписиПолучателя.Количество() = 0 Тогда
		
		Возврат;
	КонецЕсли;
	
	УстановитьПривилегированныйРежим(Истина);
	Штамп = КриптографияБЭД.ШтампЭлектроннойПодписи(ДанныеДляШтампа);
	
	ОбщегоНазначенияБЭД.ПрисоединитьОбластьКТабличномуДокументу(ТабличныйДокумент, Штамп, "Штамп");
	
КонецПроцедуры

Функция ДанныеДляШтампаЭП(ФайлДО, ВерсияФайлаДО)
	
	ДанныеДляФормированияШтампа = КриптографияБЭД.НовыеДанныеДляФормированияШтампа();
	
	ДокументДО = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ФайлДО, "ВладелецФайла");
	
	Если Не ЗначениеЗаполнено(ДокументДО) Или Не ДелопроизводствоКлиентСервер.ЭтоДокумент(ДокументДО) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ПараметрыДокумента = ПараметрыДокументаПоЭДО(ДокументДО);
	Если ПараметрыДокумента <> Неопределено Тогда
		Направление = ПараметрыДокумента.Направление;
		СостояниеДО = ПараметрыДокумента.СостояниеДО;
	Иначе
		Направление = Перечисления.НаправленияЭДО.Исходящий;
		СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.НеСформирован;
	КонецЕсли;
	
	РеквизитыДокумента = ОбщегоНазначения.ЗначенияРеквизитовОбъекта(ДокументДО, "Организация");
	
	ДанныеФайлаИДвоичныеДанные = РаботаСФайламиВызовСервера.ДанныеФайлаИДвоичныеДанные(ФайлДО, ВерсияФайлаДО);
	СведенияОФайле = СведенияОЭДИзФайла(ПоместитьВоВременноеХранилище(ДанныеФайлаИДвоичныеДанные.ДвоичныеДанные));
	
	ДанныеДляФормированияШтампа.ИдентификаторДокумента = СведенияОФайле.ИдентификаторДокумента;
	ДанныеДляФормированияШтампа.ЭтоИнформацияОтправителя = Истина;
	ДанныеДляФормированияШтампа.Организация = РеквизитыДокумента.Организация;
	ДанныеДляФормированияШтампа.ЭтоИсходящийДокумент =
		(Направление = Перечисления.НаправленияЭДО.Исходящий);
	
	ОсновноеСостояние = КриптографияБЭД.ОсновныеСостоянияДокументов().Подписан;
	Если Направление = Перечисления.НаправленияЭДО.Входящий
		И СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.Получен Тогда
		
		ОсновноеСостояние = КриптографияБЭД.ОсновныеСостоянияДокументов().Получен;
		
	ИначеЕсли Направление = Перечисления.НаправленияЭДО.Исходящий
		И СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.Отправлен Тогда
		
		ОсновноеСостояние = КриптографияБЭД.ОсновныеСостоянияДокументов().Отправлен;
		
	КонецЕсли;
	
	ДанныеДляФормированияШтампа.ОсновноеСостояние = ОсновноеСостояние;
	
	ДополнительноеСостояние = Неопределено;
	Если СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.ОжидаетсяПодтверждениеАннулирования
		Или СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.ТребуетсяАннулировать Тогда
		
		ДополнительноеСостояние = КриптографияБЭД.ДополнительныеСостоянияДокументов().ВПроцессеАннулирования;
		
	ИначеЕсли СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.Аннулирован Тогда 
		
		ДополнительноеСостояние = КриптографияБЭД.ДополнительныеСостоянияДокументов().Аннулирован;
		
	ИначеЕсли СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.ОжидаетсяИсправление
		Или СостояниеДО = Перечисления.СостоянияЭДОДокументооборот.ТребуетсяУточнение Тогда 
		
		ДополнительноеСостояние = КриптографияБЭД.ДополнительныеСостоянияДокументов().Отклонен;
		
	КонецЕсли;
	
	ДанныеДляФормированияШтампа.ДополнительноеСостояние = ДополнительноеСостояние;
	
	ПодписиФайла = ПодписиСУчетомДоверенностиВФорматеБЭД(ВерсияФайлаДО);
	ПодписиОтветногоТитула = Новый Массив;
	
	ДанныеОтвета = ДанныеОтветногоТитула(ВерсияФайлаДО);
	Если ЗначениеЗаполнено(ДанныеОтвета.Сообщение) Тогда
		ПодписиОтветногоТитула = ЭлектронныеДокументыЭДО.УстановленныеПодписиСУчетомДоверенностей(ДанныеОтвета.Сообщение);
		ИсключитьПодписиОтветногоТитула(ПодписиФайла, ПодписиОтветногоТитула);
	КонецЕсли;
	
	ДанныеДляФормированияШтампа.ПодписиОтправителя = ПодписиФайла;
	ДанныеДляФормированияШтампа.ПодписиПолучателя = ПодписиОтветногоТитула;
	
	ДанныеДляФормированияШтампа.ЕстьОтветнаяПодпись = ЗначениеЗаполнено(ДанныеДляФормированияШтампа.ПодписиПолучателя)
		Или (Направление = Перечисления.НаправленияЭДО.Входящий
			И СостояниеДО <> Перечисления.СостоянияЭДОДокументооборот.НаПодписи);
	
	Возврат ДанныеДляФормированияШтампа;
	
КонецФункции

Функция ПодписиСУчетомДоверенностиВФорматеБЭД(ПодписанныйОбъект)
	
	ДанныеПодписиейСУчетомДоверенностей = Новый Массив;
	
	УстановленныеПодписи = ЭлектроннаяПодпись.УстановленныеПодписи(ПодписанныйОбъект);
	
	УникальныеИдентификаторы = Новый Массив;
	Для Каждого Подпись Из УстановленныеПодписи Цикл
		УникальныеИдентификаторы.Добавить(Подпись.ИдентификаторПодписи);
	КонецЦикла;
	
	ДанныеДоверенностей = РаботаСЭПЛокализация.ДанныеДоверенностейПодписей(УникальныеИдентификаторы);
	
	Доверенности = Новый Массив;
	Для Каждого Элемент Из ДанныеДоверенностей Цикл
		Доверенности.Добавить(Элемент.Значение.Доверенность);
	КонецЦикла;
	
	СвойстваДоверенностей = МашиночитаемыеДоверенности.ОбщиеСвойстваДоверенностей(Доверенности);
	
	Для Каждого Подпись Из УстановленныеПодписи Цикл
		
		ДанныеПодписи = ЭлектронныеДокументыЭДОКлиентСервер.НовыеДанныеПодписиСУчетомДоверенности();
		
		СвойстваПодписи = Новый Структура;
		СвойстваПодписи.Вставить("Подпись");
		СвойстваПодписи.Вставить("ВидПодписи");
		СвойстваПодписи.Вставить("УстановившийПодпись");
		СвойстваПодписи.Вставить("Комментарий");
		СвойстваПодписи.Вставить("ДатаПодписи");
		СвойстваПодписи.Вставить("ДатаПроверкиПодписи");
		СвойстваПодписи.Вставить("ПодписьВерна");
		СвойстваПодписи.Вставить("ПорядковыйНомер");
		СвойстваПодписи.Вставить("Сертификат");
		СвойстваПодписи.Вставить("Отпечаток");
		СвойстваПодписи.Вставить("Владелец");
		СвойстваПодписи.Вставить("Должность");
		СвойстваПодписи.Вставить("ИдентификаторПодписи");
		
		ЗаполнитьЗначенияСвойств(СвойстваПодписи, Подпись);
		СвойстваПодписи.ВидПодписи = Перечисления.ВидыЭлектронныхПодписей.УсиленнаяКвалифицированная;
		СвойстваПодписи.Владелец = Подпись.КомуВыданСертификат;
		
		ДанныеПодписи.СвойстваПодписи = СвойстваПодписи;
		
		ДанныеДоверенности = ДанныеДоверенностей[Подпись.ИдентификаторПодписи];
		Если ДанныеДоверенности = Неопределено Тогда
			ДанныеПодписи.ЭтоПодписьПоДоверенности = Ложь;
			ДанныеПодписиейСУчетомДоверенностей.Добавить(ДанныеПодписи);
			Продолжить;
		КонецЕсли;
		
		ДанныеПодписи.ЭтоПодписьПоДоверенности = Истина;
		
		РезультатПроверкиПодписи = МашиночитаемыеДоверенности.НовыйРезультатПроверкиПодписи();
		РезультатПроверкиПодписи.ДатаПроверки = ДанныеДоверенности.ДатаПроверкиДоверенности;
		РезультатПроверкиПодписи.Доверенность = ДанныеДоверенности.Доверенность;
		РезультатПроверкиПодписи.ПодписьВерна = ДанныеДоверенности.ДоверенностьВерна;
		РезультатПроверкиПодписи.ПротоколПроверки = ДанныеДоверенности.ПротоколПроверкиДоверенности;
		
		ДанныеПодписи.РезультатПроверкиПоМЧД = РезультатПроверкиПодписи;
		ДанныеПодписи.СвойстваДоверенности = СвойстваДоверенностей[ДанныеДоверенности.Доверенность];
		
		ДанныеПодписиейСУчетомДоверенностей.Добавить(ДанныеПодписи);
		
	КонецЦикла;
	
	Возврат ДанныеПодписиейСУчетомДоверенностей;
	
КонецФункции

Процедура ИсключитьПодписиОтветногоТитула(ПодписиФайла, ПодписиОтветногоТитула)
	
	КлючиПодписейОтветногоТитула = Новый Соответствие;
	
	Для Каждого ДанныеПодписи Из ПодписиОтветногоТитула Цикл
		Ключ = КлючПодписиСДоверенностью(ДанныеПодписи);
		КлючиПодписейОтветногоТитула.Вставить(Ключ, Истина);
	КонецЦикла;
	
	Счетчик = 0;
	Пока Счетчик < ПодписиФайла.Количество() Цикл
		
		ДанныеПодписи = ПодписиФайла[Счетчик];
		Ключ = КлючПодписиСДоверенностью(ДанныеПодписи);
		Если КлючиПодписейОтветногоТитула[Ключ] = Истина Тогда
			ПодписиФайла.Удалить(Счетчик);
		Иначе
			Счетчик = Счетчик + 1;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция КлючПодписиСДоверенностью(ДанныеПодписи)
	
	Отпечаток = ДанныеПодписи.СвойстваПодписи.Отпечаток;
	
	Если ДанныеПодписи.ЭтоПодписьПоДоверенности Тогда
		НомерДоверенности = ДанныеПодписи.СвойстваДоверенности.НомерДоверенности;
	Иначе
		НомерДоверенности = УникальныйИдентификаторПустой();
	КонецЕсли;
	
	Возврат СтрШаблон("%1_%2", Отпечаток, НомерДоверенности);
	
КонецФункции

#КонецОбласти

#Область СпискиДокументовЭДО

#Область ДокументыИсходящие

Функция ТекстЗапросаИсходящихДокументовЭДО()
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	СостояниеДокументовПоЭДОСрезПоследних.ДокументДО,
		|	СостояниеДокументовПоЭДОСрезПоследних.СостояниеВерсииДокументаПоЭДО КАК Состояние
		|ПОМЕСТИТЬ ДокументыИсходящие
		|ИЗ
		|	РегистрСведений.СостояниеДокументовПоЭДО.СрезПоследних(,
		|		НаправлениеЭД = ЗНАЧЕНИЕ(Перечисление.НаправленияЭДО.Исходящий)) КАК СостояниеДокументовПоЭДОСрезПоследних
		|ГДЕ
		|	СостояниеДокументовПоЭДОСрезПоследних.СостояниеВерсииДокументаПоЭДО В (&СостоянияДляСписка)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	ДокументыИсходящие.ДокументДО,
		|	ДокументыИсходящие.Состояние,
		|	ДокументыДО.Организация,
		|	ДокументыДО.Контрагент,
		|	ДокументыДО.ВидДокумента,
		|	ЕСТЬNULL(СоставПакетовЭДОДокументооборот.ИдентификаторПакета, &ПустойИдентификатор) КАК ИдентификаторПакета
		|ПОМЕСТИТЬ ДокументыБезОтборов
		|ИЗ
		|	Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыИсходящие КАК ДокументыИсходящие
		|		ПО ДокументыИсходящие.ДокументДО = ДокументыДО.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоставПакетовЭДОДокументооборот КАК СоставПакетовЭДОДокументооборот
		|		ПО ДокументыДО.Ссылка = СоставПакетовЭДОДокументооборот.Документ
		|ГДЕ
		|	&ОтборОрганизации
		|	И &ОтборКонтрагента
		|	И Не ДокументыДО.ПометкаУдаления
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДокументыБезОтборов.ДокументДО,
		|	ДокументыБезОтборов.Организация,
		|	ДокументыБезОтборов.Контрагент,
		|	ДокументыБезОтборов.ВидДокумента,
		|	ДокументыБезОтборов.Состояние,
		|	ДокументыБезОтборов.ИдентификаторПакета
		|ПОМЕСТИТЬ ДокументыСОтборами
		|ИЗ
		|	ДокументыБезОтборов КАК ДокументыБезОтборов
		|ГДЕ
		|	&ОтборВидаДокумента
		|	И &ОтборСостояния
		|	И &ОтборТипаОбъектов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДокументыСОтборами.ИдентификаторПакета
		|ПОМЕСТИТЬ ПакетыСодержащиеДокументыСОтборами
		|ИЗ
		|	ДокументыСОтборами КАК ДокументыСОтборами
		|ГДЕ
		|	ДокументыСОтборами.ИдентификаторПакета <> &ПустойИдентификатор
		|СГРУППИРОВАТЬ ПО
		|	ДокументыСОтборами.ИдентификаторПакета
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДокументыСОтборами.ВидДокумента,
		|	ДокументыСОтборами.ДокументДО,
		|	ДокументыСОтборами.ИдентификаторПакета,
		|	ДокументыСОтборами.Контрагент,
		|	ДокументыСОтборами.Организация,
		|	ДокументыСОтборами.Состояние
		|ПОМЕСТИТЬ ОдиночныеДокументыСОтборами
		|ИЗ
		|	ДокументыСОтборами КАК ДокументыСОтборами
		|ГДЕ
		|	ДокументыСОтборами.ИдентификаторПакета = &ПустойИдентификатор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПакетыСодержащиеДокументыСОтборами.ИдентификаторПакета,
		|	ДокументыБезОтборов.ДокументДО,
		|	ДокументыБезОтборов.Организация,
		|	ДокументыБезОтборов.Контрагент,
		|	ДокументыБезОтборов.ВидДокумента,
		|	ДокументыБезОтборов.Состояние,
		|	ДокументыБезОтборов.Состояние <> ЗНАЧЕНИЕ(Перечисление.СостоянияЭДОДокументооборот.НеСформирован) КАК ПодписанЭП
		|ИЗ
		|	ПакетыСодержащиеДокументыСОтборами КАК ПакетыСодержащиеДокументыСОтборами
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументыБезОтборов КАК ДокументыБезОтборов
		|		ПО ПакетыСодержащиеДокументыСОтборами.ИдентификаторПакета = ДокументыБезОтборов.ИдентификаторПакета
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ОдиночныеДокументыСОтборами.ИдентификаторПакета,
		|	ОдиночныеДокументыСОтборами.ДокументДО,
		|	ОдиночныеДокументыСОтборами.Организация,
		|	ОдиночныеДокументыСОтборами.Контрагент,
		|	ОдиночныеДокументыСОтборами.ВидДокумента,
		|	ОдиночныеДокументыСОтборами.Состояние,
		|	ОдиночныеДокументыСОтборами.Состояние <> ЗНАЧЕНИЕ(Перечисление.СостоянияЭДОДокументооборот.НеСформирован)
		|ИЗ
		|	ОдиночныеДокументыСОтборами КАК ОдиночныеДокументыСОтборами";
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"%ИмяСправочникаДокументаДО%",
		ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ИмяСправочникаДокументовДО());
	
	Возврат ТекстЗапроса;
	
КонецФункции

Процедура УстановитьПараметрыЗапросаИсходящих(Запрос, Отбор)
	
	СостоянияДляСписка = Новый Массив;
	СостоянияДляСписка.Добавить(Перечисления.СостоянияЭДОДокументооборот.НеСформирован);
	СостоянияДляСписка.Добавить(Перечисления.СостоянияЭДОДокументооборот.Подписан);
	СостоянияДляСписка.Добавить(Перечисления.СостоянияЭДОДокументооборот.ПоставленВОчередьНаОтправку);
	СостоянияДляСписка.Добавить(Перечисления.СостоянияЭДОДокументооборот.ОжидаетсяОтправка);
	СостоянияДляСписка.Добавить(Перечисления.СостоянияЭДОДокументооборот.ОжидаетСозданияПакетаЭДО);
	
	Запрос.УстановитьПараметр("СостоянияДляСписка", СостоянияДляСписка);
	
	Если ТипЗнч(Отбор) = Тип("Структура")
		И Отбор.Свойство("Действия")
		И Отбор.Действия = "Подписание" Тогда
		
		СостоянияПоДействию = Новый Массив;
		СостоянияПоДействию.Добавить(Перечисления.СостоянияЭДОДокументооборот.НеСформирован);
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборСостояния",
			"ДокументыБезОтборов.Состояние В (&СостоянияПоДействию)");
		
		Запрос.УстановитьПараметр("СостоянияПоДействию", СостоянияПоДействию);
		
	ИначеЕсли ТипЗнч(Отбор) = Тип("Структура")
		И Отбор.Свойство("Действия")
		И Отбор.Действия = "Отправка" Тогда
		
		СостоянияПоДействию = Новый Массив;
		СостоянияПоДействию.Добавить(Перечисления.СостоянияЭДОДокументооборот.Подписан);
		СостоянияПоДействию.Добавить(Перечисления.СостоянияЭДОДокументооборот.ПоставленВОчередьНаОтправку);
		СостоянияПоДействию.Добавить(Перечисления.СостоянияЭДОДокументооборот.ОжидаетсяОтправка);
		СостоянияПоДействию.Добавить(Перечисления.СостоянияЭДОДокументооборот.ОжидаетСозданияПакетаЭДО);
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборСостояния",
			"ДокументыБезОтборов.Состояние В (&СостоянияПоДействию)");
		
		Запрос.УстановитьПараметр("СостоянияПоДействию", СостоянияПоДействию);
		
	Иначе
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборСостояния",
			"Истина");
		
	КонецЕсли;
	
	Если ТипЗнч(Отбор) = Тип("Структура")
		И Отбор.Свойство("Организация")
		И ЗначениеЗаполнено(Отбор.Организация) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборОрганизации",
			"ДокументыДО.Организация = &Организация");
		
		Запрос.УстановитьПараметр("Организация", Отбор.Организация);
		
	Иначе
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборОрганизации",
			"Истина");
		
	КонецЕсли;
	
	Если ТипЗнч(Отбор) = Тип("Структура")
		И Отбор.Свойство("Контрагент")
		И ЗначениеЗаполнено(Отбор.Контрагент) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборКонтрагента",
			"ДокументыДО.Контрагент = &Контрагент");
		
		Запрос.УстановитьПараметр("Контрагент", Отбор.Контрагент);
		
	Иначе
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборКонтрагента",
			"Истина");
		
	КонецЕсли;
	
	Если ТипЗнч(Отбор) = Тип("Структура")
		И Отбор.Свойство("ВидДокумента")
		И ЗначениеЗаполнено(Отбор.ВидДокумента) Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборВидаДокумента",
			"ДокументыБезОтборов.ВидДокумента = &ВидДокумента");
		
		Запрос.УстановитьПараметр("ВидДокумента", Отбор.ВидДокумента);
		
	Иначе
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборВидаДокумента",
			"Истина");
		
	КонецЕсли;
	
	Если ТипЗнч(Отбор) = Тип("Структура")
		И Отбор.Свойство("Объекты")
		И Отбор.Объекты = "Документы" Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборТипаОбъектов",
			"ДокументыБезОтборов.ИдентификаторПакета = &ПустойИдентификатор");
		
		Запрос.УстановитьПараметр("ПустойИдентификатор", УникальныйИдентификаторПустой());
		
	ИначеЕсли ТипЗнч(Отбор) = Тип("Структура")
		И Отбор.Свойство("Объекты")
		И Отбор.Объекты = "Пакеты" Тогда
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборТипаОбъектов",
			"ДокументыБезОтборов.ИдентификаторПакета <> &ПустойИдентификатор");
		
		Запрос.УстановитьПараметр("ПустойИдентификатор", УникальныйИдентификаторПустой());
		
	Иначе
		
		Запрос.Текст = СтрЗаменить(Запрос.Текст,
			"&ОтборТипаОбъектов",
			"Истина");
		
		Запрос.УстановитьПараметр("ПустойИдентификатор", УникальныйИдентификаторПустой());
		
	КонецЕсли;
	
КонецПроцедуры

Функция ДанныеВыделенныхОбъектов(ДанныеВыделенныхСтрок)
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Пакеты", Новый Соответствие);
	СтруктураВозврата.Вставить("Документы", Новый Соответствие);
	
	ПакетыВыделенные = Новый Соответствие;
	ДокументыВыделенные = Новый Соответствие;
	
	Для Каждого ДанныеСтроки Из ДанныеВыделенныхСтрок Цикл
		Если ЗначениеЗаполнено(ДанныеСтроки.ИдентификаторПакета) Тогда
			ПакетыВыделенные.Вставить(ДанныеСтроки.ИдентификаторПакета, Истина);
		Иначе
			ДокументыВыделенные.Вставить(ДанныеСтроки.Документ, Истина)
		КонецЕсли;
	КонецЦикла;
	
	УникальныеПакеты = Новый Массив;
	УникальныеДокументы = Новый Массив;
	
	Для Каждого Элемент Из ПакетыВыделенные Цикл
		УникальныеПакеты.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Для Каждого Элемент Из ДокументыВыделенные Цикл
		УникальныеДокументы.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапросаДанныхВыбранныхИсходящихДокументов();
	Запрос.УстановитьПараметр("Пакеты", УникальныеПакеты);
	Запрос.УстановитьПараметр("Документы", УникальныеДокументы);
	
	МассивРезультатов = Запрос.ВыполнитьПакет();
	КолвоПакетов = МассивРезультатов.Количество();
	
	ВыборкаДокументов = МассивРезультатов[КолвоПакетов - 4].Выбрать();
	ВыборкаСостояний = МассивРезультатов[КолвоПакетов - 3].Выбрать();
	ВыборкаФайлов = МассивРезультатов[КолвоПакетов - 2].Выбрать();
	ВыборкаОрганизацийИКонтрагентов = МассивРезультатов[КолвоПакетов - 1].Выбрать();
	
	ДанныеПоДокументам = Новый Соответствие;
	
	Пока ВыборкаСостояний.Следующий() Цикл
		
		ДанныеДокумента = ДанныеПоДокументам.Получить(ВыборкаСостояний.Документ);
		
		Если ДанныеДокумента = Неопределено Тогда
			ДанныеДокумента = НовыеДанныеДокументаСпискаИсходящих();
			ДанныеПоДокументам.Вставить(ВыборкаСостояний.Документ, ДанныеДокумента);
		КонецЕсли;
		
		ДанныеДокумента.Состояние = ВыборкаСостояний.Состояние;
		
	КонецЦикла;
	
	Пока ВыборкаФайлов.Следующий() Цикл
		
		Если Не ЗначениеЗаполнено(ВыборкаФайлов.Файл) Тогда
			Продолжить;
		КонецЕсли;
		
		ДанныеДокумента = ДанныеПоДокументам.Получить(ВыборкаФайлов.Документ);
		
		Если ДанныеДокумента = Неопределено Тогда
			ДанныеДокумента = НовыеДанныеДокументаСпискаИсходящих();
			ДанныеПоДокументам.Вставить(ВыборкаФайлов.Документ, ДанныеДокумента);
		КонецЕсли;
		
		ДанныеФайла = Новый Структура;
		ДанныеФайла.Вставить("Файл", ВыборкаФайлов.Файл);
		ДанныеФайла.Вставить("Расширение", ВыборкаФайлов.Расширение);
		
		ДанныеДокумента.Файлы.Добавить(ДанныеФайла);
		
	КонецЦикла;
	
	Пока ВыборкаОрганизацийИКонтрагентов.Следующий() Цикл
		
		ДанныеДокумента = ДанныеПоДокументам.Получить(ВыборкаОрганизацийИКонтрагентов.Документ);
		
		Если ДанныеДокумента = Неопределено Тогда
			ДанныеДокумента = НовыеДанныеДокументаСпискаИсходящих();
			ДанныеПоДокументам.Вставить(ВыборкаОрганизацийИКонтрагентов.Документ, ДанныеДокумента);
		КонецЕсли;
		
		ДанныеДокумента.Организация = ВыборкаОрганизацийИКонтрагентов.Организация;
		ДанныеДокумента.Контрагент = ВыборкаОрганизацийИКонтрагентов.Контрагент;
		
	КонецЦикла;
	
	СпособыОбмена = СпособыОбменаЭДОПоДокументамДО(УникальныеДокументы);
	
	Для Каждого Элемент Из СпособыОбмена Цикл
		
		Документ = Элемент.Ключ;
		СпособОбмена = Элемент.Значение;
		
		ДанныеДокумента = ДанныеПоДокументам.Получить(Документ);
		
		Если ДанныеДокумента = Неопределено Тогда
			ДанныеДокумента = НовыеДанныеДокументаСпискаИсходящих();
			ДанныеПоДокументам.Вставить(ВыборкаОрганизацийИКонтрагентов.Документ, ДанныеДокумента);
		КонецЕсли;
		
		ДанныеДокумента.СпособОбмена = СпособОбмена;
		
	КонецЦикла;
	
	Пока ВыборкаДокументов.Следующий() Цикл
		
		Если Не ЗначениеЗаполнено(ВыборкаДокументов.ИдентификаторПакета) Тогда
			
			СтруктураВозврата.Документы.Вставить(ВыборкаДокументов.Документ,
				ДанныеПоДокументам[ВыборкаДокументов.Документ]);
			
		Иначе
			
			ДокументыПакета = СтруктураВозврата.Пакеты.Получить(ВыборкаДокументов.ИдентификаторПакета);
			
			Если ДокументыПакета = Неопределено Тогда
				ДокументыПакета = Новый Соответствие;
				СтруктураВозврата.Пакеты.Вставить(ВыборкаДокументов.ИдентификаторПакета, ДокументыПакета);
			КонецЕсли;
			
			ДокументыПакета.Вставить(ВыборкаДокументов.Документ,
				ДанныеПоДокументам[ВыборкаДокументов.Документ]);
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат СтруктураВозврата;
	
КонецФункции

Функция НовыеДанныеДокументаСпискаИсходящих()
	
	ДанныеДокумента = Новый Структура;
	ДанныеДокумента.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	ДанныеДокумента.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
	ДанныеДокумента.Вставить("Состояние", Перечисления.СостоянияЭДОДокументооборот.ПустаяСсылка());
	ДанныеДокумента.Вставить("СпособОбмена", Перечисления.СпособыОбменаЭД.ПустаяСсылка());
	ДанныеДокумента.Вставить("Файлы", Новый Массив);
	
	Возврат ДанныеДокумента;
	
КонецФункции

Функция ТекстЗапросаДанныхВыбранныхИсходящихДокументов()
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	СоставПакетовЭДОДокументооборот.ИдентификаторПакета,
		|	ДокументыДО.ВидДокумента,
		|	СоставПакетовЭДОДокументооборот.Документ
		|ПОМЕСТИТЬ Документы
		|ИЗ
		|	РегистрСведений.СоставПакетовЭДОДокументооборот КАК СоставПакетовЭДОДокументооборот
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|		ПО СоставПакетовЭДОДокументооборот.Документ = ДокументыДО.Ссылка
		|ГДЕ
		|	СоставПакетовЭДОДокументооборот.ИдентификаторПакета В (&Пакеты)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	НЕОПРЕДЕЛЕНО,
		|	ДокументыДО.ВидДокумента,
		|	ДокументыДО.Ссылка
		|ИЗ
		|	Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|ГДЕ
		|	ДокументыДО.Ссылка В (&Документы)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Документы.Документ,
		|	ЕСТЬNULL(СостояниеДокументовПоЭДОСрезПоследних.СостояниеВерсииДокументаПоЭДО,
		|		ЗНАЧЕНИЕ(Перечисление.СостоянияЭДОДокументооборот.ПустаяСсылка)) КАК Состояние
		|ПОМЕСТИТЬ СостоянияДокументов
		|ИЗ
		|	Документы КАК Документы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостояниеДокументовПоЭДО.СрезПоследних КАК СостояниеДокументовПоЭДОСрезПоследних
		|		ПО Документы.Документ = СостояниеДокументовПоЭДОСрезПоследних.ДокументДО
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Документы.Документ,
		|	Файлы.Ссылка КАК Файл,
		|	ЕСТЬNULL(РолиФайловДокументов.Роль, ЗНАЧЕНИЕ(Справочник.РолиФайлов.ПустаяСсылка)) КАК РольФайла,
		|	Документы.ВидДокумента,
		|	Файлы.ТекущаяВерсия.Расширение КАК Расширение
		|ПОМЕСТИТЬ ФайлыДокументов
		|ИЗ
		|	Справочник.Файлы КАК Файлы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СлужебныеФайлыДокументов КАК СлужебныеФайлыДокументов
		|		ПО Файлы.Ссылка = СлужебныеФайлыДокументов.Файл
		|		ПРАВОЕ СОЕДИНЕНИЕ Документы КАК Документы
		|		ПО Файлы.ВладелецФайла = Документы.Документ
		|		И НЕ Файлы.ПометкаУдаления
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РолиФайловДокументов КАК РолиФайловДокументов
		|		ПО Файлы.Ссылка = РолиФайловДокументов.Файл
		|ГДЕ
		|	СлужебныеФайлыДокументов.Файл ЕСТЬ NULL
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ФайлыДокументов.Документ,
		|	ФайлыДокументов.Файл,
		|	ФайлыДокументов.Расширение
		|ПОМЕСТИТЬ ФайлыДокументовДляОтправки
		|ИЗ
		|	ФайлыДокументов КАК ФайлыДокументов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыДокументов.РолиФайлов КАК ВидыДокументовРолиФайлов
		|		ПО ФайлыДокументов.ВидДокумента = ВидыДокументовРолиФайлов.Ссылка
		|		И ФайлыДокументов.РольФайла = ВидыДокументовРолиФайлов.Роль
		|ГДЕ
		|	ВидыДокументовРолиФайлов.ФайлЭлектронногоДокумента
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ФайлыДокументов.Документ,
		|	ФайлыДокументов.Файл,
		|	ФайлыДокументов.Расширение
		|ИЗ
		|	ФайлыДокументов КАК ФайлыДокументов
		|ГДЕ
		|	ФайлыДокументов.РольФайла = ЗНАЧЕНИЕ(Справочник.РолиФайлов.ПустаяСсылка)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Документы.Документ,
		|	ДокументыДО.Организация,
		|	ДокументыДО.Контрагент
		|ПОМЕСТИТЬ ОрганизацииИКонтрагенты
		|ИЗ
		|	Документы КАК Документы
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|		ПО Документы.Документ = ДокументыДО.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Документы.ИдентификаторПакета,
		|	Документы.Документ
		|ИЗ
		|	Документы КАК Документы
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СостоянияДокументов.Документ,
		|	СостоянияДокументов.Состояние
		|ИЗ
		|	СостоянияДокументов КАК СостоянияДокументов
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ФайлыДокументовДляОтправки.Документ,
		|	ФайлыДокументовДляОтправки.Файл,
		|	ФайлыДокументовДляОтправки.Расширение
		|ИЗ
		|	ФайлыДокументовДляОтправки КАК ФайлыДокументовДляОтправки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ОрганизацииИКонтрагенты.Документ,
		|	ОрганизацииИКонтрагенты.Контрагент,
		|	ОрганизацииИКонтрагенты.Организация
		|ИЗ
		|	ОрганизацииИКонтрагенты КАК ОрганизацииИКонтрагенты";
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"%ИмяСправочникаДокументаДО%",
		ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ИмяСправочникаДокументовДО());
	
	Возврат ТекстЗапроса;
КонецФункции

Функция ДеревоФайловПоДаннымОбъектов(ДанныеОбъектов)
	
	ДеревоФайлов = Новый ДеревоЗначений;
	ДеревоФайлов.Колонки.Добавить("ИдентификаторПакета");
	ДеревоФайлов.Колонки.Добавить("Документ");
	ДеревоФайлов.Колонки.Добавить("Файл");
	ДеревоФайлов.Колонки.Добавить("ПодписанЭП");
	ДеревоФайлов.Колонки.Добавить("ИндексКартинкиЭП");
	ДеревоФайлов.Колонки.Добавить("ПредставлениеЭлемента");
	ДеревоФайлов.Колонки.Добавить("ИндексКартинкиФайла");
	
	ВыбранОдинПакет = (ДанныеОбъектов.Пакеты.Количество() = 1 И ДанныеОбъектов.Документы.Количество() = 0);
	
	// Если выбран один пакет, то обработка происходит иначе -- просто кидаем все данные в корень.
	Если ВыбранОдинПакет Тогда
		
		Для Каждого ЭлементПакета Из ДанныеОбъектов.Пакеты Цикл
			Для Каждого ЭлементДокумента Из ЭлементПакета.Значение Цикл
				Документ = ЭлементДокумента.Ключ;
				ДанныеДокумента = ЭлементДокумента.Значение;
				
				СтрокаДокумента = ДеревоФайлов.Строки.Добавить();
				
				ЗаполнитьДанныеСтрокиДереваДокумента(
					СтрокаДокумента, Документ, ДанныеДокумента, ЭлементПакета.Ключ);
			КонецЦикла;
		КонецЦикла;
		
		Возврат ДеревоФайлов;
		
	КонецЕсли;
	
	Для Каждого ЭлементПакета Из ДанныеОбъектов.Пакеты Цикл
		
		ИдентификаторПакета = ЭлементПакета.Ключ;
		ДокументыПакета = ЭлементПакета.Значение;
		
		СтрокаПакета = ДеревоФайлов.Строки.Добавить();
		
		СтрокаПакета.ИдентификаторПакета = ИдентификаторПакета;
		СтрокаПакета.ПредставлениеЭлемента = СтрШаблон(
			НСтр("ru = 'Пакет ЭДО (%1)'"),
			СтроковыеФункцииКлиентСервер.СтрокаСЧисломДляЛюбогоЯзыка(
				НСтр("ru = ';%1 документ;;%1 документа;%1 документов;%1 документов'"),
				ДокументыПакета.Количество()));
		
		ИндексКартинкиЭППакета = Неопределено;
		
		Для Каждого ЭлементДокумента Из ДокументыПакета Цикл
			
			Документ = ЭлементДокумента.Ключ;
			ДанныеДокумента = ЭлементДокумента.Значение;
			
			СтрокаДокумента = СтрокаПакета.Строки.Добавить();
			
			ЗаполнитьДанныеСтрокиДереваДокумента(
				СтрокаДокумента, Документ, ДанныеДокумента, ИдентификаторПакета);
			
			Если ИндексКартинкиЭППакета = Неопределено Тогда
				
				ИндексКартинкиЭППакета = СтрокаДокумента.ИндексКартинкиЭП;
				
			ИначеЕсли СтрокаДокумента.ИндексКартинкиЭП <> ИндексКартинкиЭППакета Тогда 
				
				ИндексКартинкиЭППакета = 1
				
			КонецЕсли;
			
		КонецЦикла;
		
		СтрокаПакета.ИндексКартинкиЭП = ИндексКартинкиЭППакета;
		СтрокаПакета.ПодписанЭП = (ИндексКартинкиЭППакета = 2);
		СтрокаПакета.ИндексКартинкиФайла = -1;
		
	КонецЦикла;
	
	Для Каждого ЭлементДокумента Из ДанныеОбъектов.Документы Цикл
		
		Документ = ЭлементДокумента.Ключ;
		ДанныеДокумента = ЭлементДокумента.Значение;
		
		СтрокаДокумента = ДеревоФайлов.Строки.Добавить();
		
		ЗаполнитьДанныеСтрокиДереваДокумента(
			СтрокаДокумента, Документ, ДанныеДокумента);
		
	КонецЦикла;
	
	Возврат ДеревоФайлов;
	
КонецФункции

Процедура ЗаполнитьДанныеСтрокиДереваДокумента(СтрокаДокумента, Документ,
	ДанныеДокумента, ИдентификаторПакета = Неопределено)
	
	СтрокаДокумента.ИдентификаторПакета = ИдентификаторПакета;
	СтрокаДокумента.Документ = Документ;
	СтрокаДокумента.ПодписанЭП =
		(ДанныеДокумента.Состояние <> Перечисления.СостоянияЭДОДокументооборот.НеСформирован);
	СтрокаДокумента.ИндексКартинкиЭП = ?(СтрокаДокумента.ПодписанЭП, 2, 0);
	
	Если ДанныеДокумента.Файлы.Количество() = 0 Тогда
		
		СтрокаДокумента.ПредставлениеЭлемента = СтрШаблон(
			НСтр("ru = '(нет файлов) %1'"),
			Документ);
		
		СтрокаДокумента.ИндексКартинкиФайла = -1;
		
	ИначеЕсли ДанныеДокумента.Файлы.Количество() > 1 Тогда
		
		СтрокаДокумента.ПредставлениеЭлемента = СтрШаблон(
			НСтр("ru = '(%2) %1'"),
			Документ,
			СтроковыеФункцииКлиентСервер.СтрокаСЧисломДляЛюбогоЯзыка(
				НСтр("ru = ';%1 файл;;%1 файла;%1 файлов;%1 файлов'"),
				ДанныеДокумента.Файлы.Количество()));
		
		СтрокаДокумента.ИндексКартинкиФайла = -1;
		
	Иначе
		
		ДанныеФайла = ДанныеДокумента.Файлы[0];
		
		СтрокаДокумента.ПредставлениеЭлемента = Строка(ДанныеФайла.Файл);
		
		СтрокаДокумента.Файл = ДанныеФайла.Файл;
		СтрокаДокумента.ИндексКартинкиФайла =
			ФайловыеФункцииКлиентСервер.ПолучитьИндексПиктограммыФайла(ДанныеФайла.Расширение);
		
	КонецЕсли;
	
КонецПроцедуры

Функция ОрганизацииИКонтрагентыВыбранныхДанныхОбъектов(ДанныеОбъектов)
	
	СтруктураВозврата = Новый Структура;
	СтруктураВозврата.Вставить("Организации", Новый Массив);
	СтруктураВозврата.Вставить("Контрагенты", Новый Массив);
	
	УникальныеОрганизации = Новый Соответствие;
	УникальныеКонтрагенты = Новый Соответствие;
	
	Для Каждого ЭлементПакета Из ДанныеОбъектов.Пакеты Цикл
		
		Для Каждого ЭлементДокумента Из ЭлементПакета.Значение Цикл
			
			ДанныеДокумента = ЭлементДокумента.Значение;
			
			Если УникальныеОрганизации[ДанныеДокумента.Организация] = Неопределено Тогда
				УникальныеОрганизации.Вставить(ДанныеДокумента.Организация, Истина);
			КонецЕсли;
			
			Если УникальныеКонтрагенты[ДанныеДокумента.Контрагент] = Неопределено Тогда
				УникальныеКонтрагенты.Вставить(ДанныеДокумента.Контрагент, Истина);
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЦикла;
	
	Для Каждого ЭлементДокумента Из ДанныеОбъектов.Документы Цикл
		
		ДанныеДокумента = ЭлементДокумента.Значение;
		
		Если УникальныеОрганизации[ДанныеДокумента.Организация] = Неопределено Тогда
			УникальныеОрганизации.Вставить(ДанныеДокумента.Организация, Истина);
		КонецЕсли;
		
		Если УникальныеКонтрагенты[ДанныеДокумента.Контрагент] = Неопределено Тогда
			УникальныеКонтрагенты.Вставить(ДанныеДокумента.Контрагент, Истина);
		КонецЕсли;
		
	КонецЦикла;
	
	Для Каждого Элемент Из УникальныеОрганизации Цикл
		СтруктураВозврата.Организации.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Для Каждого Элемент Из УникальныеКонтрагенты Цикл
		СтруктураВозврата.Контрагенты.Добавить(Элемент.Ключ);
	КонецЦикла;
	
	Возврат СтруктураВозврата;
	
КонецФункции

Функция ДоступныеДействияПоВыделеннымИсходящимОбъектам(ДанныеОбъектов, Организации, Контрагенты)
	
	ВозможныеДействия = ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ДействияСпискаИсходящихДокументов();
	ДоступныеДействия = Новый Соответствие;
	
	Если Организации.Количество() <> 1
		Или Контрагенты.Количество() <> 1 Тогда
		
		Возврат ДоступныеДействия;
	КонецЕсли;
	
	// Если в каком либо документе нет файлов или их больше 1, то действия нельзя выполнять вообще.
	Для Каждого ЭлементПакета Из ДанныеОбъектов.Пакеты Цикл
		ДокументыПакета = ЭлементПакета.Значение;
		
		Для Каждого ЭлементДокумента Из ДокументыПакета Цикл
			ДанныеДокумента = ЭлементДокумента.Значение;
			
			Если ДанныеДокумента.Файлы.Количество() = 0
				Или ДанныеДокумента.Файлы.Количество() > 1 Тогда
				
				Возврат ДоступныеДействия;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	Для Каждого ЭлементДокумента Из ДанныеОбъектов.Документы Цикл
		ДанныеДокумента = ЭлементДокумента.Значение;
		
		Если ДанныеДокумента.Файлы.Количество() = 0
			Или ДанныеДокумента.Файлы.Количество() > 1 Тогда
			
			Возврат ДоступныеДействия;
		КонецЕсли;
	КонецЦикла;
	
	Если ДанныеОбъектов.Пакеты.Количество() = 0
		И ДанныеОбъектов.Документы.Количество() > 0 Тогда
		
		ДоступныДействияСПакетом = Истина;
		
		Для Каждого Элемент Из ДанныеОбъектов.Документы Цикл
			
			ДанныеДокумента = Элемент.Значение;
			
			Если ДанныеДокумента.Состояние <> Перечисления.СостоянияЭДОДокументооборот.НеСформирован
				И ДанныеДокумента.Состояние <> Перечисления.СостоянияЭДОДокументооборот.Подписан
				И ДанныеДокумента.Состояние <> Перечисления.СостоянияЭДОДокументооборот.ОжидаетсяОтправка Тогда
				
				ДоступныДействияСПакетом = Ложь;
				Прервать;
			КонецЕсли;
			
			Если Не СпособОбменаПоддерживаетПакетнуюОбработку(ДанныеДокумента.СпособОбмена) Тогда
				ДоступныДействияСПакетом = Ложь;
				Прервать;
			КонецЕсли;
			
		КонецЦикла;
		
		Если ДоступныДействияСПакетом Тогда
			ДоступныеДействия.Вставить(ВозможныеДействия.СоздатьПакет, Истина);
			
			Если ДанныеОбъектов.Документы.Количество() = 1 Тогда
				
				ДоступныеДействия.Вставить(ВозможныеДействия.ДобавитьКПакету, Истина);
				
			КонецЕсли;
		КонецЕсли;
				
	ИначеЕсли ДанныеОбъектов.Документы.Количество() = 0
		И ДанныеОбъектов.Пакеты.Количество() = 1 Тогда
		
		ДоступноИзменениеСоставаПакета = Истина;
		
		Для Каждого ЭлементПакета Из ДанныеОбъектов.Пакеты Цикл
			
			ДокументыПакета = ЭлементПакета.Значение;
			
			Для Каждого ЭлементДокумента Из ДокументыПакета Цикл
				
				ДанныеДокумента = ЭлементДокумента.Значение;
				
				Если ДанныеДокумента.Состояние <> Перечисления.СостоянияЭДОДокументооборот.НеСформирован
					И ДанныеДокумента.Состояние <> Перечисления.СостоянияЭДОДокументооборот.Подписан
					И ДанныеДокумента.Состояние <> Перечисления.СостоянияЭДОДокументооборот.ОжидаетсяОтправка
					И ДанныеДокумента.Состояние <> Перечисления.СостоянияЭДОДокументооборот.ОжидаетСозданияПакетаЭДО Тогда
					
					ДоступноИзменениеСоставаПакета = Ложь;
					Прервать;
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЦикла;
		
		Если ДоступноИзменениеСоставаПакета Тогда
			ДоступныеДействия.Вставить(ВозможныеДействия.ИзменитьСоставПакета, Истина);
		КонецЕсли;
		
	КонецЕсли;
	
	Для Каждого ЭлементПакета Из ДанныеОбъектов.Пакеты Цикл
		
		Для Каждого ЭлементДокумента Из ЭлементПакета.Значение Цикл
			
			ДанныеДокумента = ЭлементДокумента.Значение;
			
			Если ДанныеДокумента.Состояние = Перечисления.СостоянияЭДОДокументооборот.НеСформирован Тогда
				
				ДоступныеДействия.Вставить(ВозможныеДействия.Подписать, Истина);
				ДоступныеДействия.Вставить(ВозможныеДействия.Отправить, Истина);
				
				Прервать;
				
			ИначеЕсли ДанныеДокумента.Состояние = Перечисления.СостоянияЭДОДокументооборот.Подписан
				Или ДанныеДокумента.Состояние
					= Перечисления.СостоянияЭДОДокументооборот.ОжидаетСозданияПакетаЭДО
				Или ДанныеДокумента.Состояние 
					= Перечисления.СостоянияЭДОДокументооборот.ПоставленВОчередьНаОтправку
				Или ДанныеДокумента.Состояние 
					= Перечисления.СостоянияЭДОДокументооборот.ОжидаетсяОтправка Тогда
				
				ДоступныеДействия.Вставить(ВозможныеДействия.Отправить, Истина);
			КонецЕсли;
			
		КонецЦикла;
		
		Если ДоступныеДействия[ВозможныеДействия.Подписать] <> Неопределено Тогда
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	Для Каждого ЭлементДокумента Из ДанныеОбъектов.Документы Цикл
		
		Если ДоступныеДействия[ВозможныеДействия.Подписать] <> Неопределено Тогда
			Прервать;
		КонецЕсли;
		
		ДанныеДокумента = ЭлементДокумента.Значение;
		
		Если ДанныеДокумента.Состояние = Перечисления.СостоянияЭДОДокументооборот.НеСформирован Тогда
			
			ДоступныеДействия.Вставить(ВозможныеДействия.Подписать, Истина);
			ДоступныеДействия.Вставить(ВозможныеДействия.Отправить, Истина);
			
			Прервать;
			
		ИначеЕсли ДанныеДокумента.Состояние = Перечисления.СостоянияЭДОДокументооборот.Подписан
			Или ДанныеДокумента.Состояние
				= Перечисления.СостоянияЭДОДокументооборот.ОжидаетСозданияПакетаЭДО
			Или ДанныеДокумента.Состояние 
				= Перечисления.СостоянияЭДОДокументооборот.ПоставленВОчередьНаОтправку
			Или ДанныеДокумента.Состояние 
				= Перечисления.СостоянияЭДОДокументооборот.ОжидаетсяОтправка Тогда
			
			ДоступныеДействия.Вставить(ВозможныеДействия.Отправить, Истина);
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ДоступныеДействия;
	
КонецФункции

#КонецОбласти

#Область ДокументыВходящие

Функция ДанныеВыделенногоВходящегоДокумента(ДокументЭДО)
	
	ДанныеДокумента = НовыеДанныеВыделенногоВходящегоЭДО();
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапросаДанныхВыделенногоВходящего();
	Запрос.УстановитьПараметр("ЭлектронныйДокумент", ДокументЭДО);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	КолвоРезультатов = РезультатыЗапроса.Количество();
	
	ВыборкаДокументовПакета = РезультатыЗапроса[КолвоРезультатов - 2].Выбрать();
	ВыборкаДанныхДокумента = РезультатыЗапроса[КолвоРезультатов - 1].Выбрать();
	
	Если Не ВыборкаДанныхДокумента.Следующий() Тогда
		Возврат ДанныеДокумента;
	КонецЕсли;
	
	ДанныеДокумента.ДокументЭДО = ВыборкаДанныхДокумента.ДокументЭДО;
	ДанныеДокумента.Организация = ВыборкаДанныхДокумента.Организация;
	ДанныеДокумента.Контрагент = ВыборкаДанныхДокумента.Контрагент;
	ДанныеДокумента.ВидДокумента = ВыборкаДанныхДокумента.ВидДокумента;
	ДанныеДокумента.Номер = ВыборкаДанныхДокумента.Номер;
	ДанныеДокумента.Дата = ВыборкаДанныхДокумента.Дата;
	ДанныеДокумента.ТребуетсяОтветнаяПодпись = ВыборкаДанныхДокумента.ТребуетсяПодтверждение;
	ДанныеДокумента.ФайлЭДО = ВыборкаДанныхДокумента.ФайлЭДО;
	ДанныеДокумента.РасширениеФайла = ВыборкаДанныхДокумента.РасширениеФайла;
	ДанныеДокумента.ОписаниеОшибкиАвтосоздания = ВыборкаДанныхДокумента.ОписаниеОшибкиСоздания;
	ДанныеДокумента.ОжидаетАвтоматическогоСоздания = ВыборкаДанныхДокумента.ОжидаетАвтоматическогоСоздания;
	
	Пока ВыборкаДокументовПакета.Следующий() Цикл
		
		ДанныеДокументаПакета = Новый Структура;
		ДанныеДокументаПакета.Вставить("ВидДокумента", ВыборкаДокументовПакета.ВидДокумента);
		ДанныеДокументаПакета.Вставить("Номер", ВыборкаДокументовПакета.Номер);
		ДанныеДокументаПакета.Вставить("Дата", ВыборкаДокументовПакета.Дата);
		
		ДанныеДокумента.ДанныеДокументовПакета.Вставить(
			ВыборкаДокументовПакета.ЭлектронныйДокумент, ДанныеДокументаПакета);
		
	КонецЦикла;
	
	Возврат ДанныеДокумента;
	
КонецФункции

// Возвращает новые данные выделенного входящего документа ЭДО для отражения в ДО
// 
// Возвращаемое значение:
//  Структура - Данные выделенного входящего документа:
//    * ДокументЭДО - ДокументСсылка.ЭлектронныйДокументВходящийЭДО
//    * Организация - СправочникСсылка.Организации
//    * Контрагент - СправочникСсылка.Контрагенты
//    * ВидДокумента - СправочникСсылка.ВидыДокументовЭДО
//    * Номер - Строка
//    * Дата - Дата
//    * ТребуетсяОтветнаяПодпись - Булево
//    * ФайлЭДО - СправочникСсылка.СообщениеЭДОПрисоединенныеФайлы - Ссылка на файл информации отправителя
//    * РасширениеФайла - Строка
//    * ОписаниеОшибкиАвтосоздания - Строка - Описание ошибки, если была попытка создать файл автоматически,
//                                            но завершилась неудачей. Если ошибок нет, то пустая строка
//    * ОжидаетАвтоматическогоСоздания - Булево - Стоит в очереди для создания по правилам в регламентном задании
//    * ДанныеДокументовПакета - Соответствие Из КлючИЗначение:
//      ** Ключ - ДокументСсылка.ЭлектронныйДокументВходящийЭДО - Другой документ пакета
//      ** Значение - Структура:
//        *** ВидДокумента - СправочникСсылка.ВидыДокументовЭДО
//        *** Номер - Строка
//        *** Дата - Дата
//
Функция НовыеДанныеВыделенногоВходящегоЭДО()
	
	ДанныеДокумента = Новый Структура;
	ДанныеДокумента.Вставить("ДокументЭДО", Документы.ЭлектронныйДокументВходящийЭДО.ПустаяСсылка());
	ДанныеДокумента.Вставить("Организация", Справочники.Организации.ПустаяСсылка());
	ДанныеДокумента.Вставить("Контрагент", Справочники.Контрагенты.ПустаяСсылка());
	ДанныеДокумента.Вставить("ВидДокумента", Справочники.ВидыДокументовЭДО.ПустаяСсылка());
	ДанныеДокумента.Вставить("Номер", "");
	ДанныеДокумента.Вставить("Дата", Дата(1, 1, 1));
	ДанныеДокумента.Вставить("ТребуетсяОтветнаяПодпись", Ложь);
	ДанныеДокумента.Вставить("ФайлЭДО", Справочники.СообщениеЭДОПрисоединенныеФайлы.ПустаяСсылка());
	ДанныеДокумента.Вставить("РасширениеФайла", "");
	ДанныеДокумента.Вставить("ОписаниеОшибкиАвтосоздания", "");
	ДанныеДокумента.Вставить("ОжидаетАвтоматическогоСоздания", Ложь);
	
	ДанныеДокумента.Вставить("ДанныеДокументовПакета", Новый Соответствие);
	
	Возврат ДанныеДокумента;
	
КонецФункции

Функция ТекстЗапросаДанныхВыделенногоВходящего()
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ЭлектронныйДокументВходящийЭДО.Ссылка КАК ДокументЭДО,
		|	ЭлектронныйДокументВходящийЭДО.Организация,
		|	ЭлектронныйДокументВходящийЭДО.Контрагент,
		|	ЭлектронныйДокументВходящийЭДО.ВидДокумента,
		|	ЭлектронныйДокументВходящийЭДО.ТребуетсяПодтверждение,
		|	СообщениеЭДОПрисоединенныеФайлы.Ссылка КАК ФайлЭДО,
		|	СообщениеЭДОПрисоединенныеФайлы.Расширение КАК РасширениеФайла,
		|	СоставПакетовДокументовЭДО.ИдентификаторПакета,
		|	ЭлектронныйДокументВходящийЭДО.НомерДокумента,
		|	ЭлектронныйДокументВходящийЭДО.ДатаДокумента
		|ПОМЕСТИТЬ ДанныеДокумента
		|ИЗ
		|	Документ.СообщениеЭДО КАК СообщениеЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументВходящийЭДО КАК ЭлектронныйДокументВходящийЭДО
		|		ПО СообщениеЭДО.ЭлектронныйДокумент = ЭлектронныйДокументВходящийЭДО.Ссылка
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СообщениеЭДОПрисоединенныеФайлы КАК СообщениеЭДОПрисоединенныеФайлы
		|		ПО СообщениеЭДО.ОсновнойФайл = СообщениеЭДОПрисоединенныеФайлы.Ссылка
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоставПакетовДокументовЭДО КАК СоставПакетовДокументовЭДО
		|		ПО СообщениеЭДО.ЭлектронныйДокумент = СоставПакетовДокументовЭДО.ЭлектронныйДокумент
		|ГДЕ
		|	ЭлектронныйДокументВходящийЭДО.Ссылка = &ЭлектронныйДокумент
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СоставПакетовДокументовЭДО.ЭлектронныйДокумент,
		|	ЭлектронныйДокументВходящийЭДО.ВидДокумента,
		|	ЭлектронныйДокументВходящийЭДО.НомерДокумента КАК Номер,
		|	ЭлектронныйДокументВходящийЭДО.ДатаДокумента КАК Дата
		|ИЗ
		|	РегистрСведений.СоставПакетовДокументовЭДО КАК СоставПакетовДокументовЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДанныеДокумента КАК ДанныеДокумента
		|		ПО СоставПакетовДокументовЭДО.ИдентификаторПакета = ДанныеДокумента.ИдентификаторПакета
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументВходящийЭДО КАК ЭлектронныйДокументВходящийЭДО
		|		ПО СоставПакетовДокументовЭДО.ЭлектронныйДокумент = ЭлектронныйДокументВходящийЭДО.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДанныеДокумента.ДокументЭДО,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.ВидДокумента,
		|	ДанныеДокумента.ТребуетсяПодтверждение,
		|	ДанныеДокумента.ФайлЭДО,
		|	ДанныеДокумента.РасширениеФайла,
		|	ДанныеДокумента.НомерДокумента КАК Номер,
		|	ДанныеДокумента.ДатаДокумента КАК Дата,
		|	ЕСТЬNULL(ОшибкиЭДОКИсправлению.ОписаниеПроблемы, """") КАК ОписаниеОшибкиСоздания,
		|	ЕСТЬNULL(ДокументыЭДОКСозданиюВДО.АвтоматическоеСоздание, Ложь) КАК ОжидаетАвтоматическогоСоздания
		|ИЗ
		|	ДанныеДокумента КАК ДанныеДокумента
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОшибкиЭДОКИсправлению КАК ОшибкиЭДОКИсправлению
		|		ПО ДанныеДокумента.ДокументЭДО = ОшибкиЭДОКИсправлению.ПредметОшибки
		|		ЛЕВОЕ соединение РегистрСведений.ДокументыЭДОКСозданиюВДО КАК ДокументыЭДОКСозданиюВДО
		|		ПО ДокументыЭДОКСозданиюВДО.ДокументЭДО = ДанныеДокумента.ДокументЭДО";
	
	Возврат ТекстЗапроса;
	
КонецФункции

#КонецОбласти

#КонецОбласти

Функция СпособыОбменаЭДОПоДокументамДО(ДокументыДО)
	
	СпособыОбмена = Новый Соответствие;
	
	Для Каждого Документ Из ДокументыДО Цикл
		СпособыОбмена.Вставить(Документ, Перечисления.СпособыОбменаЭД.ПустаяСсылка());
	КонецЦикла;
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	Файлы.ВладелецФайла КАК Документ,
		|	ОбъектыУчетаДокументовЭДО.ЭлектронныйДокумент
		|ПОМЕСТИТЬ СуществующиеДокументыЭДО
		|ИЗ
		|	Справочник.Файлы КАК Файлы
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СлужебныеФайлыДокументов КАК СлужебныеФайлыДокументов
		|		ПО Файлы.Ссылка = СлужебныеФайлыДокументов.Файл
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОбъектыУчетаДокументовЭДО КАК ОбъектыУчетаДокументовЭДО
		|		ПО (Файлы.ТекущаяВерсия = ОбъектыУчетаДокументовЭДО.ОбъектУчета
		|		И ОбъектыУчетаДокументовЭДО.Актуальный)
		|ГДЕ
		|	СлужебныеФайлыДокументов.Файл ЕСТЬ NULL
		|	И Файлы.ВладелецФайла В (&Документы)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДокументыДО.Ссылка КАК Документ,
		|	НастройкиОтправкиДокументовПоЭДО.Отправитель,
		|	НастройкиОтправкиДокументовПоЭДО.Получатель,
		|	НастройкиОтправкиДокументовПоЭДО.ВидДокументаЭДО
		|ПОМЕСТИТЬ ВидыДокументовЭДОДокументов
		|ИЗ
		|	Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиОтправкиДокументовПоЭДО КАК НастройкиОтправкиДокументовПоЭДО
		|		ПО ДокументыДО.Организация = НастройкиОтправкиДокументовПоЭДО.Отправитель
		|		И ДокументыДО.Контрагент = НастройкиОтправкиДокументовПоЭДО.Получатель
		|		И ДокументыДО.ВидДокумента = НастройкиОтправкиДокументовПоЭДО.ВидДокумента
		|ГДЕ
		|	ДокументыДО.Ссылка В (&Документы)
		|	И НастройкиОтправкиДокументовПоЭДО.Отправлять
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВидыДокументовЭДОДокументов.Документ,
		|	НастройкиОтправкиЭлектронныхДокументовПоВидам.СпособОбменаЭД КАК СпособОбмена
		|ИЗ
		|	ВидыДокументовЭДОДокументов КАК ВидыДокументовЭДОДокументов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиОтправкиЭлектронныхДокументовПоВидам КАК
		|			НастройкиОтправкиЭлектронныхДокументовПоВидам
		|		ПО ВидыДокументовЭДОДокументов.Отправитель = НастройкиОтправкиЭлектронныхДокументовПоВидам.Отправитель
		|		И ВидыДокументовЭДОДокументов.Получатель = НастройкиОтправкиЭлектронныхДокументовПоВидам.Получатель
		|		И ВидыДокументовЭДОДокументов.ВидДокументаЭДО <> ЗНАЧЕНИЕ(Справочник.ВидыДокументовЭДО.ПустаяСсылка)
		|		И ВидыДокументовЭДОДокументов.ВидДокументаЭДО = НастройкиОтправкиЭлектронныхДокументовПоВидам.ВидДокумента
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВидыДокументовЭДОДокументов.Документ,
		|	НастройкиОтправкиЭлектронныхДокументовПоВидам.СпособОбменаЭД
		|ИЗ
		|	ВидыДокументовЭДОДокументов КАК ВидыДокументовЭДОДокументов
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.НастройкиОтправкиЭлектронныхДокументовПоВидам КАК
		|			НастройкиОтправкиЭлектронныхДокументовПоВидам
		|		ПО ВидыДокументовЭДОДокументов.Отправитель = НастройкиОтправкиЭлектронныхДокументовПоВидам.Отправитель
		|		И ВидыДокументовЭДОДокументов.Получатель = НастройкиОтправкиЭлектронныхДокументовПоВидам.Получатель
		|		И ВидыДокументовЭДОДокументов.ВидДокументаЭДО = ЗНАЧЕНИЕ(Справочник.ВидыДокументовЭДО.ПустаяСсылка)
		|		И НастройкиОтправкиЭлектронныхДокументовПоВидам.ВидДокумента = &ВидДокументаПрочее
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СуществующиеДокументыЭДО.Документ,
		|	ЭлектронныйДокументВходящийЭДО.СпособОбмена,
		|	NULL
		|ИЗ
		|	СуществующиеДокументыЭДО КАК СуществующиеДокументыЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументВходящийЭДО КАК ЭлектронныйДокументВходящийЭДО
		|		ПО СуществующиеДокументыЭДО.ЭлектронныйДокумент = ЭлектронныйДокументВходящийЭДО.Ссылка
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	СуществующиеДокументыЭДО.Документ,
		|	NULL,
		|	ЭлектронныйДокументИсходящийЭДО.СпособОбмена
		|ИЗ
		|	СуществующиеДокументыЭДО КАК СуществующиеДокументыЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЭлектронныйДокументИсходящийЭДО КАК ЭлектронныйДокументИсходящийЭДО
		|		ПО СуществующиеДокументыЭДО.ЭлектронныйДокумент = ЭлектронныйДокументИсходящийЭДО.Ссылка";
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"%ИмяСправочникаДокументаДО%",
		ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ИмяСправочникаДокументовДО());
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("Документы", ДокументыДО);
	Запрос.УстановитьПараметр("ВидДокументаПрочее",
		ЭлектронныеДокументыЭДО.ВидДокументаПоТипу(Перечисления.ТипыДокументовЭДО.Прочее));
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	КолвоРезультатов = РезультатыЗапроса.Количество();
	
	ВыборкаПоНастройкамОтправки = РезультатыЗапроса[КолвоРезультатов - 2].Выбрать();
	ВыборкаПоСуществующимДокументамЭДО = РезультатыЗапроса[КолвоРезультатов - 1].Выбрать();
	
	Пока ВыборкаПоНастройкамОтправки.Следующий() Цикл
		Если ЗначениеЗаполнено(ВыборкаПоНастройкамОтправки.СпособОбмена) Тогда
			СпособыОбмена.Вставить(ВыборкаПоНастройкамОтправки.Документ,
				ВыборкаПоНастройкамОтправки.СпособОбмена);
		КонецЕсли;
	КонецЦикла;
	
	Пока ВыборкаПоСуществующимДокументамЭДО.Следующий() Цикл
		Если ЗначениеЗаполнено(ВыборкаПоСуществующимДокументамЭДО.СпособОбмена) Тогда
			СпособыОбмена.Вставить(ВыборкаПоСуществующимДокументамЭДО.Документ,
				ВыборкаПоСуществующимДокументамЭДО.СпособОбмена);
		КонецЕсли;
	КонецЦикла;
	
	Возврат СпособыОбмена;
	
КонецФункции

#Область ОтражениеДокументовВДО

#Область ОперацииПослеСозданияДокументаДО

Процедура СоздатьФайлыОтраженияВходящегоЭДО(КонтекстОтражения)
	
	ДокументДО = КонтекстОтражения.ДокументДО;
	ДокументЭДО = КонтекстОтражения.ДокументЭДО;
	
	Если КонтекстОтражения.ФайлыДляСоздания.Количество() = 0 Тогда
		ОписаниеПроблемы = СтрШаблон(
			НСтр("ru = 'При отражении входящего документа ЭДО %1 не переданы файлы для отражения в 1С:Документооборот.'"),
			ДокументЭДО);
		
		ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
		Возврат;
	КонецЕсли;
	
	РолиФайловПоПриоритету = РолиФайловДляОтраженияВходящегоЭДО(КонтекстОтражения);
	ТекущийИндексРоли = 0;
	
	Для Каждого ФайлКСозданию Из КонтекстОтражения.ФайлыДляСоздания Цикл
		
		ЗаполнитьРольФайлаПриОтраженииЭДО(ФайлКСозданию, РолиФайловПоПриоритету, ТекущийИндексРоли);
		
		Попытка
			ФайлДО = РаботаСФайламиВызовСервера.СоздатьФайлСВерсией(ДокументДО, ФайлКСозданию.СведенияОФайле);
		Исключение
			ОписаниеПроблемы =
				НСтр("ru = 'Не удалось записать файл 1С:Документооборот по причине:'")
				+ Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			
			ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
			Возврат;
		КонецПопытки;
		
		ВерсияФайлаДО = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ФайлДО, "ТекущаяВерсия");
		
		ЗанестиИнформациюОПодписяхФайлаДО(ФайлДО, ФайлКСозданию.ЭлектронныеПодписи, КонтекстОтражения);
		Если КонтекстОтражения.Отказ Тогда
			Возврат;
		КонецЕсли;
		
		Попытка
			ИнтеграцияЭДО.УстановитьСвязьЭлектронногоДокументаСОбъектомУчета(ДокументЭДО, ВерсияФайлаДО);
		Исключение
			ОписаниеПроблемы =
				НСтр("ru = 'Не удалось установить связь документа ЭДО с документом 1С:Документооборот по причине:'")
				+ Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			
			ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
			Возврат;
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗанестиИнформациюОПодписяхФайлаДО(ФайлДО, ЭлектронныеПодписи, КонтекстОтражения)
	
	ДокументЭДО = КонтекстОтражения.ДокументЭДО;
	
	Если ЭлектронныеПодписи.Количество() > 0 Тогда
		
		ИдентификаторыПодписей = Новый Массив;
		Для Каждого СвойстваПодписи Из ЭлектронныеПодписи Цикл
			ИдентификаторыПодписей.Добавить(СвойстваПодписи.ИдентификаторПодписи);
		КонецЦикла;
		
		ДанныеДоверенностей = РаботаСЭПЛокализация.ДанныеДоверенностейПодписей(ИдентификаторыПодписей);
		
		СведенияОПодписях = Новый Массив;
		
		Для Каждого СвойстваПодписи Из ЭлектронныеПодписи Цикл
			ДанныеДоверенности = ДанныеДоверенностей[СвойстваПодписи.ИдентификаторПодписи];
			
			Если ТипЗнч(ДанныеДоверенности) = Тип("Структура")
				И ЗначениеЗаполнено(ДанныеДоверенности.Доверенность) Тогда
				
				СвойстваПодписи.Вставить("Доверенность", ДанныеДоверенности.Доверенность);
			КонецЕсли;
			
			СведенияОПодписях.Добавить(
				Новый Структура("ПодписанныйОбъект, СвойстваПодписи", ФайлДО, СвойстваПодписи));
		КонецЦикла;
		
		Попытка
			РаботаСЭП.ЗанестиИнформациюОПодписях(СведенияОПодписях);
		Исключение
			ОписаниеПроблемы =
				НСтр("ru = 'Не удалось записать электронные подписи файла 1С:Документооборот по причине:'")
				+ Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			
			ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
			Возврат;
		КонецПопытки;
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ОтразитьСозданиеДокументаВоВходящемПакетеЭДО(КонтекстОтражения)
	
	ДокументДО = КонтекстОтражения.ДокументДО;
	ДокументЭДО = КонтекстОтражения.ДокументЭДО;
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапросаПакетовЭДОВходящегоДокумента();
	Запрос.УстановитьПараметр("ЭлектронныйДокумент", ДокументЭДО);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	КолвоРезультатов =РезультатыЗапроса.Количество();
	ВыборкаПоСуществующимПакетам = РезультатыЗапроса[КолвоРезультатов - 2].Выбрать();
	ВыборкаДанныхПакетаБЭД = РезультатыЗапроса[КолвоРезультатов - 1].Выбрать();
	
	// Если имеются данные по существующему пакету, то просто добавляем документ к нему.
	Если ВыборкаПоСуществующимПакетам.Следующий() Тогда
		
		Попытка
			ДобавитьДокуметДОКВходящемуПакетуПриОтражении(
				ДокументДО, ВыборкаПоСуществующимПакетам.ИдентификаторПакета);
		Исключение
			ОписаниеПроблемы = НСтр("ru = 'Не удалось добавить созданы документ к входящему пакету ЭДО по причине:'")
				+ Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			
			ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
		КонецПопытки;
		
		Возврат;
		
	КонецЕсли;
	
	// Если данных по существующему пакету нет, но имеются данные по пакету БЭД,
	//  то пакет нужно создать и добавить к нему документ
	Если ВыборкаДанныхПакетаБЭД.Следующий() Тогда
		
		Попытка
			ИДПакетаДО = СоздатьВходящийПакетЭДО(
				ВыборкаДанныхПакетаБЭД.Организация,
				ВыборкаДанныхПакетаБЭД.Контрагент,
				ВыборкаДанныхПакетаБЭД.ИдентификаторПакета);
			ДобавитьДокуметДОКВходящемуПакетуПриОтражении(ДокументДО, ИДПакетаДО);
		Исключение
			ОписаниеПроблемы = НСтр("ru = 'Не удалось создать входящий пакет ЭДО по причине:'")
				+ Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			
			ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
		КонецПопытки;
		
		Возврат;
		
	КонецЕсли;
	
КонецПроцедуры

Функция ТекстЗапросаПакетовЭДОВходящегоДокумента()
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	СоставПакетовДокументовЭДО.ИдентификаторПакета,
		|	ПакетыДокументовЭДО.Организация,
		|	ПакетыДокументовЭДО.Контрагент
		|ПОМЕСТИТЬ ДанныеПакетаБЭД
		|ИЗ
		|	РегистрСведений.СоставПакетовДокументовЭДО КАК СоставПакетовДокументовЭДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПакетыДокументовЭДО КАК ПакетыДокументовЭДО
		|		ПО СоставПакетовДокументовЭДО.ИдентификаторПакета = СоставПакетовДокументовЭДО.ИдентификаторПакета
		|ГДЕ
		|	СоставПакетовДокументовЭДО.ЭлектронныйДокумент = &ЭлектронныйДокумент
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДанныеПакетаБЭД.ИдентификаторПакета КАК ИдентификаторПакетаБЭД,
		|	ПакетыЭДОДокументооборот.ИдентификаторПакета КАК ИдентификаторПакета,
		|	ПакетыЭДОДокументооборот.Организация КАК Организация,
		|	ПакетыЭДОДокументооборот.Контрагент КАК Контрагент
		|ИЗ
		|	ДанныеПакетаБЭД КАК ДанныеПакетаБЭД
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПакетыЭДОДокументооборот КАК ПакетыЭДОДокументооборот
		|		ПО ДанныеПакетаБЭД.ИдентификаторПакета = ПакетыЭДОДокументооборот.ИдентификаторПакетаБЭД
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ДанныеПакетаБЭД.ИдентификаторПакета,
		|	ДанныеПакетаБЭД.Организация,
		|	ДанныеПакетаБЭД.Контрагент
		|ИЗ
		|	ДанныеПакетаБЭД КАК ДанныеПакетаБЭД";
	Возврат ТекстЗапроса;
	
КонецФункции

Процедура ДобавитьДокуметДОКВходящемуПакетуПриОтражении(ДокументДО, ИдентификаторПакета)
	
	Запись = РегистрыСведений.СоставПакетовЭДОДокументооборот.СоздатьМенеджерЗаписи();
	
	Запись.Документ = ДокументДО;
	Запись.ИдентификаторПакета = ИдентификаторПакета;
	
	Запись.Записать();
	
КонецПроцедуры

Функция СоздатьВходящийПакетЭДО(Организация, Контрагент, ИдентификаторПакетаБЭД)
	
	ИДПакетаДО = Новый УникальныйИдентификатор;
	
	Запись = РегистрыСведений.ПакетыЭДОДокументооборот.СоздатьМенеджерЗаписи();
	
	Запись.ИдентификаторПакета = ИДПакетаДО;
	Запись.Организация = Организация;
	Запись.Контрагент = Контрагент;
	Запись.ИдентификаторПакетаБЭД = ИдентификаторПакетаБЭД;
	Запись.Направление = Перечисления.НаправленияЭДО.Входящий;
	
	Запись.Записать();
	
	Возврат ИДПакетаДО;
	
КонецФункции

Процедура ОтметитьОтражениеВходящегоЭДОВДО(КонтекстОтражения)
	
	ДокументЭДО = КонтекстОтражения.ДокументЭДО;
	ДокументДО = КонтекстОтражения.ДокументДО;
	
	Попытка
		РегистрыСведений.ДокументыЭДОКСозданиюВДО.УдалитьДокументИзСпискаКОтражению(ДокументЭДО);
	Исключение
		ОписаниеПроблемы = НСтр("ru = 'Не удалось удалить документ ЭДО из списка к отражению в 1С:Документооборот по причине:'")
			+ Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
		Возврат;
	КонецПопытки;
	
	Попытка
		РегистрыСведений.ОшибкиЭДОКИсправлению.УдалитьЗаписьОбОшибке(ДокументЭДО);
	Исключение
		ОписаниеПроблемы = НСтр("ru = 'Не удалось удалить документ ЭДО из списка ошибок к исправлению по причине:'")
			+ Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
		Возврат;
	КонецПопытки;
	
	Если КонтекстОтражения.АвтоматическоеВыполнение Тогда
		Ответственный = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ДокументДО, "Ответственный");
		Если Не ЗначениеЗаполнено(Ответственный) Тогда
			
			Попытка
				РегистрыСведений.ПроверкаЗагруженныхДанных.УстановитьПризнакПроверки(ДокументДО, Ложь);
			Исключение
				ОписаниеПроблемы =
					НСтр("ru = 'Не удалось установить признак проверки созданного документа 1С:Документооборот по причине:'")
					+ Символы.ПС + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
				
				ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ДокументЭДО, Истина);
				Возврат;
			КонецПопытки;
			
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Возвращает массив ролей файлов отсортированных по приоритету заполнения
// 
// Параметры:
//  КонтекстОтражения - см. ОбменСКонтрагентамиДОСлужебныйКлиентСервер.НовыйКонтекстОтраженияДокументовВДО
// 
// Возвращаемое значение:
//  Массив из см. НовоеОписаниеРолиПоПриоритетуЗаполнения
//
Функция РолиФайловДляОтраженияВходящегоЭДО(КонтекстОтражения)
	
	РолиФайловПоПриоритетуЗапролнения = Новый Массив;
	
	ДокументДО = КонтекстОтражения.ДокументДО;
	
	ТекстЗапроса =
		"ВЫБРАТЬ
		|	ВидыДокументовРолиФайлов.Роль,
		|	ВидыДокументовРолиФайлов.Обязательная,
		|	ВидыДокументовРолиФайлов.ТолькоОдинФайл,
		|	ВидыДокументовРолиФайлов.ФайлЭлектронногоДокумента
		|ИЗ
		|	Справочник.%ИмяСправочникаДокументаДО% КАК ДокументыДО
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ВидыДокументов.РолиФайлов КАК ВидыДокументовРолиФайлов
		|		ПО ВидыДокументовРолиФайлов.Ссылка = ДокументыДО.ВидДокумента
		|ГДЕ
		|	ДокументыДО.Ссылка = &ДокументДО";
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,
		"%ИмяСправочникаДокументаДО%",
		ОбменСКонтрагентамиДОСлужебныйКлиентСервер.ИмяСправочникаДокументовДО());
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	Запрос.УстановитьПараметр("ДокументДО", ДокументДО);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		
		ПустаяРоль = НовоеОписаниеРолиПоПриоритетуЗаполнения();
		РолиФайловПоПриоритетуЗапролнения.Добавить(ПустаяРоль);
		
		Возврат РолиФайловПоПриоритетуЗапролнения;
		
	КонецЕсли;
	
	РольФайлаЭлектронногоДокумента = Справочники.РолиФайлов.ПустаяСсылка();
	РолиОбязательныеСЕдинственнымФайлом = Новый Массив;
	РолиОбязательныеСМножествомФайлов = Новый Массив;
	НеобязательныеРоли = Новый Массив;
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.ФайлЭлектронногоДокумента Тогда
			РольФайлаЭлектронногоДокумента = Выборка.Роль;
		ИначеЕсли Выборка.Обязательная И Выборка.ТолькоОдинФайл Тогда
			РолиОбязательныеСЕдинственнымФайлом.Добавить(Выборка.Роль);
		ИначеЕсли Выборка.Обязательная Тогда
			РолиОбязательныеСМножествомФайлов.Добавить(Выборка.Роль);
		Иначе
			НеобязательныеРоли.Добавить(Выборка.Роль);
		КонецЕсли;
		
	КонецЦикла;
	
	Если ЗначениеЗаполнено(РольФайлаЭлектронногоДокумента) Тогда
		
		ОписаниеРоли = НовоеОписаниеРолиПоПриоритетуЗаполнения();
		ОписаниеРоли.РольФайла = РольФайлаЭлектронногоДокумента;
		ОписаниеРоли.МожноДобавитьМногоФайлов = Ложь;
		
		РолиФайловПоПриоритетуЗапролнения.Добавить(ОписаниеРоли);
		
	КонецЕсли;
	
	Для Каждого Роль Из РолиОбязательныеСЕдинственнымФайлом Цикл
		
		ОписаниеРоли = НовоеОписаниеРолиПоПриоритетуЗаполнения();
		ОписаниеРоли.РольФайла = Роль;
		ОписаниеРоли.МожноДобавитьМногоФайлов = Ложь;
		
		РолиФайловПоПриоритетуЗапролнения.Добавить(ОписаниеРоли);
		
	КонецЦикла;
	
	Для Каждого Роль Из РолиОбязательныеСМножествомФайлов Цикл
		
		ОписаниеРоли = НовоеОписаниеРолиПоПриоритетуЗаполнения();
		ОписаниеРоли.РольФайла = Роль;
		ОписаниеРоли.МожноДобавитьМногоФайлов = Ложь;
		
		РолиФайловПоПриоритетуЗапролнения.Добавить(ОписаниеРоли);
		
	КонецЦикла;
	
	Если НеобязательныеРоли.Количество() > 0 Тогда
		
		ОписаниеРоли = НовоеОписаниеРолиПоПриоритетуЗаполнения();
		ОписаниеРоли.РольФайла = НеобязательныеРоли[0];
		ОписаниеРоли.МожноДобавитьМногоФайлов = Истина;
		
		РолиФайловПоПриоритетуЗапролнения.Добавить(ОписаниеРоли);
		
	ИначеЕсли РолиОбязательныеСМножествомФайлов.Количество() > 0 Тогда
		
		ОписаниеРоли = НовоеОписаниеРолиПоПриоритетуЗаполнения();
		ОписаниеРоли.РольФайла = НеобязательныеРоли[0];
		ОписаниеРоли.МожноДобавитьМногоФайлов = Истина;
		
		РолиФайловПоПриоритетуЗапролнения.Добавить(ОписаниеРоли);
		
	Иначе
		
		ОписаниеРоли = НовоеОписаниеРолиПоПриоритетуЗаполнения();
		РолиФайловПоПриоритетуЗапролнения.Добавить(ОписаниеРоли);
		
	КонецЕсли;
	
	Возврат РолиФайловПоПриоритетуЗапролнения;
	
КонецФункции

// Новое описание роли по приоритету заполнения.
// 
// Возвращаемое значение:
//  Структура - Новое описание роли по приоритету заполнения:
//    * РольФайла - СправочникСсылка.РолиФайлов
//    * МожноДобавитьМногоФайлов - Булево
Функция НовоеОписаниеРолиПоПриоритетуЗаполнения()
	
	ОписаниеРоли = Новый Структура;
	ОписаниеРоли.Вставить("РольФайла", Справочники.РолиФайлов.ПустаяСсылка());
	ОписаниеРоли.Вставить("МожноДобавитьМногоФайлов", Истина);
	
	Возврат ОписаниеРоли;
	
КонецФункции

// Заполняет роль файла при отражении входящего ЭДО
// 
// Параметры:
//  ФайлКСозданию см. ОбменСКонтрагентамиДОСлужебныйКлиентСервер.НовоеОписаниеФайлаДОДляСоздания
//  РолиФайловДляОтраженияВходящегоЭДО см. РолиФайловДляОтраженияВходящегоЭДО
//  ИндексПриоритетаРоли - Число
//
Процедура ЗаполнитьРольФайлаПриОтраженииЭДО(ФайлКСозданию, РолиФайловДляОтраженияВходящегоЭДО, ИндексПриоритетаРоли)
	
	Если ИндексПриоритетаРоли < 0
		Или ИндексПриоритетаРоли > РолиФайловДляОтраженияВходящегоЭДО.ВГраница() Тогда
			
		Возврат;
	КонецЕсли;
	
	ЗаполненнаяРоль = ФайлКСозданию.СведенияОФайле.РольФайла;
	ТекущееОписаниеРоли = РолиФайловДляОтраженияВходящегоЭДО[ИндексПриоритетаРоли];
	
	Если ЗначениеЗаполнено(ЗаполненнаяРоль) Тогда
		
		Если ЗаполненнаяРоль = ТекущееОписаниеРоли.РольФайла
			И Не ТекущееОписаниеРоли.МожноДобавитьМногоФайлов Тогда
			
			ИндексПриоритетаРоли = ИндексПриоритетаРоли + 1;
		КонецЕсли;
		
		Возврат;
		
	КонецЕсли;
	
	ФайлКСозданию.СведенияОФайле.РольФайла = ТекущееОписаниеРоли.РольФайла;
	
	Если Не ТекущееОписаниеРоли.МожноДобавитьМногоФайлов Тогда
		ИндексПриоритетаРоли = ИндексПриоритетаРоли + 1;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

Процедура ДобавитьОшибкуКонтекстаОтражения(КонтекстОтражения, ОписаниеПроблемы, ПредметОшибки, Критическая)
	
	Ошибка = ОбменСКонтрагентамиДОСлужебныйКлиентСервер.НоваяОшибкаКонтекстаОтражения();
	
	Ошибка.Описание = ОписаниеПроблемы;
	Ошибка.ПредметОшибки = ПредметОшибки;
	Ошибка.Критическая = Критическая;
	
	КонтекстОтражения.Ошибки.Добавить(Ошибка);
	
	Если Критическая = Истина Тогда
		КонтекстОтражения.Отказ = Истина;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ПереопределениеБЭД

Процедура ЗаполнитьДанныеРуководителя(Организация, ДанныеОрганизации)
	
	Если Не ЗначениеЗаполнено(Организация) Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ФизическиеЛица.Ссылка,
		|	ФизическиеЛица.Наименование,
		|	ФизическиеЛица.ДатаРождения
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ОтветственныеЛицаОрганизаций.СрезПоследних КАК
		|			ОтветственныеЛицаОрганизацийСрезПоследних
		|		ПО Сотрудники.Ссылка = ОтветственныеЛицаОрганизацийСрезПоследних.Сотрудник
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ФизическиеЛица КАК ФизическиеЛица
		|		ПО Сотрудники.Владелец = ФизическиеЛица.Ссылка
		|ГДЕ
		|	ОтветственныеЛицаОрганизацийСрезПоследних.Организация = &Организация
		|	И ОтветственныеЛицаОрганизацийСрезПоследних.ОтветственноеЛицо = &ОтветственноеЛицо";
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ОтветственноеЛицо", Перечисления.ОтветственныеЛицаОрганизаций.РуководительОрганизации);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Не Выборка.Следующий() Тогда
		Возврат;
	КонецЕсли;
	
	ЧастиИмени = ФизическиеЛицаКлиентСервер.ЧастиИмени(Выборка.Наименование);
	ДанныеОрганизации.Фамилия = ЧастиИмени.Фамилия;
	ДанныеОрганизации.Имя = ЧастиИмени.Имя;
	ДанныеОрганизации.Отчество = ЧастиИмени.Отчество;
	
	ДанныеОрганизации.РуководительФизЛицо = Выборка.Ссылка;
	ДанныеОрганизации.ДатаРождения = Выборка.ДатаРождения;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
