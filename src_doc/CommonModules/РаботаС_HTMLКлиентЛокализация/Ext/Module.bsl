////////////////////////////////////////////////////////////////////////////////
// Работа с HTML.
//
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс
// Обрабатывает ссылку 1С:Документооборота без схемы.
//
// Параметры:
//  Ссылка1СДокументооборота - Строка - Обрабатываемая ссылка.
//  Форма - ФормаКлиентскогоПриложения.
//  БазоваяНавигационнаяСсылка - Строка
//
Процедура ОбработатьСсылку1СДокументооборотаБезСхемы(Ссылка1СДокументооборота, Форма = Неопределено,
		БазоваяНавигационнаяСсылка = "", ТипСсылки) Экспорт

	// Локализация
	
	Если ТипСсылки = "share/" Тогда
		
		СсылкаДляСкачиванияДокумента = Ссылка1СДокументооборота;
		Если Не СтрНачинаетсяС(Ссылка1СДокументооборота, БазоваяНавигационнаяСсылка) Тогда
			СсылкаДляСкачиванияДокумента = СтрШаблон("%1%2", БазоваяНавигационнаяСсылка,
				Ссылка1СДокументооборота);
		КонецЕсли;
				
		Отказ = Ложь;
		ОписаниеОшибки = "";
		РезультатПоиска = ИнтеграцияShareДокументооборотВызовСервера.РезультатПоискаДокументаПоПубличнойСсылке(
			СсылкаДляСкачиванияДокумента, Отказ, ОписаниеОшибки);
		Если РезультатПоиска = Неопределено Тогда
			Если ЗначениеЗаполнено(ОписаниеОшибки) Тогда
				ИнтеграцияShareДокументооборотКлиент.ВывестиОписаниеОшибкиЗагрузки(ОписаниеОшибки,
					НСтр("ru = 'Ошибка поиска документа по ссылке.'"));
			КонецЕсли;	
			Возврат;
		КонецЕсли;
		
		ОписаниеЭлектронногоДокумента = РезультатПоиска.ОписаниеЭлектронногоДокумента;
		Если ОписаниеЭлектронногоДокумента = Неопределено Или Отказ Или ЗначениеЗаполнено(ОписаниеОшибки) Тогда
			Если ЗначениеЗаполнено(ОписаниеОшибки) Тогда
				ИнтеграцияShareДокументооборотКлиент.ВывестиОписаниеОшибкиЗагрузки(ОписаниеОшибки,
					НСтр("ru = 'Ошибка поиска документа по ссылке.'"));
			КонецЕсли;	
			Возврат;
		КонецЕсли;
		
		СсылкаНаОбъект = Неопределено;
		ПараметрыОтраженияВУчете = РезультатПоиска.НастройкиЗагрузки.ПараметрыОтраженияВУчете;
		Если ПараметрыОтраженияВУчете.Количество() > 0 Тогда
			СсылкаНаОбъект = ПараметрыОтраженияВУчете[0].СсылкаНаОбъектУчетаВБазе;
		КонецЕсли;
		Если ЗначениеЗаполнено(СсылкаНаОбъект) Тогда
			Если ОбщегоНазначенияСлужебныйКлиент.ЭтоНавигационнаяСсылка(СсылкаНаОбъект) Тогда
				ФайловаяСистемаКлиент.ОткрытьНавигационнуюСсылку(СсылкаНаОбъект);
			Иначе
				ПоказатьЗначение(, СсылкаНаОбъект);
			КонецЕсли;
			Возврат;
		КонецЕсли;
		
		Форма = ОткрытьФорму("Обработка.СервисShare.Форма.ЗагрузитьДокументПоСсылке");
		Форма.Заголовок = НСтр("ru = 'Загрузка документа из 1С:Share'");
		Форма.СсылкаДляСкачиванияДокумента = СсылкаДляСкачиванияДокумента;
		ЭлементыФормы = Форма.Элементы;
		ЭлементыФормы.СтраницыФормы.ТекущаяСтраница = ЭлементыФормы.СтраницаОжидания;
		
		Оповещение = Новый ОписаниеОповещения("ОбработатьРезультатПоискаДокументаПоПубличнойССылке", Форма);
		ИнтеграцияShareКлиент.ЗагрузитьЭлектронныйДокументПоИдентификаторуВФоне(ОписаниеЭлектронногоДокумента,
			Оповещение, Форма);
			
	КонецЕсли;
	// Локализация Конец
	
КонецПроцедуры

// Определяет тип ссылки 1С:Документооборота.
//
// Параметры:
//  Ссылка - Строка - Ссылка.
// 
// Возвращаемое значение:
//  Строка - Тип ссылки.
//
Функция ПриОпределенииТипаСсылки1СДокументооборота(Знач Ссылка) Экспорт
	
	// Локализация
	Если Не СтрНачинаетсяС(Ссылка, "api.whatsapp.com") И Не СтрНачинаетсяС(Ссылка, "t.me/share/url?url=")
			И ИнтеграцияShareКлиент.ЭтоДоменСервисаКороткихСсылокShare(Ссылка) Тогда
			
			Возврат "share/";
			
		Иначе
			
			Возврат "";
			
		КонецЕсли;
	// Локализация Конец
	
КонецФункции

// Проверяет, что ссылку можно обработать перед переходом
// 
// Параметры:
//  ТипСсылки - Строка
//  ПараметрыСсылки - Соответствие Из КлючИЗначение
// 
// Возвращаемое значение:
//  Булево - Ссылку можно обработать
//
Функция СсылкуМожноОбработать(ТипСсылки, ПараметрыСсылки) Экспорт
	
	// Локализация
	Возврат Не ИнтеграцияShareДокументооборотКлиент.ЭтоПереходПоСсылкеВБраузер(ПараметрыСсылки);
	// Локализация Конец

КонецФункции
	
#КонецОбласти
