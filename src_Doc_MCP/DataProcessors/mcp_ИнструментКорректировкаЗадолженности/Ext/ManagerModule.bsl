#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт
	
	ДобавитьИнструментКорректировкаЗадолженности(Инструменты);
	ДобавитьИнструментЗакрытиеЗаказаПоставщику(Инструменты);
	
КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт
	
	Попытка
		Если ИмяИнструмента = "create_debt_adjustment" Тогда
			Возврат СоздатьКорректировкуЗадолженности(Аргументы);
		ИначеЕсли ИмяИнструмента = "close_purchase_order" Тогда
			Возврат ЗакрытьЗаказПоставщику(Аргументы);
		Иначе
			Возврат СформироватьОтветСОшибкой("Неизвестный инструмент: " + ИмяИнструмента);
		КонецЕсли;
	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		СообщениеОшибки = СтрШаблон("Ошибка выполнения инструмента '%1': %2",
			ИмяИнструмента,
			ОписаниеОшибкиТекст);
		
		Попытка
			ЗаписьЖурналаРегистрации("MCP." + ИмяИнструмента, УровеньЖурналаРегистрации.Ошибка, , , 
				СообщениеОшибки + Символы.ПС + ПодробноеОписание);
		Исключение
			// Ошибка логирования не должна прерывать основной поток
			
		КонецПопытки;
		
		Возврат СформироватьОтветСОшибкой(СообщениеОшибки + Символы.ПС + ПодробноеОписание);
	КонецПопытки;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СформироватьОтветСОшибкой(ТекстОшибки)
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", "ОШИБКА: " + ТекстОшибки);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Ответ.Вставить("isError", Истина);
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

#Область ИнструментКорректировкаЗадолженности

Процедура ДобавитьИнструментКорректировкаЗадолженности(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	// Параметр organization - организация
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"organization",
		"string",
		"Организация (код, наименование или UUID). Обязательный параметр",
		,
		Истина
	));
	
	// Параметр partner - партнер
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"partner",
		"string",
		"Партнер (код, наименование или UUID). Обязательный параметр",
		,
		Истина
	));
	
	// Параметр contragent - контрагент (опциональный)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"contragent",
		"string",
		"Контрагент (код, наименование или UUID). Опциональный параметр. Если не указан, используется партнер.",
		,
		Ложь
	));
	
	// Параметр direction - тип расчетов (обязательный)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"direction",
		"string",
		"Тип расчетов: 'РасчетыСПоставщиком', 'РасчетыСКлиентом', 'РасчетыСКредитором', 'РасчетыСДебитором', 'РасчетыСАрендодателем'. Обязательный параметр",
		,
		Истина,
		"РасчетыСПоставщиком,РасчетыСКлиентом,РасчетыСКредитором,РасчетыСДебитором,РасчетыСАрендодателем"
	));
	
	// Параметр currency - валюта
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"currency",
		"string",
		"Валюта (код, наименование или UUID). Обязательный параметр",
		,
		Истина
	));
	
	// Параметр amount - сумма
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"amount",
		"number",
		"Сумма корректировки. Обязательный параметр",
		,
		Истина
	));
	
	// Параметр date - дата документа (опциональный)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"date",
		"string",
		"Дата документа в формате ISO (YYYY-MM-DD или YYYY-MM-DDTHH:mm:ss). По умолчанию текущая дата",
		,
		Ложь
	));
	
	// Параметр basis_selector - основание (заказ поставщику, обязательно)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"basis_selector",
		"string",
		"Идентификатор документа-основания (заказ поставщику): номер документа или UUID. Обязательный параметр",
		,
		Истина
	));
	
	// Параметр comment - комментарий (опциональный)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"comment",
		"string",
		"Комментарий к документу. Опциональный параметр",
		,
		Ложь
	));
	
	// Параметр format - формат результата
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"format",
		"string",
		"Формат результата: 'markdown' (удобочитаемые таблицы) или 'json' (структурированные данные). По умолчанию 'markdown'",
		"markdown",
		Ложь,
		"markdown,json"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	Описание = "Создание документа 'Корректировка задолженности' для корректировки расчетов с партнерами (поставщики, клиенты и др.)." + Символы.ПС + Символы.ПС
		+ "## Рекомендуемый порядок использования (ОБЯЗАТЕЛЬНО!)" + Символы.ПС
		+ "1. **ОБЯЗАТЕЛЬНО** сначала получить статус заказа через `get_purchase_order_status` для получения данных о партнере, организации, валюте и сумме" + Символы.ПС
		+ "2. Использовать **ТОЧНЫЕ значения** из ответа get_purchase_order_status:" + Символы.ПС
		+ "   - organization = поле 'Организация' из заголовка" + Символы.ПС
		+ "   - partner = поле 'Партнер' из заголовка" + Символы.ПС
		+ "   - currency = поле 'Валюта' из заголовка" + Символы.ПС
		+ "   - amount = поле 'КОплате' из СостояниеРасчетов (с обратным знаком, т.к. КОплате отрицательное)" + Символы.ПС
		+ "3. Затем вызвать `create_debt_adjustment` с полученными данными" + Символы.ПС + Символы.ПС
		+ "## Примеры использования" + Символы.ПС + Символы.ПС
		+ "### Пример 1: Закрытие заказа поставщику (проверенный рабочий пример)" + Символы.ПС
		+ "Данные из get_purchase_order_status для ПОУП-002064:" + Символы.ПС
		+ "- Организация: ПО ЭТП АО" + Символы.ПС
		+ "- Партнер: Zhongshan Shen DNP Technology Development Ltd." + Символы.ПС
		+ "- Валюта: руб." + Символы.ПС
		+ "- СуммаДокумента: 282205.78" + Символы.ПС
		+ "- КОплате (СостояниеРасчетов): -282205.78" + Символы.ПС + Символы.ПС
		+ "Вызов инструмента:" + Символы.ПС
		+ "```json" + Символы.ПС
		+ "{" + Символы.ПС
		+ "  ""organization"": ""ПО ЭТП АО""," + Символы.ПС
		+ "  ""partner"": ""Zhongshan Shen DNP Technology Development Ltd.""," + Символы.ПС
		+ "  ""direction"": ""РасчетыСПоставщиком""," + Символы.ПС
		+ "  ""currency"": ""руб.""," + Символы.ПС
		+ "  ""amount"": 282205.78," + Символы.ПС
		+ "  ""basis_selector"": ""ПОУП-002064""," + Символы.ПС
		+ "  ""comment"": ""Корректировка задолженности для закрытия заказа ПОУП-002064""" + Символы.ПС
		+ "}" + Символы.ПС
		+ "```" + Символы.ПС + Символы.ПС
		+ "### Пример 2: Минимальный набор параметров" + Символы.ПС
		+ "```json" + Символы.ПС
		+ "{" + Символы.ПС
		+ "  ""organization"": ""ПО ЭТП АО""," + Символы.ПС
		+ "  ""partner"": ""ООО Поставщик""," + Символы.ПС
		+ "  ""direction"": ""РасчетыСПоставщиком""," + Символы.ПС
		+ "  ""currency"": ""руб.""," + Символы.ПС
		+ "  ""amount"": 10000," + Символы.ПС
		+ "  ""basis_selector"": ""ПОУП-001234""" + Символы.ПС
		+ "}" + Символы.ПС
		+ "```" + Символы.ПС + Символы.ПС
		+ "## ВАЖНО: Допустимые значения параметров" + Символы.ПС + Символы.ПС
		+ "### direction (тип расчетов) - СТРОГО одно из значений:" + Символы.ПС
		+ "- `РасчетыСПоставщиком` - для расчетов с поставщиками (заказы поставщику)" + Символы.ПС
		+ "- `РасчетыСКлиентом` - для расчетов с клиентами" + Символы.ПС
		+ "- `РасчетыСКредитором` - для расчетов с кредиторами" + Символы.ПС
		+ "- `РасчетыСДебитором` - для расчетов с дебиторами" + Символы.ПС
		+ "- `РасчетыСАрендодателем` - для расчетов с арендодателями" + Символы.ПС + Символы.ПС
		+ "### currency (валюта) - примеры:" + Символы.ПС
		+ "- `руб.` - российский рубль (ВНИМАНИЕ: с точкой на конце!)" + Символы.ПС
		+ "- `USD` - доллар США" + Символы.ПС
		+ "- `EUR` - евро" + Символы.ПС
		+ "- `CNY` - китайский юань" + Символы.ПС + Символы.ПС
		+ "### basis_selector (основание) - форматы:" + Символы.ПС
		+ "- Номер заказа: `ПОУП-002064`" + Символы.ПС
		+ "- UUID заказа: `12345678-1234-1234-1234-123456789012`" + Символы.ПС + Символы.ПС
		+ "## Типичные ошибки и как их избежать" + Символы.ПС
		+ "1. **Неверное значение direction**: используйте ТОЧНО одно из допустимых значений (регистр НЕ важен, но написание важно!)" + Символы.ПС
		+ "2. **Валюта не найдена**: используйте наименование валюты из базы (например 'руб.' с точкой)" + Символы.ПС
		+ "3. **Партнер не найден**: используйте ПОЛНОЕ наименование партнера из get_purchase_order_status" + Символы.ПС
		+ "4. **Контрагент не найден**: система автоматически находит контрагента по партнеру, но если не найден - укажите явно через contragent" + Символы.ПС
		+ "5. **Сумма = 0**: Проверьте, что указана положительная сумма из СуммаДокумента или |КОплате|";
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"create_debt_adjustment",
		Описание,
		СхемаПараметров
	);
	
КонецПроцедуры

Функция СоздатьКорректировкуЗадолженности(Аргументы)
	
	Результат = Неопределено;
	УстановитьПривилегированныйРежим(Истина);
	Попытка
		
		// Преобразуем Соответствие в Структуру если нужно
		Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
			АргументыСтруктура = Новый Структура;
			Для Каждого КлючЗначение Из Аргументы Цикл
				АргументыСтруктура.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
			КонецЦикла;
			Аргументы = АргументыСтруктура;
		КонецЕсли;
		
		// Параметры
		ОрганизацияСелектор = ?(Аргументы.Свойство("organization"), Аргументы.organization, "");
		ПартнерСелектор = ?(Аргументы.Свойство("partner"), Аргументы.partner, "");
		КонтрагентСелектор = ?(Аргументы.Свойство("contragent"), Аргументы.contragent, "");
		Направление = ?(Аргументы.Свойство("direction"), Аргументы.direction, "");
		ВалютаСелектор = ?(Аргументы.Свойство("currency"), Аргументы.currency, "");
		Сумма = ?(Аргументы.Свойство("amount"), Аргументы.amount, 0);
		ДатаДокумента = ТекущаяДатаСеанса();
		Если Аргументы.Свойство("date") И ЗначениеЗаполнено(Аргументы.date) Тогда
			Попытка
				// Если уже дата - используем как есть
				Если ТипЗнч(Аргументы.date) = Тип("Дата") Тогда
					ДатаДокумента = Аргументы.date;
				Иначе
					// Пробуем ISO, затем стандартный парсер 1С
					Попытка
						ДатаДокумента = mcp_ОбщегоНазначения.ПреобразоватьДатуИзJSON(Аргументы.date);
						Если ДатаДокумента = Неопределено Тогда
							Результат = СформироватьОтветСОшибкой("Некорректный формат даты (date), ожидается ISO YYYY-MM-DD или YYYY-MM-DDTHH:mm:ss");
							УстановитьПривилегированныйРежим(Ложь);
							Возврат Результат;
						КонецЕсли;
					Исключение
						Попытка
							ДатаДокумента = Дата(Аргументы.date);
						Исключение
							Результат = СформироватьОтветСОшибкой("Некорректный формат даты (date), ожидается ISO YYYY-MM-DD или YYYY-MM-DDTHH:mm:ss");
							УстановитьПривилегированныйРежим(Ложь);
							Возврат Результат;
						КонецПопытки;
					КонецПопытки;
				КонецЕсли;
			Исключение
				Результат = СформироватьОтветСОшибкой("Некорректный формат даты (date), ожидается ISO YYYY-MM-DD или YYYY-MM-DDTHH:mm:ss");
				УстановитьПривилегированныйРежим(Ложь);
				Возврат Результат;
			КонецПопытки;
		КонецЕсли;
		ОснованиеСелектор = ?(Аргументы.Свойство("basis_selector"), Аргументы.basis_selector, "");
		Комментарий = ?(Аргументы.Свойство("comment"), Аргументы.comment, "");
		ФорматРезультата = ?(Аргументы.Свойство("format"), НРег(Аргументы.format), "markdown");
		
		Если ФОРМАТРЕЗУЛЬТАТА <> "markdown" И ФОРМАТРЕЗУЛЬТАТА <> "json" Тогда
			Результат = СформироватьОтветСОшибкой("Недопустимый формат результата. Допустимые значения: 'markdown', 'json'");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		// Валидация
		Если НЕ ЗначениеЗаполнено(ОрганизацияСелектор) Тогда
			Результат = СформироватьОтветСОшибкой("Не указана организация (organization)");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(ПартнерСелектор) Тогда
			Результат = СформироватьОтветСОшибкой("Не указан партнер (partner)");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(Направление) Тогда
			Результат = СформироватьОтветСОшибкой("Не указан тип расчетов (direction)");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(ВалютаСелектор) Тогда
			Результат = СформироватьОтветСОшибкой("Не указана валюта (currency)");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		Если Сумма = 0 Тогда
			Результат = СформироватьОтветСОшибкой("Сумма (amount) не может быть равна нулю");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(ОснованиеСелектор) Тогда
			Результат = СформироватьОтветСОшибкой("Не указано основание (basis_selector)");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		// Поиск ссылок
		ОрганизацияСсылка = НайтиОрганизацию(ОрганизацияСелектор);
		Если ОрганизацияСсылка = Неопределено Тогда
			Результат = СформироватьОтветСОшибкой("Организация не найдена: " + ОрганизацияСелектор);
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		ПартнерСсылка = НайтиПартнера(ПартнерСелектор);
		Если ПартнерСсылка = Неопределено Тогда
			Результат = СформироватьОтветСОшибкой("Партнер не найден: " + ПартнерСелектор);
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		КонтрагентСсылка = Неопределено;
		Если ЗначениеЗаполнено(КонтрагентСелектор) Тогда
			КонтрагентСсылка = НайтиКонтрагента(КонтрагентСелектор);
			Если КонтрагентСсылка = Неопределено Тогда
				Результат = СформироватьОтветСОшибкой("Контрагент не найден: " + КонтрагентСелектор);
				УстановитьПривилегированныйРежим(Ложь);
				Возврат Результат;
			КонецЕсли;
		Иначе
			// Пытаемся найти контрагента по реквизиту Партнер в справочнике контрагентов
			КонтрагентСсылка = НайтиКонтрагентаПоПартнеру(ПартнерСсылка);
			Если КонтрагентСсылка = Неопределено Тогда
				Результат = СформироватьОтветСОшибкой("Контрагент для партнера '" + ПартнерСсылка.Наименование + "' не найден. Укажите контрагента явно через параметр contragent");
				УстановитьПривилегированныйРежим(Ложь);
				Возврат Результат;
			КонецЕсли;
		КонецЕсли;
		
		ВалютаСсылка = НайтиВалюту(ВалютаСелектор);
		Если ВалютаСсылка = Неопределено Тогда
			Результат = СформироватьОтветСОшибкой("Валюта не найдена: " + ВалютаСелектор);
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		ТипРасчетов = ПреобразоватьНаправлениеВПеречисление(Направление);
		Если ТипРасчетов = Неопределено Тогда
			Результат = СформироватьОтветСОшибкой("Недопустимое значение direction: " + Направление + ". Допустимые: РасчетыСПоставщиком, РасчетыСКлиентом, РасчетыСКредитором, РасчетыСДебитором, РасчетыСАрендодателем");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		ОснованиеСсылка = НайтиЗаказПоставщику(ОснованиеСелектор);
		Если ОснованиеСсылка = Неопределено Тогда
			Результат = СформироватьОтветСОшибкой("Заказ поставщику не найден: " + ОснованиеСелектор);
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		ОбъектРасчетов = НайтиОбъектРасчетовПоЗаказу(ОснованиеСсылка);
		
		// Создание документа
		Попытка
			Документ = Документы.КорректировкаЗадолженности.СоздатьДокумент();
			Документ.Дата = ДатаДокумента;
			Документ.Организация = ОрганизацияСсылка;
			Документ.Контрагент = КонтрагентСсылка;
			Документ.Комментарий = Комментарий;
			
			Документ.Основание = ОснованиеСсылка;
			
			// Заполняем хозяйственную операцию в зависимости от знака суммы (кто кому должен)
			ХозОперация = ПолучитьХозяйственнуюОперацию(Сумма);
			Если ХозОперация <> Неопределено Тогда
				Документ.ХозяйственнаяОперация = ХозОперация;
			КонецЕсли;
			
			СтрокаЗадолженности = Документ.Задолженность.Добавить();
			СтрокаЗадолженности.ТипРасчетов = ТипРасчетов;
			СтрокаЗадолженности.Партнер = ПартнерСсылка;
			СтрокаЗадолженности.ВалютаВзаиморасчетов = ВалютаСсылка;
			СтрокаЗадолженности.Сумма = Сумма;
			СтрокаЗадолженности.ДатаПлатежа = ДатаДокумента;
			Если ОбъектРасчетов <> Неопределено Тогда
				СтрокаЗадолженности.ОбъектРасчетов = ОбъектРасчетов;
			КонецЕсли;
			
		// Заполняем табличную часть Доходы/Расходы/Активы/Пассивы
		СтатьяАктивовПассивов = ПолучитьСтатьюАктивовПассивов(ТипРасчетов, Сумма);
		Если СтатьяАктивовПассивов <> Неопределено Тогда
			СтрокаДоходовРасходов = Документ.ДоходыРасходыАктивыПассивы.Добавить();
			СтрокаДоходовРасходов.Статья = СтатьяАктивовПассивов;
			СтрокаДоходовРасходов.Валюта = ВалютаСсылка;
			СтрокаДоходовРасходов.Сумма = Сумма;
			// Для СтатьиАктивовПассивов аналитика - партнер
			СтрокаДоходовРасходов.АналитикаДоходов = ПартнерСсылка;
		КонецЕсли;
			
			Документ.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
			
			Если ФорматРезультата = "json" Тогда
				Результат = СформироватьJSONОтвет(Документ);
			Иначе
				Результат = СформироватьMarkdownОтвет(Документ);
			КонецЕсли;
			
		Исключение
			ИнформацияОбОшибке = ИнформацияОбОшибке();
			Результат = СформироватьОтветСОшибкой("Ошибка создания документа: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		КонецПопытки;
		
		// Выключаем привилегированный режим при успешном выполнении
		УстановитьПривилегированныйРежим(Ложь);
		
	Исключение
		// Выключаем привилегированный режим при ошибке
		УстановитьПривилегированныйРежим(Ложь);
		
		Если Результат = Неопределено Тогда
			ИнформацияОбОшибке = ИнформацияОбОшибке();
			Результат = СформироватьОтветСОшибкой("Ошибка выполнения инструмента: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		КонецЕсли;
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Находит организацию по селектору
Функция НайтиОрганизацию(Селектор)
	
	// Поиск по UUID
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			ОрганизацияСсылка = Справочники.Организации.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
			Если ЗначениеЗаполнено(ОрганизацияСсылка) Тогда
				Возврат ОрганизацияСсылка;
			КонецЕсли;
		Исключение
			// Не UUID - продолжаем
			
		КонецПопытки;
	КонецЕсли;
	
	// Поиск по ИНН
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Организации.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.Организации КАК Организации
			|ГДЕ
			|	Организации.ИНН = &ИНН";
		
		Запрос.УстановитьПараметр("ИНН", Селектор);
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса - продолжаем
		
	КонецПопытки;
	
	// Поиск по наименованию через запрос (точное совпадение, регистронезависимо)
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Организации.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.Организации КАК Организации
			|ГДЕ
			|	ВЕРХНИЙ(Организации.Наименование) = ВЕРХНИЙ(&Наименование)";
		
		Запрос.УстановитьПараметр("Наименование", Селектор);
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса - продолжаем
		
	КонецПопытки;
	
	// Поиск по наименованию через запрос (частичное совпадение, регистронезависимо)
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Организации.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.Организации КАК Организации
			|ГДЕ
			|	Организации.Наименование ПОДОБНО &Наименование
			|УПОРЯДОЧИТЬ ПО
			|	Организации.Наименование";
		
		Запрос.УстановитьПараметр("Наименование", "%" + Селектор + "%");
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса - возвращаем Неопределено
		
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Находит партнера по селектору
Функция НайтиПартнера(Селектор)
	
	// Поиск по UUID
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			ПартнерСсылка = Справочники.Партнеры.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
			Если ЗначениеЗаполнено(ПартнерСсылка) Тогда
				Возврат ПартнерСсылка;
			КонецЕсли;
		Исключение
			// Не UUID - продолжаем
			
		КонецПопытки;
	КонецЕсли;
	
	// Поиск по коду
	Попытка
		ПартнерСсылка = Справочники.Партнеры.НайтиПоКоду(Селектор);
		Если ЗначениеЗаполнено(ПартнерСсылка) Тогда
			Возврат ПартнерСсылка;
		КонецЕсли;
	Исключение
		// Код не найден - продолжаем
		
	КонецПопытки;
	
	// Поиск по наименованию (точное совпадение, регистронезависимо)
	ПартнерСсылка = Справочники.Партнеры.НайтиПоНаименованию(Селектор, Истина);
	Если ЗначениеЗаполнено(ПартнерСсылка) Тогда
		Возврат ПартнерСсылка;
	КонецЕсли;
	
	// Поиск по наименованию через запрос (частичное совпадение, регистронезависимо)
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Партнеры.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.Партнеры КАК Партнеры
			|ГДЕ
			|	Партнеры.Наименование ПОДОБНО &Наименование
			|УПОРЯДОЧИТЬ ПО
			|	Партнеры.Наименование";
		
		Запрос.УстановитьПараметр("Наименование", "%" + Селектор + "%");
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса - возвращаем Неопределено
		
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Находит контрагента по селектору
Функция НайтиКонтрагента(Селектор)
	
	// Поиск по UUID
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			КонтрагентСсылка = Справочники.Контрагенты.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
			Если ЗначениеЗаполнено(КонтрагентСсылка) Тогда
				Возврат КонтрагентСсылка;
			КонецЕсли;
		Исключение
			// Не UUID - продолжаем
			
		КонецПопытки;
	КонецЕсли;
	
	// Поиск по коду
	Попытка
		КонтрагентСсылка = Справочники.Контрагенты.НайтиПоКоду(Селектор);
		Если ЗначениеЗаполнено(КонтрагентСсылка) Тогда
			Возврат КонтрагентСсылка;
		КонецЕсли;
	Исключение
		// Код не найден - продолжаем
		
	КонецПопытки;
	
	// Поиск по наименованию (точное совпадение, регистронезависимо)
	КонтрагентСсылка = Справочники.Контрагенты.НайтиПоНаименованию(Селектор, Истина);
	Если ЗначениеЗаполнено(КонтрагентСсылка) Тогда
		Возврат КонтрагентСсылка;
	КонецЕсли;
	
	// Поиск по наименованию через запрос (частичное совпадение, регистронезависимо)
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Контрагенты.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.Контрагенты КАК Контрагенты
			|ГДЕ
			|	Контрагенты.Наименование ПОДОБНО &Наименование
			|УПОРЯДОЧИТЬ ПО
			|	Контрагенты.Наименование";
		
		Запрос.УстановитьПараметр("Наименование", "%" + Селектор + "%");
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса - возвращаем Неопределено
		
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Находит контрагента по реквизиту Партнер в справочнике контрагентов
Функция НайтиКонтрагентаПоПартнеру(ПартнерСсылка)
	
	Если НЕ ЗначениеЗаполнено(ПартнерСсылка) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Поиск контрагента по реквизиту Партнер (основной способ в ERP)
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Контрагенты.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.Контрагенты КАК Контрагенты
			|ГДЕ
			|	Контрагенты.Партнер = &Партнер
			|	И НЕ Контрагенты.ПометкаУдаления
			|УПОРЯДОЧИТЬ ПО
			|	Контрагенты.Наименование";
		
		Запрос.УстановитьПараметр("Партнер", ПартнерСсылка);
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса - возвращаем Неопределено
		
	КонецПопытки;
	
	// Если не нашли по реквизиту Партнер, пробуем по наименованию (fallback)
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Контрагенты.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.Контрагенты КАК Контрагенты
			|ГДЕ
			|	ВЕРХНИЙ(Контрагенты.Наименование) = ВЕРХНИЙ(&Наименование)
			|	И НЕ Контрагенты.ПометкаУдаления";
		
		Запрос.УстановитьПараметр("Наименование", ПартнерСсылка.Наименование);
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса - возвращаем Неопределено
		
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Находит валюту по селектору
// Порядок поиска: UUID -> Код -> Точное наименование -> Частичное наименование
Функция НайтиВалюту(Селектор)
	
	// Поиск по UUID
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			ВалютаСсылка = Справочники.Валюты.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
			Если ЗначениеЗаполнено(ВалютаСсылка) И НЕ ВалютаСсылка.ПустаяСсылка() Тогда
				Возврат ВалютаСсылка;
			КонецЕсли;
		Исключение
			// Не UUID - продолжаем
		КонецПопытки;
	КонецЕсли;
	
	// Поиск по коду (НайтиПоКоду возвращает пустую ссылку, если не найдено!)
	ВалютаСсылка = Справочники.Валюты.НайтиПоКоду(Селектор);
	Если ЗначениеЗаполнено(ВалютаСсылка) Тогда
		Возврат ВалютаСсылка;
	КонецЕсли;
	
	// Поиск по наименованию (точное совпадение)
	ВалютаСсылка = Справочники.Валюты.НайтиПоНаименованию(Селектор, Истина);
	Если ЗначениеЗаполнено(ВалютаСсылка) Тогда
		Возврат ВалютаСсылка;
	КонецЕсли;
	
	// Поиск по наименованию через запрос (частичное совпадение)
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	Валюты.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.Валюты КАК Валюты
			|ГДЕ
			|	Валюты.Наименование ПОДОБНО &Наименование
			|УПОРЯДОЧИТЬ ПО
			|	Валюты.Наименование";
		
		Запрос.УстановитьПараметр("Наименование", "%" + Селектор + "%");
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса - возвращаем Неопределено
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Преобразует строковое направление в перечисление ТипыРасчетовСПартнерами
Функция ПреобразоватьНаправлениеВПеречисление(Направление)
	
	Направление = НРег(Направление);
	
	Если Направление = НРег("РасчетыСПоставщиком") Тогда
		Возврат Перечисления.ТипыРасчетовСПартнерами.РасчетыСПоставщиком;
	ИначеЕсли Направление = НРег("РасчетыСКлиентом") Тогда
		Возврат Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом;
	ИначеЕсли Направление = НРег("РасчетыСКредитором") Тогда
		Возврат Перечисления.ТипыРасчетовСПартнерами.РасчетыСКредитором;
	ИначеЕсли Направление = НРег("РасчетыСДебитором") Тогда
		Возврат Перечисления.ТипыРасчетовСПартнерами.РасчетыСДебитором;
	ИначеЕсли Направление = НРег("РасчетыСАрендодателем") Тогда
		Возврат Перечисления.ТипыРасчетовСПартнерами.РасчетыСАрендодателем;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Находит заказ поставщику по селектору
Функция НайтиЗаказПоставщику(Селектор)
	
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			ЗаказСсылка = Документы.ЗаказПоставщику.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
			Если ЗначениеЗаполнено(ЗаказСсылка) Тогда
				Возврат ЗаказСсылка;
			КонецЕсли;
		Исключение
			// Не UUID - продолжаем
			
		КонецПопытки;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Док.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.ЗаказПоставщику КАК Док
		|ГДЕ
		|	Док.Номер ПОДОБНО &Номер
		|УПОРЯДОЧИТЬ ПО
		|	Док.Дата УБЫВ";
	
	Запрос.УстановитьПараметр("Номер", "%" + Селектор + "%");
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Находит объект расчетов по заказу поставщику
Функция НайтиОбъектРасчетовПоЗаказу(ЗаказСсылка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ОбъектыРасчетов.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.ОбъектыРасчетов КАК ОбъектыРасчетов
		|ГДЕ
		|	ОбъектыРасчетов.Объект = &Заказ
		|УПОРЯДОЧИТЬ ПО
		|	ОбъектыРасчетов.Дата УБЫВ";
	
	Запрос.УстановитьПараметр("Заказ", ЗаказСсылка);
	
	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Формирует JSON ответ
Функция СформироватьJSONОтвет(Документ)
	
	СтрокаЗадолженности = Документ.Задолженность[0];
	
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("number", Документ.Номер);
	Результат.Вставить("date", Формат(Документ.Дата, "ДФ=yyyy-MM-ddTHH:mm:ss"));
	Результат.Вставить("reference", Строка(Документ.Ссылка));
	Результат.Вставить("organization", Документ.Организация.Наименование);
	Результат.Вставить("partner", СтрокаЗадолженности.Партнер.Наименование);
	Результат.Вставить("amount", СтрокаЗадолженности.Сумма);
	Результат.Вставить("currency", СтрокаЗадолженности.ВалютаВзаиморасчетов.Наименование);
	Результат.Вставить("direction", Строка(СтрокаЗадолженности.ТипРасчетов));
	Результат.Вставить("message", "Документ 'Корректировка задолженности' создан и проведен");
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Результат);
	ТекстJSON = ЗаписьJSON.Закрыть();
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", ТекстJSON);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

// Получает хозяйственную операцию в зависимости от знака долга
// Цель - всегда списание, но тип зависит от того, кто кому должен
// Сумма > 0: мы должны контрагенту (кредиторская) → СписаниеКредиторскойЗадолженности
// Сумма < 0: контрагент должен нам (дебиторская) → СписаниеДебиторскойЗадолженности
Функция ПолучитьХозяйственнуюОперацию(Сумма)
	
	Если Сумма > 0 Тогда
		// Мы должны контрагенту - списываем кредиторскую задолженность (это наш доход)
		Возврат Перечисления.ХозяйственныеОперации.СписаниеКредиторскойЗадолженности;
	Иначе
		// Контрагент должен нам (переплата) - списываем дебиторскую задолженность (это наш расход)
		Возврат Перечисления.ХозяйственныеОперации.СписаниеДебиторскойЗадолженности;
	КонецЕсли;
	
КонецФункции

// Получает статью активов/пассивов для корректировки задолженности
// в зависимости от типа расчетов
// Для РасчетыСПоставщиком: "Задолженность перед поставщиками"
// Для РасчетыСКлиентом: "Задолженность клиентов"
// И т.д.
Функция ПолучитьСтатьюАктивовПассивов(ТипРасчетов, Сумма)
	
	// Определяем наименование статьи в зависимости от типа расчетов
	НаименованиеСтатьи = "";
	
	Если ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСПоставщиком Тогда
		// Для поставщика: мы должны (кредиторка) или нам должны (дебиторка-аванс)
		Если Сумма > 0 Тогда
			НаименованиеСтатьи = "Задолженность перед поставщиками";
		Иначе
			НаименованиеСтатьи = "Выданные авансы";
		КонецЕсли;
	ИначеЕсли ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКлиентом Тогда
		// Для клиента: нам должны (дебиторка) или мы должны (кредиторка-аванс)
		Если Сумма > 0 Тогда
			НаименованиеСтатьи = "Задолженность клиентов";
		Иначе
			НаименованиеСтатьи = "Полученные авансы";
		КонецЕсли;
	ИначеЕсли ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСКредитором Тогда
		НаименованиеСтатьи = "Задолженность перед поставщиками";
	ИначеЕсли ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСДебитором Тогда
		НаименованиеСтатьи = "Задолженность клиентов";
	ИначеЕсли ТипРасчетов = Перечисления.ТипыРасчетовСПартнерами.РасчетыСАрендодателем Тогда
		НаименованиеСтатьи = "Задолженность перед поставщиками";
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
	// Ищем статью в ПВХ СтатьиАктивовПассивов
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	СтатьиАктивовПассивов.Ссылка КАК Ссылка
			|ИЗ
			|	ПланВидовХарактеристик.СтатьиАктивовПассивов КАК СтатьиАктивовПассивов
			|ГДЕ
			|	СтатьиАктивовПассивов.Наименование = &Наименование
			|	И НЕ СтатьиАктивовПассивов.ПометкаУдаления";
		Запрос.УстановитьПараметр("Наименование", НаименованиеСтатьи);
		
		Результат = Запрос.Выполнить();
		Если НЕ Результат.Пустой() Тогда
			Выборка = Результат.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка - возвращаем Неопределено
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Формирует Markdown ответ
Функция СформироватьMarkdownОтвет(Документ)
	
	СтрокаЗадолженности = Документ.Задолженность[0];
	
	Текст = "# Корректировка задолженности создана" + Символы.ПС;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "| Параметр | Значение |" + Символы.ПС;
	Текст = Текст + "| --- | --- |" + Символы.ПС;
	Текст = Текст + "| Номер | **" + Документ.Номер + "** |" + Символы.ПС;
	Текст = Текст + "| Дата | " + Формат(Документ.Дата, "ДФ=dd.MM.yyyy HH:mm:ss") + " |" + Символы.ПС;
	Текст = Текст + "| Организация | " + Документ.Организация.Наименование + " |" + Символы.ПС;
	Текст = Текст + "| Партнер | " + СтрокаЗадолженности.Партнер.Наименование + " |" + Символы.ПС;
	Текст = Текст + "| Тип расчетов | " + Строка(СтрокаЗадолженности.ТипРасчетов) + " |" + Символы.ПС;
	Текст = Текст + "| Сумма | " + Формат(СтрокаЗадолженности.Сумма, "ЧДЦ=2") + " " + СтрокаЗадолженности.ВалютаВзаиморасчетов.Наименование + " |" + Символы.ПС;
	
	Если ЗначениеЗаполнено(Документ.Основание) Тогда
		Текст = Текст + "| Основание | " + Документ.Основание.Номер + " от " + Формат(Документ.Основание.Дата, "ДФ=dd.MM.yyyy") + " |" + Символы.ПС;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Документ.Комментарий) Тогда
		Текст = Текст + "| Комментарий | " + Документ.Комментарий + " |" + Символы.ПС;
	КонецЕсли;
	
	Текст = Текст + Символы.ПС;
	Текст = Текст + "**Документ создан и проведен.**" + Символы.ПС;
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", Текст);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

#КонецОбласти

#Область ИнструментЗакрытиеЗаказаПоставщику

Процедура ДобавитьИнструментЗакрытиеЗаказаПоставщику(Инструменты)
	
	МассивПараметров = Новый Массив;
	
	// Параметр selector - идентификатор заказа
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"selector",
		"string",
		"Идентификатор заказа поставщику: номер документа (например 'ПОУП-002064') или UUID. Обязательный параметр",
		,
		Истина
	));
	
	// Параметр cancel_reason - причина отмены (опциональный)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"cancel_reason",
		"string",
		"Причина отмены непоступивших строк (наименование из справочника ПричиныОтменыЗаказовПоставщикам). Опциональный параметр",
		,
		Ложь
	));
	
	// Параметр comment - комментарий (опциональный)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"comment",
		"string",
		"Комментарий к документу (добавляется к существующему). Опциональный параметр",
		,
		Ложь
	));
	
	// Параметр create_debt_adjustment - создать корректировку задолженности
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"create_debt_adjustment",
		"boolean",
		"Создать корректировку задолженности для списания долга (если КОплате <> 0). По умолчанию true",
		Истина,
		Ложь
	));
	
	// Параметр format - формат результата
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"format",
		"string",
		"Формат результата: 'markdown' или 'json'. По умолчанию 'markdown'",
		"markdown",
		Ложь,
		"markdown,json"
	));
	
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	Описание = "Полное закрытие заказа поставщику (аналог 'Помощника закрытия заказа'): анализ поступлений, разделение частично поступивших строк, отмена непоступивших, установка статуса 'Закрыт'." + Символы.ПС + Символы.ПС
		+ "## Что делает инструмент" + Символы.ПС
		+ "1. Находит заказ поставщику по номеру или UUID" + Символы.ПС
		+ "2. Анализирует фактические поступления по регистру ЗаказыПоставщикам" + Символы.ПС
		+ "3. Для каждой строки:" + Символы.ПС
		+ "   - Если ничего не поступило → отменяет строку целиком" + Символы.ПС
		+ "   - Если поступило частично → РАЗДЕЛЯЕТ строку (поступившая часть остается, непоступившая отменяется)" + Символы.ПС
		+ "4. Если есть непогашенный долг и create_debt_adjustment=true → создает корректировку задолженности" + Символы.ПС
		+ "5. Устанавливает статус 'Закрыт'" + Символы.ПС
		+ "6. Пересчитывает сумму документа и перепроводит" + Символы.ПС + Символы.ПС
		+ "## Пример использования" + Символы.ПС
		+ "```json" + Символы.ПС
		+ "{" + Символы.ПС
		+ "  ""selector"": ""ПОУП-002064""," + Символы.ПС
		+ "  ""comment"": ""Заказ закрыт по решению руководства""" + Символы.ПС
		+ "}" + Символы.ПС
		+ "```" + Символы.ПС + Символы.ПС
		+ "## Пример с частичным поступлением" + Символы.ПС
		+ "Если в заказе было 1000 шт, а поступило только 500:" + Символы.ПС
		+ "- Исходная строка: количество уменьшается до 500 (поступившие)" + Символы.ПС
		+ "- Новая строка: 500 шт с флагом Отменено=Истина" + Символы.ПС + Символы.ПС
		+ "## Важно" + Символы.ПС
		+ "- Инструмент работает аналогично типовому 'Помощнику закрытия заказа'" + Символы.ПС
		+ "- Автоматически определяет непоступившие количества по регистру заказов" + Символы.ПС
		+ "- Корректно обрабатывает частичные поступления с разделением строк" + Символы.ПС
		+ "- Если все строки уже поступили - просто устанавливает статус 'Закрыт'" + Символы.ПС
		+ "- Если долг уже погашен - корректировка задолженности не создается";
	
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"close_purchase_order",
		Описание,
		СхемаПараметров
	);
	
КонецПроцедуры

Функция ЗакрытьЗаказПоставщику(Аргументы)
	
	Результат = Неопределено;
	УстановитьПривилегированныйРежим(Истина);
	
	Попытка
		
		// Преобразуем Соответствие в Структуру если нужно
		Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
			АргументыСтруктура = Новый Структура;
			Для Каждого КлючЗначение Из Аргументы Цикл
				АргументыСтруктура.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
			КонецЦикла;
			Аргументы = АргументыСтруктура;
		КонецЕсли;
		
		// Параметры
		Селектор = ?(Аргументы.Свойство("selector"), Аргументы.selector, "");
		ПричинаОтменыСелектор = ?(Аргументы.Свойство("cancel_reason"), Аргументы.cancel_reason, "");
		Комментарий = ?(Аргументы.Свойство("comment"), Аргументы.comment, "");
		СоздатьКорректировку = ?(Аргументы.Свойство("create_debt_adjustment"), Аргументы.create_debt_adjustment, Истина);
		ФорматРезультата = ?(Аргументы.Свойство("format"), НРег(Аргументы.format), "markdown");
		
		Если НЕ ЗначениеЗаполнено(Селектор) Тогда
			Результат = СформироватьОтветСОшибкой("Не указан идентификатор заказа (selector)");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		// Находим заказ
		ЗаказСсылка = НайтиЗаказПоставщику(Селектор);
		Если ЗаказСсылка = Неопределено Тогда
			Результат = СформироватьОтветСОшибкой("Заказ поставщику не найден: " + Селектор);
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		// Проверяем, что заказ ещё не закрыт
		Если ЗаказСсылка.Статус = Перечисления.СтатусыЗаказовПоставщикам.Закрыт Тогда
			Результат = СформироватьОтветСОшибкой("Заказ " + ЗаказСсылка.Номер + " уже имеет статус 'Закрыт'");
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецЕсли;
		
		// Получаем остатки заказа (непоступившие строки)
		ОстаткиЗаказа = ПолучитьОстаткиЗаказаПоставщику(ЗаказСсылка);
		
		// Находим причину отмены если указана
		ПричинаОтменыСсылка = Неопределено;
		Если ЗначениеЗаполнено(ПричинаОтменыСелектор) Тогда
			ПричинаОтменыСсылка = НайтиПричинуОтмены(ПричинаОтменыСелектор);
		КонецЕсли;
		
		// Получаем состояние расчетов для корректировки задолженности
		СостояниеРасчетов = ПолучитьСостояниеРасчетовПоЗаказу(ЗаказСсылка);
		
		// Результат операции
		РезультатОперации = Новый Структура;
		РезультатОперации.Вставить("НомерЗаказа", ЗаказСсылка.Номер);
		РезультатОперации.Вставить("ДатаЗаказа", ЗаказСсылка.Дата);
		РезультатОперации.Вставить("Партнер", ЗаказСсылка.Партнер.Наименование);
		РезультатОперации.Вставить("Организация", ЗаказСсылка.Организация.Наименование);
		РезультатОперации.Вставить("СтрокОтменено", 0);
		РезультатОперации.Вставить("СтрокРазделено", 0);
		РезультатОперации.Вставить("КоличествоОтменено", 0);
		РезультатОперации.Вставить("СуммаОтмененных", 0);
		РезультатОперации.Вставить("КорректировкаСоздана", Ложь);
		РезультатОперации.Вставить("НомерКорректировки", "");
		РезультатОперации.Вставить("СуммаКорректировки", 0);
		РезультатОперации.Вставить("ДетализацияОтмены", Новый Массив);
		
		// Изменяем заказ
		Попытка
			ЗаказОбъект = ЗаказСсылка.ПолучитьОбъект();
			ЗаказОбъект.Заблокировать();
			
			// Получаем максимальный код строки для новых строк
			МаксКодСтроки = ЗаказОбъект.МаксимальныйКодСтроки;
			
			// Собираем строки для добавления (нельзя добавлять во время итерации)
			СтрокиДляДобавления = Новый Массив;
			
			// Обрабатываем непоступившие строки
			Для Каждого СтрокаОстатка Из ОстаткиЗаказа Цикл
				// Ищем строку в табличной части по КодСтроки
				Для Каждого СтрокаТовара Из ЗаказОбъект.Товары Цикл
					Если СтрокаТовара.КодСтроки = СтрокаОстатка.КодСтроки И НЕ СтрокаТовара.Отменено Тогда
						
						// Непоступившее количество из регистра
						НепоступившееКоличество = Макс(СтрокаОстатка.КОформлению, 0) + Макс(СтрокаОстатка.КПоступлению, 0);
						
						Если НепоступившееКоличество <= 0 Тогда
							Прервать; // Всё поступило
						КонецЕсли;
						
						// Количество в строке заказа
						КоличествоВЗаказе = СтрокаТовара.Количество;
						
						// Информация для детализации
						ДетальОтмены = Новый Структура;
						ДетальОтмены.Вставить("Номенклатура", Строка(СтрокаТовара.Номенклатура));
						ДетальОтмены.Вставить("КоличествоВЗаказе", КоличествоВЗаказе);
						
						Если НепоступившееКоличество < КоличествоВЗаказе Тогда
							// *** ЧАСТИЧНОЕ ПОСТУПЛЕНИЕ - нужно разделить строку ***
							ПоступившееКоличество = КоличествоВЗаказе - НепоступившееКоличество;
							Цена = СтрокаТовара.Цена;
							
							// Сохраняем данные для новой строки (отменяемой)
							ДанныеНовойСтроки = Новый Структура;
							ДанныеНовойСтроки.Вставить("Номенклатура", СтрокаТовара.Номенклатура);
							ДанныеНовойСтроки.Вставить("Характеристика", СтрокаТовара.Характеристика);
							ДанныеНовойСтроки.Вставить("Упаковка", СтрокаТовара.Упаковка);
							ДанныеНовойСтроки.Вставить("Количество", НепоступившееКоличество);
							ДанныеНовойСтроки.Вставить("Цена", Цена);
							ДанныеНовойСтроки.Вставить("СтавкаНДС", СтрокаТовара.СтавкаНДС);
							ДанныеНовойСтроки.Вставить("ДатаПоступления", СтрокаТовара.ДатаПоступления);
							ДанныеНовойСтроки.Вставить("Склад", СтрокаТовара.Склад);
							ДанныеНовойСтроки.Вставить("ПричинаОтмены", ПричинаОтменыСсылка);
							СтрокиДляДобавления.Добавить(ДанныеНовойСтроки);
							
							// Уменьшаем количество в исходной строке до поступившего
							СтрокаТовара.Количество = ПоступившееКоличество;
							СтрокаТовара.КоличествоУпаковок = ПоступившееКоличество; // Упрощение
							СтрокаТовара.Сумма = Окр(ПоступившееКоличество * Цена, 2);
							// Пересчитываем НДС (упрощённо)
							СтрокаТовара.СуммаСНДС = СтрокаТовара.Сумма;
							
							// Считаем сумму отменяемой части
							СуммаОтмены = Окр(НепоступившееКоличество * Цена, 2);
							
							РезультатОперации.СтрокРазделено = РезультатОперации.СтрокРазделено + 1;
							РезультатОперации.СтрокОтменено = РезультатОперации.СтрокОтменено + 1;
							РезультатОперации.КоличествоОтменено = РезультатОперации.КоличествоОтменено + НепоступившееКоличество;
							РезультатОперации.СуммаОтмененных = РезультатОперации.СуммаОтмененных + СуммаОтмены;
							
							ДетальОтмены.Вставить("Поступило", ПоступившееКоличество);
							ДетальОтмены.Вставить("КОтмене", НепоступившееКоличество);
							ДетальОтмены.Вставить("СуммаОтмены", СуммаОтмены);
							ДетальОтмены.Вставить("Разделено", Истина);
							
						Иначе
							// *** НИЧЕГО НЕ ПОСТУПИЛО - отменяем строку целиком ***
							СтрокаТовара.Отменено = Истина;
							Если ЗначениеЗаполнено(ПричинаОтменыСсылка) Тогда
								СтрокаТовара.ПричинаОтмены = ПричинаОтменыСсылка;
							КонецЕсли;
							
							РезультатОперации.СтрокОтменено = РезультатОперации.СтрокОтменено + 1;
							РезультатОперации.КоличествоОтменено = РезультатОперации.КоличествоОтменено + КоличествоВЗаказе;
							РезультатОперации.СуммаОтмененных = РезультатОперации.СуммаОтмененных + СтрокаТовара.Сумма;
							
							ДетальОтмены.Вставить("Поступило", 0);
							ДетальОтмены.Вставить("КОтмене", КоличествоВЗаказе);
							ДетальОтмены.Вставить("СуммаОтмены", СтрокаТовара.Сумма);
							ДетальОтмены.Вставить("Разделено", Ложь);
						КонецЕсли;
						
						РезультатОперации.ДетализацияОтмены.Добавить(ДетальОтмены);
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЦикла;
			
			// Добавляем новые строки (отменяемые части разделённых строк)
			Для Каждого ДанныеСтроки Из СтрокиДляДобавления Цикл
				МаксКодСтроки = МаксКодСтроки + 1;
				
				НоваяСтрока = ЗаказОбъект.Товары.Добавить();
				НоваяСтрока.Номенклатура = ДанныеСтроки.Номенклатура;
				НоваяСтрока.Характеристика = ДанныеСтроки.Характеристика;
				НоваяСтрока.Упаковка = ДанныеСтроки.Упаковка;
				НоваяСтрока.Количество = ДанныеСтроки.Количество;
				НоваяСтрока.КоличествоУпаковок = ДанныеСтроки.Количество;
				НоваяСтрока.Цена = ДанныеСтроки.Цена;
				НоваяСтрока.Сумма = Окр(ДанныеСтроки.Количество * ДанныеСтроки.Цена, 2);
				НоваяСтрока.СуммаСНДС = НоваяСтрока.Сумма;
				НоваяСтрока.СтавкаНДС = ДанныеСтроки.СтавкаНДС;
				НоваяСтрока.ДатаПоступления = ДанныеСтроки.ДатаПоступления;
				НоваяСтрока.Склад = ДанныеСтроки.Склад;
				НоваяСтрока.КодСтроки = МаксКодСтроки;
				НоваяСтрока.Отменено = Истина;
				Если ЗначениеЗаполнено(ДанныеСтроки.ПричинаОтмены) Тогда
					НоваяСтрока.ПричинаОтмены = ДанныеСтроки.ПричинаОтмены;
				КонецЕсли;
			КонецЦикла;
			
			// Обновляем максимальный код строки
			ЗаказОбъект.МаксимальныйКодСтроки = МаксКодСтроки;
			
			// Пересчитываем сумму документа
			НоваяСуммаДокумента = 0;
			Для Каждого СтрокаТовара Из ЗаказОбъект.Товары Цикл
				Если НЕ СтрокаТовара.Отменено Тогда
					НоваяСуммаДокумента = НоваяСуммаДокумента + СтрокаТовара.Сумма;
				КонецЕсли;
			КонецЦикла;
			ЗаказОбъект.СуммаДокумента = НоваяСуммаДокумента;
			
			// Добавляем комментарий если указан
			Если ЗначениеЗаполнено(Комментарий) Тогда
				Если ЗначениеЗаполнено(ЗаказОбъект.Комментарий) Тогда
					ЗаказОбъект.Комментарий = ЗаказОбъект.Комментарий + Символы.ПС + Комментарий;
				Иначе
					ЗаказОбъект.Комментарий = Комментарий;
				КонецЕсли;
			КонецЕсли;
			
			// Устанавливаем статус "Закрыт"
			ЗаказОбъект.Статус = Перечисления.СтатусыЗаказовПоставщикам.Закрыт;
			
			// Записываем и проводим
			ЗаказОбъект.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
			
		Исключение
			ИнформацияОбОшибке = ИнформацияОбОшибке();
			Результат = СформироватьОтветСОшибкой("Ошибка изменения заказа: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
			УстановитьПривилегированныйРежим(Ложь);
			Возврат Результат;
		КонецПопытки;
		
		// Создаем корректировку задолженности если нужно
		Если СоздатьКорректировку И СостояниеРасчетов.КОплате <> 0 Тогда
			Попытка
				// Определяем сумму корректировки (берём модуль КОплате)
				СуммаКорректировки = ?(СостояниеРасчетов.КОплате < 0, -СостояниеРасчетов.КОплате, СостояниеРасчетов.КОплате);
				
				// Формируем аргументы для создания корректировки
				АргументыКорректировки = Новый Структура;
				АргументыКорректировки.Вставить("organization", ЗаказСсылка.Организация.Наименование);
				АргументыКорректировки.Вставить("partner", ЗаказСсылка.Партнер.Наименование);
				АргументыКорректировки.Вставить("direction", "РасчетыСПоставщиком");
				АргументыКорректировки.Вставить("currency", ЗаказСсылка.Валюта.Наименование);
				АргументыКорректировки.Вставить("amount", СуммаКорректировки);
				АргументыКорректировки.Вставить("basis_selector", ЗаказСсылка.Номер);
				АргументыКорректировки.Вставить("comment", "Корректировка задолженности при закрытии заказа " + ЗаказСсылка.Номер);
				АргументыКорректировки.Вставить("format", "json");
				
				РезультатКорректировки = СоздатьКорректировкуЗадолженности(АргументыКорректировки);
				
				// Проверяем результат
				Если НЕ РезультатКорректировки.Свойство("isError") ИЛИ НЕ РезультатКорректировки.isError Тогда
					РезультатОперации.КорректировкаСоздана = Истина;
					РезультатОперации.СуммаКорректировки = СуммаКорректировки;
					// Извлекаем номер из JSON ответа
					Попытка
						ТекстJSON = РезультатКорректировки.content[0].text;
						ЧтениеJSON = Новый ЧтениеJSON;
						ЧтениеJSON.УстановитьСтроку(ТекстJSON);
						ДанныеКорректировки = ПрочитатьJSON(ЧтениеJSON);
						РезультатОперации.НомерКорректировки = ДанныеКорректировки.number;
					Исключение
						// Не критично
					КонецПопытки;
				КонецЕсли;
				
			Исключение
				// Ошибка создания корректировки - не критично, заказ уже закрыт
			КонецПопытки;
		КонецЕсли;
		
		// Формируем ответ
		Если ФорматРезультата = "json" Тогда
			Результат = СформироватьJSONОтветЗакрытия(РезультатОперации);
		Иначе
			Результат = СформироватьMarkdownОтветЗакрытия(РезультатОперации);
		КонецЕсли;
		
		УстановитьПривилегированныйРежим(Ложь);
		
	Исключение
		УстановитьПривилегированныйРежим(Ложь);
		
		Если Результат = Неопределено Тогда
			ИнформацияОбОшибке = ИнформацияОбОшибке();
			Результат = СформироватьОтветСОшибкой("Ошибка выполнения инструмента: " + ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
		КонецЕсли;
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Получает остатки заказа поставщику из регистра
Функция ПолучитьОстаткиЗаказаПоставщику(ЗаказСсылка)
	
	Результат = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЗаказыПоставщикамОстатки.Номенклатура КАК Номенклатура,
		|	ЗаказыПоставщикамОстатки.Характеристика КАК Характеристика,
		|	ЗаказыПоставщикамОстатки.КодСтроки КАК КодСтроки,
		|	ЗаказыПоставщикамОстатки.КОформлениюОстаток КАК КОформлению,
		|	ЗаказыПоставщикамОстатки.КПоступлениюОстаток КАК КПоступлению
		|ИЗ
		|	РегистрНакопления.ЗаказыПоставщикам.Остатки(, ЗаказПоставщику = &Заказ) КАК ЗаказыПоставщикамОстатки
		|ГДЕ
		|	(ЗаказыПоставщикамОстатки.КОформлениюОстаток > 0
		|		ИЛИ ЗаказыПоставщикамОстатки.КПоступлениюОстаток > 0)";
	
	Запрос.УстановитьПараметр("Заказ", ЗаказСсылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			СтрокаРезультата = Новый Структура;
			СтрокаРезультата.Вставить("Номенклатура", Выборка.Номенклатура);
			СтрокаРезультата.Вставить("Характеристика", Выборка.Характеристика);
			СтрокаРезультата.Вставить("КодСтроки", Выборка.КодСтроки);
			СтрокаРезультата.Вставить("КОформлению", Выборка.КОформлению);
			СтрокаРезультата.Вставить("КПоступлению", Выборка.КПоступлению);
			Результат.Добавить(СтрокаРезультата);
		КонецЦикла;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Получает состояние расчетов по заказу
Функция ПолучитьСостояниеРасчетовПоЗаказу(ЗаказСсылка)
	
	Результат = Новый Структура;
	Результат.Вставить("КОплате", 0);
	Результат.Вставить("Оплачено", 0);
	
	// Находим объект расчетов
	ОбъектРасчетов = НайтиОбъектРасчетовПоЗаказу(ЗаказСсылка);
	Если ОбъектРасчетов = Неопределено Тогда
		Возврат Результат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РасчетыСПоставщикамиОстатки.КОплатеОстаток КАК КОплате,
		|	РасчетыСПоставщикамиОстатки.ОплаченоОстаток КАК Оплачено
		|ИЗ
		|	РегистрНакопления.РасчетыСПоставщиками.Остатки(, ОбъектРасчетов = &ОбъектРасчетов) КАК РасчетыСПоставщикамиОстатки";
	
	Запрос.УстановитьПараметр("ОбъектРасчетов", ОбъектРасчетов);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Если Выборка.Следующий() Тогда
			Результат.КОплате = Выборка.КОплате;
			Результат.Оплачено = Выборка.Оплачено;
		КонецЕсли;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Находит причину отмены по селектору
Функция НайтиПричинуОтмены(Селектор)
	
	// Поиск по UUID
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			ПричинаСсылка = Справочники.ПричиныОтменыЗаказовПоставщикам.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
			Если ЗначениеЗаполнено(ПричинаСсылка) Тогда
				Возврат ПричинаСсылка;
			КонецЕсли;
		Исключение
			// Не UUID - продолжаем
		КонецПопытки;
	КонецЕсли;
	
	// Поиск по наименованию
	ПричинаСсылка = Справочники.ПричиныОтменыЗаказовПоставщикам.НайтиПоНаименованию(Селектор, Истина);
	Если ЗначениеЗаполнено(ПричинаСсылка) Тогда
		Возврат ПричинаСсылка;
	КонецЕсли;
	
	// Поиск по частичному совпадению
	Попытка
		Запрос = Новый Запрос;
		Запрос.Текст = 
			"ВЫБРАТЬ ПЕРВЫЕ 1
			|	ПричиныОтмены.Ссылка КАК Ссылка
			|ИЗ
			|	Справочник.ПричиныОтменыЗаказовПоставщикам КАК ПричиныОтмены
			|ГДЕ
			|	ПричиныОтмены.Наименование ПОДОБНО &Наименование";
		
		Запрос.УстановитьПараметр("Наименование", "%" + Селектор + "%");
		
		РезультатЗапроса = Запрос.Выполнить();
		Если НЕ РезультатЗапроса.Пустой() Тогда
			Выборка = РезультатЗапроса.Выбрать();
			Если Выборка.Следующий() Тогда
				Возврат Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;
	Исключение
		// Ошибка выполнения запроса
	КонецПопытки;
	
	Возврат Неопределено;
	
КонецФункции

// Формирует JSON ответ о закрытии заказа
Функция СформироватьJSONОтветЗакрытия(РезультатОперации)
	
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("order_number", РезультатОперации.НомерЗаказа);
	Результат.Вставить("order_date", Формат(РезультатОперации.ДатаЗаказа, "ДФ=yyyy-MM-ddTHH:mm:ss"));
	Результат.Вставить("partner", РезультатОперации.Партнер);
	Результат.Вставить("organization", РезультатОперации.Организация);
	Результат.Вставить("status", "Закрыт");
	Результат.Вставить("lines_cancelled", РезультатОперации.СтрокОтменено);
	Результат.Вставить("lines_split", РезультатОперации.СтрокРазделено);
	Результат.Вставить("quantity_cancelled", РезультатОперации.КоличествоОтменено);
	Результат.Вставить("amount_cancelled", РезультатОперации.СуммаОтмененных);
	Результат.Вставить("cancellation_details", РезультатОперации.ДетализацияОтмены);
	Результат.Вставить("debt_adjustment_created", РезультатОперации.КорректировкаСоздана);
	Если РезультатОперации.КорректировкаСоздана Тогда
		Результат.Вставить("debt_adjustment_number", РезультатОперации.НомерКорректировки);
		Результат.Вставить("debt_adjustment_amount", РезультатОперации.СуммаКорректировки);
	КонецЕсли;
	Результат.Вставить("message", "Заказ поставщику успешно закрыт");
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Результат);
	ТекстJSON = ЗаписьJSON.Закрыть();
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", ТекстJSON);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

// Формирует Markdown ответ о закрытии заказа
Функция СформироватьMarkdownОтветЗакрытия(РезультатОперации)
	
	Текст = "# Заказ поставщику закрыт" + Символы.ПС;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "| Параметр | Значение |" + Символы.ПС;
	Текст = Текст + "| --- | --- |" + Символы.ПС;
	Текст = Текст + "| Номер заказа | **" + РезультатОперации.НомерЗаказа + "** |" + Символы.ПС;
	Текст = Текст + "| Дата | " + Формат(РезультатОперации.ДатаЗаказа, "ДФ=dd.MM.yyyy HH:mm:ss") + " |" + Символы.ПС;
	Текст = Текст + "| Партнер | " + РезультатОперации.Партнер + " |" + Символы.ПС;
	Текст = Текст + "| Организация | " + РезультатОперации.Организация + " |" + Символы.ПС;
	Текст = Текст + "| Новый статус | **Закрыт** |" + Символы.ПС;
	Текст = Текст + "| Строк отменено | " + РезультатОперации.СтрокОтменено + " |" + Символы.ПС;
	Если РезультатОперации.СтрокРазделено > 0 Тогда
		Текст = Текст + "| Строк разделено | " + РезультатОперации.СтрокРазделено + " |" + Символы.ПС;
	КонецЕсли;
	Текст = Текст + "| Количество отменено | " + Формат(РезультатОперации.КоличествоОтменено, "ЧДЦ=0") + " |" + Символы.ПС;
	Текст = Текст + "| Сумма отмененных | " + Формат(РезультатОперации.СуммаОтмененных, "ЧДЦ=2") + " |" + Символы.ПС;
	
	// Детализация по товарам
	Если РезультатОперации.ДетализацияОтмены.Количество() > 0 Тогда
		Текст = Текст + Символы.ПС;
		Текст = Текст + "## Детализация по товарам" + Символы.ПС;
		Текст = Текст + "| Номенклатура | В заказе | Поступило | Отменено | Сумма | Разделено |" + Символы.ПС;
		Текст = Текст + "| --- | ---: | ---: | ---: | ---: | :---: |" + Символы.ПС;
		
		Для Каждого Деталь Из РезультатОперации.ДетализацияОтмены Цикл
			ПризнакРазделения = ?(Деталь.Разделено, "✓", "");
			Текст = Текст + "| " + Деталь.Номенклатура 
				+ " | " + Формат(Деталь.КоличествоВЗаказе, "ЧДЦ=0")
				+ " | " + Формат(Деталь.Поступило, "ЧДЦ=0")
				+ " | " + Формат(Деталь.КОтмене, "ЧДЦ=0")
				+ " | " + Формат(Деталь.СуммаОтмены, "ЧДЦ=2")
				+ " | " + ПризнакРазделения + " |" + Символы.ПС;
		КонецЦикла;
	КонецЕсли;
	
	Если РезультатОперации.КорректировкаСоздана Тогда
		Текст = Текст + Символы.ПС;
		Текст = Текст + "## Корректировка задолженности" + Символы.ПС;
		Текст = Текст + "| Параметр | Значение |" + Символы.ПС;
		Текст = Текст + "| --- | --- |" + Символы.ПС;
		Текст = Текст + "| Номер | " + РезультатОперации.НомерКорректировки + " |" + Символы.ПС;
		Текст = Текст + "| Сумма | " + Формат(РезультатОперации.СуммаКорректировки, "ЧДЦ=2") + " |" + Символы.ПС;
	КонецЕсли;
	
	Текст = Текст + Символы.ПС;
	Текст = Текст + "**Заказ успешно закрыт.**" + Символы.ПС;
	
	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", Текст);
	
	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);
	
	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;
	
КонецФункции

#КонецОбласти
