#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт

        ДобавитьИнструментПроизвольногоЗапроса(Инструменты);

КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Попытка
		Если ИмяИнструмента = "execute_any_query" Тогда
			Возврат ВыполнитьПроизвольныйЗапрос(Аргументы);
		Иначе
			Возврат СформироватьОтветСОшибкой("Неизвестный инструмент: " + ИмяИнструмента);
		КонецЕсли;
	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		СообщениеОшибки = СтрШаблон("Ошибка выполнения инструмента '%1': %2",
			ИмяИнструмента,
			ОписаниеОшибкиТекст);
		
		// Логируем ошибку (без прерывания при ошибке логирования)
		Попытка
			ЗаписьЖурналаРегистрации("MCP." + ИмяИнструмента, УровеньЖурналаРегистрации.Ошибка, , , 
				СообщениеОшибки + Символы.ПС + ПодробноеОписание);
		Исключение
			// Ошибка логирования не должна прерывать основной поток
			ОшибкаЛогирования = ОписаниеОшибки();
		КонецПопытки;
		
		// Возвращаем ошибку в формате MCP вместо исключения
		Возврат СформироватьОтветСОшибкой(СообщениеОшибки + Символы.ПС + ПодробноеОписание);
	КонецПопытки;

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Формирует ответ MCP с ошибкой
//
// Параметры:
//  ТекстОшибки - Строка - текст ошибки для отображения
//
// Возвращаемое значение:
//  Массив - массив содержимого MCP с ошибкой
//
Функция СформироватьОтветСОшибкой(ТекстОшибки)
	
	МассивСодержимого = Новый Массив;
	
	// Определяем тип ошибки и формируем понятное сообщение
	ПрефиксОшибки = "ОШИБКА: ";
	ТекстДляПользователя = ТекстОшибки;
	
	// Если это маркированная ошибка прав доступа
	Если СтрНачинаетсяС(ТекстОшибки, "НЕДОСТАТОЧНО_ПРАВ:") Тогда
		ПрефиксОшибки = "НЕДОСТАТОЧНО ПРАВ: ";
		ТекстДляПользователя = СокрЛП(Сред(ТекстОшибки, СтрДлина("НЕДОСТАТОЧНО_ПРАВ:") + 1));
		
		// Пытаемся извлечь имя объекта из ошибки
		ИмяОбъекта = ИзвлечьИмяОбъектаИзОшибки(ТекстДляПользователя);
		Если ЗначениеЗаполнено(ИмяОбъекта) Тогда
			ТекстДляПользователя = СтрШаблон(
				"У текущего пользователя нет прав на чтение объекта '%1'. " +
				"Обратитесь к администратору для получения доступа." + Символы.ПС + Символы.ПС +
				"Техническая информация: %2",
				ИмяОбъекта, ТекстДляПользователя);
		Иначе
			ТекстДляПользователя = СтрШаблон(
				"У текущего пользователя недостаточно прав для выполнения запроса. " +
				"Обратитесь к администратору для получения доступа." + Символы.ПС + Символы.ПС +
				"Техническая информация: %1",
				ТекстДляПользователя);
		КонецЕсли;
	ИначеЕсли ЭтоОшибкаПравДоступа(ТекстОшибки) Тогда
		// Немаркированная ошибка прав — добавляем понятный префикс
		ПрефиксОшибки = "НЕДОСТАТОЧНО ПРАВ: ";
		ИмяОбъекта = ИзвлечьИмяОбъектаИзОшибки(ТекстОшибки);
		Если ЗначениеЗаполнено(ИмяОбъекта) Тогда
			ТекстДляПользователя = СтрШаблон(
				"У текущего пользователя нет прав на чтение объекта '%1'. " +
				"Обратитесь к администратору для получения доступа." + Символы.ПС + Символы.ПС +
				"Техническая информация: %2",
				ИмяОбъекта, ТекстОшибки);
		Иначе
			ТекстДляПользователя = СтрШаблон(
				"У текущего пользователя недостаточно прав для выполнения запроса. " +
				"Обратитесь к администратору для получения доступа." + Символы.ПС + Символы.ПС +
				"Техническая информация: %1",
				ТекстОшибки);
		КонецЕсли;
	КонецЕсли;
	
	СодержимоеОшибки = Новый Структура;
	СодержимоеОшибки.Вставить("type", "text");
	СодержимоеОшибки.Вставить("text", ПрефиксОшибки + ТекстДляПользователя);
	СодержимоеОшибки.Вставить("isError", Истина);
	
	МассивСодержимого.Добавить(СодержимоеОшибки);
	
	Возврат МассивСодержимого;
	
КонецФункции

// Извлекает имя объекта метаданных из текста ошибки
//
// Параметры:
//  ТекстОшибки - Строка - текст ошибки
//
// Возвращаемое значение:
//  Строка - имя объекта или пустая строка
//
Функция ИзвлечьИмяОбъектаИзОшибки(ТекстОшибки)
	
	// Паттерны для поиска имён объектов в ошибках 1С
	// Например: "Справочник.Номенклатура", "Документ.ЗаказПоставщику"
	Паттерны = Новый Массив;
	Паттерны.Добавить("Справочник.");
	Паттерны.Добавить("Документ.");
	Паттерны.Добавить("РегистрСведений.");
	Паттерны.Добавить("РегистрНакопления.");
	Паттерны.Добавить("РегистрБухгалтерии.");
	Паттерны.Добавить("РегистрРасчета.");
	Паттерны.Добавить("ПланВидовХарактеристик.");
	Паттерны.Добавить("ПланСчетов.");
	Паттерны.Добавить("ПланВидовРасчета.");
	Паттерны.Добавить("БизнесПроцесс.");
	Паттерны.Добавить("Задача.");
	Паттерны.Добавить("Перечисление.");
	Паттерны.Добавить("Константа.");
	
	Для Каждого Паттерн Из Паттерны Цикл
		Позиция = СтрНайти(ТекстОшибки, Паттерн);
		Если Позиция > 0 Тогда
			// Ищем конец имени объекта (пробел, точка, скобка, кавычка)
			Начало = Позиция;
			ПозицияКонца = Начало + СтрДлина(Паттерн);
			Пока ПозицияКонца <= СтрДлина(ТекстОшибки) Цикл
				Символ = Сред(ТекстОшибки, ПозицияКонца, 1);
				Если Символ = " " ИЛИ Символ = "." ИЛИ Символ = "(" ИЛИ Символ = ")"
					ИЛИ Символ = "'" ИЛИ Символ = """" ИЛИ Символ = Символы.ПС 
					ИЛИ Символ = Символы.ВК ИЛИ Символ = "," ИЛИ Символ = ";" Тогда
					Прервать;
				КонецЕсли;
				ПозицияКонца = ПозицияКонца + 1;
			КонецЦикла;
			
			ИмяОбъекта = Сред(ТекстОшибки, Начало, ПозицияКонца - Начало);
			Если ЗначениеЗаполнено(ИмяОбъекта) Тогда
				Возврат ИмяОбъекта;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат "";
	
КонецФункции

#КонецОбласти

#Область ИнструментПроизвольногоЗапроса

Процедура ДобавитьИнструментПроизвольногоЗапроса(Инструменты)

        // Инструмент для выполнения произвольного запроса без дополнительных ограничений безопасности
        МассивПараметров = Новый Массив;

        // Параметр query - текст запроса на языке запросов 1С
        МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
                "query",
                "string",
                "Текст запроса на языке запросов 1С:Предприятие",
                ,
                Истина
        ));

        // Параметр parameters - параметры запроса (структура)
        МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
                "parameters",
                "object",
                "Параметры запроса в виде объекта (ключ-значение). Значения могут быть строками, числами, датами или булевыми."
        ));

        // Параметр format - формат результата
        МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
                "format",
                "string",
                "Формат результата: 'markdown' (удобочитаемая таблица) или 'json' (структурированные данные). По умолчанию 'markdown'",
                "markdown",
                Ложь,
                "markdown,json"
        ));

        // Параметр includeSchema - включить схему колонок в JSON
        МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
                "includeSchema",
                "boolean",
                "Включить схему колонок в JSON результат (типы данных). Применяется только для format='json'",
                Ложь
        ));

        // Параметр maxRows - максимальное количество строк в результате
        МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
                "maxRows",
                "number",
                "Максимальное количество строк в результате (по умолчанию 1000, максимум 10000)",
                1000
        ));

        СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);

        mcp_Метаданные.ДобавитьИнструмент(
                Инструменты,
                "execute_any_query",
                "Выполнение произвольного запроса к базе данных 1С:Предприятие без ограничений на тип запроса. Поддерживает параметры запроса и различные форматы вывода.",
                СхемаПараметров
        );

КонецПроцедуры

Функция ВыполнитьПроизвольныйЗапрос(Аргументы)

        Возврат ВыполнитьЗапрос(Аргументы, Ложь);

КонецФункции

Функция ВыполнитьЗапрос(Аргументы, ПроверятьБезопасность)

        ИмяИнструментаДляЛога = ?(ПроверятьБезопасность, "execute_query", "execute_any_query");

        Попытка
                // Нормализуем аргументы из Соответствия в Структуру
                Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
                        АргументыСтруктура = Новый Структура;
                        Для Каждого КлючЗначение Из Аргументы Цикл
                                АргументыСтруктура.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
                        КонецЦикла;
                        Аргументы = АргументыСтруктура;
                КонецЕсли;

                ТекстЗапроса = Аргументы.query;
                МаксСтрок = ?(Аргументы.Свойство("maxRows"), Аргументы.maxRows, 1000);
                ФорматРезультата = ?(Аргументы.Свойство("format"), Аргументы.format, "markdown");
                ВключитьСхему = ?(Аргументы.Свойство("includeSchema"), Аргументы.includeSchema, Ложь);

                // Проверяем обязательные параметры
                Если НЕ ЗначениеЗаполнено(ТекстЗапроса) Тогда
                        ВызватьИсключение "Не указан текст запроса";
                КонецЕсли;

                // Валидация формата
                Если ФорматРезультата <> "markdown" И ФорматРезультата <> "json" Тогда
                        ВызватьИсключение "Недопустимый формат результата. Допустимые значения: 'markdown', 'json'";
                КонецЕсли;

                // Ограничиваем максимальное количество строк для безопасности
                Если МаксСтрок > 10000 Тогда
                        МаксСтрок = 10000;
                ИначеЕсли МаксСтрок < 1 Тогда
                        МаксСтрок = 1;
                КонецЕсли;

                // Валидация запроса
                Если ПроверятьБезопасность Тогда
                        ПроверитьБезопасностьЗапроса(ТекстЗапроса);
                КонецЕсли;

                // Создаем и выполняем запрос
                Запрос = Новый Запрос;
                Запрос.Текст = ТекстЗапроса;

                // Устанавливаем параметры запроса, если они указаны
                Если Аргументы.Свойство("parameters") И ЗначениеЗаполнено(Аргументы.parameters) Тогда
                        ПараметрыЗапроса = Аргументы.parameters;
                        // Поддерживаем и Структура, и Соответствие (JSON может приходить как Соответствие)
                        Если ТипЗнч(ПараметрыЗапроса) = Тип("Структура") ИЛИ ТипЗнч(ПараметрыЗапроса) = Тип("Соответствие") Тогда
				Для Каждого Параметр Из ПараметрыЗапроса Цикл
					Попытка
						Запрос.УстановитьПараметр(Строка(Параметр.Ключ), Параметр.Значение);
					Исключение
						ВызватьИсключение СтрШаблон("Ошибка установки параметра запроса '%1': %2",
							Параметр.Ключ,
							ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
					КонецПопытки;
				КонецЦикла;
                        Иначе
                                ВызватьИсключение СтрШаблон("Параметр 'parameters' должен быть объектом (структурой или соответствием). Получен тип: %1", ТипЗнч(ПараметрыЗапроса));
                        КонецЕсли;
                КонецЕсли;

		Попытка
			РезультатЗапроса = Запрос.Выполнить();
		Исключение
			ТекстОшибкиЗапроса = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
			
			// Проверяем, является ли ошибка проблемой прав доступа
			Если ЭтоОшибкаПравДоступа(ТекстОшибкиЗапроса) Тогда
				ВызватьИсключение "НЕДОСТАТОЧНО_ПРАВ: " + ТекстОшибкиЗапроса;
			Иначе
				ВызватьИсключение СтрШаблон("Ошибка выполнения запроса: %1", ТекстОшибкиЗапроса);
			КонецЕсли;
		КонецПопытки;

                // Проверяем, что результат запроса получен
                Если РезультатЗапроса = Неопределено Тогда
                        ВызватьИсключение "Результат запроса не получен";
                КонецЕсли;

                // Дополнительно проверяем доступность колонок результата
		Попытка
			Колонки = РезультатЗапроса.Колонки;
			Если НЕ ЗначениеЗаполнено(Колонки) Или Колонки.Количество() = 0 Тогда
				ВызватьИсключение "Результат запроса не содержит описание колонок";
			КонецЕсли;
		Исключение
			ВызватьИсключение СтрШаблон("Ошибка доступа к колонкам результата запроса: %1",
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;

                // Формируем результат в зависимости от формата
                Попытка
                        Если ФорматРезультата = "json" Тогда
                                РезультатJSON = mcp_ОбщегоНазначения.РезультатЗапросаВJSON(РезультатЗапроса, МаксСтрок, ВключитьСхему);
                                // Преобразуем структуру в JSON строку
			Попытка
				JSONСтрока = mcp_ОбщегоНазначения.СтруктураВJSON(РезультатJSON);
			Исключение
				ВызватьИсключение СтрШаблон("Ошибка сериализации результата в JSON: %1",
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			КонецПопытки;
                                // Возвращаем массив содержимого для MCP
                                МассивСодержимого = Новый Массив;
                                МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(JSONСтрока));
                                Возврат МассивСодержимого;
                        Иначе
                                // Markdown формат
                                РезультатMarkdown = mcp_ОбщегоНазначения.РезультатЗапросаВMarkdown(РезультатЗапроса, МаксСтрок);
                                // Проверяем, что результат - строка
                                Если ТипЗнч(РезультатMarkdown) <> Тип("Строка") Тогда
                                        РезультатMarkdown = Строка(РезультатMarkdown);
                                КонецЕсли;
                                // Возвращаем массив содержимого для MCP
                                МассивСодержимого = Новый Массив;
                                МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(РезультатMarkdown));
                                Возврат МассивСодержимого;
                        КонецЕсли;
		Исключение
			ВызватьИсключение СтрШаблон("Ошибка форматирования результата запроса: %1",
				ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		КонецПопытки;

	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		СообщениеОшибки = СтрШаблон("Ошибка выполнения инструмента '%1': %2",
			ИмяИнструментаДляЛога,
			ОписаниеОшибкиТекст);
		
		Попытка
			ЗаписьЖурналаРегистрации("MCP." + ИмяИнструментаДляЛога, УровеньЖурналаРегистрации.Ошибка, , , 
				СообщениеОшибки + Символы.ПС + ПодробноеОписание);
		Исключение
			// Ошибка логирования не должна прерывать основной поток
			ОшибкаЛогирования = ОписаниеОшибки();
		КонецПопытки;
		
		// Возвращаем ошибку в ожидаемом формате MCP вместо исключения
		Возврат СформироватьОтветСОшибкой(СообщениеОшибки + Символы.ПС + ПодробноеОписание);
	КонецПопытки;

КонецФункции

// Проверяет, является ли ошибка проблемой прав доступа
//
// Параметры:
//  ТекстОшибки - Строка - текст ошибки для проверки
//
// Возвращаемое значение:
//  Булево - Истина, если это ошибка прав доступа
//
Функция ЭтоОшибкаПравДоступа(ТекстОшибки)
	
	ТекстВРег = ВРег(ТекстОшибки);
	
	// Типичные маркеры ошибок прав доступа в 1С
	Если СтрНайти(ТекстВРег, "НЕДОСТАТОЧНО ПРАВ") > 0
		ИЛИ СтрНайти(ТекстВРег, "НЕТ ПРАВ") > 0
		ИЛИ СтрНайти(ТекстВРег, "ДОСТУП ЗАПРЕЩЕН") > 0
		ИЛИ СтрНайти(ТекстВРег, "ДОСТУП ЗАКРЫТ") > 0
		ИЛИ СтрНайти(ТекстВРег, "ОШИБКА ПРАВ") > 0
		ИЛИ СтрНайти(ТекстВРег, "ПРАВА ДОСТУПА") > 0
		ИЛИ СтрНайти(ТекстВРег, "НЕ ИМЕЕТ ПРАВ") > 0
		ИЛИ СтрНайти(ТекстВРег, "ACCESS DENIED") > 0
		ИЛИ СтрНайти(ТекстВРег, "PERMISSION DENIED") > 0
		ИЛИ СтрНайти(ТекстВРег, "INSUFFICIENT RIGHTS") > 0 Тогда
		Возврат Истина;
	КонецЕсли;
	
	// Проверяем ошибки RLS (ограничения на уровне записей)
	Если СтрНайти(ТекстВРег, "RLS") > 0
		ИЛИ СтрНайти(ТекстВРег, "ОГРАНИЧЕНИЕ ДАННЫХ") > 0 Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

// Проверяет безопасность запроса
//
// Параметры:
//  ТекстЗапроса - Строка - текст запроса для проверки
//
Процедура ПроверитьБезопасностьЗапроса(ТекстЗапроса)

        // Удаляем комментарии из запроса для проверки (однострочные и многострочные)
        ТекстДляПроверки = ТекстЗапроса;
        // Удаляем однострочные комментарии (//)
        ПозицияКомментария = СтрНайти(ТекстДляПроверки, "//");
        Пока ПозицияКомментария > 0 Цикл
                ПозицияКонецСтроки = СтрНайти(ТекстДляПроверки, Символы.ПС, ПозицияКомментария);
                Если ПозицияКонецСтроки > 0 Тогда
                        ТекстДляПроверки = Лев(ТекстДляПроверки, ПозицияКомментария - 1) + Сред(ТекстДляПроверки, ПозицияКонецСтроки);
                Иначе
                        ТекстДляПроверки = Лев(ТекстДляПроверки, ПозицияКомментария - 1);
                КонецЕсли;
                ПозицияКомментария = СтрНайти(ТекстДляПроверки, "//");
        КонецЦикла;

        // Удаляем многострочные комментарии (/* ... */)
        ПозицияНачала = СтрНайти(ТекстДляПроверки, "/*");
        Пока ПозицияНачала > 0 Цикл
                ПозицияКонца = СтрНайти(ТекстДляПроверки, "*/", ПозицияНачала);
                Если ПозицияКонца > 0 Тогда
                        ТекстДляПроверки = Лев(ТекстДляПроверки, ПозицияНачала - 1) + Сред(ТекстДляПроверки, ПозицияКонца + 2);
                Иначе
                        ТекстДляПроверки = Лев(ТекстДляПроверки, ПозицияНачала - 1);
                КонецЕсли;
                ПозицияНачала = СтрНайти(ТекстДляПроверки, "/*");
        КонецЦикла;

        // Проверяем, что запрос не содержит опасных операций
        ТекстЗапросаВРег = ВРег(ТекстДляПроверки);
        Если СтрНайти(ТекстЗапросаВРег, "ИЗМЕНИТЬ") > 0
                ИЛИ СтрНайти(ТекстЗапросаВРег, "УДАЛИТЬ") > 0
                ИЛИ СтрНайти(ТекстЗапросаВРег, "ВСТАВИТЬ") > 0
                ИЛИ СтрНайти(ТекстЗапросаВРег, "UPDATE") > 0
                ИЛИ СтрНайти(ТекстЗапросаВРег, "DELETE") > 0
                ИЛИ СтрНайти(ТекстЗапросаВРег, "INSERT") > 0 Тогда
                ВызватьИсключение "Запросы на изменение данных не разрешены. Используйте только SELECT запросы.";
        КонецЕсли;

        // Проверяем, что запрос начинается с ВЫБРАТЬ или SELECT
        ТекстЗапросаБезПробелов = СокрЛП(ТекстЗапросаВРег);
        Если СтрДлина(ТекстЗапросаБезПробелов) < 6 Тогда
                ВызватьИсключение "Запрос слишком короткий или пустой после удаления комментариев.";
        КонецЕсли;

        НачалоЗапроса = Лев(ТекстЗапросаБезПробелов, 6);
        Если НачалоЗапроса <> "ВЫБРАТЬ"
                И НачалоЗапроса <> "SELECT" Тогда
                ВызватьИсключение "Запрос должен начинаться с ВЫБРАТЬ или SELECT. Разрешены только запросы на чтение данных.";
        КонецЕсли;

КонецПроцедуры

#КонецОбласти
