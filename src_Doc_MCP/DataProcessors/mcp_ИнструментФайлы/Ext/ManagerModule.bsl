#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт

	ДобавитьИнструментСписокФайлов(Инструменты);
	ДобавитьИнструментСкачатьФайл(Инструменты);

КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Попытка
		Если ИмяИнструмента = "list_files" Тогда
			Возврат ПолучитьСписокФайлов(Аргументы);
		ИначеЕсли ИмяИнструмента = "download_file" Тогда
			Возврат СкачатьФайл(Аргументы);
		Иначе
			Возврат СформироватьОтветСОшибкой("Неизвестный инструмент: " + ИмяИнструмента);
		КонецЕсли;
	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());

		Попытка
			ЗаписьЖурналаРегистрации("MCP." + ИмяИнструмента, УровеньЖурналаРегистрации.Ошибка, , ,
				ОписаниеОшибкиТекст + Символы.ПС + ПодробноеОписание);
		Исключение
		КонецПопытки;

		Возврат СформироватьОтветСОшибкой(ОписаниеОшибкиТекст);
	КонецПопытки;

КонецФункции

#КонецОбласти

#Область ОписаниеИнструментов

Процедура ДобавитьИнструментСписокФайлов(Инструменты)

	МассивПараметров = Новый Массив;

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"ownerType",
		"string",
		"Тип владельца файла: 'ВходящееПисьмо', 'ИсходящееПисьмо', 'Задача', 'ДокументыПредприятия', 'ПапкиФайлов' и др. Без префикса 'Документ.' или 'Справочник.'"
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"ownerRef",
		"string",
		"UUID ссылки владельца файла (точный отбор). Приоритетнее ownerType."
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"nameMask",
		"string",
		"Маска поиска по наименованию файла (поиск подстроки, регистронезависимый)."
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"extension",
		"string",
		"Фильтр по расширению файла (например: 'pdf', 'doc', 'xlsx')."
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"maxRows",
		"number",
		"Максимальное количество файлов в результате (по умолчанию 50, максимум 500).",
		50
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"format",
		"string",
		"Формат результата: 'markdown' или 'json'. По умолчанию 'markdown'.",
		"markdown",
		Ложь,
		"markdown,json"
	));

	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);

	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"list_files",
		"Поиск файлов в 1С:Документооборот. Позволяет найти файлы по владельцу (документ/справочник), по имени, по расширению. Возвращает список с метаинформацией: имя, расширение, размер, дата, владелец, UUID.",
		СхемаПараметров
	);

КонецПроцедуры

Процедура ДобавитьИнструментСкачатьФайл(Инструменты)

	МассивПараметров = Новый Массив;

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"fileRef",
		"string",
		"UUID ссылки файла (Справочник.Файлы) для скачивания. Можно получить из list_files.",
		,
		Истина
	));

	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);

	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"download_file",
		"Скачивание файла из 1С:Документооборот по UUID. Возвращает содержимое файла в формате Base64 вместе с метаданными (имя, расширение, размер). Для получения UUID используйте list_files.",
		СхемаПараметров
	);

КонецПроцедуры

#КонецОбласти

#Область Логика

// ============================================================
// list_files — поиск файлов
// ============================================================
Функция ПолучитьСписокФайлов(Аргументы)

	ПривестиАргументы(Аргументы);

	ТипВладельца  = ПолучитьАргумент(Аргументы, "ownerType", "");
	СсылкаВладелец = ПолучитьАргумент(Аргументы, "ownerRef", "");
	МаскаИмени    = ПолучитьАргумент(Аргументы, "nameMask", "");
	Расширение    = ПолучитьАргумент(Аргументы, "extension", "");
	МаксСтрок     = ПолучитьАргумент(Аргументы, "maxRows", 50);
	ФорматВывода  = ПолучитьАргумент(Аргументы, "format", "markdown");

	МаксСтрок = Мин(Макс(Число(МаксСтрок), 1), 500);

	// Строим запрос
	ТекстЗапроса =
	"ВЫБРАТЬ ПЕРВЫЕ " + Формат(МаксСтрок, "ЧГ=") + "
	|	Файлы.Ссылка КАК Ссылка,
	|	Файлы.Наименование КАК Наименование,
	|	Файлы.ТекущаяВерсияРасширение КАК Расширение,
	|	Файлы.ТекущаяВерсияРазмер КАК Размер,
	|	Файлы.ДатаСоздания КАК ДатаСоздания,
	|	Файлы.ТекущаяВерсияДатаМодификацииФайла КАК ДатаМодификации,
	|	ПРЕДСТАВЛЕНИЕ(Файлы.ВладелецФайла) КАК Владелец,
	|	ПРЕДСТАВЛЕНИЕ(Файлы.Автор) КАК Автор
	|ИЗ
	|	Справочник.Файлы КАК Файлы
	|ГДЕ
	|	НЕ Файлы.ПометкаУдаления";

	МассивУсловий = Новый Массив;
	Запрос = Новый Запрос;

	// Фильтр по ссылке владельца (приоритетный)
	Если ЗначениеЗаполнено(СсылкаВладелец) Тогда
		ВладелецСсылка = НайтиВладельцаПоUUID(СсылкаВладелец);
		Если ВладелецСсылка = Неопределено Тогда
			Возврат СформироватьОтветСОшибкой(
				"Владелец с UUID '" + СсылкаВладелец + "' не найден.");
		КонецЕсли;
		МассивУсловий.Добавить("Файлы.ВладелецФайла = &ВладелецСсылка");
		Запрос.УстановитьПараметр("ВладелецСсылка", ВладелецСсылка);

	// Фильтр по типу владельца
	ИначеЕсли ЗначениеЗаполнено(ТипВладельца) Тогда
		ТипМетаданных = ОпределитьТипВладельца(ТипВладельца);
		Если ТипМетаданных = Неопределено Тогда
			Возврат СформироватьОтветСОшибкой(
				"Неизвестный тип владельца: '" + ТипВладельца + "'. Укажите имя документа/справочника без префикса.");
		КонецЕсли;
		МассивУсловий.Добавить("Файлы.ВладелецФайла ССЫЛКА " + ТипМетаданных);
	КонецЕсли;

	// Фильтр по маске имени
	Если ЗначениеЗаполнено(МаскаИмени) Тогда
		МассивУсловий.Добавить("Файлы.Наименование ПОДОБНО &МаскаИмени");
		Запрос.УстановитьПараметр("МаскаИмени", "%" + МаскаИмени + "%");
	КонецЕсли;

	// Фильтр по расширению
	Если ЗначениеЗаполнено(Расширение) Тогда
		МассивУсловий.Добавить("Файлы.ТекущаяВерсияРасширение = &Расширение");
		Запрос.УстановитьПараметр("Расширение", НРег(Расширение));
	КонецЕсли;

	// Если ни одного фильтра — требуем хоть что-то
	Если МассивУсловий.Количество() = 0 Тогда
		Возврат СформироватьОтветСОшибкой(
			"Укажите хотя бы один фильтр: ownerType, ownerRef, nameMask или extension.");
	КонецЕсли;

	// Собираем условия
	Для Каждого Условие Из МассивУсловий Цикл
		ТекстЗапроса = ТекстЗапроса + "
		|	И " + Условие;
	КонецЦикла;

	ТекстЗапроса = ТекстЗапроса + "
	|
	|УПОРЯДОЧИТЬ ПО
	|	ДатаСоздания УБЫВ";

	Запрос.Текст = ТекстЗапроса;

	РезультатЗапроса = Запрос.Выполнить();
	Если РезультатЗапроса.Пустой() Тогда
		Возврат СформироватьТекстовыйОтвет("Файлы не найдены по заданным критериям.");
	КонецЕсли;

	Выборка = РезультатЗапроса.Выбрать();

	Если НРег(ФорматВывода) = "json" Тогда
		Возврат СформироватьСписокФайловJSON(Выборка);
	Иначе
		Возврат СформироватьСписокФайловMarkdown(Выборка);
	КонецЕсли;

КонецФункции

// ============================================================
// download_file — скачивание файла
// ============================================================
Функция СкачатьФайл(Аргументы)

	ПривестиАргументы(Аргументы);

	ФайлRefСтрока = ПолучитьАргумент(Аргументы, "fileRef", "");

	Если НЕ ЗначениеЗаполнено(ФайлRefСтрока) Тогда
		Возврат СформироватьОтветСОшибкой("Параметр fileRef обязателен.");
	КонецЕсли;

	// Находим файл по UUID
	ФайлСсылка = НайтиФайлПоUUID(ФайлRefСтрока);
	Если ФайлСсылка = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой(
			"Файл с UUID '" + ФайлRefСтрока + "' не найден в Справочник.Файлы.");
	КонецЕсли;

	Если ФайлСсылка.ПометкаУдаления Тогда
		Возврат СформироватьОтветСОшибкой(
			"Файл '" + ФайлСсылка.Наименование + "' помечен на удаление.");
	КонецЕсли;

	// Получаем метаданные файла
	ИмяФайла    = ФайлСсылка.Наименование;
	РасшФайла   = ФайлСсылка.ТекущаяВерсияРасширение;
	РазмерФайла = ФайлСсылка.ТекущаяВерсияРазмер;

	// Получаем двоичные данные через типовой API
	ДвоичныеДанные = Неопределено;

	Попытка
		ДвоичныеДанные = РаботаСФайлами.ДвоичныеДанныеФайла(ФайлСсылка, Ложь);
	Исключение
		// API не сработал, пробуем напрямую
	КонецПопытки;

	Если ДвоичныеДанные = Неопределено Тогда
		// Пробуем напрямую через регистр
		ДвоичныеДанные = ПолучитьДвоичныеДанныеИзРегистра(ФайлСсылка);
	КонецЕсли;

	Если ДвоичныеДанные = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой(
			"Не удалось получить двоичные данные файла '" + ИмяФайла + "'.");
	КонецЕсли;

	// Формируем ответ с Base64
	РазмерБайт = ДвоичныеДанные.Размер();
	Строка64 = Base64Строка(ДвоичныеДанные);

	// Строим JSON ответ вручную, чтобы избежать проблем с сериализацией большой строки
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписьJSON.ЗаписатьНачалоОбъекта();
	ЗаписьJSON.ЗаписатьИмяСвойства("success");
	ЗаписьJSON.ЗаписатьЗначение(Истина);
	ЗаписьJSON.ЗаписатьИмяСвойства("fileName");
	ЗаписьJSON.ЗаписатьЗначение(ИмяФайла);
	ЗаписьJSON.ЗаписатьИмяСвойства("extension");
	ЗаписьJSON.ЗаписатьЗначение(РасшФайла);
	ЗаписьJSON.ЗаписатьИмяСвойства("sizeBytes");
	ЗаписьJSON.ЗаписатьЗначение(РазмерБайт);
	ЗаписьJSON.ЗаписатьИмяСвойства("encoding");
	ЗаписьJSON.ЗаписатьЗначение("base64");
	ЗаписьJSON.ЗаписатьИмяСвойства("data");
	ЗаписьJSON.ЗаписатьЗначение(Строка64);
	ЗаписьJSON.ЗаписатьКонецОбъекта();

	СтрокаJSON = ЗаписьJSON.Закрыть();

	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(СтрокаJSON));
	Возврат МассивСодержимого;

КонецФункции

#КонецОбласти

#Область ВспомогательныеФункции

// Получение двоичных данных напрямую из регистра сведений
Функция ПолучитьДвоичныеДанныеИзРегистра(ФайлСсылка)

	// Определяем ключ для регистра: ТекущаяВерсия или сам файл
	КлючФайла = ФайлСсылка;

	Попытка
		ТекущаяВерсия = ФайлСсылка.ТекущаяВерсия;
		Если ЗначениеЗаполнено(ТекущаяВерсия) Тогда
			КлючФайла = ТекущаяВерсия;
		КонецЕсли;
	Исключение
	КонецПопытки;

	Попытка
		МенеджерЗаписи = РегистрыСведений.ДвоичныеДанныеФайлов.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.Файл = КлючФайла;
		МенеджерЗаписи.Прочитать();

		ХранилищеЗначения = МенеджерЗаписи.ДвоичныеДанныеФайла;
		Если ХранилищеЗначения <> Неопределено Тогда
			Возврат ХранилищеЗначения.Получить();
		КонецЕсли;
	Исключение
	КонецПопытки;

	Возврат Неопределено;

КонецФункции

// Поиск файла по UUID строке
Функция НайтиФайлПоUUID(СтрокаUUID)

	Попытка
		УникальныйИД = Новый УникальныйИдентификатор(СтрокаUUID);
	Исключение
		Возврат Неопределено;
	КонецПопытки;

	ФайлСсылка = Справочники.Файлы.ПолучитьСсылку(УникальныйИД);

	// Проверяем существование через запрос
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Файлы.Ссылка
	|ИЗ
	|	Справочник.Файлы КАК Файлы
	|ГДЕ
	|	Файлы.Ссылка = &Ссылка";
	Запрос.УстановитьПараметр("Ссылка", ФайлСсылка);

	Если Запрос.Выполнить().Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;

	Возврат ФайлСсылка;

КонецФункции

// Поиск произвольного объекта-владельца по UUID
Функция НайтиВладельцаПоUUID(СтрокаUUID)

	Попытка
		УникальныйИД = Новый УникальныйИдентификатор(СтрокаUUID);
	Исключение
		Возврат Неопределено;
	КонецПопытки;

	// Ищем среди типов, которые могут быть владельцами файлов
	ТипыВладельцев = Новый Массив;
	ТипыВладельцев.Добавить("ВходящееПисьмо");
	ТипыВладельцев.Добавить("ИсходящееПисьмо");
	ТипыВладельцев.Добавить("Задача");
	ТипыВладельцев.Добавить("ДействиеЗадачи");

	// Документы
	Для Каждого ИмяДокумента Из ТипыВладельцев Цикл
		Попытка
			МетаОбъект = Метаданные.Документы.Найти(ИмяДокумента);
			Если МетаОбъект <> Неопределено Тогда
				Ссылка = Документы[ИмяДокумента].ПолучитьСсылку(УникальныйИД);
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Т.Ссылка ИЗ Документ." + ИмяДокумента + " КАК Т ГДЕ Т.Ссылка = &Ссылка";
				Запрос.УстановитьПараметр("Ссылка", Ссылка);
				Если НЕ Запрос.Выполнить().Пустой() Тогда
					Возврат Ссылка;
				КонецЕсли;
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецЦикла;

	// Справочники
	ТипыСправочников = Новый Массив;
	ТипыСправочников.Добавить("ДокументыПредприятия");
	ТипыСправочников.Добавить("ПапкиФайлов");
	ТипыСправочников.Добавить("Контрагенты");
	ТипыСправочников.Добавить("Мероприятия");
	ТипыСправочников.Добавить("ШаблоныДокументов");
	ТипыСправочников.Добавить("ШаблоныПисем");

	Для Каждого ИмяСправочника Из ТипыСправочников Цикл
		Попытка
			МетаОбъект = Метаданные.Справочники.Найти(ИмяСправочника);
			Если МетаОбъект <> Неопределено Тогда
				Ссылка = Справочники[ИмяСправочника].ПолучитьСсылку(УникальныйИД);
				Запрос = Новый Запрос;
				Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 Т.Ссылка ИЗ Справочник." + ИмяСправочника + " КАК Т ГДЕ Т.Ссылка = &Ссылка";
				Запрос.УстановитьПараметр("Ссылка", Ссылка);
				Если НЕ Запрос.Выполнить().Пустой() Тогда
					Возврат Ссылка;
				КонецЕсли;
			КонецЕсли;
		Исключение
		КонецПопытки;
	КонецЦикла;

	Возврат Неопределено;

КонецФункции

// Определить полное имя типа владельца по короткому имени
Функция ОпределитьТипВладельца(КороткоеИмя)

	// Таблица соответствий: короткое имя (в нижнем регистре) → полное имя для ССЫЛКА
	Соответствия = Новый Соответствие;
	Соответствия.Вставить("входящееписьмо",       "Документ.ВходящееПисьмо");
	Соответствия.Вставить("исходящееписьмо",      "Документ.ИсходящееПисьмо");
	Соответствия.Вставить("задача",               "Документ.Задача");
	Соответствия.Вставить("действиезадачи",       "Документ.ДействиеЗадачи");
	Соответствия.Вставить("документыпредприятия",  "Справочник.ДокументыПредприятия");
	Соответствия.Вставить("папкифайлов",          "Справочник.ПапкиФайлов");
	Соответствия.Вставить("контрагенты",          "Справочник.Контрагенты");
	Соответствия.Вставить("мероприятия",          "Справочник.Мероприятия");
	Соответствия.Вставить("шаблоныдокументов",    "Справочник.ШаблоныДокументов");
	Соответствия.Вставить("шаблоныписем",         "Справочник.ШаблоныПисем");
	Соответствия.Вставить("шаблонытекстов",       "Справочник.ШаблоныТекстов");

	Результат = Соответствия.Получить(НРег(КороткоеИмя));
	Если Результат <> Неопределено Тогда
		Возврат Результат;
	КонецЕсли;

	// Пробуем как полное имя: "Документ.ХХХ" или "Справочник.ХХХ"
	Если СтрНайти(КороткоеИмя, ".") > 0 Тогда
		Возврат КороткоеИмя;
	КонецЕсли;

	// Пробуем как имя документа
	МетаОбъект = Метаданные.Документы.Найти(КороткоеИмя);
	Если МетаОбъект <> Неопределено Тогда
		Возврат "Документ." + КороткоеИмя;
	КонецЕсли;

	// Пробуем как имя справочника
	МетаОбъект = Метаданные.Справочники.Найти(КороткоеИмя);
	Если МетаОбъект <> Неопределено Тогда
		Возврат "Справочник." + КороткоеИмя;
	КонецЕсли;

	// Пробуем как бизнес-процесс
	МетаОбъект = Метаданные.БизнесПроцессы.Найти(КороткоеИмя);
	Если МетаОбъект <> Неопределено Тогда
		Возврат "БизнесПроцесс." + КороткоеИмя;
	КонецЕсли;

	Возврат Неопределено;

КонецФункции

// ============================================================
// Форматирование ответов
// ============================================================

Функция СформироватьСписокФайловJSON(Выборка)

	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписьJSON.ЗаписатьНачалоОбъекта();

	ЗаписьJSON.ЗаписатьИмяСвойства("success");
	ЗаписьJSON.ЗаписатьЗначение(Истина);

	Счетчик = 0;
	ЗаписьJSON.ЗаписатьИмяСвойства("files");
	ЗаписьJSON.ЗаписатьНачалоМассива();

	Пока Выборка.Следующий() Цикл
		Счетчик = Счетчик + 1;
		ЗаписьJSON.ЗаписатьНачалоОбъекта();

		ЗаписьJSON.ЗаписатьИмяСвойства("ref");
		ЗаписьJSON.ЗаписатьЗначение(Строка(Выборка.Ссылка.УникальныйИдентификатор()));

		ЗаписьJSON.ЗаписатьИмяСвойства("name");
		ЗаписьJSON.ЗаписатьЗначение(Выборка.Наименование);

		ЗаписьJSON.ЗаписатьИмяСвойства("extension");
		ЗаписьJSON.ЗаписатьЗначение(Выборка.Расширение);

		ЗаписьJSON.ЗаписатьИмяСвойства("sizeBytes");
		ЗаписьJSON.ЗаписатьЗначение(Выборка.Размер);

		ЗаписьJSON.ЗаписатьИмяСвойства("sizeFormatted");
		ЗаписьJSON.ЗаписатьЗначение(ФорматРазмераФайла(Выборка.Размер));

		ЗаписьJSON.ЗаписатьИмяСвойства("created");
		ЗаписьJSON.ЗаписатьЗначение(Формат(Выборка.ДатаСоздания, "ДФ=yyyy-MM-dd'T'HH:mm:ss"));

		ЗаписьJSON.ЗаписатьИмяСвойства("modified");
		ЗаписьJSON.ЗаписатьЗначение(Формат(Выборка.ДатаМодификации, "ДФ=yyyy-MM-dd'T'HH:mm:ss"));

		ЗаписьJSON.ЗаписатьИмяСвойства("owner");
		ЗаписьJSON.ЗаписатьЗначение(Выборка.Владелец);

		ЗаписьJSON.ЗаписатьИмяСвойства("author");
		ЗаписьJSON.ЗаписатьЗначение(Выборка.Автор);

		ЗаписьJSON.ЗаписатьКонецОбъекта();
	КонецЦикла;

	ЗаписьJSON.ЗаписатьКонецМассива();

	ЗаписьJSON.ЗаписатьИмяСвойства("count");
	ЗаписьJSON.ЗаписатьЗначение(Счетчик);

	ЗаписьJSON.ЗаписатьКонецОбъекта();

	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(ЗаписьJSON.Закрыть()));
	Возврат МассивСодержимого;

КонецФункции

Функция СформироватьСписокФайловMarkdown(Выборка)

	Текст = "## Найденные файлы" + Символы.ПС + Символы.ПС;
	Текст = Текст + "| # | Имя файла | Расш. | Размер | Дата | Владелец | UUID |" + Символы.ПС;
	Текст = Текст + "|---|-----------|-------|--------|------|----------|------|" + Символы.ПС;

	Счетчик = 0;
	Пока Выборка.Следующий() Цикл
		Счетчик = Счетчик + 1;
		Текст = Текст
			+ "| " + Формат(Счетчик, "ЧГ=")
			+ " | " + Выборка.Наименование
			+ " | " + Выборка.Расширение
			+ " | " + ФорматРазмераФайла(Выборка.Размер)
			+ " | " + Формат(Выборка.ДатаСоздания, "ДФ=dd.MM.yyyy")
			+ " | " + Выборка.Владелец
			+ " | " + Строка(Выборка.Ссылка.УникальныйИдентификатор())
			+ " |" + Символы.ПС;
	КонецЦикла;

	Текст = Текст + Символы.ПС + "Всего: " + Формат(Счетчик, "ЧГ=") + " файл(ов)";

	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(Текст));
	Возврат МассивСодержимого;

КонецФункции

// ============================================================
// Утилиты
// ============================================================

Функция ФорматРазмераФайла(РазмерБайт)

	Если РазмерБайт = 0 ИЛИ РазмерБайт = Неопределено Тогда
		Возврат "0 Б";
	ИначеЕсли РазмерБайт < 1024 Тогда
		Возврат Формат(РазмерБайт, "ЧГ=") + " Б";
	ИначеЕсли РазмерБайт < 1048576 Тогда
		Возврат Формат(Окр(РазмерБайт / 1024, 1), "ЧРД=.; ЧГ=") + " КБ";
	Иначе
		Возврат Формат(Окр(РазмерБайт / 1048576, 1), "ЧРД=.; ЧГ=") + " МБ";
	КонецЕсли;

КонецФункции

Процедура ПривестиАргументы(Аргументы)

	Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
		АргументыСтруктура = Новый Структура;
		Для Каждого КЗ Из Аргументы Цикл
			АргументыСтруктура.Вставить(Строка(КЗ.Ключ), КЗ.Значение);
		КонецЦикла;
		Аргументы = АргументыСтруктура;
	КонецЕсли;

КонецПроцедуры

Функция ПолучитьАргумент(Аргументы, ИмяПараметра, ЗначениеПоУмолчанию)

	Если ТипЗнч(Аргументы) = Тип("Структура") Тогда
		Если Аргументы.Свойство(ИмяПараметра) Тогда
			Значение = Аргументы[ИмяПараметра];
			Если Значение <> Неопределено И Значение <> "" Тогда
				Возврат Значение;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	Возврат ЗначениеПоУмолчанию;

КонецФункции

Функция СформироватьОтветСОшибкой(ТекстОшибки)

	МассивСодержимого = Новый Массив;
	СодержимоеОшибки = Новый Структура;
	СодержимоеОшибки.Вставить("type", "text");
	СодержимоеОшибки.Вставить("text", "ОШИБКА: " + ТекстОшибки);
	СодержимоеОшибки.Вставить("isError", Истина);
	МассивСодержимого.Добавить(СодержимоеОшибки);
	Возврат МассивСодержимого;

КонецФункции

Функция СформироватьТекстовыйОтвет(Текст)

	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(Текст));
	Возврат МассивСодержимого;

КонецФункции

#КонецОбласти
