#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт

	ДобавитьИнструментЧтениеДанных(Инструменты);

КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Попытка
		Если ИмяИнструмента = "read_object_data" Тогда
			Возврат ПрочитатьДанныеОбъекта(Аргументы);
		Иначе
			Возврат СформироватьОтветСОшибкой("Неизвестный инструмент: " + ИмяИнструмента);
		КонецЕсли;
	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		
		СообщениеОшибки = СтрШаблон("Ошибка выполнения инструмента '%1': %2",
			ИмяИнструмента,
			ОписаниеОшибкиТекст);
		
		// Логируем ошибку
		Попытка
			ЗаписьЖурналаРегистрации("MCP.read_object_data", УровеньЖурналаРегистрации.Ошибка, , , 
				СообщениеОшибки + Символы.ПС + ПодробноеОписание);
		Исключение
			// Игнорируем ошибки логирования
		КонецПопытки;
		
		// Возвращаем ошибку в формате MCP вместо исключения
		Возврат СформироватьОтветСОшибкой(СообщениеОшибки + Символы.ПС + ПодробноеОписание);
	КонецПопытки;

КонецФункции

// Формирует ответ MCP с ошибкой
//
// Параметры:
//  ТекстОшибки - Строка - текст ошибки для отображения
//
// Возвращаемое значение:
//  Массив - массив содержимого MCP с ошибкой
//
Функция СформироватьОтветСОшибкой(ТекстОшибки)
	
	МассивСодержимого = Новый Массив;
	
	СодержимоеОшибки = Новый Структура;
	СодержимоеОшибки.Вставить("type", "text");
	СодержимоеОшибки.Вставить("text", "ОШИБКА: " + ТекстОшибки);
	СодержимоеОшибки.Вставить("isError", Истина);
	
	МассивСодержимого.Добавить(СодержимоеОшибки);
	
	Возврат МассивСодержимого;
	
КонецФункции

#КонецОбласти

#Область ИнструментЧтениеДанных

Процедура ДобавитьИнструментЧтениеДанных(Инструменты)

	// Создаем описания параметров для инструмента read_object_data
	МассивПараметров = Новый Массив;
	
	// Параметр metaType - тип объекта метаданных
	СписокТиповМетаданных = "Catalogs,Documents,InformationRegisters,AccumulationRegisters,AccountingRegisters,CalculationRegisters";
	
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"metaType",
		"string",
		"Тип объекта метаданных: Catalogs, Documents, InformationRegisters, AccumulationRegisters, AccountingRegisters, CalculationRegisters",
		,
		Истина,
		СписокТиповМетаданных
	));
	
	// Параметр name - имя объекта метаданных
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"name",
		"string",
		"Точное имя объекта метаданных (без учета регистра)",
		,
		Истина
	));
	
	// Параметр mode - режим чтения
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"mode",
		"string",
		"Режим чтения: 'catalog_item' (элемент справочника), 'document_header' (заголовок документа), 'document_table_part' (табличная часть документа), 'register_slice' (срез регистра)",
		,
		Истина,
		"catalog_item,document_header,document_table_part,register_slice"
	));
	
	// Параметр operation - операция (чтение, запись, пометка на удаление)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"operation",
		"string",
		"Операция: 'read' (чтение), 'write' (запись), 'mark_for_deletion' (пометка на удаление). По умолчанию 'read'",
		"read",
		Ложь,
		"read,write,mark_for_deletion"
	));
	
	// Параметр data - данные для записи
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"data",
		"object",
		"Данные для записи в формате JSON объекта"
	));
	
	// Параметр selector - идентификатор объекта (ссылка, номер, код или фильтры)
	// Тип ставим string, чтобы разрешить простые вызовы для справочников/документов; для регистров можно передавать JSON-строку структуры
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"selector",
		"string",
		"Идентификатор объекта: для справочников/документов — строка (UUID ссылки, номер или код); для регистров — JSON-строка структуры с измерениями и условиями"
	));
	
	// Параметр tablePart - имя табличной части (для mode='document_table_part')
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"tablePart",
		"string",
		"Имя табличной части документа (обязательно для mode='document_table_part')"
	));
	
	// Параметр fields - список полей для выборки (массив строк)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструментаМассив(
		"fields",
		"string",
		"Список полей для выборки. Если не указан, возвращаются все поля."
	));
	
	// Параметр maxRows - максимальное количество строк
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"maxRows",
		"number",
		"Максимальное количество строк в результате (по умолчанию 1000, максимум 10000)",
		1000
	));
	
	// Параметр format - формат результата
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"format",
		"string",
		"Формат результата: 'markdown' (удобочитаемая таблица) или 'json' (структурированные данные). По умолчанию 'markdown'",
		"markdown",
		Ложь,
		"markdown,json"
	));
	
	// Создаем JSON-схему параметров
	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);
	
	// Добавляем инструмент в таблицу
	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"read_object_data",
		"Чтение данных объектов базы данных 1С:Предприятие (элементы справочников, документы, табличные части, срезы регистров)",
		СхемаПараметров
	);

КонецПроцедуры

Функция ПрочитатьДанныеОбъекта(Аргументы)

	// Приводим Соответствие к Структуре, чтобы работал доступ через точки (metaType, name, mode и т.д.)
	Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
		АргументыСтруктура = Новый Структура;
		Для Каждого КлючЗначение Из Аргументы Цикл
			АргументыСтруктура.Вставить(Строка(КлючЗначение.Ключ), КлючЗначение.Значение);
		КонецЦикла;
		Аргументы = АргументыСтруктура;
	ИначеЕсли ТипЗнч(Аргументы) <> Тип("Структура") Тогда
		ВызватьИсключение СтрШаблон("Аргументы должны быть структурой или соответствием. Получен тип: %1", ТипЗнч(Аргументы));
	КонецЕсли;

	МетаТип = ?(Аргументы.Свойство("metaType"), Аргументы.metaType, "");
	ИмяОбъекта = ?(Аргументы.Свойство("name"), Аргументы.name, "");
	Режим = ?(Аргументы.Свойство("mode"), Аргументы.mode, "");
	Селектор = ?(Аргументы.Свойство("selector"), Аргументы.selector, Неопределено);
	ТабличнаяЧасть = ?(Аргументы.Свойство("tablePart"), Аргументы.tablePart, "");
	Поля = ?(Аргументы.Свойство("fields"), Аргументы.fields, Неопределено);
	МаксСтрок = ?(Аргументы.Свойство("maxRows"), Аргументы.maxRows, 1000);
	ФорматРезультата = ?(Аргументы.Свойство("format"), Аргументы.format, "markdown");
	Операция = ?(Аргументы.Свойство("operation"), Аргументы.operation, "read");
	Данные = ?(Аргументы.Свойство("data"), Аргументы.data, Неопределено);

	// Для register_slice допускаем JSON-строку селектора и пытаемся преобразовать в структуру
	Если Режим = "register_slice" И ТипЗнч(Селектор) = Тип("Строка") И ЗначениеЗаполнено(Селектор) Тогда
		Попытка
			СелекторJSON = mcp_ОбщегоНазначения.JSONВСтруктуру(Селектор);
			Если ТипЗнч(СелекторJSON) = Тип("Структура") Тогда
				Селектор = СелекторJSON;
			КонецЕсли;
		Исключение
			// Оставляем как есть — далее будет ошибка валидации параметров
		КонецПопытки;
	КонецЕсли;

	// Для справочников/документов ожидаем строковый селектор; если пришла структура (из-за схемы MCP), нормализуем
	Если Режим <> "register_slice" Тогда
		Селектор = НормализоватьСтроковыйСелектор(Селектор, Режим);
	КонецЕсли;

	// Для режимов, где ожидается строковый селектор (справочники, документы, табличные части),
	// пытаемся извлечь строку из структуры, если она пришла как JSON-объект (из-за схемы параметров "object").
	Если Режим <> "register_slice" Тогда
		Если ТипЗнч(Селектор) = Тип("Структура") Тогда
			Селектор = НормализоватьСелекторВСтроку(Селектор);
		КонецЕсли;
	КонецЕсли;
	
	// Валидация параметров
	Если НЕ ЗначениеЗаполнено(МетаТип) Или НЕ ЗначениеЗаполнено(ИмяОбъекта) Или НЕ ЗначениеЗаполнено(Режим) Тогда
		ВызватьИсключение "Не указаны обязательные параметры: metaType, name, mode";
	КонецЕсли;
	
	// Валидация operation
	Если Операция <> "read" И Операция <> "write" И Операция <> "mark_for_deletion" Тогда
		ВызватьИсключение СтрШаблон("Недопустимое значение параметра operation: %1. Допустимые значения: 'read', 'write', 'mark_for_deletion'", Операция);
	КонецЕсли;
	
	Если ФорматРезультата <> "markdown" И ФорматРезультата <> "json" Тогда
		ВызватьИсключение "Недопустимый формат результата. Допустимые значения: 'markdown', 'json'";
	КонецЕсли;
	
	// Ограничиваем максимальное количество строк для безопасности
	Если МаксСтрок > 10000 Тогда
		МаксСтрок = 10000;
	ИначеЕсли МаксСтрок < 1 Тогда
		МаксСтрок = 1;
	КонецЕсли;
	
	// Получаем метаданные объекта
	МетаданныеОбъекта = mcp_ОбщегоНазначения.ПолучитьМетаданныеОбъекта(МетаТип, ИмяОбъекта);
	Если МетаданныеОбъекта = Неопределено Тогда
		ВызватьИсключение СтрШаблон("Объект метаданных не найден: %1.%2", МетаТип, ИмяОбъекта);
	КонецЕсли;
	
	// Ветвление по операции
	Если Операция = "read" Тогда
		// Существующая логика чтения
		Результат = Неопределено;
		Если Режим = "catalog_item" Тогда
			Если НЕ ЗначениеЗаполнено(Селектор) Тогда
				ВызватьИсключение "Для режима 'catalog_item' необходимо указать параметр 'selector'";
			КонецЕсли;
			Результат = ПрочитатьЭлементСправочника(МетаданныеОбъекта, Селектор, Поля, МаксСтрок, ФорматРезультата);
		ИначеЕсли Режим = "document_header" Тогда
			Если НЕ ЗначениеЗаполнено(Селектор) Тогда
				ВызватьИсключение "Для режима 'document_header' необходимо указать параметр 'selector'";
			КонецЕсли;
			Результат = ПрочитатьЗаголовокДокумента(МетаданныеОбъекта, Селектор, Поля, МаксСтрок, ФорматРезультата);
		ИначеЕсли Режим = "document_table_part" Тогда
			Если НЕ ЗначениеЗаполнено(ТабличнаяЧасть) Тогда
				ВызватьИсключение "Для режима 'document_table_part' необходимо указать параметр tablePart";
			КонецЕсли;
			Если НЕ ЗначениеЗаполнено(Селектор) Тогда
				ВызватьИсключение "Для режима 'document_table_part' необходимо указать параметр 'selector'";
			КонецЕсли;
			Результат = ПрочитатьТабличнуюЧастьДокумента(МетаданныеОбъекта, Селектор, ТабличнаяЧасть, Поля, МаксСтрок, ФорматРезультата);
		ИначеЕсли Режим = "register_slice" Тогда
			Если НЕ ЗначениеЗаполнено(Селектор) Тогда
				ВызватьИсключение "Для режима 'register_slice' необходимо указать параметр 'selector'";
			КонецЕсли;
			Результат = ПрочитатьСрезРегистра(МетаданныеОбъекта, Селектор, Поля, МаксСтрок, ФорматРезультата);
		Иначе
			ВызватьИсключение СтрШаблон("Недопустимый режим: %1", Режим);
		КонецЕсли;
		
		// Формируем результат в формате MCP
		МассивСодержимого = Новый Массив;
		МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(Результат));
		
		Возврат МассивСодержимого;
		
	ИначеЕсли Операция = "write" Тогда
		// Запись данных
		Если НЕ ЗначениеЗаполнено(Данные) Тогда
			ВызватьИсключение "Для операции 'write' необходимо указать параметр 'data'";
		КонецЕсли;
		
		Результат = ЗаписатьДанныеОбъекта(МетаданныеОбъекта, Режим, Селектор, ТабличнаяЧасть, Данные);
		
		// Формируем результат в формате MCP
		МассивСодержимого = Новый Массив;
		МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(Результат));
		
		Возврат МассивСодержимого;
		
	ИначеЕсли Операция = "mark_for_deletion" Тогда
		// Пометка на удаление
		Результат = УстановитьПометкуУдаления(МетаданныеОбъекта, Режим, Селектор);
		
		// Формируем результат в формате MCP
		МассивСодержимого = Новый Массив;
		МассивСодержимого.Добавить(mcp_Содержимое.ТекстовоеСодержимое(Результат));
		
		Возврат МассивСодержимого;
		
	КонецЕсли;

КонецФункции

// Приводит селектор, пришедший как структура JSON, к строке (код/номер/UUID).
// Поддерживает ключи: value, selector, number, номер, code, код, uuid.
Функция НормализоватьСелекторВСтроку(СелекторСтруктура)
	
	Если СелекторСтруктура = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если ТипЗнч(СелекторСтруктура) <> Тип("Структура") Тогда
		Возврат СелекторСтруктура;
	КонецЕсли;
	
	ПотенциальныеКлючи = Новый Массив;
	ПотенциальныеКлючи.Добавить("value");
	ПотенциальныеКлючи.Добавить("selector");
	ПотенциальныеКлючи.Добавить("number");
	ПотенциальныеКлючи.Добавить("номер");
	ПотенциальныеКлючи.Добавить("code");
	ПотенциальныеКлючи.Добавить("код");
	ПотенциальныеКлючи.Добавить("uuid");
	
	Для Каждого Ключ Из ПотенциальныеКлючи Цикл
		Если СелекторСтруктура.Свойство(Ключ) Тогда
			Значение = СелекторСтруктура[Ключ];
			Если ЗначениеЗаполнено(Значение) Тогда
				Возврат Строка(Значение);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	// Если ничего не нашли, возвращаем как есть — дальнейшая логика выдаст понятную ошибку.
	Возврат СелекторСтруктура;
	
КонецФункции

#КонецОбласти

#Область ЧтениеСправочников

Функция ПрочитатьЭлементСправочника(МетаданныеОбъекта, Селектор, Поля, МаксСтрок, ФорматРезультата)
	
	МенеджерСправочника = Справочники[МетаданныеОбъекта.Имя];
	
	// Получаем элемент справочника
	ЭлементСправочника = Неопределено;
	Если ЗначениеЗаполнено(Селектор) И ТипЗнч(Селектор) = Тип("Строка") Тогда
		// Пытаемся получить по ссылке
		Попытка
			ЭлементСправочника = МенеджерСправочника.НайтиПоКоду(Селектор);
		Исключение
			Попытка
				ЭлементСправочника = МенеджерСправочника.НайтиПоНаименованию(Селектор);
			Исключение
				// Пытаемся получить по ссылке через UUID
				Попытка
					ЭлементСправочника = МенеджерСправочника.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
				Исключение
					ВызватьИсключение СтрШаблон("Элемент справочника не найден по селектору: %1", Селектор);
				КонецПопытки;
			КонецПопытки;
		КонецПопытки;
	Иначе
		ВызватьИсключение "Селектор для справочника должен быть строкой (код, наименование или UUID ссылки)";
	КонецЕсли;
	
	Если ЭлементСправочника = Неопределено Тогда
		ВызватьИсключение "Элемент справочника не найден";
	КонецЕсли;
	
	// Получаем объект справочника
	ОбъектСправочника = ЭлементСправочника.ПолучитьОбъект();
	
	// Формируем таблицу значений с данными
	ТаблицаДанных = mcp_ОбщегоНазначения.ОбъектСправочникаВТаблицу(ОбъектСправочника, Поля);
	
	// Преобразуем в нужный формат
	Если ФорматРезультата = "json" Тогда
		РезультатJSON = mcp_ОбщегоНазначения.ТаблицаЗначенийВJSON(ТаблицаДанных, МаксСтрок, Ложь);
		Возврат mcp_ОбщегоНазначения.СтруктураВJSON(РезультатJSON);
	Иначе
		Возврат mcp_ОбщегоНазначения.ТаблицаЗначенийВMarkdown(ТаблицаДанных, МаксСтрок);
	КонецЕсли;

КонецФункции

#КонецОбласти

#Область ЧтениеДокументов

Функция ПрочитатьЗаголовокДокумента(МетаданныеОбъекта, Селектор, Поля, МаксСтрок, ФорматРезультата)
	
	МенеджерДокумента = Документы[МетаданныеОбъекта.Имя];
	
	// Получаем документ
	ОбъектДокумента = НайтиДокументПоСелектору(МенеджерДокумента, МетаданныеОбъекта, Селектор);
	
	Если ОбъектДокумента = Неопределено Тогда
		ВызватьИсключение СтрШаблон("Документ не найден по селектору: %1", Селектор);
	КонецЕсли;
	
	// Формируем таблицу значений с данными заголовка
	ТаблицаДанных = mcp_ОбщегоНазначения.ОбъектДокументаВТаблицу(ОбъектДокумента, Поля);
	
	// Преобразуем в нужный формат
	Если ФорматРезультата = "json" Тогда
		РезультатJSON = mcp_ОбщегоНазначения.ТаблицаЗначенийВJSON(ТаблицаДанных, МаксСтрок, Ложь);
		Возврат mcp_ОбщегоНазначения.СтруктураВJSON(РезультатJSON);
	Иначе
		Возврат mcp_ОбщегоНазначения.ТаблицаЗначенийВMarkdown(ТаблицаДанных, МаксСтрок);
	КонецЕсли;

КонецФункции

Функция ПрочитатьТабличнуюЧастьДокумента(МетаданныеОбъекта, Селектор, ИмяТабличнойЧасти, Поля, МаксСтрок, ФорматРезультата)
	
	МенеджерДокумента = Документы[МетаданныеОбъекта.Имя];
	
	// Получаем документ
	ОбъектДокумента = НайтиДокументПоСелектору(МенеджерДокумента, МетаданныеОбъекта, Селектор);
	
	Если ОбъектДокумента = Неопределено Тогда
		ВызватьИсключение СтрШаблон("Документ не найден по селектору: %1", Селектор);
	КонецЕсли;
	
	// Проверяем наличие табличной части
	МетаданныеТЧ = ОбъектДокумента.Метаданные().ТабличныеЧасти.Найти(ИмяТабличнойЧасти);
	Если МетаданныеТЧ = Неопределено Тогда
		ВызватьИсключение СтрШаблон("Табличная часть '%1' не найдена в документе '%2'", ИмяТабличнойЧасти, МетаданныеОбъекта.Имя);
	КонецЕсли;
	
	// Получаем табличную часть
	ТабличнаяЧасть = ОбъектДокумента[ИмяТабличнойЧасти];
	
	// Формируем таблицу значений
	ТаблицаДанных = mcp_ОбщегоНазначения.ТабличнаяЧастьВТаблицу(ТабличнаяЧасть, Поля, МаксСтрок, МетаданныеТЧ);
	
	// Преобразуем в нужный формат
	Если ФорматРезультата = "json" Тогда
		РезультатJSON = mcp_ОбщегоНазначения.ТаблицаЗначенийВJSON(ТаблицаДанных, МаксСтрок, Ложь);
		Возврат mcp_ОбщегоНазначения.СтруктураВJSON(РезультатJSON);
	Иначе
		Возврат mcp_ОбщегоНазначения.ТаблицаЗначенийВMarkdown(ТаблицаДанных, МаксСтрок);
	КонецЕсли;

КонецФункции

#КонецОбласти

#Область ЧтениеРегистров

Функция ПрочитатьСрезРегистра(МетаданныеОбъекта, Селектор, Поля, МаксСтрок, ФорматРезультата)
	
	// Строим запрос к регистру
	ТекстЗапроса = mcp_ОбщегоНазначения.ПостроитьЗапросКРегистру(МетаданныеОбъекта, Селектор, Поля, МаксСтрок);
	
	Запрос = Новый Запрос;
	Запрос.Текст = ТекстЗапроса;
	
	// Устанавливаем параметры из селектора
	Если Селектор <> Неопределено И ТипЗнч(Селектор) = Тип("Структура") Тогда
		Для Каждого Параметр Из Селектор Цикл
			ИмяПараметра = Параметр.Ключ;
			Значение = Параметр.Значение;
			Если ЗначениеЗаполнено(Значение) Тогда
				Запрос.УстановитьПараметр(ИмяПараметра, Значение);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	Попытка
		РезультатЗапроса = Запрос.Выполнить();
	Исключение
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		Если mcp_ОбщегоНазначения.ЭтоОшибкаПравДоступа(ТекстОшибки) Тогда
			ВызватьИсключение mcp_ОбщегоНазначения.СформироватьСообщениеОбОшибкеПрав(ТекстОшибки);
		Иначе
			ВызватьИсключение СтрШаблон("Ошибка выполнения запроса к регистру: %1", ТекстОшибки);
		КонецЕсли;
	КонецПопытки;
	
	// Преобразуем в нужный формат
	Если ФорматРезультата = "json" Тогда
		РезультатJSON = mcp_ОбщегоНазначения.РезультатЗапросаВJSON(РезультатЗапроса, МаксСтрок, Ложь);
		Возврат mcp_ОбщегоНазначения.СтруктураВJSON(РезультатJSON);
	Иначе
		Возврат mcp_ОбщегоНазначения.РезультатЗапросаВMarkdown(РезультатЗапроса, МаксСтрок);
	КонецЕсли;

КонецФункции

#КонецОбласти

#Область ЗаписьОбъектов

// Диспетчер для записи данных объектов
//
// Параметры:
//  МетаданныеОбъекта - МетаданныеОбъекта - метаданные объекта
//  Режим - Строка - режим работы
//  Селектор - Произвольный - идентификатор объекта
//  ТабличнаяЧасть - Строка - имя табличной части (для режима document_table_part)
//  Данные - Структура - данные для записи
//
// Возвращаемое значение:
//  Строка - результат операции в формате JSON
//
Функция ЗаписатьДанныеОбъекта(МетаданныеОбъекта, Режим, Селектор, ТабличнаяЧасть, Данные)
	
	Результат = Неопределено;
	
	Если Режим = "catalog_item" Тогда
		Результат = ЗаписатьЭлементСправочника(МетаданныеОбъекта, Селектор, Данные);
	ИначеЕсли Режим = "document_header" Тогда
		Результат = ЗаписатьДокумент(МетаданныеОбъекта, Селектор, Данные);
	ИначеЕсли Режим = "document_table_part" Тогда
		Если НЕ ЗначениеЗаполнено(ТабличнаяЧасть) Тогда
			ВызватьИсключение "Для режима 'document_table_part' необходимо указать параметр tablePart";
		КонецЕсли;
		Результат = ЗаписатьТабличнуюЧастьДокумента(МетаданныеОбъекта, Селектор, ТабличнаяЧасть, Данные);
	ИначеЕсли Режим = "register_slice" Тогда
		Результат = ЗаписатьДвиженияРегистра(МетаданныеОбъекта, Данные);
	Иначе
		ВызватьИсключение СтрШаблон("Недопустимый режим для записи: %1", Режим);
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

// Создает или обновляет элемент справочника
//
// Параметры:
//  МетаданныеОбъекта - МетаданныеСправочника - метаданные справочника
//  Селектор - Произвольный - идентификатор элемента (UUID, код или наименование)
//  Данные - Структура - данные для записи
//
// Возвращаемое значение:
//  Строка - результат операции в формате JSON
//
Функция ЗаписатьЭлементСправочника(МетаданныеОбъекта, Селектор, Данные)
	
	МенеджерСправочника = Справочники[МетаданныеОбъекта.Имя];
	
	// Определяем, создаем новый элемент или обновляем существующий
	ЭлементСправочника = Неопределено;
	СозданНовый = Ложь;
	
	Если ЗначениеЗаполнено(Селектор) Тогда
		// Пытаемся найти существующий элемент
		Если ТипЗнч(Селектор) = Тип("Строка") Тогда
			Попытка
				ЭлементСправочника = МенеджерСправочника.НайтиПоКоду(Селектор);
			Исключение
				Попытка
					ЭлементСправочника = МенеджерСправочника.НайтиПоНаименованию(Селектор);
				Исключение
					Попытка
						ЭлементСправочника = МенеджерСправочника.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
					Исключение
						// Элемент не найден, создадим новый
					КонецПопытки;
				КонецПопытки;
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
	
	// Если элемент не найден, создаем новый
	Если ЭлементСправочника = Неопределено Тогда
		ЭлементСправочника = МенеджерСправочника.СоздатьЭлемент();
		СозданНовый = Истина;
	Иначе
		ЭлементСправочника = ЭлементСправочника.ПолучитьОбъект();
	КонецЕсли;
	
	// Преобразуем данные из JSON в структуру, если нужно
	Если ТипЗнч(Данные) = Тип("Строка") Тогда
		Данные = mcp_ОбщегоНазначения.JSONВСтруктуру(Данные);
	КонецЕсли;
	
	// Заполняем объект данными
	Попытка
		mcp_ОбщегоНазначения.JSONВОбъектСправочника(ЭлементСправочника, Данные);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка заполнения элемента справочника: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Записываем объект
	Попытка
		ЭлементСправочника.Записать();
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка записи элемента справочника: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Формируем результат
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("operation", ?(СозданНовый, "created", "updated"));
	Результат.Вставить("reference", Строка(ЭлементСправочника.Ссылка));
	Результат.Вставить("message", ?(СозданНовый, "Элемент справочника создан", "Элемент справочника обновлен"));
	
	Возврат mcp_ОбщегоНазначения.СтруктураВJSON(Результат);

КонецФункции

// Создает или обновляет документ
//
// Параметры:
//  МетаданныеОбъекта - МетаданныеДокумента - метаданные документа
//  Селектор - Произвольный - идентификатор документа (UUID или номер)
//  Данные - Структура - данные для записи
//
// Возвращаемое значение:
//  Строка - результат операции в формате JSON
//
Функция ЗаписатьДокумент(МетаданныеОбъекта, Селектор, Данные)
	
	// Включаем привилегированный режим для обхода проверок прав и RLS
	УстановитьПривилегированныйРежим(Истина);
	
	МенеджерДокумента = Документы[МетаданныеОбъекта.Имя];
	
	// Определяем, создаем новый документ или обновляем существующий
	Документ = Неопределено;
	СозданНовый = Ложь;
	
	Если ЗначениеЗаполнено(Селектор) Тогда
		// Пытаемся найти существующий документ
		Документ = НайтиДокументПоСелектору(МенеджерДокумента, МетаданныеОбъекта, Селектор);
	КонецЕсли;
	
	// Если документ не найден, создаем новый
	Если Документ = Неопределено Тогда
		Документ = МенеджерДокумента.СоздатьДокумент();
		СозданНовый = Истина;
	КонецЕсли;
	
	// Преобразуем данные из JSON в структуру, если нужно
	Если ТипЗнч(Данные) = Тип("Строка") Тогда
		Данные = mcp_ОбщегоНазначения.JSONВСтруктуру(Данные);
	КонецЕсли;
	
	// Заполняем объект данными
	Попытка
		mcp_ОбщегоНазначения.JSONВОбъектДокумента(Документ, Данные);
	Исключение
		УстановитьПривилегированныйРежим(Ложь);
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка заполнения документа: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Записываем документ (неоперативно, чтобы не пересчитывать остатки)
	Попытка
		Документ.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
	Исключение
		УстановитьПривилегированныйРежим(Ложь);
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка записи документа: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Формируем результат
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("operation", ?(СозданНовый, "created", "updated"));
	Результат.Вставить("reference", Строка(Документ.Ссылка));
	Результат.Вставить("number", Документ.Номер);
	Результат.Вставить("message", ?(СозданНовый, "Документ создан и проведен", "Документ обновлен и проведен"));
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат mcp_ОбщегоНазначения.СтруктураВJSON(Результат);

КонецФункции

// Записывает табличную часть документа
//
// Параметры:
//  МетаданныеОбъекта - МетаданныеДокумента - метаданные документа
//  Селектор - Произвольный - идентификатор документа (UUID или номер)
//  ТабличнаяЧасть - Строка - имя табличной части
//  Данные - Массив - массив объектов с данными строк табличной части
//
// Возвращаемое значение:
//  Строка - результат операции в формате JSON
//
Функция ЗаписатьТабличнуюЧастьДокумента(МетаданныеОбъекта, Селектор, ТабличнаяЧасть, Данные)
	
	// Включаем привилегированный режим
	УстановитьПривилегированныйРежим(Истина);
	
	МенеджерДокумента = Документы[МетаданныеОбъекта.Имя];
	
	// Получаем документ через универсальную функцию поиска
	Документ = Неопределено;
	Если ЗначениеЗаполнено(Селектор) Тогда
		Документ = НайтиДокументПоСелектору(МенеджерДокумента, МетаданныеОбъекта, Селектор);
	КонецЕсли;
	
	Если Документ = Неопределено Тогда
		УстановитьПривилегированныйРежим(Ложь);
		ВызватьИсключение СтрШаблон("Документ не найден по селектору: %1", Селектор);
	КонецЕсли;
	
	// Проверяем наличие табличной части в метаданных
	ТабличнаяЧастьМД = МетаданныеОбъекта.ТабличныеЧасти.Найти(ТабличнаяЧасть);
	Если ТабличнаяЧастьМД = Неопределено Тогда
		УстановитьПривилегированныйРежим(Ложь);
		ВызватьИсключение СтрШаблон("Табличная часть '%1' не найдена в документе '%2'", ТабличнаяЧасть, МетаданныеОбъекта.Имя);
	КонецЕсли;
	
	// Преобразуем данные в массив строк табличной части
	Если ТипЗнч(Данные) = Тип("Строка") Тогда
		Данные = mcp_ОбщегоНазначения.JSONВСтруктуру(Данные);
	КонецЕсли;
	
	// Извлекаем режим и ключевое поле из структуры данных
	Режим = "replace";
	КлючевоеПоле = "";
	МассивСтрок = Неопределено;
	
	// Если данные — структура, извлекаем массив строк и параметры
	Если ТипЗнч(Данные) = Тип("Структура") ИЛИ ТипЗнч(Данные) = Тип("Соответствие") Тогда
		// Извлекаем режим
		Если ТипЗнч(Данные) = Тип("Соответствие") Тогда
			РежимИзДанных = Данные.Получить("mode");
			Если РежимИзДанных = Неопределено Тогда
				РежимИзДанных = Данные.Получить("режим");
			КонецЕсли;
			Если РежимИзДанных <> Неопределено Тогда
				Режим = Строка(РежимИзДанных);
			КонецЕсли;
			
			// Извлекаем ключевое поле
			КлючевоеПолеИзДанных = Данные.Получить("_key");
			Если КлючевоеПолеИзДанных = Неопределено Тогда
				КлючевоеПолеИзДанных = Данные.Получить("key");
			КонецЕсли;
			Если КлючевоеПолеИзДанных <> Неопределено Тогда
				КлючевоеПоле = Строка(КлючевоеПолеИзДанных);
			КонецЕсли;
			
			// Извлекаем массив строк
			МассивСтрок = Данные.Получить("строки");
			Если МассивСтрок = Неопределено Тогда
				МассивСтрок = Данные.Получить("rows");
			КонецЕсли;
		Иначе
			// Структура
			Если Данные.Свойство("mode") Тогда
				Режим = Строка(Данные.mode);
			ИначеЕсли Данные.Свойство("режим") Тогда
				Режим = Строка(Данные.режим);
			КонецЕсли;
			
			Если Данные.Свойство("_key") Тогда
				КлючевоеПоле = Строка(Данные._key);
			ИначеЕсли Данные.Свойство("key") Тогда
				КлючевоеПоле = Строка(Данные.key);
			КонецЕсли;
			
			Если Данные.Свойство("строки") Тогда
				МассивСтрок = Данные.строки;
			ИначеЕсли Данные.Свойство("rows") Тогда
				МассивСтрок = Данные.rows;
			КонецЕсли;
		КонецЕсли;
		
		Если МассивСтрок <> Неопределено Тогда
			Данные = МассивСтрок;
		КонецЕсли;
	КонецЕсли;
	
	Если ТипЗнч(Данные) <> Тип("Массив") Тогда
		УстановитьПривилегированныйРежим(Ложь);
		ВызватьИсключение "Параметр 'data' для табличной части должен быть массивом или объектом со свойством 'строки'/'rows'";
	КонецЕсли;
	
	// Получаем табличную часть и её метаданные
	ТабличнаяЧастьОбъекта = Документ[ТабличнаяЧасть];
	МетаданныеТЧ = Документ.Метаданные().ТабличныеЧасти.Найти(ТабличнаяЧасть);
	
	// Заполняем табличную часть
	Попытка
		mcp_ОбщегоНазначения.JSONВТабличнуюЧасть(ТабличнаяЧастьОбъекта, Данные, МетаданныеТЧ, Режим, КлючевоеПоле);
	Исключение
		УстановитьПривилегированныйРежим(Ложь);
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка заполнения табличной части: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Записываем документ (неоперативно)
	Попытка
		Документ.Записать(РежимЗаписиДокумента.Проведение, РежимПроведенияДокумента.Неоперативный);
	Исключение
		УстановитьПривилегированныйРежим(Ложь);
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка записи документа: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Формируем результат
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("reference", Строка(Документ.Ссылка));
	Результат.Вставить("tablePart", ТабличнаяЧасть);
	Результат.Вставить("rowsCount", ТабличнаяЧастьОбъекта.Количество());
	Результат.Вставить("message", "Табличная часть записана");
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат mcp_ОбщегоНазначения.СтруктураВJSON(Результат);

КонецФункции

// Записывает движения регистра
//
// Параметры:
//  МетаданныеОбъекта - МетаданныеРегистра - метаданные регистра
//  Данные - Массив - массив объектов с данными движений
//
// Возвращаемое значение:
//  Строка - результат операции в формате JSON
//
Функция ЗаписатьДвиженияРегистра(МетаданныеОбъекта, Данные)
	
	// Определяем тип регистра и получаем менеджер записи
	МенеджерЗаписи = Неопределено;
	ИмяРегистра = МетаданныеОбъекта.Имя;
	
	Если Метаданные.ИнформационныеРегистры.Содержит(МетаданныеОбъекта) Тогда
		МенеджерЗаписи = РегистрыСведений[ИмяРегистра].СоздатьМенеджерЗаписи();
	ИначеЕсли Метаданные.РегистрыНакопления.Содержит(МетаданныеОбъекта) Тогда
		МенеджерЗаписи = РегистрыНакопления[ИмяРегистра].СоздатьМенеджерЗаписи();
	ИначеЕсли Метаданные.РегистрыБухгалтерии.Содержит(МетаданныеОбъекта) Тогда
		МенеджерЗаписи = РегистрыБухгалтерии[ИмяРегистра].СоздатьМенеджерЗаписи();
	ИначеЕсли Метаданные.РегистрыРасчета.Содержит(МетаданныеОбъекта) Тогда
		МенеджерЗаписи = РегистрыРасчета[ИмяРегистра].СоздатьМенеджерЗаписи();
	Иначе
		ВызватьИсключение СтрШаблон("Неизвестный тип регистра: %1", ИмяРегистра);
	КонецЕсли;
	
	// Преобразуем данные из JSON в массив, если нужно
	Если ТипЗнч(Данные) = Тип("Строка") Тогда
		ДанныеJSON = mcp_ОбщегоНазначения.JSONВСтруктуру(Данные);
		Если ТипЗнч(ДанныеJSON) = Тип("Массив") Тогда
			Данные = ДанныеJSON;
		Иначе
			ВызватьИсключение "Параметр 'data' для регистра должен быть массивом";
		КонецЕсли;
	КонецЕсли;
	
	// Создаем набор записей
	НаборЗаписей = МенеджерЗаписи.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Период.Установить(ТекущаяДатаСеанса());
	
	// Заполняем движения
	Попытка
		mcp_ОбщегоНазначения.JSONВДвиженияРегистра(НаборЗаписей, Данные);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка заполнения движений регистра: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Записываем движения
	Попытка
		НаборЗаписей.Записать();
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка записи движений регистра: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Формируем результат
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("register", ИмяРегистра);
	Результат.Вставить("movementsCount", Данные.Количество());
	Результат.Вставить("message", "Движения регистра записаны");
	
	Возврат mcp_ОбщегоНазначения.СтруктураВJSON(Результат);

КонецФункции

#КонецОбласти

#Область ПометкаУдаления

// Диспетчер для установки пометки удаления
//
// Параметры:
//  МетаданныеОбъекта - МетаданныеОбъекта - метаданные объекта
//  Режим - Строка - режим работы
//  Селектор - Произвольный - идентификатор объекта
//
// Возвращаемое значение:
//  Строка - результат операции в формате JSON
//
Функция УстановитьПометкуУдаления(МетаданныеОбъекта, Режим, Селектор)
	
	Результат = Неопределено;
	
	Если Режим = "catalog_item" Тогда
		Результат = УстановитьПометкуУдаленияСправочника(МетаданныеОбъекта, Селектор);
	ИначеЕсли Режим = "document_header" Тогда
		Результат = УстановитьПометкуУдаленияДокумента(МетаданныеОбъекта, Селектор);
	Иначе
		ВызватьИсключение СтрШаблон("Режим '%1' не поддерживает операцию пометки на удаление", Режим);
	КонецЕсли;
	
	Возврат Результат;

КонецФункции

// Устанавливает пометку удаления для элемента справочника
//
// Параметры:
//  МетаданныеОбъекта - МетаданныеСправочника - метаданные справочника
//  Селектор - Произвольный - идентификатор элемента
//
// Возвращаемое значение:
//  Строка - результат операции в формате JSON
//
Функция УстановитьПометкуУдаленияСправочника(МетаданныеОбъекта, Селектор)
	
	МенеджерСправочника = Справочники[МетаданныеОбъекта.Имя];
	
	// Получаем элемент справочника
	ЭлементСправочника = Неопределено;
	Если ТипЗнч(Селектор) = Тип("Строка") Тогда
		Попытка
			ЭлементСправочника = МенеджерСправочника.НайтиПоКоду(Селектор);
		Исключение
			Попытка
				ЭлементСправочника = МенеджерСправочника.НайтиПоНаименованию(Селектор);
			Исключение
				Попытка
					ЭлементСправочника = МенеджерСправочника.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
				Исключение
					ВызватьИсключение СтрШаблон("Элемент справочника не найден по селектору: %1", Селектор);
				КонецПопытки;
			КонецПопытки;
		КонецПопытки;
	Иначе
		ВызватьИсключение "Селектор должен быть строкой";
	КонецЕсли;
	
	// Устанавливаем пометку удаления
	Попытка
		ЭлементСправочника.УстановитьПометкуУдаления(Истина);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка установки пометки удаления: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Формируем результат
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("reference", Строка(ЭлементСправочника.Ссылка));
	Результат.Вставить("message", "Пометка удаления установлена");
	
	Возврат mcp_ОбщегоНазначения.СтруктураВJSON(Результат);

КонецФункции

// Устанавливает пометку удаления для документа
//
// Параметры:
//  МетаданныеОбъекта - МетаданныеДокумента - метаданные документа
//  Селектор - Произвольный - идентификатор документа
//
// Возвращаемое значение:
//  Строка - результат операции в формате JSON
//
Функция УстановитьПометкуУдаленияДокумента(МетаданныеОбъекта, Селектор)
	
	МенеджерДокумента = Документы[МетаданныеОбъекта.Имя];
	
	// Получаем документ
	Документ = Неопределено;
	Если ТипЗнч(Селектор) = Тип("Строка") Тогда
		Попытка
			Документ = МенеджерДокумента.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
		Исключение
			Попытка
				Документ = МенеджерДокумента.НайтиПоНомеру(Селектор);
			Исключение
				ВызватьИсключение СтрШаблон("Документ не найден по селектору: %1", Селектор);
			КонецПопытки;
		КонецПопытки;
	Иначе
		ВызватьИсключение "Селектор должен быть строкой";
	КонецЕсли;
	
	// Устанавливаем пометку удаления
	Попытка
		Документ.УстановитьПометкуУдаления(Истина);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		ВызватьИсключение СтрШаблон("Ошибка установки пометки удаления: %1", 
			ПодробноеПредставлениеОшибки(ИнформацияОбОшибке));
	КонецПопытки;
	
	// Формируем результат
	Результат = Новый Структура;
	Результат.Вставить("success", Истина);
	Результат.Вставить("reference", Строка(Документ.Ссылка));
	Результат.Вставить("message", "Пометка удаления установлена");
	
	Возврат mcp_ОбщегоНазначения.СтруктураВJSON(Результат);

КонецФункции

#КонецОбласти

#Область Вспомогательные

// Нормализует селектор для справочников/документов, принимая как строку, так и структуру (из-за типа параметра object)
Функция НормализоватьСтроковыйСелектор(Селектор, Режим)

	Если ТипЗнч(Селектор) = Тип("Строка") Тогда
		Возврат Селектор;
	КонецЕсли;

	Если ТипЗнч(Селектор) = Тип("Структура") Тогда
		// Приоритетно поле value / Значение
		Если Селектор.Свойство("value") Тогда
			Возврат Селектор.value;
		КонецЕсли;
		Если Селектор.Свойство("Значение") Тогда
			Возврат Селектор.Значение;
		КонецЕсли;
		// Для документов часто передают Номер
		Если Селектор.Свойство("Номер") Тогда
			Возврат Селектор.Номер;
		КонецЕсли;
		// Если единственное поле — берем его значение
		Если Селектор.Количество() = 1 Тогда
			Для Каждого КлючЗначение Из Селектор Цикл
				Возврат КлючЗначение.Значение;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;

	ВызватьИсключение СтрШаблон("Селектор для режима '%1' должен быть строкой (номер/код/UUID). Получен тип: %2", Режим, ТипЗнч(Селектор));

КонецФункции

#КонецОбласти

#Область ПоискДокументов

// Ищет документ по селектору
// Селектор может быть:
//   - Строкой: номер документа или UUID
//   - Структурой/Соответствием с полями: Номер, Дата, Контрагент/Партнер
//
// Параметры:
//  МенеджерДокумента - ДокументМенеджер - менеджер документа
//  МетаданныеОбъекта - ОбъектМетаданных - метаданные документа
//  Селектор - Строка, Структура, Соответствие - критерии поиска
//
// Возвращаемое значение:
//  ДокументОбъект, Неопределено - найденный документ (объект) или Неопределено
//
Функция НайтиДокументПоСелектору(МенеджерДокумента, МетаданныеОбъекта, Селектор)
	
	ИмяДокумента = МетаданныеОбъекта.Имя;
	
	// Преобразуем строку-JSON в структуру, если нужно
	Если ТипЗнч(Селектор) = Тип("Строка") Тогда
		// Проверяем, не JSON ли это
		Если СтрНачинаетсяС(СокрЛП(Селектор), "{") Тогда
			Попытка
				Селектор = mcp_ОбщегоНазначения.JSONВСтруктуру(Селектор);
			Исключение
				// Не JSON — оставляем как строку
			КонецПопытки;
		КонецЕсли;
	КонецЕсли;
	
	// Если селектор — простая строка
	Если ТипЗнч(Селектор) = Тип("Строка") Тогда
		Возврат НайтиДокументПоНомеруИлиUUID(МенеджерДокумента, ИмяДокумента, Селектор);
	КонецЕсли;
	
	// Если селектор — структура или соответствие
	Если ТипЗнч(Селектор) = Тип("Структура") ИЛИ ТипЗнч(Селектор) = Тип("Соответствие") Тогда
		Возврат НайтиДокументПоКритериям(МенеджерДокумента, ИмяДокумента, Селектор);
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Ищет документ по номеру или UUID (простой поиск)
Функция НайтиДокументПоНомеруИлиUUID(МенеджерДокумента, ИмяДокумента, Селектор)
	
	Документ = Неопределено;
	
	// Способ 1: Поиск через запрос по номеру (сортируем по дате убыванием)
	Запрос = Новый Запрос;
	Запрос.Текст = СтрШаблон(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Док.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.%1 КАК Док
		|ГДЕ
		|	Док.Номер ПОДОБНО &Номер
		|УПОРЯДОЧИТЬ ПО
		|	Док.Дата УБЫВ", ИмяДокумента);
	Запрос.УстановитьПараметр("Номер", "%" + Селектор);
	
	Попытка
		Результат = Запрос.Выполнить();
	Исключение
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		Если mcp_ОбщегоНазначения.ЭтоОшибкаПравДоступа(ТекстОшибки) Тогда
			ВызватьИсключение mcp_ОбщегоНазначения.СформироватьСообщениеОбОшибкеПрав(ТекстОшибки);
		Иначе
			ВызватьИсключение СтрШаблон("Ошибка поиска документа по номеру: %1", ТекстОшибки);
		КонецЕсли;
	КонецПопытки;
	
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Документ = Выборка.Ссылка.ПолучитьОбъект();
	КонецЕсли;
	
	// Способ 2: Если не нашли по номеру, пробуем как UUID
	Если Документ = Неопределено Тогда
		Попытка
			ВозможнаяСсылка = МенеджерДокумента.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
			Если ВозможнаяСсылка.ПолучитьОбъект() <> Неопределено Тогда
				Документ = ВозможнаяСсылка.ПолучитьОбъект();
			КонецЕсли;
		Исключение
			// UUID невалидный — документ не найден
		КонецПопытки;
	КонецЕсли;
	
	Возврат Документ;
	
КонецФункции

// Ищет документ по расширенным критериям (номер, дата, контрагент)
Функция НайтиДокументПоКритериям(МенеджерДокумента, ИмяДокумента, Критерии)
	
	// Извлекаем критерии из структуры/соответствия
	Номер = ИзвлечьЗначениеИзКритериев(Критерии, "Номер,Number,number");
	Дата = ИзвлечьЗначениеИзКритериев(Критерии, "Дата,Date,date");
	Контрагент = ИзвлечьЗначениеИзКритериев(Критерии, "Контрагент,Партнер,Partner,Counterparty,counterparty,partner");
	
	// Если указан только номер без даты и контрагента — используем простой поиск
	Если ЗначениеЗаполнено(Номер) И НЕ ЗначениеЗаполнено(Дата) И НЕ ЗначениеЗаполнено(Контрагент) Тогда
		Возврат НайтиДокументПоНомеруИлиUUID(МенеджерДокумента, ИмяДокумента, Номер);
	КонецЕсли;
	
	// Строим запрос с условиями
	ТекстУсловий = "";
	Запрос = Новый Запрос;
	
	// Условие по номеру
	Если ЗначениеЗаполнено(Номер) Тогда
		ТекстУсловий = ТекстУсловий + "Док.Номер ПОДОБНО &Номер";
		Запрос.УстановитьПараметр("Номер", "%" + Номер);
	КонецЕсли;
	
	// Условие по дате
	Если ЗначениеЗаполнено(Дата) Тогда
		ДатаНачала = Неопределено;
		ДатаОкончания = Неопределено;
		
		// Преобразуем дату
		Если ТипЗнч(Дата) = Тип("Дата") Тогда
			ДатаНачала = НачалоДня(Дата);
			ДатаОкончания = КонецДня(Дата);
		ИначеЕсли ТипЗнч(Дата) = Тип("Строка") Тогда
			// Пробуем распознать дату из строки
			Попытка
				ДатаЗначение = mcp_ОбщегоНазначения.ПреобразоватьДатуИзJSON(Дата);
				Если ЗначениеЗаполнено(ДатаЗначение) Тогда
					ДатаНачала = НачалоДня(ДатаЗначение);
					ДатаОкончания = КонецДня(ДатаЗначение);
				КонецЕсли;
			Исключение
				// Не удалось распознать дату
			КонецПопытки;
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ДатаНачала) Тогда
			Если ЗначениеЗаполнено(ТекстУсловий) Тогда
				ТекстУсловий = ТекстУсловий + " И ";
			КонецЕсли;
			ТекстУсловий = ТекстУсловий + "Док.Дата >= &ДатаНачала И Док.Дата <= &ДатаОкончания";
			Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
			Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
		КонецЕсли;
	КонецЕсли;
	
	// Условие по контрагенту/партнеру
	Если ЗначениеЗаполнено(Контрагент) Тогда
		Если ЗначениеЗаполнено(ТекстУсловий) Тогда
			ТекстУсловий = ТекстУсловий + " И ";
		КонецЕсли;
		// Проверяем, есть ли реквизит Контрагент или Партнер в документе
		Если МетаданныеДокументаСодержатРеквизит(ИмяДокумента, "Контрагент") Тогда
			ТекстУсловий = ТекстУсловий + "Док.Контрагент.Наименование ПОДОБНО &Контрагент";
		ИначеЕсли МетаданныеДокументаСодержатРеквизит(ИмяДокумента, "Партнер") Тогда
			ТекстУсловий = ТекстУсловий + "Док.Партнер.Наименование ПОДОБНО &Контрагент";
		КонецЕсли;
		// Если нет подходящего реквизита — условие по контрагенту не добавляется
		Запрос.УстановитьПараметр("Контрагент", "%" + Контрагент + "%");
	КонецЕсли;
	
	// Если нет условий — возвращаем Неопределено
	Если НЕ ЗначениеЗаполнено(ТекстУсловий) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	// Формируем и выполняем запрос
	Запрос.Текст = СтрШаблон(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Док.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.%1 КАК Док
		|ГДЕ
		|	%2
		|УПОРЯДОЧИТЬ ПО
		|	Док.Дата УБЫВ", ИмяДокумента, ТекстУсловий);
	
	Попытка
		Результат = Запрос.Выполнить();
	Исключение
		ТекстОшибки = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());
		Если mcp_ОбщегоНазначения.ЭтоОшибкаПравДоступа(ТекстОшибки) Тогда
			ВызватьИсключение mcp_ОбщегоНазначения.СформироватьСообщениеОбОшибкеПрав(ТекстОшибки);
		Иначе
			ВызватьИсключение СтрШаблон("Ошибка поиска документа по критериям: %1", ТекстОшибки);
		КонецЕсли;
	КонецПопытки;
	
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка.ПолучитьОбъект();
	КонецЕсли;
	
	Возврат Неопределено;
	
КонецФункции

// Извлекает значение из критериев по списку возможных ключей
Функция ИзвлечьЗначениеИзКритериев(Критерии, СписокКлючей)
	
	МассивКлючей = СтрРазделить(СписокКлючей, ",");
	
	Для Каждого Ключ Из МассивКлючей Цикл
		Ключ = СокрЛП(Ключ);
		Если ТипЗнч(Критерии) = Тип("Соответствие") Тогда
			Значение = Критерии.Получить(Ключ);
			Если Значение <> Неопределено Тогда
				Возврат Значение;
			КонецЕсли;
		ИначеЕсли ТипЗнч(Критерии) = Тип("Структура") Тогда
			Если Критерии.Свойство(Ключ) Тогда
				Возврат Критерии[Ключ];
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Неопределено;
	
КонецФункции

// Проверяет, содержит ли документ указанный реквизит
Функция МетаданныеДокументаСодержатРеквизит(ИмяДокумента, ИмяРеквизита)
	
	МетаданныеДокумента = Метаданные.Документы.Найти(ИмяДокумента);
	Если МетаданныеДокумента = Неопределено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Возврат МетаданныеДокумента.Реквизиты.Найти(ИмяРеквизита) <> Неопределено;
	
КонецФункции

#КонецОбласти