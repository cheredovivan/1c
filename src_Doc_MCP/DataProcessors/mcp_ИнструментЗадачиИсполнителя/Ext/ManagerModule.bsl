#Область ПрограммныйИнтерфейс

Процедура ДобавитьИнструменты(Инструменты) Экспорт

	ДобавитьИнструментЗадачиИсполнителя(Инструменты);

КонецПроцедуры

Функция ВыполнитьИнструмент(ИмяИнструмента, Аргументы) Экспорт

	Попытка
		Если ИмяИнструмента = "task_manager" Тогда
			Возврат УправлениеЗадачами(Аргументы);
		Иначе
			Возврат СформироватьОтветСОшибкой("Неизвестный инструмент: " + ИмяИнструмента);
		КонецЕсли;
	Исключение
		ОписаниеОшибкиТекст = ОписаниеОшибки();
		ПодробноеОписание = ПодробноеПредставлениеОшибки(ИнформацияОбОшибке());

		СообщениеОшибки = СтрШаблон("Ошибка выполнения инструмента '%1': %2",
			ИмяИнструмента,
			ОписаниеОшибкиТекст);

		Попытка
			ЗаписьЖурналаРегистрации("MCP." + ИмяИнструмента, УровеньЖурналаРегистрации.Ошибка, , ,
				СообщениеОшибки + Символы.ПС + ПодробноеОписание);
		Исключение
			// BSLLS:EmptyCodeBlock-off
			// Ошибка логирования не должна прерывать основной поток
			// BSLLS:EmptyCodeBlock-on
		КонецПопытки;

		Возврат СформироватьОтветСОшибкой(СообщениеОшибки + Символы.ПС + ПодробноеОписание);
	КонецПопытки;

КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СформироватьОтветСОшибкой(ТекстОшибки)

	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", "ОШИБКА: " + ТекстОшибки);

	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);

	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Ответ.Вставить("isError", Истина);
	Возврат Ответ;

КонецФункции

#КонецОбласти

#Область ИнструментЗадачиИсполнителя

Процедура ДобавитьИнструментЗадачиИсполнителя(Инструменты)

	МассивПараметров = Новый Массив;

	// Параметр operation - операция (list, get, complete)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"operation",
		"string",
		"Операция: 'list' (список задач), 'get' (получение задачи), 'complete' (выполнение задачи)",
		,
		Истина,
		"list,get,complete"
	));

	// Параметр selector - идентификатор задачи (для get и complete)
	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"selector",
		"string",
		"Идентификатор задачи: номер Документ.Задача (например 'ДО-000000002466') или UUID. Обязателен для операций 'get' и 'complete'",
		,
		Ложь
	));

	// --- Фильтры для list ---

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"my_tasks",
		"string",
		"Показать задачи текущего пользователя сеанса (аналог 'Задачи мне' в интерфейсе). Фильтрует по ТекущийИсполнитель. По умолчанию 'false'. Применяется только для операции 'list'",
		"false",
		Ложь,
		"true,false"
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"active_only",
		"string",
		"Показывать только активные задачи (бизнес-процесс активен, не отменена, не исключена). По умолчанию 'true'. Применяется только для операции 'list'",
		"true",
		Ложь,
		"true,false"
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"performer",
		"string",
		"Фильтр по исполнителю (поиск по наименованию). Применяется только для операции 'list'",
		,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"performer_uuid",
		"string",
		"UUID пользователя-исполнителя (точный поиск по ссылке). Приоритетнее performer. Применяется только для операции 'list'",
		,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"author",
		"string",
		"Фильтр по автору (поиск по наименованию). Применяется только для операции 'list'",
		,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"author_uuid",
		"string",
		"UUID пользователя-автора (точный поиск по ссылке). Приоритетнее author. Применяется только для операции 'list'",
		,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"completed",
		"string",
		"Фильтр по статусу выполнения: 'true' (выполненные), 'false' (невыполненные), 'all' (все). По умолчанию 'false'. Применяется только для операции 'list'",
		"false",
		Ложь,
		"true,false,all"
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"deadline_from",
		"string",
		"Начало периода срока исполнения (дата в формате ISO или 'YYYY-MM-DD'). Применяется только для операции 'list'",
		,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"deadline_to",
		"string",
		"Конец периода срока исполнения (дата в формате ISO или 'YYYY-MM-DD'). Применяется только для операции 'list'",
		,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"subject",
		"string",
		"Поиск по предмету задачи (наименование связанного объекта). Применяется только для операции 'list'",
		,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"result",
		"string",
		"Текст результата выполнения задачи. Применяется только для операции 'complete'",
		,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"maxRows",
		"number",
		"Максимальное количество строк в результате. По умолчанию 100, максимум 1000. Применяется только для операции 'list'",
		100,
		Ложь
	));

	МассивПараметров.Добавить(mcp_Метаданные.ПараметрИнструмента(
		"format",
		"string",
		"Формат результата: 'markdown' (удобочитаемые таблицы) или 'json' (структурированные данные). По умолчанию 'markdown'",
		"markdown",
		Ложь,
		"markdown,json"
	));

	СхемаПараметров = mcp_Метаданные.СхемаПараметровИнструмента(МассивПараметров);

	mcp_Метаданные.ДобавитьИнструмент(
		Инструменты,
		"task_manager",
		"Управление задачами исполнителя: получение списка задач с фильтрами, получение детальной информации о задаче, выполнение задачи. Для получения всех задач текущего пользователя (аналог 'Задачи мне') используйте my_tasks=true",
		СхемаПараметров
	);

КонецПроцедуры

Функция УправлениеЗадачами(Аргументы)

	УстановитьПривилегированныйРежим(Истина);

	// Преобразуем Соответствие в Структуру если нужно
	Если ТипЗнч(Аргументы) = Тип("Соответствие") Тогда
		АргументыСтруктура = Новый Структура;
		Для Каждого КлючЗначение Из Аргументы Цикл
			АргументыСтруктура.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
		КонецЦикла;
		Аргументы = АргументыСтруктура;
	КонецЕсли;

	// Получаем параметры
	Операция = "";
	Если Аргументы.Свойство("operation") Тогда
		Операция = НРег(Аргументы.operation);
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(Операция) Тогда
		Возврат СформироватьОтветСОшибкой("Не указана операция (operation)");
	КонецЕсли;

	ФорматРезультата = "markdown";
	Если Аргументы.Свойство("format") Тогда
		ФорматРезультата = НРег(Аргументы.format);
	КонецЕсли;

	Если Операция = "list" Тогда
		Возврат ПолучитьСписокЗадач(Аргументы, ФорматРезультата);
	ИначеЕсли Операция = "get" Тогда
		Возврат ПолучитьЗадачу(Аргументы, ФорматРезультата);
	ИначеЕсли Операция = "complete" Тогда
		Возврат ВыполнитьЗадачу(Аргументы, ФорматРезультата);
	Иначе
		Возврат СформироватьОтветСОшибкой("Неизвестная операция: " + Операция + ". Доступны: list, get, complete");
	КонецЕсли;

КонецФункции

// Получает список задач с фильтрами
Функция ПолучитьСписокЗадач(Аргументы, ФорматРезультата)

	// Проверяем, нужен ли режим "Задачи мне" (my_tasks=true)
	// В 1С:ДО задачи назначаются как напрямую сотрудникам, так и через роли (ПолныеРоли),
	// поэтому Задача.ЗадачаИсполнителя не содержит все задачи пользователя.
	// Для полного списка используем РегистрСведений.РеестрЗадачПоИсполнителям.
	МоиЗадачи = "false";
	Если Аргументы.Свойство("my_tasks") Тогда
		МоиЗадачи = НРег(Аргументы.my_tasks);
	КонецЕсли;

	Если МоиЗадачи = "true" Тогда
		Возврат ПолучитьСписокМоихЗадач(Аргументы, ФорматРезультата);
	КонецЕсли;

	// Стандартный запрос к Задача.ЗадачаИсполнителя (без my_tasks)
	Запрос = Новый Запрос;
	ТекстУсловий = "ЗадачаТаблица.ПометкаУдаления = ЛОЖЬ";

	// Фильтр по статусу выполнения
	Выполнена = "false";
	Если Аргументы.Свойство("completed") Тогда
		Выполнена = НРег(Аргументы.completed);
	КонецЕсли;

	Если Выполнена = "true" Тогда
		ТекстУсловий = ТекстУсловий + " И ЗадачаТаблица.Выполнена = ИСТИНА";
	ИначеЕсли Выполнена = "false" Тогда
		ТекстУсловий = ТекстУсловий + " И ЗадачаТаблица.Выполнена = ЛОЖЬ";
	КонецЕсли;

	// Фильтр active_only — только активные задачи (по умолчанию включён)
	ТолькоАктивные = "true";
	Если Аргументы.Свойство("active_only") Тогда
		ТолькоАктивные = НРег(Аргументы.active_only);
	КонецЕсли;

	Если ТолькоАктивные = "true" Тогда
		ТекстУсловий = ТекстУсловий
			+ " И ЗадачаТаблица.СостояниеБизнесПроцесса = ЗНАЧЕНИЕ(Перечисление.СостоянияБизнесПроцессов.Активен)"
			+ " И ЗадачаТаблица.Отменена = ЛОЖЬ"
			+ " И ЗадачаТаблица.ИсключенаИзПроцесса = ЛОЖЬ";
	КонецЕсли;

	// Фильтр по исполнителю (UUID имеет приоритет над наименованием)
	Если Аргументы.Свойство("performer_uuid") И ЗначениеЗаполнено(Аргументы.performer_uuid) Тогда
		ИсполнительСсылка = НайтиПользователяПоUUID(Аргументы.performer_uuid);
		Если ИсполнительСсылка <> Неопределено Тогда
			ТекстУсловий = ТекстУсловий + " И (ЗадачаТаблица.Исполнитель = &Исполнитель ИЛИ ЗадачаТаблица.ТекущийИсполнитель = &Исполнитель)";
			Запрос.УстановитьПараметр("Исполнитель", ИсполнительСсылка);
		Иначе
			ТекстУсловий = ТекстУсловий + " И ЛОЖЬ";
		КонецЕсли;
	ИначеЕсли Аргументы.Свойство("performer") И ЗначениеЗаполнено(Аргументы.performer) Тогда
		ТекстУсловий = ТекстУсловий
			+ " И (ЗадачаТаблица.Исполнитель.Наименование ПОДОБНО &ИсполнительНаименование"
			+ " ИЛИ ЗадачаТаблица.ТекущийИсполнитель.Наименование ПОДОБНО &ИсполнительНаименование)";
		Запрос.УстановитьПараметр("ИсполнительНаименование", "%" + Аргументы.performer + "%");
	КонецЕсли;

	// Фильтр по автору (UUID имеет приоритет над наименованием)
	Если Аргументы.Свойство("author_uuid") И ЗначениеЗаполнено(Аргументы.author_uuid) Тогда
		АвторСсылка = НайтиПользователяПоUUID(Аргументы.author_uuid);
		Если АвторСсылка <> Неопределено Тогда
			ТекстУсловий = ТекстУсловий + " И ЗадачаТаблица.Автор = &Автор";
			Запрос.УстановитьПараметр("Автор", АвторСсылка);
		Иначе
			ТекстУсловий = ТекстУсловий + " И ЛОЖЬ";
		КонецЕсли;
	ИначеЕсли Аргументы.Свойство("author") И ЗначениеЗаполнено(Аргументы.author) Тогда
		ТекстУсловий = ТекстУсловий + " И ЗадачаТаблица.АвторСтрокой ПОДОБНО &АвторНаименование";
		Запрос.УстановитьПараметр("АвторНаименование", "%" + Аргументы.author + "%");
	КонецЕсли;

	// Фильтр по сроку исполнения
	Если Аргументы.Свойство("deadline_from") И ЗначениеЗаполнено(Аргументы.deadline_from) Тогда
		ДатаОт = ПреобразоватьДатуИзСтроки(Аргументы.deadline_from);
		ТекстУсловий = ТекстУсловий + " И ЗадачаТаблица.СрокИсполнения >= &СрокОт";
		Запрос.УстановитьПараметр("СрокОт", ДатаОт);
	КонецЕсли;

	Если Аргументы.Свойство("deadline_to") И ЗначениеЗаполнено(Аргументы.deadline_to) Тогда
		ДатаПо = ПреобразоватьДатуИзСтроки(Аргументы.deadline_to);
		ТекстУсловий = ТекстУсловий + " И ЗадачаТаблица.СрокИсполнения <= &СрокПо";
		Запрос.УстановитьПараметр("СрокПо", ДатаПо);
	КонецЕсли;

	// Фильтр по предмету
	Если Аргументы.Свойство("subject") И ЗначениеЗаполнено(Аргументы.subject) Тогда
		ТекстУсловий = ТекстУсловий + " И ЗадачаТаблица.ПредметСтрокой ПОДОБНО &Предмет";
		Запрос.УстановитьПараметр("Предмет", "%" + Аргументы.subject + "%");
	КонецЕсли;

	МаксСтрок = 100;
	Если Аргументы.Свойство("maxRows") И ТипЗнч(Аргументы.maxRows) = Тип("Число") Тогда
		МаксСтрок = Мин(Макс(Аргументы.maxRows, 1), 1000);
	КонецЕсли;

	Запрос.Текст = СтрШаблон(
		"ВЫБРАТЬ ПЕРВЫЕ %1
		|	ЗадачаТаблица.Ссылка КАК Ссылка,
		|	ЗадачаТаблица.Номер КАК Номер,
		|	ЗадачаТаблица.Дата КАК Дата,
		|	ЗадачаТаблица.Наименование КАК Наименование,
		|	ЕСТЬNULL(ЗадачаТаблица.Исполнитель.Наименование, """") КАК Исполнитель,
		|	ЕСТЬNULL(ЗадачаТаблица.ТекущийИсполнитель.Наименование, """") КАК ТекущийИсполнитель,
		|	ЗадачаТаблица.АвторСтрокой КАК Автор,
		|	ЗадачаТаблица.ПредметСтрокой КАК Предмет,
		|	ЗадачаТаблица.СрокИсполнения КАК СрокИсполнения,
		|	ЗадачаТаблица.Выполнена КАК Выполнена,
		|	ЗадачаТаблица.ДатаИсполнения КАК ДатаИсполнения,
		|	ЗадачаТаблица.Описание КАК Описание,
		|	ЗадачаТаблица.РезультатВыполнения КАК РезультатВыполнения,
		|	ЗадачаТаблица.Важность КАК Важность,
		|	ЗадачаТаблица.СостояниеБизнесПроцесса КАК СостояниеБП,
		|	ЗадачаТаблица.ПринятаКИсполнению КАК ПринятаКИсполнению,
		|	ЗадачаТаблица.Отменена КАК Отменена,
		|	ЗадачаТаблица.ИсключенаИзПроцесса КАК ИсключенаИзПроцесса,
		|	ЗадачаТаблица.ТочкаМаршрута КАК ТочкаМаршрута
		|ИЗ
		|	Задача.ЗадачаИсполнителя КАК ЗадачаТаблица
		|ГДЕ
		|	%2
		|УПОРЯДОЧИТЬ ПО
		|	ЗадачаТаблица.СрокИсполнения,
		|	ЗадачаТаблица.Дата УБЫВ", МаксСтрок, ТекстУсловий);

	Результат = Запрос.Выполнить();
	Таблица = Результат.Выгрузить();

	МассивЗадач = Новый Массив;
	Для Каждого СтрокаТаблицы Из Таблица Цикл
		ЗадачаСтруктура = Новый Структура;
		ЗадачаСтруктура.Вставить("Номер", СтрокаТаблицы.Номер);
		ЗадачаСтруктура.Вставить("Дата", СтрокаТаблицы.Дата);
		ЗадачаСтруктура.Вставить("Наименование", СтрокаТаблицы.Наименование);
		ЗадачаСтруктура.Вставить("Исполнитель", СтрокаТаблицы.Исполнитель);
		ЗадачаСтруктура.Вставить("ТекущийИсполнитель", СтрокаТаблицы.ТекущийИсполнитель);
		ЗадачаСтруктура.Вставить("Автор", СтрокаТаблицы.Автор);
		ЗадачаСтруктура.Вставить("Предмет", СтрокаТаблицы.Предмет);
		ЗадачаСтруктура.Вставить("СрокИсполнения", СтрокаТаблицы.СрокИсполнения);
		ЗадачаСтруктура.Вставить("Выполнена", СтрокаТаблицы.Выполнена);
		ЗадачаСтруктура.Вставить("ДатаИсполнения", СтрокаТаблицы.ДатаИсполнения);
		ЗадачаСтруктура.Вставить("Описание", СтрокаТаблицы.Описание);
		ЗадачаСтруктура.Вставить("РезультатВыполнения", СтрокаТаблицы.РезультатВыполнения);
		ЗадачаСтруктура.Вставить("Важность", Строка(СтрокаТаблицы.Важность));
		ЗадачаСтруктура.Вставить("СостояниеБП", Строка(СтрокаТаблицы.СостояниеБП));
		ЗадачаСтруктура.Вставить("ПринятаКИсполнению", СтрокаТаблицы.ПринятаКИсполнению);
		ЗадачаСтруктура.Вставить("Отменена", СтрокаТаблицы.Отменена);
		ЗадачаСтруктура.Вставить("ИсключенаИзПроцесса", СтрокаТаблицы.ИсключенаИзПроцесса);
		ЗадачаСтруктура.Вставить("ТочкаМаршрута", Строка(СтрокаТаблицы.ТочкаМаршрута));
		МассивЗадач.Добавить(ЗадачаСтруктура);
	КонецЦикла;

	Если ФорматРезультата = "json" Тогда
		Возврат СформироватьJSONОтвет(МассивЗадач);
	Иначе
		Возврат СформироватьMarkdownОтветСписок(МассивЗадач);
	КонецЕсли;

КонецФункции

// Получает список задач текущего пользователя через РеестрЗадачПоИсполнителям (аналог "Задачи мне").
// Регистр содержит ВСЕ задачи пользователя, включая назначенные через роли (ПолныеРоли),
// в отличие от Задача.ЗадачаИсполнителя, которая хранит только прямые назначения на сотрудника.
Функция ПолучитьСписокМоихЗадач(Аргументы, ФорматРезультата)

	// Шаг 1: Получить ФИО текущего сотрудника для поиска реестра задач
	ТекущийПользователь = Пользователи.ТекущийПользователь();
	Если НЕ ЗначениеЗаполнено(ТекущийПользователь) Тогда
		Возврат СформироватьОтветСОшибкой("Не удалось определить текущего пользователя сеанса");
	КонецЕсли;

	ЗапросФИО = Новый Запрос;
	ЗапросФИО.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Сотрудники.Владелец.Наименование КАК ФИО
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|ГДЕ
		|	Сотрудники.Владелец = &ФизЛицо
		|	И Сотрудники.Действует = ИСТИНА
		|	И Сотрудники.ПометкаУдаления = ЛОЖЬ";
	ЗапросФИО.УстановитьПараметр("ФизЛицо", ТекущийПользователь.ФизЛицо);
	РезультатФИО = ЗапросФИО.Выполнить();

	Если РезультатФИО.Пустой() Тогда
		Возврат СформироватьОтветСОшибкой("Не удалось определить ФИО текущего сотрудника");
	КонецЕсли;

	ВыборкаФИО = РезультатФИО.Выбрать();
	ВыборкаФИО.Следующий();
	ФИОСотрудника = ВыборкаФИО.ФИО;

	// Шаг 2: Формируем запрос к РеестрЗадачПоИсполнителям
	Запрос = Новый Запрос;

	// Фильтр по статусу выполнения
	Выполнена = "false";
	Если Аргументы.Свойство("completed") Тогда
		Выполнена = НРег(Аргументы.completed);
	КонецЕсли;

	Если Выполнена = "true" Тогда
		ТекстУсловий = "Реестр.Выполнено = ИСТИНА";
	ИначеЕсли Выполнена = "false" Тогда
		ТекстУсловий = "Реестр.Выполнено = ЛОЖЬ";
	Иначе
		ТекстУсловий = "ИСТИНА";
	КонецЕсли;

	// Фильтр active_only — исключаем отменённые задачи
	ТолькоАктивные = "true";
	Если Аргументы.Свойство("active_only") Тогда
		ТолькоАктивные = НРег(Аргументы.active_only);
	КонецЕсли;

	Если ТолькоАктивные = "true" Тогда
		ТекстУсловий = ТекстУсловий
			+ " И Реестр.ВидСостоянияУчастниковЗадач <> ЗНАЧЕНИЕ(Перечисление.ВидыСостоянийУчастниковЗадач.Отменена)";
	КонецЕсли;

	// Фильтр по сроку исполнения
	Если Аргументы.Свойство("deadline_from") И ЗначениеЗаполнено(Аргументы.deadline_from) Тогда
		ДатаОт = ПреобразоватьДатуИзСтроки(Аргументы.deadline_from);
		ТекстУсловий = ТекстУсловий + " И Реестр.Срок >= &СрокОт";
		Запрос.УстановитьПараметр("СрокОт", ДатаОт);
	КонецЕсли;

	Если Аргументы.Свойство("deadline_to") И ЗначениеЗаполнено(Аргументы.deadline_to) Тогда
		ДатаПо = ПреобразоватьДатуИзСтроки(Аргументы.deadline_to);
		ТекстУсловий = ТекстУсловий + " И Реестр.Срок <= &СрокПо";
		Запрос.УстановитьПараметр("СрокПо", ДатаПо);
	КонецЕсли;

	// Фильтр по предмету (ищем в заголовке задачи)
	Если Аргументы.Свойство("subject") И ЗначениеЗаполнено(Аргументы.subject) Тогда
		ТекстУсловий = ТекстУсловий + " И Реестр.Заголовок ПОДОБНО &Предмет";
		Запрос.УстановитьПараметр("Предмет", "%" + Аргументы.subject + "%");
	КонецЕсли;

	// Фильтр по автору
	Если Аргументы.Свойство("author") И ЗначениеЗаполнено(Аргументы.author) Тогда
		ТекстУсловий = ТекстУсловий + " И ПРЕДСТАВЛЕНИЕ(Реестр.Автор) ПОДОБНО &АвторНаименование";
		Запрос.УстановитьПараметр("АвторНаименование", "%" + Аргументы.author + "%");
	КонецЕсли;

	МаксСтрок = 100;
	Если Аргументы.Свойство("maxRows") И ТипЗнч(Аргументы.maxRows) = Тип("Число") Тогда
		МаксСтрок = Мин(Макс(Аргументы.maxRows, 1), 1000);
	КонецЕсли;

	Запрос.Текст = СтрШаблон(
		"ВЫБРАТЬ ПЕРВЫЕ %1
		|	Реестр.ДействиеЗадачи.Задача.Номер КАК Номер,
		|	Реестр.Дата КАК Дата,
		|	Реестр.Заголовок КАК Наименование,
		|	Реестр.Исполнитель КАК Исполнитель,
		|	Реестр.Автор КАК Автор,
		|	Реестр.Срок КАК СрокИсполнения,
		|	Реестр.Выполнено КАК Выполнена,
		|	Реестр.Просрочено КАК Просрочено,
		|	Реестр.ВРаботе КАК ВРаботе,
		|	Реестр.ВидСостоянияУчастниковЗадач КАК Состояние,
		|	Реестр.ВидДействия КАК ВидДействия,
		|	Реестр.ВидЗадачи КАК ВидЗадачи
		|ИЗ
		|	РегистрСведений.РеестрЗадачПоИсполнителям КАК Реестр
		|ГДЕ
		|	Реестр.РеестрЗадач.Наименование ПОДОБНО &РеестрМаска
		|	И %2
		|УПОРЯДОЧИТЬ ПО
		|	Реестр.Дата УБЫВ", МаксСтрок, ТекстУсловий);

	Запрос.УстановитьПараметр("РеестрМаска", "Задачи мне " + ФИОСотрудника + "%");

	Результат = Запрос.Выполнить();
	Таблица = Результат.Выгрузить();

	МассивЗадач = Новый Массив;
	Для Каждого СтрокаТаблицы Из Таблица Цикл
		ЗадачаСтруктура = Новый Структура;
		ЗадачаСтруктура.Вставить("Номер", СтрокаТаблицы.Номер);
		ЗадачаСтруктура.Вставить("Дата", СтрокаТаблицы.Дата);
		ЗадачаСтруктура.Вставить("Наименование", СтрокаТаблицы.Наименование);
		ЗадачаСтруктура.Вставить("Исполнитель", Строка(СтрокаТаблицы.Исполнитель));
		ЗадачаСтруктура.Вставить("ТекущийИсполнитель", Строка(СтрокаТаблицы.Исполнитель));
		ЗадачаСтруктура.Вставить("Автор", Строка(СтрокаТаблицы.Автор));
		ЗадачаСтруктура.Вставить("Предмет", "");
		ЗадачаСтруктура.Вставить("СрокИсполнения", СтрокаТаблицы.СрокИсполнения);
		ЗадачаСтруктура.Вставить("Выполнена", СтрокаТаблицы.Выполнена);
		ЗадачаСтруктура.Вставить("ДатаИсполнения", '00010101');
		ЗадачаСтруктура.Вставить("Описание", "");
		ЗадачаСтруктура.Вставить("РезультатВыполнения", "");
		ЗадачаСтруктура.Вставить("Важность", "");
		ЗадачаСтруктура.Вставить("СостояниеБП", Строка(СтрокаТаблицы.Состояние));
		ЗадачаСтруктура.Вставить("ПринятаКИсполнению", СтрокаТаблицы.ВРаботе);
		ЗадачаСтруктура.Вставить("Отменена", Ложь);
		ЗадачаСтруктура.Вставить("ИсключенаИзПроцесса", Ложь);
		ЗадачаСтруктура.Вставить("ТочкаМаршрута", Строка(СтрокаТаблицы.ВидДействия));
		ЗадачаСтруктура.Вставить("Просрочено", СтрокаТаблицы.Просрочено);
		ЗадачаСтруктура.Вставить("ВидЗадачи", Строка(СтрокаТаблицы.ВидЗадачи));
		МассивЗадач.Добавить(ЗадачаСтруктура);
	КонецЦикла;

	Если ФорматРезультата = "json" Тогда
		Возврат СформироватьJSONОтвет(МассивЗадач);
	Иначе
		Возврат СформироватьMarkdownОтветСписок(МассивЗадач);
	КонецЕсли;

КонецФункции

// Получает детальную информацию о задаче (из Документ.Задача).
// Селектор — номер Документ.Задача (например "ДО-000000002466") или UUID.
Функция ПолучитьЗадачу(Аргументы, ФорматРезультата)

	Селектор = "";
	Если Аргументы.Свойство("selector") Тогда
		Селектор = Аргументы.selector;
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(Селектор) Тогда
		Возврат СформироватьОтветСОшибкой("Не указан селектор задачи (selector) для операции 'get'");
	КонецЕсли;

	ДокЗадачаСсылка = НайтиЗадачуПоСелектору(Селектор);

	Если ДокЗадачаСсылка = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой("Задача не найдена по селектору: " + Селектор);
	КонецЕсли;

	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ДокЗадача.Номер КАК Номер,
		|	ДокЗадача.Дата КАК Дата,
		|	ДокЗадача.Заголовок КАК Наименование,
		|	ПРЕДСТАВЛЕНИЕ(ДокЗадача.Автор) КАК Автор,
		|	ДокЗадача.Описание КАК Описание,
		|	ДокЗадача.Срок КАК СрокИсполнения,
		|	ДокЗадача.ДатаВыполнения КАК ДатаВыполнения,
		|	ПРЕДСТАВЛЕНИЕ(ДокЗадача.СостояниеЗадачи) КАК Состояние,
		|	ПРЕДСТАВЛЕНИЕ(ДокЗадача.ВидЗадачи) КАК ВидЗадачи,
		|	ПРЕДСТАВЛЕНИЕ(ДокЗадача.Источник) КАК Источник,
		|	ПРЕДСТАВЛЕНИЕ(ДокЗадача.Приоритет) КАК Приоритет,
		|	ПРЕДСТАВЛЕНИЕ(ДокЗадача.РезультатЗадачи) КАК РезультатЗадачи,
		|	ДокЗадача.Проведен КАК Проведен,
		|	ДокЗадача.ДатаНачала КАК ДатаНачала,
		|	ДокЗадача.ДатаСоздания КАК ДатаСоздания
		|ИЗ
		|	Документ.Задача КАК ДокЗадача
		|ГДЕ
		|	ДокЗадача.Ссылка = &Ссылка";

	Запрос.УстановитьПараметр("Ссылка", ДокЗадачаСсылка);

	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат СформироватьОтветСОшибкой("Задача не найдена");
	КонецЕсли;

	Выборка = Результат.Выбрать();
	Выборка.Следующий();

	ЗадачаСтруктура = Новый Структура;
	ЗадачаСтруктура.Вставить("Номер", Выборка.Номер);
	ЗадачаСтруктура.Вставить("Дата", Выборка.Дата);
	ЗадачаСтруктура.Вставить("Наименование", Выборка.Наименование);
	ЗадачаСтруктура.Вставить("Автор", Выборка.Автор);
	ЗадачаСтруктура.Вставить("Описание", Выборка.Описание);
	ЗадачаСтруктура.Вставить("СрокИсполнения", Выборка.СрокИсполнения);
	ЗадачаСтруктура.Вставить("ДатаВыполнения", Выборка.ДатаВыполнения);
	ЗадачаСтруктура.Вставить("Состояние", Выборка.Состояние);
	ЗадачаСтруктура.Вставить("ВидЗадачи", Выборка.ВидЗадачи);
	ЗадачаСтруктура.Вставить("Источник", Выборка.Источник);
	ЗадачаСтруктура.Вставить("Приоритет", Выборка.Приоритет);
	ЗадачаСтруктура.Вставить("РезультатЗадачи", Выборка.РезультатЗадачи);
	ЗадачаСтруктура.Вставить("Проведен", Выборка.Проведен);
	ЗадачаСтруктура.Вставить("ДатаНачала", Выборка.ДатаНачала);
	ЗадачаСтруктура.Вставить("ДатаСоздания", Выборка.ДатаСоздания);

	// Дополним информацией об участниках из реестра
	ЗапросУчастники = Новый Запрос;
	ЗапросУчастники.Текст =
		"ВЫБРАТЬ
		|	ТЧ.Участник КАК Участник,
		|	ПРЕДСТАВЛЕНИЕ(ТЧ.ВидУчастника) КАК ВидУчастника,
		|	ПРЕДСТАВЛЕНИЕ(ТЧ.ДействиеУчастника.ВидДействия) КАК ВидДействия,
		|	ПРЕДСТАВЛЕНИЕ(ТЧ.ДействиеУчастника.РезультатДействия) КАК РезультатДействия
		|ИЗ
		|	Документ.Задача.Участники КАК ТЧ
		|ГДЕ
		|	ТЧ.Ссылка = &Ссылка";
	ЗапросУчастники.УстановитьПараметр("Ссылка", ДокЗадачаСсылка);

	МассивУчастников = Новый Массив;
	РезультатУчастники = ЗапросУчастники.Выполнить();
	Если НЕ РезультатУчастники.Пустой() Тогда
		ВыборкаУчастники = РезультатУчастники.Выбрать();
		Пока ВыборкаУчастники.Следующий() Цикл
			УчастникСтруктура = Новый Структура;
			УчастникСтруктура.Вставить("Участник", Строка(ВыборкаУчастники.Участник));
			УчастникСтруктура.Вставить("ВидУчастника", ВыборкаУчастники.ВидУчастника);
			УчастникСтруктура.Вставить("ВидДействия", ВыборкаУчастники.ВидДействия);
			УчастникСтруктура.Вставить("РезультатДействия", ВыборкаУчастники.РезультатДействия);
			МассивУчастников.Добавить(УчастникСтруктура);
		КонецЦикла;
	КонецЕсли;
	ЗадачаСтруктура.Вставить("Участники", МассивУчастников);

	Если ФорматРезультата = "json" Тогда
		Возврат СформироватьJSONОтвет(ЗадачаСтруктура);
	Иначе
		Возврат СформироватьMarkdownОтветЗадача(ЗадачаСтруктура);
	КонецЕсли;

КонецФункции

// Выполняет задачу.
// Находит Документ.Задача по селектору, затем через реестр задач определяет
// ДействиеЗадачи текущего исполнителя. Из ДействиеЗадачи.Источник получает
// платформенную задачу (Задача.ЗадачаИсполнителя) и выполняет через стандартный механизм.
Функция ВыполнитьЗадачу(Аргументы, ФорматРезультата)

	Селектор = "";
	Если Аргументы.Свойство("selector") Тогда
		Селектор = Аргументы.selector;
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(Селектор) Тогда
		Возврат СформироватьОтветСОшибкой("Не указан селектор задачи (selector) для операции 'complete'");
	КонецЕсли;

	ДокЗадачаСсылка = НайтиЗадачуПоСелектору(Селектор);

	Если ДокЗадачаСсылка = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой("Задача не найдена по селектору: " + Селектор);
	КонецЕсли;

	// Шаг 1: Найти ДействиеЗадачи текущего пользователя через реестр задач
	ДанныеДействия = НайтиДействиеЗадачиТекущегоИсполнителя(ДокЗадачаСсылка);

	Если ДанныеДействия = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой("Не найдено действие задачи для текущего пользователя. "
			+ "Задача может не быть назначена вам или уже выполнена.");
	КонецЕсли;

	ДействиеЗадачиСсылка = ДанныеДействия.ДействиеЗадачи;

	// Шаг 2: Определить платформенную задачу (Задача.ЗадачаИсполнителя) из Источника.
	// Используем ВЫРАЗИТЬ + фильтр по ТИПЗНАЧЕНИЯ для надёжного приведения типа.
	ПлатформеннаяЗадача = Неопределено;

	Если ЗначениеЗаполнено(ДействиеЗадачиСсылка) Тогда
		ЗапросИсточник = Новый Запрос;
		ЗапросИсточник.Текст =
			"ВЫБРАТЬ
			|	ВЫРАЗИТЬ(ДЗ.Источник КАК Задача.ЗадачаИсполнителя) КАК ЗадачаИсполнителя
			|ИЗ
			|	Документ.ДействиеЗадачи КАК ДЗ
			|ГДЕ
			|	ДЗ.Ссылка = &Ссылка
			|	И ТИПЗНАЧЕНИЯ(ДЗ.Источник) = ТИП(Задача.ЗадачаИсполнителя)";
		ЗапросИсточник.УстановитьПараметр("Ссылка", ДействиеЗадачиСсылка);

		РезультатИсточник = ЗапросИсточник.Выполнить();
		Если НЕ РезультатИсточник.Пустой() Тогда
			ВыборкаИсточник = РезультатИсточник.Выбрать();
			ВыборкаИсточник.Следующий();
			ПлатформеннаяЗадача = ВыборкаИсточник.ЗадачаИсполнителя;
		КонецЕсли;
	КонецЕсли;

	Если ПлатформеннаяЗадача = Неопределено Тогда
		Возврат СформироватьОтветСОшибкой("Задачу данного типа нельзя выполнить автоматически. "
			+ "Поддерживаются: Исполнение, Подписание, Рассмотрение, Регистрация. "
			+ "Ознакомление и другие типы нужно выполнять в интерфейсе 1С:Документооборот.");
	КонецЕсли;

	// Шаг 3: Проверяем, что платформенная задача не выполнена
	ЗадачаИсполнителяОбъект = ПлатформеннаяЗадача.ПолучитьОбъект();

	Если ЗадачаИсполнителяОбъект.Выполнена Тогда
		Возврат СформироватьОтветСОшибкой("Задача уже выполнена");
	КонецЕсли;

	// Шаг 4: Формируем параметры выполнения
	ПараметрыВыполнения = Новый Структура;

	Если Аргументы.Свойство("result") И ЗначениеЗаполнено(Аргументы.result) Тогда
		ПараметрыВыполнения.Вставить("РезультатВыполнения", Аргументы.result);
	КонецЕсли;

	// Шаг 5: Выполняем задачу через типовой API.
	// ВыполнениеЗадачСервер.ВыполнитьЗадачу() корректно вызывает обработчики бизнес-процесса,
	// обновляет даты, проверяет права и запускает следующие этапы процесса.
	Попытка
		ВыполнениеЗадачСервер.ВыполнитьЗадачу(ПлатформеннаяЗадача, ПараметрыВыполнения);
	Исключение
		Возврат СформироватьОтветСОшибкой("Ошибка выполнения задачи: "
			+ ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
	КонецПопытки;

	// Шаг 6: Получаем обновленную информацию
	Возврат ПолучитьЗадачу(Аргументы, ФорматРезультата);

КонецФункции

// Получает текущего сотрудника через цепочку: Пользователь → ФизЛицо → Сотрудник
Функция ПолучитьТекущегоСотрудника()

	ТекущийПользователь = Пользователи.ТекущийПользователь();
	Если НЕ ЗначениеЗаполнено(ТекущийПользователь) Тогда
		Возврат Неопределено;
	КонецЕсли;

	ЗапросСотрудника = Новый Запрос;
	ЗапросСотрудника.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Сотрудники.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|ГДЕ
		|	Сотрудники.Владелец = &ФизЛицо
		|	И Сотрудники.Действует = ИСТИНА
		|	И Сотрудники.ПометкаУдаления = ЛОЖЬ";

	ЗапросСотрудника.УстановитьПараметр("ФизЛицо", ТекущийПользователь.ФизЛицо);

	РезультатСотрудника = ЗапросСотрудника.Выполнить();
	Если НЕ РезультатСотрудника.Пустой() Тогда
		ВыборкаСотрудника = РезультатСотрудника.Выбрать();
		ВыборкаСотрудника.Следующий();
		Возврат ВыборкаСотрудника.Ссылка;
	КонецЕсли;

	Возврат Неопределено;

КонецФункции

// Ищет Документ.Задача по селектору (номер или UUID).
// Номер — формат "ДО-000000002466" (короткий номер Документ.Задача).
Функция НайтиЗадачуПоСелектору(Селектор)

	// Поиск по UUID
	Если СтрДлина(Селектор) = 36 И СтрНайти(Селектор, "-") > 0 Тогда
		Попытка
			СсылкаПоУИД = Документы.Задача.ПолучитьСсылку(Новый УникальныйИдентификатор(Селектор));
			Если ЗначениеЗаполнено(СсылкаПоУИД) И НЕ СсылкаПоУИД.ПолучитьОбъект() = Неопределено Тогда
				Возврат СсылкаПоУИД;
			КонецЕсли;
		Исключение
			// BSLLS:EmptyCodeBlock-off
			// Не UUID — продолжаем поиск по номеру
			// BSLLS:EmptyCodeBlock-on
		КонецПопытки;
	КонецЕсли;

	// Поиск по номеру Документ.Задача
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ДокЗадача.Ссылка КАК Ссылка
		|ИЗ
		|	Документ.Задача КАК ДокЗадача
		|ГДЕ
		|	ДокЗадача.Номер ПОДОБНО &Номер
		|УПОРЯДОЧИТЬ ПО
		|	ДокЗадача.Дата УБЫВ";

	Запрос.УстановитьПараметр("Номер", "%" + Селектор + "%");

	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;

	Возврат Неопределено;

КонецФункции

// Находит ДействиеЗадачи текущего пользователя для указанной Документ.Задача.
// Ищет через РеестрЗадачПоИсполнителям — он содержит привязку
// ДействиеЗадачи к конкретному реестру задач пользователя.
// Возвращает Структуру с полями ДействиеЗадачи, ВидДействия или Неопределено.
Функция НайтиДействиеЗадачиТекущегоИсполнителя(ДокЗадачаСсылка)

	// Получаем ФИО текущего сотрудника для поиска реестра задач
	ТекущийПользователь = Пользователи.ТекущийПользователь();
	Если НЕ ЗначениеЗаполнено(ТекущийПользователь) Тогда
		Возврат Неопределено;
	КонецЕсли;

	ЗапросФИО = Новый Запрос;
	ЗапросФИО.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Сотрудники.Владелец.Наименование КАК ФИО
		|ИЗ
		|	Справочник.Сотрудники КАК Сотрудники
		|ГДЕ
		|	Сотрудники.Владелец = &ФизЛицо
		|	И Сотрудники.Действует = ИСТИНА
		|	И Сотрудники.ПометкаУдаления = ЛОЖЬ";
	ЗапросФИО.УстановитьПараметр("ФизЛицо", ТекущийПользователь.ФизЛицо);
	РезультатФИО = ЗапросФИО.Выполнить();

	Если РезультатФИО.Пустой() Тогда
		Возврат Неопределено;
	КонецЕсли;

	ВыборкаФИО = РезультатФИО.Выбрать();
	ВыборкаФИО.Следующий();
	ФИОСотрудника = ВыборкаФИО.ФИО;

	// Ищем в реестре задач запись по данной Документ.Задача
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	Реестр.ДействиеЗадачи КАК ДействиеЗадачи,
		|	ПРЕДСТАВЛЕНИЕ(Реестр.ВидДействия) КАК ВидДействия
		|ИЗ
		|	РегистрСведений.РеестрЗадачПоИсполнителям КАК Реестр
		|ГДЕ
		|	Реестр.Задача = &ДокументЗадача
		|	И Реестр.РеестрЗадач.Наименование ПОДОБНО &РеестрМаска
		|	И Реестр.Выполнено = ЛОЖЬ";

	Запрос.УстановитьПараметр("ДокументЗадача", ДокЗадачаСсылка);
	Запрос.УстановитьПараметр("РеестрМаска", "Задачи мне " + ФИОСотрудника + "%");

	Результат = Запрос.Выполнить();
	Если НЕ Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();

		ДанныеДействия = Новый Структура;
		ДанныеДействия.Вставить("ДействиеЗадачи", Выборка.ДействиеЗадачи);
		ДанныеДействия.Вставить("ВидДействия", Выборка.ВидДействия);
		Возврат ДанныеДействия;
	КонецЕсли;

	Возврат Неопределено;

КонецФункции

// Формирует JSON ответ
Функция СформироватьJSONОтвет(Данные)

	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Данные);
	ТекстJSON = ЗаписьJSON.Закрыть();

	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", ТекстJSON);

	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);

	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;

КонецФункции

// Формирует Markdown ответ для списка задач
Функция СформироватьMarkdownОтветСписок(МассивЗадач)

	Текст = "# Список задач исполнителя" + Символы.ПС;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "Всего задач: **" + МассивЗадач.Количество() + "**" + Символы.ПС;
	Текст = Текст + Символы.ПС;

	Если МассивЗадач.Количество() = 0 Тогда
		Текст = Текст + "*Задач не найдено*" + Символы.ПС;
	Иначе
		Текст = Текст + "| № | Наименование | Исполнитель | Автор | Срок | Статус БП | Принята |" + Символы.ПС;
		Текст = Текст + "| --- | --- | --- | --- | --- | --- | --- |" + Символы.ПС;

		Для Каждого ЗадачаЭлемент Из МассивЗадач Цикл
			Срок = "";
			Если ЗначениеЗаполнено(ЗадачаЭлемент.СрокИсполнения) Тогда
				Срок = Формат(ЗадачаЭлемент.СрокИсполнения, "ДФ=dd.MM.yyyy");
			КонецЕсли;

			ИсполнительВывод = СокрЛП(ЗадачаЭлемент.ТекущийИсполнитель);
			Если НЕ ЗначениеЗаполнено(ИсполнительВывод) Тогда
				ИсполнительВывод = СокрЛП(ЗадачаЭлемент.Исполнитель);
			КонецЕсли;

			Текст = Текст + "| " + ЗадачаЭлемент.Номер + " | " +
				СокрЛП(ЗадачаЭлемент.Наименование) + " | " +
				ИсполнительВывод + " | " +
				СокрЛП(ЗадачаЭлемент.Автор) + " | " +
				Срок + " | " +
				СокрЛП(ЗадачаЭлемент.СостояниеБП) + " | " +
				?(ЗадачаЭлемент.ПринятаКИсполнению, "Да", "-") + " |" + Символы.ПС;
		КонецЦикла;
	КонецЕсли;

	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", Текст);

	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);

	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;

КонецФункции

// Преобразует строку даты в формате ISO (YYYY-MM-DD) в дату
Функция ПреобразоватьДатуИзСтроки(СтрокаДаты)

	Попытка
		СтрокаДаты = СокрЛП(СтрокаДаты);

		ПозицияT = СтрНайти(СтрокаДаты, "T");
		Если ПозицияT > 0 Тогда
			СтрокаДаты = Лев(СтрокаДаты, ПозицияT - 1);
		КонецЕсли;

		Части = СтрРазделить(СтрокаДаты, "-");
		Если Части.Количество() >= 3 Тогда
			Возврат Дата(Число(Части[0]), Число(Части[1]), Число(Части[2]));
		КонецЕсли;

		Возврат '00010101';
	Исключение
		Возврат '00010101';
	КонецПопытки;

КонецФункции

// Находит пользователя по UUID
Функция НайтиПользователяПоUUID(СтрокаUUID)

	Попытка
		УИД = Новый УникальныйИдентификатор(СтрокаUUID);
		Возврат Справочники.Пользователи.ПолучитьСсылку(УИД);
	Исключение
		Возврат Неопределено;
	КонецПопытки;

КонецФункции

// Формирует Markdown ответ для одной задачи (Документ.Задача)
Функция СформироватьMarkdownОтветЗадача(ЗадачаСтруктура)

	Текст = "# Задача " + ЗадачаСтруктура.Номер + Символы.ПС;
	Текст = Текст + Символы.ПС;
	Текст = Текст + "## Основные реквизиты" + Символы.ПС;
	Текст = Текст + "| Реквизит | Значение |" + Символы.ПС;
	Текст = Текст + "| --- | --- |" + Символы.ПС;
	Текст = Текст + "| Заголовок | **" + ЗадачаСтруктура.Наименование + "** |" + Символы.ПС;
	Текст = Текст + "| Дата | " + Формат(ЗадачаСтруктура.Дата, "ДФ=dd.MM.yyyy HH:mm:ss") + " |" + Символы.ПС;
	Текст = Текст + "| Автор | " + ЗадачаСтруктура.Автор + " |" + Символы.ПС;

	Если ЗначениеЗаполнено(ЗадачаСтруктура.ВидЗадачи) Тогда
		Текст = Текст + "| Вид задачи | " + ЗадачаСтруктура.ВидЗадачи + " |" + Символы.ПС;
	КонецЕсли;

	Если ЗначениеЗаполнено(ЗадачаСтруктура.Источник) Тогда
		Текст = Текст + "| Источник | " + ЗадачаСтруктура.Источник + " |" + Символы.ПС;
	КонецЕсли;

	Если ЗначениеЗаполнено(ЗадачаСтруктура.СрокИсполнения) Тогда
		Текст = Текст + "| Срок | " + Формат(ЗадачаСтруктура.СрокИсполнения, "ДФ=dd.MM.yyyy") + " |" + Символы.ПС;
	КонецЕсли;

	Текст = Текст + "| Состояние | " + ЗадачаСтруктура.Состояние + " |" + Символы.ПС;

	Если ЗначениеЗаполнено(ЗадачаСтруктура.Приоритет) Тогда
		Текст = Текст + "| Приоритет | " + ЗадачаСтруктура.Приоритет + " |" + Символы.ПС;
	КонецЕсли;

	Если ЗначениеЗаполнено(ЗадачаСтруктура.РезультатЗадачи) Тогда
		Текст = Текст + "| Результат | " + ЗадачаСтруктура.РезультатЗадачи + " |" + Символы.ПС;
	КонецЕсли;

	Если ЗначениеЗаполнено(ЗадачаСтруктура.ДатаВыполнения) Тогда
		Текст = Текст + "| Дата выполнения | " + Формат(ЗадачаСтруктура.ДатаВыполнения, "ДФ=dd.MM.yyyy HH:mm:ss") + " |" + Символы.ПС;
	КонецЕсли;

	Если ЗначениеЗаполнено(ЗадачаСтруктура.Описание) Тогда
		Текст = Текст + Символы.ПС;
		Текст = Текст + "## Описание" + Символы.ПС;
		Текст = Текст + ЗадачаСтруктура.Описание + Символы.ПС;
	КонецЕсли;

	// Участники
	Если ЗадачаСтруктура.Свойство("Участники") И ЗадачаСтруктура.Участники.Количество() > 0 Тогда
		Текст = Текст + Символы.ПС;
		Текст = Текст + "## Участники" + Символы.ПС;
		Текст = Текст + "| Участник | Вид | Действие | Результат |" + Символы.ПС;
		Текст = Текст + "| --- | --- | --- | --- |" + Символы.ПС;

		Для Каждого Участник Из ЗадачаСтруктура.Участники Цикл
			Текст = Текст + "| " + Участник.Участник
				+ " | " + Участник.ВидУчастника
				+ " | " + Участник.ВидДействия
				+ " | " + Участник.РезультатДействия + " |" + Символы.ПС;
		КонецЦикла;
	КонецЕсли;

	ЭлементСодержимого = Новый Структура;
	ЭлементСодержимого.Вставить("type", "text");
	ЭлементСодержимого.Вставить("text", Текст);

	МассивСодержимого = Новый Массив;
	МассивСодержимого.Добавить(ЭлементСодержимого);

	Ответ = Новый Структура;
	Ответ.Вставить("content", МассивСодержимого);
	Возврат Ответ;

КонецФункции

#КонецОбласти
