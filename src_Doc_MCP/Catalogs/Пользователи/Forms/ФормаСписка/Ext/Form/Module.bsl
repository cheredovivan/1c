///////////////////////////////////////////////////////////////////////////////////////////////////////
// MCP-сервер: Расширение формы списка справочника "Пользователи"
// Добавляет возможность запуска нового сеанса под выбранным пользователем
///////////////////////////////////////////////////////////////////////////////////////////////////////

#Область ОбработчикиСобытийФормы

&После("ПриСозданииНаСервере")
Процедура mcp_ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Проверка прав - только для пользователя admin
	Если ИмяПользователя() <> "admin" Тогда
		Возврат;
	КонецЕсли;
	
	// Проверка типа клиента - только для толстого/тонкого клиента
	#Если ВебКлиент Тогда
		Возврат;
	#КонецЕсли
	
	// Создаем команду программно
	КомандаЗапустить = Команды.Добавить("mcp_ЗапуститьПодПользователем");
	КомандаЗапустить.Заголовок = НСтр("ru = 'Запустить под пользователем'");
	КомандаЗапустить.Действие = "mcp_ЗапуститьПодПользователем";
	КомандаЗапустить.Подсказка = НСтр("ru = 'Запустить новый сеанс 1С под выбранным пользователем'");
	
	// Создаем кнопку на командной панели
	ЭлементКоманднаяПанель = Элементы.Найти("КоманднаяПанель");
	Если ЭлементКоманднаяПанель <> Неопределено Тогда
		КнопкаЗапустить = Элементы.Добавить("mcp_КнопкаЗапуститьПодПользователем", Тип("КнопкаФормы"), ЭлементКоманднаяПанель);
		КнопкаЗапустить.ИмяКоманды = "mcp_ЗапуститьПодПользователем";
		КнопкаЗапустить.Вид = ВидКнопкиФормы.КнопкаКоманднойПанели;
		КнопкаЗапустить.Заголовок = НСтр("ru = 'Запустить под пользователем'");
		КнопкаЗапустить.Отображение = ОтображениеКнопки.Текст;
		КнопкаЗапустить.ЦветФона = Новый Цвет(200, 162, 255); // Светло-фиолетовый
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура mcp_ЗапуститьПодПользователем(Команда)
	
	// Проверка что не веб-клиент
	#Если ВебКлиент Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Данная функция недоступна в веб-клиенте.'"));
		Возврат;
	#КонецЕсли
	
	// Получаем выбранного пользователя
	ТекущаяСтрока = Элементы.ПользователиСписок.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		ПоказатьПредупреждение(, НСтр("ru = 'Выберите пользователя из списка.'"));
		Возврат;
	КонецЕсли;
	
	// Подмена данных авторизации на сервере и получение данных для запуска
	ДанныеДляЗапуска = mcp_ПодменитьДанныеАвторизации(ТекущаяСтрока);
	
	Если ДанныеДляЗапуска = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ДанныеДляЗапуска.Успех Тогда
		ПоказатьПредупреждение(, ДанныеДляЗапуска.ОписаниеОшибки);
		Возврат;
	КонецЕсли;
	
	// Запускаем систему с временным паролем
	ИмяПользователя = ДанныеДляЗапуска.ИмяПользователя;
	ВременныйПароль = ДанныеДляЗапуска.ВременныйПароль;
	СохраненныеДанныеJSON = ДанныеДляЗапуска.СохраненныеДанныеJSON;
	
	Попытка
		СтрокаЗапуска = СтрШаблон("/N""%1"" /P""%2""", ИмяПользователя, ВременныйПароль);
		ЗапуститьСистему(СтрокаЗапуска);
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		// Немедленно восстанавливаем пароль при ошибке запуска
		mcp_ВосстановитьДанныеАвторизации(СохраненныеДанныеJSON);
		ПоказатьПредупреждение(, НСтр("ru = 'Ошибка запуска системы: '") + КраткоеПредставлениеОшибки(ИнформацияОбОшибке));
		Возврат;
	КонецПопытки;
	
	// Показываем предупреждение с таймаутом 30 секунд
	// После закрытия предупреждения восстанавливаем пароль
	ПараметрыОповещения = Новый Структура("СохраненныеДанныеJSON", СохраненныеДанныеJSON);
	Оповещение = Новый ОписаниеОповещения("mcp_ПослеПредупрежденияВосстановитьПароль", ЭтотОбъект, ПараметрыОповещения);
	ПоказатьПредупреждение(Оповещение, 
		НСтр("ru = 'Сеанс запущен. Пароль будет восстановлен автоматически через 30 секунд.
		           |Не закрывайте это окно раньше времени!'"), 
		30);
	
КонецПроцедуры

&НаКлиенте
Процедура mcp_ПослеПредупрежденияВосстановитьПароль(ДополнительныеПараметры) Экспорт
	
	// Восстанавливаем данные авторизации
	Если ДополнительныеПараметры <> Неопределено 
		И ДополнительныеПараметры.Свойство("СохраненныеДанныеJSON")
		И ЗначениеЗаполнено(ДополнительныеПараметры.СохраненныеДанныеJSON) Тогда
		
		Результат = mcp_ВосстановитьДанныеАвторизации(ДополнительныеПараметры.СохраненныеДанныеJSON);
		
		Если Результат.Успех Тогда
			ПоказатьОповещениеПользователя(НСтр("ru = 'Пароль восстановлен'"),, 
				НСтр("ru = 'Исходные данные авторизации пользователя восстановлены.'"));
		Иначе
			ПоказатьПредупреждение(, НСтр("ru = 'Ошибка восстановления пароля: '") + Результат.ОписаниеОшибки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервереБезКонтекста
Функция mcp_ПодменитьДанныеАвторизации(СсылкаПользователя)
	
	Результат = Новый Структура("Успех, ОписаниеОшибки, ИмяПользователя, ВременныйПароль, СохраненныеДанныеJSON");
	Результат.Успех = Ложь;
	
	Попытка
		
		// Получаем идентификатор пользователя ИБ
		ИдентификаторПользователяИБ = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
			СсылкаПользователя, "ИдентификаторПользователяИБ");
		
		Если НЕ ЗначениеЗаполнено(ИдентификаторПользователяИБ) Тогда
			Результат.ОписаниеОшибки = НСтр("ru = 'У выбранного пользователя не настроен вход в программу (нет пользователя ИБ).'");
			Возврат Результат;
		КонецЕсли;
		
		// Находим пользователя информационной базы
		ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоУникальномуИдентификатору(ИдентификаторПользователяИБ);
		
		Если ПользовательИБ = Неопределено Тогда
			Результат.ОписаниеОшибки = НСтр("ru = 'Пользователь информационной базы не найден.'");
			Возврат Результат;
		КонецЕсли;
		
		// Сохраняем текущие данные авторизации
		СохраненныеДанные = Новый Структура;
		СохраненныеДанные.Вставить("ИдентификаторПользователяИБ", Строка(ИдентификаторПользователяИБ));
		СохраненныеДанные.Вставить("АутентификацияСтандартная", ПользовательИБ.АутентификацияСтандартная);
		СохраненныеДанные.Вставить("ЗапрещеноИзменятьПароль", ПользовательИБ.ЗапрещеноИзменятьПароль);
		СохраненныеДанные.Вставить("СохраняемоеЗначениеПароля", ПользовательИБ.СохраняемоеЗначениеПароля);
		
		// Устанавливаем временный пароль
		ВременныйПароль = "TempPassword123!";
		
		// Включаем стандартную аутентификацию и устанавливаем временный пароль
		ПользовательИБ.АутентификацияСтандартная = Истина;
		ПользовательИБ.ЗапрещеноИзменятьПароль = Ложь;
		
		// Устанавливаем временный пароль через служебный метод
		СохраняемоеЗначениеПароля = ПользователиСлужебный.СохраняемоеЗначениеСтрокиПароля(ВременныйПароль);
		ПользовательИБ.СохраняемоеЗначениеПароля = СохраняемоеЗначениеПароля;
		
		// Записываем изменения
		ПользовательИБ.Записать();
		
		// Формируем результат
		Результат.Успех = Истина;
		Результат.ИмяПользователя = ПользовательИБ.Имя;
		Результат.ВременныйПароль = ВременныйПароль;
		
		// Сериализуем сохраненные данные в JSON для передачи на клиент
		ЗаписьJSON = Новый ЗаписьJSON;
		ЗаписьJSON.УстановитьСтроку();
		ЗаписатьJSON(ЗаписьJSON, СохраненныеДанные);
		Результат.СохраненныеДанныеJSON = ЗаписьJSON.Закрыть();
		
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		Результат.ОписаниеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке);
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

&НаСервереБезКонтекста
Функция mcp_ВосстановитьДанныеАвторизации(СохраненныеДанныеJSON)
	
	Результат = Новый Структура("Успех, ОписаниеОшибки");
	Результат.Успех = Ложь;
	
	Если НЕ ЗначениеЗаполнено(СохраненныеДанныеJSON) Тогда
		Результат.ОписаниеОшибки = НСтр("ru = 'Нет сохраненных данных для восстановления.'");
		Возврат Результат;
	КонецЕсли;
	
	Попытка
		
		// Десериализуем сохраненные данные
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(СохраненныеДанныеJSON);
		СохраненныеДанные = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		// Получаем идентификатор пользователя ИБ
		ИдентификаторПользователяИБ = Новый УникальныйИдентификатор(СохраненныеДанные.ИдентификаторПользователяИБ);
		
		// Находим пользователя информационной базы
		ПользовательИБ = ПользователиИнформационнойБазы.НайтиПоУникальномуИдентификатору(ИдентификаторПользователяИБ);
		
		Если ПользовательИБ = Неопределено Тогда
			Результат.ОписаниеОшибки = НСтр("ru = 'Пользователь информационной базы не найден для восстановления.'");
			Возврат Результат;
		КонецЕсли;
		
		// Восстанавливаем сохраненные данные
		ПользовательИБ.АутентификацияСтандартная = СохраненныеДанные.АутентификацияСтандартная;
		ПользовательИБ.ЗапрещеноИзменятьПароль = СохраненныеДанные.ЗапрещеноИзменятьПароль;
		ПользовательИБ.СохраняемоеЗначениеПароля = СохраненныеДанные.СохраняемоеЗначениеПароля;
		
		// Записываем изменения
		ПользовательИБ.Записать();
		
		Результат.Успех = Истина;
		
	Исключение
		ИнформацияОбОшибке = ИнформацияОбОшибке();
		Результат.ОписаниеОшибки = КраткоеПредставлениеОшибки(ИнформацияОбОшибке);
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти
